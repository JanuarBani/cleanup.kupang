const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/timNotifications-BGXkaiyb.js","assets/index-5B4sqd9c.js","assets/index-CC93JC9P.css","assets/tamuNotifications-0geSIip8.js"])))=>i.map(i=>d[i]);
import{_ as Pe}from"./index-5B4sqd9c.js";const F="http://127.0.0.1:8000/api",b={login:`${F}/login/`,register:`${F}/register/`,registerAnggota:`${F}/register-anggota/`,users:`${F}/users/`,timPengangkut:`${F}/tim-pengangkut/`,anggota:`${F}/anggota/`,tamu:`${F}/tamu/`,jadwal:`${F}/jadwal/`,pembayaran:`${F}/pembayaran/`,detailAnggotaJadwal:`${F}/detail-anggota-jadwal/`,laporanSampah:`${F}/laporan-sampah/`,upgradeAnggota:`${F}/upgrade-anggota/`,reportsKeuangan:`${F}/reports/keuangan/`,reportsAnggota:`${F}/reports/anggota/`,reportsLaporanSampah:`${F}/reports/laporan-sampah/`,reportsJadwal:`${F}/reports/jadwal/`,reportsUserStats:`${F}/reports/user-stats/`,reportsMonthly:`${F}/reports/monthly/`,reportsDampakLingkungan:`${F}/reports/dampak-lingkungan/`,reportsExport:`${F}/reports/export/`,publicAnalisisLingkungan:`${F}/api/public/analisis-lingkungan/`,publicLandingStats:`${F}/api/public/landing-stats/`,publicQuickStats:`${F}/api/public/quick-stats/`,publicTipsLingkungan:`${F}/api/public/tips-lingkungan/`,publicRankingWilayah:`${F}/api/public/ranking-wilayah/`,pushSubscriptions:`${F}/push-subscriptions/`,pushSubscriptionsVapidKey:`${F}/push-subscriptions/vapid_public_key/`,pushSubscriptionsTest:`${F}/push-subscriptions/test_notification/`,vapidKeyPublic:`${F}/api/vapid-key/`,notifications:`${F}/notifications/`,notificationsMarkAllRead:`${F}/notifications/mark_all_read/`,notificationsMarkRead:e=>`${F}/notifications/${e}/mark_read/`,notificationsTest:`${F}/notifications/test/`,pembayaranAnggota:`${F}/pembayaran/?anggota=`,pembayaranSuccess:e=>`${F}/api/pembayaran/${e}/success/`};function v(){const e=localStorage.getItem("access"),a={"Content-Type":"application/json"};e&&(a.Authorization=`Bearer ${e}`);const t=Hi("csrftoken");return t&&(a["X-CSRFToken"]=t),a}function So(){const e=localStorage.getItem("access"),a={};e&&(a.Authorization=`Bearer ${e}`);const t=Hi("csrftoken");return t&&(a["X-CSRFToken"]=t),a}async function M(e,a={}){const t={headers:v(),credentials:"include"},i={...t,...a,headers:{...t.headers,...a.headers}};try{const s=await fetch(e,i);if(!s.ok){let o=`HTTP error! status: ${s.status}`;try{const l=await s.json();o=l.detail||l.message||o}catch{o=s.statusText||o}throw new Error(o)}if(s.status===204||s.headers.get("content-length")==="0")return{success:!0};const n=s.headers.get("content-type");return n&&n.includes("application/json")?await s.json():await s.text()}catch(s){throw console.error("API Error:",s),s}}function Hi(e){let a=null;if(document.cookie&&document.cookie!==""){const t=document.cookie.split(";");for(let i=0;i<t.length;i++){const s=t[i].trim();if(s.substring(0,e.length+1)===e+"="){a=decodeURIComponent(s.substring(e.length+1));break}}}return a}function Ao(){const e={"Content-Type":"application/json"},a=Hi("csrftoken");return a&&(e["X-CSRFToken"]=a),e}let Me=null;function Bo(){return Me||(Me=document.createElement("div"),Me.id="toast-container",Me.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        `,document.body.appendChild(Me)),Me}function x(e,a="info",t=3e3){Bo();const i=document.createElement("div");i.className=`toast toast-${a}`,i.style.cssText=`
        background: ${Mo(a)};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        max-width: 400px;
        transform: translateX(400px);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    `;const s=Io(a);i.innerHTML=`
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas ${s}" style="font-size: 1.2rem;"></i>
            <span>${e}</span>
        </div>
        <button class="toast-close" style="background: none; border: none; color: white; cursor: pointer; margin-left: 15px;">
            <i class="fas fa-times"></i>
        </button>
    `,Me.appendChild(i),setTimeout(()=>{i.style.transform="translateX(0)",i.style.opacity="1"},10);const n=i.querySelector(".toast-close");return n.onclick=()=>ls(i),t>0&&setTimeout(()=>ls(i),t),i}function ls(e){e.style.transform="translateX(400px)",e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}function Mo(e){switch(e){case"success":return"#4CAF50";case"error":return"#f44336";case"warning":return"#FF9800";case"info":default:return"#2196F3"}}function Io(e){switch(e){case"success":return"fa-check-circle";case"error":return"fa-exclamation-circle";case"warning":return"fa-exclamation-triangle";case"info":default:return"fa-info-circle"}}function Po(){console.log("ðŸ“± Rendering login page..."),document.getElementById("app").innerHTML=`
        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <div class="container-fluid bg-light" style="min-height: 100vh;">
            <!-- Header dengan tombol kembali -->
            <div class="container py-3">
                <button onclick="window.location.hash='#/'" 
                        class="btn btn-outline-success btn-sm mb-3">
                    <i class="bi bi-arrow-left me-1"></i> Kembali ke Beranda
                </button>
            </div>
            
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-5">
                        <div class="card border-success shadow-lg">
                            <div class="card-header bg-success text-white text-center py-4">
                                <h3 class="fw-bold mb-2">
                                    <i class="bi bi-tree-fill me-2"></i>Login CleanUp
                                </h3>
                                <p class="mb-0 opacity-75">Masuk ke akun Anda</p>
                            </div>
                            
                            <div class="card-body p-4">
                                <form id="loginForm" novalidate>
                                    <!-- Username -->
                                    <div class="mb-4">
                                        <label class="form-label fw-semibold">
                                            <i class="bi bi-person me-2"></i>Username
                                        </label>
                                        <input type="text" 
                                               class="form-control form-control-lg" 
                                               id="username" 
                                               name="username"
                                               placeholder="Masukkan username" 
                                               minlength="3"
                                               maxlength="50"
                                               pattern="^[a-zA-Z0-9_.-]{3,50}$"
                                               title="Username 3-50 karakter, hanya huruf, angka, underscore, titik, dan dash"
                                               required>
                                        <div class="invalid-feedback" id="usernameError">
                                            Username harus 3-50 karakter dan hanya boleh mengandung huruf, angka, underscore, titik, atau dash
                                        </div>
                                        <div class="valid-feedback">
                                            Username valid
                                        </div>
                                    </div>
                                    
                                    <!-- Password -->
                                    <div class="mb-4">
                                        <label class="form-label fw-semibold">
                                            <i class="bi bi-lock me-2"></i>Password
                                        </label>
                                        <div class="input-group">
                                            <input type="password" 
                                                   class="form-control form-control-lg" 
                                                   id="password" 
                                                   name="password"
                                                   placeholder="Masukkan password" 
                                                   minlength="6"
                                                   maxlength="100"
                                                   pattern="^.{6,}$"
                                                   title="Password minimal 6 karakter"
                                                   required>
                                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="invalid-feedback" id="passwordError">
                                            Password minimal 6 karakter
                                        </div>
                                        <div class="valid-feedback">
                                            Password valid
                                        </div>
                                        <small class="text-muted mt-1 d-block">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Minimal 6 karakter
                                        </small>
                                    </div>
                                    
                                    <!-- Checkbox Remember Me -->
                                    <div class="mb-4 form-check">
                                        <input type="checkbox" class="form-check-input" id="rememberMe">
                                        <label class="form-check-label" for="rememberMe">
                                            Ingat saya di perangkat ini
                                        </label>
                                    </div>
                                    
                                    <!-- Tombol Login -->
                                    <div class="d-grid mb-4">
                                        <button type="submit" 
                                                class="btn btn-success btn-lg fw-bold py-3"
                                                id="loginBtn">
                                            <i class="bi bi-box-arrow-in-right me-2"></i>
                                            Login
                                        </button>
                                    </div>
                                    
                                    <!-- Link Register -->
                                    <div class="text-center">
                                        <p class="text-muted mb-2">
                                            Belum punya akun?
                                            <a href="#/register" class="text-success fw-semibold text-decoration-none">
                                                Daftar di sini
                                            </a>
                                        </p>
                                        <a href="#/" class="text-success text-decoration-none small">
                                            <i class="bi bi-house me-1"></i> Kembali ke Beranda
                                        </a>
                                    </div>
                                </form>
                                
                                <!-- Message Area -->
                                <div id="loginMessage" class="mt-4"></div>
                                
                                <!-- Attempt Counter (hidden) -->
                                <div id="loginAttempts" class="small text-muted text-end mt-2" style="display: none;">
                                    Percobaan login: <span id="attemptCount">0</span>/5
                                </div>
                            </div>
                            
                            <div class="card-footer bg-transparent border-top-0 text-center py-3">
                                <small class="text-muted">
                                    <i class="bi bi-shield-check me-1"></i>
                                    Data Anda aman bersama kami
                                </small>
                            </div>
                        </div>
                        
                        <!-- Info Tambahan -->
                        <div class="alert alert-info mt-4">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="bi bi-info-circle fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading mb-2">Peran Akun:</h6>
                                    <p class="mb-1 small"><strong>Tamu:</strong> Lapor sampah & lihat peta</p>
                                    <p class="mb-1 small"><strong>Anggota:</strong> Angkut sampah rutin</p>
                                    <p class="mb-1 small"><strong>Tim Angkut:</strong> Petugas pengangkut</p>
                                    <p class="mb-0 small"><strong>Admin:</strong> Kelola sistem</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `,Co()}function Co(){const e=document.getElementById("loginForm"),a=document.getElementById("togglePassword"),t=document.getElementById("password");a&&a.addEventListener("click",function(){const n=t.getAttribute("type")==="password"?"text":"password";t.setAttribute("type",n),this.innerHTML=n==="password"?'<i class="bi bi-eye"></i>':'<i class="bi bi-eye-slash"></i>'});const i=document.getElementById("username");i&&(i.addEventListener("input",Bt),i.addEventListener("blur",Bt)),t&&(t.addEventListener("input",Ti),t.addEventListener("blur",Ti)),e.addEventListener("submit",Do),document.getElementById("username").focus(),Vt();const s=localStorage.getItem("rememberedUser");s&&i&&(i.value=s,Bt())}function Bt(){const e=document.getElementById("username"),a=document.getElementById("usernameError"),t=e.value.trim();return e.classList.remove("is-invalid","is-valid"),t?t.length<3||t.length>50?(e.classList.add("is-invalid"),a.textContent="Username harus 3-50 karakter",!1):/^[a-zA-Z0-9_.-]{3,50}$/.test(t)?t.includes(" ")?(e.classList.add("is-invalid"),a.textContent="Username tidak boleh mengandung spasi",!1):(e.classList.add("is-valid"),!0):(e.classList.add("is-invalid"),a.textContent="Username hanya boleh mengandung huruf, angka, underscore, titik, atau dash",!1):(e.classList.add("is-invalid"),a.textContent="Username harus diisi",!1)}function Ti(){const e=document.getElementById("password"),a=document.getElementById("passwordError"),t=e.value;return e.classList.remove("is-invalid","is-valid"),t?t.length<6?(e.classList.add("is-invalid"),a.textContent="Password harus minimal 6 karakter",!1):t.length>100?(e.classList.add("is-invalid"),a.textContent="Password maksimal 100 karakter",!1):(e.classList.add("is-valid"),!0):(e.classList.add("is-invalid"),a.textContent="Password harus diisi",!1)}async function Do(e){e.preventDefault();const a=Bt(),t=Ti();if(!a||!t){Na("Harap perbaiki error di atas sebelum melanjutkan","error");return}const i=document.getElementById("username").value.trim(),s=document.getElementById("password").value,n=document.getElementById("loginBtn");if(rs()){Na("Terlalu banyak percobaan login. Coba lagi nanti.","error");return}n.innerHTML=`
        <span class="spinner-border spinner-border-sm me-2"></span>
        Memproses login...
    `,n.disabled=!0,No();try{await jo(i,s),_o()}catch{if(n.innerHTML=`
            <i class="bi bi-box-arrow-in-right me-2"></i>
            Login
        `,n.disabled=!1,Vt(),rs()){const l=Fo();Na(`Terlalu banyak percobaan. Coba lagi dalam ${l} menit.`,"error")}}}async function jo(e,a){if(console.log("ðŸ” LOGIN DEBUG"),console.log("Username:",e),console.log("Login URL:",b.login),!e||!a)throw new Error("Username dan password harus diisi");try{const t=await fetch(b.login,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({username:e,password:a})});console.log("HTTP Status:",t.status);let i="Terjadi kesalahan pada server";if(!t.ok){try{const n=await t.json();switch(t.status){case 400:i=n.detail||"Data login tidak valid";break;case 401:i="Username atau password salah";break;case 403:i="Akun dinonaktifkan atau tidak memiliki akses";break;case 404:i="Endpoint tidak ditemukan";break;case 429:i="Terlalu banyak percobaan. Coba lagi nanti.";break;case 500:i="Server mengalami masalah. Coba lagi nanti.";break;default:i=n.detail||`Login gagal (${t.status})`}console.error("Login error details:",n)}catch{i=`Login gagal dengan status ${t.status}`}throw Na(i,"error"),new Error(i)}const s=await t.json();if(console.log("Login Response:",s),!s.access)throw Na("Login gagal: Tidak menerima token","error"),new Error("No access token received");try{const n=s.access.split(".");if(n.length!==3)throw new Error("Token tidak valid");const o=JSON.parse(atob(n[1]));if(console.log("ðŸ”‘ Token payload:",o),o.exp&&Date.now()>=o.exp*1e3)throw Na("Token sudah kadaluarsa","error"),new Error("Token expired");const l=o.user_id;if(!l)throw Na("Token tidak berisi user_id","error"),new Error("Invalid token payload");console.log("âœ… User ID from token:",l);const r=b.users.replace(/\/$/,"")+`/${l}/`;console.log("User URL:",r);const c=await fetch(r,{headers:{Authorization:`Bearer ${s.access}`,Accept:"application/json"}});if(!c.ok)throw new Error(`Failed to fetch user data: ${c.status}`);const d=await c.json();if(console.log("âœ… User data fetched:",d),!d.id||!d.username||!d.role)throw new Error("Data pengguna tidak lengkap");if(d.is_active===!1)throw Na("Akun dinonaktifkan. Hubungi administrator.","error"),new Error("Account disabled");localStorage.setItem("access",s.access),localStorage.setItem("refresh",s.refresh),localStorage.setItem("user",JSON.stringify(d)),document.getElementById("rememberMe").checked?(localStorage.setItem("rememberedUser",e),console.log("âœ… Remembering user")):localStorage.removeItem("rememberedUser"),d.role==="anggota"&&await Ho(d.id,s.access),Na(`Login berhasil! Selamat datang ${d.username}`,"success"),typeof x=="function"&&x("success",`Selamat datang ${d.username}!`),setTimeout(()=>{console.log(`ðŸŽ¯ Redirecting ${d.role}...`),window.location.hash=`#/dashboard-${d.role}`},1500)}catch(n){throw console.error("Token validation error:",n),Na("Token tidak valid. Coba login kembali.","error"),n}}catch(t){throw console.error("Login error:",t),t.name==="TypeError"&&t.message.includes("fetch")?Na("Tidak dapat terhubung ke server. Periksa koneksi internet Anda.","error"):t.message.includes("Failed to fetch")&&Na("Server tidak merespon. Coba lagi nanti.","error"),t}}function No(){let e=JSON.parse(localStorage.getItem("loginAttempts")||"[]");const a=Date.now();e=e.filter(t=>a-t<15*60*1e3),e.push(a),localStorage.setItem("loginAttempts",JSON.stringify(e)),localStorage.setItem("lastLoginAttempt",a),Vt()}function _o(){localStorage.removeItem("loginAttempts"),localStorage.removeItem("lastLoginAttempt"),Vt()}function Vt(){const e=JSON.parse(localStorage.getItem("loginAttempts")||"[]"),a=document.getElementById("loginAttempts"),t=document.getElementById("attemptCount");a&&t&&(e.length>0?(a.style.display="block",t.textContent=e.length,e.length>=3&&(a.className="small text-warning text-end mt-2"),e.length>=5&&(a.className="small text-danger text-end mt-2")):a.style.display="none")}function rs(){const e=JSON.parse(localStorage.getItem("loginAttempts")||"[]"),a=Date.now();return e.filter(i=>a-i<15*60*1e3).length>=5}function Fo(){const e=JSON.parse(localStorage.getItem("loginAttempts")||"[]");if(e.length<5)return 0;const a=Math.min(...e),t=Math.floor((Date.now()-a)/(60*1e3));return Math.max(0,15-t)}async function Ho(e,a){try{const t=await fetch(`${b.anggota}?user=${e}`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(t.ok){const i=await t.json();if(i.length>0){const s=i[0].idAnggota||i[0].id;localStorage.setItem("idAnggota",s),console.log(`âœ… idAnggota ditemukan: ${s}`)}}}catch(t){console.warn("Tidak bisa load data anggota:",t)}}function Na(e,a="info"){const t=document.getElementById("loginMessage");switch(t.innerHTML="",t.className="alert",a){case"error":t.className="alert alert-danger";break;case"success":t.className="alert alert-success";break;case"warning":t.className="alert alert-warning";break;default:t.className="alert alert-info"}let i="";switch(a){case"error":i='<i class="bi bi-exclamation-triangle-fill me-2"></i>';break;case"success":i='<i class="bi bi-check-circle-fill me-2"></i>';break;case"warning":i='<i class="bi bi-exclamation-circle-fill me-2"></i>';break;default:i='<i class="bi bi-info-circle-fill me-2"></i>'}t.innerHTML=`
        <div class="d-flex align-items-center">
            ${i}
            <div>${e}</div>
        </div>
    `,a==="success"&&setTimeout(()=>{t.style.opacity="0",t.style.transition="opacity 0.5s",setTimeout(()=>{t.innerHTML="",t.className="",t.style=""},500)},3e3)}function Si(){const e=document.getElementById("app");e.innerHTML=`
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" 
         style="background: rgba(27, 94, 32, 0.95); backdrop-filter: blur(10px);">
      <div class="container">
        <a class="navbar-brand fw-bold d-flex align-items-center" href="#" id="logoHome">
          <!-- LOGO di Navbar -->
          <div class="me-2">
            <img src="/logo/logo_3d.png" 
                 alt="CleanUp Kupang Logo" 
                 style="height: 40px; width: auto;">
          </div>
          CleanUp Kupang
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#hero" data-section="hero">Beranda</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#fitur" data-section="fitur">Fitur</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#harga" data-section="harga">Harga</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#tentang" data-section="tentang">Tentang</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#kontak" data-section="kontak">Kontak</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#/analisis-dampak">
                <i class="bi bi-graph-up me-1"></i> Analisis
              </a>
            </li>
            <li class="nav-item ms-2">
              <a href="#/login" class="btn btn-warning btn-sm" id="loginBtn">
                <i class="bi bi-box-arrow-in-right me-1"></i> Login
              </a>
            </li>
            <li class="nav-item ms-2">
              <a href="#/register" class="btn btn-outline-light btn-sm" id="registerBtn">
                <i class="bi bi-person-plus me-1"></i> Daftar
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- HERO SECTION -->
    <section id="hero" class="text-white position-relative" 
             style="background: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%); padding-top: 80px;">
      <div class="container py-5">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <!-- LOGO di Hero Section -->
            <div class="d-flex align-items-center mb-3">
              <div class="me-3">
                <img src="/logo/logo_3d.png" 
                     alt="CleanUp Kupang Logo" 
                     style="height: 60px; width: auto;">
              </div>
              <h1 class="display-4 fw-bold mb-0 animate__animated animate__fadeInUp">
                CleanUp Kupang
              </h1>
            </div>
            <p class="lead mb-4 animate__animated animate__fadeInUp animate__delay-1s">
              Layanan Angkut Sampah Rumah Tangga Langsung ke TPA
            </p>
            <p class="mb-4 animate__animated animate__fadeInUp animate__delay-2s">
              Daftar sebagai anggota CleanUp Kupang, atur lokasi & jadwal sendiri,
              dan nikmati layanan angkut sampah rumah tangga langsung ke TPA resmi.
            </p>
            <div class="d-flex flex-wrap gap-3 animate__animated animate__fadeInUp animate__delay-3s">
              <a href="#/register-anggota" class="btn btn-warning btn-lg px-4" id="heroRegisterBtn">
                <i class="bi bi-star-fill me-1"></i> Gabung Sekarang
              </a>
            </div>
            <div class="mt-4 d-flex align-items-center text-white-50 animate__animated animate__fadeInUp animate__delay-4s">
              <i class="bi bi-shield-check me-2"></i>
              <small>Terpercaya â€¢ Terlisensi â€¢ Ramah Lingkungan</small>
            </div>
          </div>
          <div class="col-lg-6 text-center mt-5 mt-lg-0 animate__animated animate__fadeIn">
            <div class="position-relative">
              <!-- Container dengan efek modern -->
              <div class="position-relative d-inline-block">
                <!-- Background gradient dengan efek blur -->
                <div class="position-absolute top-50 start-50 translate-middle bg-success bg-opacity-10 rounded-circle" 
                    style="width: 200px; height: 200px; filter: blur(20px);"></div>
                
                <!-- Main logo container dengan border gradient -->
                <div class="position-relative rounded-4 p-4 shadow-lg" 
                    style="
                      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                      border: 2px solid rgba(25, 135, 84, 0.1);
                      width: 240px;
                      height: 240px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    ">
                  
                  <!-- Logo dengan efek shadow -->
                  <div class="position-relative">
                    <img src="/logo/logo_3d.png" 
                        alt="CleanUp Kupang Logo" 
                        class="img-fluid"
                        style="
                          height: 160px;
                          width: auto;
                          filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
                          transition: transform 0.3s ease;
                        ">
                    
                    <!-- Glow effect -->
                    <div class="position-absolute top-50 start-50 translate-middle bg-success bg-opacity-25 rounded-circle" 
                        style="width: 180px; height: 180px; z-index: -1; filter: blur(15px);"></div>
                  </div>
                  
                  <!-- Decorative elements -->
                  <div class="position-absolute top-0 start-0 translate-middle bg-success rounded-circle p-2 shadow-sm"
                      style="width: 40px; height: 40px;">
                    <i class="bi bi-recycle text-white"></i>
                  </div>
                  
                  <div class="position-absolute top-0 end-0 translate-middle bg-warning rounded-circle p-2 shadow-sm"
                      style="width: 40px; height: 40px;">
                    <i class="bi bi-tree text-white"></i>
                  </div>
                  
                  <div class="position-absolute bottom-0 start-0 translate-middle bg-info rounded-circle p-2 shadow-sm"
                      style="width: 40px; height: 40px;">
                    <i class="bi bi-truck text-white"></i>
                  </div>
                  
                  <div class="position-absolute bottom-0 end-0 translate-middle bg-danger rounded-circle p-2 shadow-sm"
                      style="width: 40px; height: 40px;">
                    <i class="bi bi-trash text-white"></i>
                  </div>
                </div>
                
                <!-- Floating truck icon dengan animasi -->
                <div class="position-absolute top-0 start-50 translate-middle-x mt-4">
                  <div class="bg-success text-white rounded-circle p-3 shadow-lg animate__animated animate__bounceIn animate__delay-2s"
                      style="
                        width: 70px;
                        height: 70px;
                        animation: float 3s ease-in-out infinite;
                      ">
                    <i class="bi bi-truck" style="font-size: 2rem;"></i>
                  </div>
                </div>
              </div>
              
              <!-- Text label di bawah logo -->
              <div class="mt-5 animate__animated animate__fadeInUp animate__delay-1s">
                <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                  <div class="bg-success bg-opacity-25 px-3 py-1 rounded-pill">
                    <small class="text-warning fw-bold">
                      <i class="bi bi-shield-check me-1"></i>Terlisensi Resmi
                    </small>
                  </div>
                  <div class="bg-warning bg-opacity-25 px-3 py-1 rounded-pill">
                    <small class="text-warning fw-bold">
                      <i class="bi bi-star-fill me-1"></i>Rating 4.9/5.0
                    </small>
                  </div>
                </div>
                
                <h5 class="text-warning fw-bold mb-2">Solusi Sampah Terpercaya</h5>
                <p class="text-muted small mx-auto" style="max-width: 300px;">
                  Melayani 500+ anggota dengan 4.000+ pengangkutan sukses
                </p>
              </div>
            </div>
          </div>

          <!-- Tambahkan style untuk animasi float -->
          <style>
            @keyframes float {
              0%, 100% {
                transform: translateY(0px);
              }
              50% {
                transform: translateY(-10px);
              }
            }
            
            .hero-logo-container:hover img {
              transform: scale(1.05);
            }
          </style>
        </div>
      </div>
      <div class="wave-divider">
        <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
          <path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" 
                opacity=".25" fill="#ffffff"></path>
          <path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" 
                opacity=".5" fill="#ffffff"></path>
          <path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="#ffffff"></path>
        </svg>
      </div>
    </section>

    <!-- STATS SECTION -->
    <section class="bg-light py-4">
      <div class="container">
        <div class="row text-center g-4">
          <div class="col-md-3 col-6">
            <div class="card border-0 bg-transparent">
              <div class="card-body">
                <h3 class="text-success fw-bold display-6">500+</h3>
                <p class="text-muted mb-0">Anggota Aktif</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card border-0 bg-transparent">
              <div class="card-body">
                <h3 class="text-success fw-bold display-6">4,000+</h3>
                <p class="text-muted mb-0">Pengangkutan</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card border-0 bg-transparent">
              <div class="card-body">
                <h3 class="text-success fw-bold display-6">100%</h3>
                <p class="text-muted mb-0">Ke TPA</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card border-0 bg-transparent">
              <div class="card-body">
                <h3 class="text-success fw-bold display-6">24/7</h3>
                <p class="text-muted mb-0">Layanan</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FITUR SECTION -->
    <section id="fitur" class="py-5">
      <div class="container">
        <div class="text-center mb-5">
          <span class="badge bg-success bg-opacity-10 text-success mb-3 px-3 py-2">
            <i class="bi bi-stars me-1"></i>Fitur Unggulan
          </span>
          <div class="d-flex justify-content-center align-items-center mb-3">
            <div class="me-3">
              <img src="/logo/logo_3d.png" 
                   alt="CleanUp Kupang Logo" 
                   style="height: 40px; width: auto;">
            </div>
            <h2 class="fw-bold display-5 mb-0">Mengapa Memilih CleanUp Kupang?</h2>
          </div>
          <p class="text-muted lead mx-auto" style="max-width: 600px;">
            Kami memberikan solusi lengkap untuk masalah sampah rumah tangga Anda
          </p>
        </div>
        
        <div class="row g-4">
          <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 hover-lift">
              <div class="card-body p-4 text-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-4 d-inline-block mb-4">
                  <i class="bi bi-truck text-success" style="font-size: 2.5rem;"></i>
                </div>
                <h4 class="card-title fw-bold mb-3">Angkut Langsung</h4>
                <p class="card-text text-muted">
                  Sampah dijemput langsung di depan rumah Anda tanpa perlu mengantarkan ke TPS.
                </p>
                <ul class="list-unstyled text-start mt-4">
                  <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Jadwal fleksibel</li>
                  <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Armada lengkap</li>
                  <li><i class="bi bi-check-circle-fill text-success me-2"></i>Petugas profesional</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 hover-lift">
              <div class="card-body p-4 text-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-4 d-inline-block mb-4">
                  <i class="bi bi-map text-success" style="font-size: 2.5rem;"></i>
                </div>
                <h4 class="card-title fw-bold mb-3">Laporan Real-time</h4>
                <p class="card-text text-muted">
                  Laporkan titik sampah dengan peta interaktif dan pantau statusnya secara real-time.
                </p>
                <ul class="list-unstyled text-start mt-4">
                  <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>GPS tracking</li>
                  <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Foto bukti</li>
                  <li><i class="bi bi-check-circle-fill text-success me-2"></i>Notifikasi status</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 hover-lift">
              <div class="card-body p-4 text-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-4 d-inline-block mb-4">
                  <i class="bi bi-recycle text-success" style="font-size: 2.5rem;"></i>
                </div>
                <h4 class="card-title fw-bold mb-3">Ramah Lingkungan</h4>
                <p class="card-text text-muted">
                  Bersama menjaga Kota Kupang tetap bersih dengan pengelolaan sampah yang bertanggung jawab.
                </p>
                <ul class="list-unstyled text-start mt-4">
                  <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Sampah ke TPA</li>
                  <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Edukasi lingkungan</li>
                  <li><i class="bi bi-check-circle-fill text-success me-2"></i>Komunitas peduli</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- HOW IT WORKS -->
    <section class="bg-light py-5">
      <div class="container">
        <div class="text-center mb-5">
          <span class="badge bg-warning bg-opacity-10 text-warning mb-3 px-3 py-2">
            <i class="bi bi-lightning-charge me-1"></i>Cara Kerja
          </span>
          <div class="d-flex justify-content-center align-items-center mb-3">
            <div class="me-3">
              <img src="/logo/logo_3d.png" 
                   alt="CleanUp Kupang Logo" 
                   style="height: 40px; width: auto;">
            </div>
            <h2 class="fw-bold display-5 mb-0">Hanya 3 Langkah Mudah</h2>
          </div>
          <p class="text-muted lead mx-auto" style="max-width: 600px;">
            Mulai dari daftar hingga sampah terangkut, semudah itu!
          </p>
        </div>
        
        <div class="row align-items-center">
          <div class="col-lg-4 mb-4">
            <div class="card border-0 bg-white shadow-sm p-4">
              <div class="position-relative">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 60px; height: 60px; font-size: 1.5rem; position: absolute; top: -30px; left: 50%; transform: translateX(-50%);">
                  1
                </div>
              </div>
              <div class="card-body text-center pt-5">
                <h4 class="fw-bold mb-3">Daftar & Login</h4>
                <p class="text-muted mb-0">
                  Daftar akun, tentukan lokasi rumah via GPS, dan langsung aktif sebagai anggota.
                </p>
              </div>
            </div>
          </div>
          
          <div class="col-lg-4 mb-4">
            <div class="card border-0 bg-white shadow-sm p-4">
              <div class="position-relative">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 60px; height: 60px; font-size: 1.5rem; position: absolute; top: -30px; left: 50%; transform: translateX(-50%);">
                  2
                </div>
              </div>
              <div class="card-body text-center pt-5">
                <h4 class="fw-bold mb-3">Atur Jadwal</h4>
                <p class="text-muted mb-0">
                  Pilih jadwal pengangkutan langsung dari aplikasi tanpa perlu konfirmasi manual.
                </p>
              </div>
            </div>
          </div>
          
          <div class="col-lg-4 mb-4">
            <div class="card border-0 bg-white shadow-sm p-4">
              <div class="position-relative">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 60px; height: 60px; font-size: 1.5rem; position: absolute; top: -30px; left: 50%; transform: translateX(-50%);">
                  3
                </div>
              </div>
              <div class="card-body text-center pt-5">
                <h4 class="fw-bold mb-3">Sampah ke TPA</h4>
                <p class="text-muted mb-0">
                  Sampah langsung dibawa ke TPA dengan pengelolaan yang bertanggung jawab.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PRICING SECTION -->
    <section id="harga" class="py-5">
      <div class="container">
        <div class="text-center mb-5">
          <span class="badge bg-info bg-opacity-10 text-info mb-3 px-3 py-2">
            <i class="bi bi-tags me-1"></i>Harga Terjangkau
          </span>
          <div class="d-flex justify-content-center align-items-center mb-3">
            <div class="me-3">
              <img src="/logo/logo_3d.png" 
                   alt="CleanUp Kupang Logo" 
                   style="height: 40px; width: auto;">
            </div>
            <h2 class="fw-bold display-5 mb-0">Paket Layanan CleanUp</h2>
          </div>
          <p class="text-muted lead mx-auto" style="max-width: 600px;">
            Investasi kecil untuk lingkungan bersih dan nyaman
          </p>
        </div>
        
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card border-0 shadow-lg overflow-hidden">
              <div class="card-header bg-success text-white text-center py-4">
                <h3 class="fw-bold mb-1">Paket Bulanan</h3>
                <div class="display-4 fw-bold">Rp 50.000</div>
                <small class="opacity-75">
                  per bulan â€¢ akun langsung aktif setelah daftar
                </small>
              </div>
              <div class="card-body p-0">
                <div class="row g-0">
                  <div class="col-md-6 p-4">
                    <h5 class="fw-bold text-success mb-4">
                      <i class="bi bi-check-circle me-2"></i>Yang Anda Dapatkan:
                    </h5>
                    <ul class="list-unstyled mb-4">
                      <li class="mb-3"><i class="bi bi-check-lg text-success me-2"></i>4x pengangkutan per bulan</li>
                      <li class="mb-3"><i class="bi bi-check-lg text-success me-2"></i>Jemput depan rumah</li>
                      <li class="mb-3"><i class="bi bi-check-lg text-success me-2"></i>Sampah langsung ke TPA</li>
                      <li class="mb-3"><i class="bi bi-check-lg text-success me-2"></i>Akses aplikasi premium</li>
                      <li><i class="bi bi-check-lg text-success me-2"></i>Prioritas layanan</li>
                    </ul>
                  </div>
                  <div class="col-md-6 bg-light p-4">
                    <h5 class="fw-bold text-success mb-4">
                      <i class="bi bi-star me-2"></i>Bonus Tambahan:
                    </h5>
                    <ul class="list-unstyled mb-4">
                      <li class="mb-3"><i class="bi bi-gift text-success me-2"></i>Gratis edukasi pengelolaan sampah</li>
                      <li class="mb-3"><i class="bi bi-gift text-success me-2"></i>Diskon produk ramah lingkungan</li>
                      <li class="mb-3"><i class="bi bi-gift text-success me-2"></i>Kartu anggota eksklusif</li>
                      <li><i class="bi bi-gift text-success me-2"></i>Update newsletter lingkungan</li>
                    </ul>
                    <div class="text-center mt-4">
                      <a href="#/register-anggota" class="btn btn-success btn-lg w-100 py-3 fw-bold" id="pricingRegisterBtn">
                        <i class="bi bi-arrow-right-circle me-2"></i>Daftar Sekarang
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="alert alert-success mt-4 text-center">
              <div class="d-flex align-items-center justify-content-center">
                <div class="me-3">
                  <img src="/logo/logo_3d.png" 
                       alt="CleanUp Kupang Logo" 
                       style="height: 30px; width: auto;">
                </div>
                <div>
                  <strong>Garansi Kepuasan:</strong> 100% uang kembali jika tidak puas dengan layanan kami
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TENTANG SECTION -->
    <section id="tentang" class="py-5">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6 mb-5 mb-lg-0">
            <span class="badge bg-success bg-opacity-10 text-success mb-3 px-3 py-2">
              <i class="bi bi-info-circle me-1"></i>Tentang Kami
            </span>
            <div class="d-flex align-items-center mb-4">
              <div class="me-3">
                <img src="/logo/logo_3d.png" 
                     alt="CleanUp Kupang Logo" 
                     style="height: 100px; width: auto;">
              </div>
              <h2 class="fw-bold display-5 mb-0">CleanUp Kupang - Peduli Lingkungan</h2>
            </div>
            <p class="lead mb-4">
              Kami mulai dari kesadaran melihat <strong class="text-success">SAMPAH KOTA KUPANG</strong> yang semakin parah setiap hari.
            </p>
            <p class="mb-4">
              Didirikan tahun 2025, CleanUp Kupang hadir sebagai solusi untuk masalah sampah rumah tangga. 
              Dengan motto <strong>"Kaka Buang, Beta Angkut"</strong>, kami berkomitmen memberikan layanan terbaik untuk 
              lingkungan yang lebih bersih dan sehat.
            </p>
            <div class="row">
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                    <i class="bi bi-award text-success"></i>
                  </div>
                  <div>
                    <h6 class="fw-bold mb-0">Terlisensi Resmi</h6>
                    <small class="text-muted">Izin pengangkutan sampah</small>
                  </div>
                </div>
              </div>
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                    <i class="bi bi-tree text-success"></i>
                  </div>
                  <div>
                    <h6 class="fw-bold mb-0">Ramah Lingkungan</h6>
                    <small class="text-muted">Sampah ke TPA terdaftar</small>
                  </div>
                </div>
              </div>
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                    <i class="bi bi-people text-success"></i>
                  </div>
                  <div>
                    <h6 class="fw-bold mb-0">Komunitas Besar</h6>
                    <small class="text-muted">500+ anggota aktif</small>
                  </div>
                </div>
              </div>
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                    <i class="bi bi-shield-check text-success"></i>
                  </div>
                  <div>
                    <h6 class="fw-bold mb-0">Terpercaya</h6>
                    <small class="text-muted">Rating 4.9/5.0</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="position-relative">
              <div class="bg-success bg-opacity-10 rounded-3 p-5">
                <div class="text-center mb-4">
                  <div class="mb-3">
                    <img src="/logo/logo_3d.png" 
                         alt="CleanUp Kupang Logo" 
                         style="height: 60px; width: auto;">
                  </div>
                  <i class="bi bi-quote display-1 text-success opacity-25"></i>
                </div>
                <blockquote class="blockquote text-center">
                  <p class="fs-4 fst-italic mb-4">
                    "Bersama CleanUp, kita bukan hanya membuang sampah, tapi membangun Kota Kupang yang lebih bersih untuk generasi mendatang."
                  </p>
                  <footer class="blockquote-footer mt-3">
                    <strong>Tim CleanUp Kupang</strong>
                  </footer>
                </blockquote>
                <div class="text-center mt-4">
                  <div class="badge bg-success px-3 py-2 mb-2">"INGAT SAMPAH INGAT CLEANUP"</div>
                  <div class="badge bg-warning text-dark px-3 py-2">EST 2025</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTACT SECTION -->
    <section id="kontak" class="py-5 bg-light">
      <div class="container">
        <div class="text-center mb-5">
          <span class="badge bg-info bg-opacity-10 text-info mb-3 px-3 py-2">
            <i class="bi bi-telephone me-1"></i>Kontak Kami
          </span>
          <div class="d-flex justify-content-center align-items-center mb-3">
            <div class="me-3">
              <img src="/logo/logo_3d.png" 
                   alt="CleanUp Kupang Logo" 
                   style="height: 40px; width: auto;">
            </div>
            <h2 class="fw-bold display-5 mb-0">Hubungi CleanUp Kupang</h2>
          </div>
          <p class="text-muted lead mx-auto" style="max-width: 600px;">
            Kami siap membantu Anda dengan layanan terbaik
          </p>
        </div>
        
        <div class="row">
          <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body p-4 text-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-3 d-inline-block mb-3">
                  <i class="bi bi-whatsapp text-success fs-2"></i>
                </div>
                <h5 class="fw-bold mb-3">WhatsApp</h5>
                <p class="text-muted mb-3">Chat langsung dengan tim kami</p>
                <a href="https://wa.me/6282341743886" target="_blank" 
                   class="btn btn-success w-100">
                  <i class="bi bi-whatsapp me-2"></i>082-341-743-886
                </a>
              </div>
            </div>
          </div>
          
          <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body p-4 text-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-3 d-inline-block mb-3">
                  <i class="bi bi-envelope text-success fs-2"></i>
                </div>
                <h5 class="fw-bold mb-3">Email</h5>
                <p class="text-muted mb-3">Untuk pertanyaan formal</p>
                <a href="mailto:admin@cleanupkupang.id" 
                   class="btn btn-outline-success w-100">
                  <i class="bi bi-envelope me-2"></i>admin@cleanupkupang.id
                </a>
              </div>
            </div>
          </div>
          
          <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body p-4 text-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-3 d-inline-block mb-3">
                  <i class="bi bi-clock text-success fs-2"></i>
                </div>
                <h5 class="fw-bold mb-3">Jam Operasional</h5>
                <p class="text-muted mb-3">Senin - Rabu</p>
                <div class="bg-light p-3 rounded">
                  <p class="mb-0 fw-bold">08:00 - 18:00 WITA</p>
                  <small class="text-muted">Kami selalu siap melayani</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- FOOTER -->
    <footer class="bg-dark text-white py-5">
      <div class="container">
        <div class="row">
          <div class="col-lg-4 mb-4">
            <div class="d-flex align-items-center mb-4">
              <div class="me-3">
                <img src="/logo/logo_3d.png" 
                     alt="CleanUp Kupang Logo" 
                     style="height: 50px; width: auto;">
              </div>
              <h4 class="fw-bold mb-0">CleanUp Kupang</h4>
            </div>
            <p class="text-white-50 mb-4">
              Layanan angkut sampah rumah tangga langsung ke TPA. Bersama menjaga Kota Kupang tetap bersih.
            </p>
            <div class="d-flex gap-3">
              <a href="https://instagram.com/cleanUp_officiall" target="_blank" class="text-white text-decoration-none">
                <i class="bi bi-instagram fs-5"></i>
              </a>
              <a href="https://facebook.com/CleanUpKupang" target="_blank" class="text-white text-decoration-none">
                <i class="bi bi-facebook fs-5"></i>
              </a>
              <a href="https://www.tiktok.com/@cleanp.kupang5" target="_blank" class="text-white text-decoration-none">
                <i class="bi bi-tiktok fs-5"></i>
              </a>
            </div>
          </div>
          
          <div class="col-lg-2 col-6 mb-4">
            <h6 class="fw-bold mb-4">Menu</h6>
            <ul class="list-unstyled">
              <li class="mb-2"><a href="#hero" class="text-white-50 text-decoration-none" data-section="hero">Beranda</a></li>
              <li class="mb-2"><a href="#fitur" class="text-white-50 text-decoration-none" data-section="fitur">Fitur</a></li>
              <li class="mb-2"><a href="#harga" class="text-white-50 text-decoration-none" data-section="harga">Harga</a></li>
              <li class="mb-2"><a href="#tentang" class="text-white-50 text-decoration-none" data-section="tentang">Tentang</a></li>
              <li><a href="#kontak" class="text-white-50 text-decoration-none" data-section="kontak">Kontak</a></li>
            </ul>
          </div>
          
          <div class="col-lg-3 col-6 mb-4">
            <h6 class="fw-bold mb-4">Layanan</h6>
            <ul class="list-unstyled">
              <li class="mb-2"><a href="#/register" class="text-white-50 text-decoration-none" id="footerRegisterBtn">Daftar Anggota</a></li>
              <li class="mb-2"><a href="#/login" class="text-white-50 text-decoration-none" id="footerLoginBtn">Login</a></li>
              <li class="mb-2"><a href="#/laporan" class="text-white-50 text-decoration-none">Lapor Sampah</a></li>
              <li><a href="#/bantuan" class="text-white-50 text-decoration-none">Bantuan</a></li>
            </ul>
          </div>
          
          <div class="col-lg-3 mb-4">
            <h6 class="fw-bold mb-4">Kontak</h6>
            <ul class="list-unstyled">
              <li class="mb-3">
                <i class="bi bi-telephone text-success me-2"></i>
                <span class="text-white-50">082-341-743-886</span>
              </li>
              <li class="mb-3">
                <i class="bi bi-envelope text-success me-2"></i>
                <span class="text-white-50">admin@cleanupkupang.id</span>
              </li>
              <li>
                <i class="bi bi-clock text-success me-2"></i>
                <span class="text-white-50">Senin - Rabu: 08:00-18:00 WITA</span>
              </li>
            </ul>
          </div>
        </div>
        
        <hr class="text-white-50 my-4">
        
        <div class="row">
          <div class="col-md-6">
            <p class="text-white-50 mb-0">
              Â© 2025 CleanUp Kupang Â· "Kaka Buang, Beta Angkut"
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <div class="d-flex flex-wrap justify-content-md-end gap-3">
              <a href="#/syarat-ketentuan" class="text-white-50 text-decoration-none small">Syarat & Ketentuan</a>
              <a href="#/kebijakan-privasi" class="text-white-50 text-decoration-none small">Kebijakan Privasi</a>
              <a href="#/faq" class="text-white-50 text-decoration-none small">FAQ</a>
            </div>
          </div>
        </div>
      </div>
    </footer>
    
    <!-- Back to Top Button -->
    <button id="backToTop" class="btn btn-success position-fixed bottom-3 end-3 rounded-circle shadow-lg" 
            style="width: 50px; height: 50px; display: none;">
      <i class="bi bi-arrow-up"></i>
    </button>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"><\/script>
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Custom CSS -->
    <style>
      :root {
        --bs-success: #198754;
        --bs-success-rgb: 25, 135, 84;
      }
      
      html {
        scroll-behavior: smooth;
      }
      
      .navbar {
        transition: all 0.3s ease;
      }
      
      .navbar.scrolled {
        background: rgba(27, 94, 32, 0.95) !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .wave-divider {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        overflow: hidden;
        line-height: 0;
      }
      
      .wave-divider svg {
        position: relative;
        display: block;
        width: calc(100% + 1.3px);
        height: 100px;
      }
      
      .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      
      .hover-lift:hover {
        transform: translateY(-10px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
      }
      
      .accordion-button:not(.collapsed) {
        background-color: rgba(25, 135, 84, 0.05) !important;
        color: var(--bs-success) !important;
        border-color: var(--bs-success) !important;
      }
      
      .accordion-button:focus {
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25) !important;
        border-color: var(--bs-success) !important;
      }
      
      @media (max-width: 768px) {
        .display-4 {
          font-size: 2.5rem;
        }
        
        .lead {
          font-size: 1.1rem;
        }
        
        .logo-in-section {
          height: 30px !important;
        }
      }
    </style>
  `,setTimeout(Uo,100)}function Uo(){console.log("ðŸ”§ Setting up landing page event handlers..."),Go();const e=document.getElementById("logoHome");e&&e.addEventListener("click",function(s){s.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})}),document.querySelectorAll('a[href^="#"]:not([href^="#/"])').forEach(s=>{s.addEventListener("click",function(n){const o=this.getAttribute("href");if(o!=="#"&&o.startsWith("#")&&!o.startsWith("#/")){n.preventDefault();const l=document.querySelector(o);if(l){const d=l.getBoundingClientRect().top+window.pageYOffset-80;window.scrollTo({top:d,behavior:"smooth"}),Jo(o.substring(1))}}})}),["loginBtn","registerBtn","heroRegisterBtn","learnMoreBtn","pricingRegisterBtn","ctaRegisterBtn","footerRegisterBtn","footerLoginBtn"].forEach(s=>{const n=document.getElementById(s);if(n){n.onclick=null;const o=n.cloneNode(!0);n.parentNode.replaceChild(o,n);const l=document.getElementById(s);l&&l.addEventListener("click",function(r){r.preventDefault();const c=this.getAttribute("href");c&&c.startsWith("#/")&&(window.location.hash=c)})}});const t=function(){const s=document.querySelector(".navbar");s&&(window.scrollY>50?s.classList.add("scrolled"):s.classList.remove("scrolled")),Ro()};window.addEventListener("scroll",t),window._landingPageScrollHandler=t;const i=document.getElementById("backToTop");if(i){const s=function(){window.scrollY>300?i.style.display="block":i.style.display="none"},n=function(){window.scrollTo({top:0,behavior:"smooth"})};window.addEventListener("scroll",s),i.addEventListener("click",n),window._backToTopScrollHandler=s,window._backToTopClickHandler=n}typeof bootstrap<"u"&&bootstrap.Tooltip&&[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(function(n){new bootstrap.Tooltip(n)}),console.log("âœ… Landing page events setup complete")}function Go(){window._landingPageScrollHandler&&(window.removeEventListener("scroll",window._landingPageScrollHandler),window._landingPageScrollHandler=null),window._backToTopScrollHandler&&(window.removeEventListener("scroll",window._backToTopScrollHandler),window._backToTopScrollHandler=null);const e=document.getElementById("backToTop");e&&window._backToTopClickHandler&&(e.removeEventListener("click",window._backToTopClickHandler),window._backToTopClickHandler=null),console.log("ðŸ§¹ Cleaned up landing page events")}function Jo(e){document.querySelectorAll(".navbar-nav .nav-link").forEach(a=>{a.getAttribute("data-section")===e?a.classList.add("active"):a.classList.remove("active")})}function Ro(){const e=["hero","fitur","harga","tentang","kontak"],a=document.querySelectorAll(".navbar-nav .nav-link[data-section]");let t="";const i=window.scrollY+100;e.forEach(s=>{const n=document.getElementById(s);if(n){const o=n.offsetTop,l=n.offsetHeight;i>=o&&i<o+l&&(t=s)}}),a.forEach(s=>{s.getAttribute("data-section")===t?s.classList.add("active"):s.classList.remove("active")})}let Ui=!1;function zo(){const e=document.getElementById("app");e.innerHTML=`
        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
            .card-body-large {
                padding: 2.5rem !important;
                min-height: 500px;
            }
            .btn-back-dashboard {
                margin-top: 1.5rem;
                padding: 0.75rem 1.5rem;
                font-weight: 600;
            }
            .feature-card {
                height: 100%;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .feature-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
            }
            .validation-feedback {
                display: none;
                font-size: 0.85rem;
                margin-top: 0.25rem;
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
            }
            .validation-feedback.error {
                display: block;
                color: #dc3545;
                background-color: rgba(220, 53, 69, 0.1);
            }
            .validation-feedback.success {
                display: block;
                color: #198754;
                background-color: rgba(25, 135, 84, 0.1);
            }
            .validation-feedback.warning {
                display: block;
                color: #ffc107;
                background-color: rgba(255, 193, 7, 0.1);
            }
            .is-invalid {
                border-color: #dc3545 !important;
            }
            .is-valid {
                border-color: #198754 !important;
            }
            .field-validation {
                min-height: 1.5rem;
            }
            @media (max-width: 768px) {
                .card-body-large {
                    padding: 1.5rem !important;
                }
            }
        </style>
        
        <div class="container-fluid bg-light" style="min-height: 100vh;">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-xl-10">
                        <div class="card border-success shadow-lg">
                            <div class="card-header bg-success text-white py-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h4 class="mb-1">
                                            <i class="bi bi-person-plus me-2"></i>
                                            Daftar Akun Tamu CleanUp Kupang
                                        </h4>
                                        <p class="mb-0 opacity-90 small">Bergabunglah dengan komunitas peduli lingkungan</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body card-body-large">
                                <!-- Tombol Kembali ke Dashboard di dalam Card Body -->
                                <div class="mb-4">
                                    <button onclick="window.location.hash='#/'"
                                            class="btn btn-outline-secondary btn-back-dashboard">
                                        <i class="bi bi-speedometer2 me-2"></i>
                                        Kembali ke Dashboard
                                    </button>
                                </div>

                                <!-- Informasi Penting -->
                                <div class="alert alert-info mb-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-info-circle-fill me-3 fs-4 mt-1"></i>
                                        <div>
                                            <h5 class="alert-heading">Informasi Pendaftaran</h5>
                                            <p class="mb-2">Pendaftaran ini untuk akun <strong class="text-success">TAMU</strong>. 
                                            Dengan akun tamu, Anda dapat melaporkan titik sampah secara gratis dan membantu 
                                            menjaga kebersihan Kota Kupang.</p>
                                            <p class="mb-0">Ingin layanan lengkap? <a href="#/register-anggota" class="alert-link fw-bold">Upgrade ke Anggota</a> 
                                            untuk mendapatkan layanan angkut sampah rumah tangga.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Form Registrasi -->
                                <form id="registerForm">
                                    <h5 class="fw-bold mb-4 text-success border-bottom pb-2">
                                        <i class="bi bi-person-circle me-2"></i>
                                        Data Pribadi
                                    </h5>
                                    
                                    <div class="row">
                                        <!-- Username -->
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label fw-semibold">
                                                <i class="bi bi-person me-1"></i> Username <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="username" 
                                                   placeholder="Masukkan username unik" required>
                                            <div class="form-text small text-muted">Contoh: budi_kupang, siti123</div>
                                            <div class="field-validation">
                                                <div id="usernameValidation" class="validation-feedback"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Password -->
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label fw-semibold">
                                                <i class="bi bi-lock me-1"></i> Password <span class="text-danger">*</span>
                                            </label>
                                            <input type="password" class="form-control form-control-lg" id="password" 
                                                   placeholder="Minimal 6 karakter" required minlength="6">
                                            <div class="form-text small text-muted">Gunakan kombinasi huruf dan angka</div>
                                            <div class="field-validation">
                                                <div id="passwordValidation" class="validation-feedback"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Email -->
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label fw-semibold">
                                                <i class="bi bi-envelope me-1"></i> Email
                                            </label>
                                            <input type="email" class="form-control form-control-lg" id="email" 
                                                   placeholder="nama@email.com" required>
                                            <div class="form-text small text-muted">Digunakan untuk notifikasi dan reset password</div>
                                            <div class="field-validation">
                                                <div id="emailValidation" class="validation-feedback"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Nama Lengkap -->
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label fw-semibold">
                                                <i class="bi bi-card-text me-1"></i> Nama Lengkap <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="nama" 
                                                   placeholder="Nama lengkap Anda" required>
                                            <div class="form-text small text-muted">Contoh: Budi Santoso</div>
                                            <div class="field-validation">
                                                <div id="namaValidation" class="validation-feedback"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Jenis Kelamin -->
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label fw-semibold">
                                                <i class="bi bi-gender-ambiguous me-1"></i> Jenis Kelamin <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select form-select-lg" id="jk" required>
                                                <option value="">Pilih Jenis Kelamin</option>
                                                <option value="L">Laki-laki</option>
                                                <option value="P">Perempuan</option>
                                            </select>
                                            <div class="field-validation">
                                                <div id="jkValidation" class="validation-feedback"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Perbandingan Fitur -->
                                    <h5 class="fw-bold mb-4 text-success border-bottom pb-2 mt-5">
                                        <i class="bi bi-grid-3x3-gap me-2"></i>
                                        Pilihan Akun
                                    </h5>
                                    
                                    <div class="row mb-5">
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100 border-success feature-card">
                                                <div class="card-header bg-success text-white">
                                                    <h5 class="mb-0">
                                                        <i class="bi bi-person me-2"></i>
                                                        Akun Tamu (GRATIS)
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="text-center mb-4">
                                                        <div class="bg-success bg-opacity-10 p-4 rounded-circle d-inline-block">
                                                            <i class="bi bi-person text-success fs-1"></i>
                                                        </div>
                                                    </div>
                                                    <ul class="list-unstyled">
                                                        <li class="mb-3">
                                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                            <strong>Lapor sampah gratis</strong>
                                                        </li>
                                                        <li class="mb-3">
                                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                            <strong>Lihat peta laporan sampah</strong>
                                                        </li>
                                                        <li class="mb-3">
                                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                            <strong>Pantau status laporan</strong>
                                                        </li>
                                                        <li class="mb-3">
                                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                            <strong>Notifikasi real-time</strong>
                                                        </li>
                                                        <li>
                                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                            <strong>Upgrade ke Anggota kapan saja</strong>
                                                        </li>
                                                    </ul>
                                                    <div class="text-center mt-4">
                                                        <div class="badge bg-success fs-6 py-2 px-3">
                                                            <i class="bi bi-currency-exchange me-1"></i>
                                                            GRATIS SELAMANYA
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100 border-warning feature-card">
                                                <div class="card-header bg-warning text-dark">
                                                    <h5 class="mb-0">
                                                        <i class="bi bi-star-fill me-2"></i>
                                                        Akun Anggota (PREMIUM)
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="text-center mb-4">
                                                        <div class="bg-warning bg-opacity-10 p-4 rounded-circle d-inline-block">
                                                            <i class="bi bi-star-fill text-warning fs-1"></i>
                                                        </div>
                                                    </div>
                                                    <ul class="list-unstyled">
                                                        <li class="mb-3">
                                                            <i class="bi bi-truck text-warning me-2"></i>
                                                            <strong>Layanan angkut sampah rumah tangga</strong>
                                                        </li>
                                                        <li class="mb-3">
                                                            <i class="bi bi-calendar-check text-warning me-2"></i>
                                                            <strong>Penjadwalan online fleksibel</strong>
                                                        </li>
                                                        <li class="mb-3">
                                                            <i class="bi bi-geo-alt text-warning me-2"></i>
                                                            <strong>Penjemputan depan rumah</strong>
                                                        </li>
                                                        <li class="mb-3">
                                                            <i class="bi bi-shield-check text-warning me-2"></i>
                                                            <strong>Prioritas layanan</strong>
                                                        </li>
                                                        <li>
                                                            <i class="bi bi-gift text-warning me-2"></i>
                                                            <strong>Bonus dan diskon eksklusif</strong>
                                                        </li>
                                                    </ul>
                                                    <div class="text-center mt-4">
                                                        <div class="badge bg-warning text-dark fs-6 py-2 px-3 mb-2">
                                                            <i class="bi bi-currency-exchange me-1"></i>
                                                            Rp 50.000 / bulan
                                                        </div>
                                                        <div class="d-grid">
                                                            <a href="#/register-anggota" class="btn btn-warning btn-lg">
                                                                <i class="bi bi-arrow-right-circle me-2"></i>
                                                                Daftar sebagai Anggota
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Summary Validation Message -->
                                    <div id="summaryValidation" class="alert alert-info d-none">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-info-circle-fill me-3 fs-5"></i>
                                            <div>
                                                <strong>Periksa kembali form Anda</strong>
                                                <div id="summaryContent" class="mt-1 small"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Tombol Submit -->
                                    <div class="d-grid gap-3 mt-3">
                                        <button type="submit" class="btn btn-success btn-lg py-3 fw-bold" id="regBtn">
                                            <i class="bi bi-person-plus me-2"></i> Daftar Akun Tamu
                                        </button>
                                        
                                        <div class="text-center">
                                            <p class="text-muted mb-2">
                                                Dengan mendaftar, Anda menyetujui 
                                                <a href="#/syarat-ketentuan" class="text-success fw-semibold">Syarat & Ketentuan</a> dan 
                                                <a href="#/kebijakan-privasi" class="text-success fw-semibold">Kebijakan Privasi</a>
                                            </p>
                                            <p class="text-muted mb-0">
                                                Sudah punya akun? 
                                                <a href="#/login" class="text-success fw-semibold text-decoration-none">
                                                    <i class="bi bi-box-arrow-in-right me-1"></i> Login di sini
                                                </a>
                                            </p>
                                        </div>
                                    </div>
                                </form>
                                
                                <!-- Message Area -->
                                <div id="registerMessage" class="mt-5"></div>

                                <!-- Tombol Kembali ke Dashboard di bagian bawah -->
                                <div class="mt-5 pt-4 border-top text-center">
                                    <button onclick="window.location.hash='#/dashboard'"
                                            class="btn btn-link text-decoration-none">
                                        <i class="bi bi-arrow-return-left me-1"></i>
                                        Kembali ke Dashboard
                                    </button>
                                    <div class="mt-2">
                                        <a href="#/" class="text-success text-decoration-none small">
                                            <i class="bi bi-house me-1"></i> Kembali ke Beranda
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </row>
            </div>
        </div>
    `,Oo(),document.getElementById("registerForm").onsubmit=Vo}function Oo(){const e=[{id:"username",validator:Wt},{id:"password",validator:Yt},{id:"email",validator:Zt},{id:"nama",validator:Xt},{id:"jk",validator:Qt}];e.forEach(a=>{const t=document.getElementById(a.id);t&&(t.addEventListener("input",()=>{a.validator(),dt(),ct()}),t.addEventListener("blur",()=>{a.validator(),dt(),ct()}),t.addEventListener("input",()=>{a.id==="username"&&(Ui=!1),a.validator(),dt(),ct()}))}),e.forEach(a=>a.validator()),dt(),ct()}function Wt(){const e=document.getElementById("username").value.trim(),a=document.getElementById("usernameValidation"),t=document.getElementById("username");return t.classList.remove("is-valid","is-invalid"),e?e.length<3?(ra(a,"error","Username minimal 3 karakter"),t.classList.add("is-invalid"),!1):/^[a-zA-Z0-9_.-]+$/.test(e)?Ui?(ra(a,"error","Username sudah digunakan"),t.classList.add("is-invalid"),!1):(ra(a,"success","âœ“ Username valid"),t.classList.add("is-valid"),!0):(ra(a,"error","Hanya huruf, angka, titik, underscore, dan dash"),t.classList.add("is-invalid"),!1):(ra(a,"error","Username harus diisi"),t.classList.add("is-invalid"),!1)}function Yt(){const e=document.getElementById("password").value,a=document.getElementById("passwordValidation"),t=document.getElementById("password");return e?e.length<6?(ra(a,"error","Password minimal 6 karakter"),t.classList.add("is-invalid"),t.classList.remove("is-valid"),!1):/(?=.*[a-zA-Z])(?=.*\d)/.test(e)?(ra(a,"success","âœ“ Password kuat"),t.classList.remove("is-invalid"),t.classList.add("is-valid"),!0):(ra(a,"warning","Sebaiknya kombinasi huruf dan angka"),t.classList.remove("is-invalid"),t.classList.add("is-valid"),!0):(ra(a,"error","Password harus diisi"),t.classList.add("is-invalid"),t.classList.remove("is-valid"),!1)}function Zt(){const e=document.getElementById("email").value.trim(),a=document.getElementById("emailValidation"),t=document.getElementById("email");return t.classList.remove("is-invalid","is-valid"),e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?e.length>254?(ra(a,"error","Email terlalu panjang (maksimal 254 karakter)"),t.classList.add("is-invalid"),!1):(ra(a,"success","âœ“ Email valid"),t.classList.remove("is-invalid"),t.classList.add("is-valid"),!0):(ra(a,"error","Format email tidak valid. Contoh: nama@domain.com"),t.classList.add("is-invalid"),!1):(ra(a,"error","Email harus diisi"),t.classList.add("is-invalid"),!1)}function Xt(){const e=document.getElementById("nama").value.trim(),a=document.getElementById("namaValidation"),t=document.getElementById("nama");return e?e.length<2?(ra(a,"warning","Nama terlalu pendek"),t.classList.remove("is-invalid"),t.classList.add("is-valid"),!0):(ra(a,"success","âœ“ Nama valid"),t.classList.remove("is-invalid"),t.classList.add("is-valid"),!0):(ra(a,"error","Nama lengkap harus diisi"),t.classList.add("is-invalid"),t.classList.remove("is-valid"),!1)}function Qt(){const e=document.getElementById("jk").value,a=document.getElementById("jkValidation"),t=document.getElementById("jk");return e?(ra(a,"success","âœ“ Jenis kelamin dipilih"),t.classList.remove("is-invalid"),t.classList.add("is-valid"),!0):(ra(a,"error","Jenis kelamin harus dipilih"),t.classList.add("is-invalid"),t.classList.remove("is-valid"),!1)}function ra(e,a,t){e.textContent=t,e.className=`validation-feedback ${a}`}function Ko(e){e.textContent="",e.className="validation-feedback"}function dt(){const e=Wt()&&Yt()&&Zt()&&Xt()&&Qt(),a=document.getElementById("regBtn");a.disabled=!e,a.className=e?"btn btn-success btn-lg py-3 fw-bold":"btn btn-secondary btn-lg py-3 fw-bold"}function ct(){const e=document.getElementById("summaryValidation"),a=document.getElementById("summaryContent"),i=[{name:"Username",valid:Wt()},{name:"Password",valid:Yt()},{name:"Email",valid:Zt()},{name:"Nama Lengkap",valid:Xt()},{name:"Jenis Kelamin",valid:Qt()}].filter(s=>!s.valid);i.length>0?(e.className="alert alert-warning",a.innerHTML=`
            <span class="text-danger fw-semibold">${i.length} field perlu diperbaiki:</span>
            <ul class="mb-0 mt-2">
                ${i.map(s=>`<li>${s.name}</li>`).join("")}
            </ul>
        `,e.classList.remove("d-none")):(e.className="alert alert-success",a.innerHTML=`
            <span class="text-success fw-semibold">âœ“ Semua data sudah valid!</span>
            <p class="mb-0 mt-1 small">Anda dapat melanjutkan pendaftaran.</p>
        `,e.classList.remove("d-none"))}function qo(){const e=Wt(),a=Yt(),t=Zt(),i=Xt(),s=Qt();return e&&a&&t&&i&&s}async function Vo(e){if(e.preventDefault(),!qo()){ct(),document.getElementById("summaryValidation").scrollIntoView({behavior:"smooth",block:"center"});return}const a=document.getElementById("regBtn"),t=a.innerHTML,i=document.getElementById("registerMessage");try{a.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mendaftar...',a.disabled=!0,i.innerHTML="";const s=document.getElementById("username").value.trim(),n=document.getElementById("password").value,o=document.getElementById("email").value.trim(),l=document.getElementById("nama").value.trim(),r=document.getElementById("jk").value;if(!o)throw new Error("Email harus diisi");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o))throw new Error("Format email tidak valid. Harus menggunakan format: nama@domain.com");const d={username:s,password:n,email:o,nama:l,jk:r};console.log("Payload registrasi:",d);const m=await fetch(b.register,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),u=await m.json();if(m.ok)alert("Registrasi Berhasil!"),i.innerHTML=`
                <div class="alert alert-success alert-dismissible fade show">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle me-4">
                            <i class="bi bi-check-circle-fill text-success fs-2"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-2">ðŸŽ‰ Registrasi Berhasil!</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Username:</strong> ${u.username}</p>
                                    <p class="mb-2"><strong>Nama:</strong> ${u.nama}</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Email:</strong> ${u.email||"-"}</p>
                                    <p class="mb-0"><strong>Status:</strong> <span class="badge bg-success">Tamu</span></p>
                                </div>
                            </div>
                            <hr class="my-3">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                Anda akan diarahkan ke halaman login dalam 3 detik...
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            `,document.getElementById("registerForm").reset(),["username","password","email","nama","jk"].forEach(p=>{const h=document.getElementById(p),f=document.getElementById(`${p}Validation`);h&&h.classList.remove("is-invalid","is-valid"),f&&Ko(f)}),document.getElementById("summaryValidation").classList.add("d-none"),setTimeout(()=>{window.location.hash="#/login"},3e3);else{if(u&&typeof u=="object"&&u.username){const p=document.getElementById("username"),h=document.getElementById("usernameValidation");Ui=!0,p.classList.add("is-invalid"),p.classList.remove("is-valid"),h&&(h.innerHTML=`
                        <i class="bi bi-x-circle-fill me-1"></i>
                        ${u.username[0]}
                    `,h.classList.remove("d-none")),p.focus(),p.scrollIntoView({behavior:"smooth",block:"center"}),i.innerHTML=`
                    <div class="alert alert-info alert-dismissible fade show mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Silakan gunakan username lain dan coba kembali.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;return}if(u&&typeof u=="object"&&u.email){const p=document.getElementById("email"),h=document.getElementById("emailValidation");p.classList.add("is-invalid"),p.classList.remove("is-valid"),h&&(h.innerHTML=`
                        <i class="bi bi-x-circle-fill me-1"></i>
                        ${u.email[0]}
                    `,h.classList.remove("d-none")),p.focus(),p.scrollIntoView({behavior:"smooth",block:"center"}),i.innerHTML=`
                    <div class="alert alert-info alert-dismissible fade show mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Email sudah terdaftar. Silakan gunakan email lain atau login.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;return}let g="Gagal mendaftar";throw u.detail?g=u.detail:u.non_field_errors?g=u.non_field_errors[0]:u.password?(g=`Password: ${u.password[0]}`,document.getElementById("password").classList.add("is-invalid")):u.nama?(g=`Nama: ${u.nama[0]}`,document.getElementById("nama").classList.add("is-invalid")):u.jk&&(g=`Jenis kelamin: ${u.jk[0]}`,document.getElementById("jk").classList.add("is-invalid")),new Error(g)}}catch(s){console.error("Error registrasi:",s),i.innerHTML=`
            <div class="alert alert-danger alert-dismissible fade show">
                <div class="d-flex align-items-center">
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle me-4">
                        <i class="bi bi-exclamation-triangle-fill text-danger fs-2"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-2">Gagal Mendaftar!</h5>
                        <p class="mb-0">${s.message}</p>
                        ${s.message.includes("email")?'<p class="mt-2 small"><i class="bi bi-info-circle me-1"></i>Pastikan email menggunakan format: nama@domain.com</p>':""}
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        `,i.scrollIntoView({behavior:"smooth",block:"center"})}finally{a.innerHTML=t,a.disabled=!1,dt()}}function ba(e){if(window.L)return Ai(),e();const a=document.createElement("link");a.rel="stylesheet",a.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",a.integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=",a.crossOrigin="",document.head.appendChild(a);const t=document.createElement("script");t.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",t.integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=",t.crossOrigin="",t.onload=function(){Ai(),e()},document.body.appendChild(t)}function Ai(){delete L.Icon.Default.prototype._getIconUrl,L.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"})}function Se(e,a=-10.1935921,t=123.6149376,i=13){const s=document.getElementById(e);if(!s)throw console.error(`Map container '${e}' not found in DOM`),new Error(`Map container '${e}' not found`);s.clientHeight===0&&(s.style.height="400px");const n=L.map(s).setView([a,t],i);return L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(n),n}function ai(e,a,t,i=-10.1935921,s=123.6149376,n=13){return new Promise((o,l)=>{const r=()=>{const c=document.getElementById(e),d=document.getElementById(a),m=document.getElementById(t);if(!c){console.warn(`Map container '${e}' not found, retrying...`),setTimeout(r,100);return}try{const u=Se(e,i,s,n);let g;d&&m&&(d.value=i.toFixed(8),m.value=s.toFixed(8)),g=nt(u,i,s),u.on("click",p=>{const{lat:h,lng:f}=p.latlng;d&&m&&(d.value=h.toFixed(8),m.value=f.toFixed(8)),g.setLatLng([h,f]),g.bindPopup(`ðŸ“ Lokasi: ${h.toFixed(6)}, ${f.toFixed(6)}`).openPopup()}),o(u)}catch(u){console.error("Error initializing map:",u),l(u)}};r()})}function nt(e,a,t,i="",s="#3388ff"){const n=L.marker([a,t],{icon:Wo(s)}).addTo(e);return i&&n.bindPopup(i),n}function Wo(e="#3388ff"){return L.divIcon({html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30" fill="${e}">
                 <path d="M12 0C7.58 0 4 3.58 4 8c0 4.42 8 16 8 16s8-11.58 8-16c0-4.42-3.58-8-8-8zm0 12c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
               </svg>`,className:"custom-marker-icon",iconSize:[30,30],iconAnchor:[15,30],popupAnchor:[0,-30]})}function Gi(){return new Promise(e=>{window.L?(Ai(),e()):ba(()=>{e()})})}const Hs=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,Us=/^0\d{11}$/,Gs=/^[a-zA-ZÃ€-Ã¿\s']+$/,Js=/^[a-zA-Z0-9Ã€-Ã¿\s.,\-\/#()]+$/,Rs=/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$/;function ua(e,a){e.classList.add("is-invalid"),e.classList.remove("is-valid"),e.nextElementSibling&&e.nextElementSibling.classList.contains("invalid-feedback")&&(e.nextElementSibling.innerHTML=`<small>${a}</small>`)}function ot(e,a="âœ“ Valid"){e.classList.remove("is-invalid"),e.classList.add("is-valid"),e.nextElementSibling&&e.nextElementSibling.classList.contains("invalid-feedback")&&(e.nextElementSibling.innerHTML=`<small class="text-success">${a}</small>`)}function Yo(){const e=document.getElementById("app");e.innerHTML=`
        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
            .card-body-large {
                padding: 2.5rem !important;
                min-height: 500px;
            }
            .btn-back-dashboard {
                margin-top: 1.5rem;
                padding: 0.75rem 1.5rem;
                font-weight: 600;
            }
            .username-feedback {
                font-size: 0.875rem;
                margin-top: 0.25rem;
            }
            @media (max-width: 768px) {
                .card-body-large {
                    padding: 1.5rem !important;
                }
            }
        </style>
        
        <div class="container-fluid bg-light" style="min-height:100vh">
            <div class="container py-4">
                <div class="row justify-content-center">
                    <div class="col-xl-10">
                        <div class="card border-success shadow-lg">
                            <div class="card-header bg-success text-white py-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h4 class="mb-1">
                                            <i class="bi bi-geo-alt-fill me-2"></i>
                                            Daftar Anggota CleanUp Kupang
                                        </h4>
                                        <small class="opacity-90">Pilih lokasi rumah (GPS / klik peta)</small>
                                    </div>
                                </div>
                            </div>

                            <div class="card-body card-body-large">
                                <button onclick="window.location.hash='#/'"
                                        class="btn btn-outline-dark btn-sm margin-bottom-10">
                                        <i class="bi bi-arrow-left me-1"></i> Kembali ke Beranda
                                    </button>
                                <form id="registerForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">Username *</label>
                                            <input id="username" class="form-control form-control-lg" 
                                                   placeholder="Masukkan username" required
                                                   autocomplete="username">
                                            <div id="usernameFeedback" class="username-feedback">
                                                <small class="text-muted">Username minimal 3 karakter</small>
                                            </div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">Password *</label>
                                            <input id="password" type="password"
                                                class="form-control form-control-lg" 
                                                placeholder="Minimal 6 karakter" required minlength="6">
                                            <div class="invalid-feedback"></div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">Email</label>
                                            <input id="email" type="email" class="form-control form-control-lg"
                                                   placeholder="nama@email.com">
                                            <div class="invalid-feedback"></div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">Nama Lengkap *</label>
                                            <input id="nama" class="form-control form-control-lg" 
                                                   placeholder="Nama lengkap" required>
                                            <div class="invalid-feedback"></div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">No WhatsApp</label>
                                            <input id="noWA" maxlength="12" class="form-control form-control-lg"
                                                   placeholder="0812-3456-7890">
                                            <div class="invalid-feedback"></div>
                                        </div>

                                        <!-- JENIS SAMPAH (DROPDOWN BARU) -->
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">Jenis Sampah *</label>
                                            <select id="jenisSampah" class="form-control form-control-lg" required>
                                                <option value="">Pilih jenis sampah...</option>
                                                <option value="Rumah Tangga">Rumah Tangga</option>
                                                <option value="Tempat Usaha">Tempat Usaha</option>
                                            </select>
                                            <div class="invalid-feedback">Pilih jenis sampah</div>
                                        </div>

                                        <div class="col-12 mb-4">
                                            <label class="form-label fw-semibold">Alamat *</label>
                                            <textarea id="alamat" class="form-control" 
                                                      rows="3" placeholder="Alamat lengkap" required></textarea>
                                            <div class="invalid-feedback"></div>
                                        </div>

                                        <!-- MAP SECTION -->
                                        <div class="col-12 mb-4">
                                            <div class="border rounded p-3 bg-light">
                                                <label class="form-label fw-bold text-success mb-3">
                                                    <i class="bi bi-map me-2"></i>
                                                    Lokasi Rumah (klik peta / GPS)
                                                </label>
                                                <div id="mapForm"
                                                    style="height:450px;border-radius:8px;border:2px solid #ddd">
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mt-3">
                                                    <button type="button"
                                                        id="btnGetGPS"
                                                        class="btn btn-primary">
                                                        <i class="bi bi-crosshair me-1"></i>
                                                        Ambil Lokasi GPS
                                                    </button>
                                                    <small class="text-muted">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        Izinkan akses lokasi di browser
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">Latitude</label>
                                            <input id="latitude" class="form-control form-control-lg" 
                                                   readonly placeholder="-10.1935921">
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-semibold">Longitude</label>
                                            <input id="longitude" class="form-control form-control-lg" 
                                                   readonly placeholder="123.6149376">
                                        </div>
                                    </div>

                                    <div class="d-grid gap-3 mt-4">
                                        <button id="regBtn"
                                            class="btn btn-success btn-lg py-3 fw-bold">
                                            <i class="bi bi-person-plus me-2"></i>
                                            Daftar Sebagai Anggota
                                        </button>
                                        
                                        <div class="text-center">
                                            <small class="text-muted">
                                                Dengan mendaftar, Anda menyetujui 
                                                <a href="#/syarat-ketentuan" class="text-success">Syarat & Ketentuan</a>
                                            </small>
                                        </div>
                                    </div>
                                </form>

                                <div id="registerMessage" class="mt-4"></div>

                                <!-- Tombol Kembali ke Dashboard di bagian bawah -->
                                <div class="mt-5 pt-4 border-top text-center">
                                    <p class="text-muted mb-3">Sudah memiliki akun?</p>
                                    <a href="#/login" class="btn btn-outline-success">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>
                                        Login ke Akun Anda
                                    </a>
                                    <div class="mt-3">
                                        <button onclick="window.location.hash='#/dashboard'"
                                            class="btn btn-link text-decoration-none">
                                            <i class="bi bi-arrow-return-left me-1"></i>
                                            Kembali ke Dashboard
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `,document.getElementById("registerForm").onsubmit=tl,Zo(),Xo(),ba(()=>al())}let ui=null;function Zo(){const e=document.getElementById("username"),a=document.getElementById("usernameFeedback");e.addEventListener("input",function(){const t=this.value.trim();if(e.classList.remove("is-valid","is-invalid"),!t){a.innerHTML='<small class="text-muted">Username minimal 3 karakter</small>';return}if(t.length<3){a.innerHTML='<small class="text-warning">âš ï¸ Username minimal 3 karakter</small>',e.classList.add("is-invalid");return}if(!/^[a-zA-Z0-9_.-]+$/.test(t)){a.innerHTML='<small class="text-warning">âš ï¸ Hanya huruf, angka, titik, underscore, dash</small>',e.classList.add("is-invalid");return}a.innerHTML='<small class="text-success">âœ“ Username valid</small>',e.classList.add("is-valid")}),e.addEventListener("blur",function(){const t=this.value.trim();if(!t){a.innerHTML='<small class="text-danger">âŒ Username wajib diisi</small>',e.classList.add("is-invalid");return}if(t.length<3){a.innerHTML='<small class="text-danger">âŒ Username minimal 3 karakter</small>',e.classList.add("is-invalid");return}if(!/^[a-zA-Z0-9_.-]+$/.test(t)){a.innerHTML='<small class="text-danger">âŒ Hanya huruf, angka, titik, underscore, dash</small>',e.classList.add("is-invalid");return}})}function Xo(){const e=document.getElementById("email"),a=document.getElementById("noWA"),t=document.getElementById("password"),i=document.getElementById("nama"),s=document.getElementById("alamat");e.addEventListener("input",()=>{if(!e.value){e.classList.remove("is-valid","is-invalid");return}Hs.test(e.value)?ot(e):ua(e,"Email harus mengandung @ dan domain valid")}),a.addEventListener("input",()=>{a.value=a.value.replace(/\D/g,""),Us.test(a.value)?ot(a):ua(a,"No WA harus diawali 0 dan 12 digit")}),s.addEventListener("input",()=>{const n=s.value.trim();if(!n){s.classList.remove("is-valid","is-invalid");return}if(n.length<10){ua(s,"Alamat minimal 10 karakter");return}if(/^\d+$/.test(n)){ua(s,"Alamat tidak boleh hanya angka");return}if(!Js.test(n)){ua(s,"Alamat mengandung karakter tidak valid");return}ot(s)}),t.addEventListener("input",()=>{Rs.test(t.value)?ot(t):ua(t,"Min 6 karakter, ada huruf & angka")}),i.addEventListener("input",()=>{const n=i.value.trim();if(!n){i.classList.remove("is-valid","is-invalid");return}if(n.length<3){ua(i,"Nama minimal 3 karakter");return}if(!Gs.test(n)){ua(i,"Nama hanya boleh huruf dan spasi");return}ot(i)})}function Qo(){const e=document.getElementById("email"),a=document.getElementById("noWA"),t=document.getElementById("password"),i=document.getElementById("nama"),s=document.getElementById("jenisSampah"),n=document.getElementById("alamat"),o=document.getElementById("latitude").value,l=document.getElementById("longitude").value;return e.value&&!Hs.test(e.value)?(ua(e,"Format email tidak valid"),!1):a.value&&!Us.test(a.value)?(ua(a,"No WA harus diawali 0 dan 12 digit"),!1):Rs.test(t.value)?Gs.test(i.value)?n.value.trim().length<10?(n.classList.add("is-invalid"),!1):s.value?["Rumah Tangga","Tempat Usaha"].includes(s.value)?!o||!l||isNaN(o)||isNaN(l)?(alert("Lokasi GPS wajib dipilih"),!1):o<-90||o>90||l<-180||l>180?(alert("Koordinat GPS tidak valid"),!1):n.value.trim().length<10?(ua(n,"Alamat minimal 10 karakter"),n.focus(),!1):/^\d+$/.test(n.value.trim())?(ua(n,"Alamat tidak boleh hanya angka"),n.focus(),!1):Js.test(n.value.trim())?!0:(ua(n,"Alamat mengandung karakter tidak valid"),n.focus(),!1):(ua(s,"Pilih jenis sampah yang valid"),s.focus(),!1):(ua(s,"Pilih jenis sampah"),s.focus(),!1):(ua(i,"Nama hanya huruf dan spasi Min 2 karakter"),!1):(ua(t,"Min 6 karakter, huruf & angka"),!1)}function al(){ai("mapForm","latitude","longitude",-10.1935921,123.6149376,14).then(t=>{const i=document.getElementById("btnGetGPS");i&&i.addEventListener("click",()=>{i.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mengambil GPS...',i.disabled=!0,el(t,()=>{i.innerHTML='<i class="bi bi-crosshair me-1"></i> Ambil Lokasi GPS',i.disabled=!1})})}).catch(t=>console.error("Map error:",t))}function el(e,a=()=>{}){if(!navigator.geolocation){alert("Browser tidak mendukung GPS"),a();return}navigator.geolocation.getCurrentPosition(t=>{const i=t.coords.latitude,s=t.coords.longitude;document.getElementById("latitude").value=i.toFixed(8),document.getElementById("longitude").value=s.toFixed(8),e.setView([i,s],16),ui&&e.removeLayer(ui);const n=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",iconSize:[38,38],iconAnchor:[19,38],popupAnchor:[0,-35]});ui=L.marker([i,s],{icon:n}).addTo(e).bindPopup("ðŸ“¡ Lokasi GPS Anda").openPopup(),a()},t=>{alert("Gagal mengambil GPS: "+t.message),a()},{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})}async function tl(e){if(e.preventDefault(),!Qo())return;const a=document.getElementById("regBtn"),t=document.getElementById("registerMessage"),i=a.innerHTML;try{a.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mendaftar...',a.disabled=!0,t.innerHTML="";const s=new Date,n=new Date(s);n.setMonth(n.getMonth()+1);const o={username:document.getElementById("username").value.trim(),password:document.getElementById("password").value,email:document.getElementById("email").value.trim(),nama:document.getElementById("nama").value.trim(),alamat:document.getElementById("alamat").value.trim(),noWA:document.getElementById("noWA").value.trim(),latitude:parseFloat(document.getElementById("latitude").value),longitude:parseFloat(document.getElementById("longitude").value),tanggalStart:ds(s),tanggalEnd:ds(n),status:"aktif",jenisSampah:document.getElementById("jenisSampah").value},l=await fetch(b.registerAnggota,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),r=await l.json();if(!l.ok){let c=!1,d="";if(r.username&&Array.isArray(r.username))d=r.username[0],c=!0;else if(typeof r=="object"){for(const[u,g]of Object.entries(r))if(Array.isArray(g)&&g.length>0){u==="username"&&(d=g[0],c=!0);break}}if(c){document.getElementById("username").classList.add("is-invalid"),document.getElementById("usernameFeedback").innerHTML=`<small class="text-danger">âŒ ${d}</small>`,document.getElementById("username").focus(),document.getElementById("username").scrollIntoView({behavior:"smooth",block:"center"}),t.innerHTML=`
                    <div class="alert alert-info alert-dismissible fade show mt-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <div>
                                <p class="mb-0">Silakan perbaiki username Anda dan coba lagi.</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;return}let m="Registrasi gagal";throw r.detail&&(m=r.detail),new Error(m);console.log(m)}alert("Registrasi Anggota Berhasil!"),t.innerHTML=`
            <div class="alert alert-success alert-dismissible fade show">
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">Registrasi Berhasil ðŸŽ‰</h5>
                        <p class="mb-2"><b>Username:</b> ${r.username}</p>
                        <p class="mb-0"><b>Status:</b> <span class="badge bg-success">Anggota Aktif</span></p>
                    </div>
                </div>
                <hr>
                <p class="mb-0">Anda akan dialihkan ke halaman login dalam 3 detik...</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `,document.getElementById("registerForm").reset(),document.getElementById("username").classList.remove("is-valid","is-invalid"),document.getElementById("usernameFeedback").innerHTML='<small class="text-muted">Username minimal 3 karakter</small>',setTimeout(()=>{window.location.hash="#/login"},3e3)}catch(s){t.innerHTML=`
            <div class="alert alert-danger alert-dismissible fade show">
                <div class="d-flex align-items-center">
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle me-4">
                        <i class="bi bi-exclamation-triangle-fill text-danger fs-2"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-2">Gagal Mendaftar!</h5>
                        <p class="mb-0">${s.message}</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        `,t.scrollIntoView({behavior:"smooth",block:"center"})}finally{a.innerHTML=i,a.disabled=!1}}function ds(e){const a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${a}-${t}-${i}`}async function Da(){const e=localStorage.getItem("access");if(!e)return null;const a=localStorage.getItem("user");if(a&&a!=="undefined")try{const t=JSON.parse(a);try{const i=JSON.parse(atob(e.split(".")[1]));if(Date.now()>i.exp*1e3)return localStorage.clear(),null}catch{return localStorage.clear(),null}return t}catch{localStorage.removeItem("user")}try{const i=JSON.parse(atob(e.split(".")[1])).user_id,s=await fetch(`${b.users}${i}/`,{headers:{Authorization:`Bearer ${e}`,Accept:"application/json"}});if(!s.ok)return localStorage.clear(),null;const n=await s.json();return localStorage.setItem("user",JSON.stringify(n)),n}catch(t){return console.error("AuthGuard error:",t),localStorage.clear(),null}}function P(e,a,t=null,i=null){let s=document.getElementById("modalContainer");s||(s=document.createElement("div"),s.id="modalContainer",document.body.appendChild(s)),Ra(),setTimeout(()=>{const n="customModal-"+Date.now();s.innerHTML=`
            <div class="modal fade" id="${n}" tabindex="-1" 
                 role="dialog" aria-modal="true" aria-labelledby="${n}-title">
                <div class="modal-dialog ${t?"modal-lg":""}">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="${n}-title">${e}</h5>
                            <button type="button" class="btn-close" 
                                    onclick="window.closeModalById('${n}')" 
                                    aria-label="Tutup modal"></button>
                        </div>
                        <div class="modal-body">
                            ${a}
                        </div>
                        ${t?`
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" 
                                    onclick="window.closeModalById('${n}')">Batal</button>
                            <button type="button" class="btn btn-primary" 
                                    id="saveModalBtn-${n}">Simpan</button>
                        </div>
                        `:""}
                    </div>
                </div>
            </div>
        `;const o=document.getElementById(n),l={backdrop:"static",keyboard:!1,focus:!1},r=new bootstrap.Modal(o,l);window.currentModal=r,window.currentModalElement=o,o.addEventListener("show.bs.modal",()=>{console.log("Modal showing - removing aria-hidden");const c=new MutationObserver(d=>{d.forEach(m=>{if(m.type==="attributes"&&m.attributeName==="aria-hidden"&&m.target===o){console.log("Bootstrap added aria-hidden, removing..."),o.removeAttribute("aria-hidden"),o.setAttribute("aria-modal","true");const u=document.querySelector(".modal-backdrop");u&&u.removeAttribute("aria-hidden")}})});c.observe(o,{attributes:!0,attributeFilter:["aria-hidden"]}),o._ariaObserver=c}),o.addEventListener("shown.bs.modal",()=>{if(console.log("Modal shown - setting focus"),o.removeAttribute("aria-hidden"),o.setAttribute("aria-modal","true"),il(o),t){const c=document.getElementById(`saveModalBtn-${n}`);c&&c.focus()}else{const c=o.querySelectorAll('button:not(.btn-close):not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');c.length>0&&c[0].focus()}}),o.addEventListener("hide.bs.modal",()=>{o._ariaObserver&&(o._ariaObserver.disconnect(),delete o._ariaObserver)}),o.addEventListener("hidden.bs.modal",()=>{zs(o),typeof i=="function"&&i()}),t&&document.getElementById(`saveModalBtn-${n}`)&&o.addEventListener("click",function(d){d.target&&d.target.id===`saveModalBtn-${n}`&&(d.preventDefault(),(async()=>{try{await t()!==!1&&r.hide()}catch(m){console.error("Error in modal save:",m),Os(m.message,"danger",n)}})())}),r.show(),window.closeModalById=function(c){const d=document.getElementById(c);if(d){const m=bootstrap.Modal.getInstance(d);m&&m.hide()}}},50)}function il(e){const a=e.querySelectorAll('button:not([disabled]):not(.btn-close), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');if(a.length===0)return;const t=a[0],i=a[a.length-1],s=n=>{if(n.key==="Tab"&&(n.shiftKey?document.activeElement===t&&(n.preventDefault(),i.focus()):document.activeElement===i&&(n.preventDefault(),t.focus())),n.key==="Escape"){n.preventDefault(),n.stopPropagation();const o=e.querySelector(".btn-close");o&&(o.focus(),setTimeout(()=>{o.click()},100))}};e._tabHandler=s,e.addEventListener("keydown",s),document._modalFocusTrap=n=>{n.key==="Tab"&&!e.contains(document.activeElement)&&(n.preventDefault(),t.focus())},document.addEventListener("keydown",document._modalFocusTrap)}function zs(e){e&&e._tabHandler&&(e.removeEventListener("keydown",e._tabHandler),delete e._tabHandler),document._modalFocusTrap&&(document.removeEventListener("keydown",document._modalFocusTrap),delete document._modalFocusTrap)}function Ra(){const e=document.getElementById("modalContainer");e&&(window.currentModal&&window.currentModal.hide(),document.querySelectorAll(".modal").forEach(i=>{zs(i);const s=bootstrap.Modal.getInstance(i);if(s)try{s.dispose()}catch(n){console.log("Error disposing modal:",n)}i._ariaObserver&&(i._ariaObserver.disconnect(),delete i._ariaObserver),i.remove()}),document.querySelectorAll(".modal-backdrop").forEach(i=>i.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="",e.innerHTML="",delete window.currentModal,delete window.currentModalElement,delete window.closeModalById,console.log("Modal closed with override"))}function pe(e,a){let t=document.getElementById("modalContainer");t||(t=document.createElement("div"),t.id="modalContainer",document.body.appendChild(t)),Ra(),setTimeout(()=>{t.innerHTML=`
            <div class="modal fade" id="confirmModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-danger">Konfirmasi</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            ${e}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="button" class="btn btn-danger" id="confirmModalBtn">Hapus</button>
                        </div>
                    </div>
                </div>
            </div>
        `;const i=document.getElementById("confirmModal"),s=new bootstrap.Modal(i),n=document.getElementById("confirmModalBtn"),o=n.cloneNode(!0);n.parentNode.replaceChild(o,n),o.addEventListener("click",async()=>{try{await a(),s.hide()}catch(l){console.error("Error in confirmation:",l),Os(l.message,"danger","confirmModal")}}),i.addEventListener("hidden.bs.modal",()=>{Ra()}),s.show(),setTimeout(()=>{o.focus()},100)},50)}function Os(e,a="danger",t="customModal"){const i=document.querySelector(`#${t} .modal-body`);if(!i)return;let s=i.querySelector(".modal-alert-container");s||(s=document.createElement("div"),s.className="modal-alert-container mb-3",i.insertBefore(s,i.firstChild)),s.innerHTML="";const n=`
        <div class="alert alert-${a} alert-dismissible fade show">
            <i class="bi bi-${a==="success"?"check-circle":"exclamation-triangle"}-fill me-2"></i>
            ${e}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;s.innerHTML=n,s.scrollIntoView({behavior:"smooth",block:"center"}),(a==="success"||a==="info")&&setTimeout(()=>{if(s&&s.querySelector(".alert")){const o=s.querySelector(".alert");o&&new bootstrap.Alert(o).close()}},5e3)}function sl(e,a="success"){let t=document.getElementById("toastContainer");t||(t=document.createElement("div"),t.id="toastContainer",t.className="toast-container position-fixed top-0 end-0 p-3",t.style.zIndex="9999",document.body.appendChild(t));const i=`toast-${Date.now()}`,s=`
        <div id="${i}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${a} text-white">
                <i class="bi bi-${a==="success"?"check-circle":a==="warning"?"exclamation-triangle":"info-circle"}-fill me-2"></i>
                <strong class="me-auto">${a==="success"?"Sukses":a==="warning"?"Peringatan":"Informasi"}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${e}
            </div>
        </div>
    `;t.insertAdjacentHTML("beforeend",s);const n=document.getElementById(i);new bootstrap.Toast(n,{autohide:!0,delay:3e3}).show(),n.addEventListener("hidden.bs.toast",()=>{n.remove()})}let ta=1,Ta=1,fe=[];function We(e){const a=document.getElementById(e);a&&a.querySelectorAll(".is-invalid").forEach(i=>{i.classList.remove("is-invalid");const s=i.nextElementSibling;s&&s.classList.contains("invalid-feedback")&&(s.textContent="")})}function Va(e,a){const t=document.getElementById(e);if(t){t.classList.add("is-invalid"),t.classList.remove("is-valid");let i=t.nextElementSibling;(!i||!i.classList.contains("invalid-feedback"))&&(i=document.createElement("div"),i.className="invalid-feedback",t.parentNode.insertBefore(i,t.nextSibling)),i.textContent=a}}function se(e){const a=document.getElementById(e);a&&(a.classList.remove("is-invalid"),a.classList.add("is-valid"))}function Ks(e){const a=document.getElementById(e);a&&a.classList.remove("is-invalid","is-valid")}async function Ct(e,a=null){try{const t=await fetch(`${b.users}?username=${encodeURIComponent(e)}`,{headers:v()});if(!t.ok)return{unique:!0,message:""};const i=await t.json(),s=Array.isArray(i)?i.find(n=>n.username===e):null;return s?a&&s.id===parseInt(a)?{unique:!0,message:""}:{unique:!1,message:"Username sudah digunakan. Silakan pilih username lain."}:{unique:!0,message:""}}catch(t){return console.error("Error checking username:",t),{unique:!0,message:""}}}function nl(e){const a={};!e.username||e.username.trim().length<3?a.username="Username minimal 3 karakter":/^[a-zA-Z0-9_]+$/.test(e.username)||(a.username="Username hanya boleh huruf, angka, dan underscore"),e.password?e.password.length<8&&(a.password="Password minimal 8 karakter"):a.password="Password wajib diisi",e.password!==e.password2&&(a.password2="Password dan konfirmasi password tidak sama"),e.role||(a.role="Role wajib dipilih"),!e.email||!e.email.trim()?a.email="Email wajib diisi":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.email)||(a.email="Format email tidak valid");const t=e.role;return t==="anggota"&&((!e.nama||e.nama.trim().length<2)&&(a.nama="Nama anggota wajib diisi"),(!e.alamat||e.alamat.trim().length<10)&&(a.alamat="Alamat wajib diisi (minimal 10 karakter)"),(!e.noWA||!/^[0-9]{10,12}$/.test(e.noWA))&&(a.noWA="No. WhatsApp harus 10-12 digit angka"),e.jenisSampah||(a.jenisSampah="Jenis sampah wajib dipilih"),(!e.latitude||isNaN(e.latitude))&&(a.latitude="Latitude wajib diisi"),(!e.longitude||isNaN(e.longitude))&&(a.longitude="Longitude wajib diisi"),e.tanggalStart||(a.tanggalStart="Tanggal mulai wajib diisi"),e.tanggalEnd||(a.tanggalEnd="Tanggal berakhir wajib diisi"),e.tanggalStart&&e.tanggalEnd&&new Date(e.tanggalStart)>new Date(e.tanggalEnd)&&(a.tanggalEnd="Tanggal berakhir harus setelah tanggal mulai")),t==="tim_angkut"&&((!e.namaTim||e.namaTim.trim().length<2)&&(a.namaTim="Nama tim wajib diisi"),(!e.noWhatsapp||!/^[0-9]{10,12}$/.test(e.noWhatsapp))&&(a.noWhatsapp="No. WhatsApp harus 10-12 digit angka")),t==="tamu"&&((!e.nama_tamu||e.nama_tamu.trim().length<2)&&(a.nama_tamu="Nama tamu wajib diisi"),e.jk||(a.jk="Jenis kelamin wajib dipilih")),a}function ol(e){return{admin:"bg-danger",anggota:"bg-success",tim_angkut:"bg-primary",tamu:"bg-secondary"}[e]||"bg-info"}async function ll(){const e=document.getElementById("mainContent");e.innerHTML=`
    <div class="container-fluid py-3">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="bi bi-people-fill text-primary me-2"></i>
          Manajemen Users
        </h2>
        <button id="addUserBtn" class="btn btn-primary">
          <i class="bi bi-plus-lg me-2"></i>Tambah User
        </button>
      </div>
      
      <!-- PERBAIKAN: Filter section yang benar -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text bg-primary text-white">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" id="searchUser" class="form-control" 
                   placeholder="Cari username atau email...">
          </div>
        </div>
        
        <div class="col-md-3">
          <select id="filterRole" class="form-select">
            <option value="">Semua Role</option>
            <option value="admin">Admin</option>
            <option value="anggota">Anggota</option>
            <option value="tim_angkut">Tim Angkut</option>
            <option value="tamu">Tamu</option>
          </select>
        </div>
        
        <div class="col-md-3">
          <select id="filterStatus" class="form-select">
            <option value="">Semua Status</option>
            <option value="true">Aktif</option>
            <option value="false">Nonaktif</option>
          </select>
        </div>
      </div>
      
      <!-- Refresh button dipisah -->
      <div class="mb-3">
        <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
        </button>
      </div>
      
      <div id="usersTableContainer" class="bg-white rounded shadow-sm p-3">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Memuat data user...</p>
        </div>
      </div>
      
      <div id="paginationContainer" class="mt-4"></div>
    </div>
  `,document.getElementById("addUserBtn").onclick=gl,document.getElementById("searchUser").addEventListener("input",rl(ne,300)),document.getElementById("filterRole").addEventListener("change",()=>{ta=1,ne(!0)}),document.getElementById("filterStatus").addEventListener("change",()=>{ta=1,ne(!0)}),document.getElementById("refreshBtn").onclick=()=>{document.getElementById("searchUser").value="",document.getElementById("filterRole").value="",document.getElementById("filterStatus").value="",ta=1,ne(!0),x("Data direfresh, semua filter direset","success")},ne()}function rl(e,a){let t;return function(...s){const n=()=>{clearTimeout(t),e(...s)};clearTimeout(t),t=setTimeout(n,a)}}async function ne(e=!1){var a,t,i;try{const s=document.getElementById("usersTableContainer");if(!s){console.error("ERROR: usersTableContainer tidak ditemukan");return}const n=((a=document.getElementById("searchUser"))==null?void 0:a.value)||"",o=((t=document.getElementById("filterRole"))==null?void 0:t.value)||"",l=((i=document.getElementById("filterStatus"))==null?void 0:i.value)||"";s.innerHTML=`
      <div class="text-center py-3">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span class="ms-2">Memuat data user...</span>
      </div>
    `;const r=JSON.stringify({search:n,role:o,status:l}),c=window.lastUserSearch||"";if(!e&&fe.length>0&&r===c)console.log("Menggunakan data yang sudah ada untuk pagination");else{let h=b.users;const f=new URLSearchParams;n&&f.append("search",n),o&&f.append("role",o),l!==""&&f.append("is_active",l),f.append("ordering","date_joined"),f.toString()&&(h+=`?${f.toString()}`),console.log("Fetching URL:",h);const k=await fetch(h,{headers:v()});if(!k.ok)throw new Error(`HTTP ${k.status}: Gagal memuat data user`);const w=await k.json();Array.isArray(w)?fe=w:w.results||w.data?fe=w.results||w.data||[]:fe=[],window.lastUserSearch=r}(r!==c||e)&&(ta=1);let d=fe.filter(h=>{var k,w;let f=!0;if(o&&h.role!==o&&(f=!1),l!==""&&String(h.is_active)!==l&&(f=!1),n){const $=n.toLowerCase(),y=((k=h.username)==null?void 0:k.toLowerCase().includes($))||!1,A=((w=h.email)==null?void 0:w.toLowerCase().includes($))||!1;!y&&!A&&(f=!1)}return f});d.sort((h,f)=>{const k=new Date(h.date_joined||0);return new Date(f.date_joined||0)-k});const m=10;Ta=Math.ceil(d.length/m),Ta===0?ta=1:ta>Ta&&(ta=Ta);const u=(ta-1)*m,g=u+m,p=d.slice(u,g);dl(p,d.length),ml(d.length)}catch(s){console.error("Error loading users:",s);const n=document.getElementById("usersTableContainer");n&&(n.innerHTML=`
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Error:</strong> ${s.message}
          <div class="mt-2">
            <button onclick="loadUsers(true)" class="btn btn-sm btn-danger">
              <i class="bi bi-arrow-clockwise me-1"></i>Coba Lagi
            </button>
          </div>
        </div>
      `)}}function dl(e,a=fe.length){const t=document.getElementById("usersTableContainer");if(!t){console.error("ERROR: usersTableContainer tidak ditemukan!");return}if(!e||e.length===0){t.innerHTML=`
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Tidak ada data user yang ditemukan</strong>
        <p class="mb-0 mt-2">Coba ubah filter pencarian Anda.</p>
      </div>
    `;return}try{const i=(ta-1)*10+1,s=`
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-center" width="60">No</th>
              <th class="text-center">ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Bergabung</th>
              <th class="text-center">Aksi</th>
            </tr>
          </thead>
          <tbody>
            ${e.map((n,o)=>`
              <tr>
                <td class="text-center text-muted fw-semibold">${i+o}</td>
                <td class="text-center">${n.id}</td>
                <td>
                  <strong>${n.username}</strong>
                  ${n.nama?`<br><small class="text-muted">${n.nama}</small>`:""}
                  ${n.nama_tamu?`<br><small class="text-muted">${n.nama_tamu}</small>`:""}
                  ${n.namaTim?`<br><small class="text-muted">${n.namaTim}</small>`:""}
                </td>
                <td>${n.email||'<span class="text-muted">-</span>'}</td>
                <td>
                  <span class="badge ${ol(n.role)}">
                    ${n.role}
                  </span>
                </td>
                <td>
                  <span class="badge ${n.is_active?"bg-success":"bg-secondary"}">
                    ${n.is_active?"Aktif":"Nonaktif"}
                  </span>
                </td>
                <td>
                  <small class="text-muted">
                    ${n.date_joined?new Date(n.date_joined).toLocaleDateString("id-ID"):"-"}
                  </small>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-warning btn-edit-user" 
                            data-user-id="${n.id}"
                            title="Edit user">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-delete-user" 
                            data-user-id="${n.id}"
                            ${n.role==="admin"?'disabled title="Admin tidak bisa dihapus"':'title="Hapus user"'}
                            onclick="return confirm('Yakin hapus user ${n.username}?') ? deleteUser(${n.id}) : false">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
      <div class="text-muted mt-2">
        <i class="bi bi-info-circle me-1"></i>
        Menampilkan ${e.length} user (filtered: ${a}, total: ${fe.length})
      </div>
    `;t.innerHTML=s,cl()}catch(i){console.error("Error rendering users table:",i),t&&(t.innerHTML=`
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Error rendering table: ${i.message}
        </div>
      `)}}function cl(){const e=document.getElementById("usersTableContainer");if(!e)return;e._tableActionHandler&&e.removeEventListener("click",e._tableActionHandler);const a=t=>{const i=t.target.closest(".btn-edit-user"),s=t.target.closest(".btn-delete-user");if(i){const n=i.getAttribute("data-user-id");n&&pl(n)}if(s){const n=s.getAttribute("data-user-id");n&&bl(n)}};e.addEventListener("click",a),e._tableActionHandler=a}function ml(){const e=document.getElementById("paginationContainer");if(!e){console.warn("paginationContainer tidak ditemukan");return}if(Ta<=1){e.innerHTML="";return}try{let a=`
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item ${ta===1?"disabled":""}">
            <a class="page-link pagination-link" href="#" data-page="prev">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
    `;const t=7;let i=Math.max(1,ta-Math.floor(t/2)),s=Math.min(Ta,i+t-1);s-i+1<t&&(i=Math.max(1,s-t+1)),i>1&&(a+=`
        <li class="page-item">
          <a class="page-link pagination-link" href="#" data-page="1">1</a>
        </li>
        ${i>2?'<li class="page-item disabled"><span class="page-link">...</span></li>':""}
      `);for(let n=i;n<=s;n++)a+=`
        <li class="page-item ${n===ta?"active":""}">
          <a class="page-link pagination-link" href="#" data-page="${n}">${n}</a>
        </li>
      `;s<Ta&&(a+=`
        ${s<Ta-1?'<li class="page-item disabled"><span class="page-link">...</span></li>':""}
        <li class="page-item">
          <a class="page-link pagination-link" href="#" data-page="${Ta}">${Ta}</a>
        </li>
      `),a+=`
          <li class="page-item ${ta===Ta?"disabled":""}">
            <a class="page-link pagination-link" href="#" data-page="next">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
      <div class="text-center text-muted mt-2">
        Halaman ${ta} dari ${Ta} â€¢ Total ${fe.length} user
      </div>
    `,e.innerHTML=a,ul(e)}catch(a){console.error("Error rendering pagination:",a),e.innerHTML=""}}function ul(e){e._paginationHandler&&e.removeEventListener("click",e._paginationHandler);const a=t=>{t.preventDefault();const i=t.target.closest(".pagination-link");if(!i)return;const s=i.getAttribute("data-page");let n;switch(s){case"prev":ta>1&&(n=ta-1);break;case"next":ta<Ta&&(n=ta+1);break;default:n=parseInt(s)}if(n&&n>=1&&n<=Ta&&n!==ta){const o=window.scrollY;ta=n,ne(),setTimeout(()=>{window.scrollTo({top:o,behavior:"smooth"})},100)}};e.addEventListener("click",a),e._paginationHandler=a}function gl(){const e="addUserForm",a=`
    <form id="${e}" class="needs-validation" novalidate>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
          <input type="text" 
                 class="form-control" 
                 id="username" 
                 name="username"
                 placeholder="contoh: budi123" 
                 required
                 minlength="3"
                 maxlength="30">
          <div class="invalid-feedback">
            Username minimal 3 karakter dan hanya boleh huruf, angka, underscore
          </div>
          <div class="valid-feedback">
            Username valid
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
          <select class="form-select" 
                  id="role" 
                  name="role" 
                  required>
            <option value="">-- Pilih Role --</option>
            <option value="admin">Admin</option>
            <option value="anggota">Anggota</option>
            <option value="tim_angkut">Tim Angkut</option>
            <option value="tamu" selected>Tamu</option>
          </select>
          <div class="invalid-feedback">
            Silakan pilih role
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
          <input type="email" 
                 class="form-control" 
                 id="email" 
                 name="email"
                 placeholder="contoh: user@email.com" 
                 required>
          <div class="invalid-feedback">
            Format email tidak valid
          </div>
          <div class="valid-feedback">
            Email valid
          </div>
        </div>
        
        <!-- Gender field akan ditambahkan berdasarkan role -->
        <div id="gender-field-container"></div>
        
        <div class="col-md-6">
          <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
          <input type="password" 
                 class="form-control" 
                 id="password" 
                 name="password"
                 placeholder="Minimal 8 karakter" 
                 required
                 minlength="8">
          <div class="invalid-feedback">
            Password minimal 8 karakter
          </div>
          <div class="valid-feedback">
            Password valid
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="password2" class="form-label">Konfirmasi Password <span class="text-danger">*</span></label>
          <input type="password" 
                 class="form-control" 
                 id="password2" 
                 name="password2"
                 placeholder="Ketik ulang password" 
                 required
                 minlength="8">
          <div class="invalid-feedback">
            Password tidak sama
          </div>
          <div class="valid-feedback">
            Password cocok
          </div>
        </div>
        
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" 
                   type="checkbox" 
                   id="is_active" 
                   name="is_active" 
                   checked>
            <label class="form-check-label" for="is_active">
              User Aktif
            </label>
          </div>
        </div>
      </div>
    </form>
  `;P("Tambah User Baru",a,async()=>{var t,i,s,n,o,l,r,c,d,m,u,g,p,h,f,k,w,$;try{We(e);const y={username:((t=document.getElementById("username"))==null?void 0:t.value.trim())||"",password:((i=document.getElementById("password"))==null?void 0:i.value)||"",password2:((s=document.getElementById("password2"))==null?void 0:s.value)||"",email:((n=document.getElementById("email"))==null?void 0:n.value.trim())||"",role:((o=document.getElementById("role"))==null?void 0:o.value)||"",is_active:((l=document.getElementById("is_active"))==null?void 0:l.checked)||!0},A=y.role;A==="tamu"&&(y.jk=((r=document.getElementById("jk"))==null?void 0:r.value)||""),A==="anggota"?(y.nama=((c=document.getElementById("nama"))==null?void 0:c.value.trim())||"",y.alamat=((d=document.getElementById("alamat"))==null?void 0:d.value.trim())||"",y.noWA=((m=document.getElementById("noWA"))==null?void 0:m.value.trim())||"",y.jenisSampah=((u=document.getElementById("jenisSampah"))==null?void 0:u.value)||"",y.latitude=((g=document.getElementById("latitude"))==null?void 0:g.value)||"",y.longitude=((p=document.getElementById("longitude"))==null?void 0:p.value)||"",y.tanggalStart=((h=document.getElementById("tanggalStart"))==null?void 0:h.value)||"",y.tanggalEnd=((f=document.getElementById("tanggalEnd"))==null?void 0:f.value)||""):A==="tim_angkut"?(y.namaTim=((k=document.getElementById("namaTim"))==null?void 0:k.value.trim())||"",y.noWhatsapp=((w=document.getElementById("noWhatsapp"))==null?void 0:w.value.trim())||""):A==="tamu"&&(y.nama_tamu=(($=document.getElementById("nama_tamu"))==null?void 0:$.value.trim())||"");const E=nl(y);if(!E.username&&(A==="admin"||A==="tim_angkut")){const U=await Ct(y.username);U.unique||(E.username=U.message)}let C=!1;for(const[U,da]of Object.entries(E))Va(U,da),C=!0;if(C)return x("Harap perbaiki error pada form","danger"),console.log("Validation errors:",E),!1;Object.keys(y).forEach(U=>{document.getElementById(U)&&se(U)});const B=document.querySelector("#modalSaveBtn");if(B){const U=B.innerHTML;B.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',B.disabled=!0}let I,D;switch(A){case"tamu":const U={username:y.username,password:y.password,email:y.email,nama:y.nama_tamu,jk:y.jk};I=await fetch(b.register,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U)}),alert("User Tamu Berhasil di Buat");break;case"anggota":const da={username:y.username,password:y.password,email:y.email,nama:y.nama,alamat:y.alamat,noWA:y.noWA,latitude:parseFloat(y.latitude),longitude:parseFloat(y.longitude),tanggalStart:y.tanggalStart||new Date().toISOString().slice(0,10),tanggalEnd:y.tanggalEnd||"2025-12-31",status:"aktif",jenisSampah:y.jenisSampah||"Rumah Tangga"};I=await fetch(b.registerAnggota,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(da)}),alert("User Anggota Berhasil di Buat");break;case"tim_angkut":const Fa={username:y.username,password:y.password,email:y.email,role:"tim_angkut",is_active:y.is_active},Ha=await fetch(b.users,{method:"POST",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify(Fa)});if(!Ha.ok){const N=await Ha.json();throw new Error(N.detail||"Gagal membuat user untuk tim angkut")}const ca=await Ha.json(),fa={namaTim:y.namaTim,noWhatsapp:y.noWhatsapp,idUser:ca.id};I=await fetch(b.timPengangkut,{method:"POST",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify(fa)}),alert("User Tim angkut Berhasil di Buat"),console.log("Tim angkut creation response:",I);break;case"admin":const T={username:y.username,password:y.password,email:y.email,role:"admin",is_active:y.is_active};I=await fetch(b.users,{method:"POST",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify(T)}),alert("User Admin Berhasil di Buat");break;default:throw new Error("Role tidak valid")}if(I&&(D=await I.json()),B&&(B.innerHTML="Simpan",B.disabled=!1),I&&!I.ok){let U="Gagal menambahkan user";if(D&&(D.username&&Array.isArray(D.username)&&D.username.includes("user with this username already exists")&&(U="Username sudah digunakan",Va("username","Username sudah digunakan")),typeof D=="object")){const da=[];for(const[Fa,Ha]of Object.entries(D))Array.isArray(Ha)?da.push(`${Fa}: ${Ha.join(", ")}`):da.push(`${Fa}: ${Ha}`);da.length>0&&(U=da.join("; "))}return x(U,"danger"),console.log("Backend errors:",D),!1}return x("User berhasil ditambahkan","success"),ne(),!0}catch(y){console.error("Error creating user:",y),x("Terjadi kesalahan jaringan","danger"),console.log(y);const A=document.querySelector("#modalSaveBtn");return A&&(A.innerHTML="Simpan",A.disabled=!1),!1}},!0),setTimeout(()=>{const t=document.getElementById(e);if(t){const i=d=>{const m=document.getElementById("gender-field-container");if(!m)return;let u="";d==="tamu"?u=`
            <div data-role-specific class="col-md-6">
              <label for="jk" class="form-label">Jenis Kelamin <span class="text-danger">*</span></label>
              <select class="form-select" id="jk" name="jk" required>
                <option value="">-- Pilih Jenis Kelamin --</option>
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
              </select>
              <div class="invalid-feedback">
                Jenis kelamin wajib dipilih
              </div>
            </div>
          `:d==="tamu"||d==="tamu"||d==="tamu"?u=`
            <div data-role-specific class="col-md-6">
              <label for="gender" class="form-label">Jenis Kelamin</label>
              <select class="form-select" id="gender" name="gender">
                <option value="">-- Pilih Jenis Kelamin --</option>
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
              </select>
            </div>
          `:u="",m.innerHTML=u,We(e)},s=document.getElementById("role");if(s){s.addEventListener("change",function(){const m=this.value;i(m),cs(m,e),setTimeout(()=>We(e),50)});const d=s.value;i(d),cs(d,e),setTimeout(()=>We(e),50)}const n=document.getElementById("username");if(n){let d;n.addEventListener("input",async()=>{clearTimeout(d);const m=n.value.trim();m.length>=3&&/^[a-zA-Z0-9_]+$/.test(m)&&(d=setTimeout(async()=>{const u=await Ct(m);u.unique?se("username"):Va("username",u.message)},500))})}const o=document.getElementById("password"),l=document.getElementById("password2");if(o&&l){const d=()=>{l.value&&o.value!==l.value?Va("password2","Password tidak sama"):l.value&&o.value===l.value&&(se("password2"),Ks("password2"))};o.addEventListener("input",d),l.addEventListener("input",d)}const r=document.getElementById("email");r&&r.addEventListener("input",()=>{const d=r.value.trim();d&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d)?Va("email","Format email tidak valid"):d&&se("email")}),t.querySelectorAll("input, select").forEach(d=>{d.addEventListener("blur",()=>{d.value&&d.checkValidity()&&se(d.id)})})}},100)}async function pl(e){try{x("Memuat data user...","info");const a=await fetch(`${b.users}${e}/`,{headers:v()});if(!a.ok){const o=await a.text();throw new Error(`Gagal mengambil data user: ${o}`)}const t=await a.json(),i=`editUserForm-${e}`,s={...t,role:t.role,username:t.username,email:t.email||"",is_active:t.is_active||!1},n=`
      <form id="${i}" class="needs-validation" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
            <input type="text" 
                   class="form-control" 
                   id="username" 
                   name="username"
                   value="${t.username||""}" 
                   placeholder="contoh: budi123" 
                   required
                   minlength="3"
                   maxlength="30">
            <div class="invalid-feedback">
              Username minimal 3 karakter dan hanya boleh huruf, angka, underscore
            </div>
            <div class="valid-feedback">
              Username valid
            </div>
          </div>
          
          <div class="col-md-6">
            <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
            <select class="form-select" 
                    id="role" 
                    name="role" 
                    required
                    disabled>
              <option value="">-- Pilih Role --</option>
              <option value="admin" ${t.role==="admin"?"selected":""}>Admin</option>
              <option value="anggota" ${t.role==="anggota"?"selected":""}>Anggota</option>
              <option value="tim_angkut" ${t.role==="tim_angkut"?"selected":""}>Tim Angkut</option>
              <option value="tamu" ${t.role==="tamu"?"selected":""}>Tamu</option>
            </select>
            <div class="invalid-feedback">
              Silakan pilih role
            </div>
            <small class="text-muted">Role tidak dapat diubah</small>
          </div>
          
          <div class="col-md-6">
            <label for="email" class="form-label">Email</label>
            <input type="email" 
                   class="form-control" 
                   id="email" 
                   name="email"
                   value="${t.email||""}" 
                   placeholder="contoh: user@email.com">
            <div class="invalid-feedback">
              Format email tidak valid
            </div>
            <div class="valid-feedback">
              Email valid
            </div>
          </div>
          
          <div class="col-12">
            <hr>
            <h6 class="text-muted">Ubah Password (Opsional)</h6>
          </div>
          
          <div class="col-md-6">
            <label for="password" class="form-label">Password Baru</label>
            <input type="password" 
                   class="form-control" 
                   id="password" 
                   name="password"
                   placeholder="Kosongkan jika tidak diubah"
                   minlength="8">
            <div class="invalid-feedback">
              Password minimal 8 karakter
            </div>
            <div class="valid-feedback">
              Password valid
            </div>
          </div>
          
          <div class="col-md-6">
            <label for="password2" class="form-label">Konfirmasi Password</label>
            <input type="password" 
                   class="form-control" 
                   id="password2" 
                   name="password2"
                   placeholder="Konfirmasi password baru">
            <div class="invalid-feedback">
              Password tidak sama
            </div>
            <div class="valid-feedback">
              Password cocok
            </div>
          </div>
          
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" 
                     type="checkbox" 
                     id="is_active" 
                     name="is_active" 
                     ${t.is_active?"checked":""}>
              <label class="form-check-label" for="is_active">
                User Aktif
              </label>
            </div>
          </div>
          
          <div class="col-12">
            <div class="alert alert-info">
              <small>
                <i class="bi bi-info-circle me-1"></i>
                <strong>Note:</strong> Edit ini hanya untuk data user.<br>
                Untuk edit data spesifik (anggota, tim angkut, tamu), silakan edit dari menu masing-masing.
              </small>
            </div>
          </div>
        </div>
      </form>
    `;P(`Edit User: ${t.username}`,n,async()=>{var o,l,r,c,d,m;try{We(i);const u={username:((o=document.getElementById("username"))==null?void 0:o.value.trim())||"",email:((l=document.getElementById("email"))==null?void 0:l.value.trim())||"",role:((r=document.getElementById("role"))==null?void 0:r.value)||s.role,password:((c=document.getElementById("password"))==null?void 0:c.value)||"",password2:((d=document.getElementById("password2"))==null?void 0:d.value)||"",is_active:((m=document.getElementById("is_active"))==null?void 0:m.checked)||!1},g=u.password||u.password2,p={};if(!u.username||u.username.trim().length<3?p.username="Username minimal 3 karakter":/^[a-zA-Z0-9_]+$/.test(u.username)||(p.username="Username hanya boleh huruf, angka, underscore"),u.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u.email)&&(p.email="Format email tidak valid"),g&&(u.password&&u.password.length<8&&(p.password="Password minimal 8 karakter"),u.password&&u.password2&&u.password!==u.password2&&(p.password2="Password dan konfirmasi password tidak sama")),!p.username&&u.username!==s.username){const E=await Ct(u.username,e);E.unique||(p.username=E.message)}let h=!1;const f=[];if(Object.keys(u).forEach(E=>{if(E==="password"||E==="password2")return;const C=u[E],B=s[E];C!==B&&(h=!0,f.push(E))}),!h&&!g)return x("Tidak ada perubahan data","warning"),!0;let k=!1;for(const[E,C]of Object.entries(p))Va(E,C),k=!0;if(k)return x("Harap perbaiki error pada form","danger"),!1;f.forEach(E=>{document.getElementById(E)&&se(E)});const w=document.querySelector("#modalSaveBtn");if(w){const E=w.innerHTML;w.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',w.disabled=!0}const $={username:u.username,email:u.email||null,is_active:u.is_active};u.password&&($.password=u.password);const y=await fetch(`${b.users}${e}/`,{method:"PATCH",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify($)}),A=await y.json();if(alert("User Berhasil di Ubah"),w&&(w.innerHTML="Simpan",w.disabled=!1),!y.ok){let E="Gagal mengupdate user";if(A&&(A.username&&Array.isArray(A.username)&&A.username.includes("user with this username already exists")&&(E="Username sudah digunakan",Va("username","Username sudah digunakan")),typeof A=="object")){const C=[];for(const[B,I]of Object.entries(A))Array.isArray(I)?C.push(`${B}: ${I.join(", ")}`):C.push(`${B}: ${I}`);C.length>0&&(E=C.join("; "))}return x(E,"danger"),!1}return x("User berhasil diperbarui","success"),ne(),!0}catch(u){console.error("Error updating user:",u),x("Terjadi kesalahan jaringan","danger");const g=document.querySelector("#modalSaveBtn");return g&&(g.innerHTML="Simpan",g.disabled=!1),!1}},!0),setTimeout(()=>{if(document.getElementById(i)){const l=document.getElementById("username");if(l){let m;l.addEventListener("input",async()=>{clearTimeout(m);const u=l.value.trim();u.length>=3&&/^[a-zA-Z0-9_]+$/.test(u)&&u!==s.username&&(m=setTimeout(async()=>{const g=await Ct(u,e);g.unique?se("username"):Va("username",g.message)},500))})}const r=document.getElementById("password"),c=document.getElementById("password2");if(r&&c){const m=()=>{r.value&&c.value&&r.value!==c.value?Va("password2","Password tidak sama"):c.value&&r.value===c.value&&(se("password2"),Ks("password2"))};r.addEventListener("input",m),c.addEventListener("input",m)}const d=document.getElementById("email");d&&d.addEventListener("input",()=>{const m=d.value.trim();m&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(m)?Va("email","Format email tidak valid"):m&&se("email")})}},100)}catch(a){console.error("Error loading user data:",a),x(a.message,"danger")}}async function bl(e){try{const a=await fetch(`${b.users}${e}/`,{headers:v()});if(!a.ok)throw new Error(`Gagal mengambil data user: ${a.status}`);const t=await a.json(),i=t.username||"User",s=t.role||"User";let n=`Apakah Anda yakin ingin menghapus ${s} "${i}"? Tindakan ini tidak dapat dibatalkan.`;switch(s){case"anggota":n+=`

Data anggota dan riwayat pengangkutan sampah juga akan dihapus.`;break;case"tim_angkut":n+=`

Data tim pengangkut dan riwayat penugasan juga akan dihapus.`;break;case"tamu":n+=`

Data profil tamu juga akan dihapus.`;break;case"admin":n+=`

Hati-hati! Menghapus admin dapat mempengaruhi akses sistem.`;break}pe(n,async()=>{try{x("Menghapus user...","info");let o;if(s==="anggota"&&t.anggota&&t.anggota.idAnggota)o=await fetch(`${b.users}${e}/`,{method:"DELETE",headers:v()});else if(s==="tim_angkut"&&t.tim_pengangkut&&t.tim_pengangkut.idTim)if((await fetch(`${b.timPengangkut}${t.tim_pengangkut.idTim}/`,{method:"DELETE",headers:v()})).ok)o=await fetch(`${b.users}${e}/`,{method:"DELETE",headers:v()});else throw new Error("Gagal menghapus data tim pengangkut");else o=await fetch(`${b.users}${e}/`,{method:"DELETE",headers:v()});if(!o.ok){const l=await o.text();throw new Error(`HTTP ${o.status}: ${l}`)}return x("User berhasil dihapus","success"),ta=1,ne(),!0}catch(o){throw console.error("Error deleting user:",o),x(`Gagal menghapus user: ${o.message}`,"danger"),o}})}catch(a){console.error("Error loading user data for deletion:",a),x(`Gagal memuat data user: ${a.message}`,"danger")}}function cs(e,a){const t=document.getElementById(a);if(!t||(t.querySelectorAll("[data-role-specific]").forEach(o=>{o.id!=="gender-field-container"&&!o.querySelector("#gender")&&!o.querySelector("#jk")&&o.remove()}),!t.querySelector(".row.g-3")))return;let n="";switch(e){case"anggota":n=`
                <div data-role-specific class="col-md-6">
                    <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="nama" 
                           name="nama"
                           placeholder="Nama lengkap anggota" 
                           required>
                    <div class="invalid-feedback">
                        Nama wajib diisi
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="alamat" class="form-label">Alamat <span class="text-danger">*</span></label>
                    <textarea class="form-control" 
                              id="alamat" 
                              name="alamat"
                              placeholder="Alamat lengkap" 
                              rows="2" 
                              required></textarea>
                    <div class="invalid-feedback">
                        Alamat wajib diisi
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="noWA" class="form-label">No. WhatsApp <span class="text-danger">*</span></label>
                    <input type="tel" 
                           class="form-control" 
                           id="noWA" 
                           maxlength="12"
                           name="noWA"
                           placeholder="contoh: 081234567890" 
                           pattern="[0-9]{10,13}"
                           required>
                    <div class="invalid-feedback">
                        No. WhatsApp harus 10-13 digit angka
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="jenisSampah" class="form-label">Jenis Sampah <span class="text-danger">*</span></label>
                    <select class="form-select" 
                            id="jenisSampah" 
                            name="jenisSampah" 
                            required>
                        <option value="">-- Pilih Jenis Sampah --</option>
                        <option value="Rumah Tangga">Rumah Tangga</option>
                        <option value="Tempat Usaha">Tempat Usaha</option>
                    </select>
                    <div class="invalid-feedback">
                        Jenis sampah wajib dipilih
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="latitude" class="form-label">Latitude <span class="text-danger">*</span></label>
                    <input type="number" 
                           class="form-control" 
                           id="latitude" 
                           name="latitude"
                           placeholder="contoh: -6.2088" 
                           step="any"
                           required>
                    <div class="invalid-feedback">
                        Latitude wajib diisi
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="longitude" class="form-label">Longitude <span class="text-danger">*</span></label>
                    <input type="number" 
                           class="form-control" 
                           id="longitude" 
                           name="longitude"
                           placeholder="contoh: 106.8456" 
                           step="any"
                           required>
                    <div class="invalid-feedback">
                        Longitude wajib diisi
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="tanggalStart" class="form-label">Tanggal Mulai <span class="text-danger">*</span></label>
                    <input type="date" 
                           class="form-control" 
                           id="tanggalStart" 
                           name="tanggalStart"
                           required>
                    <div class="invalid-feedback">
                        Tanggal mulai wajib diisi
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="tanggalEnd" class="form-label">Tanggal Berakhir <span class="text-danger">*</span></label>
                    <input type="date" 
                           class="form-control" 
                           id="tanggalEnd" 
                           name="tanggalEnd"
                           required>
                    <div class="invalid-feedback">
                        Tanggal berakhir wajib diisi
                    </div>
                </div>
            `;break;case"tim_angkut":n=`
                <div data-role-specific class="col-md-6">
                    <label for="namaTim" class="form-label">Nama Tim <span class="text-danger">*</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="namaTim" 
                           name="namaTim"
                           placeholder="Nama tim pengangkut" 
                           required>
                    <div class="invalid-feedback">
                        Nama tim wajib diisi
                    </div>
                </div>
                
                <div data-role-specific class="col-md-6">
                    <label for="noWhatsapp" class="form-label">No. WhatsApp Tim <span class="text-danger">*</span></label>
                    <input type="tel" 
                           class="form-control" 
                           id="noWhatsapp" maxlength="12"
                           name="noWhatsapp"
                           placeholder="contoh: 081234567890" 
                           pattern="[0-9]{10,12}"
                           required>
                    <div class="invalid-feedback">
                        No. WhatsApp harus 10-12 digit angka
                    </div>
                </div>
            `;break;case"tamu":n=`
                <div data-role-specific class="col-md-6">
                    <label for="nama_tamu" class="form-label">Nama Tamu <span class="text-danger">*</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="nama_tamu" 
                           name="nama_tamu"
                           placeholder="Nama lengkap tamu" 
                           required>
                    <div class="invalid-feedback">
                        Nama wajib diisi
                    </div>
                </div>
            `;break}if(n){const o=t.querySelector("#password");if(o){const l=document.createElement("div");for(l.innerHTML=n;l.firstChild;)o.parentNode.parentNode.insertBefore(l.firstChild,o.parentNode)}}We(a)}function fl(){const e=document.querySelectorAll(".needs-validation");Array.from(e).forEach(a=>{a.addEventListener("submit",t=>{a.checkValidity()||(t.preventDefault(),t.stopPropagation()),a.classList.add("was-validated")},!1)}),hl()}function hl(){document.querySelectorAll(".needs-validation").forEach(a=>{a.querySelectorAll("input, select, textarea").forEach(i=>{i.addEventListener("blur",()=>{ms(i)}),i.addEventListener("input",()=>{i.classList.contains("is-invalid")&&ms(i)})})})}function ms(e){e.checkValidity()?(e.classList.remove("is-invalid"),e.classList.add("is-valid")):(e.classList.remove("is-valid"),e.classList.add("is-invalid"))}function ie(e,a="info"){typeof x=="function"?x(e,a,5e3):alert(`${a.toUpperCase()}: ${e}`)}function vl(e){if(!e)return{valid:!1,message:"Nomor WhatsApp wajib diisi",cleanNoWA:""};const a=e.toString().replace(/\D/g,"");return a.length<9?{valid:!1,message:"Nomor WhatsApp terlalu pendek (minimal 9 digit)",cleanNoWA:a}:a.length>12?{valid:!1,message:"Nomor WhatsApp terlalu panjang (maksimal 12 digit)",cleanNoWA:a}:{valid:!0,cleanNoWA:a}}async function yl(){const e=document.getElementById("mainContent");if(!document.getElementById("modalContainer")){const a=document.createElement("div");a.id="modalContainer",document.body.appendChild(a)}e.innerHTML=`
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-success">
          <i class="bi bi-people-fill me-2"></i>Manajemen Tim Pengangkut
        </h2>
      </div>
      
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text bg-success text-white border-success">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" id="searchTim" class="form-control border-success" 
                   placeholder="Cari nama tim...">
          </div>
        </div>
      </div>
      
      <div class="card border-success shadow-sm">
        <div class="card-header bg-success bg-opacity-10 border-success">
          <h5 class="mb-0 text-success">
            <i class="bi bi-list-ul me-2"></i>Daftar Tim Saya
          </h5>
        </div>
        <div class="card-body">
          <div id="timTableContainer">
            <div class="text-center py-5">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-muted">Memuat data tim...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `,document.getElementById("searchTim").oninput=Dt,Dt()}async function Dt(){var a;const e=((a=document.getElementById("searchTim"))==null?void 0:a.value)||"";try{const t=await M(b.timPengangkut,{headers:v()}),s=(t.data||t||[]).filter(n=>n.namaTim.toLowerCase().includes(e.toLowerCase())||n.user_username&&n.user_username.toLowerCase().includes(e.toLowerCase()));kl(s)}catch(t){console.error("Error loading tim:",t),document.getElementById("timTableContainer").innerHTML=`
      <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Error:</strong> Gagal memuat data tim: ${t.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`}}function kl(e){const a=document.getElementById("timTableContainer"),t=`
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-success">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Nama Tim</th>
            <th scope="col">No WhatsApp</th>
            <th scope="col" class="text-center">Aksi</th>
          </tr>
        </thead>
        <tbody>
          ${e.map(i=>`
            <tr>
              <td class="align-middle">
                <span class="badge bg-secondary">${i.idTim||i.id}</span>
              </td>
              <td class="align-middle fw-bold">
                <div class="d-flex align-items-center">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                    <i class="bi bi-people-fill text-success"></i>
                  </div>
                  ${i.namaTim}
                </div>
              </td>
              <td class="align-middle">
                <a href="https://wa.me/${i.noWhatsapp}" target="_blank" 
                   class="badge bg-success text-decoration-none">
                  <i class="bi bi-whatsapp me-1"></i> ${i.noWhatsapp}
                </a>
              </td>
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  <button onclick="window.editTim(${i.idTim||i.id})" 
                          class="btn btn-outline-warning" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button onclick="window.deleteTim(${i.idTim||i.id})" 
                          class="btn btn-outline-danger" title="Hapus">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;a.innerHTML=t}async function wl(e){try{const a=await M(`${b.timPengangkut}${e}/`,{headers:v()}),t=a.data||a,i=t.namaTim,s=t.noWhatsapp,n=`
      <div class="tim-form-container">
        <form id="editTimForm" class="needs-validation" novalidate>
          <div class="mb-4">
            <label for="namaTim" class="form-label">
              <i class="bi bi-card-text text-warning me-1"></i>Nama Tim *
            </label>
            <input type="text" class="form-control" 
                   id="namaTim" 
                   value="${t.namaTim}" 
                   placeholder="Contoh: Tim Pengangkut Utara"
                   required
                   minlength="3">
            <div class="valid-feedback">
              <i class="bi bi-check-circle-fill me-1"></i> Nama tim valid.
            </div>
            <div class="invalid-feedback">
              <i class="bi bi-exclamation-circle-fill me-1"></i> Nama tim wajib diisi dan minimal 3 karakter.
            </div>
          </div>
          
          <div class="mb-4">
            <label for="noWhatsapp" class="form-label">
              <i class="bi bi-whatsapp text-warning me-1"></i>No WhatsApp *
            </label>
            <div class="input-group">
              <input type="tel"
                     class="form-control" 
                     id="noWhatsapp"
                     maxlength = "12"
                     value="${t.noWhatsapp}"
                     required
                     placeholder="Contoh: 081234567890"
                     oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            </div>
            <div class="valid-feedback">
              <i class="bi bi-check-circle-fill me-1"></i> Nomor WhatsApp valid.
            </div>
            <div class="invalid-feedback">
              <i class="bi bi-exclamation-circle-fill me-1"></i> Masukkan nomor WhatsApp yang valid.
            </div>
            <small class="text-muted mt-1">
              <i class="bi bi-info-circle me-1"></i> Format: 081234567890
            </small>
          </div>
        </form>
        
        <!-- Error Message Area -->
        <div id="formMessageEdit" class="mt-3"></div>
      </div>
    `;P(`Edit Tim: ${t.namaTim}`,n,async()=>{const o=document.getElementById("editTimForm");if(o.classList.remove("was-validated"),!o.checkValidity()){o.classList.add("was-validated");const d=o.querySelector(":invalid");return d&&(d.scrollIntoView({behavior:"smooth",block:"center"}),d.focus()),!1}const l=document.getElementById("namaTim").value.trim(),r=document.getElementById("noWhatsapp").value.trim(),c=vl(r);if(!c.valid){ie(c.message,"danger");const d=document.getElementById("noWhatsapp");return d.classList.add("is-invalid"),d.focus(),!1}if(l===i&&r===s)return ie("Tidak ada perubahan data yang dilakukan.","info"),!1;ie("Menyimpan perubahan data...","info");try{return await M(`${b.timPengangkut}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({namaTim:l,noWhatsapp:c.cleanNoWA})}),setTimeout(()=>{ie(`âœ… Tim "${l}" berhasil diperbarui`,"success"),Dt()},500),!0}catch(d){console.error("Error updating tim:",d);const m=document.getElementById("formMessageEdit");return m&&(m.innerHTML=`
            <div class="alert alert-danger alert-dismissible fade show">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <strong>Error:</strong> ${d.message||"Gagal memperbarui tim"}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `),ie(d.message||"Gagal memperbarui tim","danger"),!1}},!0,"modal-lg"),setTimeout(()=>{fl()},300)}catch(a){console.error("Error loading tim data:",a),ie(`âŒ Gagal memuat data tim: ${a.message}`,"danger")}}async function xl(e){try{const a=await M(`${b.timPengangkut}${e}/`,{headers:v()}),t=a.data||a;pe(`
        <div class="text-center py-3">
          <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
          <h5 class="text-danger fw-bold">Hapus Tim</h5>
          <p class="text-muted">Apakah Anda yakin ingin menghapus tim ini?</p>
          <div class="alert alert-danger mt-3">
            <div class="d-flex align-items-center">
              <div class="bg-danger bg-opacity-10 p-3 rounded-circle me-3">
                <i class="bi bi-people-fill text-danger fs-4"></i>
              </div>
              <div class="text-start">
                <strong class="d-block">${t.namaTim}</strong>
                <small class="text-muted">
                  <i class="bi bi-whatsapp me-1"></i>+62${t.noWhatsapp} | 
                  ID: ${t.idTim||t.id}
                </small>
              </div>
            </div>
          </div>
          <small class="text-muted d-block mt-3">
            <i class="bi bi-exclamation-circle me-1"></i>
            Data yang telah dihapus tidak dapat dikembalikan.
          </small>
        </div>
      `,async()=>{try{await M(`${b.timPengangkut}${e}/`,{method:"DELETE",headers:v()}),ie(`âœ… Tim "${t.namaTim}" berhasil dihapus`,"success"),setTimeout(()=>{Dt()},500)}catch(i){console.error("Error deleting tim:",i),ie(`âŒ Gagal menghapus tim: ${i.message}`,"danger")}})}catch(a){console.error("Error loading tim for deletion:",a),ie(`âŒ Gagal memuat data tim: ${a.message}`,"danger")}}window.editTim=wl;window.deleteTim=xl;let we=[],wa=1,xe=10,Y=null,Ja=null,Sa=null;async function Ll(e,a,t,i,s={}){if(!navigator.geolocation)throw i&&i("error","Browser tidak mendukung GPS"),new Error("Browser tidak mendukung geolocation");const o={...{enableHighAccuracy:!1,timeout:15e3,maximumAge:6e4,showAccuracyCircle:!0,moveToLocation:!0,zoomLevel:16},...s};return new Promise((l,r)=>{i&&i("loading"),navigator.geolocation.getCurrentPosition(c=>{try{const d=c.coords.latitude,m=c.coords.longitude,u=c.coords.accuracy||100;i&&i("success",{lat:d.toFixed(7),lng:m.toFixed(7),accuracy:Math.round(u)}),e&&o.moveToLocation&&e.setView([d,m],o.zoomLevel),t&&e.hasLayer(t)&&e.removeLayer(t);const g=L.divIcon({html:`
              <div style="
                position: relative;
                width: 50px;
                height: 50px;
              ">
                <div style="
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  width: 40px;
                  height: 40px;
                  background: #28a745;
                  border-radius: 50%;
                  border: 3px solid white;
                  box-shadow: 0 0 10px rgba(0,0,0,0.3);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 18px;
                ">
                  <i class="bi bi-crosshair"></i>
                </div>
              </div>
            `,className:"gps-marker",iconSize:[50,50],iconAnchor:[25,25]}),p=L.marker([d,m],{icon:g,title:"LOKASI GPS ANDA",draggable:!1,zIndexOffset:1e3});p.bindPopup(`
            <div style="max-width: 250px;">
              <strong style="color: #28a745;">
                <i class="bi bi-crosshair me-1"></i>LOKASI GPS ANDA
              </strong><br>
              <small>
                <b>Latitude:</b> ${d.toFixed(7)}<br>
                <b>Longitude:</b> ${m.toFixed(7)}<br>
                <b>Akurasi:</b> Â±${Math.round(u)} meter<br>
                <i>Diperoleh: ${new Date().toLocaleTimeString("id-ID")}</i>
              </small>
              <div class="mt-2">
                <button onclick="copyCoordinatesToClipboard('${d.toFixed(7)}, ${m.toFixed(7)}')" 
                        class="btn btn-sm btn-outline-success">
                  <i class="bi bi-clipboard me-1"></i>Salin Koordinat
                </button>
              </div>
            </div>
          `).openPopup(),p.addTo(e),a&&(a.setLatLng([d,m]),a.setOpacity(.7)),o.showAccuracyCircle&&u>0&&u<1e3&&L.circle([d,m],{radius:u,color:"#28a745",fillColor:"#28a745",fillOpacity:.1,weight:1}).addTo(e),setTimeout(()=>{e&&e.invalidateSize&&e.invalidateSize()},100),l({lat:d,lng:m,accuracy:u,marker:p})}catch(d){i&&i("error",d.message),r(d)}},c=>{let d="Gagal mendapatkan lokasi GPS";switch(c.code){case 1:d="Izin lokasi ditolak";break;case 2:d="Lokasi tidak tersedia";break;case 3:d="Waktu pencarian habis";break}i&&i("error",d),r(new Error(d))},{enableHighAccuracy:o.enableHighAccuracy,timeout:o.timeout,maximumAge:o.maximumAge})})}function $l(){const e=document.querySelectorAll(".needs-validation");Array.from(e).forEach(a=>{a.addEventListener("submit",t=>{a.checkValidity()||(t.preventDefault(),t.stopPropagation()),a.classList.add("was-validated")},!1)})}function Ke(e,a="info"){typeof x=="function"?x(e,a,3e3):alert(`${a.toUpperCase()}: ${e}`)}function El(e){if(!e)return{valid:!1,message:"Nomor WhatsApp harus diisi",cleanNoWA:""};const a=e.toString().replace(/\D/g,"");if(a.length<10)return{valid:!1,message:"Nomor WhatsApp terlalu pendek (minimal 10 digit)",cleanNoWA:a};if(a.length>13)return{valid:!1,message:"Nomor WhatsApp terlalu panjang (maksimal 15 digit)",cleanNoWA:a};if(a.startsWith("08")){const t=a.substring(2);if(t.length<8||t.length>10)return{valid:!1,message:"Nomor WhatsApp dengan format 08 harus memiliki 10-12 digit total",cleanNoWA:a}}return{valid:!0,cleanNoWA:a}}async function Tl(){const e=document.getElementById("mainContent");if(!document.getElementById("modalContainer")){const a=document.createElement("div");a.id="modalContainer",document.body.appendChild(a)}e.innerHTML=`
    <div class="anggota-admin-page">
      <!-- Header dengan gradient hijau -->
      <div class="card border-success mb-4 shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="text-success fw-bold mb-1">
                <i class="bi bi-people-fill me-2"></i>Manajemen Anggota
              </h2>
              <p class="text-muted mb-0">Kelola data anggota dan lihat lokasi pada peta</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Filter dan Search -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                  <i class="bi bi-search text-success"></i>
                </span>
                <input type="text" id="searchAnggota" class="form-control border-start-0" placeholder="Cari nama/alamat...">
              </div>
            </div>
            <div class="col-md-3">
              <select id="filterStatus" class="form-select">
                <option value="">Semua Status</option>
                <option value="aktif">Aktif</option>
                <option value="non-aktif">Non-Aktif</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="filterJenisSampah" class="form-select">
                <option value="">Semua Jenis Sampah</option>
                <option value="Rumah Tangga">Rumah Tangga</option>
                <option value="Tempat Usaha">Tempat Usaha</option>
              </select>
            </div>
            <div class="col-md-2">
              <button onclick="loadAnggotaWithMap()" class="btn btn-outline-success w-100">
                <i class="bi bi-funnel me-1"></i>Filter
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Peta Lokasi Anggota -->
      <div class="card border-success border-2 shadow-sm mb-4">
        <div class="card-header bg-success bg-opacity-10 border-bottom-0">
          <h5 class="card-title mb-0 text-success fw-semibold">
            <i class="bi bi-map me-2"></i>Peta Lokasi Anggota
          </h5>
          <small class="text-muted">Klik marker untuk melihat detail anggota</small>
        </div>
        <div class="card-body p-0">
          <div id="anggotaMap" style="height: 400px; border-radius: 0 0 8px 8px;"></div>
        </div>
      </div>
      
      <!-- Tabel Anggota -->
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div id="anggotaTableContainer" class="table-responsive">
            <div class="text-center py-5">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Memuat data anggota...</p>
            </div>
          </div>
          <div id="anggotaPagination" class="p-3 border-top"></div>
        </div>
      </div>
    </div>
  `,document.getElementById("searchAnggota").oninput=Ye,document.getElementById("filterStatus").onchange=Ye,document.getElementById("filterJenisSampah").onchange=Ye,Ye()}let Ae=null,us=[];async function Ye(){var i,s,n;const e=((i=document.getElementById("searchAnggota"))==null?void 0:i.value)||"",a=((s=document.getElementById("filterStatus"))==null?void 0:s.value)||"",t=((n=document.getElementById("filterJenisSampah"))==null?void 0:n.value)||"";try{we=(await M(b.anggota,{headers:v()})).filter(l=>{var m,u;const r=((m=l.nama)==null?void 0:m.toLowerCase().includes(e.toLowerCase()))||((u=l.alamat)==null?void 0:u.toLowerCase().includes(e.toLowerCase())),c=!a||l.status===a,d=!t||l.jenisSampah===t;return r&&c&&d}),wa=1,jt(),Sl(we)}catch(o){console.error("Error loading anggota:",o),document.getElementById("anggotaTableContainer").innerHTML=`
      <div class="alert alert-danger m-3">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Error loading anggota: ${o.message}
      </div>
    `}}function Sl(e){const a=document.getElementById("anggotaMap");a&&(Ae&&(Ae.remove(),Ae=null),us=[],a.innerHTML="",setTimeout(async()=>{try{if(await Gi(),e.length===0){a.innerHTML=`
          <div class="h-100 d-flex flex-column align-items-center justify-content-center bg-light">
            <i class="bi bi-map text-muted mb-3" style="font-size: 3rem;"></i>
            <p class="text-muted">Tidak ada data anggota untuk ditampilkan</p>
          </div>
        `;return}Ae=L.map("anggotaMap").setView([-10.1935921,123.6149376],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:19}).addTo(Ae);const t=[];e.forEach(i=>{var s,n;if(i.latitude&&i.longitude){const o=i.status==="aktif"?"#28a745":"#dc3545",l=L.divIcon({html:`
              <div style="
                background: ${o};
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 16px;
                border: 3px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                cursor: pointer;
              ">
                ${((s=i.nama)==null?void 0:s.charAt(0).toUpperCase())||"?"}
              </div>
            `,className:"anggota-marker",iconSize:[40,40],iconAnchor:[20,20]}),r=L.marker([i.latitude,i.longitude],{icon:l,riseOnHover:!0}).addTo(Ae).bindPopup(`
              <div class="popup-content" style="min-width: 250px;">
                <div class="d-flex align-items-center mb-2">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                    <i class="bi bi-person-circle text-success"></i>
                  </div>
                  <div>
                    <h6 class="mb-0 fw-semibold">${i.nama||"Tidak ada nama"}</h6>
                    <small class="text-muted">ID: ${i.idAnggota}</small>
                  </div>
                </div>
                <div class="mb-2">
                  <small class="text-muted d-block">Alamat:</small>
                  <div class="small">${((n=i.alamat)==null?void 0:n.substring(0,100))||"Tidak ada alamat"}...</div>
                </div>
                <div class="row g-2 mb-2">
                  <div class="col-6">
                    <small class="text-muted d-block">Status:</small>
                    <span class="badge ${i.status==="aktif"?"bg-success":"bg-danger"}">
                      ${i.status==="aktif"?"Aktif":"Non-Aktif"}
                    </span>
                  </div>
                  <div class="col-6">
                    <small class="text-muted d-block">Jenis:</small>
                    <span class="badge bg-info">${i.jenisSampah||"-"}</span>
                  </div>
                </div>
                <div class="mt-3">
                  <button onclick="viewDetailFromMap(${i.idAnggota})" 
                          class="btn btn-sm btn-success w-100">
                    <i class="bi bi-eye me-1"></i>Lihat Detail
                  </button>
                </div>
              </div>
            `);us.push(r),t.push([i.latitude,i.longitude])}}),t.length>0&&Ae.fitBounds(t,{padding:[50,50]}),window.viewDetailFromMap=Ji}catch(t){console.error("Error rendering map:",t),a.innerHTML=`
        <div class="h-100 d-flex flex-column align-items-center justify-content-center bg-light">
          <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
          <p class="text-danger">Gagal memuat peta: ${t.message}</p>
        </div>
      `}},100))}function jt(){const e=document.getElementById("anggotaTableContainer"),a=document.getElementById("anggotaPagination");if(!e)return;const t=we.length,i=Math.ceil(t/xe);wa>i&&i>0&&(wa=i);const s=(wa-1)*xe,n=s+xe,o=we.slice(s,n);if(t===0){e.innerHTML=`
      <div class="text-center py-5">
        <i class="bi bi-people text-muted mb-3" style="font-size: 3rem;"></i>
        <h5 class="text-muted">Tidak ada data anggota</h5>
        <p class="text-muted">Coba ubah filter pencarian</p>
      </div>
    `,a.innerHTML="";return}const l=s+1,r=`
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th scope="col" width="60" class="ps-4">No</th>
          <th scope="col" class="ps-4">ID</th>
          <th scope="col">Nama</th>
          <th scope="col">Alamat</th>
          <th scope="col">No WA</th>
          <th scope="col">Status</th>
          <th scope="col">Koordinat</th>
          <th scope="col" class="text-center pe-4">Aksi</th>
        </tr>
      </thead>
      <tbody>
        ${o.map((c,d)=>`
          <tr>
            <td class="ps-4 text-muted fw-semibold">
              ${l+d} <!-- PERBAIKAN: Nomor urut yang benar -->
            </td>
            <td class="ps-4 fw-semibold">${c.idAnggota}</td>
            <td>
              <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                  <i class="bi bi-person-circle text-success"></i>
                </div>
                <div>
                  <div class="fw-medium">${c.nama}</div>
                  <small class="text-muted">${c.jenisSampah}</small>
                </div>
              </div>
            </td>
            <td>${c.alamat?c.alamat.substring(0,30)+"...":"-"}</td>
            <td>
              ${c.noWA?`
                <a href="https://wa.me/${c.noWA.replace(/[^0-9]/g,"")}" 
                   target="_blank" class="text-decoration-none">
                  <i class="bi bi-whatsapp text-success me-1"></i>${c.noWA}
                </a>
              `:"-"}
            </td>
            <td>
              <span class="badge ${c.status==="aktif"?"bg-success":"bg-danger"}">
                ${c.status==="aktif"?"Aktif":"Non-Aktif"}
              </span>
            </td>
            <td>
              <small class="text-muted d-block">${c.latitude?c.latitude.toFixed(4):"-"}</small>
              <small class="text-muted">${c.longitude?c.longitude.toFixed(4):"-"}</small>
            </td>
            <td class="text-center pe-4">
              <div class="btn-group btn-group-sm" role="group">
                <button onclick="window.viewAnggotaDetail(${c.idAnggota})" class="btn btn-outline-success">
                  <i class="bi bi-eye"></i>
                </button>
                <button onclick="window.editAnggota(${c.idAnggota})" class="btn btn-outline-warning">
                  <i class="bi bi-pencil"></i>
                </button>
                <button onclick="window.deleteAnggota(${c.idAnggota})" class="btn btn-outline-danger">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;e.innerHTML=r,Al(i),Ml()}function Al(e){const a=document.getElementById("anggotaPagination");if(!a)return;if(e<=1){a.innerHTML=`
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">Menampilkan semua data (${we.length} anggota)</small>
      </div>
    `;return}const t=(wa-1)*xe+1,i=Math.min(wa*xe,we.length);let s=Math.max(1,wa-2),n=Math.min(e,s+4);n-s<4&&(s=Math.max(1,n-4));const o=[];wa>1?o.push(`
      <li class="page-item">
        <button class="page-link" onclick="window.goToPage(${wa-1})">
          <i class="bi bi-chevron-left"></i>
        </button>
      </li>
    `):o.push(`
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-left"></i>
        </span>
      </li>
    `);for(let c=s;c<=n;c++)c===wa?o.push(`
        <li class="page-item active">
          <span class="page-link">${c}</span>
        </li>
      `):o.push(`
        <li class="page-item">
          <button class="page-link" onclick="window.goToPage(${c})">${c}</button>
        </li>
      `);wa<e?o.push(`
      <li class="page-item">
        <button class="page-link" onclick="window.goToPage(${wa+1})">
          <i class="bi bi-chevron-right"></i>
        </button>
      </li>
    `):o.push(`
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-right"></i>
        </span>
      </li>
    `);const r=[5,10,20,50].map(c=>`<option value="${c}" ${xe===c?"selected":""}>${c}</option>`).join("");a.innerHTML=`
    <div class="d-flex flex-wrap justify-content-between align-items-center">
      <div class="mb-2 mb-md-0">
        <small class="text-muted">
          Menampilkan ${t} - ${i} dari ${we.length} anggota
        </small>
      </div>
      
      <div class="d-flex align-items-center">
        <div class="me-3 d-none d-md-block">
          <small class="text-muted me-2">Data per halaman:</small>
          <select id="anggotaPerPageSelect" class="form-select form-select-sm" style="width: auto;">
            ${r}
          </select>
        </div>
        
        <nav>
          <ul class="pagination pagination-sm mb-0">
            ${o.join("")}
          </ul>
        </nav>
      </div>
    </div>
  `,Bl()}function Bl(){const e=document.getElementById("anggotaPerPageSelect");e&&e.addEventListener("change",a=>{xe=parseInt(a.target.value),wa=1,jt()}),window.goToPage=a=>{if(a<1||a>Math.ceil(we.length/xe))return;wa=a,jt();const t=document.getElementById("anggotaTableContainer");t&&t.scrollIntoView({behavior:"smooth",block:"start"})}}function Ml(){window.viewAnggotaDetail=Ji,window.editAnggota=qs,window.deleteAnggota=Zs}function Il(e){wa=e,jt();const a=document.getElementById("anggotaTableContainer");a&&a.scrollIntoView({behavior:"smooth",block:"start"})}async function qs(e){try{const a=await M(`${b.anggota}${e}/`,{headers:v()}),t=o=>{if(!o)return"";try{return new Date(o).toISOString().split("T")[0]}catch{return""}};let i=a.user;if(typeof a.user=="number")try{i=await M(`${b.users}${a.user}/`,{headers:v()})}catch(o){console.error("Error fetching user data:",o),i=null}const s={nama:a.nama||"",alamat:a.alamat||"",noWA:a.noWA||"",latitude:a.latitude||0,longitude:a.longitude||0,tanggalStart:a.tanggalStart||"",tanggalEnd:a.tanggalEnd||"",status:a.status||"aktif",jenisSampah:a.jenisSampah||"Rumah Tangga",userId:i?i.id:null},n=`
      <div class="anggota-form-container">
        <div class="row">
          <!-- Informasi User (Display Only) -->
          <div class="col-12 mb-4">
            <div class="card ${i?"border-info":"border-warning"} border-2">
              <div class="card-header ${i?"bg-info":"bg-warning"} bg-opacity-10">
                <h6 class="card-title mb-0 ${i?"text-info":"text-warning"}">
                  <i class="bi bi-person-badge me-2"></i>
                  ${i?"Informasi Akun User":"Peringatan: Tidak Ada Akun User"}
                </h6>
              </div>
              <div class="card-body">
                ${i?`
                <div class="row">
                  <div class="col-md-4">
                    <div class="d-flex align-items-center">
                      <div class="${i.is_active?"bg-info":"bg-secondary"} bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="bi bi-person-fill ${i.is_active?"text-info":"text-secondary"} fs-4"></i>
                      </div>
                      <div>
                        <h5 class="mb-0">${i.username||"Tidak ada username"}</h5>
                        <small class="text-muted">Username</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <p class="mb-1"><strong>Email:</strong></p>
                    <p class="text-muted">${i.email||"Tidak ada email"}</p>
                  </div>
                  <div class="col-md-4">
                    <p class="mb-1"><strong>Status:</strong></p>
                    <span class="badge ${i.is_active?"bg-success":"bg-secondary"}">
                      ${i.is_active?"Aktif":"Non-Aktif"}
                    </span>
                  </div>
                </div>
                <input type="hidden" id="user" value="${i.id}">
                `:`
                <div class="alert alert-warning">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle fs-4 me-3"></i>
                    <div>
                      <h6 class="alert-heading mb-2">Anggota ini belum memiliki akun user</h6>
                      <p class="mb-0">
                        Hubungkan dengan akun user yang sudah ada
                      </p>
                    </div>
                  </div>
                  <div class="mt-3">
                    <label for="userSelect" class="form-label">Pilih User yang ada:</label>
                    <select id="userSelect" class="form-select" required>
                      <option value="">Pilih User...</option>
                      <!-- Options akan diisi via JavaScript -->
                    </select>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Silakan pilih user.</div>
                  </div>
                </div>
                `}
              </div>
            </div>
          </div>
          
          <!-- Form Edit Anggota -->
          <div class="col-lg-6">
            <div class="card h-100 border-warning border-2">
              <div class="card-header bg-warning bg-opacity-10">
                <h6 class="card-title mb-0 text-warning">
                  <i class="bi bi-person-lines-fill me-2"></i>Informasi Anggota
                </h6>
              </div>
              <div class="card-body">
                <form id="anggotaFormEdit" class="needs-validation" novalidate>
                  <div class="mb-3">
                    <label for="nama" class="form-label">
                      <i class="bi bi-card-text me-1"></i>Nama Lengkap *
                    </label>
                    <input type="text" id="nama" class="form-control" 
                           placeholder="Masukkan nama lengkap" 
                           value="${a.nama||""}" required>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Silakan isi nama lengkap.</div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="alamat" class="form-label">
                      <i class="bi bi-house me-1"></i>Alamat *
                    </label>
                    <textarea id="alamat" class="form-control" rows="3" 
                              placeholder="Masukkan alamat lengkap" required>${a.alamat||""}</textarea>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Silakan isi alamat.</div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="noWA" class="form-label">
                      <i class="bi bi-whatsapp me-1"></i>Nomor WhatsApp *
                    </label>
                    <input type="text" id="noWA" maxlength="12" class="form-control" 
                           placeholder="Contoh: 081234567890" 
                           value="${a.noWA||""}" required>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Silakan isi nomor WhatsApp.</div>
                  </div>
                  
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="tanggalStart" class="form-label">
                        <i class="bi bi-calendar-plus me-1"></i>Tanggal Mulai *
                      </label>
                      <input type="date" id="tanggalStart" class="form-control" 
                             value="${t(a.tanggalStart)}" required>
                      <div class="valid-feedback">Valid.</div>
                      <div class="invalid-feedback">Silakan pilih tanggal start.</div>
                    </div>
                    <div class="col-md-6">
                      <label for="tanggalEnd" class="form-label">
                        <i class="bi bi-calendar-minus me-1"></i>Tanggal Berakhir *
                      </label>
                      <input type="date" id="tanggalEnd" class="form-control" 
                             value="${t(a.tanggalEnd)}" required>
                      <div class="valid-feedback">Valid.</div>
                      <div class="invalid-feedback">Silakan pilih tanggal end.</div>
                    </div>
                  </div>
                  
                  <div class="row g-3 mt-3">
                    <div class="col-md-6">
                      <label for="status" class="form-label">
                        <i class="bi bi-check-circle me-1"></i>Status *
                      </label>
                      <select id="status" class="form-select" required>
                        <option value="">Pilih Status</option>
                        <option value="aktif" ${a.status==="aktif"?"selected":""}>Aktif</option>
                        <option value="non-aktif" ${a.status==="non-aktif"?"selected":""}>Non-Aktif</option>
                      </select>
                      <div class="valid-feedback">Valid.</div>
                      <div class="invalid-feedback">Silakan pilih status.</div>
                    </div>
                    <div class="col-md-6">
                      <label for="jenisSampah" class="form-label">
                        <i class="bi bi-trash me-1"></i>Jenis Sampah *
                      </label>
                      <select id="jenisSampah" class="form-select" required>
                        <option value="">Pilih Jenis</option>
                        <option value="Rumah Tangga" ${a.jenisSampah==="Rumah Tangga"?"selected":""}>Rumah Tangga</option>
                        <option value="Tempat Usaha" ${a.jenisSampah==="Tempat Usaha"?"selected":""}>Tempat Usaha</option>
                      </select>
                      <div class="valid-feedback">Valid.</div>
                      <div class="invalid-feedback">Silakan pilih jenis sampah.</div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <!-- Peta Lokasi -->
          <div class="col-lg-6">
            <div class="card h-100 border-warning border-2">
              <div class="card-header bg-warning bg-opacity-10">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="card-title mb-0 text-warning">
                    <i class="bi bi-geo-alt me-2"></i>Lokasi di Peta
                  </h6>
                  <div>
                    <button type="button" id="btnGetGPSLocationEdit" class="btn btn-warning btn-sm me-2">
                      <i class="bi bi-crosshair me-1"></i>Lokasi Saya
                    </button>
                    <button type="button" onclick="setAnggotaEditLocation(${a.latitude||-10.1935921}, ${a.longitude||123.6149376}, 'Lokasi Asli')" 
                            class="btn btn-outline-warning btn-sm">
                      <i class="bi bi-arrow-return-left me-1"></i>Reset
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="card-body">
                <!-- Status GPS -->
                <div id="gpsStatusEdit" class="mb-2">
                  <div id="gpsLoadingEdit" style="display: none;">
                    <span class="spinner-border spinner-border-sm text-warning me-2"></span>
                    <small class="text-warning">Mendapatkan lokasi...</small>
                  </div>
                  <div id="gpsSuccessEdit" style="display: none;">
                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                    <small class="text-success">Lokasi GPS diterapkan</small>
                  </div>
                  <div id="gpsErrorEdit" style="display: none;">
                    <i class="bi bi-exclamation-circle-fill text-danger me-1"></i>
                    <small class="text-danger">Gagal mendapatkan lokasi</small>
                  </div>
                </div>
                
                <div class="alert alert-info mb-3">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Instruksi:</strong> Klik di peta untuk mengubah lokasi. 
                  Gunakan tombol "Lokasi Saya" untuk GPS atau tombol lain untuk lokasi cepat.
                </div>
                
                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label for="latitude" class="form-label">Latitude *</label>
                    <div class="input-group">
                      <input type="number" step="any" id="latitude" 
                             class="form-control" value="${a.latitude||""}" required>
                      <button type="button" class="btn btn-outline-secondary" 
                              onclick="copyAnggotaEditToClipboard('latitude')">
                        <i class="bi bi-clipboard"></i>
                      </button>
                      <div class="valid-feedback">Valid.</div>
                      <div class="invalid-feedback">Silakan klik peta untuk memilih lokasi.</div>
                    </div>
                    <small class="text-muted">Format: -10.1711872</small>
                  </div>
                  <div class="col-md-6">
                    <label for="longitude" class="form-label">Longitude *</label>
                    <div class="input-group">
                      <input type="number" step="any" id="longitude" 
                             class="form-control" value="${a.longitude||""}" required>
                      <button type="button" class="btn btn-outline-secondary" 
                              onclick="copyAnggotaEditToClipboard('longitude')">
                        <i class="bi bi-clipboard"></i>
                      </button>
                      <div class="valid-feedback">Valid.</div>
                      <div class="invalid-feedback">Silakan klik peta untuk memilih lokasi.</div>
                    </div>
                    <small class="text-muted">Format: 123.6149376</small>
                  </div>
                </div>
                
                <!-- Lokasi Cepat -->
                <div class="mb-3">
                  <label class="form-label">
                    <i class="bi bi-lightning-charge me-1"></i>Lokasi Cepat
                  </label>
                  <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            onclick="setAnggotaEditLocation(-10.1711872, 123.6149376, 'Lokasi Saya')">
                      <i class="bi bi-house me-1"></i> Lokasi Saya
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm"
                            onclick="setAnggotaEditLocation(-10.1935921, 123.6149376, 'Kota Kupang')">
                      <i class="bi bi-geo-alt me-1"></i> Kota Kupang
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm"
                            onclick="setAnggotaEditLocation(${a.latitude||-10.1711872}, ${a.longitude||123.6149376}, 'Lokasi Asli')">
                      <i class="bi bi-arrow-return-left me-1"></i> Lokasi Asli
                    </button>
                  </div>
                </div>
                
                <div id="mapContainerAnggotaEdit" 
                     style="height: 300px; border-radius: 8px; border: 1px solid #dee2e6;"
                     class="position-relative">
                  <div id="mapLoadingEdit" class="text-center py-5">
                    <div class="spinner-border text-warning" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Memuat peta...</p>
                  </div>
                  <div id="mapErrorEdit" class="d-none text-center py-5">
                    <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                    <p class="mt-2">Peta tidak dapat dimuat</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Error Message -->
        <div id="formMessageEdit" class="mt-4"></div>
      </div>
    `;P(`Edit Anggota: ${a.nama}`,n,async()=>{const o=document.getElementById("anggotaFormEdit");if(o.classList.remove("was-validated"),!o.checkValidity()){o.classList.add("was-validated");const f=o.querySelector(":invalid");return f&&(f.scrollIntoView({behavior:"smooth",block:"center"}),f.focus()),!1}const l=El(document.getElementById("noWA").value);if(!l.valid){Ke(`<strong>Error:</strong> ${l.message}`,"error");const f=document.getElementById("noWA");return f.classList.add("is-invalid"),f.focus(),!1}const r=new Date(document.getElementById("tanggalStart").value);if(new Date(document.getElementById("tanggalEnd").value)<r){Ke("<strong>Error:</strong> Tanggal End tidak boleh lebih awal dari Tanggal Start.","error");const f=document.getElementById("tanggalEnd");return f.classList.add("is-invalid"),f.focus(),!1}const d=parseFloat(document.getElementById("latitude").value),m=parseFloat(document.getElementById("longitude").value);if(isNaN(d)||isNaN(m)){Ke("<strong>Error:</strong> Koordinat tidak valid. Klik peta untuk memilih lokasi.","error");const f=document.getElementById("latitude");return f.classList.add("is-invalid"),f.focus(),!1}let u;if(i)u=i.id;else{const f=document.getElementById("userSelect");if(u=f?parseInt(f.value):null,!u){Ke("<strong>Error:</strong> Anggota harus terhubung dengan akun user.","error");const k=document.getElementById("userSelect");return k.classList.add("is-invalid"),k.focus(),!1}}const g={nama:document.getElementById("nama").value,alamat:document.getElementById("alamat").value,noWA:l.cleanNoWA,latitude:d,longitude:m,tanggalStart:document.getElementById("tanggalStart").value,tanggalEnd:document.getElementById("tanggalEnd").value,status:document.getElementById("status").value,jenisSampah:document.getElementById("jenisSampah").value,userId:u};console.log("Data awal:",s),console.log("Data sekarang:",g);const p=g.nama!==s.nama||g.alamat!==s.alamat||g.noWA!==s.noWA||Math.abs(g.latitude-s.latitude)>1e-5||Math.abs(g.longitude-s.longitude)>1e-5||g.tanggalStart!==s.tanggalStart||g.tanggalEnd!==s.tanggalEnd||g.status!==s.status||g.jenisSampah!==s.jenisSampah||g.userId&&g.userId!==s.userId;if(console.log("Ada perubahan?",p),!p)return Ke("Tidak ada perubahan data yang dilakukan. Simpan dibatalkan.","warning"),!1;const h={...u&&{user:u},nama:g.nama,alamat:g.alamat,noWA:g.noWA,latitude:g.latitude,longitude:g.longitude,tanggalStart:g.tanggalStart,tanggalEnd:g.tanggalEnd,status:g.status,jenisSampah:g.jenisSampah};Ke("Menyimpan perubahan data anggota...","info");try{return await M(`${b.anggota}${e}/`,{method:"PUT",headers:v(),body:JSON.stringify(h)}),x(`âœ… Berhasil! Data anggota "${g.nama}" berhasil diperbarui.`,"success",5e3),setTimeout(()=>{Ye(),Ra()},2e3),!0}catch(f){return console.error("Error updating anggota:",f),x(`<strong>Error:</strong> ${f.message}`,"error",3e3),!1}}),i||setTimeout(()=>{Pl()},300),setTimeout(()=>{Cl(a.latitude,a.longitude),$l(),setTimeout(()=>{const o=document.getElementById("btnGetGPSLocationEdit");o&&(o.onclick=()=>Ws())},500)},300)}catch(a){console.error("Error loading anggota data:",a),x(`<strong>Error:</strong> Gagal memuat data anggota: ${a.message}`,"error",3e3)}}window.resetToOriginalLocation=function(){const e=document.getElementById("latitude"),a=document.getElementById("longitude");if(!e||!a)return;const t=parseFloat(e.defaultValue||e.dataset.original||e.value),i=parseFloat(a.defaultValue||a.dataset.original||a.value);if(isNaN(t)||isNaN(i)){ut(`
      <div class="alert alert-warning alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Tidak dapat reset!</strong> Koordinat asli tidak ditemukan.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `);return}Nt(t.toFixed(7),i.toFixed(7)),Y&&(Y.setView([t,i],15),Ja&&(Ja.setLatLng([t,i]),Ja.setOpacity(1)),Sa&&Y.hasLayer(Sa)&&(Y.removeLayer(Sa),Sa=null),yt("manual"),setTimeout(()=>{Y&&Y.invalidateSize&&Y.invalidateSize()},100)),ut(`
    <div class="alert alert-info alert-dismissible fade show">
      <i class="bi bi-check-circle-fill me-2"></i>
      <strong>Lokasi direset!</strong> Kembali ke koordinat asli.
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `)};window.copyToClipboard=function(e){const a=document.getElementById(e);if(a){a.select(),document.execCommand("copy");const t=a.value;a.value="âœ“ Disalin!",setTimeout(()=>{a.value=t},1e3),showFormMessage(`
      <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong>Berhasil disalin!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `)}};function Vs(e,a=5e3){return new Promise((t,i)=>{const s=Date.now(),n=()=>{const o=document.querySelector(e);if(o){t(o);return}if(Date.now()-s>a){i(new Error(`Element ${e} not found after ${a}ms`));return}setTimeout(n,100)};n()})}async function Pl(){try{const e=await M(b.users,{headers:v()}),a=document.getElementById("userSelect");if(a){const t=e.filter(s=>(s.role==="anggota"||s.role==="tamu")&&s.is_active);if(t.length===0){a.innerHTML=`
          <option value="">Tidak ada user yang tersedia</option>
          <option value="" disabled>
            Semua user sudah memiliki data anggota atau tidak aktif
          </option>
        `;return}const i=t.map(s=>`<option value="${s.id}">
          ${s.username} - ${s.email||"no email"} (${s.role})
        </option>`).join("");a.innerHTML='<option value="">Pilih User...</option>'+i}}catch(e){console.error("Error loading users for dropdown:",e)}}async function Cl(e,a){const t="mapContainerAnggotaEdit",i=`#${t}`,s="latitude",n="longitude",o=document.getElementById(t);if(!o)return;const l=document.getElementById("mapLoadingEdit"),r=document.getElementById("mapErrorEdit");l&&l.classList.remove("d-none"),r&&r.classList.add("d-none");try{await Gi(),await Vs(i),o.clientHeight===0&&(o.style.height="300px"),Y&&(Y.remove(),Y=null);const c=parseFloat(e)||-10.1935921,d=parseFloat(a)||123.6149376,m=c.toFixed(7),u=d.toFixed(7);Y=L.map(t).setView([c,d],15),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19}).addTo(Y),Ja=L.marker([c,d],{draggable:!0,title:"Lokasi Anggota"}).addTo(Y),Ja.bindPopup(`
      <div style="max-width: 200px;">
        <strong>ðŸ“ Lokasi Anggota</strong><br>
        <small>
          Lat: ${m}<br>
          Lng: ${u}<br>
          <em>Drag untuk mengubah lokasi</em>
        </small>
      </div>
    `).openPopup(),Ja.on("dragend",function(p){const h=Ja.getLatLng(),f=h.lat.toFixed(7),k=h.lng.toFixed(7);Nt(f,k),Sa&&Y.hasLayer(Sa)&&(Y.removeLayer(Sa),Sa=null),yt("manual")}),Y.on("click",function(p){const{lat:h,lng:f}=p.latlng,k=h.toFixed(7),w=f.toFixed(7);Nt(k,w),Ja.setLatLng([h,f]),Sa&&Y.hasLayer(Sa)&&(Y.removeLayer(Sa),Sa=null),yt("manual")});const g=document.getElementById("btnGetGPSLocationEdit");g&&(g.onclick=()=>Ws()),document.getElementById(s).addEventListener("input",gs),document.getElementById(n).addEventListener("input",gs),l&&l.classList.add("d-none"),console.log("Anggota edit map initialized successfully")}catch(c){console.error("Failed to initialize edit map:",c),l&&l.classList.add("d-none"),r&&r.classList.remove("d-none");const d=document.getElementById(s),m=document.getElementById(n);d&&!d.value&&(d.value=e||"-10.1935921"),m&&!m.value&&(m.value=a||"123.6149376")}}async function Ws(){const e=document.getElementById("btnGetGPSLocationEdit");if(!e||!Y){ut(`
      <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Error!</strong> Peta belum siap atau tombol tidak ditemukan.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `);return}const a=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="bi bi-hourglass-split me-1"></i> Mendapatkan lokasi...';try{const t=await Ll(Y,Ja,Sa,(i,s)=>{yt(i,s)},{moveToLocation:!0,zoomLevel:16,showAccuracyCircle:!0});Nt(t.lat.toFixed(7),t.lng.toFixed(7)),Sa=t.marker,ut(`
      <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong>Lokasi GPS Berhasil Diambil!</strong>
        <small class="d-block">
          Latitude: ${t.lat.toFixed(7)}<br>
          Longitude: ${t.lng.toFixed(7)}<br>
          Akurasi: Â±${Math.round(t.accuracy)} meter
        </small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `)}catch(t){console.error("GPS Error:",t),ut(`
      <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>${t.message||"Gagal mendapatkan lokasi GPS"}</strong>
        <small class="d-block">
          Pastikan browser memiliki akses lokasi dan GPS perangkat aktif.
        </small>
        <div class="mt-2">
          <button onclick="useManualLocationFallback()" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-geo-alt me-1"></i>Gunakan Lokasi Default
          </button>
        </div>
      </div>
    `),yt("error")}finally{e.disabled=!1,e.innerHTML=a}}window.copyCoordinatesToClipboard=async function(e){try{await navigator.clipboard.writeText(e),x("Koordinat berhasil disalin ke clipboard","success",2e3)}catch(a){console.error("Gagal menyalin koordinat:",a),x("Gagal menyalin koordinat","error",2e3)}};function Dl(){window.accuracyCircles&&window.accuracyCircles.length>0&&(window.accuracyCircles.forEach(e=>{e&&e.remove&&e.remove()}),window.accuracyCircles=[])}if(typeof P=="function"){const e=P;window.showModal=function(a,t,i,s){return Dl(),e(a,t,i,s)}}function Nt(e,a){const t=document.getElementById("latitude"),i=document.getElementById("longitude");t&&i&&(t.value=e,i.value=a,t.dataset.changed="true",i.dataset.changed="true")}function gs(){if(!Y)return;const e=parseFloat(document.getElementById("latitude").value),a=parseFloat(document.getElementById("longitude").value);isNaN(e)||isNaN(a)||(Ja&&Ja.setLatLng([e,a]),Y.setView([e,a],Y.getZoom()))}function yt(e,a=null){const t=document.getElementById("gpsLoadingEdit"),i=document.getElementById("gpsSuccessEdit"),s=document.getElementById("gpsErrorEdit");if(!(!t||!i||!s))switch(t.style.display="none",i.style.display="none",s.style.display="none",e){case"loading":t.style.display="block";break;case"success":a?i.innerHTML=`
          <i class="bi bi-check-circle-fill text-success me-1"></i>
          <small class="text-success">ðŸ“ Lokasi GPS diterapkan! (${a.lat}, ${a.lng})</small>
        `:i.innerHTML=`
          <i class="bi bi-check-circle-fill text-success me-1"></i>
          <small class="text-success">ðŸ“ Lokasi GPS diterapkan!</small>
        `,i.style.display="block";break;case"error":s.style.display="block";break;case"manual":i.innerHTML=`
        <i class="bi bi-geo-alt-fill text-primary me-1"></i>
        <small class="text-primary">ðŸ“ Lokasi dipilih manual di peta</small>
      `,i.style.display="block";break}}function ut(e){const a=document.getElementById("formMessageEdit");a&&(a.innerHTML=e,setTimeout(()=>{a.innerHTML===e&&(a.innerHTML="")},3e3))}function ps(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"})}catch{return e}}function jl(e){if(!e)return!1;try{return new Date(e)<new Date}catch{return!1}}async function Ji(e){try{const a=await M(`${b.anggota}${e}/`,{headers:v()}),t=a.latitude&&a.longitude?`
      <div class="col-12 mt-3">
        <div class="card border-success">
          <div class="card-header bg-success bg-opacity-10 py-2">
            <h6 class="mb-0"><i class="bi bi-map me-2"></i>Peta Lokasi</h6>
          </div>
          <div class="card-body p-0">
            <div id="detailMap-${e}" 
                 style="height: 300px; border-radius: 0 0 8px 8px;">
              <div class="h-100 d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2 text-muted">Memuat peta...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `:`
      <div class="col-12 mt-3">
        <div class="card border-warning">
          <div class="card-header bg-warning bg-opacity-10 py-2">
            <h6 class="mb-0"><i class="bi bi-map me-2"></i>Peta Lokasi</h6>
          </div>
          <div class="card-body">
            <div class="text-center py-4">
              <i class="bi bi-geo-alt text-warning fs-1 mb-3"></i>
              <p class="text-muted">Lokasi belum ditentukan</p>
            </div>
          </div>
        </div>
      </div>
    `;P(`Detail Anggota: ${a.nama}`,`
        <div class="detail-container">
          <div class="row">
            <!-- Kolom Kiri - Foto dan Info Dasar -->
            <div class="col-md-4">
              <div class="text-center mb-4">
                <div class="bg-success bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                     style="width: 100px; height: 100px; font-size: 40px;">
                  <i class="bi bi-person-fill text-white"></i>
                </div>
                <h4 class="fw-bold">${a.nama||"-"}</h4>
                <span class="badge ${a.status==="aktif"?"bg-success":"bg-danger"} fs-6">
                  ${a.status==="aktif"?"Aktif":"Non-Aktif"}
                </span>
                
                <div class="mt-3 d-grid">
                  ${a.noWA?`
                    <button class="btn btn-success mb-2" onclick="chatWhatsApp('${a.noWA}', 'Halo ${a.nama||""}, ini dari admin Bank Sampah')">
                      <i class="bi bi-whatsapp me-1"></i>Chat via WhatsApp
                    </button>
                  `:""}
                  
                  ${a.latitude&&a.longitude?`
                    <button class="btn btn-outline-primary" onclick="window.open('https://www.google.com/maps?q=${a.latitude},${a.longitude}', '_blank')">
                      <i class="bi bi-geo-alt me-1"></i>Lihat di Maps
                    </button>
                  `:""}
                </div>
              </div>
              
              <div class="card border-success mb-3">
                <div class="card-header bg-success bg-opacity-10 py-2">
                  <h6 class="mb-0"><i class="bi bi-qr-code me-2"></i>ID Anggota</h6>
                </div>
                <div class="card-body text-center py-3">
                  <div class="bg-light rounded-3 p-3">
                    <div class="font-monospace fs-4 fw-bold">${a.idAnggota||"N/A"}</div>
                    <small class="text-muted">ID Unik Anggota</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Kolom Kanan - Detail Lengkap -->
            <div class="col-md-8">
              <div class="row g-3">
                <!-- Informasi Kontak -->
                <div class="col-12">
                  <div class="card border-primary">
                    <div class="card-header bg-primary bg-opacity-10 py-2">
                      <h6 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Informasi Kontak</h6>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-6 mb-2">
                          <strong><i class="bi bi-whatsapp text-success me-2"></i>WhatsApp</strong>
                          <div class="mt-1">${a.noWA||"-"}</div>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong><i class="bi bi-geo-alt text-danger me-2"></i>Jenis Sampah</strong>
                          <div class="mt-1">
                            <span class="badge ${a.jenisSampah==="Rumah Tangga"?"bg-info":"bg-warning"}">
                              ${a.jenisSampah||"-"}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Alamat Lengkap -->
                <div class="col-12">
                  <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10 py-2">
                      <h6 class="mb-0"><i class="bi bi-house-door me-2"></i>Alamat Lengkap</h6>
                    </div>
                    <div class="card-body">
                      <p class="mb-0">${a.alamat||"Alamat belum diisi"}</p>
                    </div>
                  </div>
                </div>
                
                <!-- Koordinat Lokasi -->
                <div class="col-md-6">
                  <div class="card border-info">
                    <div class="card-header bg-info bg-opacity-10 py-2">
                      <h6 class="mb-0"><i class="bi bi-geo me-2"></i>Koordinat</h6>
                    </div>
                    <div class="card-body">
                      <div class="row g-2">
                        <div class="col-12">
                          <strong>Latitude</strong>
                          <div class="input-group input-group-sm mt-1">
                            <input type="text" class="form-control" value="${a.latitude||"0"}" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboardValue('${a.latitude||""}')">
                              <i class="bi bi-clipboard"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-12">
                          <strong>Longitude</strong>
                          <div class="input-group input-group-sm mt-1">
                            <input type="text" class="form-control" value="${a.longitude||"0"}" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboardValue('${a.longitude||""}')">
                              <i class="bi bi-clipboard"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Periode Keanggotaan -->
                <div class="col-md-6">
                  <div class="card border-success">
                    <div class="card-header bg-success bg-opacity-10 py-2">
                      <h6 class="mb-0"><i class="bi bi-calendar me-2"></i>Periode Keanggotaan</h6>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-12 mb-2">
                          <strong>Mulai</strong>
                          <div class="mt-1">${ps(a.tanggalStart)}</div>
                        </div>
                        <div class="col-12 mb-2">
                          <strong>Berakhir</strong>
                          <div class="mt-1">
                            ${ps(a.tanggalEnd)}
                            ${jl(a.tanggalEnd)?'<span class="badge bg-danger ms-1">Kedaluwarsa</span>':""}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Peta Lokasi (ditambahkan) -->
                ${t}
              
              <!-- Tombol Aksi -->
              <div class="mt-4 pt-3 border-top">
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-success" onclick="editAnggota(${e})">
                    <i class="bi bi-pencil me-1"></i>Edit Anggota
                  </button>
                  <button class="btn btn-danger ms-auto" onclick="deleteAnggota(${e})">
                    <i class="bi bi-trash me-1"></i>Hapus Anggota
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `,null,()=>{window.location.hash.includes("/anggota/")&&(window.location.hash="#/anggota")}),a.latitude&&a.longitude&&setTimeout(()=>{Ys(a)},500),window.location.hash=`#/anggota/${e}`}catch(a){console.error("Error loading detail:",a),P("Error",`
        <div class="text-center py-4">
          <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
          <h5 class="text-danger">Gagal Memuat Detail Anggota</h5>
          <p class="text-muted">${a.message||"Terjadi kesalahan saat memuat data"}</p>
          <button class="btn btn-primary mt-3" onclick="anggotaAdminPage()">
            Kembali ke Daftar Anggota
          </button>
        </div>
      `,null)}}async function Ys(e){var i,s;const a=`detailMap-${e.idAnggota}`,t=`#${a}`;try{await Gi(),await Vs(t);const n=parseFloat(e.latitude),o=parseFloat(e.longitude);if(isNaN(n)||isNaN(o))throw new Error("Koordinat tidak valid");const l=L.map(a).setView([n,o],15);window.detailMaps||(window.detailMaps={}),window.detailMaps[a]=l,L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19}).addTo(l);const r=e.status==="aktif"?"#28a745":"#dc3545",c=L.divIcon({html:`
        <div style="
          background: ${r};
          width: 50px;
          height: 50px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 18px;
          border: 3px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        ">
          ${((i=e.nama)==null?void 0:i.charAt(0).toUpperCase())||"?"}
        </div>
      `,className:"detail-marker",iconSize:[50,50],iconAnchor:[25,25]});L.marker([n,o],{icon:c}).addTo(l).bindPopup(`
      <div style="min-width: 200px;">
        <div class="d-flex align-items-center mb-2">
          <div class="bg-success bg-opacity-10 p-2 rounded me-2">
            <i class="bi bi-person-circle text-success"></i>
          </div>
          <div>
            <h6 class="mb-0 fw-semibold">${e.nama||"Tidak ada nama"}</h6>
            <small class="text-muted">ID: ${e.idAnggota}</small>
          </div>
        </div>
        <div class="mb-2">
          <small class="text-muted">Alamat:</small>
          <div class="small">${((s=e.alamat)==null?void 0:s.substring(0,80))||"Tidak ada alamat"}...</div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <small class="text-muted">Status:</small>
            <span class="badge ${e.status==="aktif"?"bg-success":"bg-danger"}">
              ${e.status==="aktif"?"Aktif":"Non-Aktif"}
            </span>
          </div>
          <div class="col-6">
            <small class="text-muted">Jenis:</small>
            <span class="badge bg-info">${e.jenisSampah||"-"}</span>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">Koordinat:</small>
          <div class="font-monospace small">${n.toFixed(6)}, ${o.toFixed(6)}</div>
        </div>
      </div>
    `).openPopup();const m=L.DomUtil.create("div","leaflet-control leaflet-bar"),u=L.control({position:"topright"});u.onAdd=function(g){return m},u.addTo(l),console.log("Detail map loaded successfully")}catch(n){console.error("Error loading detail map:",n);const o=document.getElementById(a);o&&(o.innerHTML=`
        <div class="h-100 d-flex flex-column align-items-center justify-content-center bg-light">
          <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
          <h6 class="mb-0 text-danger">Peta tidak dapat dimuat</h6>
          <p class="text-muted small">Koordinat: ${e.latitude}, ${e.longitude}</p>
          <button onclick="retryLoadDetailMap(${JSON.stringify(e)})" 
                  class="btn btn-warning btn-sm mt-2">
            <i class="bi bi-arrow-clockwise me-1"></i>Coba Lagi
          </button>
        </div>
      `)}}window.retryLoadDetailMap=function(e){Ys(e)};window.resetViewDetailMap=function(e,a,t){const i=window.detailMaps?window.detailMaps[e]:null;i&&i.setView([a,t],15)};window.copyToClipboardValue=function(e){e&&navigator.clipboard.writeText(e).then(()=>{const a=document.title;document.title="âœ“ Disalin!",setTimeout(()=>{document.title=a},1e3)}).catch(a=>{console.error("Gagal menyalin: ",a)})};async function Zs(e){try{const a=await M(`${b.anggota}${e}/`,{headers:v()});pe(`
        <div class="text-center py-3">
          <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
          <h5 class="text-danger">Hapus Anggota</h5>
          <p class="text-muted">Apakah Anda yakin ingin menghapus anggota ini?</p>
          <div class="alert alert-warning mt-3">
            <i class="bi bi-person me-2"></i><strong>${a.nama}</strong><br>
            <small>ID: ${a.idAnggota}</small>
          </div>
          <small class="text-muted d-block">Data yang telah dihapus tidak dapat dikembalikan.</small>
        </div>
      `,async()=>{try{await M(`${b.anggota}${e}/`,{method:"DELETE",headers:v()}),x(`Anggota ${a.nama} berhasil dihapus`,"success",5e3),Ye()}catch(t){console.error("Error deleting anggota:",t),x(`Gagal menghapus anggota: ${t.message}`,"danger",5e3)}})}catch(a){console.error("Error loading anggota for deletion:",a),sl(`Gagal memuat data anggota: ${a.message}`,"danger")}}function Xs(){const e=window.location.hash,a=e.match(/#\/anggota\/(\d+)/);if(a){const t=a[1];renderDetailPage(t)}else e==="#/anggota"&&renderAnggotaList()}window.addEventListener("hashchange",Xs);window.editAnggota=qs;window.viewDetail=Ji;window.deleteAnggota=Zs;window.changePage=Il;document.addEventListener("DOMContentLoaded",Xs);let _t=[],ga=1,ma=10;function Nl(){const e=document.querySelectorAll(".needs-validation");Array.from(e).forEach(a=>{a.addEventListener("submit",t=>{a.checkValidity()||(t.preventDefault(),t.stopPropagation()),a.classList.add("was-validated")},!1)}),_l()}function _l(){document.querySelectorAll(".needs-validation").forEach(a=>{a.querySelectorAll("input, select, textarea").forEach(i=>{i.addEventListener("blur",()=>{bs(i)}),i.addEventListener("input",()=>{i.classList.contains("is-invalid")&&bs(i)})})})}function bs(e){e.checkValidity()?(e.classList.remove("is-invalid"),e.classList.add("is-valid")):(e.classList.remove("is-valid"),e.classList.add("is-invalid"))}async function Fl(){const e=document.getElementById("mainContent");if(!document.getElementById("modalContainer")){const a=document.createElement("div");a.id="modalContainer",document.body.appendChild(a)}e.innerHTML=`
    <div class="tamu-admin-page">
      <!-- Header -->
      <div class="card border-primary mb-4 shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="text-primary fw-bold mb-1">
                <i class="bi bi-people-fill me-2"></i>Manajemen Tamu
              </h2>
              <p class="text-muted mb-0">Kelola data tamu yang mengunjungi sistem</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Filter dan Search -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                  <i class="bi bi-search text-primary"></i>
                </span>
                <input type="text" id="searchTamu" class="form-control border-start-0" placeholder="Cari nama tamu...">
              </div>
            </div>
            <div class="col-md-3">
              <select id="filterJK" class="form-select">
                <option value="">Semua Jenis Kelamin</option>
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="filterUser" class="form-select">
                <option value="">Semua Status</option>
                <option value="withUser">Sudah Punya User</option>
                <option value="withoutUser">Belum Punya User</option>
              </select>
            </div>
            <div class="col-md-2">
              <button id="clearFilters" class="btn btn-outline-secondary w-100">
                <i class="bi bi-x-circle me-1"></i>Reset
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabel Tamu -->
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div id="tamuTableContainer" class="table-responsive">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Memuat data tamu...</p>
            </div>
          </div>
          <div id="tamuPagination" class="p-3 border-top"></div>
        </div>
      </div>
    </div>
  `,document.getElementById("searchTamu").oninput=je,document.getElementById("filterJK").onchange=je,document.getElementById("filterUser").onchange=je,document.getElementById("clearFilters").onclick=Hl,je()}function Hl(){document.getElementById("searchTamu").value="",document.getElementById("filterJK").value="",document.getElementById("filterUser").value="",ga=1,je()}async function je(){const e=document.getElementById("searchTamu").value,a=document.getElementById("filterJK").value,t=document.getElementById("filterUser").value;try{_t=(await M(b.tamu,{headers:v()})).filter(s=>{var r;const n=(r=s.nama)==null?void 0:r.toLowerCase().includes(e.toLowerCase()),o=!a||s.jk===a,l=!t||t==="withUser"&&s.idUser||t==="withoutUser"&&!s.idUser;return n&&o&&l}),ga=1,Ri()}catch(i){console.error("Error loading tamu:",i),document.getElementById("tamuTableContainer").innerHTML=`
      <div class="alert alert-danger m-3">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Error loading tamu: ${i.message}
      </div>
    `,document.getElementById("tamuPagination").innerHTML=""}}function Ri(){const e=document.getElementById("tamuTableContainer"),a=document.getElementById("tamuPagination");if(!e)return;const t=_t.length,i=Math.ceil(t/ma);ga>i&&i>0&&(ga=i),t===0&&(ga=1);const s=(ga-1)*ma,n=Math.min(s+ma,t),o=_t.slice(s,n),l=t>0?s+1:0,r=n;if(t===0){e.innerHTML=`
      <div class="text-center py-5">
        <i class="bi bi-people text-muted mb-3" style="font-size: 3rem;"></i>
        <h5 class="text-muted">Tidak ada data tamu</h5>
        <p class="text-muted">Coba ubah filter pencarian</p>
      </div>
    `,a.innerHTML="";return}const c=`
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th scope="col" class="ps-4">No</th>
          <th scope="col">ID Tamu</th>
          <th scope="col">Nama</th>
          <th scope="col">Jenis Kelamin</th>
          <th scope="col">User ID</th>
          <th scope="col">Status User</th>
          <th scope="col" class="text-center pe-4">Aksi</th>
        </tr>
      </thead>
      <tbody>
        ${o.map((d,m)=>`
          <tr>
            <td class="ps-4 fw-semibold">${s+m+1}</td>
            <td>
              <span class="badge bg-primary">${d.idTamu}</span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 p-2 rounded me-2">
                  <i class="bi bi-person-circle text-primary"></i>
                </div>
                <div>
                  <div class="fw-medium">${d.nama}</div>
                </div>
              </div>
            </td>
            <td>
              <span class="badge ${d.jk==="L"?"bg-info":"bg-warning"}">
                ${d.jk==="L"?"Laki-laki":"Perempuan"}
              </span>
            </td>
            <td>
              ${d.idUser?`<span class="font-monospace">${d.idUser}</span>`:'<span class="text-muted">-</span>'}
            </td>
            <td>
              ${d.idUser?'<span class="badge bg-success">Sudah Punya User</span>':'<span class="badge bg-warning">Belum Punya User</span>'}
            </td>
            <td class="text-center pe-4">
              <div class="btn-group btn-group-sm" role="group">
                <button onclick="editTamu(${d.idTamu})" class="btn btn-outline-warning">
                  <i class="bi bi-pencil"></i>
                </button>
                <button onclick="deleteTamu(${d.idTamu})" class="btn btn-outline-danger">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
    <div class="table-footer p-3 border-top bg-light">
      <div class="row align-items-center">
        <div class="col-md-6">
          <small class="text-muted">
            Menampilkan ${l} - ${r} dari ${t} tamu
          </small>
        </div>
        <div class="col-md-6 text-md-end">
          <small class="text-muted">
            Halaman ${ga} dari ${i}
          </small>
        </div>
      </div>
    </div>
  `;e.innerHTML=c,Ul(i,l,r,t)}function Ul(e,a,t,i){const s=document.getElementById("tamuPagination");if(e<=1){s.innerHTML=`
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">Menampilkan semua data (${i} tamu)</small>
        <div class="dropdown d-none d-md-block">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                  id="tamuPerPageDropdown" data-bs-toggle="dropdown">
            ${ma} per halaman
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item ${ma===5?"active":""}" 
                   onclick="changeTamuPerPage(5)">5 per halaman</a></li>
            <li><a class="dropdown-item ${ma===10?"active":""}" 
                   onclick="changeTamuPerPage(10)">10 per halaman</a></li>
            <li><a class="dropdown-item ${ma===20?"active":""}" 
                   onclick="changeTamuPerPage(20)">20 per halaman</a></li>
            <li><a class="dropdown-item ${ma===50?"active":""}" 
                   onclick="changeTamuPerPage(50)">50 per halaman</a></li>
          </ul>
        </div>
      </div>
    `;return}let n=Math.max(1,ga-2),o=Math.min(e,n+4);o-n<4&&(n=Math.max(1,o-4));const l=[];ga>1?l.push(`
      <li class="page-item">
        <button class="page-link" onclick="changeTamuPage(1)" title="Halaman pertama">
          <i class="bi bi-chevron-double-left"></i>
        </button>
      </li>
      <li class="page-item">
        <button class="page-link" onclick="changeTamuPage(${ga-1})" title="Halaman sebelumnya">
          <i class="bi bi-chevron-left"></i>
        </button>
      </li>
    `):l.push(`
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-double-left"></i>
        </span>
      </li>
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-left"></i>
        </span>
      </li>
    `),n>1&&l.push(`
      <li class="page-item disabled">
        <span class="page-link">...</span>
      </li>
    `);for(let r=n;r<=o;r++)r===ga?l.push(`
        <li class="page-item active">
          <span class="page-link">${r}</span>
        </li>
      `):l.push(`
        <li class="page-item">
          <button class="page-link" onclick="changeTamuPage(${r})">${r}</button>
        </li>
      `);o<e&&l.push(`
      <li class="page-item disabled">
        <span class="page-link">...</span>
      </li>
    `),ga<e?l.push(`
      <li class="page-item">
        <button class="page-link" onclick="changeTamuPage(${ga+1})" title="Halaman berikutnya">
          <i class="bi bi-chevron-right"></i>
        </button>
      </li>
      <li class="page-item">
        <button class="page-link" onclick="changeTamuPage(${e})" title="Halaman terakhir">
          <i class="bi bi-chevron-double-right"></i>
        </button>
      </li>
    `):l.push(`
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-right"></i>
        </span>
      </li>
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-double-right"></i>
        </span>
      </li>
    `),s.innerHTML=`
    <div class="d-flex flex-wrap justify-content-between align-items-center">
      <div class="mb-2 mb-md-0">
        <small class="text-muted">
          Menampilkan <span class="fw-semibold">${a} - ${t}</span> dari 
          <span class="fw-semibold">${i}</span> tamu | 
          Halaman <span class="fw-semibold">${ga}</span> dari 
          <span class="fw-semibold">${e}</span>
        </small>
      </div>
      
      <div class="d-flex align-items-center">
        <!-- Dropdown untuk pilih jumlah data per halaman -->
        <div class="dropdown me-3">
          <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" 
                  id="tamuPerPageDropdown" data-bs-toggle="dropdown">
            ${ma} per halaman
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item ${ma===5?"active":""}" 
                   onclick="changeTamuPerPage(5)">5 per halaman</a></li>
            <li><a class="dropdown-item ${ma===10?"active":""}" 
                   onclick="changeTamuPerPage(10)">10 per halaman</a></li>
            <li><a class="dropdown-item ${ma===20?"active":""}" 
                   onclick="changeTamuPerPage(20)">20 per halaman</a></li>
            <li><a class="dropdown-item ${ma===50?"active":""}" 
                   onclick="changeTamuPerPage(50)">50 per halaman</a></li>
            <li><a class="dropdown-item ${ma===100?"active":""}" 
                   onclick="changeTamuPerPage(100)">100 per halaman</a></li>
          </ul>
        </div>
        
        <!-- Navigasi halaman -->
        <nav>
          <ul class="pagination pagination-sm mb-0">
            ${l.join("")}
          </ul>
        </nav>
      </div>
    </div>
  `,typeof bootstrap<"u"&&[].slice.call(s.querySelectorAll("[title]")).map(function(c){return new bootstrap.Tooltip(c)})}window.changeTamuPage=function(e){if(e<1||e>Math.ceil(_t.length/ma))return;ga=e;const a=document.getElementById("tamuTableContainer");a&&("scrollBehavior"in document.documentElement.style?a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}):a.scrollIntoView()),Ri()};window.changeTamuPerPage=function(e){ma=e,ga=1;try{localStorage.setItem("tamuPerPage",e.toString())}catch{console.log("LocalStorage not available")}Ri()};document.addEventListener("DOMContentLoaded",function(){try{const e=localStorage.getItem("tamuPerPage");e&&(ma=parseInt(e))}catch{console.log("LocalStorage not available")}});async function Gl(e){try{const a=await M(`${b.tamu}${e}/`,{headers:v()}),t=`
      <div class="tamu-form-container">
        <form id="editTamuForm" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="nama" class="form-label">Nama Lengkap *</label>
            <input type="text" id="nama" class="form-control" 
                   placeholder="Masukkan nama lengkap" 
                   value="${a.nama||""}" required>
            <div class="valid-feedback">Valid.</div>
            <div class="invalid-feedback">Silakan isi nama lengkap.</div>
          </div>
          
          <div class="mb-3">
            <label for="jk" class="form-label">Jenis Kelamin *</label>
            <select id="jk" class="form-select" required>
              <option value="">Pilih Jenis Kelamin</option>
              <option value="L" ${a.jk==="L"?"selected":""}>Laki-laki</option>
              <option value="P" ${a.jk==="P"?"selected":""}>Perempuan</option>
            </select>
            <div class="valid-feedback">Valid.</div>
            <div class="invalid-feedback">Silakan pilih jenis kelamin.</div>
          </div>
          
          <div class="mb-4">
            <label class="form-label">Informasi User</label>
            <div class="card ${a.idUser?"border-success":"border-warning"}">
              <div class="card-body">
                ${a.idUser?`<div class="text-success">
                         <i class="bi bi-check-circle-fill me-2"></i>
                         <strong>Sudah terhubung dengan User</strong>
                         <div class="mt-2">
                           <small class="text-muted">User ID:</small>
                           <div class="font-monospace bg-success bg-opacity-10 p-2 rounded mt-1">
                             ${a.idUser}
                           </div>
                         </div>
                       </div>`:`<div class="text-warning">
                         <i class="bi bi-exclamation-triangle-fill me-2"></i>
                         <strong>Belum terhubung dengan akun user</strong>
                       </div>`}
                <small class="text-muted d-block mt-2">
                  <i class="bi bi-info-circle me-1"></i>
                  ID User tidak dapat diubah melalui form ini.
                </small>
              </div>
            </div>
          </div>
        </form>
        
        <!-- Error Message -->
        <div id="formMessageEdit" class="mt-3"></div>
      </div>
    `;P(`Edit Tamu: ${a.nama}`,t,async()=>{const i=document.getElementById("editTamuForm");if(i.classList.remove("was-validated"),!i.checkValidity()){i.classList.add("was-validated");const n=i.querySelector(":invalid");return n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.focus()),!1}const s={nama:document.getElementById("nama").value,jk:document.getElementById("jk").value};if(s.nama===a.nama&&s.jk===a.jk)return x("Tidak ada perubahan data yang dilakukan.","info",3e3),!1;try{return x("Menyimpan perubahan data...","info",2e3),await M(`${b.tamu}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify(s)}),x(`âœ… Data tamu "${s.nama}" berhasil diperbarui`,"success",5e3),setTimeout(()=>{je()},500),!0}catch(n){const o=document.getElementById("formMessageEdit");return o&&(o.innerHTML=`
            <div class="alert alert-danger alert-dismissible fade show">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <strong>Error:</strong> ${n.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `),!1}},!0),setTimeout(()=>{Nl()},300)}catch(a){x(`âŒ Gagal memuat data tamu: ${a.message}`,"danger",3e3)}}async function Jl(e){try{const a=await M(`${b.tamu}${e}/`,{headers:v()});pe(`
        <div class="text-center py-3">
          <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
          <h5 class="text-danger">Hapus Tamu</h5>
          <p class="text-muted">Apakah Anda yakin ingin menghapus data tamu ini?</p>
          <div class="alert alert-warning mt-3">
            <div class="d-flex align-items-center">
              <div class="bg-danger bg-opacity-10 p-2 rounded-circle me-3">
                <i class="bi bi-person text-danger"></i>
              </div>
              <div>
                <strong>${a.nama}</strong><br>
                <small class="text-muted">ID: ${a.idTamu} | ${a.jk==="L"?"Laki-laki":"Perempuan"}</small>
              </div>
            </div>
          </div>
          <small class="text-muted d-block mt-3">Data yang telah dihapus tidak dapat dikembalikan.</small>
        </div>
      `,async()=>{try{await M(`${b.tamu}${e}/`,{method:"DELETE",headers:v()}),x(`âœ… Tamu "${a.nama}" berhasil dihapus`,"success",5e3),ga=1,setTimeout(()=>{je()},500)}catch(t){x(`âŒ Gagal menghapus tamu: ${t.message}`,"danger",3e3)}})}catch(a){x(`âŒ Gagal memuat data tamu: ${a.message}`,"danger",3e3)}}window.editTamu=Gl;window.deleteTamu=Jl;window.changeTamuPage=changeTamuPage;window.changeTamuPerPage=changeTamuPerPage;let oe=[],Pa=1;const Ft=10;let gt="";async function Rl(){const e=document.getElementById("mainContent");if(!e){console.error("mainContent element not found");return}if(!document.getElementById("modalContainer")){const o=document.createElement("div");o.id="modalContainer",document.body.appendChild(o)}e.innerHTML=`
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Manajemen Jadwal</h2>
                <button id="addJadwalBtn" class="btn btn-success">
                    <i class="bi bi-plus-circle me-2"></i>Tambah Jadwal
                </button>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Filter Jadwal</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterDate" class="form-label">Tanggal</label>
                            <input type="date" id="filterDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label for="filterMonth" class="form-label">Bulan</label>
                            <select id="filterMonth" class="form-select">
                                <option value="">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterTim" class="form-label">Tim Pengangkut</label>
                            <select id="filterTim" class="form-select">
                                <option value="">Semua Tim</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="resetFilter" class="btn btn-secondary w-100">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Daftar Jadwal</h5>
                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status" id="loadingSpinner">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Info Pagination -->
                    <div id="paginationInfo" class="mb-3 text-muted small"></div>
                    
                    <!-- Table Container -->
                    <div id="jadwalTableContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Memuat data jadwal...</p>
                        </div>
                    </div>
                    
                    <!-- Pagination Container -->
                    <div id="paginationContainer" class="mt-4"></div>
                </div>
            </div>
        </div>
    `,Pa=1,oe=[],gt="";const a=document.getElementById("addJadwalBtn");a&&(a.onclick=()=>tn());const t=document.getElementById("filterDate");t&&(t.onchange=le);const i=document.getElementById("filterMonth");i&&(i.onchange=()=>{gt=i.value,le()});const s=document.getElementById("filterTim");s&&(s.onchange=le);const n=document.getElementById("resetFilter");n&&(n.onclick=()=>{t&&(t.value=""),i&&(i.value="",gt=""),s&&(s.value=""),le()}),zl(),le()}function ei(e){return["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"][e]}function Re(e){return["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"].indexOf(e)}function Wa(e,a){let t=document.getElementById("toastContainer");t||(t=document.createElement("div"),t.id="toastContainer",t.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 350px;
    `,document.body.appendChild(t));const i="toast-"+Date.now(),s={success:"bg-success",error:"bg-danger",warning:"bg-warning",info:"bg-info"},n={success:"bi-check-circle",error:"bi-exclamation-triangle",warning:"bi-exclamation-circle",info:"bi-info-circle"},o=`
    <div id="${i}" class="toast align-items-center text-white ${s[e]||"bg-primary"} border-0 mb-2" 
         role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi ${n[e]} me-2"></i>
          ${a}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;t.insertAdjacentHTML("afterbegin",o);const l=document.getElementById(i);new bootstrap.Toast(l,{delay:3e3}).show(),l.addEventListener("hidden.bs.toast",function(){this.remove()})}const Qs=document.createElement("style");Qs.textContent=`
  .calendar-grid.multi-select {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
  }
  
  .calendar-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  
  .days-of-week {
    padding: 8px 0;
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 10px;
  }
  
  .day-header {
    font-weight: 600;
    color: #495057;
    padding: 8px 0;
  }
  
  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
  }
  
  .day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    user-select: none;
    border: 2px solid transparent;
  }
  
  .day.empty {
    visibility: hidden;
  }
  
  .day.selectable {
    background: #f8f9fa;
    color: #495057;
  }
  
  .day.selectable:hover {
    background: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .day.selectable.hover {
    background: #e3f2fd;
    border-color: #0d6efd;
  }
  
  .day.selected {
    background: #0d6efd;
    color: white;
    font-weight: bold;
    border-color: #0a58ca;
    transform: scale(1.05);
  }
  
  .day.selected .day-checkmark {
    display: block;
  }
  
  .day.today {
    background: #fff3cd;
    color: #856404;
    font-weight: bold;
    border-color: #ffeaa7;
  }
  
  .day.past {
    background: #f8f9fa;
    color: #adb5bd;
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .day-checkmark {
    position: absolute;
    top: 2px;
    right: 2px;
    display: none;
    font-size: 12px;
  }
  
  .calendar-container.multi-select-mode::before {
    content: "Mode Multi-select (CTRL) Aktif";
    position: absolute;
    top: -30px;
    left: 0;
    right: 0;
    background: #0d6efd;
    color: white;
    padding: 5px;
    text-align: center;
    font-size: 12px;
    border-radius: 4px;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
  
  #selectedDatesDisplay .badge {
    padding: 0.5em 0.8em;
    border-radius: 20px;
  }
  
  #selectedDatesDisplay .btn-close-sm {
    padding: 0.25rem;
    font-size: 0.7rem;
  }
  
  .btn-close-sm:hover {
    background-color: rgba(0,0,0,0.1);
  }
  
  .multi-select-mode .day.selectable:hover {
    background: #d1e7ff;
  }
`;document.head.appendChild(Qs);window.getMonthName=ei;window.getMonthIndex=Re;window.showToast=Wa;async function zl(){try{const e=await M(b.timPengangkut,{headers:v()}),a=e.data||e,t=document.getElementById("filterTim");if(t){for(;t.options.length>1;)t.remove(1);a.forEach(i=>{const s=document.createElement("option");s.value=i.idTim||i.id,s.textContent=i.namaTim,t.appendChild(s)})}}catch(e){console.error("Error loading tim options:",e)}}async function le(){var i,s;const e=((i=document.getElementById("filterDate"))==null?void 0:i.value)||"",a=((s=document.getElementById("filterTim"))==null?void 0:s.value)||"",t=document.getElementById("loadingSpinner");t&&t.classList.remove("d-none");try{oe=(await M(b.jadwal,{headers:v()})).sort((c,d)=>{const m=new Date(c.tanggalJadwal);return new Date(d.tanggalJadwal)-m}).filter(c=>{const d=!e||c.tanggalJadwal===e;let m=!0;gt&&(m=(c.tanggalJadwal?c.tanggalJadwal.split("-")[1]:"")===gt);const u=!a||c.idTim==a;return d&&m&&u}).sort((c,d)=>{const m=new Date(c.tanggalJadwal),u=new Date(d.tanggalJadwal);return m-u}),Pa=1,an()}catch(n){console.error("Error loading jadwal:",n);const o=document.getElementById("jadwalTableContainer");o&&(o.innerHTML=`
        <div class="alert alert-danger">
          <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Error Loading Data</h5>
          <p>${n.message||"Gagal memuat data jadwal"}</p>
          <button onclick="loadJadwal()" class="btn btn-danger btn-sm">
            <i class="bi bi-arrow-clockwise me-1"></i>Coba Lagi
          </button>
        </div>
      `),document.getElementById("paginationContainer").innerHTML="",document.getElementById("paginationInfo").innerHTML=""}finally{t&&t.classList.add("d-none")}}function Ol(e){const a=document.getElementById("jadwalTableContainer");if(!a){console.error("jadwalTableContainer element not found");return}const t={};e.forEach(n=>{if(!n.tanggalJadwal)return;const l=new Date(n.tanggalJadwal).toLocaleDateString("id-ID",{month:"long",year:"numeric"});t[l]||(t[l]=[]),t[l].push(n)});const i=Object.keys(t).sort((n,o)=>{const l=new Date(n.split(" ")[1],Re(n.split(" ")[0]));return new Date(o.split(" ")[1],Re(o.split(" ")[0]))-l});let s="";i.forEach(n=>{const o=t[n];o.sort((l,r)=>{const c=new Date(l.tanggalJadwal),d=new Date(r.tanggalJadwal);return c-d}),s+=`
      <div class="mb-4">
        <div class="card bg-light border-0 mb-2">
          <div class="card-body py-2">
            <h6 class="mb-0 fw-bold">
              <i class="bi bi-calendar-month me-2"></i>${n}
              <span class="badge bg-secondary ms-2">${o.length} Jadwal</span>
            </h6>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 50px;">No</th>
                <th>Tanggal</th>
                <th>Nama Tim</th>
                <th>Jumlah Anggota</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              ${o.map((l,r)=>`
                <tr>
                  <td class="text-center fw-semibold">${r+1}</td>
                  <td>
                    <div class="fw-semibold">${ti(l.tanggalJadwal)}</div>
                    <small class="text-muted">${ii(l.tanggalJadwal)}</small>
                  </td>
                  <td>
                    <div class="fw-medium">${l.nama_tim||"Tim"}</div>
                    <small class="text-muted">ID: ${l.idTim}</small>
                  </td>
                  <td>
                    <span class="badge bg-secondary" id="count-${l.idJadwal||l.id}">
                      <i class="bi bi-people me-1"></i>
                      Loading...
                    </span>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button onclick="viewDetailJadwal('${l.idJadwal||l.id}')" class="btn btn-sm btn-info" title="Detail">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button onclick="editJadwal('${l.idJadwal||l.id}')" class="btn btn-sm btn-warning" title="Edit">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button onclick="deleteJadwal('${l.idJadwal||l.id}')" class="btn btn-sm btn-danger" title="Hapus">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `}),a.innerHTML=s,e.forEach(n=>{Vl(n.idJadwal||n.id)})}function an(){const e=document.getElementById("jadwalTableContainer"),a=document.getElementById("paginationInfo");if(!e){console.error("jadwalTableContainer element not found");return}if(!oe||oe.length===0){e.innerHTML=`
      <div class="text-center py-5">
        <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
        <h5 class="text-muted">Tidak ada data jadwal</h5>
        <p class="text-muted">Gunakan filter atau tambah jadwal baru</p>
      </div>
    `,a.innerHTML="",document.getElementById("paginationContainer").innerHTML="";return}const t=(Pa-1)*Ft,i=Math.min(t+Ft,oe.length),s=oe.slice(t,i);a.innerHTML=`
    Menampilkan <strong>${t+1} - ${i}</strong> dari <strong>${oe.length}</strong> jadwal
  `,Ol(s),Kl()}function Kl(){const e=document.getElementById("paginationContainer");if(!e)return;const a=Math.ceil(oe.length/Ft);if(a<=1){e.innerHTML="";return}let t=`
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mb-0">
        <!-- Previous Button -->
        <li class="page-item ${Pa===1?"disabled":""}">
          <a class="page-link" href="javascript:void(0)" onclick="goToJadwalPage(${Pa-1})" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
  `,i=Math.max(1,Pa-2),s=Math.min(a,Pa+2);Pa<=3&&(s=Math.min(5,a)),Pa>=a-2&&(i=Math.max(1,a-4)),i>1&&(t+=`
      <li class="page-item">
        <a class="page-link" href="javascript:void(0)" onclick="goToJadwalPage(1)">1</a>
      </li>
    `,i>2&&(t+='<li class="page-item disabled"><span class="page-link">...</span></li>'));for(let n=i;n<=s;n++)t+=`
      <li class="page-item ${n===Pa?"active":""}">
        <a class="page-link" href="javascript:void(0)" onclick="goToJadwalPage(${n})">${n}</a>
      </li>
    `;s<a&&(s<a-1&&(t+='<li class="page-item disabled"><span class="page-link">...</span></li>'),t+=`
      <li class="page-item">
        <a class="page-link" href="javascript:void(0)" onclick="goToJadwalPage(${a})">${a}</a>
      </li>
    `),t+=`
        <!-- Next Button -->
        <li class="page-item ${Pa===a?"disabled":""}">
          <a class="page-link" href="javascript:void(0)" onclick="goToJadwalPage(${Pa+1})" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  `,e.innerHTML=t}function ql(e){e<1||e>Math.ceil(oe.length/Ft)||(Pa=e,an(),document.getElementById("jadwalTableContainer").scrollIntoView({behavior:"smooth",block:"start"}))}async function Vl(e){try{const t=(await M(b.detailAnggotaJadwal,{headers:v()})).filter(s=>s.idJadwal==e).length,i=document.getElementById(`count-${e}`);i&&(i.innerHTML=`<i class="bi bi-people me-1"></i>${t}`,i.className=`badge ${t===0?"bg-secondary":"bg-success"}`)}catch(a){console.error(`Error loading count for jadwal ${e}:`,a);const t=document.getElementById(`count-${e}`);t&&(t.innerHTML='<i class="bi bi-exclamation-triangle me-1"></i>Error',t.className="badge bg-danger")}}function ti(e){if(!e)return"-";try{const a=new Date(e),t=a.getDate(),i=ei(a.getMonth()),s=a.getFullYear();return`${t} ${i} ${s}`}catch{return e}}function ii(e){if(!e)return"";try{return new Date(e).toLocaleDateString("id-ID",{weekday:"long"})}catch{return""}}function en(e){const a=document.getElementById(e);let t=!0;return a.querySelectorAll(".form-control, .form-select, .form-check-input").forEach(i=>{i.classList.remove("is-invalid","is-valid");const s=i.nextElementSibling;s&&(s.classList.contains("invalid-feedback")||s.classList.contains("valid-feedback"))&&(s.style.display="none")}),a.querySelectorAll("[required]").forEach(i=>{if(i.type==="hidden"&&!i.value){const s=i.nextElementSibling;s&&s.classList.contains("invalid-feedback")&&(i.classList.add("is-invalid"),s.style.display="block",t=!1)}else if(i.tagName==="SELECT")if(i.value)i.classList.add("is-valid");else{i.classList.add("is-invalid");const s=i.nextElementSibling;s&&s.classList.contains("invalid-feedback")&&(s.style.display="block"),t=!1}else if(i.type==="checkbox")if(i.checked)i.classList.add("is-valid");else{i.classList.add("is-invalid");const s=i.closest(".form-check").querySelector(".invalid-feedback");s&&(s.style.display="block"),t=!1}else if(i.type!=="hidden")if(i.value.trim())i.classList.add("is-valid");else{i.classList.add("is-invalid");const s=i.nextElementSibling;s&&s.classList.contains("invalid-feedback")&&(s.style.display="block"),t=!1}}),t}function tn(){M(b.timPengangkut,{headers:v()}).then(e=>{const a=e.data||e;if(!a||a.length===0){P("Tambah Jadwal Baru",`
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Tidak ada tim pengangkut yang tersedia. Silakan tambah tim terlebih dahulu.
          </div>
        `,null,!0);return}const t=a.map(r=>`<option value="${r.idTim||r.id}">${r.namaTim}</option>`).join(""),i=new Date,s=i.getFullYear(),n=i.getMonth(),o=nn(s,n),l=`
        <form id="jadwalForm" novalidate>
          <div class="mb-3">
            <label for="idTim" class="form-label">Tim Pengangkut *</label>
            <select id="idTim" class="form-select" required>
              <option value="">Pilih Tim</option>
              ${t}
            </select>
            <div class="invalid-feedback">Harap pilih tim pengangkut.</div>
            <div class="form-text">Pilih tim yang akan bertugas</div>
          </div>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0">Pilih Tanggal *</label>
              <button type="button" id="clearSelection" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i>Hapus Pilihan
              </button>
            </div>
            
            <div class="calendar-container mb-3">
              ${o}
            </div>
            
            <input type="hidden" id="selectedDates" required>
            <div class="invalid-feedback">Harap pilih minimal satu tanggal.</div>
            
            <div id="selectedDatesDisplay" class="mt-3">
              <div class="alert alert-primary">
                <div class="d-flex align-items-center">
                  <i class="bi bi-calendar-check fs-5 me-2"></i>
                  <div>
                    <div class="fw-bold">Tanggal Terpilih: <span id="selectedCount" class="badge bg-primary">0</span></div>
                    <div id="datesList" class="mt-1 small"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Klik tanggal untuk memilih/deselect.
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Sistem akan membuat jadwal untuk setiap tanggal yang dipilih.
          </div>
        </form>
      `;P("Tambah Jadwal Baru",l,async()=>{if(!en("jadwalForm"))return!1;const r=document.getElementById("selectedDates"),c=document.getElementById("idTim"),d=JSON.parse(r.value);if(d.length===0){const g=document.getElementById("selectedDates").nextElementSibling;return g&&g.classList.contains("invalid-feedback")&&(g.style.display="block"),!1}if(d.length>30)return Wa("error","Maksimal 30 tanggal dalam satu kali input!"),!1;const m={dates:d,idTim:parseInt(c.value)};try{const u=document.querySelector(".modal-footer .btn-primary"),g=u.innerHTML;u.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',u.disabled=!0;const p=await Yl(m);return p.success>0?(Wa("success",`Berhasil membuat ${p.success} jadwal!`),p.failed>0&&Wa("warning",`${p.failed} jadwal gagal dibuat.`)):Wa("error","Gagal membuat semua jadwal"),le(),!0}catch(u){return console.error("Error menambahkan jadwal:",u),Wa("error","Error menambahkan jadwal: "+u.message),!1}},!0),setTimeout(()=>{sn();const r=document.getElementById("idTim");r&&r.addEventListener("change",function(){if(this.value){this.classList.remove("is-invalid"),this.classList.add("is-valid");const c=this.nextElementSibling;c&&c.classList.contains("invalid-feedback")&&(c.style.display="none")}})},100)}).catch(e=>{console.error("Error loading tim:",e),P("Tambah Jadwal Baru",`
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Gagal memuat data tim: ${e.message}
        </div>
      `,null,!0)})}async function Wl(e){try{const[a,t]=await Promise.all([M(`${b.jadwal}${e}/`,{headers:v()}),M(b.timPengangkut,{headers:v()})]),i=a,s=t.data||t;if(!s||s.length===0){P("Edit Jadwal",`
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Tidak ada tim pengangkut yang tersedia.
        </div>
      `,null,!0);return}const n=i.tanggalJadwal?i.tanggalJadwal.split("T")[0]:new Date().toISOString().split("T")[0],o=new Date(n),l=o.getFullYear(),r=o.getMonth(),c=o.getDate(),d=s.map(g=>{const p=g.idTim||g.id,h=p==i.idTim;return`<option value="${p}" ${h?"selected":""}>${g.namaTim}</option>`}).join(""),m=on(l,r,n),u=`
      <form id="editJadwalForm" novalidate>
        <input type="hidden" id="jadwalId" value="${e}">
        
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Pilih Tanggal Baru *</label>
            <small class="text-muted">Klik tanggal untuk memilih</small>
          </div>
          
          <div class="calendar-container mb-3">
            ${m}
          </div>
          
          <input type="hidden" id="selectedDate" value="${n}" required>
          <div class="invalid-feedback">Harap pilih tanggal.</div>
          
          <div id="selectedDateDisplay" class="mt-3">
            <div class="alert alert-primary">
              <div class="d-flex align-items-center">
                <i class="bi bi-calendar-check fs-5 me-2"></i>
                <div>
                  <div class="fw-bold">Tanggal Terpilih:</div>
                  <div id="dateValue" class="mt-1 fw-semibold">
                    ${ti(n)} (${ii(n)})
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="idTim" class="form-label">Tim Pengangkut *</label>
          <select id="idTim" class="form-select" required>
            <option value="">Pilih Tim Pengangkut</option>
            ${d}
          </select>
          <div class="invalid-feedback">Harap pilih tim pengangkut.</div>
          <div class="form-text">Pilih tim yang akan bertugas pada tanggal tersebut</div>
        </div>
        
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Anda hanya mengedit <strong>satu jadwal</strong> ini saja. Tanggal yang dipilih akan menggantikan tanggal sebelumnya.
        </div>
      </form>
    `;P("Edit Jadwal",u,async()=>{if(!en("editJadwalForm"))return!1;const g=document.getElementById("selectedDate"),p=document.getElementById("idTim"),h=n,f=i.idTim,k=g.value,w=parseInt(p.value);if(h===k&&f==w)return Wa("info","Tidak ada perubahan yang dilakukan."),!1;const $={tanggalJadwal:k,idTim:w};try{const y=document.querySelector(".modal-footer .btn-primary"),A=y.innerHTML;return y.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',y.disabled=!0,await M(`${b.jadwal}${e}/`,{method:"PUT",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify($)}),Wa("success","Jadwal berhasil diperbarui!"),le(),!0}catch(y){return console.error("Error updating jadwal:",y),Wa("error","Gagal memperbarui jadwal: "+y.message),!1}},!0),setTimeout(()=>{ln(n);const g=document.getElementById("idTim");g&&g.addEventListener("change",function(){if(this.value){this.classList.remove("is-invalid"),this.classList.add("is-valid");const p=this.nextElementSibling;p&&p.classList.contains("invalid-feedback")&&(p.style.display="none")}})},100)}catch(a){console.error("Error loading jadwal data:",a),P("Edit Jadwal",`
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Gagal memuat data jadwal: ${a.message}
      </div>
    `,null,!0)}}function sn(){var t,i,s;let e=new Set;function a(){const n=document.getElementById("selectedCount"),o=document.getElementById("datesList"),l=document.getElementById("selectedDates");if(n&&(n.textContent=e.size),o)if(e.size===0){if(o.innerHTML='<span class="text-muted fst-italic">Belum ada tanggal dipilih</span>',l){l.classList.add("is-invalid");const r=l.nextElementSibling;r&&r.classList.contains("invalid-feedback")&&(r.style.display="block")}}else{const c=Array.from(e).sort().map(d=>`
            <span class="badge bg-primary text-white me-1 mb-1">
              ${new Date(d).toLocaleDateString("id-ID",{day:"numeric",month:"short"})}
              <button type="button" class="btn-close btn-close-white ms-1" 
                      onclick="removeDate('${d}', event)"></button>
            </span>
          `).join("");if(o.innerHTML=c,l){l.classList.remove("is-invalid"),l.classList.add("is-valid");const d=l.nextElementSibling;d&&d.classList.contains("invalid-feedback")&&(d.style.display="none")}}l&&(l.value=JSON.stringify(Array.from(e)))}window.removeDate=function(n,o){o==null||o.stopPropagation(),e.delete(n);const l=document.querySelector(`.day[data-date="${n}"]`);l&&l.classList.remove("selected"),a()},document.querySelectorAll(".calendar-days .selectable").forEach(n=>{n.addEventListener("click",function(o){const l=this.getAttribute("data-date");e.has(l)?(e.delete(l),this.classList.remove("selected")):(e.add(l),this.classList.add("selected")),a()}),n.addEventListener("mouseenter",function(){this.classList.contains("selected")||this.classList.add("hover")}),n.addEventListener("mouseleave",function(){this.classList.remove("hover")})}),(t=document.getElementById("clearSelection"))==null||t.addEventListener("click",function(){e.clear(),document.querySelectorAll(".calendar-days .selected").forEach(n=>{n.classList.remove("selected")}),a()}),(i=document.querySelector(".prev-month"))==null||i.addEventListener("click",function(){const n=this.closest(".calendar-header").querySelector("h6"),[o,l]=n.textContent.split(" "),r=Re(o);let c=parseInt(l),d=r-1;d<0&&(d=11,c--);const m=new Set(e);fs(c,d,m),e=m}),(s=document.querySelector(".next-month"))==null||s.addEventListener("click",function(){const n=this.closest(".calendar-header").querySelector("h6"),[o,l]=n.textContent.split(" "),r=Re(o);let c=parseInt(l),d=r+1;d>11&&(d=0,c++);const m=new Set(e);fs(c,d,m),e=m})}function nn(e,a){const t=new Date,i=t.getFullYear(),s=t.getMonth(),n=t.getDate(),o=new Date(e,a,1),r=new Date(e,a+1,0).getDate(),c=o.getDay(),d=["M","S","S","R","K","J","S"];let m=`
    <div class="calendar-grid multi-select">
      <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-sm btn-outline-secondary prev-month" type="button" title="Bulan sebelumnya">
          <i class="bi bi-chevron-left"></i>
        </button>
        <h6 class="mb-0 fw-bold">${ei(a)} ${e}</h6>
        <button class="btn btn-sm btn-outline-secondary next-month" type="button" title="Bulan selanjutnya">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      
      <div class="days-of-week d-flex mb-2">
        ${d.map(u=>`
          <div class="day-header text-center fw-semibold text-muted small flex-fill py-1">${u}</div>
        `).join("")}
      </div>
      
      <div class="calendar-days">
  `;for(let u=0;u<c;u++)m+='<div class="day empty"></div>';for(let u=1;u<=r;u++){const g=e===i&&a===s&&u===n,p=e<i||e===i&&a<s||e===i&&a===s&&u<n,h=`${e}-${String(a+1).padStart(2,"0")}-${String(u).padStart(2,"0")}`;m+=`
      <div class="day ${g?"today":""} ${p?"past disabled":"selectable"}" 
           data-date="${h}"
           ${p?'title="Tanggal sudah lewat"':'title="Klik untuk memilih"'}>
        ${u}
        <div class="day-checkmark">
          <i class="bi bi-check-circle-fill"></i>
        </div>
      </div>
    `}return m+=`
      </div>
    </div>
  `,m}function fs(e,a,t){const i=nn(e,a),s=document.querySelector(".calendar-container");return s&&(s.innerHTML=i,sn(),t&&t.size>0&&setTimeout(()=>{t.forEach(r=>{const c=document.querySelector(`.day[data-date="${r}"]`);c&&!c.classList.contains("disabled")&&c.classList.add("selected")});const n=document.getElementById("selectedDates");n&&(n.value=JSON.stringify(Array.from(t)));const o=document.getElementById("selectedCount"),l=document.getElementById("datesList");if(o&&(o.textContent=t.size),l){const c=Array.from(t).sort().map(d=>`
              <span class="badge bg-primary text-white me-1 mb-1">
                ${new Date(d).toLocaleDateString("id-ID",{day:"numeric",month:"short"})}
                <button type="button" class="btn-close btn-close-white ms-1" 
                        onclick="removeDate('${d}', event)"></button>
              </span>
            `).join("");l.innerHTML=c}},50)),t}async function Yl(e){var t,i;const a={success:0,failed:0,errors:[]};P("Membuat Jadwal",`
    <div class="text-center py-4">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <h5>Membuat Jadwal...</h5>
      <p class="text-muted">Sedang memproses ${e.dates.length} tanggal</p>
      <div class="progress mt-3" style="height: 6px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             style="width: 0%" id="progressBar"></div>
      </div>
      <div class="mt-2 small text-muted" id="progressText">Memulai...</div>
    </div>
  `,null,!1);try{for(let s=0;s<e.dates.length;s++){const n=e.dates[s],o=Math.round((s+1)/e.dates.length*100),l=document.getElementById("progressBar"),r=document.getElementById("progressText");l&&(l.style.width=`${o}%`),r&&(r.textContent=`Memproses ${s+1} dari ${e.dates.length}: ${n}`);try{const c={tanggalJadwal:n,idTim:e.idTim};await M(b.jadwal,{method:"POST",headers:v(),body:JSON.stringify(c)}),a.success++}catch(c){console.error(`Error creating schedule for ${n}:`,c),a.failed++,a.errors.push({date:n,error:c.message})}await new Promise(c=>setTimeout(c,100))}return(t=document.querySelector(".modal .btn-close"))==null||t.click(),a}catch(s){throw console.error("Error in createMultipleSchedules:",s),(i=document.querySelector(".modal .btn-close"))==null||i.click(),s}}async function Zl(e){try{P("Detail Jadwal",`
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Memuat detail jadwal...</p>
      </div>
    `,null,!0);const a=await M(`${b.jadwal}${e}/`,{headers:v()}),t=`
      <div>
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Informasi Jadwal</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <dl>
                  <dt>ID Jadwal</dt>
                  <dd class="mb-3">#${a.idJadwal||a.id}</dd>
                  
                  <dt>Tanggal</dt>
                  <dd class="mb-3">
                    <div class="fw-bold">${ti(a.tanggalJadwal)}</div>
                    <small class="text-muted">${ii(a.tanggalJadwal)}</small>
                  </dd>
                </dl>
              </div>
              <div class="col-md-6">
                <dl>
                  <dt>Tim Pengangkut</dt>
                  <dd class="mb-3">
                    <div class="fw-bold">${a.nama_tim||"N/A"}</div>
                    <small class="text-muted">ID: ${a.idTim}</small>
                  </dd>
                  
                  <dt>Jumlah Anggota</dt>
                  <dd class="mb-3">
                    <span class="badge bg-success" id="detailCount">
                      <i class="bi bi-people me-1"></i>
                      Loading...
                    </span>
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Anggota Terjadwal</h5>
            <span class="badge bg-white text-info" id="anggotaCount">Loading...</span>
          </div>
          <div class="card-body">
            <div id="anggotaJadwalList">
              <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-info" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Memuat data anggota...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `,i=document.querySelector(".modal-body");i&&(i.innerHTML=t,Xl(e),Ql(e))}catch(a){console.error("Error loading detail:",a),P("Detail Jadwal",`
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Gagal memuat detail jadwal: ${a.message}
      </div>
    `,null,!0)}}async function Xl(e){try{const t=(await M(b.detailAnggotaJadwal,{headers:v()})).filter(s=>s.idJadwal==e||s.jadwal_id==e).length,i=document.getElementById("detailCount");i&&(i.innerHTML=`<i class="bi bi-people me-1"></i>${t} Anggota`)}catch(a){console.error("Error loading count for detail:",a)}}async function Ql(e){try{const t=(await M(b.detailAnggotaJadwal,{headers:v()})).filter(n=>n.idJadwal==e),i=document.getElementById("anggotaJadwalList"),s=document.getElementById("anggotaCount");if(!i)return;!t||t.length===0?(i.innerHTML=`
        <div class="text-center py-4">
          <i class="bi bi-people fs-1 text-muted mb-3"></i>
          <h6 class="text-muted">Belum ada anggota terjadwal</h6>
          <p class="text-muted small">Tambahkan anggota ke jadwal ini melalui menu Detail Jadwal</p>
        </div>
      `,s&&(s.textContent="0 Anggota")):(i.innerHTML=`
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Nama Anggota</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${t.map(n=>`
                  <tr>
                    <td>
                      <div class="fw-medium">${n.nama_anggota||"Anggota"}</div>
                      <small class="text-muted">ID: ${n.idAnggota}</small>
                    </td>
                    <td>
                      <span class="badge ${ar(n.status_pengangkutan)}">
                        ${n.status_pengangkutan||"terjadwal"}
                      </span>
                    </td>
                  </tr>
                `).join("")}
            </tbody>
          </table>
        </div>
      `,s&&(s.textContent=`${t.length} Anggota`))}catch(a){console.error("Error loading anggota:",a);const t=document.getElementById("anggotaJadwalList");t&&(t.innerHTML=`
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Gagal memuat data anggota: ${a.message}
        </div>
      `)}}function ar(e){switch(e==null?void 0:e.toLowerCase()){case"selesai":return"bg-success";case"dalam_proses":return"bg-warning";case"dibatalkan":return"bg-danger";case"tertunda":return"bg-secondary";default:return"bg-info"}}function on(e,a,t=""){const i=new Date,s=i.getFullYear(),n=i.getMonth(),o=i.getDate(),l=new Date(e,a,1),c=new Date(e,a+1,0).getDate(),d=l.getDay();let m=0;if(t){const p=new Date(t);p.getFullYear()===e&&p.getMonth()===a&&(m=p.getDate())}const u=["M","S","S","R","K","J","S"];let g=`
    <div class="calendar-grid single-select">
      <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-sm btn-outline-secondary prev-month" type="button" title="Bulan sebelumnya">
          <i class="bi bi-chevron-left"></i>
        </button>
        <h6 class="mb-0 fw-bold">${ei(a)} ${e}</h6>
        <button class="btn btn-sm btn-outline-secondary next-month" type="button" title="Bulan selanjutnya">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      
      <div class="days-of-week d-flex mb-2">
        ${u.map(p=>`
          <div class="day-header text-center fw-semibold text-muted small flex-fill py-1">${p}</div>
        `).join("")}
      </div>
      
      <div class="calendar-days">
  `;for(let p=0;p<d;p++)g+='<div class="day empty"></div>';for(let p=1;p<=c;p++){const h=e===s&&a===n&&p===o,f=p===m,k=e<s||e===s&&a<n||e===s&&a===n&&p<o,w=`${e}-${String(a+1).padStart(2,"0")}-${String(p).padStart(2,"0")}`;g+=`
      <div class="day ${h?"today":""} ${k?"past disabled":"selectable"} ${f?"selected":""}" 
           data-date="${w}"
           ${k?'title="Tanggal sudah lewat"':'title="Klik untuk memilih"'}>
        ${p}
        <div class="day-checkmark">
          <i class="bi bi-check-circle-fill"></i>
        </div>
      </div>
    `}return g+=`
      </div>
    </div>
  `,g}function ln(e=""){var i,s;let a=e||"";function t(n){const o=document.getElementById("selectedDate"),l=document.getElementById("dateValue");o&&n&&(o.value=n),l&&n&&(l.innerHTML=`
        ${ti(n)}<br>
        <small class="text-muted">(${ii(n)})</small>
      `)}document.querySelectorAll(".calendar-days .selectable").forEach(n=>{n.addEventListener("click",function(o){const l=this.getAttribute("data-date");document.querySelectorAll(".calendar-days .selected").forEach(r=>{r.classList.remove("selected")}),this.classList.add("selected"),a=l,t(l)}),n.addEventListener("mouseenter",function(){this.classList.contains("selected")||this.classList.add("hover")}),n.addEventListener("mouseleave",function(){this.classList.remove("hover")})}),(i=document.querySelector(".prev-month"))==null||i.addEventListener("click",function(){const n=this.closest(".calendar-header").querySelector("h6"),[o,l]=n.textContent.split(" "),r=Re(o);let c=parseInt(l),d=r-1;d<0&&(d=11,c--),hs(c,d,a)}),(s=document.querySelector(".next-month"))==null||s.addEventListener("click",function(){const n=this.closest(".calendar-header").querySelector("h6"),[o,l]=n.textContent.split(" "),r=Re(o);let c=parseInt(l),d=r+1;d>11&&(d=0,c++),hs(c,d,a)}),a&&t(a)}function hs(e,a,t=""){const i=on(e,a,t),s=document.querySelector(".calendar-container");s&&(s.innerHTML=i,ln(t))}const rn=document.createElement("style");rn.textContent=`
  .calendar-grid.single-select {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
  }
  
  .calendar-grid.single-select .day.selected {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
    font-weight: bold;
    border-color: #0a58ca;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
  }
  
  .calendar-grid.single-select .day.selectable:hover:not(.selected) {
    background: #e3f2fd;
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
`;document.head.appendChild(rn);async function er(e){pe(`
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong>Perhatian!</strong>
      <p class="mt-2 mb-0">Apakah Anda yakin ingin menghapus jadwal ini?</p>
      <p class="mb-0">Semua data anggota yang terkait dengan jadwal ini juga akan dihapus.</p>
    </div>
    <p class="text-muted">Aksi ini tidak dapat dibatalkan.</p>
  `,async()=>{try{await M(`${b.jadwal}${e}/`,{method:"DELETE",headers:v()}),Wa("success","Jadwal berhasil dihapus!"),setTimeout(()=>{le()},1500)}catch(i){console.error("Error deleting jadwal:",i),P("Error",`
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Gagal menghapus jadwal: ${i.message}
        </div>
      `,null,!0)}})}window.goToJadwalPage=ql;window.viewDetailJadwal=Zl;window.editJadwal=Wl;window.deleteJadwal=er;window.showAddJadwalForm=tn;window.loadJadwal=le;function Fe(e,a="info"){typeof x=="function"?x(e,a,5e3):alert(`${a.toUpperCase()}: ${e}`)}let re=[],W=1;const Ht=10;async function tr(){const e=document.getElementById("mainContent");if(!document.getElementById("modalContainer")){const a=document.createElement("div");a.id="modalContainer",document.body.appendChild(a)}e.innerHTML=`
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Manajemen Pembayaran</h2>
                <button id="addPembayaranBtn" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Tambah Pembayaran
                </button>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="filterDate" class="form-label">Tanggal</label>
                    <input type="date" id="filterDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="filterStatus" class="form-label">Status</label>
                    <select id="filterStatus" class="form-select">
                        <option value="">Semua Status</option>
                        <option value="pending">Pending</option>
                        <option value="lunas">Lunas</option>
                        <option value="gagal">Gagal</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filterMetode" class="form-label">Metode</label>
                    <select id="filterMetode" class="form-select">
                        <option value="">Semua Metode</option>
                        <option value="Transfer">Transfer</option>
                        <option value="Tunai">Tunai</option>
                        <option value="QRIS">QRIS</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="resetFilter" class="btn btn-secondary w-100">
                        <i class="bi bi-arrow-clockwise"></i> Reset Filter
                    </button>
                </div>
            </div>
            
            <!-- Info Pagination -->
            <div id="paginationInfo" class="mb-2 text-muted"></div>
            
            <!-- Tabel Container -->
            <div id="pembayaranTableContainer" class="table-responsive">
                <p>Loading data...</p>
            </div>
            
            <!-- Pagination Container -->
            <div id="paginationContainer" class="mt-3 d-flex justify-content-center"></div>
        </div>
    `,W=1,re=[],document.getElementById("addPembayaranBtn").onclick=()=>gn(),document.getElementById("filterDate").onchange=de,document.getElementById("filterStatus").onchange=de,document.getElementById("filterMetode").onchange=de,document.getElementById("resetFilter").onclick=()=>{document.getElementById("filterDate").value="",document.getElementById("filterStatus").value="",document.getElementById("filterMetode").value="",de()},de()}function Ut(e){const a=document.getElementById(e);if(!a)return;a.querySelectorAll(".invalid-feedback").forEach(s=>{s.style.display="none"});const i=a.querySelectorAll("input, select");i.forEach(s=>{s.classList.remove("is-valid","is-invalid")}),i.forEach(s=>{s.addEventListener("blur",function(){dn(this)})})}function dn(e){e.classList.remove("is-valid","is-invalid");const a=e.nextElementSibling;e.checkValidity()?(e.classList.add("is-valid"),a&&a.classList.contains("valid-feedback")&&(a.style.display="block")):(e.classList.add("is-invalid"),a&&a.classList.contains("invalid-feedback")&&(a.style.display="block"))}function cn(e){const a=document.getElementById(e);let t=!0;if(a.querySelectorAll("[required]").forEach(s=>{dn(s),s.checkValidity()||(t=!1)}),e==="pembayaranForm"||e==="editPembayaranForm"){const s=document.getElementById("jumlahBayar");if(s){const n=parseFloat(s.value);if(isNaN(n)||n<=0){s.classList.add("is-invalid");let o=s.nextElementSibling;(!o||!o.classList.contains("invalid-feedback"))&&(o=document.createElement("div"),o.className="invalid-feedback",s.parentNode.insertBefore(o,s.nextSibling)),o.textContent="Jumlah bayar harus lebih dari 0",o.style.display="block",t=!1}}}return t}async function de(){const e=document.getElementById("filterDate").value,a=document.getElementById("filterStatus").value,t=document.getElementById("filterMetode").value;try{re=(await M(b.pembayaran,{headers:v()})).filter(n=>{const o=!e||n.tanggalBayar===e,l=!a||n.statusBayar===a,r=!t||n.metodeBayar===t;return o&&l&&r}),W=1,mn()}catch(i){document.getElementById("pembayaranTableContainer").innerHTML=`<p style="color: red; padding: 20px; text-align: center;">Error loading pembayaran: ${i.message}</p>`,document.getElementById("paginationContainer").innerHTML="",document.getElementById("paginationInfo").innerHTML=""}}function mn(){const e=document.getElementById("pembayaranTableContainer"),a=document.getElementById("paginationInfo");if(!re||re.length===0){e.innerHTML=`
      <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
        <div style="font-size: 48px; color: #ddd;">ðŸ’°</div>
        <h3 style="color: #666;">Tidak ada data pembayaran</h3>
        <p style="color: #888;">Coba ubah filter pencarian</p>
      </div>
    `,a.innerHTML="",document.getElementById("paginationContainer").innerHTML="";return}const t=(W-1)*Ht,i=Math.min(t+Ht,re.length),s=re.slice(t,i);a.innerHTML=`
    Menampilkan <strong>${t+1} - ${i}</strong> dari <strong>${re.length}</strong> pembayaran
  `,ir(s),sr()}function ir(e){const a=document.getElementById("pembayaranTableContainer"),t=`
        <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">ID</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Anggota</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Tanggal</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Jumlah</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Metode</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Status</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Aksi</th>
                </tr>
            </thead>
            <tbody>
                ${e.map(i=>`
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${i.idPembayaran}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${i.nama_anggota||"N/A"}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${i.tanggalBayar}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">Rp ${i.jumlahBayar.toLocaleString()}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${i.metodeBayar}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                            <span style="
                                padding: 6px 12px;
                                border-radius: 20px;
                                background: ${un(i.statusBayar)};
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                                display: inline-block;
                                text-transform: uppercase;
                            ">${i.statusBayar}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <button onclick="viewDetailPembayaran(${i.idPembayaran})" style="padding: 6px 12px; margin-right: 5px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="bi bi-eye"></i> Detail
                            </button>
                            <button onclick="editPembayaran(${i.idPembayaran})" style="padding: 6px 12px; margin-right: 5px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button onclick="deletePembayaran(${i.idPembayaran})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="bi bi-trash"></i> Hapus
                            </button>
                        </td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;a.innerHTML=t}function sr(){const e=document.getElementById("paginationContainer");if(!e)return;const a=Math.ceil(re.length/Ht);if(a<=1){e.innerHTML="";return}let t=`
    <div style="display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
      <!-- Previous Button -->
      <button ${W===1?"disabled":""}
        onclick="goToPembayaranPage(${W-1})"
        style="padding: 8px 16px; border: 1px solid #ddd; background: ${W===1?"#f5f5f5":"white"}; 
               color: ${W===1?"#999":"#333"}; border-radius: 4px; cursor: ${W===1?"not-allowed":"pointer"};">
        â† Prev
      </button>
  `,i=Math.max(1,W-2),s=Math.min(a,W+2);W<=3&&(s=Math.min(5,a)),W>=a-2&&(i=Math.max(1,a-4)),i>1&&(t+=`
      <button onclick="goToPembayaranPage(1)"
        style="padding: 8px 16px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer;">
        1
      </button>
    `,i>2&&(t+='<span style="padding: 8px 4px;">...</span>'));for(let n=i;n<=s;n++)t+=`
      <button onclick="goToPembayaranPage(${n})"
        style="padding: 8px 16px; border: 1px solid #ddd; 
               background: ${n===W?"#007bff":"white"}; 
               color: ${n===W?"white":"#333"}; 
               border-radius: 4px; cursor: pointer; font-weight: ${n===W?"bold":"normal"};">
        ${n}
      </button>
    `;s<a&&(s<a-1&&(t+='<span style="padding: 8px 4px;">...</span>'),t+=`
      <button onclick="goToPembayaranPage(${a})"
        style="padding: 8px 16px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer;">
        ${a}
      </button>
    `),t+=`
      <!-- Next Button -->
      <button ${W===a?"disabled":""}
        onclick="goToPembayaranPage(${W+1})"
        style="padding: 8px 16px; border: 1px solid #ddd; background: ${W===a?"#f5f5f5":"white"}; 
               color: ${W===a?"#999":"#333"}; border-radius: 4px; cursor: ${W===a?"not-allowed":"pointer"};">
        Next â†’
      </button>
    </div>
  `,e.innerHTML=t}function nr(e){e<1||e>Math.ceil(re.length/Ht)||(W=e,mn(),document.getElementById("pembayaranTableContainer").scrollIntoView({behavior:"smooth",block:"start"}))}function un(e){if(!e)return"#6c757d";const a=String(e).toLowerCase();return{lunas:"#28a745",paid:"#28a745",selesai:"#28a745",pending:"#ffc107",waiting:"#ffc107",gagal:"#dc3545",failed:"#dc3545",expired:"#6c757d",canceled:"#6c757d"}[a]||"#6c757d"}async function gn(){try{const a=(await M(b.anggota,{headers:v()})).map(s=>`<option value="${s.idAnggota}">${s.nama}</option>`).join(""),t=new Date().toISOString().split("T")[0],i=`
            <form id="pembayaranForm" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="idAnggota" class="form-label">Anggota *</label>
                    <select id="idAnggota" class="form-select" required>
                        <option value="">Pilih Anggota</option>
                        ${a}
                    </select>
                    <div class="invalid-feedback">Silakan pilih anggota.</div>
                </div>
                
                <div class="mb-3">
                    <label for="tanggalBayar" class="form-label">Tanggal Bayar *</label>
                    <input type="date" id="tanggalBayar" class="form-control" value="${t}" required>
                    <div class="invalid-feedback">Silakan isi tanggal bayar.</div>
                </div>
                
                <div class="mb-3">
                    <label for="jumlahBayar" class="form-label">Jumlah Bayar (Rp) *</label>
                    <input type="number" id="jumlahBayar" class="form-control" placeholder="50000" min="1" required>
                    <div class="invalid-feedback">Jumlah bayar harus lebih dari 0.</div>
                </div>
                
                <div class="mb-3">
                    <label for="metodeBayar" class="form-label">Metode Bayar *</label>
                    <select id="metodeBayar" class="form-select" required>
                        <option value="Transfer">Transfer</option>
                        <option value="Tunai">Tunai</option>
                        <option value="QRIS">QRIS</option>
                    </select>
                    <div class="invalid-feedback">Silakan pilih metode bayar.</div>
                </div>
                
                <div class="mb-3">
                    <label for="statusBayar" class="form-label">Status Bayar *</label>
                    <select id="statusBayar" class="form-select" required>
                        <option value="pending">Pending</option>
                        <option value="lunas">Lunas</option>
                        <option value="gagal">Gagal</option>
                    </select>
                    <div class="invalid-feedback">Silakan pilih status bayar.</div>
                </div>
                
                <div class="mb-3">
                    <label for="buktiBayar" class="form-label">Bukti Bayar (Opsional)</label>
                    <input type="file" id="buktiBayar" class="form-control" accept="image/*">
                    <div class="form-text">Format: JPG, PNG, GIF (max 5MB)</div>
                    <div class="invalid-feedback" id="fileError"></div>
                </div>
            </form>
        `;P("Tambah Pembayaran",i,async()=>{if(Ut("pembayaranForm"),!cn("pembayaranForm"))return!1;const s=document.getElementById("idAnggota").value,n=document.getElementById("tanggalBayar").value,o=document.getElementById("jumlahBayar").value,l=document.getElementById("metodeBayar").value,r=document.getElementById("statusBayar").value,c=document.getElementById("buktiBayar"),d=c.files[0]||null;if(d){if(!["image/jpeg","image/png","image/jpg","image/gif"].includes(d.type))return c.classList.add("is-invalid"),document.getElementById("fileError").textContent="Bukti bayar harus berupa gambar (JPG, PNG, GIF)",document.getElementById("fileError").style.display="block",!1;if(d.size>5242880)return c.classList.add("is-invalid"),document.getElementById("fileError").textContent="Ukuran bukti bayar maksimal 5MB",document.getElementById("fileError").style.display="block",!1}const m=new FormData;m.append("idAnggota",s),m.append("tanggalBayar",n),m.append("jumlahBayar",o),m.append("metodeBayar",l),m.append("statusBayar",r),d&&m.append("buktiBayar",d);try{const u={},g=localStorage.getItem("access");g&&(u.Authorization=`Bearer ${g}`);const p=await fetch(b.pembayaran,{method:"POST",headers:u,body:m});if(!p.ok){const h=await p.text();throw new Error(h||"Gagal menambah pembayaran")}return Fe("Pembayaran berhasil ditambahkan","success"),W=1,de(),!0}catch(u){return Fe(u.message,"danger"),!1}},()=>{setTimeout(()=>Ut("pembayaranForm"),100)})}catch(e){Fe("Error loading anggota: "+e.message,"danger")}}async function or(e){try{const a=await M(`${b.pembayaran}${e}/`,{headers:v()}),t=`
            <form id="editPembayaranForm" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="tanggalBayar" class="form-label">Tanggal Bayar *</label>
                    <input type="date" id="tanggalBayar" class="form-control" value="${a.tanggalBayar}" required>
                    <div class="invalid-feedback">Silakan isi tanggal bayar.</div>
                </div>
                
                <div class="mb-3">
                    <label for="jumlahBayar" class="form-label">Jumlah Bayar (Rp) *</label>
                    <input type="number" id="jumlahBayar" class="form-control" value="${a.jumlahBayar}" required>
                    <div class="invalid-feedback">Jumlah bayar harus lebih dari 0.</div>
                </div>
                
                <div class="mb-3">
                    <label for="metodeBayar" class="form-label">Metode Bayar *</label>
                    <select id="metodeBayar" class="form-select" required>
                        <option value="Transfer" ${a.metodeBayar==="Transfer"?"selected":""}>Transfer</option>
                        <option value="Tunai" ${a.metodeBayar==="Tunai"?"selected":""}>Tunai</option>
                        <option value="QRIS" ${a.metodeBayar==="QRIS"?"selected":""}>QRIS</option>
                    </select>
                    <div class="invalid-feedback">Silakan pilih metode bayar.</div>
                </div>
                
                <div class="mb-3">
                    <label for="statusBayar" class="form-label">Status Bayar *</label>
                    <select id="statusBayar" class="form-select" required>
                        <option value="pending" ${a.statusBayar==="pending"?"selected":""}>Pending</option>
                        <option value="lunas" ${a.statusBayar==="lunas"?"selected":""}>Lunas</option>
                        <option value="gagal" ${a.statusBayar==="gagal"?"selected":""}>Gagal</option>
                    </select>
                    <div class="invalid-feedback">Silakan pilih status bayar.</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Bukti Bayar Saat Ini:</label>
                    ${a.bukti_bayar_url?`<div class="mb-2">
                           <img src="${a.bukti_bayar_url}" 
                                alt="Bukti Saat Ini"
                                class="img-thumbnail" style="max-width: 200px; max-height: 200px; object-fit: contain;">
                         </div>
                         <a href="${a.bukti_bayar_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                           <i class="bi bi-box-arrow-up-right"></i> Buka di tab baru
                         </a>`:"<p class='text-muted'>Tidak ada bukti bayar</p>"}
                </div>
                
                <div class="mb-3">
                    <label for="buktiBayar" class="form-label">Ubah Bukti Bayar (Opsional):</label>
                    <input type="file" id="buktiBayar" class="form-control" accept="image/*">
                    <div class="form-text">Biarkan kosong jika tidak ingin mengubah</div>
                    <div class="invalid-feedback" id="editFileError"></div>
                </div>
            </form>
        `;P("Edit Pembayaran",t,async()=>{if(Ut("editPembayaranForm"),!cn("editPembayaranForm"))return!1;const i=document.getElementById("tanggalBayar").value,s=document.getElementById("jumlahBayar").value,n=document.getElementById("metodeBayar").value,o=document.getElementById("statusBayar").value,l=document.getElementById("buktiBayar"),r=l.files[0]||null;if(r){if(!["image/jpeg","image/png","image/jpg","image/gif"].includes(r.type))return l.classList.add("is-invalid"),document.getElementById("editFileError").textContent="Bukti bayar harus berupa gambar (JPG, PNG, GIF)",document.getElementById("editFileError").style.display="block",!1;if(r.size>5242880)return l.classList.add("is-invalid"),document.getElementById("editFileError").textContent="Ukuran bukti bayar maksimal 5MB",document.getElementById("editFileError").style.display="block",!1}const c=new FormData;c.append("tanggalBayar",i),c.append("jumlahBayar",s),c.append("metodeBayar",n),c.append("statusBayar",o),r&&c.append("buktiBayar",r);try{const d={},m=localStorage.getItem("access");m&&(d.Authorization=`Bearer ${m}`);const u=await fetch(`${b.pembayaran}${e}/`,{method:"PATCH",headers:d,body:c});if(!u.ok)throw new Error(await u.text());return Fe("Pembayaran berhasil diperbarui","success"),de(),!0}catch(d){return Fe(d.message,"danger"),!1}},()=>{setTimeout(()=>Ut("editPembayaranForm"),100)})}catch(a){Fe("Error loading pembayaran data: "+a.message,"danger")}}async function lr(e){try{console.log("Fetching detail pembayaran dengan ID:",e);const a=await M(`${b.pembayaran}${e}/`,{headers:v()});if(console.log("Data pembayaran yang diterima:",a),!a)throw new Error("Data pembayaran tidak ditemukan");let t="";a.bukti_bayar_url?t=a.bukti_bayar_url:a.buktiBayar?t=a.buktiBayar:typeof a.bukti_bayar=="string"&&a.bukti_bayar.startsWith("http")&&(t=a.bukti_bayar);const i=t?`<div style="margin-top: 15px;">
                <strong>Bukti Bayar:</strong><br>
                <img src="${t}" 
                     alt="Bukti Pembayaran"
                     style="max-width: 100%; max-height: 300px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; object-fit: contain;">
                <div style="margin-top: 10px;">
                  <a href="${t}" target="_blank" 
                     style="color: #007bff; text-decoration: none;">
                    <i class="bi bi-box-arrow-up-right"></i> Buka di tab baru
                  </a>
                </div>
            </div>`:"<p style='color: #666; font-style: italic;'>Tidak ada bukti bayar</p>",s=o=>{if(!o)return"-";try{return new Date(o).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"})}catch{return o}},n=`
      <div style="max-width: 600px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
          <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
            <i class="bi bi-receipt"></i> Detail Pembayaran
          </h3>
          <p style="margin: 5px 0 0 0; opacity: 0.9;">ID: #${a.idPembayaran||e}</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Anggota</div>
              <div style="font-weight: 600; color: #333;">${a.nama_anggota||"N/A"}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #17a2b8;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Tanggal Bayar</div>
              <div style="font-weight: 600; color: #333;">${s(a.tanggalBayar)}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Jumlah Bayar</div>
              <div style="font-weight: 600; color: #28a745;">
                Rp ${(a.jumlahBayar||0).toLocaleString("id-ID")}
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #6f42c1;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Metode Bayar</div>
              <div style="font-weight: 600; color: #333;">${a.metodeBayar||"N/A"}</div>
            </div>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Status Bayar</div>
              <span style="
                padding: 6px 16px;
                border-radius: 20px;
                background: ${un(a.statusBayar)};
                color: white;
                font-size: 14px;
                font-weight: bold;
                text-transform: uppercase;
                display: inline-block;
              ">
                ${a.statusBayar||"pending"}
              </span>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
              <i class="bi bi-image"></i> Bukti Bayar
            </h4>
            ${i}
          </div>
          
          ${a.keterangan?`
            <div style="margin-top: 20px;">
              <h4 style="margin-bottom: 10px; color: #333; display: flex; align-items: center; gap: 8px;">
                <i class="bi bi-chat-left-text"></i> Keterangan
              </h4>
              <div style="background: #e9ecef; padding: 12px; border-radius: 6px; font-size: 14px; color: #495057;">
                ${a.keterangan}
              </div>
            </div>
          `:""}
        </div>
      </div>
    `;P("Detail Pembayaran",n)}catch(a){console.error("Error loading detail:",a);const t=`
      <div style="text-align: center; padding: 40px 20px;">
        <div style="font-size: 48px; color: #dc3545; margin-bottom: 20px;">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h3 style="color: #dc3545; margin-bottom: 10px;">Gagal Memuat Detail</h3>
        <p style="color: #666; margin-bottom: 5px;">Terjadi kesalahan saat mengambil data pembayaran.</p>
        <p style="color: #999; font-size: 14px;">${a.message}</p>
        <button onclick="viewDetailPembayaran(${e})" 
                style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
          <i class="bi bi-arrow-clockwise"></i> Coba Lagi
        </button>
      </div>
    `;P("Error",t)}}async function rr(e){pe("Apakah Anda yakin ingin menghapus pembayaran ini?",async()=>{try{const a=await fetch(`${b.pembayaran}${e}/`,{method:"DELETE",headers:v()});if(!a.ok){const t=await a.text();throw new Error(t||`HTTP ${a.status}`)}Fe("Pembayaran berhasil dihapus!","success"),W=1,de()}catch(a){alert("Error deleting pembayaran: "+a.message)}})}window.goToPembayaranPage=nr;window.viewDetailPembayaran=lr;window.editPembayaran=or;window.deletePembayaran=rr;window.showAddPembayaranForm=gn;window.loadPembayaran=de;function q(e,a="info"){typeof x=="function"?x(e,a,5e3):alert(`${a.toUpperCase()}: ${e}`)}let ja=null,Lt=null,ce=[],ea=1;const Gt=10;let J=null,sa=null,X=null,R=null,na=null,Q=null;async function dr(){const e=document.getElementById("mainContent");if(!document.getElementById("modalContainer")){const a=document.createElement("div");a.id="modalContainer",document.body.appendChild(a)}e.innerHTML=`
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Manajemen Laporan Sampah</h2>
                <button id="addLaporanBtn" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Tambah Laporan
                </button>
            </div>

            <!-- PETA BESAR -->
            <div id="mapAllLaporan" style="
                width: 100%;
                height: 350px;
                border-radius: 10px;
                margin: 20px 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            "></div>
            
            <!-- FILTER DAN PENCARIAN -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="searchLaporan" placeholder="Cari laporan..." style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 250px;">
                <input type="date" id="filterDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <select id="filterStatus" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Semua Status</option>
                    <option value="pending">Pending</option>
                    <option value="proses">Proses</option>
                    <option value="selesai">Selesai</option>
                    <option value="ditolak">Ditolak</option>
                    <option value="diterima">Diterima</option>
                </select>
                <button id="resetFilter" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Reset Filter</button>
            </div>
            
            <!-- Info Pagination -->
            <div id="paginationInfo" style="margin-bottom: 10px; font-size: 14px; color: #666;"></div>
            
            <!-- Tabel Container -->
            <div id="laporanTableContainer" style="overflow-x: auto;">
                <p>Loading data...</p>
            </div>
            
            <!-- Pagination Container -->
            <div id="paginationContainer" style="margin-top: 20px; display: flex; justify-content: center;"></div>
        </div>
    `,ea=1,ce=[],document.getElementById("addLaporanBtn").onclick=()=>pn(),document.getElementById("searchLaporan").oninput=he,document.getElementById("filterDate").onchange=he,document.getElementById("filterStatus").onchange=he,document.getElementById("resetFilter").onclick=()=>{document.getElementById("searchLaporan").value="",document.getElementById("filterDate").value="",document.getElementById("filterStatus").value="",he()},he()}async function pn(){try{const e=JSON.parse(localStorage.getItem("user")||"{}"),a=(e==null?void 0:e.id)||1,t=`
            <form id="addLaporanForm" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="nama" class="form-label">Nama Pelapor *</label>
                    <input type="text" class="form-control" id="nama" value="${e.username||""}" required>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Nama pelapor wajib diisi.</div>
                </div>
                
                <div class="mb-3">
                    <label for="alamat" class="form-label">Alamat Lengkap *</label>
                    <textarea class="form-control" id="alamat" required rows="3" placeholder="Masukkan alamat lengkap tempat sampah"></textarea>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Alamat wajib diisi.</div>
                </div>
                
                <!-- PETA LOKASI -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-geo-alt me-1"></i>Pilih Lokasi di Peta
                    </label>
                    
                    <!-- Tombol GPS -->
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" id="btnGetGPSLocationAdd" class="btn btn-success">
                            <i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS
                        </button>
                        <button type="button" id="btnResetMapLocationAdd" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise me-1"></i> Reset Peta
                        </button>
                    </div>
                    
                    <!-- Status GPS -->
                    <div id="gpsStatusAdd" class="mb-2">
                        <div id="gpsLoadingAdd" class="alert alert-primary d-none py-1" role="alert">
                            <i class="bi bi-hourglass-split me-1"></i> Mendapatkan lokasi...
                        </div>
                        <div id="gpsSuccessAdd" class="alert alert-success d-none py-1" role="alert">
                            <i class="bi bi-check-circle me-1"></i> Lokasi berhasil didapatkan
                        </div>
                        <div id="gpsErrorAdd" class="alert alert-danger d-none py-1" role="alert">
                            <i class="bi bi-exclamation-circle me-1"></i> Gagal mendapatkan lokasi
                        </div>
                    </div>
                    
                    <!-- Peta -->
                    <div id="mapAddLaporan" style="
                        width: 100%;
                        height: 250px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        margin-bottom: 10px;
                        background: #f8f9fa;
                    "></div>
                    
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Klik pada peta untuk memilih lokasi atau gunakan tombol GPS
                    </small>
                </div>
                
                <!-- Koordinat Input -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="latitude" class="form-label">
                            <i class="bi bi-geo-alt-fill me-1"></i>Latitude *
                        </label>
                        <div class="input-group">
                            <input type="number" step="any" class="form-control" id="latitude" value="-10.1711872" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyLaporanAddValue('latitude')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback">Latitude harus angka antara -90 sampai 90.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="longitude" class="form-label">
                            <i class="bi bi-geo-alt-fill me-1"></i>Longitude *
                        </label>
                        <div class="input-group">
                            <input type="number" step="any" class="form-control" id="longitude" value="123.6149376" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyLaporanAddValue('longitude')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback">Longitude harus angka antara -180 sampai 180.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Lokasi Cepat -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-lightning-charge me-1"></i>Lokasi Cepat
                    </label>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setLaporanAddLocation(-10.1711872, 123.6149376, 'Lokasi Tetap')">
                            <i class="bi bi-house me-1"></i> Lokasi Tetap
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="setLaporanAddLocation(-10.1935921, 123.6149376, 'Kota Kupang')">
                            <i class="bi bi-geo-alt me-1"></i> Kota Kupang
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="deskripsi" class="form-label">Deskripsi Masalah *</label>
                    <textarea class="form-control" id="deskripsi" required rows="4" placeholder="Deskripsikan kondisi sampah di lokasi tersebut"></textarea>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Deskripsi masalah wajib diisi.</div>
                </div>
                
                <div class="mb-3">
                    <label for="status" class="form-label">Status Laporan *</label>
                    <select class="form-select" id="status" required>
                        <option value="" selected disabled>Pilih status...</option>
                        <option value="pending">â³ Pending</option>
                        <option value="proses">ðŸ”„ Proses</option>
                        <option value="selesai">âœ… Selesai</option>
                    </select>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Status laporan wajib dipilih.</div>
                </div>
                
                <div class="mb-3">
                    <label for="foto_bukti" class="form-label">Foto Bukti *</label>
                    <input type="file" class="form-control" id="foto_bukti" accept="image/*" required>
                    <div class="form-text">Maksimal 5MB. Format: JPG, PNG, GIF.</div>
                    
                    <div id="previewContainerAdd" class="mt-2 d-none">
                        <p class="mb-1">Preview:</p>
                        <img id="fotoPreviewAdd" class="img-thumbnail" style="max-width: 200px;">
                    </div>
                </div>
            </form>
        `;P("Tambah Laporan Sampah",t,async()=>{const i=document.getElementById("addLaporanForm");if(i.classList.add("was-validated"),!i.checkValidity())return q("Harap isi semua field yang wajib diisi dengan benar","error"),!1;const s=parseFloat(document.getElementById("latitude").value),n=parseFloat(document.getElementById("longitude").value);if(isNaN(s)||s<-90||s>90)return document.getElementById("latitude").classList.add("is-invalid"),document.getElementById("latitude").classList.remove("is-valid"),q("Latitude harus angka antara -90 sampai 90","error"),!1;if(document.getElementById("latitude").classList.add("is-valid"),document.getElementById("latitude").classList.remove("is-invalid"),isNaN(n)||n<-180||n>180)return document.getElementById("longitude").classList.add("is-invalid"),document.getElementById("longitude").classList.remove("is-valid"),q("Longitude harus angka antara -180 sampai 180","error"),!1;document.getElementById("longitude").classList.add("is-valid"),document.getElementById("longitude").classList.remove("is-invalid");const o=document.getElementById("foto_bukti");if(o.files.length===0)return o.classList.add("is-invalid"),o.classList.remove("is-valid"),q("Foto bukti wajib diunggah","error"),!1;const l=o.files[0],r=5*1024*1024;if(!["image/jpeg","image/jpg","image/png","image/gif"].includes(l.type))return o.classList.add("is-invalid"),o.classList.remove("is-valid"),q("File harus berupa gambar (JPG, PNG, GIF)","error"),!1;if(l.size>r)return o.classList.add("is-invalid"),o.classList.remove("is-valid"),q("Ukuran file maksimal 5MB","error"),!1;o.classList.add("is-valid"),o.classList.remove("is-invalid");const d=new FormData;d.append("nama",document.getElementById("nama").value.trim()),d.append("alamat",document.getElementById("alamat").value.trim()),d.append("latitude",s),d.append("longitude",n),d.append("deskripsi",document.getElementById("deskripsi").value.trim()),d.append("status",document.getElementById("status").value),d.append("tanggal_lapor",new Date().toISOString().split("T")[0]),d.append("idUser",a),o.files.length>0&&d.append("foto_bukti",o.files[0]);try{const m=localStorage.getItem("access"),u={};m&&(u.Authorization=`Bearer ${m}`);const g=document.querySelector(".modal-footer .btn-primary"),p=g.innerHTML;g.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',g.disabled=!0;const h=await fetch(b.laporanSampah,{method:"POST",headers:u,body:d});if(!h.ok){const f=await h.text();throw new Error(f||`HTTP ${h.status}`)}return q("Laporan berhasil ditambahkan!","success"),he(),!0}catch(m){return console.error("Error adding laporan:",m),q("Gagal menambahkan laporan: "+m.message,"error"),!1}}),setTimeout(()=>{cr();const i=document.getElementById("btnGetGPSLocationAdd"),s=document.getElementById("btnResetMapLocationAdd");i&&(i.onclick=()=>mr()),s&&(s.onclick=()=>ur()),document.querySelectorAll("#addLaporanForm input, #addLaporanForm textarea, #addLaporanForm select").forEach(m=>{m.addEventListener("input",function(){this.checkValidity()?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))}),m.addEventListener("change",function(){this.checkValidity()?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))})});const o=document.getElementById("latitude"),l=document.getElementById("longitude");o&&o.addEventListener("input",function(){const m=parseFloat(this.value);!isNaN(m)&&m>=-90&&m<=90?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))}),l&&l.addEventListener("input",function(){const m=parseFloat(this.value);!isNaN(m)&&m>=-180&&m<=180?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))});const r=document.getElementById("foto_bukti"),c=document.getElementById("previewContainerAdd"),d=document.getElementById("fotoPreviewAdd");r&&r.addEventListener("change",function(){if(this.files&&this.files[0]){const m=this.files[0],u=["image/jpeg","image/jpg","image/png","image/gif"],g=5*1024*1024;if(!u.includes(m.type)){this.classList.remove("is-valid"),this.classList.add("is-invalid");return}if(m.size>g){this.classList.remove("is-valid"),this.classList.add("is-invalid");return}this.classList.remove("is-invalid"),this.classList.add("is-valid");const p=new FileReader;p.onload=function(h){d.src=h.target.result,c.classList.remove("d-none"),c.classList.add("d-block")},p.readAsDataURL(m)}else c.classList.remove("d-block"),c.classList.add("d-none"),this.classList.remove("is-valid")})},100)}catch(e){q("Error loading form: "+e.message,"danger")}}function cr(){const e=document.getElementById("mapAddLaporan");if(!e){console.error("Add laporan map container not found");return}const a=-10.1711872,t=123.6149376;ba(()=>{try{R&&(R.remove(),R=null),na=null,Q=null,R=L.map("mapAddLaporan").setView([a,t],15),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19,noWrap:!0}).addTo(R),na=L.marker([a,t],{draggable:!0}).addTo(R),na.bindPopup(`
        <div style="font-size: 14px;">
          <strong>ðŸ“ Lokasi Laporan</strong><br>
          <small>
            Lat: ${a.toFixed(6)}<br>
            Lng: ${t.toFixed(6)}<br>
            <em>Drag untuk mengubah lokasi</em>
          </small>
        </div>
      `).openPopup(),na.on("dragend",function(i){const s=na.getLatLng();He(s.lat,s.lng),Q&&R.hasLayer(Q)&&(R.removeLayer(Q),Q=null),ye("manual")}),R.on("click",function(i){const{lat:s,lng:n}=i.latlng;He(s,n),na.setLatLng([s,n]),Q&&R.hasLayer(Q)&&(R.removeLayer(Q),Q=null),ye("manual")}),He(a,t),setTimeout(()=>{R&&R.invalidateSize(!0)},200)}catch(i){console.error("Error setting up add laporan map:",i),e.innerHTML=`
        <div style="
          width: 100%;
          height: 250px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: #f8f9fa;
          border: 1px solid #ddd;
          border-radius: 6px;
          color: #666;
          text-align: center;
          padding: 20px;
        ">
          <div style="font-size: 36px; margin-bottom: 10px;">âš ï¸</div>
          <p style="margin: 0;">Peta tidak dapat dimuat: ${i.message}</p>
          <button onclick="setupAddLaporanMap()" 
                  style="margin-top: 10px; padding: 8px 16px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Coba Lagi
          </button>
        </div>
      `}})}function mr(){const e=document.getElementById("btnGetGPSLocationAdd");if(!e)return;if(e.disabled=!0,e.innerHTML='<i class="bi bi-hourglass-split me-1"></i> Mendapatkan lokasi...',ye("loading"),!navigator.geolocation){ye("error"),q("Browser tidak mendukung Geolocation","error"),e.disabled=!1,e.innerHTML='<i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS';return}const a={enableHighAccuracy:!0,timeout:15e3,maximumAge:0};navigator.geolocation.getCurrentPosition(function(t){const i=t.coords.latitude,s=t.coords.longitude,n=t.coords.accuracy;if(console.log("GPS Location Retrieved:",{latitude:i,longitude:s,accuracy:n}),He(i,s),R){R.setView([i,s],17),Q&&R.hasLayer(Q)&&R.removeLayer(Q),Q=L.marker([i,s],{icon:L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),title:"LOKASI GPS ANDA",draggable:!1,zIndexOffset:1e3}).addTo(R);const l=n<100?`Akurasi: Â±${Math.round(n)} meter (Tinggi)`:n<500?`Akurasi: Â±${Math.round(n)} meter (Sedang)`:`Akurasi: Â±${Math.round(n)} meter (Rendah)`;Q.bindPopup(`
          <div style="max-width: 250px;">
            <strong style="color: #28a745;">ðŸ“ LOKASI GPS ANDA</strong><br>
            <small>
              <b>Lat:</b> ${i.toFixed(6)}<br>
              <b>Lng:</b> ${s.toFixed(6)}<br>
              <b>${l}</b><br>
              <i>Lokasi GPS asli Anda</i>
            </small>
          </div>
        `).openPopup(),n>50&&L.circle([i,s],{radius:n,color:"#28a745",fillColor:"#28a745",fillOpacity:.1,weight:1}).addTo(R).bindPopup(`Rentang akurasi: Â±${Math.round(n)} meter`),na&&(na.setLatLng([i,s]),na.setOpacity(.5)),setTimeout(()=>{R.invalidateSize()},100)}const o=n<100?`Lokasi GPS ditemukan! (Akurasi tinggi: Â±${Math.round(n)}m)`:n<500?`Lokasi GPS ditemukan! (Akurasi sedang: Â±${Math.round(n)}m)`:`Lokasi GPS ditemukan! (Akurasi rendah: Â±${Math.round(n)}m)`;ye("success",o),e.disabled=!1,e.innerHTML='<i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS',q(o,"success")},function(t){console.error("Geolocation Error:",t);let i="Gagal mendapatkan lokasi GPS";switch(t.code){case t.PERMISSION_DENIED:i="Akses GPS ditolak. Harap izinkan akses lokasi di browser Anda.";break;case t.POSITION_UNAVAILABLE:i="Informasi lokasi tidak tersedia. Pastikan GPS aktif.";break;case t.TIMEOUT:i="Waktu permintaan lokasi habis. Coba lagi.";break;default:i="Terjadi kesalahan saat mengambil lokasi."}ye("error",i),e.disabled=!1,e.innerHTML='<i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS',q(i,"error");const s=-10.1711872,n=123.6149376;He(s,n),R&&(R.setView([s,n],15),na&&na.setLatLng([s,n])),q("Menggunakan lokasi fallback sebagai alternatif","warning")},a)}function ur(){if(R){const e=-10.1711872,a=123.6149376;R.setView([e,a],15),Q&&R.hasLayer(Q)&&(R.removeLayer(Q),Q=null),na&&(na.setLatLng([e,a]),na.setOpacity(1),na.bindPopup(`
        <div style="max-width: 200px;">
          <strong>ðŸ“ Lokasi Laporan</strong><br>
          <small>
            Lat: ${e.toFixed(6)}<br>
            Lng: ${a.toFixed(6)}
          </small>
        </div>
      `).openPopup()),He(e,a),ye("manual"),setTimeout(()=>{R.invalidateSize()},200)}}function He(e,a){const t=document.getElementById("latitude"),i=document.getElementById("longitude");t&&i&&(t.value=e,i.value=a)}function ye(e,a=""){const t=document.getElementById("gpsLoadingAdd"),i=document.getElementById("gpsSuccessAdd"),s=document.getElementById("gpsErrorAdd");if(!(!t||!i||!s))switch(t.style.display="none",i.style.display="none",s.style.display="none",e){case"loading":t.style.display="block";break;case"success":i.innerHTML=`
        <i class="bi bi-check-circle me-1"></i> ${a||"Lokasi GPS ditemukan!"}
      `,i.style.display="block";break;case"error":s.innerHTML=`
        <i class="bi bi-exclamation-circle me-1"></i> ${a||"Gagal mendapatkan lokasi GPS"}
      `,s.style.display="block";break;case"manual":i.innerHTML=`
        <i class="bi bi-geo-alt-fill me-1"></i> Lokasi dipilih manual di peta
      `,i.style.display="block";break}}window.setLaporanAddLocation=function(e,a,t){He(e,a),R&&(R.setView([e,a],17),Q&&R.hasLayer(Q)&&(R.removeLayer(Q),Q=null),na&&(na.setLatLng([e,a]),na.setOpacity(1),na.bindPopup(`
        <div style="max-width: 200px;">
          <strong>ðŸ“ ${t}</strong><br>
          <small>
            Lat: ${e.toFixed(6)}<br>
            Lng: ${a.toFixed(6)}
          </small>
        </div>
      `).openPopup()),ye("manual"),setTimeout(()=>{R.invalidateSize()},100))};window.copyLaporanAddValue=function(e){const a=document.getElementById(e);if(a){a.select(),document.execCommand("copy");const t=a.value;a.value="âœ“ Disalin!",setTimeout(()=>{a.value=t},1e3)}};function gr(e){const a=document.getElementById("mapAllLaporan");if(!a){console.error("Map container not found!");return}a.innerHTML="",ba(()=>{try{ja&&(ja.remove(),ja=null);const t=-10.1711872,i=123.6149376;ja=L.map("mapAllLaporan").setView([t,i],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19,noWrap:!0}).addTo(ja),Lt&&Lt.clearLayers(),Lt=L.layerGroup().addTo(ja);const s=e.filter(n=>{if(!n.latitude||!n.longitude)return!1;const o=parseFloat(n.latitude),l=parseFloat(n.longitude);return!isNaN(o)&&!isNaN(l)});if(s.length>0){const n=L.latLngBounds([]);if(s.forEach((o,l)=>{try{const r=parseFloat(o.latitude),c=parseFloat(o.longitude),d=`
              <div style="max-width: 250px;">
                <strong>${o.nama||"Laporan"}</strong><br>
                <small>${o.alamat||""}</small><br>
                <small>Status: <strong>${o.status||"dilaporkan"}</strong></small><br>
                <small>ID: ${o.idLaporan}</small><br>
                <small>Tanggal: ${o.tanggal_lapor}</small><br>
                <button onclick="viewDetailLaporan(${o.idLaporan})" 
                        style="margin-top: 5px; padding: 5px 10px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                  Lihat Detail
                </button>
              </div>
            `;L.marker([r,c]).addTo(Lt).bindPopup(d),n.extend([r,c])}catch(r){console.error(`Error creating marker for laporan ${l}:`,r)}}),n.isValid()&&n.getNorth()!==n.getSouth())try{ja.fitBounds(n,{padding:[50,50],maxZoom:15})}catch{console.warn("Could not fit bounds, using default view"),ja.setView([t,i],13)}else ja.setView([t,i],13)}else{ja.setView([t,i],13);const n=document.createElement("div");n.style.cssText=`
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          text-align: center;
          z-index: 1000;
          background: rgba(255,255,255,0.95);
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border: 1px solid #ddd;
        `,n.innerHTML=`
          <div style="font-size: 48px; margin-bottom: 10px; color: #999;">ðŸ—‘ï¸</div>
          <p style="margin: 0; color: #666; font-size: 14px;">Tidak ada data laporan dengan koordinat</p>
        `,a.appendChild(n)}setTimeout(()=>{ja&&ja.invalidateSize(!0)},300)}catch(t){console.error("Error rendering map:",t),a.innerHTML=`
        <div style="
          width: 100%;
          height: 350px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: #f8f9fa;
          border-radius: 10px;
          border: 2px dashed #ddd;
          color: #666;
          text-align: center;
          padding: 20px;
        ">
          <div style="font-size: 48px; margin-bottom: 10px;">ðŸ—ºï¸</div>
          <h3 style="margin: 0 0 10px 0;">Peta Tidak Dapat Dimuat</h3>
          <p style="margin: 0; font-size: 14px;">${t.message}</p>
          <button onclick="window.location.reload()" 
                  style="margin-top: 15px; padding: 8px 16px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Muat Ulang Halaman
          </button>
        </div>
      `}})}async function he(){const e=document.getElementById("searchLaporan").value,a=document.getElementById("filterDate").value,t=document.getElementById("filterStatus").value;try{const s=(await M(b.laporanSampah,{headers:v()})).filter(n=>{const o=n.nama.toLowerCase().includes(e.toLowerCase())||n.alamat.toLowerCase().includes(e.toLowerCase())||n.deskripsi&&n.deskripsi.toLowerCase().includes(e.toLowerCase()),l=!a||n.tanggal_lapor===a,r=!t||n.status===t;return o&&l&&r});ce=s,ea=1,bn(),gr(s)}catch(i){document.getElementById("laporanTableContainer").innerHTML=`<p style="color: red; padding: 20px; text-align: center;">Error loading laporan: ${i.message}</p>`,document.getElementById("paginationContainer").innerHTML="",document.getElementById("paginationInfo").innerHTML=""}}function pr(e){const a=document.getElementById("laporanTableContainer"),t=`
        <table style="width: 100%; border-collapse: collapse; background: white; font-size: 14px;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">ID</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">Nama</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">Tanggal</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">Alamat</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">Status</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center; font-weight: 600;">Foto</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center; font-weight: 600;">Aksi</th>
                </tr>
            </thead>
            <tbody>
                ${e.map(i=>`
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">${i.idLaporan}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${i.nama}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${i.tanggal_lapor}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${i.alamat?i.alamat.substring(0,30)+(i.alamat.length>30?"...":""):"-"}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">
                            <span style="
                                padding: 6px 12px;
                                border-radius: 20px;
                                background: ${fn(i.status)};
                                color: white;
                                font-size: 12px;
                                font-weight: 600;
                                display: inline-block;
                            ">${i.status}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
                            ${i.foto_bukti_url?`<a href="${i.foto_bukti_url}" target="_blank" 
                                   style="color: #0d6efd; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="bi bi-image"></i> Lihat
                                  </a>`:'<span style="color: #6c757d; font-style: italic;">-</span>'}
                        </td>
                        <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button onclick="viewDetailLaporan(${i.idLaporan})" 
                                        style="padding: 6px 12px; background: #0dcaf0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                    <i class="bi bi-eye"></i> Detail
                                </button>
                                <button onclick="editLaporan(${i.idLaporan})" 
                                        style="padding: 6px 12px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button onclick="deleteLaporan(${i.idLaporan})" 
                                        style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                    <i class="bi bi-trash"></i> Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;a.innerHTML=t}function bn(){const e=document.getElementById("laporanTableContainer"),a=document.getElementById("paginationInfo");if(!ce||ce.length===0){e.innerHTML=`
      <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
        <div style="font-size: 48px; color: #ddd;">ðŸ—‘ï¸</div>
        <h3 style="color: #666;">Tidak ada data laporan</h3>
        <p style="color: #888;">Coba ubah filter pencarian</p>
      </div>
    `,a.innerHTML="",document.getElementById("paginationContainer").innerHTML="";return}const t=(ea-1)*Gt,i=Math.min(t+Gt,ce.length),s=ce.slice(t,i);a.innerHTML=`
    Menampilkan <strong>${t+1} - ${i}</strong> dari <strong>${ce.length}</strong> laporan
  `,pr(s),br()}function br(){const e=document.getElementById("paginationContainer");if(!e)return;const a=Math.ceil(ce.length/Gt);if(a<=1){e.innerHTML="";return}let t=`
    <div style="display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
      <!-- Previous Button -->
      <button ${ea===1?"disabled":""}
        onclick="goToLaporanPage(${ea-1})"
        style="padding: 8px 16px; border: 1px solid #dee2e6; background: ${ea===1?"#f5f5f5":"white"}; 
               color: ${ea===1?"#999":"#333"}; border-radius: 4px; cursor: ${ea===1?"not-allowed":"pointer"}; font-size: 14px;">
        â† Prev
      </button>
  `,i=Math.max(1,ea-2),s=Math.min(a,ea+2);ea<=3&&(s=Math.min(5,a)),ea>=a-2&&(i=Math.max(1,a-4)),i>1&&(t+=`
      <button onclick="goToLaporanPage(1)"
        style="padding: 8px 16px; border: 1px solid #dee2e6; background: white; color: #333; border-radius: 4px; cursor: pointer; font-size: 14px;">
        1
      </button>
    `,i>2&&(t+='<span style="padding: 8px 4px; color: #666;">...</span>'));for(let n=i;n<=s;n++)t+=`
      <button onclick="goToLaporanPage(${n})"
        style="padding: 8px 16px; border: 1px solid #dee2e6; 
               background: ${n===ea?"#0d6efd":"white"}; 
               color: ${n===ea?"white":"#333"}; 
               border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: ${n===ea?"bold":"normal"};">
        ${n}
      </button>
    `;s<a&&(s<a-1&&(t+='<span style="padding: 8px 4px; color: #666;">...</span>'),t+=`
      <button onclick="goToLaporanPage(${a})"
        style="padding: 8px 16px; border: 1px solid #dee2e6; background: white; color: #333; border-radius: 4px; cursor: pointer; font-size: 14px;">
        ${a}
      </button>
    `),t+=`
      <!-- Next Button -->
      <button ${ea===a?"disabled":""}
        onclick="goToLaporanPage(${ea+1})"
        style="padding: 8px 16px; border: 1px solid #dee2e6; background: ${ea===a?"#f5f5f5":"white"}; 
               color: ${ea===a?"#999":"#333"}; border-radius: 4px; cursor: ${ea===a?"not-allowed":"pointer"}; font-size: 14px;">
        Next â†’
      </button>
    </div>
  `,e.innerHTML=t}function fr(e){e<1||e>Math.ceil(ce.length/Gt)||(ea=e,bn(),document.getElementById("laporanTableContainer").scrollIntoView({behavior:"smooth",block:"start"}))}function fn(e){return{pending:"#ffc107",proses:"#17a2b8",selesai:"#28a745"}[e]||"#6c757d"}async function hr(e){try{const a=await M(`${b.laporanSampah}${e}/`,{headers:v()}),t=a.foto_bukti_url?`
            <div style="
                background:#fff;
                border-radius:10px;
                padding:12px;
                border:1px solid #eee;
                margin-top:15px;
            ">
                <div style="font-weight:600; margin-bottom:8px;">ðŸ“¸ Foto Bukti</div>
                <img src="${a.foto_bukti_url}"
                    style="
                        width:100%;
                        max-height:280px;
                        object-fit:cover;
                        border-radius:8px;
                        border:1px solid #ddd;
                    "
                >
                <div style="margin-top:8px; text-align:right;">
                    <a href="${a.foto_bukti_url}" target="_blank"
                        style="font-size:13px; color:#0d6efd; text-decoration:none;">
                        ðŸ”— Lihat resolusi penuh
                    </a>
                </div>
            </div>
        `:`
            <div style="
                background:#fff3cd;
                color:#856404;
                padding:10px 12px;
                border-radius:8px;
                border:1px solid #ffeeba;
                margin-top:15px;
                font-size:13px;
            ">
                âš ï¸ Tidak ada foto bukti
            </div>
        `,i=fn(a.status),s=`
            <div>

                <h2 style="
                    margin:0 0 12px 0;
                    font-size:20px;
                    font-weight:700;
                    color:#333;
                    text-align:center;
                ">
                    Detail Laporan Sampah
                </h2>

                <!-- MAP -->
                <div style="margin: 15px 0;">
                    <div id="mapDetailLaporan" style="
                        width: 100%;
                        height: 260px;
                        border-radius: 12px;
                        background:#e0e0e0;
                        box-shadow:0 2px 8px rgba(0,0,0,0.1);
                    "></div>
                </div>

                <!-- CARD DETAIL -->
                <div style="
                    background:#ffffff;
                    padding:18px;
                    border-radius:12px;
                    border:1px solid #eee;
                    box-shadow:0 2px 6px rgba(0,0,0,0.05);
                ">
                    <p><strong>ID Laporan:</strong> ${a.idLaporan}</p>

                    <div style="margin:8px 0;">
                        <strong>Nama Pelapor:</strong><br>
                        <span style="
                            background:#f1f3f5;
                            padding:6px 10px;
                            border-radius:6px;
                            display:inline-block;
                            margin-top:4px;
                            color:#333;
                        ">
                            ðŸ‘¤ ${a.nama}
                        </span>
                    </div>

                    <p><strong>Akun User:</strong> ${a.nama_user||"Tidak diketahui"}</p>
                    <p><strong>Tanggal Lapor:</strong> ${a.tanggal_lapor}</p>

                    <div style="margin:10px 0;">
                        <strong>Alamat Lengkap:</strong><br>
                        <span style="color:#444;">${a.alamat}</span>
                    </div>

                    <p><strong>Koordinat:</strong> 
                        <span style="color:#007bff;">${a.latitude}, ${a.longitude}</span>
                    </p>

                    <div style="margin:10px 0;">
                        <strong>Deskripsi:</strong>
                        <div style="
                            padding:10px;
                            background:#f8f9fa;
                            border-left:3px solid #0d6efd;
                            border-radius:6px;
                            margin-top:4px;
                        ">
                            ${a.deskripsi}
                        </div>
                    </div>

                    <p>
                        <strong>Status:</strong> 
                        <span style="
                            padding:4px 10px;
                            border-radius:10px;
                            font-size:12px;
                            font-weight:600;
                            color:white;
                            background:${i};
                        ">
                            ${a.status.toUpperCase()}
                        </span>
                    </p>

                    ${t}
                </div>
            </div>
        `;P("Detail Laporan",s),setTimeout(()=>{vr(a)},300)}catch(a){alert("Error loading detail: "+a.message)}}function vr(e){if(!e.latitude||!e.longitude){console.warn("Laporan missing coordinates for detail map");return}const a=document.getElementById("mapDetailLaporan");if(!a){console.error("Detail map container not found");return}a.innerHTML="",ba(()=>{var t,i;try{const s=parseFloat(e.latitude),n=parseFloat(e.longitude);if(isNaN(s)||isNaN(n))throw new Error("Invalid coordinates");const o=L.map("mapDetailLaporan").setView([s,n],16);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19,noWrap:!0}).addTo(o);const l=L.marker([s,n]).addTo(o),r=`
        <div style="max-width: 250px;">
          <b>${e.nama||"Laporan"}</b><br>
          <small>${e.alamat||""}</small><br>
          <small>Status: <strong>${e.status||"dilaporkan"}</strong></small><br>
          <small>Deskripsi: ${((t=e.deskripsi)==null?void 0:t.substring(0,100))||""}${((i=e.deskripsi)==null?void 0:i.length)>100?"...":""}</small><br>
          <small>Tanggal: ${e.tanggal_lapor}</small>
        </div>
      `;l.bindPopup(r).openPopup(),setTimeout(()=>{o.invalidateSize(!0)},300)}catch(s){console.error("Error rendering detail map:",s),a.innerHTML=`
        <div style="
          width: 100%;
          height: 260px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: #f8f9fa;
          border-radius: 12px;
          color: #666;
          text-align: center;
          padding: 20px;
        ">
          <div style="font-size: 36px; margin-bottom: 10px;">ðŸ“</div>
          <p style="margin: 0;">Lokasi: ${e.latitude}, ${e.longitude}</p>
          <p style="margin: 5px 0 0 0; font-size: 12px; color: #888;">Peta tidak dapat ditampilkan</p>
        </div>
      `}})}async function yr(e){try{const a=await M(`${b.laporanSampah}${e}/`,{headers:v()}),t=`
            <form id="editLaporanForm" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="nama" class="form-label">Nama Pelapor *</label>
                    <input type="text" class="form-control" id="nama" value="${a.nama}" required>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Nama pelapor wajib diisi.</div>
                </div>
                
                <div class="mb-3">
                    <label for="alamat" class="form-label">Alamat Lengkap *</label>
                    <textarea class="form-control" id="alamat" required rows="3">${a.alamat}</textarea>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Alamat wajib diisi.</div>
                </div>
                
                <!-- PETA LOKASI -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-geo-alt me-1"></i>Pilih Lokasi di Peta
                    </label>
                    
                    <!-- Tombol GPS -->
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" id="btnGetGPSLocation" class="btn btn-success">
                            <i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS
                        </button>
                        <button type="button" id="btnResetMapLocation" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise me-1"></i> Reset Peta
                        </button>
                    </div>
                    
                    <!-- Status GPS -->
                    <div id="gpsStatus" class="mb-2">
                        <div id="gpsLoading" class="alert alert-primary d-none py-1" role="alert">
                            <i class="bi bi-hourglass-split me-1"></i> Mendapatkan lokasi...
                        </div>
                        <div id="gpsSuccess" class="alert alert-success d-none py-1" role="alert">
                            <i class="bi bi-check-circle me-1"></i> Lokasi berhasil didapatkan
                        </div>
                        <div id="gpsError" class="alert alert-danger d-none py-1" role="alert">
                            <i class="bi bi-exclamation-circle me-1"></i> Gagal mendapatkan lokasi
                        </div>
                    </div>
                    
                    <!-- Peta -->
                    <div id="mapEditLaporan" style="
                        width: 100%;
                        height: 250px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        margin-bottom: 10px;
                        background: #f8f9fa;
                    "></div>
                    
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Klik pada peta untuk memilih lokasi atau gunakan tombol GPS
                    </small>
                </div>
                
                <!-- Koordinat Input -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="latitude" class="form-label">
                            <i class="bi bi-geo-alt-fill me-1"></i>Latitude *
                        </label>
                        <div class="input-group">
                            <input type="number" step="any" class="form-control" id="latitude" value="${a.latitude}" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyLaporanEditValue('latitude')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback">Latitude harus angka antara -90 sampai 90.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="longitude" class="form-label">
                            <i class="bi bi-geo-alt-fill me-1"></i>Longitude *
                        </label>
                        <div class="input-group">
                            <input type="number" step="any" class="form-control" id="longitude" value="${a.longitude}" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyLaporanEditValue('longitude')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <div class="valid-feedback">Valid.</div>
                            <div class="invalid-feedback">Longitude harus angka antara -180 sampai 180.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Lokasi Cepat -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-lightning-charge me-1"></i>Lokasi Cepat
                    </label>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setLaporanEditLocation(-10.1711872, 123.6149376, 'Lokasi Tetap')">
                            <i class="bi bi-house me-1"></i> Lokasi Tetap
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="setLaporanEditLocation(-10.1935921, 123.6149376, 'Kota Kupang')">
                            <i class="bi bi-geo-alt me-1"></i> Kota Kupang
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setLaporanEditLocation(${a.latitude||-10.1711872}, ${a.longitude||123.6149376}, 'Lokasi Asli')">
                            <i class="bi bi-arrow-return-left me-1"></i> Lokasi Asli
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="deskripsi" class="form-label">Deskripsi Masalah *</label>
                    <textarea class="form-control" id="deskripsi" required rows="4">${a.deskripsi}</textarea>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Deskripsi masalah wajib diisi.</div>
                </div>
                
                <div class="mb-3">
                    <label for="status" class="form-label">Status Laporan *</label>
                    <select class="form-select" id="status" required>
                        <option value="" disabled>Pilih status...</option>
                        <option value="pending" ${a.status==="pending"?"selected":""}>â³ Pending</option>
                        <option value="proses" ${a.status==="proses"?"selected":""}>ðŸ”„ Proses</option>
                        <option value="selesai" ${a.status==="selesai"?"selected":""}>âœ… Selesai</option>
                    </select>
                    <div class="valid-feedback">Valid.</div>
                    <div class="invalid-feedback">Status laporan wajib dipilih.</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Foto Bukti Saat Ini:</label>
                    ${a.foto_bukti_url?`<div class="mt-2">
                            <img src="${a.foto_bukti_url}" 
                                 alt="Foto Saat Ini"
                                 class="img-thumbnail" style="max-width: 200px;"><br>
                            <a href="${a.foto_bukti_url}" target="_blank" 
                               class="text-decoration-none">
                                <i class="bi bi-link-45deg"></i> Buka di tab baru
                            </a>
                        </div>`:'<p class="text-muted">Tidak ada foto bukti</p>'}
                </div>
                
                <div class="mb-3">
                    <label for="foto_bukti" class="form-label">Ganti Foto (Opsional):</label>
                    <input type="file" class="form-control" id="foto_bukti" accept="image/*">
                    <div class="form-text">Biarkan kosong jika tidak ingin mengganti foto. Maksimal 5MB. Format: JPG, PNG, GIF.</div>
                    
                    <div id="previewContainer" class="mt-2 d-none">
                        <p class="mb-1">Preview:</p>
                        <img id="fotoPreview" class="img-thumbnail" style="max-width: 200px;">
                    </div>
                </div>
            </form>
        `;P("Edit Laporan Sampah",t,async()=>{const i=document.getElementById("editLaporanForm");if(i.classList.add("was-validated"),!i.checkValidity())return q("Harap isi semua field yang wajib diisi dengan benar","error"),!1;const s=parseFloat(document.getElementById("latitude").value),n=parseFloat(document.getElementById("longitude").value);if(isNaN(s)||s<-90||s>90)return document.getElementById("latitude").classList.add("is-invalid"),document.getElementById("latitude").classList.remove("is-valid"),q("Latitude harus angka antara -90 sampai 90","error"),!1;if(document.getElementById("latitude").classList.add("is-valid"),document.getElementById("latitude").classList.remove("is-invalid"),isNaN(n)||n<-180||n>180)return document.getElementById("longitude").classList.add("is-invalid"),document.getElementById("longitude").classList.remove("is-valid"),q("Longitude harus angka antara -180 sampai 180","error"),!1;document.getElementById("longitude").classList.add("is-valid"),document.getElementById("longitude").classList.remove("is-invalid");const o=document.getElementById("foto_bukti");if(o.files.length>0){const r=o.files[0],c=5*1024*1024;if(!["image/jpeg","image/jpg","image/png","image/gif"].includes(r.type))return o.classList.add("is-invalid"),o.classList.remove("is-valid"),q("File harus berupa gambar (JPG, PNG, GIF)","error"),!1;if(r.size>c)return o.classList.add("is-invalid"),o.classList.remove("is-valid"),q("Ukuran file maksimal 5MB","error"),!1;o.classList.add("is-valid"),o.classList.remove("is-invalid")}const l=new FormData;l.append("nama",document.getElementById("nama").value.trim()),l.append("alamat",document.getElementById("alamat").value.trim()),l.append("latitude",s),l.append("longitude",n),l.append("deskripsi",document.getElementById("deskripsi").value.trim()),l.append("status",document.getElementById("status").value),l.append("tanggal_lapor",a.tanggal_lapor),l.append("idUser",a.idUser),o.files.length>0&&l.append("foto_bukti",o.files[0]);try{const r=localStorage.getItem("access"),c={};r&&(c.Authorization=`Bearer ${r}`);const d=document.querySelector(".modal-footer .btn-primary"),m=d.innerHTML;d.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',d.disabled=!0;const u=await fetch(`${b.laporanSampah}${e}/`,{method:"PATCH",headers:c,body:l});if(!u.ok){const g=await u.text();throw new Error(g||`HTTP ${u.status}`)}return q("Laporan berhasil diperbarui!","success"),he(),!0}catch(r){return console.error("Error updating laporan:",r),q("Gagal memperbarui laporan: "+r.message,"error"),!1}}),setTimeout(()=>{kr(a);const i=document.getElementById("btnGetGPSLocation"),s=document.getElementById("btnResetMapLocation");i&&(i.onclick=()=>wr(a)),s&&(s.onclick=()=>xr(a)),document.querySelectorAll("#editLaporanForm input, #editLaporanForm textarea, #editLaporanForm select").forEach(m=>{m.addEventListener("input",function(){this.checkValidity()?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))}),m.addEventListener("change",function(){this.checkValidity()?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))})});const o=document.getElementById("latitude"),l=document.getElementById("longitude");o&&o.addEventListener("input",function(){const m=parseFloat(this.value);!isNaN(m)&&m>=-90&&m<=90?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))}),l&&l.addEventListener("input",function(){const m=parseFloat(this.value);!isNaN(m)&&m>=-180&&m<=180?(this.classList.remove("is-invalid"),this.classList.add("is-valid")):(this.classList.remove("is-valid"),this.classList.add("is-invalid"))});const r=document.getElementById("foto_bukti"),c=document.getElementById("previewContainer"),d=document.getElementById("fotoPreview");r&&r.addEventListener("change",function(){if(this.files&&this.files[0]){const m=this.files[0],u=["image/jpeg","image/jpg","image/png","image/gif"],g=5*1024*1024;if(!u.includes(m.type)){this.classList.remove("is-valid"),this.classList.add("is-invalid");return}if(m.size>g){this.classList.remove("is-valid"),this.classList.add("is-invalid");return}this.classList.remove("is-invalid"),this.classList.add("is-valid");const p=new FileReader;p.onload=function(h){d.src=h.target.result,c.classList.remove("d-none"),c.classList.add("d-block")},p.readAsDataURL(m)}else c.classList.remove("d-block"),c.classList.add("d-none")})},100)}catch(a){alert("Error loading laporan data: "+a.message)}}function kr(e){const a=document.getElementById("mapEditLaporan");if(!a)return;const t=parseFloat(e.latitude)||-10.1711872,i=parseFloat(e.longitude)||123.6149376;ba(()=>{try{J&&(J.remove(),J=null),sa=null,X=null,J=L.map("mapEditLaporan").setView([t,i],15),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19,noWrap:!0}).addTo(J),sa=L.marker([t,i],{draggable:!0}).addTo(J),sa.bindPopup(`
        <div style="font-size: 14px;">
          <strong>ðŸ“ Lokasi Laporan</strong><br>
          <small>
            Lat: ${t.toFixed(6)}<br>
            Lng: ${i.toFixed(6)}<br>
            <em>Drag untuk mengubah lokasi</em>
          </small>
        </div>
      `).openPopup(),sa.on("dragend",function(s){const n=sa.getLatLng();Ue(n.lat,n.lng),X&&J.hasLayer(X)&&(J.removeLayer(X),X=null),ke("manual")}),J.on("click",function(s){const{lat:n,lng:o}=s.latlng;Ue(n,o),sa.setLatLng([n,o]),X&&J.hasLayer(X)&&(J.removeLayer(X),X=null),ke("manual")}),Ue(t,i),setTimeout(()=>{J&&J.invalidateSize(!0)},200)}catch(s){console.error("Error setting up edit laporan map:",s),a.innerHTML=`
        <div style="
          width: 100%;
          height: 250px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: #f8f9fa;
          border: 1px solid #ddd;
          border-radius: 6px;
          color: #666;
          text-align: center;
          padding: 20px;
        ">
          <div style="font-size: 36px; margin-bottom: 10px;">âš ï¸</div>
          <p style="margin: 0;">Peta tidak dapat dimuat: ${s.message}</p>
          <button onclick="setupEditLaporanMap(${JSON.stringify(e).replace(/"/g,"&quot;")})" 
                  style="margin-top: 10px; padding: 8px 16px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Coba Lagi
          </button>
        </div>
      `}})}function wr(e){const a=document.getElementById("btnGetGPSLocation");if(!a)return;if(a.disabled=!0,a.innerHTML='<i class="bi bi-hourglass-split me-1"></i> Mendapatkan lokasi...',ke("loading"),!navigator.geolocation){ke("error"),q("Browser tidak mendukung Geolocation","error"),a.disabled=!1,a.innerHTML='<i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS';return}const t={enableHighAccuracy:!0,timeout:15e3,maximumAge:0};navigator.geolocation.getCurrentPosition(function(i){const s=i.coords.latitude,n=i.coords.longitude,o=i.coords.accuracy;if(console.log("GPS Location Retrieved:",{latitude:s,longitude:n,accuracy:o}),Ue(s,n),J){J.setView([s,n],17),X&&J.hasLayer(X)&&J.removeLayer(X),X=L.marker([s,n],{icon:L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),title:"LOKASI GPS ANDA",draggable:!1,zIndexOffset:1e3}).addTo(J);const r=o<100?`Akurasi: Â±${Math.round(o)} meter (Tinggi)`:o<500?`Akurasi: Â±${Math.round(o)} meter (Sedang)`:`Akurasi: Â±${Math.round(o)} meter (Rendah)`;X.bindPopup(`
          <div style="max-width: 250px;">
            <strong style="color: #28a745;">ðŸ“ LOKASI GPS ANDA</strong><br>
            <small>
              <b>Lat:</b> ${s.toFixed(6)}<br>
              <b>Lng:</b> ${n.toFixed(6)}<br>
              <b>${r}</b><br>
              <i>Lokasi GPS asli Anda</i>
            </small>
          </div>
        `).openPopup(),o>50&&L.circle([s,n],{radius:o,color:"#28a745",fillColor:"#28a745",fillOpacity:.1,weight:1}).addTo(J).bindPopup(`Rentang akurasi: Â±${Math.round(o)} meter`),sa&&(sa.setLatLng([s,n]),sa.setOpacity(.5)),setTimeout(()=>{J.invalidateSize()},100)}const l=o<100?`Lokasi GPS ditemukan! (Akurasi tinggi: Â±${Math.round(o)}m)`:o<500?`Lokasi GPS ditemukan! (Akurasi sedang: Â±${Math.round(o)}m)`:`Lokasi GPS ditemukan! (Akurasi rendah: Â±${Math.round(o)}m)`;ke("success",l),a.disabled=!1,a.innerHTML='<i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS',q(l,"success")},function(i){console.error("Geolocation Error:",i);let s="Gagal mendapatkan lokasi GPS";switch(i.code){case i.PERMISSION_DENIED:s="Akses GPS ditolak. Harap izinkan akses lokasi di browser Anda.";break;case i.POSITION_UNAVAILABLE:s="Informasi lokasi tidak tersedia. Pastikan GPS aktif.";break;case i.TIMEOUT:s="Waktu permintaan lokasi habis. Coba lagi.";break;default:s="Terjadi kesalahan saat mengambil lokasi."}ke("error",s),a.disabled=!1,a.innerHTML='<i class="bi bi-crosshair me-1"></i> Dapatkan Lokasi GPS',q(s,"error");const n=parseFloat(e.latitude)||-10.1711872,o=parseFloat(e.longitude)||123.6149376;Ue(n,o),J&&(J.setView([n,o],15),sa&&sa.setLatLng([n,o])),q("Menggunakan lokasi laporan sebagai alternatif","warning")},t)}function xr(e){if(J){const a=parseFloat(e.latitude)||-10.1711872,t=parseFloat(e.longitude)||123.6149376;J.setView([a,t],15),X&&J.hasLayer(X)&&(J.removeLayer(X),X=null),sa&&(sa.setLatLng([a,t]),sa.setOpacity(1),sa.bindPopup(`
        <div style="max-width: 200px;">
          <strong>ðŸ“ Lokasi Laporan</strong><br>
          <small>
            Lat: ${a.toFixed(6)}<br>
            Lng: ${t.toFixed(6)}
          </small>
        </div>
      `).openPopup()),Ue(a,t),ke("manual"),setTimeout(()=>{J.invalidateSize()},200)}}function Ue(e,a){const t=document.getElementById("latitude"),i=document.getElementById("longitude");t&&i&&(t.value=e,i.value=a)}function ke(e,a=""){const t=document.getElementById("gpsLoading"),i=document.getElementById("gpsSuccess"),s=document.getElementById("gpsError");if(!(!t||!i||!s))switch(t.style.display="none",i.style.display="none",s.style.display="none",e){case"loading":t.style.display="block";break;case"success":i.innerHTML=`
        <i class="bi bi-check-circle me-1"></i> ${a||"Lokasi GPS ditemukan!"}
      `,i.style.display="block";break;case"error":s.innerHTML=`
        <i class="bi bi-exclamation-circle me-1"></i> ${a||"Gagal mendapatkan lokasi GPS"}
      `,s.style.display="block";break;case"manual":i.innerHTML=`
        <i class="bi bi-geo-alt-fill me-1"></i> Lokasi dipilih manual di peta
      `,i.style.display="block";break}}window.setLaporanEditLocation=function(e,a,t){Ue(e,a),J&&(J.setView([e,a],17),X&&J.hasLayer(X)&&(J.removeLayer(X),X=null),sa&&(sa.setLatLng([e,a]),sa.setOpacity(1),sa.bindPopup(`
        <div style="max-width: 200px;">
          <strong>ðŸ“ ${t}</strong><br>
          <small>
            Lat: ${e.toFixed(6)}<br>
            Lng: ${a.toFixed(6)}
          </small>
        </div>
      `).openPopup()),ke("manual"),setTimeout(()=>{J.invalidateSize()},100))};window.copyLaporanEditValue=function(e){const a=document.getElementById(e);if(a){a.select(),document.execCommand("copy");const t=a.value;a.value="âœ“ Disalin!",setTimeout(()=>{a.value=t},1e3)}};async function Lr(e){pe("Apakah Anda yakin ingin menghapus laporan ini?",async()=>{try{const a=await fetch(`${b.laporanSampah}${e}/`,{method:"DELETE",headers:v()});if(!a.ok){const t=await a.text();throw new Error(t||`HTTP ${a.status}`)}q("Laporan berhasil dihapus!","success"),he()}catch(a){alert("Error deleting laporan: "+a.message)}})}window.goToLaporanPage=fr;window.viewDetailLaporan=hr;window.editLaporan=yr;window.deleteLaporan=Lr;window.showAddLaporanForm=pn;let Qe=[],xa=1,Ka=10,$t=new Map,Qa=[];function $r(e,a="info"){typeof x=="function"?x(e,a,5e3):alert(`${a.toUpperCase()}: ${e}`)}async function Er(){window.changeDetailPage=si,window.changeDetailPerPage=ni,window.setupJadwalGridListeners=Ln,window.removeSelectedJadwal=xn,window.editDetailJadwal=vn,window.viewDetailJadwal=$n,window.deleteDetailJadwal=En;const e=document.getElementById("mainContent");e.innerHTML=`
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Detail Jadwal Anggota</h2>
                <button id="addDetailBtn" style="padding: 8px 16px; background: #28a745; color: white;">+ Tambah Detail</button>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="searchDetail" placeholder="Cari anggota/jadwal..." style="padding: 8px; width: 250px;">
                <select id="filterStatus" style="padding: 8px;">
                    <option value="">Semua Status</option>
                    <option value="terjadwal">Terjadwal</option>
                    <option value="dalam_proses">Dalam Proses</option>
                    <option value="selesai">Selesai</option>
                    <option value="dibatalkan">Dibatalkan</option>
                </select>
                <select id="filterAnggota" style="padding: 8px; width: 200px;">
                    <option value="">Semua Anggota</option>
                </select>
                <select id="filterJadwal" style="padding: 8px; width: 200px;">
                    <option value="">Semua Jadwal</option>
                </select>
            </div>
            
            <div id="detailTableContainer">
                <p>Loading data...</p>
            </div>
        </div>
    `,document.getElementById("addDetailBtn").onclick=()=>Br(),document.getElementById("searchDetail").oninput=Le,document.getElementById("filterStatus").onchange=Le,Tr(),Le()}async function Tr(){try{const e=await M(b.anggota,{headers:v()}),a=document.getElementById("filterAnggota");for(;a.options.length>1;)a.remove(1);e.forEach(s=>{const n=document.createElement("option");n.value=s.idAnggota,n.textContent=`${s.idAnggota} - ${s.nama}`,a.appendChild(n)});const t=await M(b.jadwal,{headers:v()}),i=document.getElementById("filterJadwal");for(;i.options.length>1;)i.remove(1);t.forEach(s=>{const n=document.createElement("option"),o=s.idJadwal,l=s.tanggalJadwal||"N/A",r=s.nama_tim||"N/A";n.value=o,n.textContent=`${o} - ${l} (${r})`,i.appendChild(n)}),document.getElementById("filterAnggota").onchange=Le,document.getElementById("filterJadwal").onchange=Le}catch(e){console.error("Error loading dropdown data:",e)}}function Sr(e){const a=document.getElementById("detailPagination");if(!a)return;if(e<=1){a.innerHTML=`
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <small class="text-muted">Menampilkan semua data (${Qe.length} detail)</small>
      </div>
    `;return}const t=(xa-1)*Ka+1,i=Math.min(xa*Ka,Qe.length);let s=Math.max(1,xa-2),n=Math.min(e,s+4);n-s<4&&(s=Math.max(1,n-4));let o=`
    <div>
      <small style="color: #666;">
        Menampilkan ${t} - ${i} dari ${Qe.length} detail
      </small>
    </div>
    
    <div style="display: flex; align-items: center; gap: 5px;">
  `;xa>1&&(o+=`
      <button data-page="${xa-1}" class="pagination-btn"
              style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">
        â†
      </button>
    `);for(let l=s;l<=n;l++)l===xa?o+=`
        <button style="padding: 5px 10px; border: 1px solid #007bff; background: #007bff; color: white; font-weight: bold; border-radius: 4px;">
          ${l}
        </button>
      `:o+=`
        <button data-page="${l}" class="pagination-btn"
                style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">
          ${l}
        </button>
      `;xa<e&&(o+=`
      <button data-page="${xa+1}" class="pagination-btn"
              style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">
        â†’
      </button>
    `),o+=`
    </div>
    
    <div style="display: flex; align-items: center; gap: 10px;">
      <small style="color: #666;">Items per page:</small>
      <select id="detailPerPageSelect" 
              style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="5" ${Ka===5?"selected":""}>5</option>
        <option value="10" ${Ka===10?"selected":""}>10</option>
        <option value="20" ${Ka===20?"selected":""}>20</option>
        <option value="50" ${Ka===50?"selected":""}>50</option>
      </select>
    </div>
  `,a.innerHTML=o,setTimeout(()=>{Ar()},50)}function Ar(){const e=document.getElementById("detailPerPageSelect");e&&(e.onchange=function(){ni(this.value)}),document.querySelectorAll("#detailPagination .pagination-btn").forEach(t=>{t.addEventListener("click",function(){const i=parseInt(this.getAttribute("data-page"));isNaN(i)||si(i)})})}function si(e){xa=e,zi();const a=document.getElementById("detailTableContainer");a&&a.scrollIntoView({behavior:"smooth",block:"start"})}function ni(e){Ka=parseInt(e),xa=1,zi()}window.changeDetailPage=si;window.changeDetailPerPage=ni;function hn(e){const a=document.getElementById(e);let t=!0;return a.querySelectorAll(".form-control, .form-select").forEach(i=>{i.classList.remove("is-invalid","is-valid");const s=i.nextElementSibling;s&&s.classList.contains("invalid-feedback")&&(s.style.display="none")}),a.querySelectorAll("[required]").forEach(i=>{if(i.tagName==="SELECT")if(i.value)i.classList.add("is-valid");else{i.classList.add("is-invalid");const s=i.nextElementSibling;s&&s.classList.contains("invalid-feedback")&&(s.style.display="block"),t=!1}else if(i.type==="hidden")if(i.value)i.classList.add("is-valid");else{i.classList.add("is-invalid");const s=i.nextElementSibling;s&&s.classList.contains("invalid-feedback")&&(s.style.display="block"),t=!1}}),t||x("Harap lengkapi semua field yang wajib diisi!","warning"),t}function Br(){Promise.all([M(b.anggota,{headers:v()}),M(b.jadwal,{headers:v()})]).then(([e,a])=>{const t=a.sort((o,l)=>{const r=new Date(o.tanggalJadwal||o.tanggal);return new Date(l.tanggalJadwal||l.tanggal)-r}),i=e.map(o=>`<option value="${o.idAnggota}">${o.idAnggota} - ${o.nama} (${(o.alamat||"").substring(0,20)}...)</option>`).join(""),s=yn(t),n=`
            <form id="detailForm" novalidate>
                <div class="mb-3">
                    <label for="idAnggota" class="form-label">Anggota *</label>
                    <select id="idAnggota" class="form-select" required>
                        <option value="">Pilih Anggota</option>
                        ${i}
                    </select>
                    <div class="invalid-feedback">Harap pilih anggota.</div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0 fw-bold">Pilih Jadwal (Maksimal 4) *</label>
                        <div class="text-muted small">
                            <span id="selectedCount">0</span>/4 jadwal terpilih
                        </div>
                    </div>
                    <div class="border rounded p-3 mb-2" style="max-height: 300px; overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;" id="jadwalGrid">
                            ${s}
                        </div>
                    </div>
                    <input type="hidden" id="selectedJadwalIds" required>
                    <div class="invalid-feedback">Harap pilih minimal 1 jadwal.</div>
                    <div id="selectedJadwalInfo" class="mt-2 p-3 bg-light rounded">
                        <strong>Jadwal terpilih:</strong> 
                        <div id="selectedJadwalList" class="mt-2 d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="status_pengangkutan" class="form-label">Status Pengangkutan *</label>
                    <select id="status_pengangkutan" class="form-select" required>
                        <option value="terjadwal">Terjadwal</option>
                        <option value="dalam_proses">Dalam Proses</option>
                        <option value="selesai">Selesai</option>
                        <option value="dibatalkan">Dibatalkan</option>
                    </select>
                    <div class="invalid-feedback">Harap pilih status pengangkutan.</div>
                </div>
                
                <div class="mb-3">
                    <label for="catatan" class="form-label">Catatan</label>
                    <textarea id="catatan" class="form-control" rows="3" placeholder="Catatan tambahan..."></textarea>
                </div>
            </form>
        `;P("Tambah Detail Jadwal Anggota",n,async()=>{if(!hn("detailForm"))return!1;const l=document.getElementById("selectedJadwalIds").value.split(",").filter(g=>g!=="");if(l.length===0){const g=document.getElementById("selectedJadwalIds");g.classList.add("is-invalid");const p=g.nextElementSibling;return p&&p.classList.contains("invalid-feedback")&&(p.style.display="block"),x("Harap pilih minimal 1 jadwal!","warning"),!1}if(l.length>4)return x("Maksimal hanya bisa memilih 4 jadwal!","error"),!1;const r=parseInt(document.getElementById("idAnggota").value),c=document.getElementById("status_pengangkutan").value,d=document.getElementById("catatan").value||"";let m=0,u=0;x("Sedang menyimpan data...","info");try{const g=l.map(p=>{const h={idAnggota:r,idJadwal:parseInt(p),status_pengangkutan:c,catatan:d};return M(b.detailAnggotaJadwal,{method:"POST",headers:v(),body:JSON.stringify(h)}).then(()=>{m++}).catch(f=>{throw u++,f})});if(await Promise.allSettled(g),m>0)return x(`Berhasil menambahkan ${m} dari ${l.length} jadwal!`,"success",5e3),setTimeout(()=>{Le(),Ra()},2e3),!0;if(u>0)return x(`Gagal menambahkan ${u} jadwal`,"error"),!1}catch(g){return x(`Error: ${g.message}`,"error"),!1}return!0}),setTimeout(()=>{Mr();const o=document.getElementById("idAnggota"),l=document.getElementById("status_pengangkutan");o&&o.addEventListener("change",function(){if(this.value){this.classList.remove("is-invalid"),this.classList.add("is-valid");const r=this.nextElementSibling;r&&r.classList.contains("invalid-feedback")&&(r.style.display="none")}}),l&&l.addEventListener("change",function(){if(this.value){this.classList.remove("is-invalid"),this.classList.add("is-valid");const r=this.nextElementSibling;r&&r.classList.contains("invalid-feedback")&&(r.style.display="none")}})},100)}).catch(e=>{x("Error loading data: "+e.message,"error")})}async function vn(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()}),[t,i]=await Promise.all([M(b.anggota,{headers:v()}),M(b.jadwal,{headers:v()})]),s=i.sort((d,m)=>{const u=new Date(d.tanggalJadwal||d.tanggal);return new Date(m.tanggalJadwal||m.tanggal)-u}),n=t.map(d=>`<option value="${d.idAnggota}" ${d.idAnggota==a.idAnggota?"selected":""}>
                ${d.idAnggota} - ${d.nama}
            </option>`).join(""),o=s.find(d=>d.idJadwal==a.idJadwal),l=o?`${Bi(o.tanggalJadwal)} - ${o.nama_tim}`:"Belum dipilih",r={idAnggota:a.idAnggota,idJadwal:a.idJadwal,status_pengangkutan:a.status_pengangkutan,catatan:a.catatan||""},c=`
            <form id="editDetailForm" novalidate>
                <div class="mb-3">
                    <label for="idAnggota" class="form-label">Anggota *</label>
                    <select id="idAnggota" class="form-select" required>
                        <option value="">Pilih Anggota</option>
                        ${n}
                    </select>
                    <div class="invalid-feedback">Harap pilih anggota.</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label mb-2 fw-bold">Pilih Jadwal *</label>
                    <div class="border rounded p-3 mb-2" style="max-height: 300px; overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;" id="jadwalGridEdit">
                            ${Pr(s,a.idJadwal)}
                        </div>
                    </div>
                    <input type="hidden" id="idJadwal" required value="${a.idJadwal||""}">
                    <div class="invalid-feedback">Harap pilih jadwal.</div>
                    <div id="selectedJadwalInfo" class="mt-2 p-3 bg-light rounded ${a.idJadwal?"":"d-none"}">
                        <strong>Jadwal terpilih:</strong> <span id="selectedJadwalText">${l}</span>
                        ${o?`<br><small class="text-muted">Tanggal: ${Bi(o.tanggalJadwal)} | Tim: ${o.nama_tim}</small>`:""}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="status_pengangkutan" class="form-label">Status Pengangkutan *</label>
                    <select id="status_pengangkutan" class="form-select" required>
                        <option value="terjadwal" ${a.status_pengangkutan==="terjadwal"?"selected":""}>Terjadwal</option>
                        <option value="dalam_proses" ${a.status_pengangkutan==="dalam_proses"?"selected":""}>Dalam Proses</option>
                        <option value="selesai" ${a.status_pengangkutan==="selesai"?"selected":""}>Selesai</option>
                        <option value="dibatalkan" ${a.status_pengangkutan==="dibatalkan"?"selected":""}>Dibatalkan</option>
                    </select>
                    <div class="invalid-feedback">Harap pilih status pengangkutan.</div>
                </div>
                
                <div class="mb-3">
                    <label for="catatan" class="form-label">Catatan</label>
                    <textarea id="catatan" class="form-control" rows="3" placeholder="Catatan tambahan...">${a.catatan||""}</textarea>
                </div>
            </form>
        `;P("Edit Detail Jadwal Anggota",c,async()=>{if(!hn("editDetailForm"))return!1;const d=document.getElementById("idAnggota").value,m=document.getElementById("idJadwal").value,u=document.getElementById("status_pengangkutan").value,g=document.getElementById("catatan").value||"";if(!(parseInt(d)!==parseInt(r.idAnggota)||parseInt(m)!==parseInt(r.idJadwal)||u!==r.status_pengangkutan||g!==r.catatan))return $r("Tidak ada perubahan data yang dilakukan.","info"),!1;const h={idAnggota:parseInt(d),idJadwal:parseInt(m),status_pengangkutan:u,catatan:g};try{const f=document.querySelector(".modal-footer .btn-primary"),k=f.innerHTML;return f.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',f.disabled=!0,await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify(h)}),x("Detail jadwal berhasil diupdate!","success",5e3),setTimeout(()=>{Le(),Ra()},1500),!0}catch(f){const k=document.querySelector(".modal-footer .btn-primary");return k&&(k.innerHTML=originalText,k.disabled=!1),f.message&&f.message.includes("sudah ada")||f.message&&f.message.includes("already exists")?x("Kombinasi anggota dan jadwal ini sudah ada dalam sistem!","error"):x("error","Error: "+f.message),!1}}),setTimeout(()=>{Cr(a.idJadwal);const d=document.getElementById("idAnggota"),m=document.getElementById("status_pengangkutan");d&&(d.value&&d.classList.add("is-valid"),d.addEventListener("change",function(){if(this.value){this.classList.remove("is-invalid"),this.classList.add("is-valid");const p=this.nextElementSibling;p&&p.classList.contains("invalid-feedback")&&(p.style.display="none")}else{this.classList.remove("is-valid"),this.classList.add("is-invalid");const p=this.nextElementSibling;p&&p.classList.contains("invalid-feedback")&&(p.style.display="block")}})),m&&(m.classList.add("is-valid"),m.addEventListener("change",function(){this.classList.remove("is-invalid","is-valid"),this.classList.add("is-valid");const p=this.nextElementSibling;p&&p.classList.contains("invalid-feedback")&&(p.style.display="none")}));const u=document.getElementById("idJadwal");u&&u.value&&u.classList.add("is-valid");const g=document.getElementById("catatan");g&&g.addEventListener("input",function(){})},100)}catch(a){x("error","Error loading data: "+a.message)}}async function Le(){var s,n,o,l;const e=((s=document.getElementById("searchDetail"))==null?void 0:s.value)||"",a=((n=document.getElementById("filterStatus"))==null?void 0:n.value)||"",t=((o=document.getElementById("filterAnggota"))==null?void 0:o.value)||"",i=((l=document.getElementById("filterJadwal"))==null?void 0:l.value)||"";try{Qe=(await M(b.detailAnggotaJadwal,{headers:v()})).sort((d,m)=>{let u=new Date(d.tanggal_jadwal||d.created_at||0),g=new Date(m.tanggal_jadwal||m.created_at||0);return d.jadwal&&d.jadwal.tanggalJadwal&&(u=new Date(d.jadwal.tanggalJadwal)),m.jadwal&&m.jadwal.tanggalJadwal&&(g=new Date(m.jadwal.tanggalJadwal)),g-u}).filter(d=>{const m=d.nama_anggota||"",u=d.tanggal_jadwal||"",g=d.nama_tim||"",p=d.status_pengangkutan||"",h=!e||m.toLowerCase().includes(e.toLowerCase())||u.includes(e)||g.toLowerCase().includes(e.toLowerCase())||p.toLowerCase().includes(e.toLowerCase()),f=!a||p===a,k=!t||d.idAnggota==t,w=!i||d.idJadwal==i;return h&&f&&k&&w}),xa=1,zi()}catch(r){document.getElementById("detailTableContainer").innerHTML=`<div class="alert alert-danger">Error loading data: ${r.message}</div>`}}function yn(e){const a={};e.forEach(s=>{const n=s.idJadwal||s.id,o=s.tanggalJadwal||s.tanggal,l=s.nama_tim||"Tim";if(o){const r=new Date(o),c=r.toLocaleDateString("id-ID",{month:"long",year:"numeric"});a[c]||(a[c]=[]),a[c].push({id:n,tanggal:o,namaTim:l,dateObj:r,formattedDate:r.toLocaleDateString("id-ID",{weekday:"short",day:"numeric",month:"short"})})}});let t="";return Object.keys(a).sort((s,n)=>{const o=new Date(s.split(" ")[1]+"-"+vs(s.split(" ")[0]));return new Date(n.split(" ")[1]+"-"+vs(n.split(" ")[0]))-o}).forEach(s=>{const n=a[s];n.sort((o,l)=>l.dateObj-o.dateObj),t+=`
            <div style="grid-column: 1 / -1; margin-bottom: 10px;">
                <h4 class="h6 mb-2 pb-1 border-bottom" style="border-bottom: 2px solid #007bff !important;">
                    ${s}
                </h4>
            </div>
        `,n.forEach(o=>{t+=`
                <div class="jadwal-card border rounded p-2 text-center" 
                     data-jadwal-id="${o.id}" 
                     style="cursor: pointer; transition: all 0.2s; background: white; position: relative;">
                    <div class="fw-bold text-primary mb-1">
                        ${o.formattedDate}
                    </div>
                    <div class="small text-muted">
                        ${o.namaTim}
                    </div>
                    <div class="checkmark position-absolute" 
                         style="top: 5px; right: 5px; width: 20px; height: 20px; border-radius: 50%; 
                                background: #28a745; color: white; font-size: 12px;
                                display: none; align-items: center; justify-content: center;">
                        âœ“
                    </div>
                </div>
            `})}),t}function vs(e){return{Januari:"01",Februari:"02",Maret:"03",April:"04",Mei:"05",Juni:"06",Juli:"07",Agustus:"08",September:"09",Oktober:"10",November:"11",Desember:"12"}[e]||"01"}function Mr(){const e=document.querySelectorAll(".jadwal-card");e.length!==0&&(Qa.length=0,$t.clear(),e.forEach(a=>{const t=function(){const i=this.getAttribute("data-jadwal-id"),s=this.querySelector("div:first-child").textContent,n=this.querySelector("div:nth-child(2)").textContent,o=this.querySelector(".checkmark");if(Qa.includes(i)){const l=Qa.indexOf(i);Qa.splice(l,1),$t.delete(i),this.classList.remove("border-primary","bg-light"),o.style.display="none"}else{if(Qa.length>=4){x("Maksimal hanya bisa memilih 4 jadwal!","warning");return}Qa.push(i),$t.set(i,{tanggal:s,namaTim:n,id:i}),this.classList.add("border-primary","bg-light"),o.style.display="flex";const l=document.getElementById("selectedJadwalIds");if(l){l.classList.remove("is-invalid"),l.classList.add("is-valid");const r=l.nextElementSibling;r&&r.classList.contains("invalid-feedback")&&(r.style.display="none")}}kn(Qa,$t)};a._clickHandler=t,a.addEventListener("click",t),a.addEventListener("mouseenter",function(){const i=this.getAttribute("data-jadwal-id");Qa.includes(i)||this.classList.add("border-info","shadow-sm")}),a.addEventListener("mouseleave",function(){const i=this.getAttribute("data-jadwal-id");Qa.includes(i)||this.classList.remove("border-info","shadow-sm")})}))}function kn(e,a){try{const t=document.getElementById("selectedCount");t&&(t.textContent=e.length);const i=document.getElementById("selectedJadwalIds");if(i)if(i.value=e.join(","),e.length>0){i.classList.remove("is-invalid"),i.classList.add("is-valid");const o=i.nextElementSibling;o&&o.classList.contains("invalid-feedback")&&(o.style.display="none")}else{i.classList.remove("is-valid"),i.classList.add("is-invalid");const o=i.nextElementSibling;o&&o.classList.contains("invalid-feedback")&&(o.style.display="block")}const s=document.getElementById("selectedJadwalList");if(!s)return;if(e.length===0){s.innerHTML='<span class="text-muted fst-italic">Belum ada jadwal yang dipilih</span>';return}let n="";e.forEach(o=>{const l=a.get(o);l&&(n+=`
                <span class="badge bg-primary d-inline-flex align-items-center gap-1">
                    ${l.tanggal}
                    <button type="button" onclick="removeSelectedJadwal('${o}')" 
                            class="btn-close btn-close-white" 
                            style="padding: 0; font-size: 8px;"></button>
                </span>
            `)}),s.innerHTML=n}catch(t){console.error("Error updating selected jadwal info:",t)}}function zi(){const e=document.getElementById("detailTableContainer");if(!e)return;const a=Qe.length,t=Math.ceil(a/Ka);t===0?xa=1:xa>t&&(xa=t);const i=(xa-1)*Ka,s=i+Ka,n=Qe.slice(i,s);if(!n||n.length===0){e.innerHTML=`
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Tidak ada data detail jadwal anggota
      </div>
    `;return}const o=`
    <div class="table-responsive">
      <table class="table table-hover table-striped">
        <thead class="table-light">
          <tr>
            <th style="width: 50px;">No</th>
            <th>Anggota</th>
            <th>Jadwal</th>
            <th>Status</th>
            <th>Catatan</th>
            <th>Dibuat</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          ${n.map((l,r)=>{const c=i+r+1,d=l.idDetailAnggotaJadwal||l.id,m=l.nama_anggota||`Anggota ID: ${l.idAnggota}`,u=l.tanggal_jadwal||`Jadwal ID: ${l.idJadwal}`,g=l.nama_tim||"N/A",p=l.catatan||"",h=p?p.substring(0,50)+(p.length>50?"...":""):"-",f=l.created_at?new Date(l.created_at).toLocaleDateString("id-ID"):"-";return`
                <tr>
                  <td class="text-center fw-semibold">${c}</td>
                  <td>
                    <div class="fw-medium">${m}</div>
                    <small class="text-muted">ID: ${l.idAnggota}</small>
                  </td>
                  <td>
                    <div class="fw-semibold">${Bi(u)}</div>
                    <small class="text-muted">Tim: ${g}</small>
                  </td>
                  <td>
                    ${wn(l.status_pengangkutan)}
                  </td>
                  <td style="max-width: 200px;">
                    <div class="text-truncate" title="${p}">${h}</div>
                  </td>
                  <td>
                    <small class="text-muted">${f}</small>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button onclick="viewDetailJadwal(${d})" class="btn btn-info" title="Detail">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button onclick="editDetailJadwal(${d})" class="btn btn-warning" title="Edit">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button onclick="deleteDetailJadwal(${d})" class="btn btn-danger" title="Hapus">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `}).join("")}
        </tbody>
      </table>
    </div>
    <div id="detailPagination" class="mt-3 pt-3 border-top"></div>
  `;e.innerHTML=o,Sr(t)}function wn(e){const t={terjadwal:{class:"bg-info",label:"Terjadwal"},dalam_proses:{class:"bg-warning",label:"Dalam Proses"},selesai:{class:"bg-success",label:"Selesai"},dibatalkan:{class:"bg-danger",label:"Dibatalkan"}}[e]||{class:"bg-secondary",label:e};return`<span class="badge ${t.class}">${t.label}</span>`}function xn(e){try{const a=document.querySelector(`.jadwal-card[data-jadwal-id="${e}"]`);if(a){const t=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});a.dispatchEvent(t)}}catch(a){console.error("Error removing selected jadwal:",a)}}function Ir(e){const a={};e.forEach(s=>{const n=s.idJadwal||s.id,o=s.tanggalJadwal||s.tanggal,l=s.nama_tim||"Tim";if(o){const r=new Date(o),c=r.toLocaleDateString("id-ID",{month:"long",year:"numeric"});a[c]||(a[c]=[]),a[c].push({id:n,tanggal:o,namaTim:l,dateObj:r,formattedDate:r.toLocaleDateString("id-ID",{weekday:"short",day:"numeric",month:"short"})})}});let t="";return Object.keys(a).sort((s,n)=>new Date(s)-new Date(n)).forEach(s=>{const n=a[s];n.sort((o,l)=>o.dateObj-l.dateObj),t+=`
            <div style="grid-column: 1 / -1; margin-bottom: 10px;">
                <h4 style="margin: 0; padding-bottom: 5px; border-bottom: 2px solid #007bff; color: #333;">
                    ${s}
                </h4>
            </div>
        `,n.forEach(o=>{t+=`
                <div class="jadwal-card" data-jadwal-id="${o.id}" 
                     style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; 
                            cursor: pointer; transition: all 0.2s; text-align: center;
                            background: white;">
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 5px;">
                        ${o.formattedDate}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${o.namaTim}
                    </div>
                </div>
            `})}),t}function Ln(){const e=document.querySelectorAll(".jadwal-card");let a=null;e.forEach(t=>{t.addEventListener("click",function(){const i=this.getAttribute("data-jadwal-id"),s=this.querySelector("div:first-child").textContent,n=this.querySelector("div:last-child").textContent;a&&(a.style.background="white",a.style.borderColor="#ddd",a.style.boxShadow="none"),this.style.background="#e3f2fd",this.style.borderColor="#007bff",this.style.boxShadow="0 0 0 2px rgba(0, 123, 255, 0.25)",a=this,document.getElementById("idJadwal").value=i,document.getElementById("selectedJadwalText").textContent=`${s} - ${n}`,document.getElementById("selectedJadwalInfo").style.display="block"}),t.addEventListener("mouseenter",function(){this!==a&&(this.style.background="#f8f9fa",this.style.transform="translateY(-2px)",this.style.boxShadow="0 4px 6px rgba(0,0,0,0.1)")}),t.addEventListener("mouseleave",function(){this!==a&&(this.style.background="white",this.style.transform="translateY(0)",this.style.boxShadow="none")})})}function Pr(e,a){const t={};e.forEach(n=>{const o=n.idJadwal||n.id,l=n.tanggalJadwal||n.tanggal,r=n.nama_tim||"Tim",c=o==a;if(l){const d=new Date(l),m=d.toLocaleDateString("id-ID",{month:"long",year:"numeric"});t[m]||(t[m]=[]),t[m].push({id:o,tanggal:l,namaTim:r,dateObj:d,formattedDate:d.toLocaleDateString("id-ID",{weekday:"short",day:"numeric",month:"short"}),isSelected:c})}});let i="";return Object.keys(t).sort((n,o)=>new Date(n)-new Date(o)).forEach(n=>{const o=t[n];o.sort((l,r)=>l.dateObj-r.dateObj),i+=`
            <div style="grid-column: 1 / -1; margin-bottom: 10px;">
                <h4 style="margin: 0; padding-bottom: 5px; border-bottom: 2px solid #007bff; color: #333;">
                    ${n}
                </h4>
            </div>
        `,o.forEach(l=>{const r=l.isSelected?"background: #e3f2fd; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);":"background: white;",c=l.isSelected?"display: flex;":"display: none;";i+=`
                <div class="jadwal-card-edit" data-jadwal-id="${l.id}" 
                     style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; 
                            cursor: pointer; transition: all 0.2s; text-align: center;
                            ${r} position: relative;">
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 5px;">
                        ${l.formattedDate}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${l.namaTim}
                    </div>
                    <div class="checkmark-edit" style="position: absolute; top: 5px; right: 5px; 
                          width: 20px; height: 20px; border-radius: 50%; 
                          background: #28a745; color: white; font-size: 12px;
                          ${c} align-items: center; justify-content: center;">
                        âœ“
                    </div>
                </div>
            `})}),i}function Cr(e){const a=document.querySelectorAll(".jadwal-card-edit");let t=null;e&&(t=document.querySelector(`.jadwal-card-edit[data-jadwal-id="${e}"]`)),a.forEach(i=>{i.removeEventListener("click",s),i.addEventListener("click",s);function s(){const n=this.getAttribute("data-jadwal-id"),o=this.querySelector("div:first-child").textContent,l=this.querySelector("div:nth-child(2)").textContent,r=this.querySelector(".checkmark-edit");a.forEach(m=>{m.style.background="white",m.style.borderColor="#ddd",m.style.boxShadow="none";const u=m.querySelector(".checkmark-edit");u&&(u.style.display="none")}),this.style.background="#e3f2fd",this.style.borderColor="#007bff",this.style.boxShadow="0 0 0 2px rgba(0, 123, 255, 0.25)",r&&(r.style.display="flex"),t=this,document.getElementById("idJadwal").value=n;const c=document.getElementById("selectedJadwalText");c&&(c.textContent=`${o} - ${l}`);const d=document.getElementById("selectedJadwalInfo");d&&(d.style.display="block")}i.addEventListener("mouseenter",function(){this!==t&&(this.style.background="#f8f9fa",this.style.transform="translateY(-2px)",this.style.boxShadow="0 4px 6px rgba(0,0,0,0.1)")}),i.addEventListener("mouseleave",function(){this!==t&&(this.style.background=this.getAttribute("data-jadwal-id")==e?"#e3f2fd":"white",this.style.transform="translateY(0)",this.style.boxShadow=this.getAttribute("data-jadwal-id")==e?"0 0 0 2px rgba(0, 123, 255, 0.25)":"none")})})}function Bi(e){if(!e)return"Tidak ada tanggal";try{return new Date(e).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}catch{return e}}async function $n(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()});console.log("Detail untuk view:",a);let t=null,i=null;if(a.idAnggota)try{t=await M(`${b.anggota}${a.idAnggota}/`,{headers:v()})}catch(n){console.warn("Tidak bisa fetch detail anggota:",n)}if(a.idJadwal)try{i=await M(`${b.jadwal}${a.idJadwal}/`,{headers:v()})}catch(n){console.warn("Tidak bisa fetch detail jadwal:",n)}const s=`
            <div>
                <h3>Detail Jadwal Anggota</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #555;">ID:</div>
                        <div>${a.id||"N/A"}</div>
                        
                        <div style="font-weight: 600; color: #555;">Anggota:</div>
                        <div>
                            <strong>${a.nama_anggota||(t==null?void 0:t.nama)||"N/A"}</strong><br>
                            <small>${(t==null?void 0:t.alamat)||""}</small><br>
                            <small>Telp: ${(t==null?void 0:t.noWA)||""}</small><br>
                            <small style="color: #666;">ID: ${a.idAnggota||"N/A"}</small>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Jadwal:</div>
                        <div>
                            <strong>Tanggal: ${a.tanggal_jadwal||(i==null?void 0:i.tanggalJadwal)||"N/A"}</strong><br>
                            <small>Tim: ${a.nama_tim||(i==null?void 0:i.nama_tim)||"N/A"}</small><br>
                            <small>ID Jadwal: ${a.idJadwal||(i==null?void 0:i.idJadwal)||"N/A"}</small>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Status:</div>
                        <div>
                            ${wn(a.status_pengangkutan)}
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Catatan:</div>
                        <div style="white-space: pre-wrap; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                            ${a.catatan||"-"}
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Dibuat:</div>
                        <div>${a.created_at?new Date(a.created_at).toLocaleString("id-ID"):"N/A"}</div>
                    </div>
                </div>
            </div>
        `;P("Detail Jadwal Anggota",s)}catch(a){alert("Error loading detail: "+a.message)}}async function En(e){pe("Apakah Anda yakin ingin menghapus detail jadwal ini?",async()=>{try{await M(`${b.detailAnggotaJadwal}${e}/`,{method:"DELETE",headers:v()}),x("Detail jadwal berhasil dihapus","success",5e3),Le()}catch(a){alert("Error deleting detail: "+a.message)}})}window.changeDetailPage=si;window.changeDetailPerPage=ni;window.setupJadwalGridListeners=Ln;window.removeSelectedJadwal=xn;window.createMultiSelectJadwalGrid=yn;window.createJadwalGrid=Ir;window.editDetailJadwal=vn;window.viewDetailJadwal=$n;window.deleteDetailJadwal=En;window.updateSelectedJadwalInfoFromGlobal=kn;async function Dr(){const e=document.getElementById("mainContent");if(!document.getElementById("modalContainer")){const a=document.createElement("div");a.id="modalContainer",document.body.appendChild(a)}if(!e){console.error("mainContent element not found");return}e.innerHTML=`
        <div class="reports-container">
            <div class="reports-header">
                <h2><i class="fas fa-chart-bar"></i> Laporan dan Statistik</h2>
                <p class="text-muted">Kelola dan lihat berbagai laporan sistem</p>
            </div>
            
            <!-- Report Selection Cards -->
            <div class="row g-4 mb-4" id="reportCardsContainer">
                <div class="col-md-4">
                    <div class="report-card" data-report-type="keuangan">
                        <div class="report-icon bg-primary">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="report-content">
                            <h5>Laporan Keuangan</h5>
                            <p>Pendapatan, transaksi, dan statistik keuangan</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="report-card" data-report-type="anggota">
                        <div class="report-icon bg-success">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="report-content">
                            <h5>Laporan Anggota</h5>
                            <p>Statistik anggota dan aktivitas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="report-card" data-report-type="laporan-sampah">
                        <div class="report-icon bg-warning">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="report-content">
                            <h5>Laporan Sampah</h5>
                            <p>Laporan dan pengaduan sampah</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="report-card" data-report-type="jadwal">
                        <div class="report-icon bg-info">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="report-content">
                            <h5>Laporan Jadwal</h5>
                            <p>Jadwal pengangkutan dan tim</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="report-card" data-report-type="dampak-lingkungan">
                        <div class="report-icon" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="report-content">
                            <h5>Dampak Lingkungan</h5>
                            <p>Analisis dampak lingkungan dari laporan sampah</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="report-card" data-report-type="user-stats">
                        <div class="report-icon bg-dark">
                            <i class="fas fa-user-chart"></i>
                        </div>
                        <div class="report-content">
                            <h5>Statistik User</h5>
                            <p>Data pengguna dan aktivitas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="report-card" data-report-type="monthly">
                        <div class="report-icon bg-purple">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="report-content">
                            <h5>Laporan Bulanan</h5>
                            <p>Ringkasan performa bulanan</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Display Area -->
            <div class="report-display-area">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 id="reportTitle" class="mb-0">Pilih Laporan</h4>
                        <div id="exportButtonsContainer" style="display: none;">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-danger" id="exportPdfBtn">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" id="exportExcelBtn">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="exportJsonBtn">
                                    <i class="fas fa-file-code"></i> JSON
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter Section -->
                        <div id="filterSection" class="mb-4" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-filter"></i> Filter Laporan</h6>
                                </div>
                                <div class="card-body">
                                    <div id="filterContent"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Report Content -->
                        <div id="reportContent">
                            <div class="text-center py-5">
                                <div class="display-1 text-muted mb-3">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <h4 class="text-muted">Pilih jenis laporan di atas</h4>
                                <p class="text-muted">Klik salah satu kartu laporan untuk melihat detail</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `,Nr(),_r()}function jr(){document.addEventListener("click",e=>{var t,i;e.target.id==="exportPdfBtn"||e.target.closest("#exportPdfBtn")?(e.preventDefault(),e.stopPropagation(),Mt("pdf")):e.target.id==="exportExcelBtn"||e.target.closest("#exportExcelBtn")?(e.preventDefault(),e.stopPropagation(),Mt("excel")):(e.target.id==="exportJsonBtn"||e.target.closest("#exportJsonBtn"))&&(e.preventDefault(),e.stopPropagation(),Mt("json"));const a=e.target.closest(".export-btn");if(a){e.preventDefault(),e.stopPropagation();const s=a.getAttribute("data-format")||"pdf",n=document.querySelector(".report-card.active");if(n){const o=n.getAttribute("data-report-type");let l={};if(o==="monthly"){const r=document.getElementById("monthSelect"),c=document.getElementById("yearSelect");r&&c&&(l={month:parseInt(r.value),year:parseInt(c.value)})}else if(o==="user-stats")l={};else{const r=(t=document.getElementById("startDate"))==null?void 0:t.value,c=(i=document.getElementById("endDate"))==null?void 0:i.value;r&&c&&(l={start_date:r,end_date:c})}console.log(`Export ${o} as ${s} with filters:`,l),Tn(o,s,l)}}})}function Nr(){const e=document.getElementById("reportCardsContainer");e&&e.addEventListener("click",a=>{const t=a.target.closest(".report-card");if(t){const i=t.getAttribute("data-report-type");i&&(document.querySelectorAll(".report-card").forEach(s=>{s.classList.remove("active")}),t.classList.add("active"),Sn(i))}}),document.addEventListener("submit",a=>{const t=a.target;if(t.id==="filterForm"){a.preventDefault();const i=document.querySelector(".report-card.active");if(i){const s=i.getAttribute("data-report-type");Jt(a,s)}}t.id==="monthlyFilterForm"&&(a.preventDefault(),Oi())}),jr()}function _r(){if(document.querySelector("#reports-css"))return;const e=`
        .reports-container {
            padding: 20px;
        }
        
        .reports-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .report-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            border: 1px solid #e9ecef;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        
        .report-card.active {
            border-color: #007bff;
            background-color: #f8f9fa;
            box-shadow: 0 5px 15px rgba(0,123,255,0.2);
        }
        
        .report-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: white;
            font-size: 24px;
        }
        
        .report-icon.bg-purple {
            background: linear-gradient(135deg, #6f42c1, #9b6bff);
        }
        
        .report-content h5 {
            font-weight: 600;
            margin-bottom: 10px;
            color: #343a40;
        }
        
        .report-content p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .report-display-area {
            margin-top: 30px;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            padding: 40px 20px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .report-card {
                padding: 20px;
            }
            
            .report-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .stat-value {
                font-size: 20px;
            }
        }
    `,a=document.createElement("style");a.id="reports-css",a.textContent=e,document.head.appendChild(a)}function at(e){return e==null||isNaN(e)?"Rp 0":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function La(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"})}catch{return e}}async function ee(e,a="POST",t=null,i=null){try{const s=v();a!=="GET"&&t&&(s["Content-Type"]="application/json");const n={method:a,headers:s,signal:i};t&&a!=="GET"&&(typeof t=="string"||t instanceof FormData?(n.body=t,t instanceof FormData&&delete s["Content-Type"]):n.body=JSON.stringify(t)),console.log(`ðŸ“¤ Fetch Report: ${a} ${e}`,{headers:s,body:t?t instanceof FormData?"[FormData]":t:void 0});const o=await fetch(e,n);if(console.log(`ðŸ“¥ Response: ${o.status} ${o.statusText}`),o.status===401)throw localStorage.removeItem("access"),localStorage.removeItem("refresh"),localStorage.removeItem("user"),x("Sesi telah berakhir. Silakan login kembali.","warning"),setTimeout(()=>{window.location.href="/login"},2e3),new Error("Sesi telah berakhir");if(o.status>=500){const r=await o.text();throw console.error("Server Error Response:",r),new Error(`Server error ${o.status}. Silakan coba lagi nanti.`)}if(!o.ok){const r=await o.text();console.error(`Client Error ${o.status}:`,r);let c;try{c=JSON.parse(r),console.error("Parsed Error:",c)}catch{c={message:`HTTP ${o.status}: ${o.statusText}`,details:r.substring(0,200)+"..."}}let d="Terjadi kesalahan pada server";if(c.detail)d=c.detail;else if(c.message)d=c.message;else if(c.non_field_errors)d=Array.isArray(c.non_field_errors)?c.non_field_errors.join(", "):c.non_field_errors;else if(typeof c=="object"){const u=[];for(const[g,p]of Object.entries(c))Array.isArray(p)?u.push(`${g}: ${p.join(", ")}`):typeof p=="string"&&u.push(`${g}: ${p}`);u.length>0&&(d=u.join("; "))}const m=new Error(d);throw m.response=c,m.status=o.status,m}const l=o.headers.get("content-type")||"";if(l.includes("application/json")){const r=await o.json();if(console.log("âœ… Parsed JSON Response:",r),r.status==="error")throw new Error(r.message||"Terjadi kesalahan");return r}else if(l.includes("text/")){const r=await o.text();console.log("âœ… Text Response:",r.substring(0,200));try{return JSON.parse(r)}catch{return{data:r}}}else return o}catch(s){throw console.error("âŒ Fetch report error:",{message:s.message,name:s.name,stack:s.stack}),s.name==="AbortError"?new Error("Request timeout. Silakan coba lagi."):s.name==="TypeError"&&(s.message.includes("fetch")||s.message.includes("network"))?new Error("Koneksi jaringan terputus. Periksa koneksi internet Anda."):s.message&&s.message!=="Terjadi kesalahan pada server"?s:s.message.includes("500")?new Error("Server sedang mengalami masalah. Silakan coba lagi dalam beberapa menit."):new Error(s.message||"Terjadi kesalahan yang tidak diketahui")}}function ys(e){const a=new Date,t=new Date;return t.setMonth(t.getMonth()-1),`
        <form id="filterForm">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Tanggal Mulai</label>
                    <input type="date" class="form-control" id="startDate" 
                           value="${t.toISOString().split("T")[0]}" required>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Tanggal Akhir</label>
                    <input type="date" class="form-control" id="endDate" 
                           value="${a.toISOString().split("T")[0]}" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Terapkan
                    </button>
                </div>
            </div>
        </form>
    `}function Fr(){const e=new Date,a=e.getFullYear(),t=e.getMonth()+1,i=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],s=[a,a-1,a-2];return`
        <form id="monthlyFilterForm">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Bulan</label>
                    <select class="form-select" id="monthSelect" required>
                        ${i.map((n,o)=>`
                            <option value="${o+1}" ${t===o+1?"selected":""}>
                                ${n}
                            </option>
                        `).join("")}
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Tahun</label>
                    <select class="form-select" id="yearSelect" required>
                        ${s.map(n=>`
                            <option value="${n}" ${a===n?"selected":""}>${n}</option>
                        `).join("")}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-chart-line"></i> Generate
                    </button>
                </div>
            </div>
        </form>
    `}function Oe(e,a={}){const t={};a.start_date&&a.end_date?(t.start_date=a.start_date,t.end_date=a.end_date):a.month&&a.year&&(t.month=a.month,t.year=a.year);const i=JSON.stringify(t).replace(/"/g,"&quot;");return`
        <div class="mt-4 pt-3 border-top">
            <h6 class="mb-3"><i class="fas fa-download"></i> Export Laporan</h6>
            <p class="text-muted small mb-3">
                <i class="fas fa-info-circle"></i> Pilih format yang diinginkan
            </p>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-danger export-btn" data-format="pdf"
                        onclick="window.handleExportButtonClick('${e}', 'pdf', '${i}')">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button type="button" class="btn btn-outline-success export-btn" data-format="excel"
                        onclick="window.handleExportButtonClick('${e}', 'excel', '${i}')">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button type="button" class="btn btn-outline-primary export-btn" data-format="json"
                        onclick="window.handleExportButtonClick('${e}', 'json', '${i}')">
                    <i class="fas fa-file-code"></i> JSON
                </button>
            </div>
        </div>
    `}async function Hr(e,a,t){try{console.log("Export button clicked:",{reportType:e,format:a,filterString:t});let i={};try{if(t&&t!=="{}"){const s=t.replace(/&quot;/g,'"');i=JSON.parse(s)}}catch(s){console.error("Error parsing filter string:",s)}await oi(e,a,i)}catch(i){console.error("Error in handleExportButtonClick:",i),x(`Gagal export: ${i.message}`,"error")}}async function Tn(e,a,t={}){try{console.log(`ðŸ“Š Export ${e} as ${a}`,t),await oi(e,a,t)}catch(i){console.error("Error in handleExportWithFilters:",i),x(`Gagal export: ${i.message}`,"error")}}async function Sn(e){const a=document.getElementById("filterSection"),t=document.getElementById("reportContent"),i=document.getElementById("reportTitle"),s=document.getElementById("exportButtonsContainer");try{s&&(s.style.display="none"),t.innerHTML=`
            <div class="loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Memuat laporan...</h4>
            </div>
        `;const n={keuangan:"Laporan Keuangan",anggota:"Laporan Anggota","laporan-sampah":"Laporan Sampah",jadwal:"Laporan Jadwal","dampak-lingkungan":"Analisis Dampak Lingkungan","user-stats":"Statistik User",monthly:"Laporan Bulanan"};i&&(i.textContent=n[e]||"Laporan"),a&&(a.style.display="block");const o=document.getElementById("filterContent");if(e==="user-stats")o&&(o.innerHTML="",a.style.display="none"),await An();else if(e==="monthly")o&&(o.innerHTML=Fr()),await Oi();else if(e==="dampak-lingkungan"){if(o){o.innerHTML=ys(e);const l=new Date,r=new Date;r.setDate(r.getDate()-30),document.getElementById("startDate").value=r.toISOString().split("T")[0],document.getElementById("endDate").value=l.toISOString().split("T")[0]}await Jt(null,e)}else{if(o){o.innerHTML=ys(e);const l=new Date,r=new Date;r.setDate(r.getDate()-30),document.getElementById("startDate").value=r.toISOString().split("T")[0],document.getElementById("endDate").value=l.toISOString().split("T")[0]}await Jt(null,e)}s&&e!=="user-stats"&&(s.style.display="block")}catch(n){console.error("Error in loadReport:",n),t&&(t.innerHTML=`
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
                    <p>${n.message}</p>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="window.loadReport('${e}')">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </div>
            `)}}async function Jt(e,a,t=null){var n,o;e&&(e.preventDefault(),e.stopPropagation());const i=document.getElementById("reportContent"),s=e?e.target.querySelector('button[type="submit"]'):null;try{if(i.innerHTML=`
            <div class="loading-container">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3">
                    <h4>Memproses data...</h4>
                    <p class="text-muted">Sedang mengambil dan memproses data laporan</p>
                </div>
            </div>
        `,s){const d=s.innerHTML;s.disabled=!0,s.innerHTML=`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Memproses...
            `}let l;if(t)l=t;else{const d=(n=document.getElementById("startDate"))==null?void 0:n.value,m=(o=document.getElementById("endDate"))==null?void 0:o.value;if(!d||!m)throw new Error("Tanggal awal dan akhir harus diisi");if(new Date(d)>new Date(m))throw new Error("Tanggal awal tidak boleh lebih besar dari tanggal akhir");l={start_date:d,end_date:m}}l._t=new Date().getTime();let r,c;switch(a){case"keuangan":c=b.reportsKeuangan,r=await ee(c,"POST",l),Pn(r.data||r,l);break;case"anggota":c=b.reportsAnggota,r=await ee(c,"POST",l),Bn(r.data||r,l);break;case"laporan-sampah":c=b.reportsLaporanSampah,r=await ee(c,"POST",l),Mn(r.data||r,l);break;case"jadwal":c=b.reportsJadwal,r=await ee(c,"POST",l),In(r.data||r,l);break;case"dampak-lingkungan":c=b.reportsDampakLingkungan,r=await ee(c,"POST",l),Cn(r.data||r,l);break;case"user-stats":c=b.reportsUserStats,r=await ee(c,"GET"),Ki(r.data||r,l);break;case"monthly":c=b.reportsMonthly,r=await ee(c,"POST",l),qi(r.data||r,l);break;default:throw new Error(`Tipe report tidak dikenali: ${a}`)}}catch(l){console.error("Error in applyFilter:",l);let r=l.message;l.response&&(r=l.response.message||l.message,console.error("Error response details:",l.response)),i&&(i.innerHTML=`
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-circle"></i> Gagal Memuat Data Laporan</h5>
                    <p>${r}</p>
                    <p class="small text-muted mt-2">Endpoint: ${apiEndpoint||"N/A"}</p>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="window.applyFilter(null, '${a}')">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </div>
            `)}finally{s&&(s.disabled=!1,s.innerHTML='<i class="fas fa-filter"></i> Terapkan Filter')}}async function An(){const e=document.getElementById("reportContent");try{if(!e)throw new Error("Element reportContent tidak ditemukan");e.innerHTML=`
            <div class="loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Memuat Statistik Pengguna...</h4>
                <p class="text-muted">Sedang mengambil data dari server</p>
            </div>
        `;const a=await ee(b.reportsUserStats,"GET");if(!a)throw new Error("Tidak ada data yang diterima");const t=a.data||a;Ki(t)}catch(a){console.error("Error loading user stats:",a),e&&(e.innerHTML=`
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Gagal Memuat Statistik</h5>
                    <p>${a.message}</p>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="window.loadUserStatsReport()">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </div>
            `)}}async function Oi(){const e=document.getElementById("reportContent"),a=document.getElementById("exportButtonsContainer");try{if(!e){console.error("âŒ reportContent element not found");return}a&&(a.style.display="block"),e.innerHTML=`
            <div class="loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Memuat laporan bulanan...</h4>
                <p class="text-muted">Sedang menghitung data statistik</p>
            </div>
        `;const t=document.getElementById("monthSelect"),i=document.getElementById("yearSelect");if(!t||!i)throw new Error("Form filter tidak ditemukan");const s=parseInt(t.value),n=parseInt(i.value);if(!s||!n)throw new Error("Bulan dan tahun harus dipilih");if(s<1||s>12)throw new Error("Bulan harus antara 1-12");const o=b.reportsMonthly||"/api/reports/monthly/",l=await ee(o,"POST",{month:s,year:n}),r=l.data||l;qi(r,{month:s,year:n})}catch(t){if(console.error("âŒ Error in generateMonthlyReport:",t),e){let i=t.message;(t.message.includes("401")||t.message.includes("Sesi telah berakhir"))&&(i="Sesi telah berakhir. Silakan login kembali."),e.innerHTML=`
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Gagal Memuat Laporan Bulanan</h5>
                    <p>${i}</p>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-danger me-2" onclick="generateMonthlyReport()">
                            <i class="fas fa-redo"></i> Coba Lagi
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadReport('monthly')">
                            <i class="fas fa-arrow-left"></i> Kembali ke Filter
                        </button>
                    </div>
                </div>
            `}}}async function oi(e,a="pdf",t={}){const i=document.querySelectorAll(".export-btn, #exportPdfBtn, #exportExcelBtn, #exportJsonBtn");i.forEach(s=>{const n=s.innerHTML,o=s.disabled;s.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> Memproses...',s.disabled=!0,s.dataset.originalHTML=n,s.dataset.originalDisabled=o?"true":"false"});try{console.log(`ðŸš€ Starting export for ${e} as ${a}`,t);const s=v();s["Content-Type"]="application/json";const n={};if(["start_date","end_date","month","year"].forEach(u=>{t[u]!==void 0&&t[u]!==null&&t[u]!==""&&(n[u]=t[u])}),e!=="monthly"&&e!=="user-stats"&&(!n.start_date||!n.end_date)){const u=new Date,g=new Date;g.setDate(g.getDate()-30),n.start_date=g.toISOString().split("T")[0],n.end_date=u.toISOString().split("T")[0]}console.log("ðŸ“¤ Sending export request:",{report_type:e,format:a,filters:n});const l={report_type:e,format:a,filters:n},r=await fetch(b.reportsExport,{method:"POST",headers:s,body:JSON.stringify(l)});if(console.log("ðŸ“¥ Received response:",{status:r.status,statusText:r.statusText,ok:r.ok,headers:Object.fromEntries(r.headers.entries())}),!r.ok){let u="";try{u=await r.text(),console.error("Error response text:",u);let g=`HTTP ${r.status}: ${r.statusText}`;try{const p=JSON.parse(u);p.error?g=p.error:p.detail?g=p.detail:p.message&&(g=p.message)}catch{u.length>200?g=u.substring(0,200)+"...":g=u||g}throw new Error(g)}catch(g){throw console.error("Error reading error response:",g),new Error(`HTTP ${r.status}: ${r.statusText}`)}}const c=r.headers.get("content-type")||"";console.log("Content-Type:",c);let d=`laporan_${e}_${new Date().getTime()}`;const m=r.headers.get("content-disposition");if(m){const u=m.match(/filename="(.+)"/)||m.match(/filename=([^;]+)/);u&&u[1]&&(d=u[1].replace(/['"]/g,""))}if(c.includes("application/pdf")){const u=await r.blob();if(!u||u.size===0)throw new Error("File PDF kosong atau corrupt");lt(u,d.endsWith(".pdf")?d:`${d}.pdf`),x("File PDF berhasil didownload!","success",7e3)}else if(c.includes("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")){const u=await r.blob();if(!u||u.size===0)throw new Error("File Excel kosong atau corrupt");lt(u,d.endsWith(".xlsx")?d:`${d}.xlsx`),x("File Excel berhasil didownload!","success",7e3)}else if(c.includes("application/json")){const u=await r.text();console.log("JSON response received:",u.substring(0,200)+"...");try{const g=JSON.parse(u);if(a==="pdf"||a==="excel"){if(x(`Backend mengembalikan data JSON, bukan file ${a.toUpperCase()}`,"warning"),g.error)throw new Error(g.error);const p=JSON.stringify(g,null,2),h=new Blob([p],{type:"application/json"});lt(h,`${d}.json`),x("Data tersedia dalam format JSON","info")}else{const p=JSON.stringify(g,null,2),h=new Blob([p],{type:"application/json"});lt(h,d.endsWith(".json")?d:`${d}.json`),x("File JSON berhasil didownload!","success",7e3)}}catch(g){throw console.error("Error parsing JSON response:",g),new Error("Gagal memproses response dari server")}}else{const u=await r.blob();if(u&&u.size>0){let g=a;a==="pdf"?g="pdf":a==="excel"?g="xlsx":a==="json"&&(g="json"),lt(u,`${d}.${g}`),x(`File ${a.toUpperCase()} berhasil didownload!`,"success")}else throw new Error("Response kosong dari server")}}catch(s){console.error("âŒ Export error:",s),x(`Gagal export: ${s.message}`,"error")}finally{i.forEach(s=>{if(s.dataset.originalHTML){s.innerHTML=s.dataset.originalHTML;const n=s.dataset.originalDisabled==="true";s.disabled=n,delete s.dataset.originalHTML,delete s.dataset.originalDisabled}})}}async function Mt(e="pdf"){var a,t,i,s;try{const n=document.querySelector(".report-card.active");if(!n){x("Silakan pilih laporan terlebih dahulu","warning");return}const o=n.getAttribute("data-report-type");let l={};if(o==="monthly"){const r=document.getElementById("monthSelect"),c=document.getElementById("yearSelect");if(r&&c)l={month:parseInt(r.value),year:parseInt(c.value)};else{const d=new Date;l={month:d.getMonth()+1,year:d.getFullYear()}}}else if(o==="user-stats")l={};else if(o==="dampak-lingkungan"){let r=(a=document.getElementById("startDate"))==null?void 0:a.value,c=(t=document.getElementById("endDate"))==null?void 0:t.value;if(!r||!c){const d=new Date,m=new Date;m.setDate(m.getDate()-30),r=m.toISOString().split("T")[0],c=d.toISOString().split("T")[0]}if(new Date(r)>new Date(c))throw new Error("Tanggal mulai tidak boleh lebih besar dari tanggal akhir");l={start_date:r,end_date:c}}else{let r=(i=document.getElementById("startDate"))==null?void 0:i.value,c=(s=document.getElementById("endDate"))==null?void 0:s.value;if(!r||!c){const d=new Date,m=new Date;m.setDate(m.getDate()-30),r=m.toISOString().split("T")[0],c=d.toISOString().split("T")[0]}if(new Date(r)>new Date(c))throw new Error("Tanggal mulai tidak boleh lebih besar dari tanggal akhir");l={start_date:r,end_date:c}}console.log(`ðŸ“Š Export ${o} sebagai ${e} dengan filter:`,l),await oi(o,e,l)}catch(n){console.error("Error in handleExport:",n),x(`Gagal memproses export: ${n.message}`,"error")}}function lt(e,a){const t=window.URL.createObjectURL(e),i=document.createElement("a");i.href=t,i.download=a,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),window.URL.revokeObjectURL(t)},100)}async function Ur(){try{const e=v();e["Content-Type"]="application/json";const a={report_type:"user-stats",format:"json"},t=await fetch(b.reportsExport,{method:"POST",headers:e,body:JSON.stringify(a)}),i=t.headers.get("content-type")||"",s=await t.json().catch(()=>null);return console.log("ðŸ”§ Export capabilities check:",{status:t.status,contentType:i,supportsPdf:i.includes("pdf"),supportsExcel:i.includes("excel")||i.includes("spreadsheetml"),dataFormat:s?typeof s:"unknown"}),{supportsPdf:i.includes("pdf"),supportsExcel:i.includes("excel")||i.includes("spreadsheetml"),supportsJson:!0,status:t.status}}catch(e){return console.error("Error checking export capabilities:",e),{supportsPdf:!1,supportsExcel:!1,supportsJson:!0,error:e.message}}}function Ki(e){const a=document.getElementById("reportContent");if(!a)return;const t=e.info||{},i=e.table||[],s=t.total_users||0,n=t.active_users||0,o=t.admin_count||0,l=t.anggota_count||0,r=t.tamu_count||0,c=t.tim_angkut_count||0,d=t.new_users_month||0,m=w=>s?Math.round(w/s*100):0,u=m(n),g=m(o),p=m(l),h=m(r),f=m(c),k=[...i].sort((w,$)=>new Date($.date_joined)-new Date(w.date_joined));a.innerHTML=`
        <div class="user-stats-report">
            <!-- HEADER -->
            <div class="mb-4">
                <h4><i class="fas fa-users"></i> Statistik Pengguna</h4>
                <p class="text-muted">
                    Terakhir diperbarui: ${new Date(t.tanggal_generate||Date.now()).toLocaleString("id-ID")}
                </p>
            </div>

            <!-- SUMMARY -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-primary">${s}</div>
                        <div class="stat-label">Total Pengguna</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-success">${n}</div>
                        <div class="stat-label">Aktif (${u}%)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-danger">${o}</div>
                        <div class="stat-label">Admin (${g}%)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-warning">${d}</div>
                        <div class="stat-label">Baru Bulan Ini</div>
                    </div>
                </div>
            </div>

            <!-- DISTRIBUSI ROLE -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Distribusi Peran</h5>
                        </div>
                        <div class="card-body">
                            ${Et("Admin",o,g,"danger")}
                            ${Et("Anggota",l,p,"success")}
                            ${Et("Tamu",r,h,"warning")}
                            ${Et("Tim Pengangkut",c,f,"info")}
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Ringkasan</h5>
                        </div>
                        <div class="card-body">
                            <p><i class="fas fa-check-circle text-success me-2"></i>
                                <strong>${u}%</strong> pengguna aktif
                            </p>
                            <p><i class="fas fa-user-plus text-primary me-2"></i>
                                <strong>${d}</strong> pengguna baru bulan ini
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLE DETAIL -->
            ${k.length?`
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between">
                    <h5 class="mb-0">Detail Pengguna</h5>
                    <span class="badge bg-secondary">${k.length} user</span>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>No</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Tanggal Daftar</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${k.map((w,$)=>`
                                <tr>
                                    <td>${$+1}</td>
                                    <td>${w.username||"-"}</td>
                                    <td>${w.email||"-"}</td>
                                    <td>
                                        <span class="badge bg-secondary">${w.role}</span>
                                    </td>
                                    <td>
                                        <span class="badge ${w.is_active?"bg-success":"bg-danger"}">
                                            ${w.is_active?"Aktif":"Nonaktif"}
                                        </span>
                                    </td>
                                    <td>${La(w.date_joined)}</td>
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>
                </div>
            </div>
            `:`
            <div class="alert alert-info">Tidak ada data pengguna</div>
            `}

            ${Oe("user-stats")}

            <button class="btn btn-outline-primary mt-3" onclick="window.loadUserStatsReport()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
        </div>
    `}function Et(e,a,t,i){return`
        <div class="d-flex justify-content-between mb-2">
            <span><span class="badge bg-${i}">${e}</span></span>
            <span>${a} (${t}%)</span>
        </div>
    `}function Bn(e,a){const t=document.getElementById("reportContent");if(!t)return;const i=e.info||{},s=e.table||[],n=i.total_anggota||0,o=i.aktif||0,l=i.non_aktif||0,r=i.akan_expired||0,c=n>0?(o/n*100).toFixed(1):0,d=n>0?(l/n*100).toFixed(1):0,m=`
        <div class="anggota-report">

            <!-- ===== SUMMARY ===== -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-primary">${n}</div>
                        <div class="stat-label">Total Anggota</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-success">${o}</div>
                        <div class="stat-label">Aktif (${c}%)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-danger">${l}</div>
                        <div class="stat-label">Non-Aktif (${d}%)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-warning">${r}</div>
                        <div class="stat-label">Akan Expired</div>
                    </div>
                </div>
            </div>

            <!-- ===== DISTRIBUSI JENIS SAMPAH ===== -->
            ${i.jenis_sampah_stats&&Object.keys(i.jenis_sampah_stats).length?`
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Distribusi Jenis Sampah</h5>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-success">
                                <tr>
                                    <th>Jenis Sampah</th>
                                    <th class="text-end">Jumlah</th>
                                    <th class="text-end">Persentase</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(i.jenis_sampah_stats).map(([u,g])=>`
                                    <tr>
                                        <td>${u}</td>
                                        <td class="text-end">${g}</td>
                                        <td class="text-end">
                                            ${n>0?(g/n*100).toFixed(1):0}%
                                        </td>
                                    </tr>
                                `).join("")}
                            </tbody>
                        </table>
                    </div>
                </div>
            `:""}

            <!-- ===== TABLE DETAIL ANGGOTA ===== -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Detail Anggota</h5>
                    <span class="badge bg-secondary">${s.length} data</span>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>No</th>
                                <th>Nama Anggota</th>
                                <th>Status</th>
                                <th>Jenis Sampah</th>
                                <th>Tanggal Mulai</th>
                                <th>Tanggal Berakhir</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${s.length?s.map((u,g)=>`
                                <tr>
                                    <td>${g+1}</td>
                                    <td>${u.nama_anggota||"-"}</td>
                                    <td>
                                        <span class="badge ${u.status==="aktif"?"bg-success":"bg-danger"}">
                                            ${u.status}
                                        </span>
                                    </td>
                                    <td>${u.jenis_sampah||"-"}</td>
                                    <td>${La(u.tanggal_start)}</td>
                                    <td>${u.tanggal_end?La(u.tanggal_end):"-"}</td>
                                </tr>
                            `).join(""):`
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        Tidak ada data anggota
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ===== EXPORT ===== -->
            ${Oe("anggota",a)}

            <!-- ===== FOOTER ===== -->
            <div class="mt-4 pt-3 border-top text-muted small">
                <strong>Periode:</strong>
                ${La(a.start_date)} - ${La(a.end_date)}
                &nbsp;|&nbsp;
                <strong>Dibuat:</strong>
                ${new Date(i.tanggal_generate||Date.now()).toLocaleString("id-ID")}
            </div>

        </div>
    `;t.innerHTML=m}function Mn(e,a){var g;const t=document.getElementById("reportContent"),i=e.info||{},s=e.table||[],n=i.total_laporan||0,o=i.pending||0,l=i.proses||0,r=i.selesai||0,c=n?(o/n*100).toFixed(1):0,d=n?(l/n*100).toFixed(1):0,m=n?(r/n*100).toFixed(1):0,u=`
    <div>
        <!-- SUMMARY -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <div class="stat-value text-primary">${n}</div>
                    <div class="stat-label">Total Laporan</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <div class="stat-value text-warning">${o}</div>
                    <div class="stat-label">Pending (${c}%)</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <div class="stat-value text-info">${l}</div>
                    <div class="stat-label">Proses (${d}%)</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <div class="stat-value text-success">${r}</div>
                    <div class="stat-label">Selesai (${m}%)</div>
                </div>
            </div>
        </div>

        <!-- TOP PELAPOR -->
        ${(g=i.top_pelapor)!=null&&g.length?`
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Top Pelapor</h5>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-hover">
                    <thead class="table-danger">
                        <tr>
                            <th>No</th>
                            <th>Username</th>
                            <th class="text-end">Jumlah</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${i.top_pelapor.map((p,h)=>`
                            <tr>
                                <td>${h+1}</td>
                                <td>${p.username||"-"}</td>
                                <td class="text-end">${p.jumlah_laporan||0}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            </div>
        </div>`:""}

        <!-- TABEL DETAIL LAPORAN -->
        ${s.length?`
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between">
                <h5 class="mb-0">Detail Laporan Sampah</h5>
                <span class="badge bg-secondary">${s.length} data</span>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>No</th>
                            <th>Tanggal</th>
                            <th>Pelapor</th>
                            <th>Lokasi</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${s.map((p,h)=>`
                            <tr>
                                <td>${h+1}</td>
                                <td>${La(p.tanggal_lapor)}</td>
                                <td>${p.nama_pelapor}</td>
                                <td>${p.alamat}</td>
                                <td>
                                    <span class="badge ${p.status==="selesai"?"bg-success":p.status==="proses"?"bg-info":"bg-warning"}">
                                        ${p.status}
                                    </span>
                                </td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            </div>
        </div>`:`
        <div class="alert alert-info">Tidak ada data laporan</div>`}

        ${Oe("laporan-sampah",a)}

        <div class="mt-4 pt-3 border-top text-muted small">
            <strong>Periode:</strong> ${La(a.start_date)} - ${La(a.end_date)} |
            <strong>Dibuat:</strong> ${new Date().toLocaleString("id-ID")}
        </div>
    </div>
    `;t.innerHTML=u}function In(e,a){const t=document.getElementById("reportContent"),i=e.info||{},s=e.table||[],n=i.total_jadwal||0,o=i.total_tim||0,l=i.total_anggota_terjadwal||0,r=`
        <div>
            <!-- SUMMARY GLOBAL -->
            <div class="row g-3 mb-4">
                <div class="col-md-4 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-primary">${n}</div>
                        <div class="stat-label">Total Jadwal</div>
                    </div>
                </div>
                <div class="col-md-4 col-6">
                    <div class="stat-card">
                        <div class="stat-value" style="color:#9b59b6;">${o}</div>
                        <div class="stat-label">Tim Pengangkut</div>
                    </div>
                </div>
                <div class="col-md-4 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-success">${l}</div>
                        <div class="stat-label">Anggota Terjadwal</div>
                    </div>
                </div>
            </div>

            <!-- STATUS GLOBAL -->
            ${i.status_stats?`
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Status Pengangkutan (Global)</h5>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-hover">
                            <thead class="table-info">
                                <tr>
                                    <th>Status</th>
                                    <th class="text-end">Jumlah</th>
                                    <th class="text-end">Persentase</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(i.status_stats).map(([c,d])=>`
                                    <tr>
                                        <td>
                                            <span class="badge" style="background:${It(c)}">
                                                ${c}
                                            </span>
                                        </td>
                                        <td class="text-end">${d}</td>
                                        <td class="text-end">
                                            ${l?(d/l*100).toFixed(1):0}%
                                        </td>
                                    </tr>
                                `).join("")}
                            </tbody>
                        </table>
                    </div>
                </div>
            `:""}

            <!-- DETAIL PER TIM -->
            ${s.length?`
                <div class="accordion" id="accordionTim">
                    ${s.map((c,d)=>`
                        <div class="accordion-item mb-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button ${d?"collapsed":""}" 
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#tim-${d}">
                                    <strong>${c.nama_tim}</strong>
                                    <span class="ms-3 badge bg-primary">
                                        ${c.total_anggota} anggota
                                    </span>
                                    <span class="ms-2 badge bg-secondary">
                                        ${c.total_jadwal} jadwal
                                    </span>
                                </button>
                            </h2>

                            <div id="tim-${d}" class="accordion-collapse collapse ${d===0?"show":""}">
                                <div class="accordion-body">

                                    <!-- STATUS PER TIM -->
                                    <div class="mb-3">
                                        ${Object.entries(c.status_stats).map(([m,u])=>`
                                            <span class="badge me-2" style="background:${It(m)}">
                                                ${m}: ${u}
                                            </span>
                                        `).join("")}
                                    </div>

                                    <!-- TABEL ANGGOTA -->
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>No</th>
                                                    <th>Tanggal</th>
                                                    <th>Nama Anggota</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${c.detail.map((m,u)=>`
                                                    <tr>
                                                        <td>${u+1}</td>
                                                        <td>${La(m.tanggal_jadwal)}</td>
                                                        <td>${m.nama_anggota}</td>
                                                        <td>
                                                            <span class="badge" style="background:${It(m.status_pengangkutan)}">
                                                                ${m.status_pengangkutan}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `).join("")}
                                            </tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>
                    `).join("")}
                </div>
            `:`
                <div class="alert alert-info">Tidak ada data jadwal</div>
            `}

            ${Oe("jadwal",a)}

            <div class="mt-4 pt-3 border-top text-muted small">
                <strong>Periode:</strong> ${La(a.start_date)} - ${La(a.end_date)} |
                <strong>Dibuat:</strong> ${new Date().toLocaleString("id-ID")}
            </div>
        </div>
    `;t.innerHTML=r}function Pn(e,a){const t=document.getElementById("reportContent"),i=e.info||{},s=e.table||[],n=i.total_pendapatan||0,o=i.total_pending||0,l=i.total_lunas||0,r=i.total_gagal||0,c=`
        <div>
            <!-- SUMMARY -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-success">${at(n)}</div>
                        <div class="stat-label">Total Pendapatan</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-warning">${o}</div>
                        <div class="stat-label">Transaksi Pending</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-primary">${l}</div>
                        <div class="stat-label">Transaksi Lunas</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-danger">${r}</div>
                        <div class="stat-label">Transaksi Gagal</div>
                    </div>
                </div>
            </div>

            <!-- METODE PEMBAYARAN -->
            ${i.metode_bayar_stats?`
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Statistik Metode Pembayaran</h5>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>Metode</th>
                                    <th class="text-end">Jumlah</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(i.metode_bayar_stats).map(([d,m])=>`
                                    <tr>
                                        <td>${d}</td>
                                        <td class="text-end">${m.count||0}</td>
                                        <td class="text-end">${at(m.total||0)}</td>
                                    </tr>
                                `).join("")}
                            </tbody>
                        </table>
                    </div>
                </div>
            `:""}

            ${s.length?`
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Detail Transaksi</h5>
                    <span class="badge bg-secondary">${s.length} data</span>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Nama Anggota</th>
                                <th>Metode</th>
                                <th>Status</th>
                                <th class="text-end">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${s.map((d,m)=>`
                                <tr>
                                    <td>${m+1}</td>
                                    <td>${La(d.tanggal_bayar)}</td>
                                    <td>${d.nama_anggota}</td>
                                    <td>${d.metode_bayar}</td>
                                    <td>
                                        <span class="badge ${d.status_bayar==="lunas"?"bg-success":d.status_bayar==="pending"?"bg-warning":"bg-danger"}">
                                            ${d.status_bayar}
                                        </span>
                                    </td>
                                    <td class="text-end">${at(d.jumlah_bayar)}</td>
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>
                </div>
            </div>
            `:`
            <div class="alert alert-info">Tidak ada data transaksi</div>
            `}


            ${Oe("keuangan",a)}

            <div class="mt-4 pt-3 border-top text-muted small">
                <strong>Periode:</strong> ${La(a.start_date)} - ${La(a.end_date)} |
                <strong>Dibuat:</strong> ${new Date().toLocaleString("id-ID")}
            </div>
        </div>
    `;t.innerHTML=c}function qi(e,a){const t=document.getElementById("reportContent"),i=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],s=e.bulan||(a.month?i[a.month-1]+" "+a.year:"Laporan Bulanan"),n=`
        <div>
            <h4 class="mb-4" style="color: #2c3e50;">${s}</h4>
            
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-success">${at(e.total_pendapatan||0)}</div>
                        <div class="stat-label">Pendapatan</div>
                        <div class="text-muted small">${e.total_transaksi||0} transaksi</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-primary">${e.total_anggota||0}</div>
                        <div class="stat-label">Anggota</div>
                        <div class="text-muted small">
                            ${e.anggota_baru||0} baru, ${e.anggota_expired||0} expired
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" style="color: #9b59b6;">${e.total_jadwal||0}</div>
                        <div class="stat-label">Jadwal</div>
                        <div class="text-muted small">
                            ${e.anggota_dilayani||0} anggota, ${e.success_rate||0}% success
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-danger">${e.total_laporan||0}</div>
                        <div class="stat-label">Laporan Sampah</div>
                        <div class="text-muted small">${e.resolution_rate||0}% resolved</div>
                    </div>
                </div>
            </div>
            
            ${e.summary?`
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Ringkasan & Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td class="fw-bold">Pendapatan per Anggota</td>
                                        <td class="text-end">${at(e.summary.pendapatan_per_anggota||0)}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Laporan per User</td>
                                        <td class="text-end">${(e.summary.laporan_per_user||0).toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Efficiency Rate</td>
                                        <td class="text-end">
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                                    <div class="progress-bar bg-success" role="progressbar" 
                                                         style="width: ${e.summary.efficiency_rate||0}%">
                                                    </div>
                                                </div>
                                                <span>${e.summary.efficiency_rate||0}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `:""}
            
            ${Oe("monthly",a)}
            
            <div class="mt-4 pt-3 border-top text-muted small">
                <strong>Bulan:</strong> ${s} | 
                <strong>Dibuat:</strong> ${new Date().toLocaleString("id-ID")}
            </div>
        </div>
    `;t.innerHTML=n}function Cn(e,a){const t=document.getElementById("reportContent");if(!t){console.error("Element #reportContent tidak ditemukan");return}const i=e.total_laporan||0,s=e.laporan_selesai||0,n=e.tingkat_penyelesaian||0,o=e.efektivitas_penanganan||{},l=e.tren_waktu||{},r=e.dampak_lingkungan||{},c=Array.isArray(r.peringatan)?r.peringatan:[];r.jenis_berbahaya;const d=Array.isArray(r.analisis_detail)?r.analisis_detail:[],m=r.ringkasan||{},u=Array.isArray(r.lokasi_berbahaya)?r.lokasi_berbahaya:[],g=r.waktu_penanganan_berbahaya||{},p=e.klasifikasi_sampah||{},h=Array.isArray(p.detail_klasifikasi)?p.detail_klasifikasi:[],f=p.persentase_data_terstruktur||0,k=e.ranking_wilayah||{},w=Array.isArray(k.ranking_terkotor)?k.ranking_terkotor:[],$=Array.isArray(k.ranking_terbersih)?k.ranking_terbersih:[],y=Array.isArray(e.rekomendasi)?e.rekomendasi:[],A=T=>{if(!T)return"-";try{return new Date(T).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})}catch{return T}},E=T=>{switch(T){case"sangat_tinggi":return"bg-danger";case"tinggi":return"bg-warning";case"sedang":return"bg-primary";case"rendah":return"bg-info";case"aman":return"bg-success";default:return"bg-secondary"}},C=T=>({plastik:"#e74c3c",organik:"#27ae60",kertas:"#3498db",logam:"#f39c12",b3:"#9b59b6",kaca:"#1abc9c",campuran:"#95a5a6",karet:"#d35400",tekstil:"#8e44ad",tidak_terdeteksi:"#7f8c8d"})[T]||"#34495e",B=()=>c.length===0?`
                <div class="alert alert-success mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <h6 class="alert-heading">Tidak Ada Peringatan Kritis</h6>
                            <p class="mb-0">Berdasarkan analisis data yang tersedia, tidak ditemukan indikasi dampak lingkungan yang kritis.</p>
                        </div>
                    </div>
                </div>
            `:`
            <div class="mb-4">
                <h6 class="text-danger mb-3"><i class="fas fa-radiation"></i> Peringatan Lingkungan</h6>
                <div class="row g-3">
                    ${c.map(T=>{const N=T.level==="sangat_tinggi"?"danger":T.level==="tinggi"?"warning":T.level==="sedang"?"primary":"info",z=T.level==="sangat_tinggi"?"fa-radiation":T.level==="tinggi"?"fa-exclamation-triangle":T.level==="sedang"?"fa-exclamation-circle":"fa-info-circle",G=T.level==="sangat_tinggi"?"SANGAT TINGGI":T.level==="tinggi"?"TINGGI":T.level==="sedang"?"SEDANG":"RENDAH";let j=T.jenis||"tidak_diketahui";return j==="b3"?j="LIMBAH B3":j==="plastik"?j="SAMPAH PLASTIK":j==="organik"?j="SAMPAH ORGANIK":j=j.toUpperCase(),`
                            <div class="col-md-6">
                                <div class="alert alert-${N}">
                                    <div class="d-flex align-items-start">
                                        <i class="fas ${z} fa-2x me-3 mt-1"></i>
                                        <div>
                                            <h6 class="alert-heading">
                                                ${j}
                                                <span class="badge bg-dark ms-2">${G}</span>
                                            </h6>
                                            <p class="mb-1">
                                                <strong>${T.jumlah||0} laporan</strong> 
                                                (${T.persentase||0}% dari total)
                                            </p>
                                            ${T.dampak?`
                                                <p class="small mb-1">
                                                    <i class="fas fa-exclamation-circle"></i> 
                                                    ${Array.isArray(T.dampak)?T.dampak[0]:T.dampak}
                                                    ${Array.isArray(T.dampak)&&T.dampak.length>1?` (+${T.dampak.length-1} lainnya)`:""}
                                                </p>
                                            `:""}
                                            ${T.rekomendasi?`
                                                <small class="mb-0">
                                                    <strong>Rekomendasi:</strong> ${T.rekomendasi}
                                                </small>
                                            `:""}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}).join("")}
                </div>
            </div>
        `,I=()=>d.length===0?"":`
            <div class="mb-4">
                <h6 class="text-primary mb-3"><i class="fas fa-chart-bar"></i> Analisis Dampak per Jenis Sampah</h6>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Jenis Sampah</th>
                                <th class="text-end">Jumlah</th>
                                <th class="text-end">Persentase</th>
                                <th>Tingkat Bahaya</th>
                                <th>Dampak Potensial</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${d.map(T=>{const N=T.tingkat_bahaya||"tidak_diketahui",z=N==="sangat_tinggi"?"danger":N==="tinggi"?"warning":N==="sedang"?"primary":"success",G=T.status||"tidak_diketahui",j=G==="aman"?"success":"warning",K=G==="aman"?"fa-check-circle":"fa-exclamation-triangle";let H=T.jenis||"tidak_diketahui";return H==="b3"?H="Limbah B3":H==="plastik"?H="Plastik":H==="organik"?H="Organik":H==="kertas"?H="Kertas":H==="logam"?H="Logam":H==="kaca"?H="Kaca":H=H.charAt(0).toUpperCase()+H.slice(1),`
                                    <tr>
                                        <td>
                                            <strong>${H}</strong>
                                        </td>
                                        <td class="text-end fw-bold">${T.jumlah||0}</td>
                                        <td class="text-end">${T.persentase||0}%</td>
                                        <td>
                                            <span class="badge bg-${z}">
                                                ${N==="sangat_tinggi"?"SANGAT TINGGI":N==="tinggi"?"TINGGI":N==="sedang"?"SEDANG":"RENDAH"}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="small">
                                                ${T.dampak_potensial?Array.isArray(T.dampak_potensial)?T.dampak_potensial[0]:T.dampak_potensial:"-"}
                                                ${Array.isArray(T.dampak_potensial)&&T.dampak_potensial.length>1?`<br><span class="text-muted">+${T.dampak_potensial.length-1} dampak lainnya</span>`:""}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-${j}">
                                                <i class="fas ${K}"></i>
                                                ${G==="aman"?"AMAN":"PERHATIAN"}
                                            </span>
                                        </td>
                                    </tr>
                                `}).join("")}
                        </tbody>
                    </table>
                </div>
            </div>
        `,D=()=>u.length===0?"":`
            <div class="mb-4">
                <h6 class="text-warning mb-3"><i class="fas fa-map-marker-alt"></i> Lokasi dengan Sampah Berbahaya</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-warning">
                            <tr>
                                <th>#</th>
                                <th>Lokasi</th>
                                <th class="text-end">Limbah B3</th>
                                <th class="text-end">Plastik</th>
                                <th class="text-end">Total</th>
                                <th>Tingkat Risiko</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${u.slice(0,5).map((T,N)=>{var j,K;const z=T.tingkat_risiko==="tinggi"?"danger":"warning",G=T.lokasi||T.wilayah||"Lokasi Tidak Diketahui";return`
                                    <tr>
                                        <td>${N+1}</td>
                                        <td>
                                            <strong>${G}</strong>
                                            ${T.koordinat?`<div class="small text-muted">
                                                    <i class="fas fa-map-pin"></i> 
                                                    ${((j=T.koordinat.lat)==null?void 0:j.toFixed(4))||"?"}, ${((K=T.koordinat.lon)==null?void 0:K.toFixed(4))||"?"}
                                                </div>`:""}
                                            ${T.alamat_samples&&Array.isArray(T.alamat_samples)&&T.alamat_samples.length>0?`<div class="small text-muted">Alamat: 	${T.alamat_samples[0]}</div>`:""}
                                        </td>
                                        <td class="text-end">
                                            ${T.b3>0?`<span class="badge bg-danger">${T.b3}</span>`:'<span class="text-muted">-</span>'}
                                        </td>
                                        <td class="text-end">
                                            ${T.plastik>0?`<span class="badge bg-warning">${T.plastik}</span>`:'<span class="text-muted">-</span>'}
                                        </td>
                                        <td class="text-end fw-bold">${T.total_berbahaya||T.total||0}</td>
                                        <td>
                                            <span class="badge bg-${z}">
                                                ${T.tingkat_risiko==="tinggi"?"TINGGI":"SEDANG"}
                                            </span>
                                        </td>
                                    </tr>
                                `}).join("")}
                        </tbody>
                    </table>
                </div>
                ${u.length>5?`<p class="small text-muted mt-2">
                        <i class="fas fa-info-circle"></i> Menampilkan 5 dari ${u.length} lokasi berbahaya
                    </p>`:""}
            </div>
        `,U=()=>!g||g.total_laporan_berbahaya===0?"":`
            <div class="mb-4">
                <h6 class="text-info mb-3"><i class="fas fa-clock"></i> Waktu Penanganan Sampah Berbahaya</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-light">
                            <div class="row">
                                <div class="col-6">
                                    <p class="small mb-1">
                                        <i class="fas fa-list"></i> <strong>Total Laporan</strong><br>
                                        <span class="fs-5 fw-bold">${g.total_laporan_berbahaya}</span>
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p class="small mb-1">
                                        <i class="fas fa-check-circle text-success"></i> <strong>Selesai</strong><br>
                                        <span class="fs-5 fw-bold">${g.selesai||0}</span>
                                    </p>
                                </div>
                                <div class="col-12 mt-2">
                                    <p class="small mb-1">
                                        <i class="fas fa-clock"></i> <strong>Rata-rata waktu</strong><br>
                                        <span class="fs-5 fw-bold">${g.rata_waktu_penanganan_hari||0}</span> hari
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-light">
                            <p class="small mb-2">
                                <i class="fas fa-chart-line"></i> <strong>Tingkat Penanganan</strong>
                            </p>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: ${g.tingkat_penanganan||0}%">
                                </div>
                            </div>
                            <p class="small text-center mt-1">
                                ${g.tingkat_penanganan||0}%
                            </p>
                            ${g.rata_waktu_penanganan_hari>7?`
                                <p class="small text-danger mb-0">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Waktu penanganan melebihi 7 hari, perlu perbaikan respons time
                                </p>
                            `:""}
                        </div>
                    </div>
                </div>
            </div>
        `,da=()=>{if(h.length===0)return'<div class="alert alert-warning mb-4"><i class="fas fa-exclamation-triangle"></i> Tidak ada data klasifikasi sampah</div>';const T=h.find(K=>K.jenis==="plastik"),N=h.find(K=>K.jenis==="b3"),z=h.find(K=>K.jenis==="organik"),G=h.reduce((K,H)=>K+(H.jumlah||0),0);let j="";return N&&N.jumlah>0&&(j+=`
                <p class="mb-2">
                    <i class="fas fa-radiation text-danger"></i> 
                    <strong>Limbah B3:</strong> ${N.jumlah} laporan (${N.persentase}%)<br>
                    <span class="text-danger small">â€¢ Penanganan khusus diperlukan</span>
                </p>
            `),T&&(T.persentase>30?j+=`
                    <p class="mb-2">
                        <i class="fas fa-exclamation-triangle text-warning"></i> 
                        <strong>Plastik Tinggi:</strong> ${T.persentase}%<br>
                        <span class="text-warning small">â€¢ Perlu program daur ulang</span>
                    </p>
                `:T.persentase>0&&(j+=`
                    <p class="mb-2">
                        <i class="fas fa-check-circle text-success"></i> 
                        <strong>Plastik:</strong> ${T.persentase}% (wajar)
                    </p>
                `)),z&&z.persentase>40&&(j+=`
                <p class="mb-2">
                    <i class="fas fa-leaf text-success"></i> 
                    <strong>Organik Dominan:</strong> ${z.persentase}%<br>
                    <span class="text-success small">â€¢ Potensi pengomposan tinggi</span>
                </p>
            `),j+=`
            <hr>
            <p class="mb-0">
                <i class="fas fa-percentage"></i> 
                <strong>Total Terklasifikasi:</strong> ${G} laporan<br>
                <i class="fas fa-database"></i> 
                <strong>Data Terstruktur:</strong> ${f.toFixed(1)}%
            </p>
        `,`
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Distribusi Jenis Sampah</h5>
                        <div>
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-database"></i> ${f.toFixed(1)}% data terstruktur
                            </span>
                            <span class="badge ${f>50?"bg-success":"bg-warning"}">
                                ${f>50?"Data Baik":"Perlu Perbaikan"}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Jenis Sampah</th>
                                            <th class="text-end">Jumlah</th>
                                            <th class="text-end">Persentase</th>
                                            <th class="text-end">Data Valid</th>
                                            <th>Status Data</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${h.map(K=>{const H=K.persentase||0;let O=K.jenis||"tidak_dikenali";O==="b3"?O="Limbah B3":O==="plastik"?O="Plastik":O==="organik"?O="Organik":O==="kertas"?O="Kertas":O==="logam"?O="Logam":O==="kaca"?O="Kaca":O==="campuran"?O="Campuran":O==="tidak_terdeteksi"?O="Tidak Terdeteksi":O=O.charAt(0).toUpperCase()+O.slice(1);const os=C(K.jenis),mi=K.data_valid||0;return`
                                                <tr>
                                                    <td>
                                                        <span class="badge" style="background-color: ${os}; color: white;">
                                                            ${O}
                                                        </span>
                                                    </td>
                                                    <td class="text-end fw-bold">${K.jumlah||0}</td>
                                                    <td class="text-end">
                                                        <div class="progress" style="height: 10px; width: 80px; margin-left: auto;">
                                                            <div class="progress-bar" 
                                                                 style="width: ${H}%; background-color: ${os};">
                                                            </div>
                                                        </div>
                                                        <span class="small">${H.toFixed(1)}%</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <span class="badge bg-info">${mi}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge ${mi>0?"bg-success":"bg-warning"}">
                                                            ${mi>0?"Valid":"Perlu Verifikasi"}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `}).join("")}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-light h-100">
                                <h6><i class="fas fa-info-circle"></i> Analisis Komposisi</h6>
                                <div class="small">
                                    ${j}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `},Fa=()=>w.length===0&&$.length===0?"":`
            <div class="row mb-4">
                ${w.length>0?`
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 5 Wilayah Terkotor</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Wilayah</th>
                                                <th class="text-end">Laporan</th>
                                                <th class="text-end">Selesai</th>
                                                <th class="text-end">Skor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${w.map((T,N)=>`
                                                <tr>
                                                    <td>${N+1}</td>
                                                    <td>
                                                        <span class="badge bg-danger">${T.wilayah||"Tidak Diketahui"}</span>
                                                    </td>
                                                    <td class="text-end">${T.total_laporan||0}</td>
                                                    <td class="text-end">
                                                        <span class="badge ${T.tingkat_penyelesaian>50?"bg-success":"bg-warning"}">
                                                            ${T.tingkat_penyelesaian||0}%
                                                        </span>
                                                    </td>
                                                    <td class="text-end fw-bold" style="color: #e74c3c;">
                                                        ${T.skor_kebersihan||0}
                                                    </td>
                                                </tr>
                                            `).join("")}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `:""}
                
                ${$.length>0?`
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-trophy"></i> 5 Wilayah Terbersih</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Wilayah</th>
                                                <th class="text-end">Laporan</th>
                                                <th class="text-end">Selesai</th>
                                                <th class="text-end">Skor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${$.map((T,N)=>`
                                                <tr>
                                                    <td>${N+1}</td>
                                                    <td>
                                                        <span class="badge bg-success">${T.wilayah||"Tidak Diketahui"}</span>
                                                    </td>
                                                    <td class="text-end">${T.total_laporan||0}</td>
                                                    <td class="text-end">
                                                        <span class="badge ${T.tingkat_penyelesaian>50?"bg-success":"bg-warning"}">
                                                            ${T.tingkat_penyelesaian||0}%
                                                        </span>
                                                    </td>
                                                    <td class="text-end fw-bold" style="color: #27ae60;">
                                                        ${T.skor_kebersihan||0}
                                                    </td>
                                                </tr>
                                            `).join("")}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `:""}
            </div>
        `,Ha=()=>y.length===0?"":`
            <div class="card mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #6f42c1, #9b6bff); color: white;">
                    <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Rekomendasi Aksi Prioritas</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        ${y.map((T,N)=>{const z=T.prioritas==="sangat_tinggi"?"danger":T.prioritas==="tinggi"?"warning":T.prioritas==="sedang"?"primary":"success",G=T.prioritas==="sangat_tinggi"?"fa-exclamation-triangle":T.prioritas==="tinggi"?"fa-exclamation-circle":T.prioritas==="sedang"?"fa-info-circle":"fa-check-circle",j=T.prioritas==="sangat_tinggi"?"SANGAT TINGGI":T.prioritas==="tinggi"?"TINGGI":T.prioritas==="sedang"?"SEDANG":"RENDAH";return`
                                <div class="col-md-6">
                                    <div class="card border-${z} h-100 shadow-sm">
                                        <div class="card-header bg-${z} text-white py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas ${G} me-2"></i>
                                                    <span class="small fw-bold">${N+1}. ${T.kategori||"Umum"}</span>
                                                </div>
                                                <span class="badge bg-light text-dark">${j}</span>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text fw-bold">${T.rekomendasi||"Tidak ada rekomendasi"}</p>
                                            <div class="small text-muted">
                                                <i class="fas fa-bullseye"></i> 
                                                <strong>Alasan:</strong> ${T.alasan||"Tidak tersedia"}
                                            </div>
                                            ${T.sumber_data?`
                                                <div class="small mt-2">
                                                    <i class="fas fa-database"></i> 
                                                    <strong>Sumber data:</strong> 
                                                    <span class="badge bg-secondary">${T.sumber_data}</span>
                                                </div>
                                            `:""}
                                        </div>
                                    </div>
                                </div>
                            `}).join("")}
                    </div>
                </div>
            </div>
        `,ca=()=>{if(!l.labels||l.labels.length===0)return"";const T=l.total_laporan?l.total_laporan.reduce((G,j)=>G+j,0):0,N=T/l.labels.length;let z="-";if(l.total_laporan&&l.total_laporan.length>0){const G=l.total_laporan.indexOf(Math.max(...l.total_laporan)),j=Math.max(...l.total_laporan);z=`
                <strong>${l.labels[G]||"-"}</strong><br>
                <span class="text-primary">${j} laporan</span>
            `}return`
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Analisis Tren Waktu</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <p class="small mb-1">
                                    <i class="fas fa-calendar-check"></i> 
                                    <strong>Periode:</strong> ${l.labels.length} hari
                                </p>
                            </div>
                            <div class="col-6 text-end">
                                <p class="small mb-1">
                                    <strong>Total:</strong> ${T}
                                </p>
                            </div>
                        </div>
                        
                        <div class="alert alert-light">
                            <div class="row">
                                <div class="col-6">
                                    <p class="small mb-1">
                                        <i class="fas fa-chart-bar"></i> 
                                        <strong>Rata-rata/hari:</strong>
                                    </p>
                                    <h4 class="text-primary">
                                        ${N.toFixed(1)}
                                    </h4>
                                    <p class="small text-muted mb-0">laporan</p>
                                </div>
                                <div class="col-6">
                                    <p class="small mb-1">
                                        <i class="fas fa-calendar-day"></i> 
                                        <strong>Hari terpadat:</strong>
                                    </p>
                                    <div class="small">
                                        ${z}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `},fa=`
        <div class="dampak-lingkungan-report">
            <div class="report-header mb-4">
                <h4><i class="fas fa-leaf text-success"></i> Analisis Dampak Lingkungan</h4>
                <p class="text-muted">
                    <i class="fas fa-calendar"></i> Periode: ${A(a==null?void 0:a.start_date)} - ${A(a==null?void 0:a.end_date)}
                    <span class="ms-3 badge ${E(m.tingkat_risiko)}">
                        <i class="fas fa-chart-bar"></i> Tingkat Risiko: ${m.tingkat_risiko||"Belum Dianalisis"}
                    </span>
                </p>
            </div>
            
            <!-- Summary Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-primary">${i}</div>
                        <div class="stat-label">Total Laporan</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value text-success">${s}</div>
                        <div class="stat-label">Laporan Selesai</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" style="color: #e74c3c;">${n.toFixed(1)}%</div>
                        <div class="stat-label">Tingkat Penyelesaian</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f39c12;">
                            ${m.total_peringatan||0}
                        </div>
                        <div class="stat-label">Peringatan Lingkungan</div>
                    </div>
                </div>
            </div>
            
            <!-- DAMPAK LINGKUNGAN SECTION -->
            <div class="card mb-4 ${c.length>0?"border-danger":"border-success"}">
                <div class="card-header ${c.length>0?"bg-danger text-white":"bg-success text-white"}">
                    <h5 class="mb-0">
                        <i class="fas ${c.length>0?"fa-exclamation-triangle":"fa-check-circle"}"></i> 
                        Analisis Dampak Lingkungan
                        ${m.total_jenis_berbahaya>0?`<span class="badge bg-warning ms-2">${m.total_jenis_berbahaya} jenis berbahaya</span>`:""}
                    </h5>
                </div>
                <div class="card-body">
                    ${B()}
                    ${I()}
                    ${D()}
                    ${U()}
                </div>
            </div>
            
            ${da()}
            ${Fa()}
            ${Ha()}
            
            <!-- Efektivitas & Tren -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Efektivitas Penanganan</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column gap-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Total Laporan</span>
                                    <span class="fw-bold fs-5">${o.total_laporan||0}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-check-circle text-success me-1"></i>
                                        Selesai
                                    </span>
                                    <span class="badge bg-success fs-6">${o.laporan_selesai||0}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-clock text-warning me-1"></i>
                                        Pending
                                    </span>
                                    <span class="badge bg-warning fs-6">${o.laporan_pending||0}</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Tingkat Penyelesaian</span>
                                    <div class="progress flex-grow-1 mx-2" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${o.tingkat_penyelesaian||0}%">
                                        </div>
                                    </div>
                                    <span class="fw-bold fs-5">${o.tingkat_penyelesaian?o.tingkat_penyelesaian.toFixed(1):0}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${ca()}
            </div>

            <!-- ===== TAMBAHKAN TOMBOL EXPORT DI SINI ===== -->
            ${Oe("dampak-lingkungan",a)}
            
            <!-- Footer -->
            <div class="mt-4 pt-3 border-top text-muted small">
                <div class="row">
                    <div class="col-md-6">
                        <div>
                            <i class="fas fa-chart-pie"></i> 
                            <strong>Analisis Lengkap:</strong> 
                            Berdasarkan ${i} laporan sampah
                        </div>
                        <div class="mt-1">
                            <i class="fas fa-clock"></i> 
                            <strong>Dibuat:</strong> ${new Date().toLocaleString("id-ID")}
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div>
                            <i class="fas fa-database"></i> 
                            <strong>Kualitas Data:</strong> 
                            <span class="badge ${f>50?"bg-success":"bg-warning"}">
                                ${f>50?"Baik":"Perlu Perbaikan"}
                            </span>
                            <span class="ms-2">(${f.toFixed(1)}% terstruktur)</span>
                        </div>
                        <div class="mt-1">
                            <i class="fas fa-exclamation-circle"></i> 
                            <strong>Peringatan:</strong> 
                            <span class="badge ${m.total_peringatan>0?"bg-danger":"bg-success"}">
                                ${m.total_peringatan||0}
                            </span>
                            <span class="ms-2">Risiko: ${m.tingkat_risiko||"Belum Dianalisis"}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;t.innerHTML=fa}function It(e){return{selesai:"#27ae60",proses:"#3498db",pending:"#f39c12",dibatalkan:"#e74c3c",jadwal_ulang:"#9b59b6",completed:"#27ae60",in_progress:"#3498db",pending:"#f39c12",cancelled:"#e74c3c",rescheduled:"#9b59b6"}[e.toLowerCase()]||"#7f8c8d"}window.loadReport=Sn;window.loadUserStatsReport=An;window.applyFilter=Jt;window.generateMonthlyReport=Oi;window.handleExport=Mt;window.exportReport=oi;window.handleExportWithFilters=Tn;window.handleExportButtonClick=Hr;window.renderUserStatsReport=Ki;window.renderKeuanganReport=Pn;window.renderAnggotaReport=Bn;window.renderLaporanSampahReport=Mn;window.renderJadwalReport=In;window.renderMonthlyReport=qi;window.renderDampakLingkunganReport=Cn;window.formatRupiah=at;window.formatDate=La;window.getStatusColor=It;window.checkExportCapabilities=Ur;async function Gr(){const e=document.getElementById("mainContent");e.innerHTML=`
    <div class="container-fluid">
      <h2 class="text-success mb-4">Push Subscription</h2>

      <div class="card border-success">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Subscription Aktif</h5>
        </div>
        <div class="card-body" id="subTableContainer">
          <div class="spinner-border text-success"></div>
        </div>
      </div>
    </div>
  `,Dn()}async function Dn(){try{const e=await M(b.pushSubscriptions,{headers:v()}),a=e.results||e.data||e;Jr(a)}catch(e){document.getElementById("subTableContainer").innerHTML=`<div class="alert alert-danger">${e.message}</div>`}}function Jr(e){const a=document.getElementById("subTableContainer");if(!e.length){a.innerHTML='<div class="alert alert-info">Belum ada subscription</div>';return}a.innerHTML=`
    <table class="table table-hover">
      <thead class="table-success">
        <tr>
          <th>No</th>
          <th>ID</th>
          <th>User</th>
          <th>Endpoint</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        ${e.map((t,i)=>`
          <tr>
            <td>${i+1}</td>
            <td>${t.id}</td>
            <td class="text-truncate" style="max-width:300px">${t.user_username}</td>
            <td class="text-truncate" style="max-width:300px">${t.endpoint}</td>
            <td>
              <button class="btn btn-sm btn-danger"
                onclick="deleteSub(${t.id})">
                Hapus
              </button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `,window.deleteSub=Rr}async function Rr(e){pe("Yakin ingin menghapus subscription ini?",async()=>{await M(`${b.pushSubscriptions}${e}/`,{method:"DELETE",headers:v()}),x("Subscription dihapus","success"),Dn()})}class zr{constructor(){this.publicKey=null,this.isSubscribed=!1,this.registration=null,this.subscription=null,this.isSupported="serviceWorker"in navigator&&"PushManager"in window}urlBase64ToUint8Array(a){const t="=".repeat((4-a.length%4)%4),i=(a+t).replace(/-/g,"+").replace(/_/g,"/"),s=atob(i),n=new Uint8Array(s.length);for(let o=0;o<s.length;++o)n[o]=s.charCodeAt(o);return n}async requestNotificationPermission(){if(!("Notification"in window))throw new Error("Browser ini tidak mendukung notifikasi");if(Notification.permission==="granted")return!0;if(Notification.permission==="denied")throw new Error("Izin notifikasi telah ditolak. Harap aktifkan manual di pengaturan browser.");return await Notification.requestPermission()==="granted"}async registerServiceWorker(){if(!this.isSupported)throw new Error("Browser ini tidak mendukung Service Worker");try{if(navigator.serviceWorker.controller)return console.log("Service Worker sudah aktif"),this.registration=await navigator.serviceWorker.getRegistration(),this.registration;if(this.registration=await navigator.serviceWorker.register("/service-worker.js",{scope:"/"}),console.log("Service Worker registered:",this.registration),this.registration.active)return console.log("Service Worker aktif"),this.registration;const a=this.registration.installing||this.registration.waiting||this.registration.active;return a?await new Promise((t,i)=>{const s=()=>{console.log("Service Worker state:",a.state),a.state==="activated"?(a.removeEventListener("statechange",s),t()):a.state==="redundant"&&(a.removeEventListener("statechange",s),i(new Error("Service Worker menjadi redundant")))};a.addEventListener("statechange",s),a.state==="activated"&&t(),setTimeout(()=>{a.removeEventListener("statechange",s),i(new Error("Timeout menunggu Service Worker aktif"))},1e4)}):console.warn("Tidak ada Service Worker instance yang ditemukan"),this.registration}catch(a){throw console.error("Gagal register Service Worker:",a),a}}async getPublicKey(){if(this.publicKey)return console.log("ðŸ“‹ Using cached VAPID key"),this.publicKey;try{console.log("ðŸ”‘ Fetching VAPID key...");const a=[{url:b.vapidKeyPublic,method:"GET",headers:{"Content-Type":"application/json"},requiresAuth:!1,description:"Public VAPID endpoint"},{url:b.pushSubscriptionsVapidKey,method:"GET",headers:{"Content-Type":"application/json"},requiresAuth:!0,description:"PushSubscription viewset endpoint"},{url:b.pushSubscriptionsVapidKey,method:"GET",headers:{"Content-Type":"application/json"},requiresAuth:!1,description:"Viewset endpoint without auth"}];let t=null,i=null,s=[];for(const l of a)try{console.log(`   Trying: ${l.description} (${l.url})`);let r={...l.headers};if(l.requiresAuth){const c=v();r={...r,...c}}if(t=await fetch(l.url,{method:l.method,headers:r,credentials:l.requiresAuth?"include":"omit"}),console.log(`   Response: ${t.status} ${t.statusText}`),t.ok){i=l,console.log(`âœ… Success with: ${l.description}`);break}else{const c=await t.text();s.push({endpoint:l.url,status:t.status,error:c.substring(0,100)}),console.log(`   Failed: ${t.status} - ${c.substring(0,50)}...`)}}catch(r){s.push({endpoint:l.url,error:r.message}),console.log(`   Error: ${r.message}`);continue}if(!t||!t.ok){console.warn("âš ï¸ All VAPID endpoints failed:",s);try{if(console.log("ðŸ”„ Trying direct localhost URL..."),t=await fetch("http://127.0.0.1:8000/api/vapid-key/",{method:"GET",headers:{"Content-Type":"application/json"}}),t.ok)console.log("âœ… Success with direct URL");else throw new Error(`Direct URL failed: ${t.status}`)}catch{return console.log("âŒ Direct URL also failed"),console.log("ðŸ”„ Using hardcoded fallback VAPID key"),this.publicKey=this.FALLBACK_PUBLIC_KEY,localStorage.setItem("vapid_public_key",this.publicKey),this.publicKey}}const n=await t.json();console.log("ðŸ“Š VAPID response:",n);let o=null;if(n.public_key)o=n.public_key;else if(n.publicKey)o=n.publicKey;else if(n.key)o=n.key;else if(typeof n=="string")o=n;else if(n.public_key_base64)o=n.public_key_base64;else throw console.error("âŒ Unknown VAPID key format:",n),new Error("Format VAPID key tidak dikenal dalam response");if(!o)throw new Error("Public key tidak ditemukan dalam response");return o=o.trim(),(o.length<80||o.length>100)&&console.warn(`âš ï¸ VAPID key length suspicious: ${o.length} chars`),this.publicKey=o,console.log(`âœ… VAPID public key berhasil didapatkan (${o.length} chars)`),localStorage.setItem("vapid_public_key",o),localStorage.setItem("vapid_source",(i==null?void 0:i.url)||"unknown"),this.publicKey}catch(a){console.error("âŒ Gagal mendapatkan VAPID public key:",a);try{const t=localStorage.getItem("vapid_public_key");if(t&&t.length>80)return console.log("ðŸ”„ Using cached VAPID key from localStorage"),this.publicKey=t,this.publicKey}catch{console.log("   Could not read from localStorage")}return console.log("ðŸ”„ Using hardcoded fallback VAPID key"),this.publicKey=this.FALLBACK_PUBLIC_KEY,this.publicKey}}async subscribe(){this.registration||await this.registerServiceWorker();const a=await this.getPublicKey();try{return this.subscription=await this.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(a)}),this.subscription}catch(t){throw console.error("Gagal subscribe push notifications:",t),t.name==="NotAllowedError"?new Error("Izin ditolak. Harap aktifkan notifikasi di pengaturan browser."):t}}convertSubscriptionToData(a){const t=a.getKey("p256dh"),i=a.getKey("auth");return{endpoint:a.endpoint,p256dh:t?btoa(String.fromCharCode(...new Uint8Array(t))):null,auth:i?btoa(String.fromCharCode(...new Uint8Array(i))):null}}async saveSubscription(a){const t=a.getKey("p256dh"),i=a.getKey("auth");if(!t||!i)return console.warn("âŒ Subscription key tidak lengkap, batal simpan"),!1;const s={endpoint:a.endpoint,p256dh:btoa(String.fromCharCode(...new Uint8Array(t))),auth:btoa(String.fromCharCode(...new Uint8Array(i)))},n=await fetch(b.pushSubscriptions,{method:"POST",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify(s)});if(!n.ok){const o=await n.text();throw new Error(`Gagal menyimpan subscription: ${n.status} - ${o}`)}return console.log("âœ… Subscription berhasil disimpan"),!0}async getSubscriptions(){try{const a=await fetch(b.pushSubscriptions,{headers:v()});if(!a.ok)throw new Error(`Gagal mendapatkan subscriptions: ${a.status}`);return await a.json()}catch(a){throw console.error("Gagal mendapatkan subscriptions:",a),a}}async unsubscribe(){if(!this.registration)return;const a=await this.registration.pushManager.getSubscription();if(a){await a.unsubscribe();try{const i=(await this.getSubscriptions()).find(s=>s.endpoint===a.endpoint);if(i){const s=await fetch(`${b.pushSubscriptions}${i.id}/`,{method:"DELETE",headers:v()});s.ok||console.warn("Gagal menghapus subscription dari server:",s.status)}}catch(t){console.error("Gagal menghapus subscription dari server:",t)}this.subscription=null,this.isSubscribed=!1}}async checkSubscription(){if(!this.registration)return!1;const a=await this.registration.pushManager.getSubscription();return this.subscription=a,this.isSubscribed=!!a,this.isSubscribed}async initialize(){if(!this.isSupported)return console.log("Web push tidak didukung di browser ini"),!1;try{if(await this.registerServiceWorker(),await this.checkSubscription(),this.isSubscribed&&this.subscription)try{await this.saveSubscription(this.subscription)}catch(a){console.warn("Gagal update subscription ke server:",a)}return console.log("Web Push initialized. Subscribed:",this.isSubscribed),!0}catch(a){return console.error("Gagal initialize web push:",a),!1}}async enableNotifications(){try{if(!await this.requestNotificationPermission())throw new Error("Izin notifikasi ditolak");const t=await this.subscribe();return await this.saveSubscription(t),this.isSubscribed=!0,this.subscription=t,{success:!0,message:"Notifikasi berhasil diaktifkan"}}catch(a){return{success:!1,message:a.message}}}async disableNotifications(){try{return await this.unsubscribe(),this.isSubscribed=!1,{success:!0,message:"Notifikasi berhasil dinonaktifkan"}}catch(a){return{success:!1,message:a.message}}}async sendTestNotification(){try{if(!await this.checkSubscription())return{success:!1,message:"Anda belum berlangganan notifikasi. Silakan aktifkan terlebih dahulu."};console.log("ðŸ§ª Sending test notification...");const t=v();if(!t.Authorization&&!t["X-CSRFToken"])return console.warn("âš ï¸ No authentication credentials found"),{success:!1,message:"Sesi login telah habis. Silakan login ulang."};console.log("ðŸ“¤ Sending request to:",b.pushSubscriptionsTest),console.log("ðŸ”‘ Auth headers:",t);const i=await fetch(b.pushSubscriptionsTest,{method:"POST",headers:{...t,"Content-Type":"application/json"},body:JSON.stringify({title:"Test Notifikasi - Admin",body:"Ini adalah notifikasi test dari panel admin CleanUp",type:"test",icon:"/icon-192.png",badge:"/badge-72.png",timestamp:new Date().toISOString()}),credentials:"include"});console.log("ðŸ“¥ Test notification response status:",i.status);let s;try{const n=await i.text();console.log("ðŸ“‹ Response text:",n),n&&(s=JSON.parse(n))}catch(n){console.error("âŒ Cannot parse response:",n)}if(!i.ok){let n=`HTTP ${i.status}: Gagal mengirim test notification`;throw s&&(s.message?n=s.message:s.detail&&(n=s.detail)),i.status===500&&(n+=" (Server error - check Django logs)"),new Error(n)}if(console.log("âœ… Test notification response:",s),Notification.permission==="granted"&&s&&s.success){const n=new Notification("âœ… Test Berhasil - CleanUp Admin",{body:"Notifikasi test berhasil dikirim!",icon:"/icon-192.png",badge:"/badge-72.png",tag:"test-notification-success"});n.onclick=()=>{window.focus(),n.close()}}return{success:!0,message:(s==null?void 0:s.message)||"Notifikasi test berhasil dikirim",data:s}}catch(a){return console.error("âŒ Error sending test notification:",a),{success:!1,message:a.message||"Gagal mengirim notifikasi test"}}}async hasSubscription(){try{return(await this.getSubscriptions()).length>0}catch(a){return console.error("Error checking subscription:",a),!1}}setupPushEventListener(){this.registration&&navigator.serviceWorker.addEventListener("message",a=>{a.data&&a.data.type==="NOTIFICATION_CLICKED"&&this.handleNotificationClick(a.data)})}handleNotificationClick(a){switch(console.log("Notification clicked:",a),a.type){case"payment_update":window.location.href=`/pembayaran/${a.pembayaran_id||""}`;break;case"pickup_update":window.location.href=`/jadwal/${a.jadwal_id||""}`;break;default:window.location.href=a.url||"/"}}}const Z=new zr;class Or{constructor(){this.notificationSubscription=null,this.unreadNotifications=0,this.notificationInterval=null,this.lastNotificationCheck=null,this.webPushInitialized=!1,this.user=null}async initialize(){try{if(console.log("ðŸ”” Initializing Admin Notifications..."),this.user=JSON.parse(localStorage.getItem("user")||"{}"),this.user.role!=="admin")return console.log(`â„¹ï¸ User role ${this.user.role} doesn't need admin notifications`),!1;if(!Z.isSupported)return console.log("âš ï¸ Web Push not supported in this browser"),this.updateNotificationUI("not-supported"),!1;try{await Z.initialize(),this.webPushInitialized=!0,Z.setupPushEventListener(),console.log("âœ… Web Push initialized for admin")}catch(t){return console.error("Web Push init failed:",t),this.updateNotificationUI("service-worker-error"),!1}const a=await Z.checkSubscription();return a?(console.log("âœ… Admin is subscribed to push notifications"),this.notificationSubscription=Z.subscription,await this.updateUnreadNotificationsCount(),await this.updateNotificationUI("subscribed"),this.startNotificationPolling()):(console.log("â„¹ï¸ Admin is not subscribed to push notifications"),await this.updateNotificationUI("unsubscribed")),a}catch(a){return console.error("âŒ Error initializing admin notifications:",a),this.updateNotificationUI("error"),!1}}async enableNotifications(){try{if(console.log("ðŸ”„ Enabling admin notifications..."),JSON.parse(localStorage.getItem("user")||"{}").role!=="admin")return x("error","Hanya admin yang dapat mengaktifkan notifikasi"),!1;if(this.updateNotificationUI("loading"),!Z.isSupported)throw new Error("Browser tidak mendukung Web Push Notifications");if(Notification.permission==="denied")throw new Error("Permission untuk notifikasi telah ditolak. Mohon aktifkan di pengaturan browser.");if(Notification.permission==="default"&&await Notification.requestPermission()!=="granted")throw new Error("Izin notifikasi ditolak oleh pengguna");const t=await Z.enableNotifications();return t.success?(console.log("âœ… Admin notifications enabled successfully"),this.notificationSubscription=Z.subscription,await this.updateNotificationUI("subscribed"),this.startNotificationPolling(),x("success","Notifikasi admin telah diaktifkan!"),!0):(console.error("âŒ Failed to enable admin notifications:",t.error),await this.updateNotificationUI("error"),x("error","Gagal mengaktifkan notifikasi"),!1)}catch(a){console.error("âŒ Error enabling admin notifications:",a);let t="Terjadi kesalahan saat mengaktifkan notifikasi",i="error";return a.message.includes("Permission")||a.message.includes("Izin")?(t="Izin notifikasi ditolak. Mohon aktifkan di pengaturan browser.",i="permission-denied"):a.message.includes("Service Worker")?(t="Service Worker tidak tersedia. Pastikan Anda mengakses melalui HTTPS.",i="service-worker-error"):(a.message.includes("VAPID")||a.message.includes("fetch"))&&(t="Server notifikasi tidak dapat dijangkau. Coba lagi nanti.",i="server-unavailable"),await this.updateNotificationUI(i),x("error",t),!1}}async disableNotifications(){try{console.log("ðŸ”„ Disabling admin notifications..."),this.updateNotificationUI("loading");const a=await Z.disableNotifications();return a.success?(console.log("âœ… Admin notifications disabled successfully"),this.notificationSubscription=null,this.unreadNotifications=0,this.stopNotificationPolling(),await this.updateNotificationUI("unsubscribed"),x("info","Notifikasi admin telah dinonaktifkan"),!0):(console.error("âŒ Failed to disable admin notifications:",a.error),await this.updateNotificationUI("error"),x("error","Gagal menonaktifkan notifikasi"),!1)}catch(a){return console.error("âŒ Error disabling admin notifications:",a),await this.updateNotificationUI("error"),x("error","Terjadi kesalahan saat menonaktifkan notifikasi"),!1}}async toggleNotifications(){try{return await Z.checkSubscription()?await this.disableNotifications():await this.enableNotifications(),!0}catch(a){return console.error("âŒ Error toggling admin notifications:",a),x("error","Gagal mengubah pengaturan notifikasi"),!1}}async fetchNotifications(){var a,t;try{console.log("ðŸ“¥ Fetching admin notifications...");const i=v(),s=b.notifications;if(!s)return console.error("Notification API endpoint not configured"),this.getMockNotifications();const n=new URLSearchParams({user:((a=this.user)==null?void 0:a.id)||"",user_role:"admin",notification_type:"payment,report,alert,system",limit:"30",ordering:"-created_at"}),o=`${s}?${n}`;console.log(`Fetching from: ${o}`);const l=await fetch(o,{headers:i,credentials:"include"});if(!l.ok){if(l.status>=500)return console.error("Server error - menggunakan mock notifications"),this.getMockNotifications();throw new Error(`HTTP ${l.status}: Server error`)}const r=await l.json();let c=[];return Array.isArray(r)?c=r:r&&r.results?c=r.results:r&&r.notifications&&(c=r.notifications),console.log(`ðŸ“Š Received ${c.length} notifications for admin ${((t=this.user)==null?void 0:t.username)||"admin"}`),this.unreadNotifications=c.filter(d=>!d.read).length,this.lastNotificationCheck=new Date,this.updateNotificationBadge(),c}catch(i){return console.error("âŒ Error fetching admin notifications:",i.message),this.getMockNotifications()}}async checkForNewNotifications(){try{if(!navigator.onLine)return console.log("ðŸŒ Offline - Skipping notification check"),[];const a=await this.fetchNotifications(),t=new Date(Date.now()-5*60*1e3),i=a.filter(s=>{try{return new Date(s.created_at||s.timestamp||Date.now())>t}catch{return!1}});return i.length>0&&Notification.permission==="granted"&&i.forEach(s=>{(s.priority==="high"||s.notification_type==="alert")&&this.showDesktopNotification(s)}),i}catch(a){return console.error("âŒ Error checking for new notifications:",a),[]}}async updateUnreadNotificationsCount(){try{const a=await this.fetchNotifications();this.unreadNotifications=a.filter(t=>!t.read).length,this.updateNotificationBadge()}catch(a){console.error("Error updating unread count:",a)}}async markAllNotificationsAsRead(){try{if(console.log("ðŸ“ Marking all admin notifications as read..."),!this.user||!this.user.id)throw new Error("User not found");const a=v(),t=b.notificationsMarkAllRead||`${b.notifications}mark-all-read/`;console.log("Using URL:",t);const i=await fetch(t,{method:"POST",headers:{...a,"Content-Type":"application/json"},credentials:"include"});if(console.log("Response status:",i.status),!i.ok){const n=await i.text();throw console.error("Error response:",n),new Error(`HTTP ${i.status}`)}const s=await i.json();return console.log("Response data:",s),this.unreadNotifications=0,this.updateNotificationBadge(),x("success",`Semua notifikasi (${s.count||0}) telah ditandai sebagai dibaca`),!0}catch(a){console.error("Error marking all notifications as read:",a);try{console.log("ðŸ”„ Trying fallback: marking individual notifications...");const i=(await this.fetchNotifications()).filter(s=>!s.read);if(i.length>0){const s=v();for(const n of i)try{const o=`${b.notifications}${n.id}/mark_read/`;await fetch(o,{method:"POST",headers:s,credentials:"include"})}catch(o){console.warn(`Failed to mark notification ${n.id} as read:`,o.message)}}return this.unreadNotifications=0,this.updateNotificationBadge(),x("success","Semua notifikasi telah ditandai sebagai dibaca (fallback)"),!0}catch(t){return console.error("Fallback also failed:",t),this.unreadNotifications=0,this.updateNotificationBadge(),x("info","Notifikasi ditandai sebagai dibaca secara lokal"),!0}}}async markNotificationAsRead(a){try{console.log(`ðŸ“ Marking admin notification ${a} as read...`);const t=v();if(b.notifications){const i=b.notifications.endsWith("/")?`${b.notifications}${a}/mark_read/`:`${b.notifications}/${a}/mark_read/`;try{(await fetch(i,{method:"POST",headers:t,credentials:"include"})).ok?console.log(`âœ… Server: Notification ${a} marked as read`):console.warn(`âš ï¸ Server: Failed to mark notification ${a} as read`)}catch(s){console.warn("Server update failed, using local only:",s.message)}}return this.unreadNotifications>0&&this.unreadNotifications--,console.log(`âœ… Local: Notification ${a} marked as read`),this.updateNotificationBadge(),!0}catch(t){return console.error("âŒ Error marking notification as read:",t),this.unreadNotifications>0&&(this.unreadNotifications--,this.updateNotificationBadge()),!1}}async deleteNotification(a){try{if(console.log(`ðŸ—‘ï¸ Deleting admin notification ${a}...`),!this.user||!this.user.id)throw new Error("User not found");const t=v();let i=b.notifications;if(!i)throw new Error("Notification API endpoint not configured");i.endsWith("/")||(i+="/");const s=`${i}${a}/`;console.log("Delete URL:",s);const n=await fetch(s,{method:"DELETE",headers:t,credentials:"include"});if(!n.ok){const o=await n.text();return console.error(`Delete failed ${n.status}:`,o.substring(0,200)),await this.tryAlternativeDelete(a)}return this.unreadNotifications>0&&(this.unreadNotifications--,this.updateNotificationBadge()),x("success","Notifikasi berhasil dihapus"),console.log(`âœ… Admin notification ${a} deleted successfully`),!0}catch(t){if(console.error("âŒ Error deleting admin notification:",t),this.handleLocalDelete(a))return x("info","Notifikasi dihapus (mode pengembangan)"),!0;let s="Gagal menghapus notifikasi";return t.message.includes("404")?s="Notifikasi tidak ditemukan":(t.message.includes("401")||t.message.includes("403"))&&(s="Anda tidak memiliki izin untuk menghapus notifikasi"),x("error",s),!1}}async tryAlternativeDelete(a){try{console.log("ðŸ”„ Mencoba alternatif delete untuk admin...");const t=v(),i=[`${b.notifications}${a}/`,`${b.notifications}/${a}/`,`${b.base}/notifications/${a}/`,`${b.base}/admin/notifications/${a}/`];for(const s of i)try{if(console.log(`Mencoba: ${s}`),(await fetch(s,{method:"DELETE",headers:t,credentials:"include"})).ok)return console.log(`âœ… Delete berhasil via ${s}`),this.unreadNotifications>0&&(this.unreadNotifications--,this.updateNotificationBadge()),!0}catch(n){console.log(`URL ${s} gagal:`,n.message);continue}throw new Error("Semua alternatif gagal")}catch(t){throw console.error("âŒ Semua percobaan delete admin gagal:",t),t}}async deleteAllNotifications(){try{if(console.log("ðŸ—‘ï¸ Deleting all admin notifications..."),!this.user||!this.user.id)throw new Error("User not found");if(!await this.showDeleteConfirmationModal())return!1;x("info","Menghapus semua notifikasi admin...",3e3);const t=v();let i;b.notifications?i=b.notifications.endsWith("/")?`${b.notifications}admin/all/`:`${b.notifications}/admin/all/`:i=`${b.base}/admin/notifications/all/`,console.log("Delete all URL for admin:",i);const s=await fetch(i,{method:"DELETE",headers:t,credentials:"include"});return s.ok?(this.unreadNotifications=0,this.updateNotificationBadge(),x("success","Semua riwayat notifikasi admin telah dihapus"),console.log("âœ… All admin notifications deleted successfully"),!0):s.status===404?(console.log("Endpoint /admin/all tidak ditemukan, menggunakan fallback..."),await this.deleteAllNotificationsFallback()):await this.deleteAllNotificationsFallback()}catch(a){console.error("âŒ Error deleting all admin notifications:",a);try{if(await this.deleteAllNotificationsFallback())return!0}catch(t){console.error("Fallback juga gagal:",t)}return this.unreadNotifications=0,this.updateNotificationBadge(),x("info","Riwayat notifikasi admin direset (mode pengembangan)"),!0}}async deleteAllNotificationsFallback(){try{console.log("ðŸ”„ Menggunakan fallback untuk delete all admin...");const a=await this.fetchNotifications();if(a.length===0)return console.log("Tidak ada notifikasi admin untuk dihapus"),x("info","Tidak ada notifikasi untuk dihapus"),!0;let t=0,i=0;for(const n of a)try{await this.deleteNotification(n.id),t++,await new Promise(o=>setTimeout(o,50))}catch(o){console.warn(`Gagal menghapus notifikasi admin ${n.id}:`,o.message),i++}this.unreadNotifications=0,this.updateNotificationBadge();let s=`Berhasil menghapus ${t} notifikasi admin`;return i>0&&(s+=`, ${i} gagal`),x("success",s),console.log(`âœ… Deleted ${t} admin notifications (${i} failed)`),t>0}catch(a){return console.error("âŒ Error in admin fallback delete all:",a),this.unreadNotifications=0,this.updateNotificationBadge(),x("info","Notifikasi admin direset secara lokal"),!0}}async showDeleteConfirmationModal(){return new Promise(a=>{P("Konfirmasi Hapus",`
                <div class="confirmation-modal">
                    <div class="text-center mb-4">
                        <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                    </div>
                    <h5 class="text-center mb-3">Hapus Semua Notifikasi</h5>
                    <p class="text-center text-muted mb-4">
                        Apakah Anda yakin ingin menghapus <strong>SEMUA</strong> riwayat notifikasi?<br>
                        <small>Tindakan ini tidak dapat dibatalkan.</small>
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-outline-secondary" id="cancelDelete">
                            <i class="bi bi-x-lg me-2"></i>Batal
                        </button>
                        <button class="btn btn-danger" id="confirmDeleteAll">
                            <i class="bi bi-trash me-2"></i>Ya, Hapus Semua
                        </button>
                    </div>
                </div>
            `,null,()=>{a(!1)}),setTimeout(()=>{const i=document.getElementById("cancelDelete"),s=document.getElementById("confirmDeleteAll");i&&(i.onclick=()=>{Ra(),a(!1)}),s&&(s.onclick=()=>{Ra(),a(!0)})},100)})}async showSingleDeleteConfirmationModal(){return new Promise(a=>{P("Konfirmasi Hapus",`
                <div class="confirmation-modal-single">
                    <div class="text-center mb-3">
                        <i class="bi bi-trash text-danger fs-2"></i>
                    </div>
                    <h6 class="text-center mb-3">Hapus Notifikasi</h6>
                    <p class="text-center text-muted mb-4">
                        Apakah Anda yakin ingin menghapus notifikasi ini?
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-outline-secondary" id="cancelSingleDelete">
                            Batal
                        </button>
                        <button class="btn btn-danger" id="confirmSingleDelete">
                            <i class="bi bi-trash me-1"></i>Hapus
                        </button>
                    </div>
                </div>
            `,null,()=>{a(!1)}),setTimeout(()=>{const i=document.getElementById("cancelSingleDelete"),s=document.getElementById("confirmSingleDelete");i&&(i.onclick=()=>{Ra(),a(!1)}),s&&(s.onclick=()=>{Ra(),a(!0)})},100)})}async showNotificationModal(){try{console.log("ðŸ“‹ Showing admin notification modal...");const a=await this.fetchNotifications(),t=`
                <div class="notification-modal-admin">
                    ${this.generateNotificationModalContent(a)}
                </div>
            `;P("Notifikasi Admin",t,"modal-lg"),this.setupNotificationModalEventListeners()}catch(a){console.error("âŒ Error showing admin notification modal:",a),x("error","Gagal memuat notifikasi")}}generateNotificationModalContent(a){let t=`
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-shield-check text-primary me-2"></i>
                    Notifikasi Admin
                    ${this.unreadNotifications>0?`
                        <span class="badge bg-danger ms-2">${this.unreadNotifications} baru</span>
                    `:""}
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="refreshAdminNotifications">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    ${a.length>0?`
                        <button class="btn btn-sm btn-outline-success ms-2" id="markAllAsReadAdmin">
                            <i class="bi bi-check-all"></i> Tandai Semua Dibaca
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-2" id="deleteAllAdminNotifications">
                            <i class="bi bi-trash"></i> Hapus Semua
                        </button>
                    `:""}
                </div>
            </div>
        `;return a.length>0?(t+=`
                <div class="notification-list-admin" style="max-height: 400px; overflow-y: auto;">
            `,a.forEach((i,s)=>{const n=i.priority==="high",o=i.read;t+=`
                    <div class="notification-item-admin border rounded p-3 mb-2 ${n?"border-danger":o?"border-light":"border-primary"} ${n?"bg-danger bg-opacity-10":o?"bg-light":"bg-primary bg-opacity-10"}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 me-3">
                                <div class="d-flex align-items-center mb-1">
                                    ${this.getNotificationIcon(i.notification_type||i.type)}
                                    <h6 class="mb-0 ms-2 ${n?"text-danger fw-bold":o?"text-muted":"text-dark"}">
                                        ${i.title||"Notifikasi"}
                                    </h6>
                                    ${n?`
                                        <span class="badge bg-danger ms-2">PENTING</span>
                                    `:""}
                                    ${o?"":`
                                        <span class="badge bg-success ms-2">BARU</span>
                                    `}
                                </div>
                                <p class="mb-1 ${o?"text-muted":"text-dark"}">${i.message||""}</p>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    ${this.formatTimeAgo(i.created_at||i.timestamp)}
                                </small>
                            </div>
                            <div>
                                ${o?"":`
                                    <button class="btn btn-sm btn-outline-success mark-as-read-admin me-1" 
                                            data-id="${i.id||s}"
                                            data-type="mark-read">
                                        <i class="bi bi-check"></i> Baca
                                    </button>
                                `}
                                <button class="btn btn-sm btn-outline-danger delete-admin-notification" 
                                        data-id="${i.id||s}"
                                        data-type="delete">
                                    <i class="bi bi-trash"></i> Hapus
                                </button>
                            </div>
                        </div>
                `,i.data&&(t+=`
                        <div class="mt-2 p-2 bg-light rounded">
                            <small class="text-muted">Informasi:</small>
                            <pre class="mb-0 small" style="max-height: 100px; overflow: auto; white-space: pre-wrap;">${JSON.stringify(i.data,null,2)}</pre>
                        </div>
                    `),t+="</div>"}),t+="</div>"):t+=`
                <div class="text-center py-5">
                    <i class="bi bi-bell-slash fs-1 text-muted mb-3"></i>
                    <p class="text-muted">Tidak ada notifikasi</p>
                    <small class="text-muted">Notifikasi akan muncul di sini saat ada pembaruan</small>
                </div>
            `,t+=`
            <div class="mt-3 border-top pt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Notifikasi diperbarui setiap 5 menit. Terakhir: ${this.lastNotificationCheck?this.lastNotificationCheck.toLocaleTimeString("id-ID"):"Belum pernah"}
                </small>
            </div>
        `,t}async refreshNotificationModal(){try{console.log("ðŸ”„ Refreshing admin notification modal...");const a=await this.fetchNotifications(),t=document.querySelector(".modal-body .notification-modal-admin");if(t){const i=this.generateNotificationModalContent(a);t.innerHTML=i,this.setupNotificationModalEventListeners()}this.updateNotificationBadge()}catch(a){console.error("âŒ Error refreshing modal:",a)}}setupNotificationModalEventListeners(){setTimeout(()=>{const a=document.getElementById("refreshAdminNotifications");a&&a.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),await this.refreshNotificationModal()});const t=document.getElementById("markAllAsReadAdmin");t&&t.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),await this.markAllNotificationsAsRead()&&await this.refreshNotificationModal()});const i=document.getElementById("deleteAllAdminNotifications");i&&i.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),await this.deleteAllNotifications()&&await this.refreshNotificationModal()}),document.querySelectorAll('.mark-as-read-admin[data-type="mark-read"]').forEach(s=>{s.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation();const o=s.dataset.id;s.disabled=!0,s.innerHTML='<i class="bi bi-hourglass"></i> Memproses...',await this.markNotificationAsRead(o)?await this.refreshNotificationModal():(s.disabled=!1,s.innerHTML='<i class="bi bi-check"></i> Baca',x("error","Gagal menandai notifikasi sebagai dibaca"))})}),document.querySelectorAll('.delete-admin-notification[data-type="delete"]').forEach(s=>{s.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation();const o=s.dataset.id;if(!await this.showSingleDeleteConfirmationModal())return;s.disabled=!0,s.innerHTML='<i class="bi bi-hourglass"></i> Menghapus...',await this.deleteNotification(o)?await this.refreshNotificationModal():(s.disabled=!1,s.innerHTML='<i class="bi bi-trash"></i> Hapus',x("error","Gagal menghapus notifikasi"))})})},100)}handleLocalDelete(a){return console.log(`ðŸ”§ Local delete for admin notification ${a} (mock)`),this.unreadNotifications>0&&(this.unreadNotifications=Math.max(0,this.unreadNotifications-1),this.updateNotificationBadge()),!0}showDesktopNotification(a){try{if(!("Notification"in window)){console.log("âš ï¸ Desktop notifications not supported");return}if(Notification.permission!=="granted"){console.log("âš ï¸ Notification permission not granted");return}const t={body:a.message||"Anda memiliki notifikasi baru",icon:"/static/icon-192x192.png",badge:"/static/icon-72x72.png",tag:`admin-notification-${a.id||Date.now()}`,requireInteraction:a.priority==="high",data:a,silent:!1},i=new Notification(`Admin - ${a.title||"Notifikasi"}`,t);i.onclick=()=>{window.focus(),i.close(),this.showNotificationModal()},i.onclose=()=>{console.log("Desktop notification closed")},a.priority!=="high"&&setTimeout(()=>{i.close()},1e4)}catch(t){console.error("âŒ Error showing desktop notification:",t)}}startNotificationPolling(){this.notificationInterval&&clearInterval(this.notificationInterval),this.notificationInterval=setInterval(async()=>{try{await this.checkForNewNotifications()}catch(a){console.error("Polling error:",a)}},5*60*1e3),console.log("ðŸ”„ Started admin notification polling (every 5 minutes)"),setTimeout(()=>{this.checkForNewNotifications()},3e3)}stopNotificationPolling(){this.notificationInterval&&(clearInterval(this.notificationInterval),this.notificationInterval=null,console.log("ðŸ›‘ Stopped admin notification polling"))}getNotificationIcon(a){return{payment:'<i class="bi bi-cash-coin text-success fs-5"></i>',report:'<i class="bi bi-clipboard-data text-warning fs-5"></i>',alert:'<i class="bi bi-exclamation-triangle text-danger fs-5"></i>',system:'<i class="bi bi-gear text-secondary fs-5"></i>',test:'<i class="bi bi-bell text-muted fs-5"></i>',user:'<i class="bi bi-person-plus text-info fs-5"></i>'}[a]||'<i class="bi bi-bell text-muted fs-5"></i>'}formatTimeAgo(a){if(!a)return"Baru saja";try{const t=new Date(a),s=new Date-t,n=Math.floor(s/1e3),o=Math.floor(n/60),l=Math.floor(o/60),r=Math.floor(l/24);return n<10?"Baru saja":n<60?`${n} detik lalu`:o<60?`${o} menit lalu`:l<24?`${l} jam lalu`:r===1?"Kemarin":r<7?`${r} hari lalu`:r<30?`${Math.floor(r/7)} minggu lalu`:`${Math.floor(r/30)} bulan lalu`}catch{return"Baru saja"}}getMockNotifications(){const a=new Date;return[{id:1,title:"Pembayaran Baru",message:"Anggota #1234 telah melakukan pembayaran bulanan Rp 50,000",notification_type:"payment",priority:"normal",read:!1,created_at:new Date(a.getTime()-30*60*1e3).toISOString(),data:{amount:5e4,member_id:1234,status:"success"}},{id:2,title:"Laporan Sampah Menunggu",message:"3 laporan sampah baru menunggu verifikasi",notification_type:"report",priority:"high",read:!1,created_at:new Date(a.getTime()-15*60*1e3).toISOString(),data:{count:3,status:"pending",location:"Area A"}},{id:3,title:"Jadwal Besok",message:"5 jadwal pengangkutan untuk besok perlu dipersiapkan",notification_type:"schedule",priority:"normal",read:!0,created_at:new Date(a.getTime()-5*60*1e3).toISOString(),data:{schedule_count:5,date:new Date(a.getTime()+24*60*60*1e3).toISOString().split("T")[0]}}]}async updateNotificationUI(a){const t=document.getElementById("notification-status"),i=document.getElementById("notification-status-mobile"),s=document.getElementById("toggleNotificationsBtn"),n=document.getElementById("toggleNotificationsBtnMobile"),o=(c,d)=>{c&&(c.innerHTML=d)},l={loading:{badge:`<span class="badge bg-warning">
                    <i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1"></i> Memuat...
                </span>`,buttonText:'<i class="bi bi-arrow-repeat me-2"></i>Memuat...',disabled:!0},subscribed:{badge:`<span class="badge bg-success">
                    <i class="bi bi-bell-fill me-1"></i> Aktif
                </span>`,buttonText:'<i class="bi bi-bell-slash me-2"></i>Nonaktifkan',disabled:!1},unsubscribed:{badge:`<span class="badge bg-secondary">
                    <i class="bi bi-bell-slash me-1"></i> Nonaktif
                </span>`,buttonText:'<i class="bi bi-bell me-2"></i>Aktifkan',disabled:!1},"not-supported":{badge:`<span class="badge bg-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i> Tidak Didukung
                </span>`,buttonText:'<i class="bi bi-ban me-2"></i>Tidak Didukung',disabled:!0},"permission-denied":{badge:`<span class="badge bg-danger">
                    <i class="bi bi-slash-circle me-1"></i> Izin Ditolak
                </span>`,buttonText:'<i class="bi bi-slash-circle me-2"></i>Izin Ditolak',disabled:!0},"service-worker-error":{badge:`<span class="badge bg-danger">
                    <i class="bi bi-gear me-1"></i> Service Worker Error
                </span>`,buttonText:'<i class="bi bi-exclamation-triangle me-2"></i>Error SW',disabled:!0},"server-unavailable":{badge:`<span class="badge bg-warning">
                    <i class="bi bi-cloud-slash me-1"></i> Server Offline
                </span>`,buttonText:'<i class="bi bi-cloud-slash me-2"></i>Server Offline',disabled:!0},error:{badge:`<span class="badge bg-danger">
                    <i class="bi bi-exclamation-circle me-1"></i> Error
                </span>`,buttonText:'<i class="bi bi-exclamation-triangle me-2"></i>Error',disabled:!1}},r=l[a]||l.error;o(t,r.badge),o(i,r.badge),s&&(s.innerHTML=r.buttonText,s.disabled=r.disabled),n&&(n.innerHTML=r.buttonText,n.disabled=r.disabled),this.updateNotificationBadge()}updateNotificationBadge(){const a=document.getElementById("notification-badge"),t=document.getElementById("notification-badge-mobile"),i=s=>{s&&(this.unreadNotifications>0?(s.innerHTML=`
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6em;">
                            ${this.unreadNotifications>99?"99+":this.unreadNotifications}
                            <span class="visually-hidden">unread notifications</span>
                        </span>
                    `,s.classList.add("position-relative")):(s.innerHTML="",s.classList.remove("position-relative")))};i(a),i(t)}async setupDashboardIntegration(){try{console.log("ðŸ”§ Setting up admin dashboard integration..."),await this.initialize(),this.setupEventListeners(),await this.updateDropdownStatus(),console.log("âœ… Admin dashboard integration complete")}catch(a){console.error("âŒ Error setting up admin dashboard integration:",a)}}setupEventListeners(){console.log("ðŸ”— Setting up admin event listeners...");const a=document.getElementById("toggleNotificationsBtn");a&&a.addEventListener("click",async i=>{i.preventDefault(),await this.toggleNotifications()});const t=document.getElementById("showNotificationsModal");t&&t.addEventListener("click",async i=>{i.preventDefault(),await this.showNotificationModal()})}async updateDropdownStatus(){const a=document.getElementById("notification-dropdown-status");if(a)try{await Z.checkSubscription()?a.innerHTML=`
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> Aktif
                    </span>
                `:a.innerHTML=`
                    <span class="badge bg-secondary">
                        <i class="bi bi-bell-slash"></i> Nonaktif
                    </span>
                `}catch(t){console.error("Error updating dropdown status:",t),a.innerHTML=`
                <span class="badge bg-warning">
                    <i class="bi bi-exclamation-circle"></i> Gagal
                </span>
            `}}}const te=new Or;async function jn(){const e=await Da();if(!e)return;if(console.log("ðŸ‘‘ Admin Dashboard - User:",e),e.role!=="admin"){alert("Hanya admin yang bisa mengakses dashboard ini!"),window.location.hash="#/dashboard";return}const a=document.getElementById("app");a.innerHTML=`
        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        
        <div class="container-fluid p-0" style="min-height: 100vh;">
            <div class="d-flex">
                <!-- Desktop Sidebar (LG ke atas) -->
                <aside class="d-none d-lg-flex flex-column flex-shrink-0 bg-success text-white" 
                    style="width: 280px; min-height: 100vh; position: sticky; top: 0;">
                    
                    <!-- Header dengan LOGO -->
                    <div class="bg-success text-white border-bottom border-white-20 p-3">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <!-- LOGO CleanUp di Sidebar -->
                                <div class="me-3">
                                    <img src="/logo/logo_3d.png" 
                                         alt="CleanUp Kupang Logo" 
                                         style="height: 40px; width: auto;">
                                </div>
                                <div>
                                    <h5 class="mb-0">${e.username}</h5>
                                    <small class="text-white-50">ADMIN</small>
                                </div>
                            </div>
                            <!-- Close button hanya untuk konsistensi visual -->
                            <button type="button" class="btn-close btn-close-white opacity-50" disabled></button>
                        </div>
                        
                        <!-- Brand centered -->
                        <div class="d-flex align-items-center justify-content-center pt-2">
                            <span class="fs-4 fw-bold text-white">
                                <i class="bi bi-recycle me-2"></i>CleanUp Kupang
                            </span>
                        </div>
                    </div>
                    
                    <!-- Navigation dengan padding seperti mobile -->
                    <ul class="nav nav-pills flex-column mb-auto p-3" id="sidebarMenuDesktop">
                        <li class="nav-item mb-2">
                            <button class="nav-link active text-white bg-white-10 w-100 d-flex align-items-center" data-page="dashboard">
                                <i class="bi bi-speedometer2 me-2"></i>
                                <span>Dashboard Utama</span>
                            </button>
                        </li>
                        
                        <!-- Manajemen User Section -->
                        <li class="nav-item">
                            <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                <i class="bi bi-people me-1"></i> MANAJEMEN USER
                            </p>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="users">
                                <i class="bi bi-person me-2"></i>
                                <span>Users</span>
                            </button>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="anggota">
                                <i class="bi bi-people-fill me-2"></i>
                                <span>Anggota</span>
                            </button>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="tamu">
                                <i class="bi bi-person-plus me-2"></i>
                                <span>Tamu</span>
                            </button>
                        </li>

                        <!-- Notifikasi Section -->
                        <li class="nav-item">
                            <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                <i class="bi bi-bell me-1"></i> NOTIFIKASI
                            </p>
                        </li>

                        <li class="nav-item mb-2">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center"
                                    data-page="push-subscriptions">
                                <i class="bi bi-broadcast me-2"></i>
                                <span>Push Subscription</span>
                            </button>
                        </li>

                        
                        <!-- Operasional Section -->
                        <li class="nav-item">
                            <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                <i class="bi bi-truck me-1"></i> Operasional
                            </p>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="tim">
                                <i class="bi bi-truck me-2"></i>
                                <span>Tim Pengangkut</span>
                            </button>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="jadwal">
                                <i class="bi bi-calendar-check me-2"></i>
                                <span>Jadwal</span>
                            </button>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="detailJadwal">
                                <i class="bi bi-calendar-week me-2"></i>
                                <span>Detail Jadwal</span>
                            </button>
                        </li>
                        
                        <!-- Keuangan Section -->
                        <li class="nav-item">
                            <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                <i class="bi bi-cash-coin me-1"></i> Keuangan
                            </p>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="pembayaran">
                                <i class="bi bi-cash-stack me-2"></i>
                                <span>Pembayaran</span>
                            </button>
                        </li>
                        
                        <!-- Laporan Section -->
                        <li class="nav-item">
                            <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                <i class="bi bi-clipboard-data me-1"></i> Laporan
                            </p>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="laporan">
                                <i class="bi bi-trash me-2"></i>
                                <span>Laporan Sampah</span>
                            </button>
                        </li>
                        <li class="nav-item mb-1">
                            <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" data-page="reports">
                                <i class="bi bi-graph-up me-2"></i>
                                <span>Analitik & Laporan</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Footer dengan border seperti mobile -->
                    <div class="p-3 border-top border-white-20 mt-auto">
                        <button class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center" id="btnLogout">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            Logout
                        </button>
                        <div class="text-center mt-3">
                            <small class="text-white-50">v1.0.0 â€¢ CleanUp System</small>
                        </div>
                    </div>
                </aside>
                
                <!-- Mobile Sidebar (Offcanvas) -->
                <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="sidebarOffcanvas" style="width: 280px;">
                    <div class="offcanvas-header bg-success text-white border-bottom border-white-20">
                        <div class="d-flex align-items-center">
                            <!-- LOGO CleanUp di Offcanvas -->
                            <div class="me-3">
                                <img src="/logo/logo_3d.png" 
                                     alt="CleanUp Kupang Logo" 
                                     style="height: 35px; width: auto;">
                            </div>
                            <div>
                                <h5 class="offcanvas-title mb-0">${e.username}</h5>
                                <small class="text-white-50">ADMIN</small>
                            </div>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
                    </div>
                    
                    <div class="offcanvas-body p-0 bg-success">
                        <div class="d-flex align-items-center justify-content-center p-3 border-bottom border-white-20">
                            <!-- Logo dan Brand -->
                            <div class="d-flex align-items-center">
                                <img src="/logo/logo_3d.png" 
                                     alt="CleanUp Kupang Logo" 
                                     style="height: 40px; width: auto; margin-right: 10px;">
                                <span class="fs-4 fw-bold text-white">
                                    CleanUp Kupang
                                </span>
                            </div>
                        </div>
                        
                        <ul class="nav nav-pills flex-column mb-auto p-3" id="sidebarMenuMobile">
                            <li class="nav-item mb-2">
                                <button class="nav-link active text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="dashboard" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-speedometer2 me-2"></i>
                                    <span>Dashboard Utama</span>
                                </button>
                            </li>
                            
                            <!-- Manajemen User Section -->
                            <li class="nav-item">
                                <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                    <i class="bi bi-people me-1"></i> MANAJEMEN USER
                                </p>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="users" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-person me-2"></i>
                                    <span>Users</span>
                                </button>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="anggota" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-people-fill me-2"></i>
                                    <span>Anggota</span>
                                </button>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="tamu" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-person-plus me-2"></i>
                                    <span>Tamu</span>
                                </button>
                            </li>

                            <!-- Notifikasi Section -->
                            <li class="nav-item">
                                <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                    <i class="bi bi-bell me-1"></i> NOTIFIKASI
                                </p>
                            </li>
                            <li class="nav-item mb-2">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center"
                                        data-page="push-subscriptions"
                                        data-bs-dismiss="offcanvas">
                                    <i class="bi bi-broadcast me-2"></i>
                                    <span>Push Subscription</span>
                                </button>
                            </li>
                            
                            <!-- Operasional Section -->
                            <li class="nav-item">
                                <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                    <i class="bi bi-truck me-1"></i> Operasional
                                </p>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="tim" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-truck me-2"></i>
                                    <span>Tim Pengangkut</span>
                                </button>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="jadwal" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-calendar-check me-2"></i>
                                    <span>Jadwal</span>
                                </button>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="detailJadwal" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-calendar-week me-2"></i>
                                    <span>Detail Jadwal</span>
                                </button>
                            </li>
                            
                            <!-- Keuangan Section -->
                            <li class="nav-item">
                                <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                    <i class="bi bi-cash-coin me-1"></i> Keuangan
                                </p>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="pembayaran" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-cash-stack me-2"></i>
                                    <span>Pembayaran</span>
                                </button>
                            </li>
                            
                            <!-- Laporan Section -->
                            <li class="nav-item">
                                <p class="small text-uppercase text-white-50 mt-4 mb-2 fw-semibold">
                                    <i class="bi bi-clipboard-data me-1"></i> Laporan
                                </p>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="laporan" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-trash me-2"></i>
                                    <span>Laporan Sampah</span>
                                </button>
                            </li>
                            <li class="nav-item mb-1">
                                <button class="nav-link text-white bg-white-10 w-100 d-flex align-items-center" 
                                        data-page="reports" data-bs-dismiss="offcanvas">
                                    <i class="bi bi-graph-up me-2"></i>
                                    <span>Analitik & Laporan</span>
                                </button>
                            </li>
                        </ul>
                        
                        <div class="p-3 border-top border-white-20 mt-auto">
                            <button class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center" 
                                    id="btnLogoutMobile">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                Logout
                            </button>
                            <div class="text-center mt-3">
                                <small class="text-white-50">v1.0.0 â€¢ CleanUp System</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content Area -->
                <main class="flex-grow-1 bg-light">
                    <!-- Top Navigation Bar dengan LOGO -->
                    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm sticky-top" style="z-index: 999;">
                        <div class="container-fluid">
                            <!-- Mobile Toggle Button -->
                            <button class="btn btn-success d-lg-none me-2" type="button" data-bs-toggle="offcanvas" 
                                    data-bs-target="#sidebarOffcanvas">
                                <i class="bi bi-list fs-5"></i>
                            </button>
                            
                            <!-- Page Title dengan LOGO -->
                            <div class="d-flex align-items-center">
                                <!-- Logo untuk desktop -->
                                <div class="d-none d-md-block me-3">
                                    <img src="/logo/logo_3d.png" 
                                         alt="CleanUp Kupang Logo" 
                                         style="height: 35px; width: auto;">
                                </div>
                                <h5 class="mb-0 text-success fw-bold" id="pageTitle">
                                    <i class="bi bi-speedometer2 me-2"></i>Dashboard Admin
                                </h5>
                            </div>
                            
                            <!-- User Info & Notifications -->
                            <div class="d-flex align-items-center">
                                <!-- Desktop Notification Bell -->
                                <div class="dropdown me-3 d-none d-md-block">
                                    <button class="btn btn-outline-success position-relative" 
                                            id="notification-bell" 
                                            type="button" 
                                            data-bs-toggle="dropdown">
                                        <i class="bi bi-bell fs-5"></i>
                                        <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" style="min-width: 300px;">
                                        <li><h6 class="dropdown-header">Notifikasi Admin</h6></li>
                                        <li>
                                            <div class="px-3 py-2">
                                                <small class="text-muted d-block mb-1">Status:</small>
                                                <div id="notification-status">
                                                    <span class="badge bg-secondary">Memuat...</span>
                                                </div>
                                            </div>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item" id="viewNotificationsBtn">
                                                <i class="bi bi-bell me-2"></i> Lihat Semua Notifikasi
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" id="toggleNotificationsBtn">
                                                <i class="bi bi-bell me-2"></i> Aktif/Nonaktif Notifikasi
                                            </button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <small class="text-muted px-3">Terakhir diperbarui: <span id="last-notification-check">-</span></small>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- Mobile Notification Bell -->
                                <div class="dropdown me-2 d-md-none">
                                    <button class="btn btn-outline-success btn-sm position-relative" 
                                            id="notification-bell-mobile" 
                                            type="button" 
                                            data-bs-toggle="dropdown">
                                        <i class="bi bi-bell"></i>
                                        <span id="notification-badge-mobile" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" style="min-width: 280px;">
                                        <li><h6 class="dropdown-header">Notifikasi</h6></li>
                                        <li>
                                            <div class="px-3 py-2">
                                                <small class="text-muted d-block mb-1">Status:</small>
                                                <div id="notification-status-mobile">
                                                    <span class="badge bg-secondary">Memuat...</span>
                                                </div>
                                            </div>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item" id="viewNotificationsBtnMobile">
                                                <i class="bi bi-bell me-2"></i> Lihat Notifikasi
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" id="toggleNotificationsBtnMobile">
                                                <i class="bi bi-bell-slash me-2"></i> Pengaturan
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- User Info -->
                                <div class="d-flex align-items-center">
                                    <!-- Logo kecil untuk mobile -->
                                    <div class="d-md-none me-2">
                                        <img src="/logo/logo_3d.png" 
                                             alt="CleanUp Kupang Logo" 
                                             style="height: 25px; width: auto;">
                                    </div>
                                    <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" 
                                        style="width: 40px; height: 40px; font-weight: bold;">
                                        ${e.username.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="ms-2 d-none d-sm-block">
                                        <p class="mb-0 fw-semibold">${e.username}</p>
                                        <small class="text-muted">Administrator</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    <!-- Main Content Container dengan LOGO di tengah -->
                    <div class="container-fluid py-4 px-3 px-md-4">
                        <div class="row">
                            <div class="col-12">
                                <div id="mainContent">
                                    <!-- Welcome Content dengan LOGO -->
                                    <div class="text-center py-5">
                                        <!-- Logo Besar di Tengah Dashboard -->
                                        <div class="mb-4">
                                            <img src="/logo/logo_3d.png" 
                                                 alt="CleanUp Kupang Logo" 
                                                 style="height: 100px; width: auto; margin-bottom: 20px;">
                                        </div>
                                        
                                        <div class="display-1 text-success mb-4">
                                            <i class="bi bi-speedometer2"></i>
                                        </div>
                                        <h3 class="mb-3">Dashboard Admin CleanUp Kupang</h3>
                                        <p class="text-muted">Selamat datang di sistem manajemen CleanUp Kupang</p>
                                        
                                        <!-- Notification Alert -->
                                        <div id="notification-alert" class="alert alert-info alert-dismissible fade show mt-4 mx-auto" style="max-width: 600px;">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-bell-fill fs-4 me-3"></i>
                                                <div>
                                                    <h5 class="alert-heading mb-2">Aktifkan Notifikasi Real-time</h5>
                                                    <p class="mb-2">Dapatkan notifikasi langsung untuk pembayaran baru, laporan menunggu, jadwal, dan aktivitas penting lainnya.</p>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        <button class="btn btn-primary btn-sm" id="enableNotificationsAlert">
                                                            <i class="bi bi-bell me-1"></i> Aktifkan Sekarang
                                                        </button>
                                                        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="alert">
                                                            Nanti Saja
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- Bootstrap JS Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"><\/script>
        <!-- Animate.css -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
        
        <!-- Custom CSS untuk logo -->
        <style>
            /* Styling untuk logo di sidebar */
            .sidebar-logo {
                filter: brightness(0) invert(1);
                transition: transform 0.3s ease;
            }
            
            .sidebar-logo:hover {
                transform: scale(1.05);
            }
            
            /* Styling untuk logo di navbar */
            .navbar-logo {
                transition: opacity 0.3s ease;
            }
            
            .navbar-logo:hover {
                opacity: 0.8;
            }
            
            /* Styling untuk logo besar di dashboard */
            .dashboard-logo {
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
                100% {
                    transform: scale(1);
                }
            }
            
            /* Styling untuk logo mobile */
            .mobile-logo {
                filter: brightness(0) saturate(100%) invert(27%) sepia(98%) saturate(1500%) hue-rotate(130deg) brightness(90%) contrast(90%);
            }
            
            /* Sidebar Styles */
            .sidebar-link {
                transition: all 0.3s ease;
            }
            
            .sidebar-link:hover {
                background-color: rgba(255, 255, 255, 0.15);
                transform: translateX(5px);
            }
            
            .sidebar-link.active {
                background-color: rgba(255, 255, 255, 0.25);
                border-left: 4px solid #ffc107;
            }
            
            /* Offcanvas Custom */
            .offcanvas-start {
                background: linear-gradient(180deg, #198754 0%, #146c43 100%);
            }
            
            .bg-white-10 {
                background-color: rgba(255, 255, 255, 0.1) !important;
            }
            
            .bg-white-10:hover {
                background-color: rgba(255, 255, 255, 0.2) !important;
            }
            
            /* Stats Cards */
            .stats-card {
                border-radius: 12px;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                border: none;
                overflow: hidden;
            }
            
            .stats-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
            }
            
            .stats-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 5px;
                height: 100%;
            }
            
            .stats-card-success::before { background: linear-gradient(to bottom, #198754, #2ecc71); }
            .stats-card-primary::before { background: linear-gradient(to bottom, #0d6efd, #3498db); }
            .stats-card-warning::before { background: linear-gradient(to bottom, #ffc107, #f39c12); }
            .stats-card-info::before { background: linear-gradient(to bottom, #0dcaf0, #1abc9c); }
            .stats-card-danger::before { background: linear-gradient(to bottom, #dc3545, #e74c3c); }
            .stats-card-secondary::before { background: linear-gradient(to bottom, #6c757d, #7f8c8d); }
            
            .stats-icon {
                width: 70px;
                height: 70px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 32px;
            }
            
            /* Trend Chart */
            .trend-bar {
                transition: all 0.3s ease;
                min-height: 10px;
                border-radius: 4px 4px 0 0;
            }
            
            .trend-bar:hover {
                opacity: 0.9;
            }
            
            /* Activity Items */
            .activity-item {
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
            }
            
            .activity-item:hover {
                background-color: rgba(25, 135, 84, 0.05);
                border-left-color: #198754;
                transform: translateX(5px);
            }
            
            /* Quick Actions */
            .quick-action-btn {
                transition: all 0.3s ease;
                border: 2px solid rgba(25, 135, 84, 0.1);
            }
            
            .quick-action-btn:hover {
                background: linear-gradient(135deg, #198754, #146c43);
                color: white;
                border-color: transparent;
                transform: translateY(-3px);
            }
            
            /* Scrollbar */
            .custom-scrollbar {
                scrollbar-width: thin;
                scrollbar-color: #198754 transparent;
            }
            
            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
                border-radius: 3px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(25, 135, 84, 0.5);
                border-radius: 3px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: rgba(25, 135, 84, 0.7);
            }
            
            /* Animation */
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .animate-fadeInUp {
                animation: fadeInUp 0.6s ease-out;
            }
        </style>
    `,Kr(),qr(),Vr(),await te.initialize(),await te.checkForNewNotifications(),Wr(),await Rt()}function Kr(){const e=document.querySelectorAll("#sidebarMenuDesktop button[data-page], #sidebarMenuMobile button[data-page]");e.forEach(a=>{a.onclick=()=>{e.forEach(t=>{t.classList.remove("active")}),a.classList.add("active"),Nn(a.dataset.page)}})}function qr(){const e=document.getElementById("btnLogout");e&&(e.onclick=()=>{console.log("ðŸ”„ Admin: Logout button clicked"),typeof window.logout=="function"?window.logout():(console.error("âŒ window.logout function not found"),localStorage.clear(),window.location.hash="#/login",window.location.reload())});const a=document.getElementById("btnLogoutMobile");a&&(a.onclick=()=>{console.log("ðŸ”„ Admin: Mobile logout button clicked"),typeof window.logout=="function"?window.logout():(console.error("âŒ window.logout function not found"),localStorage.clear(),window.location.hash="#/login",window.location.reload())})}function Vr(){const e=document.getElementById("viewNotificationsBtn");e&&e.addEventListener("click",()=>{te.showNotificationModal()});const a=document.getElementById("toggleNotificationsBtn");a&&a.addEventListener("click",async()=>{const l=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';try{await te.toggleNotifications()}finally{a.disabled=!1,a.innerHTML=l}});const t=document.getElementById("viewNotificationsBtnMobile");t&&t.addEventListener("click",()=>{te.showNotificationModal()});const i=document.getElementById("toggleNotificationsBtnMobile");i&&i.addEventListener("click",async()=>{const l=i.innerHTML;i.disabled=!0,i.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';try{await te.toggleNotifications()}finally{i.disabled=!1,i.innerHTML=l}});const s=document.getElementById("enableNotificationsAlert");s&&s.addEventListener("click",async()=>{await te.enableNotifications();const l=document.getElementById("notification-alert");l&&l.classList.add("d-none")});const n=document.getElementById("notification-bell");n&&n.addEventListener("click",async()=>{await te.updateUnreadNotificationsCount()});const o=document.getElementById("notification-bell-mobile");o&&o.addEventListener("click",async()=>{await te.updateUnreadNotificationsCount()})}function Wr(){const e=document.getElementById("last-notification-check");e&&(e.textContent=new Date().toLocaleTimeString("id-ID"))}async function Nn(e){const a=document.getElementById("mainContent"),t=document.getElementById("pageTitle"),i={dashboard:'<i class="bi bi-speedometer2 me-2"></i>Dashboard Utama',users:'<i class="bi bi-person me-2"></i>Manajemen Users',tim:'<i class="bi bi-truck me-2"></i>Tim Pengangkut',anggota:'<i class="bi bi-people-fill me-2"></i>Anggota',tamu:'<i class="bi bi-person-plus me-2"></i>Tamu',notifications:'<i class="bi bi-bell me-2"></i>Manajemen Notifikasi',"push-subscriptions":'<i class="bi bi-broadcast me-2"></i>Push Subscription',jadwal:'<i class="bi bi-calendar-check me-2"></i>Jadwal Pengangkutan',detailJadwal:'<i class="bi bi-calendar-week me-2"></i>Detail Jadwal Anggota',pembayaran:'<i class="bi bi-cash-stack me-2"></i>Pembayaran',laporan:'<i class="bi bi-trash me-2"></i>Laporan Sampah',reports:'<i class="bi bi-graph-up me-2"></i>Analitik & Laporan'};t.innerHTML=i[e]||"Dashboard Admin",a.innerHTML=`
        <div class="d-flex flex-column align-items-center justify-content-center py-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Memuat halaman...</p>
        </div>
    `;try{switch(e){case"users":await ll();break;case"tim":await yl();break;case"anggota":await Tl();break;case"tamu":await Fl();break;case"notifications":await notificationAdminPage();break;case"push-subscriptions":await Gr();break;case"jadwal":await Rl();break;case"detailJadwal":await Er();break;case"pembayaran":await tr();break;case"laporan":await dr();break;case"reports":await Dr();break;case"dashboard":await Rt();break;default:a.innerHTML=`
                    <div class="card animate-fadeInUp">
                        <div class="card-body text-center py-5">
                            <h4 class="text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>Halaman tidak ditemukan
                            </h4>
                            <p class="text-muted">Halaman ${e} tidak tersedia</p>
                            <button onclick="loadPage('dashboard')" class="btn btn-success mt-3">
                                <i class="bi bi-house me-1"></i> Kembali ke Dashboard
                            </button>
                        </div>
                    </div>
                `}}catch(s){console.error("Error loading page:",s),a.innerHTML=`
            <div class="card border-danger animate-fadeInUp">
                <div class="card-body text-center py-5">
                    <div class="text-danger mb-3">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="text-danger">Terjadi Kesalahan</h4>
                    <p class="text-muted">Gagal memuat halaman: ${s.message}</p>
                    <button onclick="location.reload()" class="btn btn-outline-success mt-3">
                        <i class="bi bi-arrow-clockwise me-1"></i> Coba Lagi
                    </button>
                </div>
            </div>
        `}}async function Yr(){try{console.log("ðŸ“Š Fetching dashboard stats...");const[e,a,t,i,s,n]=await Promise.allSettled([fetch(b.users,{headers:v()}),fetch(b.anggota,{headers:v()}),fetch(b.timPengangkut,{headers:v()}),fetch(b.pembayaran,{headers:v()}),fetch(b.laporanSampah,{headers:v()}),fetch(b.jadwal,{headers:v()})]),o=e.status==="fulfilled"?await e.value.json():[],l=a.status==="fulfilled"?await a.value.json():[],r=t.status==="fulfilled"?await t.value.json():[],c=i.status==="fulfilled"?await i.value.json():[],d=s.status==="fulfilled"?await s.value.json():[],m=n.status==="fulfilled"?await n.value.json():[],u=new Date().toISOString().split("T")[0],g=new Date().getMonth()+1,p=new Date().getFullYear(),h=o.length||0,f=l.filter(B=>B.status==="aktif").length||0,k=r.length||0,w=c.filter(B=>{try{const I=new Date(B.tanggalBayar);return I.getMonth()+1===g&&I.getFullYear()===p&&B.statusBayar==="lunas"}catch{return!1}}).reduce((B,I)=>B+(I.jumlahBayar||0),0),$=d.length||0,y=m.filter(B=>B.tanggalJadwal===u).length||0,A={};o.forEach(B=>{A[B.role]=(A[B.role]||0)+1});const E={};d.forEach(B=>{E[B.status]=(E[B.status]||0)+1});const C=await Zr();return{totalUsers:h,anggotaAktif:f,totalTim:k,totalPembayaranBulanIni:w,totalLaporan:$,jadwalHariIni:y,userRoles:A,laporanStatus:E,recentActivities:C}}catch(e){return console.error("Error fetching dashboard stats:",e),{totalUsers:0,anggotaAktif:0,totalTim:0,totalPembayaranBulanIni:0,totalLaporan:0,jadwalHariIni:0,userRoles:{},laporanStatus:{},recentActivities:[]}}}async function Zr(){try{console.log("ðŸ“ Fetching recent activities...");const[e,a,t]=await Promise.allSettled([fetch(b.laporanSampah+"?ordering=-tanggal_lapor",{headers:v()}),fetch(b.pembayaran+"?ordering=-tanggalBayar",{headers:v()}),fetch(b.anggota+"?ordering=-tanggalStart",{headers:v()})]),i=e.status==="fulfilled"?await e.value.json():[],s=a.status==="fulfilled"?await a.value.json():[],n=t.status==="fulfilled"?await t.value.json():[],o=[];return i.slice(0,3).forEach(l=>{o.push({type:"laporan",icon:"ðŸ—‘ï¸",title:`Laporan baru dari ${l.nama||"Anonymous"}`,desc:`Status: ${l.status||"pending"}`,time:l.tanggal_lapor?gi(l.tanggal_lapor):"Baru saja"})}),s.slice(0,3).forEach(l=>{o.push({type:"pembayaran",icon:"ðŸ’°",title:"Pembayaran diterima",desc:`Rp ${(l.jumlahBayar||0).toLocaleString()} - ${l.statusBayar||"pending"}`,time:l.tanggalBayar?gi(l.tanggalBayar):"Baru saja"})}),n.slice(0,2).forEach(l=>{o.push({type:"anggota",icon:"ðŸ‘¤",title:`Anggota baru: ${l.nama||"Tanpa nama"}`,desc:`Jenis: ${l.jenisSampah||"Rumah Tangga"}`,time:l.tanggalStart?gi(l.tanggalStart):"Baru saja"})}),o.sort((l,r)=>new Date(r.time)-new Date(l.time)).slice(0,5)}catch(e){return console.error("Error fetching activities:",e),[]}}function gi(e){if(!e)return"Baru saja";try{const a=new Date(e),i=new Date-a,s=Math.floor(i/(1e3*60)),n=Math.floor(i/(1e3*60*60)),o=Math.floor(i/(1e3*60*60*24));return s<1?"Baru saja":s<60?`${s} menit lalu`:n<24?`${n} jam lalu`:o===1?"Kemarin":o<7?`${o} hari lalu`:o<30?`${Math.floor(o/7)} minggu lalu`:`${Math.floor(o/30)} bulan lalu`}catch{return"Baru saja"}}async function Rt(){const e=document.getElementById("mainContent");e.innerHTML=`
        <div class="d-flex flex-column align-items-center justify-content-center py-5 animate-fadeInUp">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Memuat statistik dashboard...</p>
        </div>
    `;try{const[a,t]=await Promise.all([Yr(),ad()]),i=s=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(s);e.innerHTML=`
            <div class="animate-fadeInUp">
                <!-- Header -->
                <div class="mb-4">
                    <h3 class="text-success fw-bold">ðŸ“Š Dashboard Utama</h3>
                    <p class="text-muted mb-1">Selamat datang di panel administrasi CleanUp System</p>
                    <small class="text-muted">
                        <i class="bi bi-clock-history me-1"></i>Terakhir diperbarui: ${new Date().toLocaleTimeString("id-ID")}
                    </small>
                </div>
                
                <!-- Stats Cards Grid (2 rows Ã— 3 columns) -->
                <div class="row g-3 mb-4">
                    <!-- Row 1 -->
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="card stats-card stats-card-success h-100 shadow-sm border-0">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon bg-success bg-opacity-10 text-success me-3">
                                        <i class="bi bi-people-fill"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted text-uppercase small fw-semibold mb-2">Total Users</h6>
                                        <h3 class="text-success fw-bold mb-2">${a.totalUsers.toLocaleString()}</h3>
                                        <small class="text-muted">Semua pengguna terdaftar</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="card stats-card stats-card-primary h-100 shadow-sm border-0">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon bg-primary bg-opacity-10 text-primary me-3">
                                        <i class="bi bi-person-check-fill"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted text-uppercase small fw-semibold mb-2">Anggota Aktif</h6>
                                        <h3 class="text-primary fw-bold mb-2">${a.anggotaAktif.toLocaleString()}</h3>
                                        <small class="text-muted">
                                            ${a.totalUsers>0?`${(a.anggotaAktif/a.totalUsers*100).toFixed(1)}% dari total`:"0% dari total"}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="card stats-card stats-card-warning h-100 shadow-sm border-0">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon bg-warning bg-opacity-10 text-warning me-3">
                                        <i class="bi bi-truck"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted text-uppercase small fw-semibold mb-2">Tim Pengangkut</h6>
                                        <h3 class="text-warning fw-bold mb-2">1</h3>
                      Export Laporan                  <small class="text-muted">Tim aktif hari ini</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Row 2 -->
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="card stats-card stats-card-info h-100 shadow-sm border-0">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon bg-info bg-opacity-10 text-info me-3">
                                        <i class="bi bi-cash-coin"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted text-uppercase small fw-semibold mb-2">Pembayaran Bulan Ini</h6>
                                        <h3 class="text-info fw-bold mb-2">${i(a.totalPembayaranBulanIni)}</h3>
                                        <small class="text-muted">Status lunas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="card stats-card stats-card-danger h-100 shadow-sm border-0">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon bg-danger bg-opacity-10 text-danger me-3">
                                        <i class="bi bi-trash"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted text-uppercase small fw-semibold mb-2">Laporan Sampah</h6>
                                        <h3 class="text-danger fw-bold mb-2">${a.totalLaporan.toLocaleString()}</h3>
                                        <small class="text-muted">Total semua laporan</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="card stats-card stats-card-secondary h-100 shadow-sm border-0">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon bg-secondary bg-opacity-10 text-secondary me-3">
                                        <i class="bi bi-calendar-check"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted text-uppercase small fw-semibold mb-2">Jadwal Hari Ini</h6>
                                        <h3 class="text-secondary fw-bold mb-2">${a.jadwalHariIni.toLocaleString()}</h3>
                                        <small class="text-muted">Pengangkutan terjadwal</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts and Activity Row -->
                <div class="row g-4">
                    <!-- Charts Column -->
                    <div class="col-lg-8">
                        <div class="row g-4">
                            <!-- Trend Chart -->
                            <div class="col-12">
                                <div class="card h-100 shadow-sm border-0">
                                    <div class="card-header bg-success bg-opacity-10 border-0">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-graph-up me-2"></i>Trend Laporan 7 Hari Terakhir
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        ${Xr(t)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User Distribution Chart -->
                            <div class="col-12">
                                <div class="card h-100 shadow-sm border-0">
                                    <div class="card-header bg-primary bg-opacity-10 border-0">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-pie-chart me-2"></i>Distribusi User per Role
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        ${Qr(a.userRoles)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Column -->
                    <div class="col-lg-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header bg-warning bg-opacity-10 border-0 d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-activity me-2"></i>Aktivitas Terbaru
                                </h5>
                                <button class="btn btn-sm btn-outline-success" id="refreshActivity">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div class="card-body p-0 custom-scrollbar" style="max-height: 400px;">
                                <div class="list-group list-group-flush">
                                    ${a.recentActivities.length>0?a.recentActivities.map(s=>`
                                            <div class="list-group-item activity-item border-0">
                                                <div class="d-flex align-items-start">
                                                    <div class="me-3">
                                                        <span class="fs-5">${s.icon}</span>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1 fw-semibold">${s.title}</h6>
                                                        <p class="mb-1 text-muted small">${s.desc}</p>
                                                    </div>
                                                    <small class="text-muted">${s.time}</small>
                                                </div>
                                            </div>
                                        `).join(""):`<div class="text-center py-4">
                                            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
                                            <p class="text-muted">Belum ada aktivitas terbaru</p>
                                        </div>`}
                                </div>
                            </div>
                            
                            <div class="card-footer bg-transparent border-0">
                                <h6 class="mb-3">
                                    <i class="bi bi-lightning-fill me-2 text-success"></i>Aksi Cepat
                                </h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button class="btn btn-outline-success w-100 quick-action-btn" data-page="users">
                                            <i class="bi bi-person-plus me-1"></i>Tambah User
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-primary w-100 quick-action-btn" data-page="jadwal">
                                            <i class="bi bi-calendar-plus me-1"></i>Buat Jadwal
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-warning w-100 quick-action-btn" data-page="reports">
                                            <i class="bi bi-file-earmark-text me-1"></i>Lihat Laporan
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-info w-100 quick-action-btn" id="refreshDashboard">
                                            <i class="bi bi-arrow-repeat me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,setTimeout(()=>{document.querySelectorAll(".quick-action-btn[data-page]").forEach(o=>{o.addEventListener("click",()=>{Nn(o.getAttribute("data-page"))})});const s=document.getElementById("refreshDashboard");s&&s.addEventListener("click",()=>{Rt()});const n=document.getElementById("refreshActivity");n&&n.addEventListener("click",()=>{Rt()})},50)}catch(a){console.error("Error showing dashboard:",a),e.innerHTML=`
            <div class="card border-danger animate-fadeInUp">
                <div class="card-body text-center py-5">
                    <div class="text-danger mb-3">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="text-danger">Gagal Memuat Dashboard</h4>
                    <p class="text-muted">${a.message||"Terjadi kesalahan saat mengambil data"}</p>
                    <button onclick="showDashboardStats()" class="btn btn-success mt-3">
                        <i class="bi bi-arrow-clockwise me-1"></i> Coba Lagi
                    </button>
                </div>
            </div>
        `}}function Xr(e){const a=["12/07","12/08","12/09","12/10","12/11","12/12","12/13"],t=[0,3,2,0,0,0,0],i=["#198754","#28a745","#20c997","#17a2b8","#007bff","#6f42c1","#e83e8c"],s=Math.max(...t,1);return`
        <div>
            <div class="d-flex justify-content-between mb-4">
                <div>
                    <h6 class="text-muted mb-1">Total Laporan</h6>
                    <h3 class="text-success fw-bold">${t.reduce((n,o)=>n+o,0)}</h3>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Rata-rata/hari</h6>
                    <h3 class="text-primary fw-bold">${(t.reduce((n,o)=>n+o,0)/t.length).toFixed(1)}</h3>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Puncak</h6>
                    <h3 class="text-warning fw-bold">${s}</h3>
                </div>
            </div>
            
            <div class="d-flex align-items-end justify-content-between" style="height: 180px;">
                ${t.map((n,o)=>{const l=n===0?10:n/s*100,r=n===0?"#e9ecef":i[o];return`
                        <div class="d-flex flex-column align-items-center" style="width: 14%;">
                            <div class="position-relative mb-2">
                                <div class="trend-bar rounded-top ${a[o]==="12/13"?"border border-2 border-success shadow-sm":""}" 
                                     style="height: ${l}px; background-color: ${r}; width: 35px;"
                                     data-bs-toggle="tooltip" title="${a[o]}: ${n} laporan">
                                </div>
                                <div class="position-absolute top-0 start-50 translate-middle-x mt-1 small fw-bold">
                                    ${n}
                                </div>
                            </div>
                            <small class="text-muted">${a[o]}</small>
                        </div>
                    `}).join("")}
            </div>
        </div>
    `}function Qr(e){const a=Object.keys(e),t=Object.values(e),i=t.reduce((n,o)=>n+o,0);if(a.length===0)return`
            <div class="text-center py-4">
                <i class="bi bi-pie-chart fs-1 text-muted mb-3"></i>
                <p class="text-muted">Belum ada data user</p>
            </div>
        `;const s={admin:"#198754",anggota:"#0d6efd",tamu:"#fd7e14",tim_angkut:"#6f42c1"};return`
        <div>
            <div class="row mb-4">
                ${a.map((n,o)=>{const l=t[o],r=i>0?(l/i*100).toFixed(1):0,c=s[n]||"#6c757d";return`
                        <div class="col-6 mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: ${c};"></div>
                                <span class="fw-semibold">${n==="admin"?"Admin":n==="anggota"?"Anggota":n==="tamu"?"Tamu":n==="tim_angkut"?"Tim Angkut":n}</span>
                                <span class="ms-auto fw-bold">${l}</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${r}%; background-color: ${c};" 
                                     aria-valuenow="${r}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">${r}%</small>
                        </div>
                    `}).join("")}
            </div>
            
            <div class="mt-4 pt-3 border-top">
                <div class="text-center">
                    <h6 class="text-success fw-bold">${i}</h6>
                    <small class="text-muted">Total Pengguna Terdaftar</small>
                </div>
            </div>
        </div>
    `}async function ad(){try{const a=await(await fetch(b.laporanSampah,{headers:v()})).json();return Array.from({length:7},(i,s)=>{const n=new Date;return n.setDate(n.getDate()-s),n.toISOString().split("T")[0]}).reverse().map(i=>({date:i.split("-").slice(1).join("/"),count:a.filter(s=>s.tanggal_lapor===i).length}))}catch{return Array.from({length:7},(e,a)=>({date:"0",count:0}))}}let _=null,la=null,V=null;async function kt(){const e=await Da(),a=document.getElementById("mainContent");if(!e){alert("Silakan login terlebih dahulu!"),window.location.hash="#/login";return}if(e.role!=="anggota"){a.innerHTML=`
            <div class="alert alert-warning shadow-sm">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">Akses Ditolak</h5>
                        <p class="mb-0">Halaman ini hanya untuk anggota. Role Anda: <strong>${e.role}</strong></p>
                    </div>
                </div>
                <div class="mt-3">
                    <button onclick="window.location.hash='#/dashboard'" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Kembali ke Dashboard
                    </button>
                </div>
            </div>
        `;return}let t={},i={...e};try{console.log("ðŸ“¡ Fetching user data...");const s=await fetch(`${b.users}${e.id}/`,{headers:v()});s.ok?(i=await s.json(),console.log("âœ… User data fetched")):console.warn("âš ï¸ Failed to fetch user data"),console.log("ðŸ“¡ Fetching anggota data...");const n=await fetch(`${b.anggota}?user=${e.id}`,{headers:v()});if(n.ok){const o=await n.json();console.log("ðŸ“Š Anggota data:",o),Array.isArray(o)?t=o.length?o[0]:{}:t=o}else console.warn("âš ï¸ Failed to fetch anggota data")}catch(s){console.error("âŒ Error fetching data:",s)}ed(e,i,t)}function ed(e,a,t){const i=document.getElementById("mainContent");i.innerHTML=`
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        
        <div class="container-fluid px-2 px-md-3 py-3">
            <!-- Header Profil -->
            <div class="bg-success bg-gradient text-white rounded-3 shadow-sm mb-3 p-3">
                <div class="row align-items-center">
                    <div class="col-8 col-md-9">
                        <div class="d-flex align-items-center">
                            <div class="bg-white text-success rounded-2 p-2 me-2">
                                <i class="bi bi-person-fill fs-2"></i>
                            </div>
                            <div>
                                <h1 class="h5 fw-bold mb-1">Profil Anggota</h1>
                                <div class="d-flex flex-wrap align-items-center gap-1">
                                    <span class="fs-6 fw-medium">${t.nama||a.first_name||e.username}</span>
                                    <span class="badge bg-white text-success">${t.status||"Anggota"}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 text-end">
                        <div class="badge bg-white bg-opacity-25 text-white p-1 px-2 mb-1">
                            <i class="bi bi-calendar3 me-1"></i>
                            ${pi(t.tanggalStart||t.created_at)}
                        </div>
                        ${t.tanggalEnd?`
                            <div class="badge ${cd(t.tanggalEnd)} bg-opacity-25 p-1 px-2">
                                <i class="bi bi-calendar-x me-1"></i>
                                ${pi(t.tanggalEnd)}
                            </div>
                        `:""}
                    </div>
                </div>
            </div>
            
            <!-- Statistik Ringkas -->
            <div class="row g-2 mb-3">
                <div class="col-6 col-md-3">
                    <div class="card border-success h-100 shadow-sm">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Status</small>
                                    <h6 class="mb-0 fw-bold text-success">${t.status||"Aktif"}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-primary h-100 shadow-sm">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-trash-fill text-primary fs-4"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Jenis Sampah</small>
                                    <h6 class="mb-0 fw-bold text-primary">${t.jenisSampah||t.jenis_sampah||"-"}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-info h-100 shadow-sm">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-clock-history text-info fs-4"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Bergabung</small>
                                    <h6 class="mb-0 fw-bold text-info">${pi(t.tanggalStart||t.created_at)}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-warning h-100 shadow-sm">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-whatsapp text-warning fs-4"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">WhatsApp</small>
                                    <h6 class="mb-0 fw-bold text-warning">
                                        ${t.noWA||t.no_wa?"Tersedia":"-"}
                                    </h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Informasi Detail -->
            <div class="row g-3">
                <!-- Kolom Kiri - Info Pribadi -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-light py-2">
                            <h5 class="mb-0 fw-bold fs-6">
                                <i class="bi bi-person-lines-fill text-success me-2"></i>Informasi Pribadi
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <div class="bg-light rounded-2 p-2">
                                        <small class="text-muted d-block mb-1">
                                            <i class="bi bi-person-badge me-1"></i>Username
                                        </small>
                                        <div class="fw-bold font-monospace">${e.username}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="bg-light rounded-2 p-2">
                                        <small class="text-muted d-block mb-1">
                                            <i class="bi bi-envelope me-1"></i>Email
                                        </small>
                                        <div class="fw-bold">${a.email||"-"}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted mb-1">
                                    <i class="bi bi-person-vcard me-2"></i>Nama Lengkap
                                </label>
                                <div class="bg-light rounded-2 p-2">
                                    <h6 class="mb-0 fw-bold">${t.nama||a.first_name||"-"}</h6>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <label class="form-label fw-bold text-muted mb-1">
                                    <i class="bi bi-whatsapp me-2"></i>Nomor WhatsApp
                                </label>
                                <div class="bg-light rounded-2 p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0 fw-bold">${t.noWA||t.no_wa||"Belum diisi"}</h6>
                                            <small class="${t.noWA||t.no_wa?"text-success":"text-warning"}">
                                                <i class="bi bi-${t.noWA||t.no_wa?"check-circle":"exclamation-circle"} me-1"></i>
                                                ${t.noWA||t.no_wa?"Tersedia":"Belum diisi"}
                                            </small>
                                        </div>
                                        ${t.noWA||t.no_wa?`<a href="https://wa.me/${t.noWA||t.no_wa}" 
                                                target="_blank" 
                                                class="btn btn-success btn-sm">
                                                <i class="bi bi-whatsapp me-1"></i>Chat
                                            </a>`:""}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Kolom Kanan - Info Keanggotaan & Lokasi -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-light py-2">
                            <h5 class="mb-0 fw-bold fs-6">
                                <i class="bi bi-house-fill text-primary me-2"></i>Informasi Keanggotaan
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted mb-1">
                                    <i class="bi bi-house-door me-2"></i>Alamat Lengkap
                                </label>
                                <div class="bg-light rounded-2 p-2">
                                    <p class="mb-0">${t.alamat||"-"}</p>
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <div class="bg-light rounded-2 p-2">
                                        <small class="text-muted d-block mb-1">
                                            <i class="bi bi-geo-alt-fill text-danger me-1"></i>Jenis Sampah
                                        </small>
                                        <div class="fw-bold">${t.jenisSampah||t.jenis_sampah||"-"}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="bg-light rounded-2 p-2">
                                        <small class="text-muted d-block mb-1">
                                            <i class="bi bi-calendar-check me-1"></i>ID Anggota
                                        </small>
                                        <div class="fw-bold font-monospace">
                                            #${t.idAnggota?t.idAnggota.toString().padStart(4,"0"):"-"}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Koordinat Lokasi -->
                            <div class="mb-2">
                                <label class="form-label fw-bold text-muted mb-1 d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-geo-alt me-2"></i>Koordinat Lokasi</span>
                                    ${t.latitude&&t.longitude?'<span class="badge bg-success">Lokasi Tersedia</span>':'<span class="badge bg-warning">Belum Ditentukan</span>'}
                                </label>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">
                                                <i class="bi bi-globe-asia-australia"></i>
                                            </span>
                                            <input type="text" 
                                                class="form-control" 
                                                value="${t.latitude||"Belum ditentukan"}" 
                                                readonly>
                                            ${t.latitude?`<button class="btn btn-outline-secondary btn-sm" 
                                                        onclick="copyToClipboardValue('${t.latitude}')">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>`:""}
                                        </div>
                                        <small class="text-muted">Latitude</small>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">
                                                <i class="bi bi-globe"></i>
                                            </span>
                                            <input type="text" 
                                                class="form-control" 
                                                value="${t.longitude||"Belum ditentukan"}" 
                                                readonly>
                                            ${t.longitude?`<button class="btn btn-outline-secondary btn-sm" 
                                                        onclick="copyToClipboardValue('${t.longitude}')">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>`:""}
                                        </div>
                                        <small class="text-muted">Longitude</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Peta Lokasi -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-light py-2">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <h5 class="mb-1 mb-md-0 fw-bold fs-6">
                            <i class="bi bi-map-fill text-danger me-2"></i>Peta Lokasi Rumah
                        </h5>
                        <div class="d-flex gap-1">
                            ${t.latitude&&t.longitude?`<button onclick="showLocationInMaps(${t.latitude}, ${t.longitude})" 
                                        class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-compass me-1"></i>Buka di Maps
                                </button>`:`<button onclick="useDefaultLocation()" 
                                        class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-geo-alt me-1"></i>Lokasi Default
                                </button>`}
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div style="height: 250px; min-height: 180px;" class="position-relative">
                        ${t.latitude&&t.longitude?`
                            <div id="mapProfil" style="height: 100%;"></div>
                            `:`
                            <div class="h-100 d-flex flex-column align-items-center justify-content-center bg-light p-2">
                                <div class="text-center">
                                    <i class="bi bi-geo-alt-fill text-muted fs-2 mb-2"></i>
                                    <h6 class="text-muted mb-1">Lokasi Belum Ditentukan</h6>
                                    <p class="text-muted mb-2 small">Tambahkan lokasi rumah untuk memudahkan koordinasi</p>
                                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                                        <button onclick="document.getElementById('btnEditProfil').click()" 
                                                class="btn btn-success btn-sm">
                                            <i class="bi bi-plus-circle me-1"></i>Tambah Lokasi
                                        </button>
                                        <button onclick="useDefaultLocation()" 
                                                class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-geo-alt me-1"></i>Lokasi Default
                                        </button>
                                    </div>
                                </div>
                            </div>
                            `}
                    </div>
                </div>
            </div>
            
            <!-- Tombol Aksi -->
            <div class="card shadow-sm mt-3">
                <div class="card-body py-2">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
                        <div class="d-flex gap-2">
                            <button id="btnRefresh" 
                                    class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                            <button id="btnEditProfil" 
                                    class="btn btn-success btn-sm">
                                <i class="bi bi-pencil-square me-1"></i>Edit Profil
                            </button>
                        </div>
                        <button onclick="window.location.hash='#/dashboard'" 
                                class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Kembali
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,document.getElementById("btnEditProfil").onclick=()=>{id(e,a,t)},document.getElementById("btnRefresh").onclick=async()=>{const s=document.getElementById("btnRefresh"),n=s.innerHTML;s.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Memuat...',s.disabled=!0,await kt(),s.innerHTML=n,s.disabled=!1},t.latitude&&t.longitude&&setTimeout(()=>{td(t)},500)}async function td(e){try{if(await new Promise((n,o)=>{ba(()=>{n()})}),await _n("#mapProfil"),!document.getElementById("mapProfil"))throw new Error("Map container not found");window.profileMap&&(window.profileMap.remove(),window.profileMap=null);const t=parseFloat(e.latitude)||-10.1935921,i=parseFloat(e.longitude)||123.6149376;console.log(`ðŸ“ Initializing map at ${t}, ${i}`),window.profileMap=window.L.map("mapProfil").setView([t,i],15),window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19}).addTo(window.profileMap),window.profileMarker=window.L.marker([t,i]).addTo(window.profileMap);const s=`
            <div style="text-align: center;">
                <strong>${e.nama||"Anggota"}</strong><br>
                <small>${e.alamat||""}</small><br>
                <small class="text-muted">${t.toFixed(6)}, ${i.toFixed(6)}</small>
            </div>
        `;window.profileMarker.bindPopup(s).openPopup(),console.log("âœ… Map loaded successfully")}catch(a){console.error("âŒ Error loading map:",a),document.getElementById("mapContainer").innerHTML=`
            <div class="alert alert-warning h-100 d-flex align-items-center justify-content-center">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle display-4 text-warning mb-3"></i>
                    <h5>Peta tidak dapat dimuat</h5>
                    <p class="text-muted">Koordinat: ${e.latitude}, ${e.longitude}</p>
                    <button onclick="loadMap(${JSON.stringify(e)})" class="btn btn-warning btn-sm mt-2">
                        <i class="bi bi-arrow-clockwise me-1"></i>Coba Lagi
                    </button>
                </div>
            </div>
        `}}function _n(e,a=5e3){return new Promise((t,i)=>{const s=Date.now(),n=()=>{const o=document.querySelector(e);o?t(o):Date.now()-s>a?i(new Error(`Element ${e} not found after ${a}ms`)):setTimeout(n,100)};n()})}function id(e,a,t){const i=document.getElementById("mainContent");i.innerHTML=`
        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="card border-primary shadow-sm mb-4">
                <div class="card-body bg-primary bg-opacity-10">
                    <h1 class="text-primary mb-1">
                        <i class="bi bi-pencil-square me-2"></i>Edit Profil Anggota
                    </h1>
                    <p class="text-muted mb-0">Perbarui informasi profil Anda</p>
                </div>
            </div>
            
            <form id="formEditProfil">
                <div class="row">
                    <!-- Kolom Kiri - Data Pribadi -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-person-lines-fill me-2"></i>Data Pribadi
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-person me-1"></i>Nama Lengkap *
                                    </label>
                                    <input type="text" id="editNama" class="form-control" 
                                           value="${t.nama||a.first_name||""}">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-envelope me-1"></i>Email *
                                    </label>
                                    <input type="email" id="editEmail" class="form-control" 
                                           value="${a.email||""}">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-house me-1"></i>Alamat Lengkap *
                                    </label>
                                    <textarea id="editAlamat" class="form-control" rows="3">${t.alamat||""}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-whatsapp me-1"></i>Nomor WhatsApp *
                                    </label>
                                    <input type="tel" id="editNoWA" maxlength="12" class="form-control" 
                                           value="${t.noWA||t.no_wa||""}">
                                    <small class="text-muted">Contoh: 081234567890</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kolom Kanan - Lokasi -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-geo-alt me-2"></i>Lokasi Rumah
                                </h5>
                                <button type="button" id="btnGetCurrentLocation" 
                                        class="btn btn-success btn-sm">
                                    <i class="bi bi-crosshair me-1"></i>Gunakan Lokasi Saya
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label d-block">
                                        <i class="bi bi-map me-1"></i>Pilih Lokasi di Peta
                                    </label>
                                    
                                    <!-- Status GPS -->
                                    <div id="gpsStatus" class="mb-2">
                                        <div id="gpsLoading" style="display: none;">
                                            <span class="spinner-border spinner-border-sm text-primary me-2"></span>
                                            <small class="text-primary">Mendapatkan lokasi GPS...</small>
                                        </div>
                                        <div id="gpsSuccess" style="display: none;">
                                            <i class="bi bi-check-circle-fill text-success me-1"></i>
                                            <small class="text-success">Lokasi GPS berhasil didapatkan!</small>
                                        </div>
                                        <div id="gpsError" style="display: none;">
                                            <i class="bi bi-exclamation-circle-fill text-danger me-1"></i>
                                            <small class="text-danger">Gagal mendapatkan lokasi GPS</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Peta -->
                                    <div id="mapEditContainer" style="height: 250px; border-radius: 6px; border: 1px solid #ddd; position: relative;">
                                        <div id="mapEdit" style="height: 100%;"></div>
                                    </div>
                                    <small class="text-muted mt-2 d-block">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Klik pada peta untuk memilih lokasi atau gunakan GPS
                                    </small>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="bi bi-geo-alt-fill me-1"></i>Latitude *
                                        </label>
                                        <div class="input-group">
                                            <input type="number" step="0.00000001" id="editLatitude" 
                                                   class="form-control" 
                                                   value="${t.latitude||-10.1711872}">
                                            <button type="button" class="btn btn-outline-secondary" 
                                                    onclick="copyEditToClipboard('editLatitude')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="bi bi-geo-alt-fill me-1"></i>Longitude *
                                        </label>
                                        <div class="input-group">
                                            <input type="number" step="0.00000001" id="editLongitude" 
                                                   class="form-control" 
                                                   value="${t.longitude||123.6149376}">
                                            <button type="button" class="btn btn-outline-secondary" 
                                                    onclick="copyEditToClipboard('editLongitude')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tombol Lokasi Cepat -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-lightning-charge me-1"></i>Lokasi Cepat
                                    </label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="setEditFixedLocation(-10.1711872, 123.6149376, 'Lokasi Saya')">
                                            <i class="bi bi-house me-1"></i>Lokasi Saya
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm"
                                                onclick="setEditFixedLocation(-10.1935921, 123.6149376, 'Kota Kupang')">
                                            <i class="bi bi-geo-alt me-1"></i>Kota Kupang
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-trash me-1"></i>Jenis Sampah
                                    </label>
                                    <select id="editJenisSampah" class="form-select">
                                        <option value="Rumah Tangga" ${t.jenisSampah==="Rumah Tangga"||t.jenis_sampah==="Rumah Tangga"?"selected":""}>
                                            Rumah Tangga
                                        </option>
                                        <option value="Tempat Usaha" ${t.jenisSampah==="Tempat Usaha"||t.jenis_sampah==="Tempat Usaha"?"selected":""}>
                                            Tempat Usaha
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tombol Aksi -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <button type="button" id="btnCancel" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>Batal
                            </button>
                            <div>
                                <button type="button" id="btnReset" class="btn btn-outline-warning me-2">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                </button>
                                <button type="submit" id="btnSave" class="btn btn-success">
                                    <i class="bi bi-save me-1"></i>Simpan Perubahan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="formMessage" class="mt-3"></div>
            </form>
        </div>
    `,window.__originalProfileData={nama:t==null?void 0:t.nama,email:(a==null?void 0:a.email)||"",alamat:(t==null?void 0:t.alamat)||"",noWA:(t==null?void 0:t.noWA)||(t==null?void 0:t.no_wa)||"",latitude:(t==null?void 0:t.latitude)||-10.1711872,longitude:(t==null?void 0:t.longitude)||123.6149376,jenisSampah:(t==null?void 0:t.jenisSampah)||(t==null?void 0:t.jenis_sampah)||"Rumah Tangga"},console.log("ðŸ’¾ Saved original profile data:",window.__originalProfileData),document.getElementById("btnCancel").onclick=()=>{kt()},document.getElementById("btnReset").onclick=()=>{document.getElementById("editNama").value=t.nama||a.first_name||"",document.getElementById("editEmail").value=a.email||"",document.getElementById("editAlamat").value=t.alamat||"",document.getElementById("editNoWA").value=t.noWA||t.no_wa||"",document.getElementById("editLatitude").value=t.latitude||-10.1711872,document.getElementById("editLongitude").value=t.longitude||123.6149376,document.getElementById("editJenisSampah").value=t.jenisSampah||t.jenis_sampah||"Rumah Tangga",ld(),Te(`
            <div class="alert alert-info alert-dismissible fade show">
                <i class="bi bi-arrow-clockwise me-2"></i>
                <strong>Form telah direset</strong> ke nilai semula
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `)},document.getElementById("formEditProfil").onsubmit=async s=>{s.preventDefault(),await dd(e,a,t)},document.getElementById("btnGetCurrentLocation").onclick=od,setTimeout(()=>{sd(t)},500)}async function sd(e){try{await new Promise((i,s)=>{ba(()=>{i()})}),await _n("#mapEdit");const a=parseFloat(e.latitude)||-10.1711872,t=parseFloat(e.longitude)||123.6149376;_||(_=window.L.map("mapEdit").setView([a,t],13),window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19}).addTo(_)),la&&_.hasLayer(la)&&_.removeLayer(la),la=window.L.marker([a,t],{draggable:!0,title:"Lokasi Anda",zIndexOffset:100}).addTo(_),la.bindPopup(`
            <div style="max-width: 200px;">
                <strong>ðŸ“ Lokasi Saat Ini</strong><br>
                <small>
                    Lat: ${a.toFixed(6)}<br>
                    Lng: ${t.toFixed(6)}
                </small>
            </div>
        `).openPopup(),_.on("click",i=>{const{lat:s,lng:n}=i.latlng;V&&_.hasLayer(V)&&(_.removeLayer(V),V=null),ze(s,n),li(s,n),$e("manual")}),la.on("dragend",i=>{const s=la.getLatLng();V&&_.hasLayer(V)&&(_.removeLayer(V),V=null),ze(s.lat,s.lng),$e("manual"),la.bindPopup(`
                <div style="max-width: 200px;">
                    <strong>ðŸ“ Lokasi Manual</strong><br>
                    <small>
                        Lat: ${s.lat.toFixed(6)}<br>
                        Lng: ${s.lng.toFixed(6)}
                    </small>
                </div>
            `).openPopup()}),document.getElementById("editLatitude").addEventListener("input",ks),document.getElementById("editLongitude").addEventListener("input",ks),console.log("âœ… Edit map loaded successfully")}catch(a){console.error("âŒ Error loading edit map:",a),document.getElementById("mapEditContainer").innerHTML=`
            <div class="alert alert-warning h-100 d-flex align-items-center justify-content-center">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle display-4 text-warning mb-3"></i>
                    <h5>Peta tidak dapat dimuat</h5>
                    <p class="text-muted">Gunakan input manual untuk koordinat</p>
                </div>
            </div>
        `}}function nd(){return new Promise((e,a)=>{if(console.log("ðŸ” Meminta izin GPS..."),!navigator.geolocation){console.error("âŒ Browser tidak mendukung geolocation"),a(new Error("Browser Anda tidak mendukung GPS"));return}const t={enableHighAccuracy:!0,timeout:3e4,maximumAge:0};navigator.geolocation.getCurrentPosition(i=>{const s=i.coords.latitude,n=i.coords.longitude,o=i.coords.accuracy;console.log("âœ… GPS Berhasil:",{lat:s,lng:n,accuracy:`${o}m`,source:i.coords.altitude?"GPS":"Network"}),e({lat:s,lng:n,accuracy:o})},i=>{console.error("âŒ GPS Error:",i);let s="Gagal mendapatkan lokasi GPS",n="unknown";switch(i.code){case i.PERMISSION_DENIED:s="Izin GPS ditolak. Silakan izinkan akses lokasi di browser Anda.",n="permission";break;case i.POSITION_UNAVAILABLE:s="GPS tidak tersedia. Pastikan GPS perangkat aktif.",n="unavailable";break;case i.TIMEOUT:s="Waktu tunggu GPS habis. Coba lagi atau gunakan lokasi manual.",n="timeout";break;default:s="Error GPS tidak diketahui.",n="unknown"}if(console.log("ðŸ”„ Mencoba fallback ke network location..."),i.code===i.TIMEOUT){const o={enableHighAccuracy:!1,timeout:5e3,maximumAge:6e4};navigator.geolocation.getCurrentPosition(l=>{const r=l.coords.latitude,c=l.coords.longitude,d=l.coords.accuracy;console.log("âœ… Network Location Berhasil (fallback):",{lat:r,lng:c,accuracy:d}),e({lat:r,lng:c,accuracy:d,source:"network",note:"Lokasi dari jaringan (kurang akurat)"})},l=>{a({message:`${s} | Fallback juga gagal`,type:n,code:i.code})},o)}else a({message:s,type:n,code:i.code})},t)})}async function od(){const e=document.getElementById("btnGetCurrentLocation");if(e){e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Memuat...',$e("loading");try{const{lat:a,lng:t}=await nd();if(console.log("ðŸ“ GPS Real Location Found:",a,t),ze(a,t),_){_.setView([a,t],17),V&&_.hasLayer(V)&&_.removeLayer(V);const i=window.L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});V=window.L.marker([a,t],{icon:i,title:"LOKASI SAYA (GPS REAL)",zIndexOffset:1e3}).addTo(_),V.bindPopup(`
                <div style="max-width: 250px;">
                    <div style="background: linear-gradient(135deg, #198754, #146c43); color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: -10px -15px 10px -15px;">
                        <strong style="font-size: 0.9rem;">
                            <i class="bi bi-crosshair"></i> LOKASI GPS REAL
                        </strong>
                    </div>
                    <div style="padding: 10px 0;">
                        <div style="font-family: monospace; font-size: 0.8rem; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                            <span style="color: #198754;">Lat:</span> ${a.toFixed(6)}<br>
                            <span style="color: #198754;">Lng:</span> ${t.toFixed(6)}
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i> Lokasi GPS dari perangkat Anda
                        </small>
                    </div>
                </div>
            `).openPopup(),window.L.circle([a,t],{color:"#198754",fillColor:"#198754",fillOpacity:.15,radius:50}).addTo(_),setTimeout(()=>{_.invalidateSize()},100)}$e("success"),e.disabled=!1,e.innerHTML='<i class="bi bi-crosshair me-1"></i>Lokasi Saya',Te(`
            <div class="alert alert-success alert-dismissible fade show border-0 shadow-sm">
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                    <div>
                        <strong class="d-block">GPS Real Ditemukan!</strong>
                        <small class="text-muted">Lokasi: ${a.toFixed(6)}, ${t.toFixed(6)}</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `)}catch(a){console.error("GPS Real Error:",a),console.log("âš ï¸ Menggunakan lokasi tetap sebagai fallback"),ze(-10.1711872,123.6149376),$e("error"),e.disabled=!1,e.innerHTML='<i class="bi bi-crosshair me-1"></i>Lokasi Saya',Te(`
            <div class="alert alert-warning alert-dismissible fade show border-0 shadow-sm">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                    <div>
                        <strong class="d-block">${a.message}</strong>
                        <small class="text-muted">Menggunakan lokasi default sebagai pengganti</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `)}}}function ld(){if(_){const e=-10.1935921,a=123.6149376;_.setView([e,a],13),V&&_.hasLayer(V)&&(_.removeLayer(V),V=null),la&&_.hasLayer(la)&&(la.setOpacity(1),la.setLatLng([e,a]),la.bindPopup(`
                <div style="max-width: 200px;">
                    <strong>ðŸ“ Lokasi Default</strong><br>
                    <small>
                        Lat: ${e}<br>
                        Lng: ${a}
                    </small>
                </div>
            `).openPopup()),ze(e,a),$e("manual"),setTimeout(()=>{_.invalidateSize()},200),Te(`
            <div class="alert alert-info alert-dismissible fade show">
                <i class="bi bi-info-circle-fill me-2"></i>
                <strong>Peta direset</strong> ke lokasi default
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `)}}function $e(e){const a=document.getElementById("gpsLoading"),t=document.getElementById("gpsSuccess"),i=document.getElementById("gpsError");if(!(!a||!t||!i))switch(a.style.display="none",t.style.display="none",i.style.display="none",e){case"loading":a.style.display="block";break;case"success":t.innerHTML=`
                <i class="bi bi-check-circle-fill text-success me-1"></i>
                <small class="text-success">ðŸ“ Lokasi GPS Anda diterapkan!</small>
            `,t.style.display="block";break;case"error":i.innerHTML=`
                <i class="bi bi-exclamation-circle-fill text-danger me-1"></i>
                <small class="text-danger">Gagal mendapatkan lokasi GPS</small>
            `,i.style.display="block";break;case"manual":t.innerHTML=`
                <i class="bi bi-geo-alt-fill text-primary me-1"></i>
                <small class="text-primary">ðŸ“ Lokasi dipilih manual di peta</small>
            `,t.style.display="block";break}}function ze(e,a){const t=document.getElementById("editLatitude"),i=document.getElementById("editLongitude");t&&i&&(t.value=e,i.value=a)}function li(e,a){la&&_.hasLayer(la)&&(la.setLatLng([e,a]),la.setOpacity(1),la.bindPopup(`
            <div style="max-width: 200px;">
                <strong>ðŸ“ Lokasi Manual</strong><br>
                <small>
                    Lat: ${e.toFixed(6)}<br>
                    Lng: ${a.toFixed(6)}
                </small>
            </div>
        `).openPopup())}function ks(){if(!_)return;const e=parseFloat(document.getElementById("editLatitude").value),a=parseFloat(document.getElementById("editLongitude").value);isNaN(e)||isNaN(a)||(li(e,a),_.setView([e,a],_.getZoom()))}window.setFixedLocation=function(e,a,t){ze(e,a),_&&(_.setView([e,a],17),V&&_.hasLayer(V)&&(_.removeLayer(V),V=null),li(e,a),$e("manual"),setTimeout(()=>{_.invalidateSize()},100)),Te(`
        <div class="alert alert-info alert-dismissible fade show">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Lokasi diterapkan:</strong> ${t}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `)};window.copyEditToClipboard=function(e){const a=document.getElementById(e);if(a){a.select(),document.execCommand("copy");const t=a.value;a.value="âœ“ Disalin!",setTimeout(()=>{a.value=t},1e3),Te(`
            <div class="alert alert-success alert-dismissible fade show">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>Berhasil disalin!</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `)}};window.copyToClipboardValue=function(e){const a=document.getElementById(e);if(a){a.select(),document.execCommand("copy");const t=a.value;a.value="âœ“ Disalin!",setTimeout(()=>{a.value=t},1e3),Te(`
            <div class="alert alert-success alert-dismissible fade show">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>Berhasil disalin!</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `)}};window.setEditFixedLocation=function(e,a,t){ze(e,a),_&&(_.setView([e,a],17),V&&_.hasLayer(V)&&(_.removeLayer(V),V=null),li(e,a),$e("manual"),setTimeout(()=>{_.invalidateSize()},100)),Te(`
        <div class="alert alert-info alert-dismissible fade show">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Lokasi diterapkan:</strong> ${t}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `)};window.getCurrentLocationView=function(){const e=-10.1711872,a=123.6149376;window.profileMap&&(window.profileMap.setView([e,a],17),window.profileGPSMarker?(window.profileGPSMarker.setLatLng([e,a]),window.profileGPSMarker.openPopup()):(window.profileGPSMarker=window.L.marker([e,a],{icon:window.L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),title:"LOKASI SAYA (GPS)",draggable:!1,zIndexOffset:1e3}).addTo(window.profileMap),window.profileGPSMarker.bindPopup(`
                <div style="max-width: 250px;">
                    <strong style="color: #4CAF50;">ðŸ“ LOKASI SAYA</strong><br>
                    <small>
                        <b>Lat:</b> ${e}<br>
                        <b>Lng:</b> ${a}<br>
                        <i>Lokasi tetap Anda</i>
                    </small>
                </div>
            `).openPopup()),x("Menggunakan lokasi Anda: -10.1711872, 123.6149376","success"))};window.resetMapView=function(){window.profileMap&&(window.profileMap.setView([-10.1935921,123.6149376],13),window.profileGPSMarker&&(window.profileMap.removeLayer(window.profileGPSMarker),window.profileGPSMarker=null),x("Peta direset ke lokasi default Kupang","info"))};function Te(e){const a=document.getElementById("formMessage");a&&(a.innerHTML=e,setTimeout(()=>{a.innerHTML===e&&(a.innerHTML="")},3e3))}function Ia(e,a,t=!1){const i=document.getElementById(e);if(!i)return;const s=i.parentElement.querySelector(".validation-feedback");if(s&&s.remove(),i.classList.remove("is-valid","is-invalid"),a){const n=document.createElement("div");n.className=`validation-feedback ${t?"valid-feedback":"invalid-feedback"}`,n.innerHTML=`<i class="bi ${t?"bi-check-circle":"bi-exclamation-circle"} me-1"></i>${a}`,i.classList.add(t?"is-valid":"is-invalid"),i.parentElement.appendChild(n)}}function rd(e,a){return!e||!a?!0:Object.keys(a).some(t=>{const i=e[t],s=a[t],n=i!=null?String(i):"",o=s!=null?String(s):"";return console.log(`ðŸ” Comparing ${t}: "${n}" vs "${o}"`),n.trim()!==o.trim()})}async function dd(e,a,t){const i=document.getElementById("btnSave"),s=document.getElementById("formMessage");document.querySelectorAll(".validation-feedback").forEach(B=>B.remove()),document.querySelectorAll("#formEditProfil input, #formEditProfil textarea, #formEditProfil select").forEach(B=>{B.classList.remove("is-valid","is-invalid")});const l=document.getElementById("editNama").value.trim(),r=document.getElementById("editEmail").value.trim(),c=document.getElementById("editAlamat").value.trim(),d=document.getElementById("editNoWA").value.trim(),m=parseFloat(document.getElementById("editLatitude").value),u=parseFloat(document.getElementById("editLongitude").value),g=document.getElementById("editJenisSampah").value,p=d.replace(/\D/g,""),h={nama:l,email:r,alamat:c,noWA:p,latitude:m,longitude:u,jenisSampah:g};window.__originalProfileData||(window.__originalProfileData={nama:(t==null?void 0:t.nama)||"",email:(a==null?void 0:a.email)||"",alamat:(t==null?void 0:t.alamat)||"",noWA:(t==null?void 0:t.noWA)||(t==null?void 0:t.no_wa)||"",latitude:(t==null?void 0:t.latitude)||-10.1711872,longitude:(t==null?void 0:t.longitude)||123.6149376,jenisSampah:(t==null?void 0:t.jenisSampah)||(t==null?void 0:t.jenis_sampah)||"Rumah Tangga"});const f=window.__originalProfileData||{};console.log("ðŸ“Š Original Data:",f),console.log("ðŸ“Š Current Data:",h);const k=rd(f,h);if(console.log("ðŸ”„ Has changed?",k),!k){s&&(s.innerHTML=`
                <div class="alert alert-warning alert-dismissible fade show border-0 shadow-sm">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                        <div>
                            <strong class="d-block">Tidak ada perubahan data</strong>
                            <small class="text-muted">
                                Silakan ubah minimal satu field sebelum menyimpan
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);return}let w=!0;if(l?l.length<3?(Ia("editNama","Nama minimal 3 karakter"),w=!1):Ia("editNama","Nama valid",!0):(Ia("editNama","Nama lengkap harus diisi"),w=!1),r?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)?Ia("editEmail","Email valid",!0):(Ia("editEmail","Format email tidak valid"),w=!1):(Ia("editEmail","Email harus diisi"),w=!1),c?c.length<10?(Ia("editAlamat","Alamat terlalu pendek"),w=!1):Ia("editAlamat","Alamat valid",!0):(Ia("editAlamat","Alamat harus diisi"),w=!1),d?p.length<10||p.length>12?(Ia("editNoWA","Nomor WhatsApp harus 10-12 digit"),w=!1):/^[0-9]+$/.test(p)?Ia("editNoWA","Nomor WhatsApp valid",!0):(Ia("editNoWA","Hanya angka yang diperbolehkan"),w=!1):(Ia("editNoWA","Nomor WhatsApp harus diisi"),w=!1),!w){const B=document.querySelector(".is-invalid");B&&(B.scrollIntoView({behavior:"smooth",block:"center"}),B.focus()),s&&(s.innerHTML=`
                <div class="alert alert-warning alert-dismissible fade show border-0 shadow-sm">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div>
                            <strong class="d-block">Terdapat kesalahan dalam pengisian form</strong>
                            <small class="text-muted">Silakan perbaiki field yang ditandai dengan warna merah</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);return}const y={email:r},A={user:e.id,nama:l,alamat:c,noWA:p,latitude:m,longitude:u,jenisSampah:g};let E=null;t&&(t.idAnggota?E=t.idAnggota:t.id&&(E=t.id)),console.log("Anggota ID:",E),i.disabled=!0;const C=i.innerHTML;i.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',x("Menyimpan perubahan profil...","info"),s&&(s.innerHTML=`
            <div class="alert alert-info alert-dismissible fade show border-0 shadow-sm">
                <div class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-3"></span>
                    <div>
                        <strong class="d-block">Menyimpan perubahan...</strong>
                        <small class="text-muted">Mohon tunggu sebentar</small>
                    </div>
                </div>
            </div>
        `);try{console.log("Updating user data...");const B=await fetch(`${b.users}${e.id}/`,{method:"PATCH",headers:v(),body:JSON.stringify(y)});if(!B.ok)throw new Error(`Gagal update user: ${B.status}`);x("Anggota Berhasil di Perbarui","success"),alert("âœ“ Anggota Berhasil di Perbarui");let I;if(E?(console.log(`Updating existing anggota: ${E}`),I=await fetch(`${b.anggota}${E}/`,{method:"PATCH",headers:v(),body:JSON.stringify(A)})):(console.log("Creating new anggota"),I=await fetch(b.anggota,{method:"POST",headers:v(),body:JSON.stringify(A)})),!I.ok)throw new Error(`Gagal update anggota: ${I.status}`);console.log("Anggota updated successfully");try{const D=JSON.parse(localStorage.getItem("user")||"{}");D.email=r,localStorage.setItem("user",JSON.stringify(D));const U=await I.json();localStorage.setItem("anggota",JSON.stringify(U)),console.log("LocalStorage updated")}catch(D){console.warn("Failed to update localStorage:",D)}s&&(s.innerHTML=`
                <div class="alert alert-success alert-dismissible fade show border-0 shadow-sm">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                        <div>
                            <strong class="d-block">Profil Berhasil Diperbarui!</strong>
                            <small class="text-muted">Halaman akan dimuat ulang...</small>
                        </div>
                    </div>
                </div>
            `),i.innerHTML='<i class="bi bi-check-circle me-1"></i>Berhasil!',i.classList.remove("btn-success"),i.classList.add("btn-success","disabled"),setTimeout(()=>{kt()},2e3)}catch(B){console.error("Update error:",B),i.disabled=!1,i.innerHTML=C;let I="Gagal memperbarui profil",D=B.message;B.message.includes("401")||B.message.includes("403")?(I="Akses ditolak",D="Silakan login ulang untuk melanjutkan"):B.message.includes("404")?(I="Data tidak ditemukan",D="Data yang ingin diperbarui tidak ditemukan di server"):B.message.includes("400")&&(I="Data tidak valid",D="Periksa kembali data yang Anda masukkan"),s&&(s.innerHTML=`
                <div class="alert alert-danger alert-dismissible fade show border-0 shadow-sm">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div>
                            <strong class="d-block">${I}</strong>
                            <small class="text-muted">${D}</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `)}}const Fn=document.createElement("style");Fn.textContent=`
    .validation-feedback {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.875em;
    }
    .valid-feedback {
        color: #198754;
    }
    .invalid-feedback {
        color: #dc3545;
    }
    .is-valid {
        border-color: #198754;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    .is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    .is-valid:focus, .is-invalid:focus {
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-success-rgb), 0.25);
    }
    .is-invalid:focus {
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-danger-rgb), 0.25);
    }
`;document.head.appendChild(Fn);function pi(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})}catch{return e}}function cd(e){if(!e)return"bg-secondary";try{const a=new Date,t=new Date(e),i=Math.ceil((t-a)/(1e3*60*60*24));return i<=0?"bg-danger":i<=7?"bg-warning":"bg-info"}catch{return"bg-secondary"}}let va=null,Be=null,bi=null;async function md(e){try{console.log("Loading laporan detail for ID:",e);const a=await fetch(`${b.laporanSampah}${e}/`,{headers:v()});if(!a.ok){const i=await a.json();throw new Error(i.detail||`Gagal mengambil data laporan: ${a.status}`)}const t=await a.json();va=t,ud(t)}catch(a){console.error("Error loading laporan detail:",a),alert(`âŒ Gagal memuat detail laporan: ${a.message}`)}}function Hn(){return new Promise((e,a)=>{if(!navigator.geolocation){a(new Error("GPS tidak didukung oleh browser"));return}navigator.geolocation.getCurrentPosition(t=>{e({latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy,timestamp:new Date(t.timestamp)})},t=>{let i="Gagal mendapatkan lokasi GPS: ";switch(t.code){case t.PERMISSION_DENIED:i+="Izin ditolak. Izinkan akses lokasi di pengaturan browser.";break;case t.POSITION_UNAVAILABLE:i+="Informasi lokasi tidak tersedia.";break;case t.TIMEOUT:i+="Permintaan waktu habis.";break;default:i+="Error tidak diketahui."}a(new Error(i))},{enableHighAccuracy:!0,timeout:3e4,maximumAge:0})})}function ws(e,a,t,i="red",s="ðŸ—‘ï¸"){let n="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png";if(i==="green"){const r=L.divIcon({className:"user-marker-custom",html:`
                <div style="
                    background: #4CAF50;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 0 10px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 14px;
                    font-weight: bold;
                ">
                    ${s}
                </div>
            `,iconSize:[30,30],iconAnchor:[15,15]});return L.marker([e,a],{icon:r}).bindPopup(t)}const o=L.icon({iconUrl:n,shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});return L.marker([e,a],{icon:o}).bindPopup(t)}function ud(e){const a=document.getElementById("laporanDetailModal");a&&a.remove();const t=document.createElement("div");t.id="laporanDetailModal";const i=kd(e.status),s=Un(e.status),n=Gn(e.tanggal_lapor);t.innerHTML=`
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;">
            <div style="background: white; padding: 0; border-radius: 10px; width: 95%; max-width: 1000px; max-height: 95vh; overflow-y: auto;">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px 25px; border-radius: 10px 10px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h2 style="margin: 0; font-size: 24px;">ðŸ—‘ï¸ Detail Laporan Sampah</h2>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">ID: #${e.idLaporan}</p>
                        </div>
                        <button onclick="closeLaporanDetailModal()" 
                                style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            Ã—
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div style="padding: 6px 16px; background: ${i}; color: white; border-radius: 20px; font-weight: bold; font-size: 14px;">
                            ${s}
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">
                            ðŸ“… ${n}
                        </div>
                        <div style="font-size: 14px; opacity: 0.9; display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 15px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #4CAF50;"></div>
                            <span>ðŸ“ GPS Aktif</span>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div style="padding: 25px;">
                    <div style="display: flex; flex-direction: column; gap: 25px;">
                        <!-- ROW 1: Peta Besar di Atas -->
                        ${e.latitude&&e.longitude?`
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">ðŸ—ºï¸</span> Peta Lokasi
                                    <span style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
                                        <span style="display: flex; align-items: center; gap: 5px;">
                                            <div style="width: 12px; height: 12px; background: #FF5252; border-radius: 50%;"></div>
                                            <small style="font-size: 12px; color: #666;">Lokasi Sampah</small>
                                        </span>
                                        <span style="display: flex; align-items: center; gap: 5px;">
                                            <div style="width: 12px; height: 12px; background: #4CAF50; border-radius: 50%;"></div>
                                            <small style="font-size: 12px; color: #666;">Lokasi Saya</small>
                                        </span>
                                    </span>
                                </h3>
                                <div id="detailMap" style="height: 400px; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></div>
                                
                                <!-- Controls -->
                                <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between;">
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="showLocationOnGoogleMaps(${e.latitude}, ${e.longitude})" 
                                                style="background: #4285F4; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                            <span>ðŸŒ</span> Buka di Google Maps
                                        </button>
                                        <button onclick="zoomInMap()" 
                                                style="background: #757575; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                            <span>âž•</span> Zoom In
                                        </button>
                                        <button onclick="zoomOutMap()" 
                                                style="background: #757575; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                            <span>âž–</span> Zoom Out
                                        </button>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <button onclick="centerToSampahMarker()" 
                                                style="background: #FF5252; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                            <span>ðŸ—‘ï¸</span> Fokus ke Sampah
                                        </button>
                                        <button onclick="centerToUserMarker()" 
                                                style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                            <span>ðŸ“</span> Fokus ke Saya
                                        </button>
                                        <button onclick="fitBothMarkers()" 
                                                style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                            <span>ðŸ”</span> Lihat Keduanya
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- GPS Info -->
                                <div id="gpsInfoBox" style="margin-top: 15px; background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #4CAF50; display: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-size: 14px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸ“</span> Informasi Lokasi
                                            </div>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                <span id="distanceInfo">Menghitung jarak...</span>
                                            </div>
                                        </div>
                                        <button onclick="updateUserLocation()" 
                                                style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 5px;">
                                            <span>ðŸ”„</span> Update GPS
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `:""}
                        
                        <!-- ROW 2: Grid untuk Info dan Foto (sama seperti sebelumnya) -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px;">
                            <!-- Left Column: Informasi Lengkap -->
                            <div>
                                <!-- Reporter & Status Info -->
                                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div>
                                            <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                                <span style="font-size: 18px;">ðŸ‘¤</span> Pelapor
                                            </h3>
                                            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                                <div style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px;">
                                                    ${e.nama||"Tidak diketahui"}
                                                </div>
                                                ${e.idUser?`
                                                    <div style="font-size: 13px; color: #666;">ID: ${e.idUser}</div>
                                                `:""}
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                                <span style="font-size: 18px;">ðŸ“Š</span> Status
                                            </h3>
                                            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #e0e0e0; text-align: center;">
                                                <div style="padding: 8px 16px; background: ${i}; color: white; border-radius: 20px; font-weight: bold; font-size: 14px; display: inline-block;">
                                                    ${s}
                                                </div>
                                                <div style="margin-top: 10px; font-size: 13px; color: #666;">
                                                    ${wd(e.status)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Location Details -->
                                <div style="margin-bottom: 20px;">
                                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px;">ðŸ“</span> Detail Lokasi
                                    </h3>
                                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                        <div style="margin-bottom: 15px;">
                                            <div style="font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold;">ALAMAT</div>
                                            <div style="font-size: 15px; color: #333; line-height: 1.5; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                                ${e.alamat||"Tidak ada alamat"}
                                            </div>
                                        </div>
                                        
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div>
                                                <div style="font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold;">LATITUDE</div>
                                                <div style="font-family: monospace; font-size: 14px; color: #333; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                                    ${e.latitude||"-"}
                                                </div>
                                            </div>
                                            <div>
                                                <div style="font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold;">LONGITUDE</div>
                                                <div style="font-family: monospace; font-size: 14px; color: #333; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                                    ${e.longitude||"-"}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Description -->
                                <div>
                                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px;">ðŸ“</span> Deskripsi Lengkap
                                    </h3>
                                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 200px;">
                                        <div style="font-size: 15px; color: #333; line-height: 1.6; white-space: pre-wrap;">
                                            ${e.deskripsi||"Tidak ada deskripsi"}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column: Foto Bukti -->
                            <div>
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 18px;">ðŸ“·</span> Foto Bukti
                                </h3>
                                ${e.foto_bukti?`
                                    <div style="position: relative;">
                                        <img src="${e.foto_bukti}" 
                                             alt="Foto Bukti Laporan" 
                                             style="width: 100%; height: 300px; border-radius: 10px; border: 1px solid #ddd; object-fit: cover; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="position: absolute; bottom: 10px; right: 10px;">
                                            <a href="${e.foto_bukti}" 
                                               target="_blank" 
                                               style="background: rgba(0,0,0,0.7); color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                                                ðŸ” Full Size
                                            </a>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; text-align: center;">
                                        <small style="color: #666; font-size: 12px;">Klik Full Size untuk melihat gambar asli</small>
                                    </div>
                                `:`
                                    <div style="background: #f8f9fa; padding: 60px 20px; border-radius: 10px; text-align: center; height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed #ddd;">
                                        <div style="font-size: 48px; margin-bottom: 15px; color: #ccc;">ðŸ“·</div>
                                        <div style="color: #666; margin-bottom: 10px;">Tidak ada foto bukti</div>
                                        <small style="color: #999;">Foto tidak diunggah saat laporan dibuat</small>
                                    </div>
                                `}
                                
                                <!-- Additional Info -->
                                <div style="margin-top: 25px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ðŸ“‹ Informasi Tambahan</h4>
                                    <div style="font-size: 12px; color: #666;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span>ID Laporan:</span>
                                            <span style="font-weight: bold;">#${e.idLaporan}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span>Tanggal Dibuat:</span>
                                            <span>${xd(e.tanggal_lapor)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- User GPS Info -->
                                <div id="userGPSBox" style="margin-top: 25px; background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                    <h4 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                        <span>ðŸ“</span> Lokasi Saya
                                    </h4>
                                    <div style="font-size: 12px; color: #2e7d32;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Status GPS:</strong> <span id="gpsStatusText">Memuat...</span>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Jarak ke Lokasi Sampah:</strong> <span id="distanceResult">-</span>
                                        </div>
                                        <button onclick="showDirections()" 
                                                style="margin-top: 10px; background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 5px;">
                                            <span>ðŸ§­</span> Tunjuk Arah ke Sampah
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="printLaporan(${e.idLaporan})" 
                                    style="background: #2196F3; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; font-weight: bold;">
                                <span style="font-size: 16px;">ðŸ–¨ï¸</span> Cetak Laporan
                            </button>
                            
                            ${e.latitude&&e.longitude?`
                                <button onclick="shareLaporanLocation(${e.latitude}, ${e.longitude}, '${e.alamat||""}')" 
                                        style="background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 16px;">ðŸ“¤</span> Bagikan Lokasi
                                </button>
                            `:""}
                            
                            <button onclick="drawRouteToSampah()" 
                                    style="background: #FF9800; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">ðŸ›£ï¸</span> Gambar Rute
                            </button>
                            
                            <button onclick="closeLaporanDetailModal()" 
                                    style="background: #757575; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `,document.body.appendChild(t),e.latitude&&e.longitude&&ba(()=>{gd(e,s)})}async function gd(e,a){const t=parseFloat(e.latitude),i=parseFloat(e.longitude);Be=Se("detailMap",t,i,14);const s=[[t,i]],n=ws(t,i,`
        <div style="max-width: 250px;">
            <div style="font-weight: bold; color: #FF5252; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                <span>ðŸ—‘ï¸</span> LOKASI SAMPAH
            </div>
            <hr style="margin: 5px 0; border-color: #eee;">
            <div><strong>ID:</strong> #${e.idLaporan}</div>
            <div><strong>Status:</strong> ${a}</div>
            <div><strong>Pelapor:</strong> ${e.nama||"-"}</div>
            <div><strong>Alamat:</strong> ${e.alamat?e.alamat.substring(0,50)+"...":"-"}</div>
            <div><strong>Koordinat:</strong><br>${t.toFixed(6)}, ${i.toFixed(6)}</div>
            <hr style="margin: 8px 0; border-color: #eee;">
            <button onclick="showLocationOnGoogleMaps(${t}, ${i})" 
                    style="background: #4285F4; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-top: 5px;">
                Buka di Google Maps
            </button>
        </div>
        `,"red","ðŸ—‘ï¸");n.addTo(Be),window.sampahMarker=n;try{console.log("Mencoba mendapatkan lokasi GPS pengguna...");const o=await Hn(),l=o.latitude,r=o.longitude,c=o.accuracy;console.log("GPS pengguna ditemukan:",{userLat:l,userLng:r,accuracy:c}),bi=ws(l,r,`
            <div style="max-width: 250px;">
                <div style="font-weight: bold; color: #4CAF50; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                    <span>ðŸ“</span> LOKASI SAYA
                </div>
                <hr style="margin: 5px 0; border-color: #eee;">
                <div><strong>Koordinat:</strong><br>${l.toFixed(6)}, ${r.toFixed(6)}</div>
                <div><strong>Akurasi:</strong> ${c?`${c.toFixed(1)} meter`:"Tidak diketahui"}</div>
                <div><strong>Waktu:</strong> ${new Date().toLocaleTimeString("id-ID")}</div>
                <div><strong>Jarak ke Sampah:</strong><br><span id="userToSampahDistance">Menghitung...</span></div>
                <hr style="margin: 8px 0; border-color: #eee;">
                <button onclick="centerToUserMarker()" 
                        style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-right: 5px;">
                    Fokus ke Saya
                </button>
                <button onclick="showLocationOnGoogleMaps(${l}, ${r})" 
                        style="background: #4285F4; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                    Buka di GMaps
                </button>
            </div>
            `,"green","ðŸ“"),bi.addTo(Be),window.userMarker=bi,s.push([l,r]);const d=Vi(l,r,t,i);if(Wi(d),document.getElementById("gpsInfoBox").style.display="block",document.getElementById("gpsStatusText").textContent="Aktif",s.length>1){const m=L.latLngBounds(s);Be.fitBounds(m,{padding:[80,80],maxZoom:16})}}catch(o){console.error("Error mendapatkan GPS pengguna:",o),document.getElementById("gpsStatusText").textContent="Gagal",document.getElementById("userGPSBox").innerHTML+=`
            <div style="color: #f44336; font-size: 11px; margin-top: 5px;">
                âš ï¸ ${o.message}
            </div>
        `,Be.setView([t,i],14)}window.detailMapInstance=Be,window.mapInstance=Be}function Vi(e,a,t,i){function s(n,o,l,r){const d=n*Math.PI/180,m=l*Math.PI/180,u=(l-n)*Math.PI/180,g=(r-o)*Math.PI/180,p=Math.sin(u/2)*Math.sin(u/2)+Math.cos(d)*Math.cos(m)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))}return s(e,a,t,i)}function Wi(e){let a;e<1e3?a=`${Math.round(e)} meter`:a=`${(e/1e3).toFixed(2)} km`;const t=document.getElementById("distanceInfo"),i=document.getElementById("distanceResult");if(t&&(t.textContent=`Jarak ke lokasi sampah: ${a}`),i&&(i.textContent=a),window.userMarker){const n=window.userMarker.getPopup().getContent().replace('<span id="userToSampahDistance">Menghitung...</span>',`<span id="userToSampahDistance">${a}</span>`);window.userMarker.setPopupContent(n)}return a}async function pd(){try{const e=await Hn(),a=e.latitude,t=e.longitude;if(window.userMarker){window.userMarker.setLatLng([a,t]);const s=window.userMarker.getPopup().getContent().replace(/Koordinat:<br>[\d\.\-]+,\s[\d\.\-]+/,`Koordinat:<br>${a.toFixed(6)}, ${t.toFixed(6)}`).replace(/Waktu:[^<]+/,`Waktu: ${new Date().toLocaleTimeString("id-ID")}`);if(window.userMarker.setPopupContent(s),window.sampahMarker){const n=window.sampahMarker.getLatLng(),o=Vi(a,t,n.lat,n.lng);Wi(o)}alert(`ðŸ“ Lokasi diperbarui: ${a.toFixed(6)}, ${t.toFixed(6)}`)}}catch(e){alert(`âš ï¸ Gagal update lokasi: ${e.message}`)}}function bd(){if(window.userMarker&&window.sampahMarker&&window.mapInstance){const e=window.userMarker.getLatLng(),a=window.sampahMarker.getLatLng();window.routePolyline&&window.mapInstance.removeLayer(window.routePolyline),window.routePolyline=L.polyline([e,a],{color:"#FF9800",weight:3,opacity:.7}).addTo(window.mapInstance);const t=Vi(e.lat,e.lng,a.lat,a.lng),i=[(e.lat+a.lat)/2,(e.lng+a.lng)/2];L.popup().setLatLng(i).setContent(`<div style="text-align: center;"><strong>Jarak: ${Wi(t)}</strong><br>Saya â†’ Lokasi Sampah</div>`).openOn(window.mapInstance)}}function fd(){if(window.userMarker&&window.sampahMarker){const e=window.userMarker.getLatLng(),a=window.sampahMarker.getLatLng(),t=`https://www.google.com/maps/dir/${e.lat},${e.lng}/${a.lat},${a.lng}`;window.open(t,"_blank")}}function hd(){if(window.sampahMarker&&window.mapInstance){const e=window.sampahMarker.getLatLng();window.mapInstance.setView(e,16),window.sampahMarker.openPopup()}}function vd(){if(window.userMarker&&window.mapInstance){const e=window.userMarker.getLatLng();window.mapInstance.setView(e,16),window.userMarker.openPopup()}}function yd(){if(window.sampahMarker&&window.userMarker&&window.mapInstance){const e=L.latLngBounds([window.sampahMarker.getLatLng(),window.userMarker.getLatLng()]);window.mapInstance.fitBounds(e,{padding:[100,100]})}}function kd(e){const a={selesai:"#4CAF50",proses:"#2196F3",pending:"#FF9800",default:"#757575"};return a[e]||a.default}function Un(e){const a={selesai:"SELESAI",proses:"DIPROSES",pending:"MENUNGGU",default:(e==null?void 0:e.toUpperCase())||"UNKNOWN"};return a[e]||a.default}function wd(e){return{selesai:"Laporan telah ditangani dan selesai",proses:"Sedang dalam proses penanganan",pending:"Menunggu untuk diproses"}[e]||"Status laporan"}function Gn(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}function xd(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric"})}catch{return e}}function Ld(e,a){const t=`https://www.google.com/maps?q=${e},${a}`;window.open(t,"_blank")}function $d(){window.detailMapInstance&&window.detailMapInstance.zoomIn()}function Ed(){window.detailMapInstance&&window.detailMapInstance.zoomOut()}function Td(e,a,t){const i=`Lokasi laporan sampah:
${t}
Koordinat: ${e}, ${a}
Google Maps: https://www.google.com/maps?q=${e},${a}`;navigator.share?navigator.share({title:"Lokasi Laporan Sampah",text:i,url:`https://www.google.com/maps?q=${e},${a}`}):navigator.clipboard.writeText(i).then(()=>{alert("Lokasi telah disalin ke clipboard!")})}function Sd(e){if(!va)return;const a=window.open("","_blank");a.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Laporan Sampah #${e}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 30px; max-width: 800px; margin: 0 auto; }
                .header { text-align: center; margin-bottom: 30px; }
                .logo { font-size: 48px; margin-bottom: 10px; }
                .company { font-size: 24px; font-weight: bold; color: #2196F3; }
                .address { font-size: 14px; color: #666; margin-bottom: 20px; }
                .title { font-size: 32px; font-weight: bold; margin: 20px 0; }
                .details { margin: 20px 0; }
                .details table { width: 100%; border-collapse: collapse; }
                .details td { padding: 12px 0; border-bottom: 1px solid #ddd; }
                .section { margin: 25px 0; }
                .section-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #2196F3; }
                .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                .status { padding: 5px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
                .status-pending { background: #FF9800; color: white; }
                .status-proses { background: #2196F3; color: white; }
                .status-selesai { background: #4CAF50; color: white; }
                @media print {
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">ðŸ—‘ï¸</div>
                <div class="company">CLEANUP KUPANG</div>
                <div class="address">Jl. Perintis Kemerdekaan No. 10, Kota Kupang</div>
                <div class="title">LAPORAN SAMPAH</div>
            </div>
            
            <div class="details">
                <table>
                    <tr>
                        <td width="30%"><strong>ID Laporan</strong></td>
                        <td>#${va.idLaporan}</td>
                    </tr>
                    <tr>
                        <td><strong>Tanggal Lapor</strong></td>
                        <td>${Gn(va.tanggal_lapor)}</td>
                    </tr>
                    <tr>
                        <td><strong>Status</strong></td>
                        <td>
                            <span class="status status-${va.status||"pending"}">
                                ${Un(va.status)}
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">Informasi Pelapor</div>
                <table>
                    <tr>
                        <td width="30%"><strong>Nama Pelapor</strong></td>
                        <td>${va.nama}</td>
                    </tr>
                    <tr>
                        <td><strong>ID User</strong></td>
                        <td>${va.idUser||"-"}</td>
                    </tr>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">Lokasi Sampah</div>
                <table>
                    <tr>
                        <td width="30%"><strong>Alamat</strong></td>
                        <td>${va.alamat}</td>
                    </tr>
                    <tr>
                        <td><strong>Koordinat</strong></td>
                        <td>${va.latitude||"-"}, ${va.longitude||"-"}</td>
                    </tr>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">Deskripsi Sampah</div>
                <div style="padding: 15px; background: #f5f5f5; border-radius: 5px; margin: 10px 0;">
                    ${va.deskripsi}
                </div>
            </div>
            
            ${va.foto_bukti?`
                <div class="section">
                    <div class="section-title">Foto Bukti</div>
                    <div style="text-align: center; margin: 20px 0;">
                        <img src="${va.foto_bukti}" 
                             style="max-width: 100%; max-height: 400px; border-radius: 5px; border: 1px solid #ddd;">
                    </div>
                </div>
            `:""}
            
            <div class="footer">
                <div style="margin: 30px 0;">
                    <div style="margin-bottom: 40px;">______________________________</div>
                    <div>Petugas CleanUp Kupang</div>
                </div>
                <div>Dicetak pada: ${new Date().toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}</div>
                <div class="no-print" style="margin-top: 20px;">
                    <button onclick="window.print()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ðŸ–¨ï¸ Cetak Dokumen
                    </button>
                </div>
            </div>
            
            <script>
                window.onload = function() {
                    // Auto print jika diinginkan
                    // window.print();
                };
            <\/script>
        </body>
        </html>
    `),a.document.close()}function Ad(){const e=document.getElementById("laporanDetailModal");e&&e.remove(),va=null,window.detailMapInstance=null,window.mapInstance=null,window.sampahMarker=null,window.userMarker=null,window.routePolyline=null}window.showDetail=md;window.closeLaporanDetailModal=Ad;window.showLocationOnGoogleMaps=Ld;window.zoomInMap=$d;window.zoomOutMap=Ed;window.shareLaporanLocation=Td;window.printLaporan=Sd;window.centerToSampahMarker=hd;window.centerToUserMarker=vd;window.fitBothMarkers=yd;window.updateUserLocation=pd;window.drawRouteToSampah=bd;window.showDirections=fd;let aa=null,qe=!1,Ce=1;const Mi=9;let Yi=[];async function Zi(){const e=await Da(),a=document.getElementById("mainContent");if(aa=e,!e){a.innerHTML=`
            <div style="background: #ffebee; color: #c62828; padding: 20px; border-radius: 8px; text-align: center;">
                <h3>âš ï¸ Akses Ditolak</h3>
                <p>Silakan login terlebih dahulu</p>
                <button onclick="window.location.hash='#/login'" 
                        style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px;">
                    Login
                </button>
            </div>
        `;return}if(e.role!=="anggota"){a.innerHTML=`
            <div style="background: #fff3cd; color: #856404; padding: 20px; border-radius: 8px; text-align: center;">
                <h3>âš ï¸ Akses Ditolak</h3>
                <p>Halaman ini hanya untuk anggota. Role Anda: <strong>${e.role}</strong></p>
                <button onclick="window.location.hash='#/dashboard'" 
                        style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px;">
                    Kembali ke Dashboard
                </button>
            </div>
        `;return}a.innerHTML=`
        <div style="max-width: 1200px; margin: 0 auto;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0 0 10px 0; font-size: 28px;">ðŸ—‘ï¸ Laporan Sampah</h1>
                        <p style="margin: 0; opacity: 0.9;">Laporkan sampah untuk membantu kebersihan Kota Kupang</p>
                    </div>
                    <button id="btnBuatLaporan" 
                            style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 25px; border-radius: 6px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        ðŸ“ Buat Laporan Baru
                    </button>
                </div>
            </div>

            <!-- PETA LAPORAN (Full Width di Baris Pertama) -->
            <div style="margin-bottom: 20px;">
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="font-size: 24px;">ðŸ“</div>
                        <h2 style="margin: 0; color: #333;">Peta Lokasi Laporan</h2>
                    </div>
                    <p style="margin: 0 0 15px 0; color: #666;">Lihat semua lokasi laporan sampah di Kota Kupang</p>
                    <div id="mapContainer" style="height: 400px; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0;">
                        <div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666; background: #f8f9fa;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 10px;">ðŸ—ºï¸</div>
                                <p>Memuat peta...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATISTIK LAPORAN (Full Width di Baris Kedua) -->
            <div style="margin-bottom: 20px;">
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="font-size: 24px;">ðŸ“Š</div>
                        <h2 style="margin: 0; color: #333;">Statistik Laporan Anda</h2>
                    </div>
                    <p style="margin: 0 0 15px 0; color: #666;">Ringkasan laporan yang telah Anda buat</p>
                    <div id="statistics">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <!-- Card Total Laporan -->
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Total Laporan</div>
                                        <div style="font-size: 32px; font-weight: bold; color: #2e7d32;">0</div>
                                    </div>
                                    <div style="font-size: 32px; color: #4CAF50;">ðŸ“‹</div>
                                </div>
                            </div>
                            
                            <!-- Card Laporan Diproses -->
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196F3;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Diproses</div>
                                        <div style="font-size: 32px; font-weight: bold; color: #1565c0;">0</div>
                                    </div>
                                    <div style="font-size: 32px; color: #2196F3;">â³</div>
                                </div>
                            </div>
                            
                            <!-- Card Laporan Selesai -->
                            <div style="background: #fff8e1; padding: 20px; border-radius: 8px; border-left: 4px solid #FF9800;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Selesai</div>
                                        <div style="font-size: 32px; font-weight: bold; color: #ef6c00;">0</div>
                                    </div>
                                    <div style="font-size: 32px; color: #FF9800;">âœ…</div>
                                </div>
                            </div>
                            
                            <!-- Card Rating Rata-rata -->
                            <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Rating Rata-rata</div>
                                        <div style="font-size: 32px; font-weight: bold; color: #7b1fa2;">0.0</div>
                                    </div>
                                    <div style="font-size: 32px; color: #9C27B0;">â­</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DAFTAR LAPORAN (Full Width di Baris Ketiga) -->
            <div style="margin-bottom: 20px;">
                <div style="background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="padding: 20px; border-bottom: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0; color: #333;">Daftar Laporan Sampah</h2>
                                <p style="margin: 10px 0 0 0; color: #666;">Semua laporan sampah di Kota Kupang</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button id="btnRefreshLaporan" 
                                        style="background: #f5f5f5; color: #333; border: 1px solid #ddd; padding: 8px 16px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                    ðŸ”„ Refresh
                                </button>
                                <button id="btnFilterLaporan" 
                                        style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                    ðŸ” Filter
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="laporanContainer" style="padding: 20px;">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 20px;">â³</div>
                            <p>Memuat laporan...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `,await Promise.all([xs(),Ls(),$s()]),document.getElementById("btnBuatLaporan").onclick=Dd,document.getElementById("btnRefreshLaporan").onclick=async()=>{document.getElementById("btnRefreshLaporan").innerHTML="ðŸ”„ Memuat...",document.getElementById("btnRefreshLaporan").disabled=!0,await Promise.all([xs(),Ls(),$s()]),document.getElementById("btnRefreshLaporan").innerHTML="ðŸ”„ Refresh",document.getElementById("btnRefreshLaporan").disabled=!1},document.getElementById("btnFilterLaporan").onclick=Bd}function Bd(){const e=document.getElementById("laporanContainer");e.innerHTML=`
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0;">ðŸ” Filter Laporan</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Status</label>
                    <select id="filterStatus" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Semua Status</option>
                        <option value="selesai">Selesai</option>
                        <option value="diproses">Diproses</option>
                        <option value="diterima">Diterima</option>
                        <option value="dilaporkan">Dilaporkan</option>
                        <option value="ditolak">Ditolak</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Laporan Saya</label>
                    <select id="filterMyReport" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Semua Laporan</option>
                        <option value="my">Laporan Saya Saja</option>
                        <option value="others">Laporan Orang Lain</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Urutkan</label>
                    <select id="filterSort" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="newest">Terbaru</option>
                        <option value="oldest">Terlama</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="applyLaporanFilters()" 
                        style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Terapkan Filter
                </button>
                <button onclick="resetLaporanFilters()" 
                        style="background: #757575; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Reset Filter
                </button>
            </div>
        </div>
        <div id="laporanList" style="min-height: 200px;">
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">â³</div>
                <p>Memuat laporan...</p>
            </div>
        </div>
    `,ri("laporanList")}async function Md(){const e=document.getElementById("filterStatus").value,a=document.getElementById("filterMyReport").value,t=document.getElementById("filterSort").value;await ri("laporanList",{status:e,myReport:a,sort:t})}function Id(){document.getElementById("filterStatus").value="",document.getElementById("filterMyReport").value="",document.getElementById("filterSort").value="newest",ri("laporanList")}async function ri(e="laporanContainer",a={}){const t=document.getElementById(e);if(!(!t||!aa))try{console.log("Fetching laporan with filters:",a);const i=await fetch(b.laporanSampah,{headers:v()});if(!i.ok){const o=await i.json();throw new Error(o.detail||`HTTP ${i.status}`)}const s=await i.json();if(!s||!Array.isArray(s)||s.length===0){t.innerHTML=`
                <div style="text-align: center; padding: 50px 20px; color: #666;">
                    <div style="font-size: 72px; margin-bottom: 20px;">ðŸ“</div>
                    <h3 style="margin: 0 0 10px 0;">Belum Ada Laporan</h3>
                    <p style="margin: 0 0 20px 0;">Belum ada laporan sampah di sistem</p>
                    <button onclick="showCreateLaporanForm()" 
                            style="background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                        Buat Laporan Pertama
                    </button>
                </div>
            `;return}let n=[...s];if(a.status&&(n=n.filter(o=>o.status===a.status)),a.myReport==="my"?n=n.filter(o=>o.idUser===aa.id||o.id_user===aa.id||o.nama===aa.username):a.myReport==="others"&&(n=n.filter(o=>o.idUser!==aa.id&&o.id_user!==aa.id&&o.nama!==aa.username)),a.sort==="newest"?n.sort((o,l)=>new Date(l.tanggal_lapor||l.created_at)-new Date(o.tanggal_lapor||o.created_at)):a.sort==="oldest"&&n.sort((o,l)=>new Date(o.tanggal_lapor||o.created_at)-new Date(l.tanggal_lapor||l.created_at)),n.length===0){t.innerHTML=`
                <div style="text-align: center; padding: 50px 20px; color: #666;">
                    <div style="font-size: 72px; margin-bottom: 20px;">ðŸ”</div>
                    <h3 style="margin: 0 0 10px 0;">Tidak Ada Hasil</h3>
                    <p style="margin: 0 0 20px 0;">Tidak ada laporan yang sesuai dengan filter</p>
                    <button onclick="resetLaporanFilters()" 
                            style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        Reset Filter
                    </button>
                </div>
            `;return}Yi=n,Ce=1,t.innerHTML=`
        <div id="laporanGrid"
            style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;">
        </div>

        <div id="pagination"
            style="margin-top:25px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <small style="color: #666;">
                Menampilkan <strong>${n.length}</strong> dari <strong>${s.length}</strong> laporan
                ${a.status?` | Status: ${a.status}`:""}
                ${a.myReport?` | ${a.myReport==="my"?"Laporan Saya":"Laporan Orang Lain"}`:""}
            </small>
        </div>
    `,Jn(1)}catch(i){console.error("Error loading laporan:",i),t.innerHTML=`
            <div style="background: #ffebee; color: #c62828; padding: 20px; border-radius: 8px; text-align: center;">
                <h3>âŒ Gagal Memuat Laporan</h3>
                <p>${i.message}</p>
                <button onclick="loadLaporanWithContainer('${e}')" 
                        style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px;">
                    Coba Lagi
                </button>
            </div>
        `}}function Jn(e){const a=document.getElementById("laporanGrid");if(!a)return;Ce=e;const t=(e-1)*Mi,i=t+Mi,s=Yi.slice(t,i);a.innerHTML=s.map(n=>Cd(n)).join(""),Pd()}async function xs(){await ri("laporanContainer")}function Pd(){const e=document.getElementById("pagination");if(!e)return;const a=Math.ceil(Yi.length/Mi);let t="";t+=`
        <button ${Ce===1?"disabled":""}
            onclick="renderLaporanPage(${Ce-1})">â¬… Prev</button>
    `;for(let i=1;i<=a;i++)t+=`
            <button onclick="renderLaporanPage(${i})"
                style="
                    padding:6px 12px;
                    border-radius:4px;
                    border:1px solid #ddd;
                    ${i===Ce?"background:#2196F3;color:white;":""}
                ">
                ${i}
            </button>
        `;t+=`
        <button ${Ce===a?"disabled":""}
            onclick="renderLaporanPage(${Ce+1})">Next âž¡</button>
    `,e.innerHTML=t}function Cd(e){if(!e||typeof e!="object")return console.error("Invalid laporan data in renderLaporanCard:",e),renderErrorCard("Data laporan tidak valid");const a={selesai:"#4CAF50",diproses:"#2196F3",diterima:"#FF9800",ditolak:"#f44336",dilaporkan:"#9C27B0",pending:"#FF9800",default:"#757575"},t=e.status||"dilaporkan",i=a[t]||a.default;let s=!1;aa&&(s=e.idUser===aa.id||e.id_user===aa.id||e.nama===aa.username);const n=e.nama||"Tidak diketahui",o=e.deskripsi||"Laporan Sampah",l=e.alamat||"Tidak ada alamat",r=e.tanggal_lapor||e.created_at,c=e.idLaporan||e.id||"N/A",d=e.latitude&&e.longitude;return`
        <div style="background: white; border: 1px solid #eee; border-radius: 8px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;"
             onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            ${e.foto_bukti?`
                <div style="height: 180px; overflow: hidden; position: relative;">
                    <img src="${e.foto_bukti}" 
                         alt="Foto laporan" 
                         style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjY2NjIj7imYvigIwgRm90byBFcnJvcjwvdGV4dD48L3N2Zz4='">
                    ${s?`
                        <div style="position: absolute; top: 10px; left: 10px; background: #9C27B0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                            Laporan Anda
                        </div>
                    `:""}
                </div>
            `:`
                <div style="height: 180px; background: linear-gradient(135deg, #f5f5f5, #e0e0e0); display: flex; align-items: center; justify-content: center; position: relative;">
                    <div style="font-size: 48px; color: #ccc;">ðŸ—‘ï¸</div>
                    ${s?`
                        <div style="position: absolute; top: 10px; left: 10px; background: #9C27B0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                            Laporan Anda
                        </div>
                    `:""}
                </div>
            `}
            
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div>
                        <h3 style="margin: 0; font-size: 18px; color: #333;">
                            ${o.substring(0,50)}${o.length>50?"...":""}
                        </h3>
                    </div>
                    <span style="background: ${i}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                        ${t.toUpperCase()}
                    </span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #555;">
                        <span style="font-size: 14px; min-width: 20px;">ðŸ‘¤</span>
                        <div>
                            <div style="font-size: 14px; font-weight: 500;">${n}</div>
                            <small style="font-size: 12px; color: #888;">Pelapor</small>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #555;">
                        <span style="font-size: 14px; min-width: 20px;">ðŸ“</span>
                        <div>
                            <div style="font-size: 14px; font-weight: 500;">
                                ${l.substring(0,60)}${l.length>60?"...":""}
                            </div>
                            <small style="font-size: 12px; color: #888;">Lokasi</small>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: #555;">
                        <span style="font-size: 14px; min-width: 20px;">ðŸ“…</span>
                        <div>
                            <div style="font-size: 14px; font-weight: 500;">${Jd(r)}</div>
                            <small style="font-size: 12px; color: #888;">Tanggal Lapor</small>
                        </div>
                    </div>
                </div>
                
                ${d?`
                    <button onclick="showDetail(${c})" 
                            style="width: 100%; background: #2196F3; color: white; border: none; padding: 10px; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;"
                            onmouseover="this.style.background='#1976D2'"
                            onmouseout="this.style.background='#2196F3'">
                        <span style="font-size: 16px;">ðŸ”</span> Detail Laporan
                    </button>
                `:`
                    <div style="width: 100%; background: #f5f5f5; border: 1px dashed #ddd; color: #999; padding: 10px; border-radius: 6px; font-size: 14px; text-align: center;">
                        ðŸ“ Tidak ada lokasi
                    </div>
                `}
            </div>
        </div>
    `}window.showLaporanOnMap=function(e,a,t=""){const i=`
        <div style="margin-bottom: 15px;">
            ${t?`
                <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <p style="margin: 0; font-size: 14px; color: #333;">${t}</p>
                </div>
            `:""}
            <div id="detailMap" style="height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 6px;"></div>
        </div>
    `;Swal.fire({title:"ðŸ“ Lokasi Laporan",html:i,width:"500px",showConfirmButton:!1,showCloseButton:!0,didOpen:()=>{ba(()=>{const s=Se("detailMap",e,a,15);nt(s,e,a,t||"Lokasi Laporan"),setTimeout(()=>{s.invalidateSize()},200)})}})};async function Ls(){const e=document.getElementById("statistics");if(!(!e||!aa))try{const a=await fetch(b.laporanSampah,{headers:v()});if(a.ok){const i=await a.json(),s={total:i.length,selesai:i.filter(n=>n.status==="selesai").length,diproses:i.filter(n=>n.status==="diproses").length,diterima:i.filter(n=>n.status==="diterima").length,ditolak:i.filter(n=>n.status==="ditolak").length,dilaporkan:i.filter(n=>n.status==="dilaporkan"||!n.status).length};e.innerHTML=`
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${s.total}</div>
                        <small>Total</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${s.selesai}</div>
                        <small>Selesai</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${s.diproses}</div>
                        <small>Diproses</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #FFC107;">${s.diterima}</div>
                        <small>Diterima</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f44336;">${s.ditolak}</div>
                        <small>Ditolak</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">${s.dilaporkan}</div>
                        <small>Dilaporkan</small>
                    </div>
                </div>
            `}}catch(a){console.error("Error loading statistics:",a),e.innerHTML='<p style="color: #f44336;">Gagal memuat statistik</p>'}}async function $s(){const e=document.getElementById("mapContainer");if(!(!e||!aa))try{const a=await fetch(b.laporanSampah,{headers:v()});if(a.ok){const i=await a.json();if(i.length===0){e.innerHTML=`
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; margin-bottom: 10px;">ðŸ“</div>
                            <p>Belum ada laporan dengan lokasi</p>
                        </div>
                    </div>
                `;return}e.innerHTML='<div id="miniMap" style="height: 100%;"></div>',ba(()=>{const s=Se("miniMap");let n=!1;i.forEach(o=>{if(o.latitude&&o.longitude){n=!0;let l="#ffc107";o.status==="selesai"?l="#28a745":o.status==="diproses"||o.status==="proses"?l="#17a2b8":o.status==="ditolak"?l="#f44336":o.status==="diterima"?l="#ffc107":o.status==="dilaporkan"&&(l="#9C27B0");const r=aa&&(o.idUser===aa.id||o.id_user===aa.id||o.nama===aa.username),c=`
                            <b>${o.nama||"Laporan"}</b><br>
                            <small>${o.alamat||""}</small><br>
                            <small>Status: <strong>${o.status||"dilaporkan"}</strong></small><br>
                            ${r?"<small><em>ðŸ”¹ Laporan Anda</em></small>":""}
                        `;nt(s,o.latitude,o.longitude,c,l)}}),n&&setTimeout(()=>{if(document.querySelectorAll(".leaflet-marker-icon").length>0){const l=L.latLngBounds([]);i.forEach(r=>{r.latitude&&r.longitude&&l.extend([parseFloat(r.latitude),parseFloat(r.longitude)])}),s.fitBounds(l,{padding:[20,20]})}},500)})}}catch(a){console.error("Error loading map:",a),e.innerHTML=`<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #f44336;">
            Gagal memuat peta
        </div>`}}function Dd(){showModal('<strong style="color: #2196F3;">ðŸ“ Buat Laporan Baru</strong>',`
        <form id="modalLaporanForm" class="needs-validation" novalidate style="text-align: left;">
            <!-- INFO JENIS SAMPAH -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 20px; margin-right: 10px;">ðŸ—‘ï¸</span>
                    <h4 style="margin: 0; font-size: 16px; font-weight: bold;">Informasi Jenis Sampah</h4>
                </div>
                <div style="font-size: 13px; opacity: 0.95;">
                    <p style="margin: 0 0 10px 0;">Sebutkan jenis sampah dalam deskripsi untuk analisis yang lebih baik:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #ff6b6b;">â—</span> B3 (Baterai, Elektronik, Bahan Kimia)
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #4ecdc4;">â—</span> Plastik (Botol, Kresek, Sedotan)
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #45b7d1;">â—</span> Organik (Sisa Makanan, Daun, Sayur)
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #96ceb4;">â—</span> Logam (Kaleng, Besi, Aluminium)
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #ffeaa7;">â—</span> Kaca (Botol, Beling, Pecahan)
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #fab1a0;">â—</span> Kertas (Koran, Kardus, Buku)
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #a29bfe;">â—</span> Karet (Ban, Sandal, Karet Gelang)
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                            <span style="color: #fd79a8;">â—</span> Tekstil (Kain, Baju, Sepatu)
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Alamat Lokasi -->
            <div class="mb-3">
                <label for="modalAlamat" class="form-label fw-bold">
                    <span style="color: #e74c3c;">ðŸ“</span> Kelurahan Lokasi Sampah
                </label>
                <input type="text" class="form-control" id="modalAlamat" 
                       placeholder="Contoh: Kelurahan Oebobo" required>
                <div class="invalid-feedback">
                    Mohon isi alamat lokasi sampah.
                </div>
            </div>
            
            <!-- Deskripsi Sampah -->
            <div class="mb-3">
                <label for="modalDeskripsi" class="form-label fw-bold">
                    <span style="color: #2ecc71;">ðŸ“</span> Deskripsi Sampah
                </label>
                <textarea class="form-control" id="modalDeskripsi" rows="4"
                          placeholder="Contoh: 'Tumpukan sampah plastik (botol mineral, kresek) di pinggir jalan, volume sekitar 2mÂ³, menutupi saluran air'
                        
Contoh lainnya:
â€¢ 'Limbah B3: baterai bekas dan elektronik rusak dibuang sembarangan'
â€¢ 'Sampah organik: sisa sayuran dan daun membusuk di taman'
â€¢ 'Sampah campuran: plastik, kertas, dan kaleng berserakan'
                        
Mohon sebutkan:
1. Jenis sampah (plastik/organik/logam/B3/dll)
2. Perkiraan volume/banyaknya
3. Kondisi sekitar (berbau, mengganggu, dll)" required></textarea>
                <div class="invalid-feedback">
                    Mohon isi deskripsi sampah.
                </div>
                <div class="form-text text-muted">
                    <span style="color: #3498db;">ðŸ’¡</span> Deskripsi yang jelas membantu analisis dampak lingkungan
                </div>
            </div>
            
            <!-- Peta Lokasi -->
            <div class="mb-3">
                <label class="form-label fw-bold">
                    <span style="color: #9b59b6;">ðŸ—ºï¸</span> Peta Lokasi
                </label>
                <p class="text-muted mb-2 small">Tentukan lokasi sampah di peta atau gunakan GPS</p>
                
                <!-- Tombol GPS di atas peta -->
                <div class="d-flex gap-2 mb-2 flex-wrap">
                    <button type="button" id="modalPilihLokasiPeta" 
                            class="btn btn-primary flex-fill d-flex align-items-center justify-content-center gap-2">
                        <span style="font-size: 16px;">ðŸ—ºï¸</span> Pilih di Peta
                    </button>
                    
                    <button type="button" id="modalGetLocation" 
                            class="btn btn-success flex-fill d-flex align-items-center justify-content-center gap-2">
                        <span style="font-size: 16px;">ðŸ“</span> GPS Saya
                    </button>
                    
                    <button type="button" id="modalResetMap" 
                            class="btn btn-danger flex-fill d-flex align-items-center justify-content-center gap-2">
                        <span style="font-size: 16px;">ðŸ”„</span> Reset Peta
                    </button>
                </div>
                
                <!-- Peta utama -->
                <div id="modalMapSelect" style="height: 250px; width: 100%; border-radius: 6px; border: 2px solid #dee2e6;"></div>
                
                <!-- Koordinat Input -->
                <div class="row g-2 mt-2">
                    <div class="col-md-6">
                        <label for="modalLatitude" class="form-label small">
                            <span style="color: #f39c12;">ðŸŒ</span> Latitude
                        </label>
                        <input type="number" step="0.00000001" class="form-control" id="modalLatitude" 
                               placeholder="-10.1935921" required readonly>
                        <div class="invalid-feedback">
                            Mohon pilih lokasi di peta.
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="modalLongitude" class="form-label small">
                            <span style="color: #f39c12;">ðŸŒ</span> Longitude
                        </label>
                        <input type="number" step="0.00000001" class="form-control" id="modalLongitude" 
                               placeholder="123.6149376" required readonly>
                        <div class="invalid-feedback">
                            Mohon pilih lokasi di peta.
                        </div>
                    </div>
                </div>
                
                <!-- Status GPS -->
                <div id="modalGpsStatus" class="mt-2"></div>
            </div>
            
            <!-- Foto Bukti -->
            <div class="mb-3">
                <label for="modalFoto" class="form-label fw-bold">
                    <span style="color: #e67e22;">ðŸ“·</span> Foto Bukti
                </label>
                <p class="text-muted small">Maksimal 5MB. Format: JPG, PNG, JPEG</p>
                <input type="file" class="form-control" id="modalFoto" accept="image/*" required>
                <div class="invalid-feedback">
                    Mohon unggah foto bukti.
                </div>
                
                <!-- Preview Foto -->
                <div id="modalPreviewContainer" class="mt-2" style="display: none;">
                    <div class="card border-secondary">
                        <div class="card-body p-2">
                            <p class="small mb-1"><strong>Pratinjau Foto:</strong></p>
                            <img id="modalImagePreview" class="img-fluid rounded" style="max-height: 150px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Informasi tambahan -->
            <div class="alert alert-warning" role="alert">
                <div class="d-flex">
                    <i class="bi bi-lightbulb me-2 fs-5"></i>
                    <div>
                        <strong>Tips Pengisian:</strong> Sebutkan jenis sampah dengan jelas dalam deskripsi untuk membantu tim analisis menentukan tingkat bahaya dan prioritas penanganan.
                    </div>
                </div>
            </div>
        </form>
    `,async()=>{var s;const a=document.getElementById("modalLaporanForm");if(!a.checkValidity()){a.querySelectorAll("input, textarea, select").forEach(l=>{ue(l)});const o=a.querySelector(".is-invalid");return o&&o.scrollIntoView({behavior:"smooth",block:"center"}),!1}const t=document.getElementById("modalFoto");if(!t||!t.files||t.files.length===0)return t.classList.add("is-invalid"),t.setCustomValidity("Mohon unggah foto bukti"),t.scrollIntoView({behavior:"smooth",block:"center"}),!1;const i={alamat:document.getElementById("modalAlamat").value.trim(),deskripsi:document.getElementById("modalDeskripsi").value.trim(),latitude:parseFloat(document.getElementById("modalLatitude").value),longitude:parseFloat(document.getElementById("modalLongitude").value),foto:(s=document.getElementById("modalFoto"))==null?void 0:s.files[0]};return await Ud(i),!0},()=>{console.log("Modal ditutup")}),setTimeout(()=>{const a=-10.1935921,t=123.6149376;document.getElementById("modalLatitude").value=a,document.getElementById("modalLongitude").value=t,jd(),Nd(),_d()},100)}function jd(){const e=document.getElementById("modalLaporanForm");if(!e)return;e.querySelectorAll("input[required], textarea[required]").forEach(t=>{t.addEventListener("input",function(){ue(this)}),t.addEventListener("blur",function(){ue(this)})})}function ue(e){e&&(e.classList.remove("is-valid","is-invalid"),e.checkValidity()?e.classList.add("is-valid"):e.classList.add("is-invalid"))}async function Nd(){try{const t=await ai("modalMapSelect","modalLatitude","modalLongitude",-10.1935921,123.6149376);window.__formLaporanMap=t,window.__modalGpsMarker=null,t.on("click",function(i){const{lat:s,lng:n}=i.latlng,o=document.getElementById("modalLatitude"),l=document.getElementById("modalLongitude");o&&l&&(o.value=s.toFixed(7),l.value=n.toFixed(7),ue(o),ue(l)),window.__modalGpsMarker&&t.hasLayer(window.__modalGpsMarker)&&(t.removeLayer(window.__modalGpsMarker),window.__modalGpsMarker=null),window.__formLaporanMarker&&t.hasLayer(window.__formLaporanMarker)&&(window.__formLaporanMarker.setOpacity(1),window.__formLaporanMarker.setLatLng([s,n]),window.__formLaporanMarker.bindPopup(`
                    <div style="max-width: 200px;">
                        <strong>ðŸ“ Lokasi Dipilih</strong><br>
                        <small>
                            Latitude: ${s.toFixed(6)}<br>
                            Longitude: ${n.toFixed(6)}<br>
                            <em>Lokasi dipilih manual di peta</em>
                        </small>
                    </div>
                `).openPopup()),window.locationFromGPS=!1,Ze("manual","ðŸ“ Lokasi dipilih manual"),x("Lokasi dipilih ${lat.toFixed(6)}, ${lng.toFixed(6)}",{type:"info"})}),setTimeout(()=>{t.invalidateSize()},300)}catch(e){console.error("Error inisialisasi peta:",e),x("Gagal memuat peta lokasi",{type:"error"})}}function _d(){const e=document.getElementById("modalGetLocation");e&&e.addEventListener("click",Fd);const a=document.getElementById("modalResetMap");a&&a.addEventListener("click",Hd);const t=document.getElementById("modalPilihLokasiPeta");t&&t.addEventListener("click",function(){x("Klik pada peta untuk memilih lokasi",{type:"info"}),window.__formLaporanMap&&window.__formLaporanMap.invalidateSize()});const i=document.getElementById("modalFoto");i&&i.addEventListener("change",function(s){const n=s.target.files[0],o=document.getElementById("modalPreviewContainer"),l=document.getElementById("modalImagePreview");if(this.classList.remove("is-invalid","is-valid"),n){if(n.size>5*1024*1024){this.classList.add("is-invalid"),this.setCustomValidity("Ukuran file maksimal 5MB"),s.target.value="",o.style.display="none";return}if(!["image/jpeg","image/png","image/jpg"].includes(n.type)){this.classList.add("is-invalid"),this.setCustomValidity("Format file harus JPG, JPEG, atau PNG"),s.target.value="",o.style.display="none";return}this.classList.add("is-valid"),this.setCustomValidity("");const c=new FileReader;c.onload=function(d){l.src=d.target.result,o.style.display="block"},c.readAsDataURL(n)}else this.classList.add("is-invalid"),this.setCustomValidity("Mohon unggah foto bukti"),o.style.display="none"})}function Fd(){if(qe)return;console.log("ðŸ“ GPS button clicked - using REAL GPS"),qe=!0;const e=document.getElementById("modalGetLocation");if(!e){console.error("GPS button not found!"),qe=!1;return}if(!navigator.geolocation){x("Browser tidak mendukung GPS",{type:"error"}),qe=!1;return}e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mengambil...',Ze("loading","Mendapatkan lokasi GPS..."),navigator.geolocation.getCurrentPosition(async a=>{try{const t=a.coords.latitude,i=a.coords.longitude,s=Math.round(a.coords.accuracy);console.log("GPS success:",{latitude:t,longitude:i,accuracy:s});const n=document.getElementById("modalLatitude"),o=document.getElementById("modalLongitude");if(n&&o&&(n.value=t.toFixed(7),o.value=i.toFixed(7),ue(n),ue(o)),window.__formLaporanMap){const l=window.__formLaporanMap;window.__modalGpsMarker&&l.hasLayer(window.__modalGpsMarker)&&l.removeLayer(window.__modalGpsMarker),window.__modalGpsMarker=L.marker([t,i],{icon:L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),title:"Lokasi Saya (GPS)",draggable:!1,zIndexOffset:1e3}).addTo(l),window.__modalGpsMarker.bindPopup(`
                        <div style="max-width: 240px;">
                            <strong style="color:#2e7d32;">ðŸ“ LOKASI SAYA</strong><br>
                            <small>
                                <b>Latitude:</b> ${t.toFixed(6)}<br>
                                <b>Longitude:</b> ${i.toFixed(6)}<br>
                                <b>Akurasi:</b> Â±${s} meter
                            </small>
                        </div>
                    `).openPopup(),window.__formLaporanMarker&&l.hasLayer(window.__formLaporanMarker)&&window.__formLaporanMarker.setOpacity(.3),l.setView([t,i],17),setTimeout(()=>l.invalidateSize(),100)}window.locationFromGPS=!0,Ze("success",`âœ… Lokasi ditemukan! Akurasi: Â±${s}m`),zt(`
                    <div style="background:#e8f5e9;padding:10px;border-radius:6px;border-left:4px solid #4CAF50;">
                        <strong style="color:#2e7d32;">âœ… Lokasi berhasil diambil</strong><br>
                        <small>
                            Latitude: <b>${t.toFixed(6)}</b><br>
                            Longitude: <b>${i.toFixed(6)}</b><br>
                            Akurasi: Â±${s} meter
                        </small>
                    </div>
                `,"success")}catch(t){console.error("Error in GPS success handler:",t),Ze("error","âŒ Error memproses lokasi")}finally{e.disabled=!1,e.innerHTML='<span style="font-size:16px;">ðŸ“</span> GPS Saya',qe=!1}},a=>{console.error("GPS error:",a);let t="Gagal mengambil lokasi GPS";switch(a.code){case a.PERMISSION_DENIED:t="âŒ Izin lokasi ditolak";break;case a.POSITION_UNAVAILABLE:t="âŒ Lokasi tidak tersedia";break;case a.TIMEOUT:t="âŒ Permintaan lokasi timeout";break}Ze("error",t),x(t,{type:"error"}),e.disabled=!1,e.innerHTML='<span style="font-size:16px;">ðŸ“</span> GPS Saya',qe=!1},{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})}function Hd(){if(window.__formLaporanMap){const e=window.__formLaporanMap,a=-10.1935921,t=123.6149376;e.setView([a,t],13),window.__modalGpsMarker&&e.hasLayer(window.__modalGpsMarker)&&(e.removeLayer(window.__modalGpsMarker),window.__modalGpsMarker=null),window.__formLaporanMarker&&e.hasLayer(window.__formLaporanMarker)&&(window.__formLaporanMarker.setOpacity(1),window.__formLaporanMarker.setLatLng([a,t]),window.__formLaporanMarker.bindPopup(`
                <div style="max-width: 200px;">
                    <strong>ðŸ“ Lokasi Default</strong><br>
                    <small>
                        Latitude: ${a}<br>
                        Longitude: ${t}<br>
                        <em>Klik peta atau gunakan GPS untuk memilih lokasi lain</em>
                    </small>
                </div>
            `).openPopup());const i=document.getElementById("modalLatitude"),s=document.getElementById("modalLongitude");i&&s&&(i.value=a,s.value=t,ue(i),ue(s)),window.locationFromGPS=!1,Ze("manual","ðŸ“ Lokasi default"),zt("ðŸ“ Peta direset ke lokasi default Kupang","info"),setTimeout(()=>{e.invalidateSize()},200)}}function Ze(e,a=""){const t=document.getElementById("modalGpsStatus");if(!t)return;let i="";switch(e){case"loading":i=`
                <div class="alert alert-primary d-flex align-items-center py-2" role="alert">
                    <i class="bi bi-hourglass-split me-2"></i>
                    <div>${a}</div>
                </div>
            `;break;case"success":i=`
                <div class="alert alert-success d-flex align-items-center py-2" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    <div>${a}</div>
                </div>
            `;break;case"error":i=`
                <div class="alert alert-danger d-flex align-items-center py-2" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <div>${a}</div>
                </div>
            `;break;case"manual":i=`
                <div class="alert alert-info d-flex align-items-center py-2" role="alert">
                    <i class="bi bi-geo-alt me-2"></i>
                    <div>${a}</div>
                </div>
            `;break}t.innerHTML=i}function zt(e,a="info"){let t=document.getElementById("modalMessageContainer");if(!t){t=document.createElement("div"),t.id="modalMessageContainer";const n=document.getElementById("modalLaporanForm");n&&n.parentNode.insertBefore(t,n)}t.innerHTML="";const i=a==="error"?"alert-danger":a==="success"?"alert-success":a==="warning"?"alert-warning":"alert-info",s=document.createElement("div");s.className=`alert ${i} alert-dismissible fade show mt-2`,s.innerHTML=`
        ${e}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `,t.appendChild(s),a==="info"&&setTimeout(()=>{s.parentNode&&s.remove()},5e3)}async function Ud(e){if(x("Mengirim laporan...","info"),!aa){const a=await Da();if(!a)return zt("Session expired, silakan login kembali","error"),!1;aa=a}try{const a={nama:aa.username,alamat:e.alamat,deskripsi:e.deskripsi,latitude:e.latitude,longitude:e.longitude,tanggal_lapor:new Date().toISOString().split("T")[0],idUser:parseInt(aa.id),status:"pending"},t=await fetch(b.laporanSampah,{method:"POST",headers:v(),body:JSON.stringify(a)});let i;try{i=await t.json()}catch{throw new Error(`Invalid response from server: ${t.status}`)}if(!t.ok){let n="";if(i&&typeof i=="object")for(const[o,l]of Object.entries(i))Array.isArray(l)?n+=`${o}: ${l.join(", ")}
`:n+=`${o}: ${l}
`;throw new Error(`HTTP ${t.status}
${n}`)}let s=!1;return e.foto&&(zt("Mengupload foto...","info"),s=await Gd(i.idLaporan||i.id,e.foto)),x("Laporan berhasil dikirim","success"),alert("Laporan berhasil dikirim"),setTimeout(()=>{Zi()},2e3),!0}catch(a){return console.error("Error submitting laporan:",a),x("Gagal mengirim laporan","error"),!1}}async function Gd(e,a){const t=new FormData;t.append("foto_bukti",a);try{const i=await fetch(`${b.laporanSampah}${e}/`,{method:"PATCH",headers:So(),body:t});if(i.ok)return console.log("âœ… Foto berhasil diupload"),!0;{const s=await i.json();return console.warn("Gagal upload foto:",s),!1}}catch(i){return console.warn("Error uploading foto:",i),!1}}function Jd(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}window.showLaporanOnMap=function(e,a,t=""){const i=`
        <div style="margin-bottom: 15px;">
            ${t?`
                <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <p style="margin: 0; font-size: 14px; color: #333;">${t}</p>
                </div>
            `:""}
            <div id="detailMap" style="height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 6px;"></div>
        </div>
    `;showModal("ðŸ“ Lokasi Laporan",i,null,()=>{}),setTimeout(()=>{ba(()=>{const s=Se("detailMap",e,a,15);nt(s,e,a,t||"Lokasi Laporan"),setTimeout(()=>{s.invalidateSize()},200)})},100)};window.applyLaporanFilters=Md;window.resetLaporanFilters=Id;window.renderLaporanPage=Jn;let di=null;function Rd(e){const a=e.toLowerCase();return{lunas:"#4CAF50",success:"#4CAF50",pending:"#FF9800",failed:"#F44336",gagal:"#F44336",ditolak:"#F44336"}[a]||"#757575"}function Rn(e){const a=e?e.toLowerCase():"";return{lunas:"LUNAS",success:"BERHASIL",pending:"MENUNGGU",failed:"GAGAL",gagal:"GAGAL",ditolak:"DITOLAK"}[a]||(e?e.toUpperCase():"UNKNOWN")}function zd(e){const a=e.toLowerCase();return{bank_transfer:"ðŸ¦",transfer:"ðŸ¦",cash:"ðŸ’µ",tunai:"ðŸ’µ",qris:"ðŸ“±",debit:"ðŸ’³",credit:"ðŸ’³"}[a]||"ðŸ’³"}function zn(e){const a=e?e.toLowerCase():"";return{bank_transfer:"Transfer Bank",transfer:"Transfer Bank",cash:"Tunai",tunai:"Tunai",qris:"QRIS",debit:"Kartu Debit",credit:"Kartu Kredit"}[a]||e||"Transfer"}function fi(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}function On(e){if(console.log("ðŸ” Extracting payment ID from:",e),e&&typeof e=="object"){if(e.idPembayaran)return e.idPembayaran;if(e.id)return e.id;if(e.payment_id)return e.payment_id;const a=String(e);return a&&a!=="[object Object]"?a:(console.error("âŒ Cannot extract ID from object:",e),null)}return e}async function Ii(e){try{console.log("Loading payment detail:",e);const a=On(e);if(!a)throw new Error("ID pembayaran tidak valid");console.log("Valid payment ID:",a);const t=await fetch(`${b.pembayaran}${a}/`,{headers:v()});if(!t.ok){const s=await t.json();throw new Error(s.detail||`Gagal mengambil data pembayaran: ${t.status}`)}const i=await t.json();di=i,qn(i,!1)}catch(a){console.error("Error loading payment detail:",a),Kn(`âŒ Gagal memuat detail pembayaran: ${a.message}`)}}async function Od(e){try{console.log("Loading payment detail for anggota:",e);const a=On(e);if(!a)throw new Error("ID pembayaran tidak valid");console.log("Valid payment ID for anggota:",a);let t=null;try{const i=await fetch(`${b.pembayaran}${a}/`,{headers:v()});i.ok&&(t=await i.json())}catch{console.log("Direct endpoint failed, trying search...")}if(!t)try{const i=`${b.pembayaran}?id_pembayaran=${a}`,s=await fetch(i,{headers:v()});if(s.ok){const n=await s.json();Array.isArray(n)&&n.length>0?t=n[0]:n.results&&Array.isArray(n.results)&&n.results.length>0&&(t=n.results[0])}}catch{console.log("Search endpoint also failed")}if(!t)throw new Error(`Pembayaran dengan ID ${a} tidak ditemukan`);di=t,qn(t,!1)}catch(a){console.error("Error loading payment detail:",a),Kn(`âŒ Gagal memuat detail pembayaran: ${a.message}`)}}function Kn(e){const a=document.createElement("div");a.style.cssText=`
        position: fixed;
        top: 20px;
        right: 20px;
        background: #f44336;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 9999;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-width: 400px;
    `,a.innerHTML=`
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="flex: 1;">
                <strong>âŒ Error</strong><br>
                <span style="font-size: 14px;">${e}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: 10px;">
                Ã—
            </button>
        </div>
    `,document.body.appendChild(a),setTimeout(()=>{a.parentNode&&a.remove()},5e3)}function qn(e,a=!1){var h,f;const t=document.getElementById("paymentDetailModal");t&&t.remove();const i=e.idPembayaran||e.id||"N/A",s=e.statusBayar||e.status||"unknown",n=Rd(s),o=Rn(s),l=e.metodeBayar||e.metode||"unknown",r=zd(l),c=zn(l),d=e.jumlahBayar||e.nominal||0,m=e.tanggalBayar||e.created_at,u=e.buktiBayar||e.bukti_bayar,g=((h=e.idAnggota)==null?void 0:h.nama)||e.namaAnggota||"N/A",p=document.createElement("div");p.id="paymentDetailModal",p.innerHTML=`
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;">
            <div style="background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">ðŸ“‹ Detail Pembayaran</h2>
                    <button onclick="closePaymentDetailModal()" 
                            style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">
                        Ã—
                    </button>
                </div>
                
                <!-- Payment Info -->
                <div style="margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">ID Pembayaran</div>
                            <div style="font-weight: bold; font-size: 18px; color: #333;">
                                #${i}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Status</div>
                            <div style="padding: 6px 12px; background: ${n}; color: white; border-radius: 20px; display: inline-block; font-weight: bold;">
                                ${o}
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Tanggal Bayar</div>
                                <div style="font-weight: bold;">
                                    ${fi(m)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Jumlah Bayar</div>
                                <div style="font-weight: bold; font-size: 20px; color: #4CAF50;">
                                    Rp ${parseInt(d).toLocaleString("id-ID")}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Metode Pembayaran</div>
                            <div style="font-weight: bold; display: flex; align-items: center; gap: 8px;">
                                ${r}
                                ${c}
                            </div>
                        </div>
                        
                        ${g!=="N/A"?`
                            <div style="margin-top: 15px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Nama Anggota</div>
                                <div style="font-weight: bold;">
                                    ${g}
                                </div>
                            </div>
                        `:""}
                        
                        ${a&&((f=e.idAnggota)!=null&&f.idAnggota)?`
                            <div style="margin-top: 15px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">ID Anggota</div>
                                <div style="font-weight: bold;">
                                    #${e.idAnggota.idAnggota}
                                </div>
                            </div>
                        `:""}
                    </div>
                </div>
                
                <!-- Bukti Pembayaran -->
                ${u?`
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">ðŸ“Ž Bukti Pembayaran</h3>
                        <div style="text-align: center;">
                            <img src="${u}" 
                                 alt="Bukti Pembayaran" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="margin-top: 10px;">
                                <a href="${u}" 
                                   target="_blank" 
                                   style="color: #2196F3; text-decoration: none;">
                                    ðŸ” Lihat Full Size
                                </a>
                            </div>
                        </div>
                    </div>
                `:`
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">ðŸ“Ž Bukti Pembayaran</h3>
                        <div style="background: #f8f9fa; padding: 40px 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“„</div>
                            <div style="color: #666; margin-bottom: 15px;">Belum ada bukti pembayaran</div>
                            ${!a&&(l==="bank_transfer"||l==="transfer")&&(s==="pending"||s==="menunggu")?`
                                <button onclick="uploadProofForPayment(${i})" 
                                        style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                    ðŸ“¤ Upload Bukti
                                </button>
                            `:""}
                        </div>
                    </div>
                `}
                
                <!-- Actions -->
                <div style="margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap;">
                    ${a&&(s==="pending"||s==="menunggu")?`
                        <button onclick="confirmPaymentAsAdmin('${i}')" 
                                style="flex: 1; background: #4CAF50; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            âœ… Konfirmasi Pembayaran
                        </button>
                        <button onclick="rejectPayment('${i}')" 
                                style="flex: 1; background: #F44336; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                            âŒ Tolak Pembayaran
                        </button>
                    `:""}
                    
                    ${!a&&(s==="lunas"||s==="success")?`
                        <button onclick="printReceipt('${i}')" 
                                style="flex: 1; background: #2196F3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                            ðŸ–¨ï¸ Cetak Kwitansi
                        </button>
                    `:""}
                    
                    <button onclick="closePaymentDetailModal()" 
                            style="flex: 1; background: #757575; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                        Tutup
                    </button>
                </div>
                
                <!-- Additional Info -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>Dibuat: ${fi(e.created_at)}</div>
                        <div>Diperbarui: ${fi(e.updated_at||e.created_at)}</div>
                    </div>
                </div>
            </div>
        </div>
    `,document.body.appendChild(p),a&&addAdminStatusControls(e)}function Kd(){const e=document.getElementById("paymentDetailModal");e&&e.remove(),di=null}function qd(e){var s;const a=di;if(!a){alert("âŒ Tidak ada data pembayaran untuk dicetak");return}const t={id:a.idPembayaran||a.id||e,tanggal:Vd(a.tanggalBayar||a.created_at),metode:zn(a.metodeBayar||a.metode),jumlah:a.jumlahBayar||a.nominal||0,nama:((s=a.idAnggota)==null?void 0:s.nama)||a.namaAnggota||"Anggota",status:Rn(a.statusBayar||a.status)},i=window.open("","_blank","width=800,height=600");i.document.write(`
        <!DOCTYPE html>
        <html lang="id">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Kwitansi Pembayaran #${t.id}</title>
            <style>
                @media print {
                    @page {
                        margin: 20mm;
                    }
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: 'Arial', sans-serif;
                    }
                }
                
                body {
                    font-family: 'Arial', sans-serif;
                    line-height: 1.6;
                    color: #333;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    background: #fff;
                }
                
                .receipt-container {
                    border: 2px solid #000;
                    padding: 30px;
                    margin: 20px 0;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #000;
                    padding-bottom: 20px;
                }
                
                .logo {
                    font-size: 48px;
                    margin-bottom: 10px;
                }
                
                .company-name {
                    font-size: 24px;
                    font-weight: bold;
                    margin-bottom: 5px;
                    text-transform: uppercase;
                }
                
                .company-address {
                    font-size: 14px;
                    color: #666;
                    margin-bottom: 10px;
                }
                
                .receipt-title {
                    font-size: 28px;
                    font-weight: bold;
                    margin: 20px 0;
                    text-align: center;
                }
                
                .details-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 30px 0;
                }
                
                .details-table td {
                    padding: 12px 8px;
                    border-bottom: 1px solid #ddd;
                    vertical-align: top;
                }
                
                .details-table tr:last-child td {
                    border-bottom: none;
                }
                
                .details-label {
                    font-weight: bold;
                    width: 40%;
                }
                
                .amount-section {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                    margin: 30px 0;
                    border: 1px dashed #ccc;
                }
                
                .amount-label {
                    font-size: 14px;
                    color: #666;
                    margin-bottom: 5px;
                }
                
                .amount-value {
                    font-size: 32px;
                    font-weight: bold;
                    color: #4CAF50;
                }
                
                .footer {
                    margin-top: 50px;
                    padding-top: 20px;
                    border-top: 1px solid #000;
                }
                
                .signature-section {
                    float: right;
                    text-align: center;
                    margin-top: 60px;
                }
                
                .signature-line {
                    width: 200px;
                    border-top: 1px solid #000;
                    margin: 40px auto 10px;
                }
                
                .signature-label {
                    font-size: 14px;
                }
                
                .watermark {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 80px;
                    color: rgba(0,0,0,0.1);
                    z-index: -1;
                    white-space: nowrap;
                }
                
                .receipt-number {
                    text-align: right;
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 20px;
                }
                
                .note {
                    font-size: 12px;
                    color: #666;
                    margin-top: 30px;
                    text-align: center;
                }
                
                .print-button {
                    display: none;
                    text-align: center;
                    margin-top: 20px;
                }
                
                @media screen {
                    .print-button {
                        display: block;
                    }
                }
                
                .btn-print {
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                    margin: 10px;
                }
                
                .btn-close {
                    background: #757575;
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                }
            </style>
        </head>
        <body>
            <div class="receipt-container">
                <!-- Watermark -->
                <div class="watermark">LUNAS</div>
                
                <!-- Receipt Number -->
                <div class="receipt-number">
                    No: ${t.id}/${new Date().getFullYear()}
                </div>
                
                <!-- Header -->
                <div class="header">
                    <div class="logo">ðŸ’°</div>
                    <div class="company-name">CLEANUP KUPANG</div>
                    <div class="company-address">
                        Jl. Perintis Kemerdekaan No. 10, Kupang<br>
                        Telp: (0380) 123456 | Email: info@cleanupkupang.id
                    </div>
                </div>
                
                <!-- Title -->
                <div class="receipt-title">KWITANSI PEMBAYARAN</div>
                
                <!-- Details -->
                <table class="details-table">
                    <tr>
                        <td class="details-label">Nomor Kwitansi</td>
                        <td>#${t.id}</td>
                    </tr>
                    <tr>
                        <td class="details-label">Tanggal Pembayaran</td>
                        <td>${t.tanggal}</td>
                    </tr>
                    <tr>
                        <td class="details-label">Nama Anggota</td>
                        <td>${t.nama}</td>
                    </tr>
                    <tr>
                        <td class="details-label">Metode Pembayaran</td>
                        <td>${t.metode}</td>
                    </tr>
                    <tr>
                        <td class="details-label">Status</td>
                        <td><strong>${t.status}</strong></td>
                    </tr>
                </table>
                
                <!-- Amount -->
                <div class="amount-section">
                    <div class="amount-label">TOTAL PEMBAYARAN</div>
                    <div class="amount-value">Rp ${parseInt(t.jumlah).toLocaleString("id-ID")}</div>
                </div>
                
                <!-- Footer -->
                <div class="footer">
                    <div class="note">
                        Kwitansi ini merupakan bukti pembayaran yang sah.<br>
                        Simpan kwitansi ini untuk keperluan administrasi.
                    </div>
                    
                    <div class="signature-section">
                        <div class="signature-line"></div>
                        <div class="signature-label">Petugas CleanUp Kupang</div>
                    </div>
                    
                    <div style="clear: both;"></div>
                </div>
            </div>
            
            <!-- Buttons (only on screen, not when printing) -->
            <div class="print-button">
                <button class="btn-print" onclick="window.print()">
                    ðŸ–¨ï¸ Cetak Kwitansi
                </button>
                <button class="btn-close" onclick="window.close()">
                    âœ• Tutup
                </button>
            </div>
            
            <script>
                // Auto print setelah halaman dimuat
                window.onload = function() {
                    // Tunggu sebentar agar semua konten dimuat
                    setTimeout(function() {
                        window.print();
                        
                        // Setelah cetak, close window setelah beberapa detik
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }, 500);
                };
                
                // Handler untuk setelah cetak selesai
                window.onafterprint = function() {
                    setTimeout(function() {
                        window.close();
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `),i.document.close()}function Vd(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}window.showPaymentDetail=Ii;window.showPaymentDetailForAnggota=Od;window.closePaymentDetailModal=Kd;window.printReceipt=qd;let Ma=null,$a=null,ge=null,Vn=localStorage.getItem("access");async function Wd(){Ma=await Da();const e=document.getElementById("mainContent");if(ge=null,!Ma){e.innerHTML=`
            <div class="container py-5">
                <div class="alert alert-danger text-center">
                    <h3 class="alert-heading">âš ï¸ Akses Ditolak</h3>
                    <p>Silakan login terlebih dahulu</p>
                    <button class="btn btn-success mt-2" onclick="window.location.hash='#/login'">Login</button>
                </div>
            </div>
        `;return}if(Ma.role!=="anggota"){e.innerHTML=`
            <div class="container py-5">
                <div class="alert alert-warning text-center">
                    <h3 class="alert-heading">âš ï¸ Akses Ditolak</h3>
                    <p>Halaman ini hanya untuk anggota. Role Anda: ${Ma.role}</p>
                    <button class="btn btn-success mt-2" onclick="window.location.hash='#/dashboard'">Kembali ke Dashboard</button>
                </div>
            </div>
        `;return}e.innerHTML=`
        <div class="container py-5">
            <div class="text-center">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Memuat data pembayaran...</p>
            </div>
        </div>
    `;try{if($a=await Yd(),!$a)return Zd();console.log("Data anggota berhasil dimuat:",$a),Wn(),await Promise.all([xt(),wt()])}catch(a){console.error("Error loading payment page:",a),e.innerHTML=`
            <div class="container py-5">
                <div class="alert alert-danger">
                    <h4 class="alert-heading">
                        <i class="bi bi-exclamation-triangle me-2"></i>Terjadi Kesalahan
                    </h4>
                    <p>Gagal memuat halaman pembayaran: ${a.message}</p>
                    <button class="btn btn-success" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Coba Lagi
                    </button>
                </div>
            </div>
        `}}async function Yd(){const e=localStorage.getItem("user");if(!e)return console.log("âš  No user data found"),null;try{const a=JSON.parse(e);if(console.log(`ðŸ” Searching anggota for user ID: ${a.id}, Role: ${a.role}`),a.role!=="anggota")return console.log(`â„¹ User role is "${a.role}", skipping anggota lookup`),null;const t=await fetch(`${b.anggota}?user=${a.id}`,{headers:{Authorization:`Bearer ${Vn}`,"Content-Type":"application/json"}});if(console.log(`ðŸ“Š Response status: ${t.status}`),!t.ok)return console.warn(`âš  API error ${t.status} when fetching anggota`),null;const i=await t.json();if(console.log("ðŸ“¦ Data anggota received:",i),i.length>0){const s=i[0];return localStorage.setItem("anggota",JSON.stringify(s)),s}else return console.log(`â„¹ Tidak ada data anggota untuk user ID ${a.id}`),null}catch(a){return console.error("âŒ Gagal load anggota data:",a),null}}function Zd(){const e=document.getElementById("mainContent");e.innerHTML=`
        <div class="container py-4">
            <div class="card border-warning shadow">
                <div class="card-header bg-warning text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-person-plus me-2"></i>Pendaftaran Anggota
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Selamat datang!</strong> Anda belum terdaftar sebagai anggota CleanUp Kupang. 
                        Silakan lengkapi formulir berikut untuk mendaftar.
                    </div>
                    
                    <form id="anggotaRegistrationForm">
                        <div class="mb-3">
                            <label for="nama" class="form-label">
                                <i class="bi bi-person me-1"></i>Nama Lengkap *
                            </label>
                            <input type="text" id="nama" class="form-control" required 
                                   value="${(Ma==null?void 0:Ma.username)||""}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="alamat" class="form-label">
                                <i class="bi bi-house me-1"></i>Alamat Lengkap *
                            </label>
                            <textarea id="alamat" class="form-control" rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="noWA" class="form-label">
                                <i class="bi bi-whatsapp me-1"></i>Nomor WhatsApp *
                            </label>
                            <input type="tel" id="noWA" class="form-control" required 
                                   placeholder="081234567890">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="latitude" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Latitude *
                                </label>
                                <input type="number" step="any" id="latitude" class="form-control" required 
                                       value="-10.1935921">
                            </div>
                            <div class="col-md-6">
                                <label for="longitude" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Longitude *
                                </label>
                                <input type="number" step="any" id="longitude" class="form-control" required 
                                       value="123.6149376">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="tanggalStart" class="form-label">
                                    <i class="bi bi-calendar-plus me-1"></i>Tanggal Mulai *
                                </label>
                                <input type="date" id="tanggalStart" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="tanggalEnd" class="form-label">
                                    <i class="bi bi-calendar-minus me-1"></i>Tanggal Berakhir *
                                </label>
                                <input type="date" id="tanggalEnd" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="jenisSampah" class="form-label">
                                    <i class="bi bi-trash me-1"></i>Jenis Sampah *
                                </label>
                                <select id="jenisSampah" class="form-select" required>
                                    <option value="Rumah Tangga">Rumah Tangga</option>
                                    <option value="Tempat Usaha">Tempat Usaha</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="bi bi-check-circle me-1"></i>Status Keanggotaan
                                </label>
                                <div class="alert alert-success py-2">
                                    <i class="bi bi-check-lg me-1"></i>
                                    Aktif (setelah pembayaran pertama)
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Perhatian:</strong> Setelah mendaftar, Anda perlu membayar biaya keanggotaan 
                            bulanan sebesar <strong>Rp 50.000</strong> untuk dapat menggunakan layanan pengangkutan sampah.
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" 
                                    onclick="window.location.hash='#/dashboard'">
                                <i class="bi bi-arrow-left me-1"></i>Kembali
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle me-1"></i>Daftar Sekarang
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;const a=new Date,t=new Date(a);t.setMonth(t.getMonth()+1),document.getElementById("tanggalStart").value=a.toISOString().split("T")[0],document.getElementById("tanggalEnd").value=t.toISOString().split("T")[0],document.getElementById("anggotaRegistrationForm").onsubmit=async i=>{i.preventDefault(),await Xd()}}async function Xd(){const a=document.getElementById("anggotaRegistrationForm").querySelector('button[type="submit"]'),t=a.innerHTML;try{a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mendaftarkan...';const i={user:Ma.id,nama:document.getElementById("nama").value,alamat:document.getElementById("alamat").value,noWA:document.getElementById("noWA").value,latitude:parseFloat(document.getElementById("latitude").value),longitude:parseFloat(document.getElementById("longitude").value),tanggalStart:document.getElementById("tanggalStart").value,tanggalEnd:document.getElementById("tanggalEnd").value,status:"aktif",jenisSampah:document.getElementById("jenisSampah").value};console.log("Data anggota yang akan dikirim:",i);const s=await M(b.anggota,{method:"POST",headers:v(),body:JSON.stringify(i)});console.log("Registration response:",s),$a=s,localStorage.setItem("anggota",JSON.stringify(s)),pa("success",`
            âœ… Pendaftaran anggota berhasil!<br>
            ID Anggota: <strong>${s.idAnggota||s.id}</strong><br><br>
            Halaman akan dimuat ulang untuk melanjutkan ke pembayaran.
        `),setTimeout(()=>{location.reload()},2e3)}catch(i){console.error("Registration error:",i),pa("danger",`âŒ Gagal mendaftarkan anggota: ${i.message}`),a.disabled=!1,a.innerHTML=t}}function Wn(){const e=document.getElementById("mainContent");e.innerHTML=`
        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="card border-success shadow-sm mb-4">
                <div class="card-body bg-success bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="text-success mb-1">
                                <i class="bi bi-cash-coin me-2"></i>Pembayaran Langganan
                            </h1>
                            <p class="text-muted mb-0">
                                ID Anggota: <strong>#${$a.idAnggota||$a.id}</strong> | 
                                ${$a.nama}
                            </p>
                        </div>
                        <div class="text-end">
                            <div class="text-success small">Biaya Bulanan</div>
                            <div class="h2 text-success fw-bold">Rp 50.000</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card border-info h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="bg-info bg-opacity-10 p-3 rounded me-3">
                                    <i class="bi bi-wallet2 text-info fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title text-muted mb-1">Total Dibayar</h5>
                                    <div class="h4 text-success fw-bold" id="totalPaid">Rp 0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card border-primary h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                                    <i class="bi bi-calendar-check text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title text-muted mb-1">Bulan Aktif</h5>
                                    <div class="h4 text-success fw-bold" id="activeMonths">0 bulan</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card border-success h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                                    <i class="bi bi-check-circle text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title text-muted mb-1">Status Pembayaran</h5>
                                    <div class="h4 text-success fw-bold" id="paymentStatus">Aktif</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Options -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>Pilih Metode Pembayaran
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Bayar Rp 50.000 untuk keanggotaan 1 bulan</p>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="payment-method card h-100 border-2 cursor-pointer" data-method="transfer">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-3 text-primary">
                                        <i class="bi bi-bank"></i>
                                    </div>
                                    <h5 class="text-dark">Transfer Bank</h5>
                                    <p class="text-muted small mb-0">BNI / BRI / Mandiri</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="payment-method card h-100 border-2 cursor-pointer" data-method="cash">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-3 text-success">
                                        <i class="bi bi-cash-stack"></i>
                                    </div>
                                    <h5 class="text-dark">Tunai</h5>
                                    <p class="text-muted small mb-0">Bayar ke petugas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="paymentDetails" class="alert alert-light border" style="display: none;">
                        <div id="paymentInstructions"></div>
                        <button id="btnConfirmPayment" class="btn btn-success mt-3">
                            <i class="bi bi-cash-coin me-1"></i>Buat Pembayaran
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Riwayat Pembayaran
                    </h3>
                    <button onclick="exportPayments()" class="btn btn-light btn-sm">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                </div>
                <div class="card-body">
                    <div id="pembayaranList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Memuat riwayat pembayaran...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div class="alert alert-info shadow-sm">
                <h5 class="alert-heading">
                    <i class="bi bi-info-circle me-2"></i>Informasi Pembayaran
                </h5>
                <ul class="mb-0">
                    <li>Biaya keanggotaan: <strong class="text-success">Rp 50.000 per bulan</strong></li>
                    <li>Pembayaran tunai: Bayar ke petugas saat pengangkutan sampah pertama</li>
                    <li>Transfer bank: Upload bukti transfer setelah melakukan pembayaran</li>
                    <li>Status anggota akan non-aktif jika pembayaran terlambat 7 hari</li>
                </ul>
            </div>
        </div>

        <!-- Payment Modals -->
        <div id="paymentModal"></div>
        <div id="uploadModal"></div>
    `,Qd()}function Qd(){document.querySelectorAll(".payment-method").forEach(e=>{e.onclick=()=>{document.querySelectorAll(".payment-method").forEach(t=>{t.classList.remove("border-success","bg-success","bg-opacity-10"),t.classList.add("border-2")}),e.classList.remove("border-2"),e.classList.add("border-success","bg-success","bg-opacity-10");const a=e.dataset.method;ac(a)}}),document.getElementById("btnConfirmPayment").onclick=async()=>{const e=document.querySelector(".payment-method.border-success");if(!e){pa("warning","Pilih metode pembayaran terlebih dahulu");return}const a=e.dataset.method;a==="cash"?await tc():await ec(a)}}function ac(e){const a=document.getElementById("paymentDetails"),t=document.getElementById("paymentInstructions"),i={transfer:`
            <div>
                <h5 class="text-primary"><i class="bi bi-bank me-2"></i>Transfer Bank</h5>
                <div class="alert alert-primary">
                    <strong>Transfer ke rekening berikut:</strong>
                    <table class="table table-sm mt-2">
                        <tr>
                            <td class="fw-bold">Bank</td>
                            <td class="text-end"><strong>BNI</strong></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Nomor Rekening</td>
                            <td class="text-end"><strong>1234-5678-9012</strong></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Atas Nama</td>
                            <td class="text-end"><strong>CLEANUP KUPANG</strong></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Jumlah Transfer</td>
                            <td class="text-end"><strong class="text-success">Rp 50.000</strong></td>
                        </tr>
                    </table>
                    <p class="mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Setelah melakukan transfer, klik tombol "Buat Pembayaran" dan upload bukti transfer
                    </p>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>Catatan:</strong> Setelah Anda melakukan pembayaran, sistem akan otomatis memperbarui status menjadi "Lunas" setelah konfirmasi.
                </div>
            </div>
        `,cash:`
            <div>
                <h5 class="text-success"><i class="bi bi-cash-stack me-2"></i>Pembayaran Tunai</h5>
                <div class="alert alert-success">
                    <strong>Pembayaran dilakukan langsung ke petugas:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Bayar saat pengangkutan sampah pertama</li>
                        <li>Petugas akan memberikan kwitansi pembayaran</li>
                        <li>Status akan dikonfirmasi oleh petugas</li>
                    </ul>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Catatan:</strong> Pastikan Anda mendapatkan kwitansi pembayaran dari petugas sebagai bukti.
                </div>
            </div>
        `};t.innerHTML=i[e]||'<p class="text-muted">Pilih metode pembayaran</p>',a.style.display="block"}async function ec(e){const a=document.getElementById("btnConfirmPayment");if(!Ma){pa("danger","Sesi telah berakhir. Silakan login ulang.");return}if(!$a||!$a.idAnggota){pa("danger","Data anggota tidak valid. Silakan refresh halaman.");return}const t=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Membuat pembayaran...';try{const i={idAnggota:$a.idAnggota||$a.id,tanggalBayar:new Date().toISOString().split("T")[0],jumlahBayar:5e4,metodeBayar:e==="transfer"?"bank_transfer":e,statusBayar:"pending"};console.log("ðŸ“¤ Payload pembayaran:",i);const s=await M(b.pembayaran,{method:"POST",body:JSON.stringify(i)});console.log("ðŸ“¥ Response pembayaran:",s),alert("pembayaran Berhasil di Buat, Silahkan bayar ketika petugas mengambil saat pengambilan pertama!");const n=s.idPembayaran||s.id;ge=n,e==="transfer"?Yn(s):e==="cash"&&(pa("success",`
                âœ… Pembayaran tunai berhasil dibuat!<br><br>
                <strong>ID Pembayaran:</strong> ${n}<br>
                <strong>Status:</strong> Menunggu pembayaran ke petugas<br><br>
                <small class="text-muted">
                    Silakan bayar ke petugas saat pengangkutan sampah pertama.<br>
                    Petugas akan mengkonfirmasi pembayaran Anda.
                </small>
            `),await Promise.all([xt(),wt()])),Zn()}catch(i){console.error("âŒ Payment error:",i),pa("danger",`âŒ Gagal membuat pembayaran: ${i.message}`),a.disabled=!1,a.innerHTML=t}}async function tc(){const e=document.getElementById("btnConfirmPayment");if(!Ma){pa("danger","Sesi telah berakhir. Silakan login ulang.");return}if(!$a||!$a.idAnggota){pa("danger","âŒ Data anggota tidak ditemukan.");return}if(!await Qn("Pembayaran Tunai",`
        <div class="alert alert-warning">
            <h6><i class="bi bi-cash-stack me-2"></i>Prosedur Pembayaran Tunai</h6>
            <ol class="mb-0">
                <li>Sistem akan membuat tagihan pembayaran tunai</li>
                <li>Bayar Rp 50.000 ke petugas saat pengangkutan sampah pertama</li>
                <li>Petugas akan konfirmasi pembayaran Anda</li>
            </ol>
        </div>
        <p class="text-muted">Lanjutkan membuat pembayaran tunai?</p>
        `,"Ya, Lanjutkan","success","Batal"))return;const t=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Membuat pembayaran tunai...';try{const i={idAnggota:$a.idAnggota||$a.id,tanggalBayar:new Date().toISOString().split("T")[0],jumlahBayar:5e4,metodeBayar:"cash",statusBayar:"pending"};console.log("Payload pembayaran tunai:",i);const s=await fetch(b.pembayaran,{method:"POST",headers:v(),body:JSON.stringify(i)}),n=await s.json();if(!s.ok)throw new Error(n.detail||"Gagal membuat pembayaran");ge=n.idPembayaran||n.id,pa("success",`âœ… Pembayaran tunai berhasil dibuat!<br><br>
            <strong>ID Pembayaran:</strong> ${ge}<br>
            <strong>Status:</strong> Menunggu pembayaran ke petugas<br><br>
            <small class="text-muted">Silakan bayar ke petugas saat pengangkutan sampah pertama.</small>`),Zn(),await Promise.all([xt(),wt()])}catch(i){pa("danger",`âŒ Gagal membuat pembayaran tunai: ${i.message}`),e.disabled=!1,e.innerHTML=t}}function Yn(e){const a=document.getElementById("uploadModal")||document.createElement("div");a.id="uploadModal",a.innerHTML="",e.metodeBayar==="bank_transfer"||e.metodeBayar;const t='<i class="bi bi-cloud-upload me-2"></i>Upload Bukti Transfer',i="bg-success text-white";let s="",n="";s=`
    <div class="mb-4">
      <h6><i class="bi bi-list-ol me-2"></i>Instruksi Transfer Bank:</h6>
      <ol class="mb-0">
        <li>Transfer <strong class="text-success">Rp 50.000</strong> ke rekening berikut:</li>
        <div class="alert alert-primary mt-2 mb-3">
          <table class="table table-sm table-borderless mb-0">
            <tr>
              <td width="40%"><strong>Bank</strong></td>
              <td class="text-end"><strong>BNI</strong></td>
            </tr>
            <tr>
              <td><strong>Nomor Rekening</strong></td>
              <td class="text-end"><strong>1234-5678-9012</strong></td>
            </tr>
            <tr>
              <td><strong>Atas Nama</strong></td>
              <td class="text-end"><strong>CLEANUP KUPANG</strong></td>
            </tr>
          </table>
        </div>
        <li>Screenshot/photo <strong>bukti transfer</strong> dari aplikasi bank/mobile banking</li>
        <li>Upload file bukti transfer di bawah ini</li>
        <li>Klik "Simpan Bukti Transfer" untuk mengkonfirmasi</li>
      </ol>
    </div>
    
    <div class="alert alert-info mb-4">
      <i class="bi bi-info-circle me-2"></i>
      <strong>Informasi Penting:</strong> Pastikan bukti transfer memuat informasi:
      <ul class="mb-0 mt-1">
        <li>Nama pengirim (Anda)</li>
        <li>Jumlah transfer (Rp 50.000)</li>
        <li>Waktu transfer</li>
        <li>Referensi/ID transaksi bank</li>
      </ul>
    </div>
  `,n=`
    <p class="mb-1"><strong>ID Pembayaran:</strong> ${e.idPembayaran||e.id}</p>
    <p class="mb-1"><strong>Jumlah:</strong> <span class="text-success fw-bold">Rp 50.000</span></p>
    <p class="mb-0"><strong>Metode:</strong> <span class="badge bg-success">Transfer Bank</span></p>
    <p class="mb-0 mt-1"><strong>Kode Bank:</strong> <code>009 (BNI)</code></p>
  `,a.innerHTML=`
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header ${i}">
            <h5 class="modal-title">
              ${t}
            </h5>
            <button type="button" class="btn-close btn-close-white" onclick="closeUploadModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <div class="alert alert-primary">
                <h6 class="alert-heading mb-2">
                  <i class="bi bi-info-circle me-2"></i>Informasi Pembayaran
                </h6>
                ${n}
              </div>
            </div>
            
            ${s}
            
            <div class="mb-4">
              <div id="uploadPreview" class="border rounded p-4 text-center bg-light">
                <i class="bi bi-paperclip display-4 text-muted mb-3"></i>
                <p class="text-muted mb-1">Belum ada file dipilih</p>
                <small class="text-muted">Maksimal 5MB (JPG, PNG, PDF)</small>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="d-grid gap-2">
                <label for="fileInput" class="btn btn-outline-success">
                  <i class="bi bi-folder2-open me-2"></i>Pilih File Bukti
                </label>
                <input type="file" id="fileInput" class="d-none" accept=".jpg,.jpeg,.png,.pdf">
                <button onclick="uploadBuktiBayar()" id="btnUpload" class="btn btn-success" disabled>
                  <i class="bi bi-cloud-upload me-2"></i>Simpan Bukti Transfer
                </button>
              </div>
            </div>
            
            <div id="uploadMessage"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="skipUpload()">
              <i class="bi bi-clock me-2"></i>Upload Nanti
            </button>
            <button type="button" class="btn btn-outline-success" onclick="closeUploadModal()">
              <i class="bi bi-x-circle me-2"></i>Tutup
            </button>
          </div>
        </div>
      </div>
    </div>
  `,document.body.appendChild(a),document.getElementById("fileInput").onchange=function(o){const l=o.target.files[0];l&&previewUploadFile(l)}}function Zn(){document.querySelectorAll(".payment-method").forEach(t=>{t.classList.remove("border-success","bg-success","bg-opacity-10"),t.classList.add("border-2")});const e=document.getElementById("paymentDetails");e&&(e.style.display="none");const a=document.getElementById("btnConfirmPayment");a&&(a.disabled=!1,a.innerHTML='<i class="bi bi-cash-coin me-1"></i>Buat Pembayaran')}async function wt(){try{if(!Ma)return;const e=await fetch(`${b.pembayaran}?user=${Ma.id}`,{headers:v()});if(e.ok){const a=await e.json(),t=Array.isArray(a)?a:[],s=t.filter(m=>(m.statusBayar||m.status)==="success"||(m.statusBayar||m.status)==="lunas").reduce((m,u)=>m+(u.jumlahBayar||u.nominal||0),0),n=Math.floor(s/5e4),o=t[t.length-1];let l="Belum Bayar",r="Belum Bayar";if(t.length>0)switch((o==null?void 0:o.statusBayar)||(o==null?void 0:o.status)){case"success":case"lunas":l="Aktif",r="Lunas";break;case"pending":l="Menunggu",r="Menunggu Konfirmasi";break;case"failed":case"gagal":l="Gagal",r="Gagal";break;default:l="Belum Bayar",r="Belum Bayar"}s>0&&(l="Aktif",r="Lunas"),document.getElementById("totalPaid").textContent=`Rp ${s.toLocaleString("id-ID")}`,document.getElementById("activeMonths").textContent=`${n} bulan`,document.getElementById("paymentStatus").textContent=r;const c=document.getElementById("paymentStatus");c.className="h4 fw-bold "+(l==="Aktif"||l==="Lunas"?"text-success":l==="Menunggu"?"text-warning":l==="Gagal"?"text-danger":"text-muted");const d=document.querySelector(".card.border-success .card-body");d&&(d.classList.remove("bg-success","bg-opacity-10"),l==="Aktif"||l==="Lunas"?d.classList.add("bg-success","bg-opacity-10"):l==="Menunggu"?d.classList.add("bg-warning","bg-opacity-10"):l==="Gagal"?d.classList.add("bg-danger","bg-opacity-10"):d.classList.add("bg-secondary","bg-opacity-10"))}}catch(e){console.error("Error loading payment summary:",e)}}async function xt(){const e=document.getElementById("pembayaranList");if(!(!e||!Ma))try{const a=await fetch(`${b.pembayaran}?user=${Ma.id}`,{headers:v()}),t=a.headers.get("content-type");if(!t||!t.includes("application/json")){const n=await a.text();console.error("Non-JSON response:",n.substring(0,200)),Es(e,"Format data tidak valid");return}if(!a.ok){const n=await a.json();throw new Error(n.detail||`HTTP ${a.status}`)}const i=await a.json(),s=Array.isArray(i)?i:[];if(s.length===0){e.innerHTML=`
                <div class="text-center py-5">
                    <i class="bi bi-wallet display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">Belum Ada Riwayat Pembayaran</h4>
                    <p class="text-muted">Lakukan pembayaran pertama Anda</p>
                </div>
            `;return}e.innerHTML=`
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Tanggal</th>
                            <th>Nominal</th>
                            <th>Metode</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${s.map(n=>ic(n)).join("")}
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <strong>Total: ${s.length} transaksi</strong>
                </div>
                <div>
                    <button class="btn btn-outline-success" onclick="exportPayments()">
                        <i class="bi bi-download me-1"></i>Export PDF
                    </button>
                </div>
            </div>
        `}catch(a){console.error("Error loading pembayaran:",a),Es(e,a.message)}}function ic(e){const a=e.statusBayar||e.status||"pending",t=e.jumlahBayar||e.nominal||0,i=e.bukti_bayar||e.buktiBayar;let s;switch(a){case"success":case"lunas":s={class:"success",text:"Lunas",icon:"check-circle"};break;case"pending":i?s={class:"info",text:"Menunggu Verifikasi",icon:"clock-history"}:s={class:"warning",text:"Menunggu Pembayaran",icon:"clock"};break;case"failed":case"gagal":s={class:"danger",text:"Gagal",icon:"x-circle"};break;default:s={class:"secondary",text:a,icon:"question-circle"}}let n="Transfer";if(e.metodeBayar)switch(e.metodeBayar){case"bank_transfer":n="Transfer Bank";break;case"cash":n="Tunai";break;default:n=e.metodeBayar}let o="";return a==="pending"?e.metodeBayar==="bank_transfer"?i?o=`
          <span class="text-info small">
            <i class="bi bi-clock-history me-1"></i>Menunggu Verifikasi
          </span>
        `:o=`
          <button onclick="showUploadModalForPayment('${e.idPembayaran||e.id}')" 
                  class="btn btn-sm btn-outline-warning">
            <i class="bi bi-upload me-1"></i>Upload Bukti
          </button>
        `:o=`
        <button onclick="showPaymentDetailForAnggota('${e.idPembayaran||e.id}')" 
                class="btn btn-sm btn-outline-success">
          <i class="bi bi-eye me-1"></i>Detail
        </button>
      `:o=`
      <button onclick="showPaymentDetailForAnggota('${e.idPembayaran||e.id}')" 
              class="btn btn-sm btn-outline-success">
        <i class="bi bi-eye me-1"></i>Detail
      </button>
    `,`
    <tr>
      <td class="fw-semibold">#${e.idPembayaran||e.id||"-"}</td>
      <td>${Xn(e.tanggalBayar||e.created_at)}</td>
      <td class="${a==="success"||a==="lunas"?"text-success":a==="pending"&&i?"text-info":"text-warning"} fw-bold">
        Rp ${t.toLocaleString("id-ID")}
      </td>
      <td>
        <span class="badge bg-light text-dark">
          ${n}
        </span>
      </td>
      <td>
        <span class="badge bg-${s.class}">
          <i class="bi bi-${s.icon} me-1"></i>${s.text}
        </span>
      </td>
      <td>
        ${o}
      </td>
    </tr>
  `}window.showUploadModalForPayment=async function(e){ge=e;try{const a=await fetch(`${b.pembayaran}${e}/`,{headers:v()});if(a.ok){const t=await a.json();Yn(t)}else pa("danger","Gagal memuat data pembayaran")}catch(a){pa("danger","Error: "+a.message)}};function Es(e,a){e.innerHTML=`
        <div class="alert alert-danger text-center">
            <h4 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-2"></i>Gagal Memuat Data
            </h4>
            <p class="mb-3">${a}</p>
            <button onclick="location.reload()" class="btn btn-success">
                <i class="bi bi-arrow-clockwise me-1"></i>Coba Lagi
            </button>
        </div>
    `}function Xn(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}function pa(e,a){const t=document.createElement("div");t.className=`alert alert-${e} alert-dismissible fade show position-fixed`,t.style.top="20px",t.style.right="20px",t.style.zIndex="1050",t.style.minWidth="300px",t.innerHTML=`
        <div>${a}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `,document.body.appendChild(t),setTimeout(()=>{t.remove()},5e3)}function Qn(e,a,t="Ya",i="primary",s="Batal"){return new Promise(n=>{const o=document.createElement("div");o.id="confirmModal",o.innerHTML=`
            <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${e}</h5>
                            <button type="button" class="btn-close" onclick="document.getElementById('confirmModal').remove(); resolve(false);"></button>
                        </div>
                        <div class="modal-body">
                            ${a}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('confirmModal').remove(); resolve(false);">
                                ${s}
                            </button>
                            <button type="button" class="btn btn-${i}" onclick="document.getElementById('confirmModal').remove(); resolve(true);">
                                ${t}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(o),window.resolve=n})}window.exportPayments=function(){pa("info","Fitur export PDF sedang dalam pengembangan")};window.uploadBuktiBayar=async function(){const e=document.getElementById("fileInput"),a=document.getElementById("btnUpload");if(document.getElementById("uploadMessage"),!e.files||e.files.length===0){showUploadMessage("Pilih file terlebih dahulu","error");return}if(!ge){showUploadMessage("ID pembayaran tidak ditemukan","error");return}const t=e.files[0],i=new FormData;i.append("buktiBayar",t);const s=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mengupload...',showUploadMessage("Mengupload file...","info");try{const n=await fetch(`${b.pembayaran}${ge}/`,{method:"PATCH",headers:{Authorization:`Bearer ${Vn}`},body:i}),o=await n.json();if(!n.ok)throw new Error(o.detail||"Gagal mengupload bukti");showUploadMessage("âœ… Bukti pembayaran berhasil diupload!","success"),Wn(),closeUploadModal(),a.innerHTML='<i class="bi bi-check-circle me-2"></i>Terupload',setTimeout(async()=>{pa("success","Bukti transfer berhasil diupload. Status akan diperiksa oleh admin."),closeUploadModal(),await wt(),await xt(),document.getElementById("paymentStatus").textContent="Menunggu Konfirmasi",document.getElementById("paymentStatus").className="h4 fw-bold text-warning"},2e3)}catch(n){console.error("Upload error:",n),showUploadMessage(`âŒ Gagal upload: ${n.message}`,"error"),a.disabled=!1,a.innerHTML=s}};window.closeUploadModal=function(){const e=document.getElementById("uploadModal");e&&e.remove()};window.skipUpload=function(){Qn("Upload Bukti Transfer","Anda yakin ingin melewati upload bukti?<br><br>Anda dapat upload bukti transfer nanti melalui menu riwayat pembayaran.","Ya, Lewati","warning").then(async e=>{await Promise.all([xt(),wt()]),e&&(closeUploadModal(),pa("info",`Pembayaran berhasil dibuat (ID: ${ge}).<br>Jangan lupa upload bukti transfer nanti.`),ge=null)})};window.previewUploadFile=function(e){const a=document.getElementById("uploadPreview"),t=document.getElementById("btnUpload");if(e.size>5*1024*1024){showUploadMessage("File terlalu besar. Maksimal 5MB","error");return}if(!["image/jpeg","image/jpg","image/png","application/pdf"].includes(e.type)){showUploadMessage("Format file tidak didukung. Gunakan JPG, PNG, atau PDF","error");return}if(e.type.startsWith("image/")){const s=new FileReader;s.onload=function(n){a.innerHTML=`
                <div class="text-center">
                    <img src="${n.target.result}" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                    <div class="mt-2">
                        <strong class="d-block">${e.name}</strong>
                        <small class="text-muted">${(e.size/1024).toFixed(1)} KB</small>
                    </div>
                </div>
            `},s.readAsDataURL(e)}else a.innerHTML=`
            <div class="text-center">
                <i class="bi bi-file-earmark-pdf display-1 text-danger mb-2"></i>
                <div class="mt-2">
                    <strong class="d-block">${e.name}</strong>
                    <small class="text-muted">${(e.size/1024).toFixed(1)} KB - PDF</small>
                </div>
            </div>
        `;t.disabled=!1,t.innerHTML='<i class="bi bi-cloud-upload me-2"></i>Upload Bukti',showUploadMessage("File siap diupload","success")};window.showUploadMessage=function(e,a="info"){const t=document.getElementById("uploadMessage");t&&(t.innerHTML=`
        <div class="alert alert-${a} mb-0">
            <i class="bi bi-${a==="error"?"exclamation-triangle":a==="success"?"check-circle":"info-circle"} me-2"></i>
            ${e}
        </div>
    `)};window.showPaymentDetailForAnggota=async function(e){try{console.log("ðŸ” Fetching payment detail for ID:",e);let a=`${b.pembayaran}${e}/`;console.log("ðŸ”— API URL:",a);const t=await fetch(a,{headers:v()});if(console.log("ðŸ“Š Response status:",t.status),!t.ok){if(t.status===404){const s=`${b.pembayaran}?id=${e}`;console.log("ðŸ”„ Trying alternative URL:",s);const n=await fetch(s,{headers:v()});if(n.ok){const o=await n.json();if(Array.isArray(o)&&o.length>0){Ts(o[0]);return}}}throw new Error(`HTTP ${t.status}: Gagal mengambil detail pembayaran`)}const i=await t.json();console.log("âœ… Payment data received:",i),typeof Ii=="function"?Ii(i):Ts(i)}catch(a){console.error("âŒ Error loading payment detail:",a),pa("danger",`Gagal memuat detail pembayaran: ${a.message}`)}};function Ts(e){const a=document.createElement("div");a.id="detailModal",a.innerHTML=`
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-receipt me-2"></i>Detail Pembayaran
                        </h5>
                        <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('detailModal').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">Informasi Pembayaran</h6>
                        </div>
                        
                        <table class="table table-borderless">
                            <tr>
                                <td width="40%"><strong>ID Pembayaran</strong></td>
                                <td>#${e.idPembayaran||e.id||"N/A"}</td>
                            </tr>
                            <tr>
                                <td><strong>Tanggal</strong></td>
                                <td>${Xn(e.tanggalBayar||e.created_at)}</td>
                            </tr>
                            <tr>
                                <td><strong>Jumlah</strong></td>
                                <td class="fw-bold text-success">
                                    Rp ${parseInt(e.jumlahBayar||e.nominal||0).toLocaleString("id-ID")}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Metode</strong></td>
                                <td>
                                    ${e.metodeBayar==="bank_transfer"?"Transfer Bank":e.metodeBayar==="cash"?"Tunai":e.metodeBayar||"N/A"}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Status</strong></td>
                                <td>
                                    ${sc(e.statusBayar||e.status)}
                                </td>
                            </tr>
                        </table>
                        
                        ${e.bukti_bayar||e.buktiBayar?`
                        <div class="mt-4">
                            <h6><i class="bi bi-image me-2"></i>Bukti Pembayaran</h6>
                            <div class="text-center">
                                <img src="${e.bukti_bayar||e.buktiBayar}" 
                                     class="img-fluid rounded border" 
                                     style="max-height: 200px;" 
                                     alt="Bukti Bayar">
                                <div class="mt-2">
                                    <a href="${e.bukti_bayar||e.buktiBayar}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Buka Full Size
                                    </a>
                                </div>
                            </div>
                        </div>
                        `:""}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('detailModal').remove()">
                            <i class="bi bi-x-circle me-2"></i>Tutup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,document.body.appendChild(a)}function sc(e){const t={success:{text:"Lunas",class:"bg-success"},lunas:{text:"Lunas",class:"bg-success"},pending:{text:"Pending",class:"bg-warning"},failed:{text:"Gagal",class:"bg-danger"},gagal:{text:"Gagal",class:"bg-danger"}}[e==null?void 0:e.toLowerCase()]||{text:e||"Unknown",class:"bg-secondary"};return`<span class="badge ${t.class}">${t.text}</span>`}function Ee(e,a,t=null,i="Simpan",s="Batal"){const n=document.createElement("div");n.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `,n.innerHTML=`
        <div style="
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        ">
            <div style="
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h3 style="margin: 0;">${e}</h3>
                <button id="closeModal" style="
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    color: #666;
                ">Ã—</button>
            </div>
            <div style="padding: 20px;" id="modalContent">
                ${a}
            </div>
            <div style="
                padding: 15px 20px;
                border-top: 1px solid #eee;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            ">
                <button id="cancelBtn" style="
                    padding: 8px 16px;
                    background: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                ">${s}</button>
                ${t?`
                <button id="confirmBtn" style="
                    padding: 8px 16px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                ">${i}</button>
                `:""}
            </div>
        </div>
    `,document.body.appendChild(n);const o=()=>{document.removeEventListener("keydown",r),document.body.removeChild(n)},l=()=>o();document.getElementById("closeModal").onclick=l,document.getElementById("cancelBtn").onclick=l;const r=c=>{c.key==="Escape"&&o()};if(document.addEventListener("keydown",r),t){let c=!1;document.getElementById("confirmBtn").onclick=async()=>{if(c)return;c=!0;const d=document.getElementById("confirmBtn"),m=d.innerHTML;d.disabled=!0,d.innerHTML="<span>Menyimpan...</span>";try{await t()===!0?o():(d.disabled=!1,d.innerHTML=m,c=!1)}catch(u){console.error("Error in modal confirm:",u),d.disabled=!1,d.innerHTML=m,c=!1}}}return{element:n,close:o}}function nc(e,a,t="Konfirmasi",i="Ya",s="Tidak"){return Ee(t,`
        <div style="padding: 20px 0;">
            <p style="margin: 0 0 20px 0;">${e}</p>
        </div>
    `,async()=>(await a(),!0),i,s)}async function oc(){const e=document.getElementById("mainContent");e.innerHTML=`
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Jadwal Pengangkutan Saya</h2>
                <button id="addDetailBtn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    + Tambah Jadwal Saya
                </button>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="searchDetail" placeholder="Cari berdasarkan tanggal/tim..." style="padding: 8px; width: 250px; border: 1px solid #ddd; border-radius: 4px;">
                <select id="filterStatus" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Semua Status</option>
                    <option value="terjadwal">Terjadwal</option>
                    <option value="dalam_proses">Dalam Proses</option>
                    <option value="selesai">Selesai</option>
                    <option value="dibatalkan">Dibatalkan</option>
                </select>
                <select id="filterJadwal" style="padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Semua Jadwal</option>
                </select>
            </div>
            
            <div id="detailTableContainer">
                <p>Loading data...</p>
            </div>
            
            <div style="margin-top: 30px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff;">
                <h4 style="margin-top: 0; color: #0056b3;">ðŸ“‹ Panduan Penggunaan:</h4>
                <ul style="margin-bottom: 0;">
                    <li>Anda hanya dapat melihat dan mengelola jadwal milik Anda sendiri</li>
                    <li><strong>Status "Terjadwal"</strong>: Jadwal sudah direncanakan</li>
                    <li><strong>Status "Dalam Proses"</strong>: Tim sedang dalam perjalanan</li>
                    <li><strong>Status "Selesai"</strong>: Pengangkutan telah selesai</li>
                    <li><strong>Status "Dibatalkan"</strong>: Jadwal dibatalkan</li>
                    <li>Gunakan kolom catatan untuk memberikan informasi tambahan</li>
                </ul>
            </div>
        </div>
    `,document.getElementById("addDetailBtn").onclick=()=>Pi(),document.getElementById("searchDetail").oninput=Ge,document.getElementById("filterStatus").onchange=Ge,window.showAddDetailFormAnggota=Pi,lc(),Ge()}async function lc(){try{const e=await M(b.jadwal,{headers:v()}),a=document.getElementById("filterJadwal");for(;a.options.length>1;)a.remove(1);e.forEach(t=>{const i=document.createElement("option"),s=t.idJadwal,n=t.tanggalJadwal||"N/A",o=t.nama_tim||"N/A";i.value=s,i.textContent=`${n} (${o})`,a.appendChild(i)}),document.getElementById("filterJadwal").onchange=Ge}catch(e){console.error("Error loading dropdown data:",e)}}async function Ge(){var i,s,n;const e=((i=document.getElementById("searchDetail"))==null?void 0:i.value)||"",a=((s=document.getElementById("filterStatus"))==null?void 0:s.value)||"",t=((n=document.getElementById("filterJadwal"))==null?void 0:n.value)||"";try{const l=(await M(b.detailAnggotaJadwal,{headers:v()})).filter(r=>{const c=r.tanggal_jadwal||"",d=r.nama_tim||"",m=r.status_pengangkutan||"",u=!e||c.toLowerCase().includes(e.toLowerCase())||d.toLowerCase().includes(e.toLowerCase())||m.toLowerCase().includes(e.toLowerCase()),g=!a||m===a,p=!t||r.idJadwal==t;return u&&g&&p});rc(l)}catch(o){document.getElementById("detailTableContainer").innerHTML=`<p style="color: red;">Error loading data: ${o.message}</p>`}}function rc(e){const a=document.getElementById("detailTableContainer");if(!e||e.length===0){a.innerHTML=`
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 48px; color: #6c757d; margin-bottom: 15px;">ðŸ“…</div>
                <h3 style="color: #6c757d;">Belum ada jadwal</h3>
                <p style="color: #6c757d;">Klik tombol <strong>"+ Tambah Jadwal Saya"</strong> untuk menambahkan jadwal pengangkutan</p>
                <button onclick="showAddDetailFormAnggota()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer;">
                    + Tambah Jadwal Pertama
                </button>
            </div>
        `;return}const t=`
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead>
                    <tr style="background: #f2f2f2;">
                        <th style="padding: 10px; border: 1px solid #ddd;">ID</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Tanggal Jadwal</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Tim Angkut</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Catatan</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Dibuat</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    ${e.map(i=>{const s=i.id||"N/A",n=i.tanggal_jadwal||`Jadwal ID: ${i.idJadwal}`,o=i.nama_tim||"N/A";let l=n;try{const u=new Date(n);isNaN(u)||(l=u.toLocaleDateString("id-ID",{weekday:"short",year:"numeric",month:"short",day:"numeric"}))}catch{}const r=i.catatan||"",c=r?r.substring(0,40)+(r.length>40?"...":""):"-",d=i.created_at?new Date(i.created_at).toLocaleDateString("id-ID"):"-";let m="";return i.status_pengangkutan==="terjadwal"?m=`
                                <button onclick="viewDetailJadwalAnggota(${s})" style="padding: 4px 8px; margin-right: 5px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer;">Detail</button>
                                <button onclick="editDetailJadwalAnggota(${s})" style="padding: 4px 8px; margin-right: 5px; background: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer;">Edit</button>
                                <button onclick="batalkanJadwalAnggota(${s})" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Batalkan</button>
                            `:i.status_pengangkutan==="dalam_proses"?m=`
                                <button onclick="viewDetailJadwalAnggota(${s})" style="padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer;">Detail</button>
                            `:m=`
                                <button onclick="viewDetailJadwalAnggota(${s})" style="padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer;">Detail</button>
                            `,`
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <div>
                                    <strong>${l}</strong>
                                </div>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <div>
                                    <strong>${o}</strong>
                                </div>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                ${ao(i.status_pengangkutan)}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; max-width: 200px;">
                                ${c}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; font-size: 12px; text-align: center;">
                                ${d}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                ${m}
                            </td>
                        </tr>
                        `}).join("")}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; color: #666;">
            <strong>Total:</strong> ${e.length} jadwal ditemukan
        </div>
    `;a.innerHTML=t,window.viewDetailJadwalAnggota=gc,window.editDetailJadwalAnggota=pc,window.batalkanJadwalAnggota=bc}function ao(e){const t={terjadwal:{color:"#17a2b8",label:"Terjadwal",icon:"ðŸ“…"},dalam_proses:{color:"#ffc107",label:"Dalam Proses",icon:"ðŸšš"},selesai:{color:"#28a745",label:"Selesai",icon:"âœ…"},dibatalkan:{color:"#dc3545",label:"Dibatalkan",icon:"âŒ"}}[e]||{color:"#6c757d",label:e,icon:"â“"};return`
        <span style="
            padding: 4px 10px;
            border-radius: 20px;
            background: ${t.color};
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        ">
            ${t.icon} ${t.label}
        </span>
    `}async function dc(){const e=await Da();if(!e||!e.id)return console.warn("User tidak ditemukan saat loadAnggotaId."),null;try{const a=await M(`${b.anggota}?user=${e.id}`,{headers:v()});return a.length>0?(localStorage.setItem("idAnggota",a[0].id),console.log("idAnggota loaded:",a[0].id),a[0].id):(console.warn("Tidak ditemukan data Anggota untuk user ini."),null)}catch(a){return console.error("Gagal load idAnggota:",a),null}}function Pi(){const e=localStorage.getItem("idAnggota");if(!e){dc().then(a=>{a?Pi():Ee("Error",`
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
                        <strong>Data Anggota tidak ditemukan!</strong><br>
                        Silakan login ulang atau hubungi administrator.
                    </div>
                `,()=>!0)});return}M(b.jadwal,{headers:v()}).then(a=>{const i=`
                <div id="validationMessageContainer" style="margin-bottom: 15px;"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    ${cc(a)}
                </div>

                <hr style="margin: 15px 0;">

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="font-weight: bold; color: #0d6efd;">
                            Catatan untuk Petugas Pengangkut
                        </label>
                        <span style="background: #d1ecf1; color: #0c5460; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                            Opsional
                        </span>
                    </div>
                    
                    <textarea id="catatanAnggota" 
                            style="width: 100%; padding: 10px; height: 100px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; resize: vertical;"
                            placeholder="Tambahkan instruksi atau catatan khusus untuk petugas pengangkut..."
                            maxlength="500"></textarea>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <div>
                            <small style="color: #666;">
                                Contoh: "Sampah ada di belakang rumah", "Mohon diangkut pagi hari", "Ada sampah kaca, hati-hati"
                            </small>
                        </div>
                        <small id="charCount" style="color: #666;">0/500 karakter</small>
                    </div>
                </div>

                <input type="hidden" id="selectedJadwalIdsAnggota">

                <div style="margin-top: 15px; background: #f7f7f7; padding: 10px; border-radius: 5px;">
                    <strong>Dipilih: <span id="selectedCountAnggota">0</span> jadwal</strong>
                    <div id="selectedJadwalListAnggota" style="margin-top: 10px;"></div>
                </div>
            `,s=Ee("Tambah Jadwal Pengangkutan",i,async()=>{const l=document.getElementById("selectedJadwalIdsAnggota").value,r=document.getElementById("validationMessageContainer");if(r.innerHTML="",!l)return r.innerHTML=`
                        <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb;">
                            <strong>Pilih minimal 1 jadwal!</strong><br>
                            Silakan pilih jadwal yang ingin ditambahkan
                        </div>
                    `,r.scrollIntoView({behavior:"smooth",block:"center"}),!1;const c=l.split(",").filter(k=>k!==""),d=document.getElementById("catatanAnggota").value||"",m=document.getElementById("modalContent"),u=m.innerHTML;m.innerHTML=`
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; margin: 0 auto 15px; animation: spin 1s linear infinite;"></div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                        <h5>Menambahkan jadwal...</h5>
                        <p style="color: #666;">Mohon tunggu sebentar</p>
                    </div>
                `;let g=0,p=0,h=[];const f=c.map(async k=>{var $;const w={idJadwal:parseInt(k),idAnggota:parseInt(e),status_pengangkutan:"terjadwal",catatan:d};console.log("Payload dikirim:",w);try{const y=await fetch(b.detailAnggotaJadwal,{method:"POST",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify(w)});if(!y.ok){let A=`HTTP ${y.status}`;try{const E=await y.json();A=(($=E==null?void 0:E.non_field_errors)==null?void 0:$[0])||(E==null?void 0:E.detail)||JSON.stringify(E)}catch{}throw new Error(A)}g++}catch(y){p++,h.push(`Jadwal ${k}: ${y.message}`)}});if(await Promise.allSettled(f),m.innerHTML=u,g>0)return r.innerHTML=`
                        <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb;">
                            <strong>Berhasil menambahkan ${g} jadwal!</strong><br>
                            Data akan diperbarui...
                        </div>
                    `,alert(`Berhasil menambahkan ${g} jadwal!
Data akan diperbarui...`),Ge(),!0;if(p>0){const k=h.map(w=>`<li>${w}</li>`).join("");return r.innerHTML=`
                        <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; border: 1px solid #ffeaa7;">
                            <strong>Gagal menambah ${p} jadwal</strong><br>
                            Detail error:
                            <ul style="margin: 5px 0 0 20px; padding: 0;">${k}</ul>
                        </div>
                    `,!1}return!1}),n=document.getElementById("catatanAnggota"),o=document.getElementById("charCount");return n.addEventListener("input",function(){o.textContent=`${this.value.length}/500 karakter`}),mc(),s}).catch(a=>{Ee("Error",`
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
                    <strong>Error memuat data jadwal:</strong><br>
                    ${a.message}
                </div>
            `,()=>!0)})}function cc(e){const a=new Date;a.setHours(0,0,0,0);const t=e.filter(o=>o.tanggalJadwal?new Date(o.tanggalJadwal)>=a:!1);if(t.length===0)return`
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“­</div>
                <p>Tidak ada jadwal yang tersedia untuk dipilih.</p>
                <p>Silakan hubungi admin untuk informasi jadwal terbaru.</p>
            </div>
        `;const i={};t.forEach(o=>{const l=o.idJadwal,r=o.tanggalJadwal,c=o.nama_tim||"Tim";if(r){const d=new Date(r),m=d.toLocaleDateString("id-ID",{month:"long",year:"numeric"});i[m]||(i[m]=[]),i[m].push({id:l,tanggal:r,namaTim:c,dateObj:d,formattedDate:d.toLocaleDateString("id-ID",{weekday:"short",day:"numeric",month:"short"}),isToday:d.toDateString()===a.toDateString()})}});let s="";return Object.keys(i).sort((o,l)=>new Date(o)-new Date(l)).forEach(o=>{const l=i[o];l.sort((r,c)=>r.dateObj-c.dateObj),s+=`
            <div style="grid-column: 1 / -1; margin-bottom: 10px;">
                <h4 style="margin: 0; padding-bottom: 5px; border-bottom: 2px solid #007bff; color: #333;">
                    ${o}
                </h4>
            </div>
        `,l.forEach(r=>{const c=r.isToday?'<span style="position: absolute; top: -5px; left: -5px; background: #ff5722; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px;">HARI INI</span>':"";s+=`
                <div class="jadwal-card-anggota" data-jadwal-id="${r.id}" 
                     data-jadwal-tanggal="${r.formattedDate}"
                     data-jadwal-tim="${r.namaTim}"
                     style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; 
                            cursor: pointer; transition: all 0.2s; text-align: center;
                            background: white; position: relative; min-height: 70px;">
                    ${c}
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 5px;">
                        ${r.formattedDate}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${r.namaTim}
                    </div>
                    <div class="checkmark-anggota" style="position: absolute; top: 5px; right: 5px; 
                          width: 20px; height: 20px; border-radius: 50%; 
                          background: #28a745; color: white; font-size: 12px;
                          display: none; align-items: center; justify-content: center;">
                        âœ“
                    </div>
                </div>
            `})}),s}function mc(){const e=document.querySelectorAll(".jadwal-card-anggota"),a=[],t=new Map;e.forEach(i=>{i.addEventListener("click",function(){const s=this.getAttribute("data-jadwal-id"),n=this.getAttribute("data-jadwal-tanggal"),o=this.getAttribute("data-jadwal-tim"),l=this.querySelector(".checkmark-anggota");if(a.includes(s)){const r=a.indexOf(s);a.splice(r,1),t.delete(s),this.style.background="white",this.style.borderColor="#ddd",this.style.boxShadow="none",l&&(l.style.display="none")}else{if(a.length>=4){alert("Maksimal hanya bisa memilih 4 jadwal!");return}a.push(s),t.set(s,{tanggal:n,namaTim:o,id:s}),this.style.background="#e3f2fd",this.style.borderColor="#007bff",this.style.boxShadow="0 0 0 2px rgba(0, 123, 255, 0.25)",l&&(l.style.display="flex")}uc(a,t)}),i.addEventListener("mouseenter",function(){a.includes(this.getAttribute("data-jadwal-id"))||(this.style.background="#f8f9fa",this.style.transform="translateY(-2px)",this.style.boxShadow="0 4px 6px rgba(0,0,0,0.1)")}),i.addEventListener("mouseleave",function(){const s=this.getAttribute("data-jadwal-id");a.includes(s)||(this.style.background="white",this.style.transform="translateY(0)",this.style.boxShadow="none")})})}function uc(e,a){document.getElementById("selectedCountAnggota").textContent=e.length,document.getElementById("selectedJadwalIdsAnggota").value=e.join(",");const t=document.getElementById("selectedJadwalListAnggota");if(e.length===0){t.innerHTML='<span style="color: #999; font-style: italic;">Belum ada jadwal yang dipilih</span>';return}let i='<div style="display: flex; flex-wrap: wrap; gap: 5px;">';e.forEach(s=>{const n=a.get(s);n&&(i+=`
                <span style="background: #007bff; color: white; padding: 3px 8px; 
                      border-radius: 12px; font-size: 12px; display: inline-flex; 
                      align-items: center; gap: 5px;">
                    ${n.tanggal}
                    <button type="button" onclick="removeSelectedJadwalAnggota('${s}')" 
                            style="background: none; border: none; color: white; 
                                   cursor: pointer; font-size: 10px; padding: 0;"
                            onmouseover="this.innerHTML='Ã—'" 
                            onmouseout="this.innerHTML='âœ•'">
                        âœ•
                    </button>
                </span>
            `)}),i+="</div>",t.innerHTML=i}async function gc(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()});let t=null;if(a.idJadwal)try{t=await M(`${b.jadwal}${a.idJadwal}/`,{headers:v()})}catch(s){console.warn("Tidak bisa fetch detail jadwal:",s)}const i=`
            <div>
                <h3>ðŸ“‹ Detail Jadwal Pengangkutan</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #555;">ID:</div>
                        <div>${a.id||"N/A"}</div>
                        
                        <div style="font-weight: 600; color: #555;">Status:</div>
                        <div>
                            ${ao(a.status_pengangkutan)}
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Tanggal:</div>
                        <div>
                            <strong>${a.tanggal_jadwal||(t==null?void 0:t.tanggalJadwal)||"N/A"}</strong>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Tim Angkut:</div>
                        <div>
                            <strong>${a.nama_tim||(t==null?void 0:t.nama_tim)||"N/A"}</strong>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Catatan:</div>
                        <div style="white-space: pre-wrap; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; min-height: 60px;">
                            ${a.catatan||'<span style="color: #999; font-style: italic;">Tidak ada catatan</span>'}
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Dibuat:</div>
                        <div>${a.created_at?new Date(a.created_at).toLocaleString("id-ID"):"N/A"}</div>
                    </div>
                </div>
            </div>
        `;Ee("Detail Jadwal",i)}catch(a){alert("Error loading detail: "+a.message)}}async function pc(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()});if(a.status_pengangkutan!=="terjadwal"){Ee("Peringatan",`
                <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffecb5;">
                    <strong>Hanya jadwal dengan status "Terjadwal" yang dapat diedit!</strong><br>
                    Status saat ini: ${a.status_pengangkutan}
                </div>
            `,()=>!0);return}const t=a.catatan||"",i=`
            <div id="validationMessageContainer"></div>
            
            <form id="editDetailFormAnggota">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <strong>Catatan</strong>
                        <small style="color: #666; font-weight: normal;"> - Update informasi tambahan jika diperlukan</small>
                    </label>
                    <textarea id="catatanEdit" style="width: 100%; padding: 8px; height: 100px; border: 1px solid #ddd; border-radius: 4px;" 
                              placeholder="Contoh: Sampah organik 3 karung, plastik 1 karung, ada barang elektronik rusak...">${t}</textarea>
                
                    ${t?`
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
                        <small style="color: #666; font-weight: bold;">Catatan saat ini:</small>
                        <div style="color: #333; margin-top: 5px; font-size: 14px;">${t}</div>
                    </div>
                    `:`
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <small style="color: #666; font-weight: bold;">Catatan saat ini:</small>
                        <div style="color: #999; font-style: italic; margin-top: 5px; font-size: 14px;">Tidak ada catatan</div>
                    </div>
                    `}
                </div>
                
                <div style="padding: 10px; background: #fff3cd; border-radius: 5px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404;">
                        <strong>âš ï¸ Perhatian:</strong> Hanya catatan yang dapat diubah. 
                        Untuk mengubah tanggal atau membatalkan jadwal, gunakan tombol "Batalkan" dan buat jadwal baru.
                    </p>
                </div>
            </form>
        `;Ee("Edit Catatan Jadwal",i,async()=>{const s=document.getElementById("catatanEdit").value.trim(),n=document.getElementById("validationMessageContainer");if(n.innerHTML="",!s)return n.innerHTML=`
                    <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb;">
                        <strong>Catatan tidak boleh kosong!</strong><br>
                        Silakan isi catatan atau ketik "-" jika tidak ada catatan
                    </div>
                `,n.scrollIntoView({behavior:"smooth",block:"center"}),!1;if(s===t)return n.innerHTML=`
                    <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; border: 1px solid #ffeaa7;">
                        <strong>Tidak ada perubahan!</strong><br>
                        Catatan masih sama dengan sebelumnya. Silakan ubah catatan jika ingin memperbarui
                    </div>
                `,n.scrollIntoView({behavior:"smooth",block:"center"}),!1;const o=document.getElementById("modalContent"),l=o.innerHTML;o.innerHTML=`
                <div style="text-align: center; padding: 20px 0;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; margin: 0 auto 15px; animation: spin 1s linear infinite;"></div>
                    <h5>Memperbarui catatan...</h5>
                    <p style="color: #666;">Mohon tunggu sebentar</p>
                </div>
            `;try{const r=await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({catatan:s})});return o.innerHTML=l,n.innerHTML=`
                    <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb;">
                        <strong>âœ… Catatan jadwal berhasil diperbarui!</strong><br>
                        Halaman akan diperbarui...
                    </div>
                `,alert("âœ… Catatan jadwal berhasil diperbarui!"),setTimeout(()=>{Ge()},1e3),!0}catch(r){return console.error("Update error:",r),o.innerHTML=l,n.innerHTML=`
                    <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb;">
                        <strong>Gagal memperbarui catatan!</strong><br>
                        ${r.message}
                    </div>
                `,!1}})}catch(a){Ee("Error",`
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
                <strong>Error memuat data!</strong><br>
                ${a.message}
            </div>
        `,()=>!0)}}async function bc(e){nc("Apakah Anda yakin ingin membatalkan jadwal ini?",async()=>{try{await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({status_pengangkutan:"dibatalkan"})}),alert("âœ… Jadwal berhasil dibatalkan!"),Ge()}catch(a){alert("Error: "+a.message)}},"Batalkan Jadwal","Ya, Batalkan","Tidak")}window.removeSelectedJadwalAnggota=function(e){const a=document.querySelector(`.jadwal-card-anggota[data-jadwal-id="${e}"]`);a&&a.click()};let Ua=null,S={hasActivePayment:!1,showPaymentReminder:!1,currentPayment:null};async function Xi(e,a={}){try{console.log(`ðŸŒ Fetching: ${e}`);const t=await fetch(e,{headers:v(),credentials:"include",...a});if(!t.ok){const s=await t.text();throw console.error(`âŒ HTTP ${t.status}: ${s}`),new Error(`HTTP ${t.status}: ${s}`)}const i=await t.json();return console.log(`âœ… Response from ${e}:`,i),i}catch(t){throw console.error(`ðŸ’¥ Error fetching ${e}:`,t),t}}async function Qi(){try{if(console.log("ðŸ”„ Memulai refreshPaymentStatus..."),S={hasActivePayment:!1,showPaymentReminder:!1,currentPayment:null,expiryReminder:null,isPending:!1,paymentMethod:null,isMemberInactive:!1},Ua||(Ua=JSON.parse(localStorage.getItem("user")||"{}"),console.log("ðŸ“‹ Current user data:",Ua)),!Ua||!Ua.id)return console.error("âŒ User data tidak valid:",Ua),S;try{console.log("ðŸŒ Fetching anggota data...");const e=await Xi(`${b.anggota}?user=${Ua.id}`);if(console.log("ðŸ“Š Anggota data received:",e),e&&e.length>0){const a=e[0];if(Ua.idAnggota=a.idAnggota,console.log("ðŸ‘¤ Anggota ditemukan:",a),localStorage.setItem("currentAnggota",JSON.stringify(a)),a.status==="non-aktif")return console.log("âš ï¸ Anggota status non-aktif"),S.hasActivePayment=!1,S.showPaymentReminder=!0,S.isMemberInactive=!0,await hc(a.idAnggota),S;const t=new Date,i=new Date(a.tanggalEnd),s=Math.ceil((i-t)/(1e3*60*60*24));console.log(`ðŸ“… Expiry check: ${s} hari tersisa`),s<=7&&(S.expiryReminder={daysRemaining:s,tanggalEnd:a.tanggalEnd,showWarning:!0},s<=3&&(S.expiryReminder.isUrgent=!0),s<=0&&(S.expiryReminder.isExpired=!0,S.hasActivePayment=!1)),await fc(a.idAnggota)}else console.warn("âš ï¸ Tidak ada data anggota untuk user ini"),S.hasActivePayment=!1,S.showPaymentReminder=!0}catch(e){console.error("âŒ Error mengambil data anggota:",e),S.hasActivePayment=!1,S.showPaymentReminder=!0}return console.log("ðŸ Payment status akhir:",S),S}catch(e){return console.error("ðŸ’¥ refreshPaymentStatus error:",e),S.hasActivePayment=!1,S.showPaymentReminder=!0,x("error","Gagal memuat status pembayaran. Coba refresh halaman."),S}}async function fc(e){try{console.log("ðŸ’° Checking latest payment for anggota:",e),S.currentPayment=null,S.hasActivePayment=!1,S.showPaymentReminder=!0,S.isPending=!1,S.paymentMethod=null,S.canAccessSchedule=!1;const a=await Xi(`${b.pembayaran}?idAnggota=${e}`),t=Array.isArray(a)?a:(a==null?void 0:a.results)||[];if(!t.length){console.log("ðŸ“­ Tidak ada pembayaran");return}const i={pending:0,lunas:1,gagal:2},n=t.filter(r=>r.statusBayar).sort((r,c)=>{const d=i[r.statusBayar]??99,m=i[c.statusBayar]??99;return d!==m?d-m:new Date(c.tanggalBayar)-new Date(r.tanggalBayar)})[0];S.currentPayment=n;const o=n.statusBayar.toLowerCase(),l=(n.metodeBayar||"").toLowerCase();if(S.paymentMethod=l,console.log("ðŸ’³ Latest payment FIXED:",n),o==="lunas"){S.hasActivePayment=!0,S.showPaymentReminder=!1,S.isPending=!1,S.canAccessSchedule=!0,console.log("âœ… LUNAS â†’ jadwal dibuka");return}if(o==="pending"){S.isPending=!0,l==="cash"||l==="tunai"?(S.canAccessSchedule=!0,S.hasActivePayment=!0,S.showPaymentReminder=!0,console.log("ðŸŸ¢ PENDING + TUNAI â†’ jadwal dibuka (dengan reminder)")):(S.canAccessSchedule=!1,S.hasActivePayment=!1,S.showPaymentReminder=!0,console.log("ðŸ”’ PENDING non-tunai â†’ jadwal dikunci"));return}S.canAccessSchedule=!1,S.showPaymentReminder=!0,console.log("âŒ GAGAL / UNKNOWN â†’ jadwal dikunci")}catch(a){console.error("âŒ Error checking latest payment:",a),S.canAccessSchedule=!1,S.showPaymentReminder=!0}}async function hc(e){try{console.log("ðŸ” Checking recent payments for non-active member:",e);const a=await Xi(`${b.pembayaran}?anggota=${e}`);if(a&&a.length>0){const t=a.find(i=>{var n,o;const s=((n=i.statusBayar)==null?void 0:n.toLowerCase())||((o=i.status)==null?void 0:o.toLowerCase());return["pending","waiting","process"].includes(s)});console.log("ðŸ“Š Pending payment found:",t),t&&(S.pendingPayment=t,S.paymentMethod=t.metodeBayar,S.isPending=!0,console.log("ðŸ”„ Ada pembayaran pending untuk anggota non-aktif:",t))}}catch(a){console.error("Error checking recent payment:",a)}}function Tt(e){if(!e)return"";try{return new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})}catch{return""}}function vc(){P("Pembayaran Diperlukan",`
        <div class="text-center py-4">
            <div class="display-1 text-warning mb-3">
                <i class="bi bi-credit-card"></i>
            </div>
            <h4 class="text-warning mb-3">Fitur Ini Membutuhkan Pembayaran</h4>
            <p class="text-muted mb-4">
                Untuk dapat mengakses fitur pengangkutan sampah, Anda perlu menyelesaikan pembayaran bulanan terlebih dahulu.
                Setelah pembayaran lunas, semua fitur akan terbuka untuk Anda.
            </p>
            <div class="row g-3 mt-4">
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h5 class="card-title text-warning">
                                <i class="bi bi-info-circle me-2"></i>Informasi Pembayaran
                            </h5>
                            <ul class="text-start mt-3">
                                <li class="mb-2">Biaya bulanan: <strong>Rp 50.000</strong></li>
                                <li class="mb-2">Layanan: Pengangkutan 4x sebulan</li>
                                <li class="mb-2">Pembayaran via Transfer Bank/QRIS</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-body">
                            <h5 class="card-title text-success">
                                <i class="bi bi-check-circle me-2"></i>Manfaat Setelah Bayar
                            </h5>
                            <ul class="text-start mt-3">
                                <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Akses laporan sampah</li>
                                <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Jadwal pengangkutan</li>
                                <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Tim pengangkut datang</li>
                                <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Lingkungan lebih bersih</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <button id="modalBayarSekarang" class="btn btn-success btn-lg">
                    <i class="bi bi-credit-card me-2"></i>Bayar Sekarang
                </button>
            </div>
        </div>
        `,null),setTimeout(()=>{const e=document.getElementById("modalBayarSekarang");e&&e.addEventListener("click",()=>{const a=document.getElementById("btnPembayaran");a&&a.click()})},100)}function yc(e,a=!1,t=""){return async function(i){if(console.log(`ðŸ“± Menu ${t} diklik, requiresPayment: ${a}`),a){try{await Qi(),console.log(`âœ… Payment status refreshed: ${S.hasActivePayment}`),console.log("ðŸ“Š Payment details:",{hasActivePayment:S.hasActivePayment,isPending:S.isPending,currentPayment:S.currentPayment})}catch(n){console.error("âŒ Error refreshing payment status:",n),x("warning","Gagal memeriksa status pembayaran")}if(!S.canAccessSchedule){console.log("ðŸš« Jadwal dikunci oleh status pembayaran"),vc();return}}document.querySelectorAll(".nav-link.btn").forEach(n=>{n.classList.remove("active")}),i.target.closest(".nav-link.btn")&&i.target.closest(".nav-link.btn").classList.add("active");const s=document.getElementById("mainContent");if(s){s.style.opacity="0.5",s.innerHTML=`
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Memuat ${t}...</p>
                </div>
            `;try{console.log(`ðŸ”„ Memuat halaman ${t}...`),await e(),console.log(`âœ… Halaman ${t} berhasil dimuat`)}catch(n){console.error(`âŒ Error loading page ${t}:`,n),s.innerHTML=`
                    <div class="alert alert-danger">
                        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Terjadi Kesalahan</h4>
                        <p>${n.message||"Gagal memuat halaman"}</p>
                        <div class="mt-3">
                            <button onclick="location.reload()" class="btn btn-primary">
                                <i class="bi bi-arrow-clockwise me-1"></i> Muat Ulang
                            </button>
                            <button onclick="window.history.back()" class="btn btn-secondary ms-2">
                                <i class="bi bi-arrow-left me-1"></i> Kembali
                            </button>
                        </div>
                    </div>
                `}finally{s.style.opacity="1"}}}}async function pt(e,a=null){const t=document.getElementById("webpush-status");if(t){if(a==="not-supported")t.innerHTML=`
            <span class="badge bg-warning">
                <i class="bi bi-exclamation-triangle"></i> Browser tidak mendukung
            </span>
        `;else if(a==="error")t.innerHTML=`
            <span class="badge bg-danger">
                <i class="bi bi-x-circle"></i> Gagal inisialisasi
            </span>
        `;else if(e)try{const i=await e.checkSubscription();console.log("ðŸ”„ Updating web push status, subscribed:",i),i?t.innerHTML=`
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> Notifikasi aktif
                    </span>
                `:t.innerHTML=`
                    <span class="badge bg-secondary">
                        <i class="bi bi-bell-slash"></i> Notifikasi nonaktif
                    </span>
                `}catch(i){console.error("âŒ Error checking subscription:",i),t.innerHTML=`
                <span class="badge bg-warning">
                    <i class="bi bi-exclamation-circle"></i> Gagal memeriksa
                </span>
            `}}}async function kc(){try{console.log("ðŸ”” Initializing Web Push..."),Z.isSupported?(await Z.initialize(),Z.setupPushEventListener(),await pt(Z),console.log("âœ… Web Push initialized")):(pt(null,"not-supported"),console.log("âš ï¸ Web Push not supported"))}catch(e){console.error("âŒ Error initializing Web Push:",e),pt(null,"error")}}async function wc(){try{if(console.log("ðŸ”” Checking notification status..."),!("Notification"in window))return console.warn("âš ï¸ Browser tidak mendukung Notification API"),!1;const e=Notification.permission;console.log("ðŸ“Š Notification permission:",e);const a=await Z.checkSubscription();console.log("ðŸ“Š Has subscription:",a);const t=document.getElementById("notification-alert");return t&&(e==="denied"?(t.classList.remove("d-none"),t.innerHTML=`
                    <div class="d-flex align-items-center">
                        <i class="bi bi-bell-slash-fill fs-4 me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-2">Notifikasi Diblokir</h5>
                            <p class="mb-2">Izin notifikasi telah diblokir. Silakan aktifkan di pengaturan browser Anda.</p>
                            <div class="d-flex flex-wrap gap-2">
                                <button onclick="window.location.reload()" class="btn btn-primary btn-sm">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                `):e!=="granted"||!a?t.classList.remove("d-none"):t.classList.add("d-none")),a&&e==="granted"}catch(e){return console.error("âŒ Error checking notification status:",e),!1}}async function xc(){const e=document.querySelectorAll("#toggleNotificationsBtn");if(e.length){e.forEach(a=>{const t=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Memproses...',a.dataset.originalText=t});try{console.log("ðŸ”” Checking subscription status...");const a=await Z.checkSubscription();console.log("ðŸ“Š Current subscription status:",a);let t;a?(console.log("âŒ Unsubscribing from notifications..."),t=await Z.disableNotifications(),console.log("âœ… Unsubscribe result:",t)):(console.log("âœ… Subscribing to notifications..."),t=await Z.enableNotifications(),console.log("âœ… Subscribe result:",t)),await pt(Z),await as(),t&&t.success?x("success",t.message||"Pengaturan notifikasi berhasil diubah"):x("warning",(t==null?void 0:t.message)||"Terjadi kesalahan saat mengubah pengaturan notifikasi")}catch(a){console.error("âŒ Error toggling notifications:",a),x("error","Gagal mengubah pengaturan notifikasi: "+a.message)}finally{e.forEach(a=>{a.disabled=!1,a.innerHTML=a.dataset.originalText||"Aktif/Nonaktif",delete a.dataset.originalText})}}}async function Lc(){try{if(console.log("ðŸ”” Requesting notification permission..."),!("Notification"in window))return{granted:!1,error:"Browser tidak mendukung notifikasi"};if(Notification.permission==="granted")return{granted:!0};if(Notification.permission==="denied")return{granted:!1,error:"Izin notifikasi telah diblokir"};const e=await Notification.requestPermission();return console.log("ðŸ“Š Permission result:",e),{granted:e==="granted"}}catch(e){return console.error("âŒ Error requesting permission:",e),{granted:!1,error:e.message}}}function $c(){Object.entries({btnProfil:{handler:kt,requiresPayment:!1,name:"Profil"},btnLaporan:{handler:Zi,requiresPayment:!1,name:"Laporan Sampah"},btnPembayaran:{handler:Wd,requiresPayment:!1,name:"Pembayaran"},btnJadwal:{handler:oc,requiresPayment:!0,name:"Jadwal Angkut"}}).forEach(([s,n])=>{const o=document.getElementById(s);o?(o.onclick=yc(n.handler,n.requiresPayment,n.name),console.log(`âœ… Event listener untuk ${s} ditambahkan`)):console.warn(`âš ï¸ Button ${s} tidak ditemukan`)});const a=document.getElementById("btnBayarSekarang");a&&(a.onclick=()=>{const s=document.getElementById("btnPembayaran");s&&s.click()},console.log("âœ… Event listener untuk btnBayarSekarang ditambahkan"));const t=document.getElementById("btnLogout");t&&(t.onclick=()=>{typeof window.logout=="function"?window.logout():(localStorage.clear(),window.location.hash="#/login",window.location.reload())},console.log("âœ… Event listener untuk btnLogout ditambahkan"));const i=document.querySelectorAll("#toggleNotificationsBtn");i.length>0?(i.forEach(s=>{s.onclick=xc}),console.log(`âœ… Event listener untuk ${i.length} toggleNotificationsBtn ditambahkan`)):console.warn("âš ï¸ toggleNotificationsBtn tidak ditemukan")}window.checkPaymentStatus=async function(e=!1){console.log("ðŸ”„ checkPaymentStatus dipanggil, forceRefresh:",e);const a=(event==null?void 0:event.target)||document.querySelector('[onclick*="checkPaymentStatus"]'),t=a==null?void 0:a.innerHTML;a&&(a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>Checking...');try{await Qi(),e&&(S.hasActivePayment?(x("success","âœ… Status pembayaran telah aktif! Memuat ulang dashboard..."),setTimeout(()=>{window.location.reload()},1e3)):S.isPending?x("info","â³ Status pembayaran masih menunggu konfirmasi..."):x("info","Status pembayaran masih belum lunas. Silakan selesaikan pembayaran."))}catch(i){console.error("Error checking payment status:",i),x("error","Gagal memeriksa status pembayaran")}finally{a&&(a.disabled=!1,a.innerHTML=t)}};async function eo(){console.log("ðŸš€ Starting dashboardAnggota...");try{const e=await Da();if(!e){x("warning","Silakan login terlebih dahulu!"),window.location.hash="#/login";return}if(console.log("ðŸ‘¤ User authenticated:",e),e.role!=="anggota")switch(console.warn(`âš ï¸ User role is ${e.role}, redirecting`),e.role){case"admin":window.location.hash="#/dashboard";return;case"tamu":case"tim_angkut":window.location.hash="#/dashboard";return;default:x("error","Anda tidak memiliki akses ke dashboard anggota!"),window.location.hash="#/login";return}Ua=e,console.log("ðŸ”„ Refreshing payment status...");const a=Qi(),t=new Promise((l,r)=>setTimeout(()=>r(new Error("Timeout refreshing payment status")),1e4));await Promise.race([a,t]);const{hasActivePayment:i,showPaymentReminder:s,currentPayment:n,isPending:o}=S;console.log("ðŸ“Š Payment status loaded:",S),Ec(e,i,s,n,o),$c(),setTimeout(()=>{Sc()},100),setTimeout(()=>{const l=document.getElementById("btnGoToPayment");l&&(l.onclick=()=>{const r=document.getElementById("btnPembayaran");r&&r.click()},console.log("âœ… Event listener untuk btnGoToPayment ditambahkan"))},100),await kc(),await wc(),await as(),console.log("ðŸ“„ Loading default page (laporan)...");try{await Zi();const l=document.getElementById("btnLaporan");l&&l.classList.add("active"),console.log("âœ… Laporan page loaded successfully")}catch(l){console.error("âŒ Error loading laporan page:",l);try{console.log("ðŸ”„ Falling back to profil page..."),await kt();const r=document.getElementById("btnProfil");r&&r.classList.add("active"),console.log("âœ… Profil page loaded successfully")}catch(r){console.error("âŒ Error loading profile page:",r),x("error","Gagal memuat halaman. Silakan refresh.")}}console.log("ðŸŽ‰ Dashboard initialization complete!")}catch(e){console.error("ðŸ’¥ Critical error in dashboardAnggota:",e);const a=document.getElementById("app");a.innerHTML=`
            <div class="container mt-5">
                <div class="alert alert-danger">
                    <h4 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Terjadi Kesalahan</h4>
                    <p>Gagal memuat dashboard: ${e.message}</p>
                    <div class="mt-3">
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="bi bi-arrow-clockwise me-1"></i> Muat Ulang
                        </button>
                        <button onclick="window.location.hash='#/login'" class="btn btn-secondary ms-2">
                            <i class="bi bi-box-arrow-right me-1"></i> Login Ulang
                        </button>
                    </div>
                </div>
            </div>
        `}}function Ec(e,a,t,i,s=!1){const n=document.getElementById("app"),o=JSON.parse(localStorage.getItem("currentAnggota")||"{}");let l="",r="";if(t){let p="",h="",f="warning",k="bi-exclamation-triangle-fill",w=!0,$=!1,y=!0;s?S.paymentMethod==="cash"||S.paymentMethod==="tunai"?(p="â³ Menunggu Konfirmasi (Tunai)",h="Pembayaran tunai Anda sedang menunggu konfirmasi petugas. Anda tetap bisa mengakses jadwal pengangkutan.",f="info",k="bi-cash-stack",$=!0,w=!1,y=!1):(p="â³ Menunggu Konfirmasi",h="Pembayaran Anda sedang menunggu konfirmasi. Silakan refresh halaman dan menuju ke halaman Jadwal untuk penjadwalan pengangkutan.",f="info",k="bi-clock-fill",w=!1):S!=null&&S.isMemberInactive?(p="Status Anggota Non-Aktif",h="Status keanggotaan Anda saat ini non-aktif. Silakan melakukan pembayaran untuk mengaktifkan kembali layanan.",f="danger",k="bi-x-circle-fill"):(p="Pembayaran Bulanan Belum Lunas",h="Untuk dapat menggunakan layanan pengangkutan sampah, silakan selesaikan pembayaran bulanan terlebih dahulu.");let A="";w&&(A+=`
                <button id="btnBayarSekarang" class="btn btn-success btn-sm">
                    <i class="bi bi-credit-card me-1"></i> Bayar Sekarang
                </button>
            `),s&&S.paymentMethod!=="cash"&&S.paymentMethod!=="tunai"&&(A+=`
                <button onclick="checkPaymentStatus(true)" class="btn btn-primary btn-sm">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh Status
                </button>
            `),s&&(A+=`
                <button onclick="showPaymentDetails()" class="btn btn-outline-info btn-sm">
                    <i class="bi bi-receipt me-1"></i> Lihat Detail Pembayaran
                </button>
            `),y&&(A+=`
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="alert">
                    Nanti Saja
                </button>
            `),l=`
            <div class="alert alert-${f} alert-dismissible fade show mb-4 shadow-sm" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi ${k} fs-4 me-3"></i>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-2">${p}</h5>
                        <p class="mb-2">${h}</p>
                        ${$?`
                        <div class="alert alert-warning py-2 px-3 mb-2 d-inline-block">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Info Jadwal:</strong> Jadwal pengangkutan tetap dapat diakses di menu <strong>Jadwal Angkut</strong>
                        </div>
                        `:""}
                        ${A?`
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            ${A}
                        </div>
                        `:""}
                    </div>
                    ${y?`
                    <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
                    `:""}
                </div>
            </div>
        `}if(o!=null&&o.tanggalEnd){const p=new Date,h=new Date(o.tanggalEnd),f=Math.ceil((h-p)/(1e3*60*60*24));if(f<=7){let k="",w="warning";f<=0?(k=`âš ï¸ MASA BERLAKU TELAH HABIS! Keanggotaan Anda telah kadaluarsa sejak ${Tt(o.tanggalEnd)}. Segera perpanjang untuk melanjutkan layanan.`,w="danger"):f<=3?(k=`â³ MASA BERLAKU AKAN HABIS! Keanggotaan Anda tinggal ${f} hari lagi (hingga ${Tt(o.tanggalEnd)}). Segera perpanjang!`,w="warning"):(k=`ðŸ“… Masa berlaku keanggotaan Anda tinggal ${f} hari lagi (hingga ${Tt(o.tanggalEnd)}).`,w="info"),r=`
                <div class="marquee-container mb-3">
                    <div class="alert alert-${w} mb-0 py-2">
                        <div class="marquee-content">
                            <i class="bi bi-clock-history me-2"></i>
                            ${k}
                            <a href="#" id="btnGoToPaymentFromMarquee" class="ms-3 fw-bold text-decoration-underline" style="color: inherit;">
                                <i class="bi bi-credit-card me-1"></i>Perpanjang Sekarang
                            </a>
                        </div>
                    </div>
                </div>
            `}}const c=S.canAccessSchedule?`
        <div class="alert alert-success alert-dismissible fade show mb-4 shadow-sm" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-2">${s?"â³ Pembayaran Sedang Diproses":"âœ… Pembayaran Lunas!"}</h5>
                    <p class="mb-0">${s?"Status anggota Anda sedang diproses. Anda dapat mengakses jadwal pengangkutan.":"Status anggota Anda aktif. Semua fitur kini terbuka."}</p>
                    ${i?`
                    <small class="text-muted">
                        ${s?"Menunggu konfirmasi":"Terakhir bayar"}: ${Tt(i.tanggalBayar||i.tanggal_bayar||i.created_at)} | 
                        Metode: ${i.metodeBayar||"N/A"}
                        ${s?' | Status: <span class="badge bg-warning">Pending</span>':""}
                    </small>
                    `:""}
                </div>
                <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    `:"",d=!S.canAccessSchedule,m=d?"Fitur terkunci karena pembayaran belum lunas":"Akses jadwal pengangkutan",u=`
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="${S.canAccessSchedule?"bg-success":S.isPending?"bg-info":"bg-warning"} bg-opacity-10 p-3 rounded me-3">
                                <i class="bi ${S.canAccessSchedule?"bi-check-circle text-success":S.isPending?"bi-clock text-info":"bi-exclamation-triangle text-warning"} fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1">Status Layanan</h5>
                                <p class="card-text text-muted mb-0">Pengangkutan Sampah</p>
                            </div>
                        </div>
                        ${S.canAccessSchedule?S.isPending?'<span class="badge bg-info">â³ Pending (Tunai)</span>':'<span class="badge bg-success">âœ“ Aktif</span>':S.isPending?'<span class="badge bg-warning">â³ Menunggu</span>':'<span class="badge bg-danger">âŒ Belum Bayar</span>'}
                        ${S.isPending&&(S.paymentMethod==="cash"||S.paymentMethod==="tunai")?'<div class="mt-2 small text-info"><i class="bi bi-check-circle"></i> Jadwal dapat diakses</div>':S.isPending?'<div class="mt-2 small text-warning"><i class="bi bi-exclamation-circle"></i> Tunggu konfirmasi</div>':""}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="${S.canAccessSchedule?"bg-info":"bg-secondary"} bg-opacity-10 p-3 rounded me-3">
                                <i class="bi ${S.canAccessSchedule?"bi-truck text-info":"bi-truck text-secondary"} fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1">Pengangkutan</h5>
                                <p class="card-text text-muted mb-0">${S.canAccessSchedule?"Aktif":"Tidak Aktif"}</p>
                            </div>
                        </div>
                        <span class="badge ${S.canAccessSchedule?"bg-info":"bg-secondary"}">
                            ${S.canAccessSchedule?S.isPending?"ðŸ“¦ Menunggu jadwal":"ðŸ“¦ Siap diangkut":"ðŸ”’ Tunggu pembayaran"}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-currency-dollar text-primary fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1">Biaya Bulanan</h5>
                                <p class="card-text text-muted mb-0">Rp 50.000</p>
                            </div>
                        </div>
                        ${S.canAccessSchedule?S.isPending?`<span class="badge bg-info">â³ ${S.paymentMethod==="cash"?"Tunai - Pending":"Pending"}</span>`:'<span class="badge bg-success">âœ“ Lunas</span>':S.isPending?'<span class="badge bg-warning">â³ Pending</span>':'<span class="badge bg-danger">âŒ Belum Bayar</span>'}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-star text-success fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1">Kontribusi Anda</h5>
                                <p class="card-text text-muted mb-0">Lingkungan Bersih</p>
                            </div>
                        </div>
                        <span class="badge ${S.canAccessSchedule?"bg-warning text-dark":"bg-light text-dark"}">
                            ${S.canAccessSchedule?S.isPending?"â³ Siap berkontribusi":"ðŸŒ± Aktif berkontribusi":"ðŸ’¡ Menunggu aktivasi"}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    `;n.innerHTML=`
        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        
        <div class="container-fluid p-0">
            <!-- Header -->
            <div class="bg-success bg-gradient text-white p-4 mb-4">
                <div class="container">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="mb-3 mb-md-0">
                            <div class="d-flex align-items-center mb-3">
                                <img src="/logo/logo_3d.png" 
                                     alt="CleanUp Kupang Logo" 
                                     style="height: 60px; width: auto; margin-right: 15px;">
                                <div>
                                    <h1 class="h2 mb-2"><i class="bi bi-person-circle me-2"></i>Selamat Datang, ${e.username}!</h1>
                                    <p class="mb-0 opacity-75">Anda login sebagai <strong>Anggota CleanUp</strong></p>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button onclick="checkPaymentStatus(true)" class="btn btn-sm btn-light me-2">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh Status
                                </button>
                                <span class="ms-2 small">
                                    Status: ${S.canAccessSchedule?S.isPending?'<span class="badge bg-info">â³ Pending (Tunai)</span>':'<span class="badge bg-success">âœ“ Aktif</span>':S.isPending?'<span class="badge bg-warning">â³ Menunggu</span>':'<span class="badge bg-danger">âŒ Belum Bayar</span>'}
                                </span>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="bg-white bg-opacity-25 p-3 rounded">
                                <small class="d-block text-white text-opacity-75">Status</small>
                                <div class="fw-bold">
                                    ${S.canAccessSchedule?S.isPending?'<span class="badge bg-info">Pending Tunai</span>':'<span class="badge bg-success">Aktif</span>':'<span class="badge bg-warning text-dark">Perlu Bayar</span>'}
                                </div>
                            </div>
                            <div class="bg-white bg-opacity-25 p-3 rounded">
                                <small class="d-block text-white text-opacity-75">ID Anggota</small>
                                <div class="fw-bold">#${Ua.idAnggota?Ua.idAnggota.toString().padStart(4,"0"):"---"}</div>
                            </div>
                            <div class="bg-white bg-opacity-25 p-3 rounded">
                                <small class="d-block text-white text-opacity-75">Notifikasi</small>
                                <div class="fw-bold">
                                    <span id="webpush-status">
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-clock"></i> Memuat...
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container">
                <!-- Expiry Reminder -->
                ${r}
                
                <!-- Pembayaran Reminder Banner -->
                ${l}
                
                <!-- Notifikasi Alert -->
                <div id="notification-alert" class="alert alert-info alert-dismissible fade show mb-4 d-none shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-bell-fill fs-4 me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-2">Aktifkan Notifikasi Web</h5>
                            <p class="mb-2">Dapatkan notifikasi real-time tentang pembayaran, jadwal pengangkutan, dan update penting lainnya.</p>
                            <div class="d-flex flex-wrap gap-2">
                                <button id="toggleNotificationsBtn" class="btn btn-primary btn-sm">
                                    <i class="bi bi-bell me-1"></i> Aktifkan Notifikasi
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="alert">
                                    Nanti Saja
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${c}
                
                <!-- Main Card -->
                <div class="card shadow-sm mb-4">
                    <!-- Navbar -->
                    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                        <div class="container-fluid">
                            <a class="navbar-brand d-flex align-items-center" href="#">
                                <img src="/logo/logo_3d.png" 
                                     alt="CleanUp Kupang Logo" 
                                     style="height: 40px; width: auto; margin-right: 10px;">
                                <span class="fw-bold">CleanUp Kupang</span>
                            </a>
                            
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#dashboardNavbar" aria-controls="dashboardNavbar" aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            
                            <div class="collapse navbar-collapse" id="dashboardNavbar">
                                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                    <li class="nav-item">
                                        <button id="btnLaporan" class="nav-link btn btn-link">
                                            <i class="bi bi-clipboard-check me-1"></i> Laporan Sampah
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button id="btnProfil" class="nav-link btn btn-link">
                                            <i class="bi bi-person me-1"></i> Profil
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button id="btnJadwal" class="nav-link btn btn-link ${d?"disabled-link":""}" 
                                                ${d?'title="'+m+'"':""}>
                                            <i class="bi bi-calendar-event me-1"></i> Jadwal Angkut
                                            ${d?'<span class="badge bg-secondary ms-1">ðŸ”’</span>':""}
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button id="btnPembayaran" class="nav-link btn btn-link">
                                            <i class="bi bi-credit-card me-1"></i> Pembayaran
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="dropdown">
                                        <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-bell me-1"></i> Notifikasi
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><h6 class="dropdown-header">Pengaturan Notifikasi</h6></li>
                                            <li>
                                                <div class="px-3 py-2">
                                                    <small class="text-muted d-block mb-1">Status:</small>
                                                    <div id="webpush-status-dropdown">
                                                        <span class="badge bg-secondary">Memuat...</span>
                                                    </div>
                                                </div>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button id="toggleNotificationsBtn" class="dropdown-item">
                                                    <i class="bi bi-bell me-2"></i> Aktif/Nonaktif
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <button onclick="checkPaymentStatus(true)" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                    </button>
                                    <button id="btnLogout" class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-box-arrow-right me-1"></i> Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <!-- Main Content -->
                    <div id="mainContent" class="p-4 min-vh-50">
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <img src="/logo/logo_3d.png" 
                                     alt="CleanUp Kupang Logo" 
                                     style="height: 120px; width: auto; margin-bottom: 20px;">
                            </div>
                            
                            <div class="display-1 ${S.canAccessSchedule?"text-success":S.isPending?"text-info":"text-muted"} mb-4">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <h3 class="mb-3">Dashboard Anggota CleanUp</h3>
                            <p class="text-muted">Selamat datang di dashboard anggota CleanUp Kupang</p>
                            
                            ${S.canAccessSchedule?`
                            <div class="alert alert-success mt-4 max-w-600 mx-auto">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>Selamat!</strong> Status Anda ${S.isPending?"sedang diproses":"aktif"}. ${S.isPending?"Anda tetap dapat mengakses jadwal pengangkutan.":"Semua fitur sekarang tersedia."}
                            </div>
                            `:`
                            <div class="alert ${S.isPending?"alert-info":"alert-warning"} mt-4 max-w-600 mx-auto">
                                <i class="bi ${S.isPending?"bi-info-circle":"bi-exclamation-circle"} me-2"></i>
                                <strong>${S.isPending?"Informasi:":"Perhatian:"}</strong> 
                                ${S.isPending?"Pembayaran Anda sedang menunggu konfirmasi.":"Anda belum dapat mengakses fitur pengangkutan sampah karena pembayaran bulanan belum dilakukan."}
                                <div class="mt-2">
                                    <button id="btnGoToPayment" class="btn btn-success btn-sm">
                                        <i class="bi bi-credit-card me-1"></i> Bayar Sekarang
                                    </button>
                                </div>
                            </div>
                            `}
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                ${u}

                <!-- Footer -->
                <footer class="text-center py-4 mt-4 border-top">
                    <div class="mb-3">
                        <img src="/logo/logo_3d.png" 
                             alt="CleanUp Kupang Logo" 
                             style="height: 60px; width: auto;">
                    </div>
                    
                    <p class="mb-2">
                        <strong>CleanUp Kupang</strong> - Layanan Angkut Sampah Profesional<br>
                        <small class="text-muted">
                            <i class="bi bi-telephone me-1"></i> (0380) 123456 | 
                            <i class="bi bi-envelope ms-2 me-1"></i> info@cleanupkupang.id
                        </small>
                    </p>
                    <small class="text-muted">Â© 2024 CleanUp. Semua hak dilindungi.</small>
                </footer>
            </div>
        </div>

        <!-- Bootstrap 5 JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"><\/script>
    `;const g=document.createElement("style");g.textContent=`
        .nav-link.btn {
            color: #495057;
            text-decoration: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .nav-link.btn:hover {
            color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .nav-link.btn.active {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .nav-link.btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1rem;
            right: 1rem;
            height: 3px;
            background-color: #0d6efd;
            border-radius: 3px 3px 0 0;
        }
        
        .disabled-link {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
            position: relative;
        }
        
        .disabled-link:hover::before {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }
        
        .card {
            border-radius: 10px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .min-vh-50 {
            min-height: 400px;
        }
        
        .max-w-600 {
            max-width: 600px;
        }
        
        /* Marquee animation */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            margin-bottom: 1rem;
        }
        
        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
        }
        
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .marquee-content:hover {
            animation-play-state: paused;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .navbar-nav {
                gap: 0.5rem;
            }
            
            .nav-link.btn.active::after {
                left: 0.5rem;
                right: 0.5rem;
            }
            
            .d-flex.flex-wrap.gap-2 {
                gap: 0.5rem !important;
            }
            
            .marquee-content {
                font-size: 0.9rem;
                padding-left: 150%;
                animation: marquee 15s linear infinite;
            }
            
            @keyframes marquee {
                0% { transform: translateX(0); }
                100% { transform: translateX(-150%); }
            }
        }
        
        @media (max-width: 576px) {
            .marquee-content {
                font-size: 0.8rem;
                padding-left: 200%;
                animation: marquee 12s linear infinite;
            }
            
            @keyframes marquee {
                0% { transform: translateX(0); }
                100% { transform: translateX(-200%); }
            }
        }
        
        /* Styling khusus untuk alert payment */
        .alert .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .flex-grow-1 {
            flex-grow: 1;
        }
    `,document.head.appendChild(g),setTimeout(()=>{Tc()},100)}function Tc(){const e=document.getElementById("btnBayarSekarang");e&&(e.onclick=()=>{const i=document.getElementById("btnPembayaran");i&&i.click()});const a=document.getElementById("btnGoToPaymentFromMarquee");a&&(a.onclick=i=>{i.preventDefault();const s=document.getElementById("btnPembayaran");s&&s.click()});const t=document.getElementById("btnGoToPayment");t&&(t.onclick=()=>{const i=document.getElementById("btnPembayaran");i&&i.click()})}async function as(){const e=document.getElementById("webpush-status-dropdown");if(!e){console.warn("âš ï¸ webpush-status-dropdown tidak ditemukan");return}try{const a=await Z.checkSubscription();console.log("ðŸ”„ Updating dropdown status, subscribed:",a),a?e.innerHTML=`
                <span class="badge bg-success">
                    <i class="bi bi-check-circle"></i> Aktif
                </span>
            `:e.innerHTML=`
                <span class="badge bg-secondary">
                    <i class="bi bi-bell-slash"></i> Nonaktif
                </span>
            `}catch(a){console.error("âŒ Error updating dropdown status:",a),e.innerHTML=`
            <span class="badge bg-warning">
                <i class="bi bi-exclamation-circle"></i> Gagal memeriksa
            </span>
        `}}function Sc(){const e=document.getElementById("notification-alert");if(!e)return;const a=e.querySelector("#toggleNotificationsBtn");a&&(a.onclick=async function(t){t.preventDefault();try{const i=await Lc();if(i.granted){const s=await Z.enableNotifications();s.success?(x("success","Notifikasi berhasil diaktifkan!"),await pt(Z),await as(),e.classList.add("d-none")):x("warning",s.message||"Gagal mengaktifkan notifikasi")}else x("error",i.error||"Izin notifikasi ditolak")}catch(i){console.error("âŒ Error activating notifications from alert:",i),x("error","Gagal mengaktifkan notifikasi: "+i.message)}})}function Ac(){const e=S.currentPayment;if(console.log("ðŸ“Š Current payment data:",e),!e){x("info","Tidak ada data pembayaran yang tersedia");return}const a=e.idPembayaran||e.id;if(console.log("ðŸ” Payment ID to show:",a),!a){console.error("âŒ No payment ID found in:",e),x("warning","ID pembayaran tidak ditemukan");return}typeof window.showPaymentDetailForAnggota=="function"?(console.log("âœ… Calling showPaymentDetailForAnggota with ID:",a),window.showPaymentDetailForAnggota(a)):(console.error("âŒ showPaymentDetailForAnggota function not found"),x("error","Fitur detail pembayaran tidak tersedia"))}window.showPaymentDetails=Ac;function Bc(e,a,t=null,i="Simpan",s="Batal"){const n=document.createElement("div");n.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `,n.innerHTML=`
        <div style="
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        ">
            <div style="
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h3 style="margin: 0;">${e}</h3>
                <button id="closeModal" style="
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    color: #666;
                ">Ã—</button>
            </div>
            <div style="padding: 20px;" id="modalContent">
                ${a}
            </div>
            <div style="
                padding: 15px 20px;
                border-top: 1px solid #eee;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            ">
                <button id="cancelBtn" style="
                    padding: 8px 16px;
                    background: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                ">${s}</button>
                ${t?`
                <button id="confirmBtn" style="
                    padding: 8px 16px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                ">${i}</button>
                `:""}
            </div>
        </div>
    `,document.body.appendChild(n);const o=()=>document.body.removeChild(n);document.getElementById("closeModal").onclick=o,document.getElementById("cancelBtn").onclick=o,t&&(document.getElementById("confirmBtn").onclick=()=>{t(),o()});const l=r=>{r.key==="Escape"&&o()};return document.addEventListener("keydown",l),n._closeModal=o,n._handleEsc=l,n}let De=[],ya=1,Ea=10,hi,vi,Je;async function to(){if(hi=localStorage.getItem("user"),!hi){window.location.href="#/login";return}if(vi=JSON.parse(hi),Je=vi?vi.username:null,!Je){console.error("User not found in localStorage");return}const e=document.getElementById("mainContent");e.innerHTML=`
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ðŸ“… Jadwal Pengangkutan Tim ${Je}</h2>
                <button id="refreshBtn" style="padding: 8px 16px; background: #17a2b8; color: white;">ðŸ”„ Refresh</button>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <select id="filterTanggal" style="padding: 8px; width: 200px;">
                    <option value="">Semua Tanggal</option>
                    <option value="hari-ini">Hari Ini</option>
                    <option value="minggu-ini">Minggu Ini</option>
                    <option value="bulan-ini">Bulan Ini</option>
                </select>
                <select id="filterStatus" style="padding: 8px; width: 200px;">
                    <option value="">Semua Status</option>
                    <option value="terjadwal">Terjadwal</option>
                    <option value="dalam_proses">Dalam Proses</option>
                    <option value="selesai">Selesai</option>
                    <option value="dibatalkan">Dibatalkan</option>
                </select>
                <input type="text" id="searchAnggota" placeholder="Cari nama anggota..." style="padding: 8px; width: 250px;">
            </div>
            
            <!-- Stats Overview -->
            <div id="statsOverview" style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            ">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #1976d2;">0</div>
                    <div style="font-size: 14px; color: #555;">Total Jadwal</div>
                </div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #ff9800;">0</div>
                    <div style="font-size: 14px; color: #555;">Dalam Proses</div>
                </div>
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">0</div>
                    <div style="font-size: 14px; color: #555;">Selesai</div>
                </div>
                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #dc3545;">0</div>
                    <div style="font-size: 14px; color: #555;">Dibatalkan</div>
                </div>
            </div>
            
            <div id="detailTableContainer">
                <p>Loading data...</p>
            </div>
            
            <!-- Pagination Container -->
            <div id="detailPagination" style="margin-top: 20px; display: flex; justify-content: center; align-items: center;"></div>
        </div>
    `,document.getElementById("refreshBtn").onclick=rt,document.getElementById("filterTanggal").onchange=rt,document.getElementById("filterStatus").onchange=rt,document.getElementById("searchAnggota").oninput=rt,rt()}async function rt(){const e=document.getElementById("filterTanggal").value,a=document.getElementById("filterStatus").value,t=document.getElementById("searchAnggota").value;try{const i=await M(b.detailAnggotaJadwal,{headers:v()});console.log("Semua data jadwal:",i),console.log("Username yang login:",Je);const s=new Date,n=new Date(s.getFullYear(),s.getMonth(),s.getDate()),o=i.filter(l=>{const r=l.tanggal_jadwal||"",c=l.nama_anggota||"",d=l.status_pengangkutan||"",m=l.nama_tim||"",u=m===Je;if(!u)return console.log(`Data ${l.id} tidak sesuai: nama_tim=${m}, username=${Je}`),!1;let g=!0;if(e){if(!r)return!1;const f=new Date(r),k=new Date(f.getFullYear(),f.getMonth(),f.getDate());if(e==="hari-ini")g=k.getTime()===n.getTime();else if(e==="minggu-ini"){const w=new Date(n);w.setDate(n.getDate()-n.getDay());const $=new Date(w);$.setDate(w.getDate()+6),g=f>=w&&f<=$}else e==="bulan-ini"&&(g=f.getMonth()===n.getMonth()&&f.getFullYear()===n.getFullYear())}const p=!a||d===a,h=!t||c.toLowerCase().includes(t.toLowerCase());return u&&g&&p&&h});console.log("Data setelah filter:",o),De=o,ya=1,Mc(o),Ot()}catch(i){document.getElementById("detailTableContainer").innerHTML=`<p style="color: red;">Error loading data: ${i.message}</p>`,document.getElementById("detailPagination").innerHTML=""}}function Mc(e){const a={total:e.length,terjadwal:e.filter(t=>t.status_pengangkutan==="terjadwal").length,dalam_proses:e.filter(t=>t.status_pengangkutan==="dalam_proses").length,selesai:e.filter(t=>t.status_pengangkutan==="selesai").length,dibatalkan:e.filter(t=>t.status_pengangkutan==="dibatalkan").length};document.querySelector("#statsOverview div:nth-child(1) div:first-child").textContent=a.total,document.querySelector("#statsOverview div:nth-child(2) div:first-child").textContent=a.dalam_proses,document.querySelector("#statsOverview div:nth-child(3) div:first-child").textContent=a.selesai,document.querySelector("#statsOverview div:nth-child(4) div:first-child").textContent=a.dibatalkan}function Ot(){const e=document.getElementById("detailTableContainer"),a=document.getElementById("detailPagination");if(!e)return;const t=De.length,i=Math.ceil(t/Ea);ya>i&&i>0&&(ya=i),t===0&&(ya=1);const s=(ya-1)*Ea,n=Math.min(s+Ea,t),o=De.slice(s,n),l=t>0?s+1:0,r=n;if(!o||o.length===0){e.innerHTML=`
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 48px; color: #6c757d; margin-bottom: 15px;">ðŸ“­</div>
                <h3 style="color: #6c757d;">Tidak ada jadwal</h3>
                <p style="color: #6c757d;">Tidak ada jadwal pengangkutan yang ditugaskan ke tim Anda (${Je}).</p>
            </div>
        `,a.innerHTML="";return}const c=`
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                <thead>
                    <tr style="background: #f2f2f2;">
                        <th style="padding: 10px; border: 1px solid #ddd;">No</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Tanggal</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Anggota</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Nama Tim</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Catatan</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Detail</th>
                    </tr>
                </thead>
                <tbody>
                    ${o.map((d,m)=>{const u=d.id||"N/A",g=d.tanggal_jadwal||"",p=d.nama_anggota||"Anggota",h=d.nama_tim||"N/A";let f=g;try{const y=new Date(g);if(!isNaN(y)){f=y.toLocaleDateString("id-ID",{weekday:"short",year:"numeric",month:"short",day:"numeric"});const A=new Date;y.toDateString()===A.toDateString()&&(f=`<span style="background: #ff5722; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold;">HARI INI</span><br>${f}`)}}catch{}const k=d.catatan||"",w=k?k.substring(0,30)+(k.length>30?"...":""):'<span style="color: #999; font-style: italic;">Tidak ada catatan</span>',$=`
                            <button onclick="viewDetailTimAngkut(${u})" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="bi bi-info-circle"></i> Detail
                            </button>
                        `;return`
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s+m+1}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; min-width: 120px;">
                                ${f}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <div>
                                    <strong>${p}</strong><br>
                                    <small style="color: #666;">ID: ${d.idAnggota||"N/A"}</small>
                                </div>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                <span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                    ${h}
                                </span>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                ${io(d.status_pengangkutan)}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; max-width: 150px; font-size: 13px;">
                                ${w}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                ${$}
                            </td>
                        </tr>
                        `}).join("")}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; color: #666;">
            <strong>Menampilkan ${l} - ${r} dari ${t} jadwal</strong> â€¢ 
            Terjadwal: ${De.filter(d=>d.status_pengangkutan==="terjadwal").length} â€¢ 
            Dalam Proses: ${De.filter(d=>d.status_pengangkutan==="dalam_proses").length} â€¢ 
            Selesai: ${De.filter(d=>d.status_pengangkutan==="selesai").length}
        </div>
    `;e.innerHTML=c,Ic(i,l,r,t),window.viewDetailTimAngkut=Pc}function Ic(e,a,t,i){const s=document.getElementById("detailPagination");if(e<=1){s.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <small class="text-muted">
                    Menampilkan ${a} - ${t} dari ${i} jadwal
                </small>
                <select id="detailPerPageSelect" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="10" ${Ea===10?"selected":""}>10 per halaman</option>
                    <option value="20" ${Ea===20?"selected":""}>20 per halaman</option>
                    <option value="50" ${Ea===50?"selected":""}>50 per halaman</option>
                    <option value="100" ${Ea===100?"selected":""}>100 per halaman</option>
                </select>
            </div>
        `;const c=document.getElementById("detailPerPageSelect");c&&(c.onchange=function(){Ea=parseInt(this.value),ya=1,Ot()});return}let n=Math.max(1,ya-2),o=Math.min(e,n+4);o-n<4&&(n=Math.max(1,o-4));let l=`
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div>
                <small style="color: #666;">
                    Menampilkan ${a} - ${t} dari ${i} | 
                    Halaman ${ya} dari ${e}
                </small>
            </div>
            
            <div style="display: flex; gap: 5px;">
    `;ya>1?l+=`
            <button onclick="changeDetailPage(${ya-1})" 
                    style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">
                â†
            </button>
        `:l+=`
            <button disabled style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: not-allowed; border-radius: 4px; color: #999;">
                â†
            </button>
        `;for(let c=n;c<=o;c++)c===ya?l+=`
                <button style="padding: 5px 10px; border: 1px solid #ddd; background: #007bff; color: white; cursor: default; border-radius: 4px;">
                    ${c}
                </button>
            `:l+=`
                <button onclick="changeDetailPage(${c})" 
                        style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">
                    ${c}
                </button>
            `;ya<e?l+=`
            <button onclick="changeDetailPage(${ya+1})" 
                    style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">
                â†’
            </button>
        `:l+=`
            <button disabled style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: not-allowed; border-radius: 4px; color: #999;">
                â†’
            </button>
        `,l+=`
            </div>
            
            <div>
                <select id="detailPerPageSelect" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="10" ${Ea===10?"selected":""}>10 per halaman</option>
                    <option value="20" ${Ea===20?"selected":""}>20 per halaman</option>
                    <option value="50" ${Ea===50?"selected":""}>50 per halaman</option>
                    <option value="100" ${Ea===100?"selected":""}>100 per halaman</option>
                </select>
            </div>
        </div>
    `,s.innerHTML=l;const r=document.getElementById("detailPerPageSelect");r&&(r.onchange=function(){Ea=parseInt(this.value),ya=1,Ot()})}window.changeDetailPage=function(e){if(e<1||e>Math.ceil(De.length/Ea))return;ya=e;const a=document.getElementById("detailTableContainer");a&&a.scrollIntoView({behavior:"smooth",block:"start"}),Ot()};function io(e){const t={terjadwal:{color:"#17a2b8",label:"Terjadwal",icon:"ðŸ“…"},dalam_proses:{color:"#ffc107",label:"Dalam Proses",icon:"ðŸšš"},selesai:{color:"#28a745",label:"Selesai",icon:"âœ…"},dibatalkan:{color:"#dc3545",label:"Dibatalkan",icon:"âŒ"}}[e]||{color:"#6c757d",label:e,icon:"â“"};return`
        <span style="
            padding: 4px 10px;
            border-radius: 20px;
            background: ${t.color};
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        ">
            ${t.icon} ${t.label}
        </span>
    `}async function Pc(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()});let t=null;if(a.idAnggota)try{t=await M(`${b.anggota}${a.idAnggota}/`,{headers:v()})}catch(s){console.warn("Tidak bisa fetch detail anggota:",s)}const i=`
            <div>
                <h3>ðŸ“‹ Detail Pengangkutan</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #555;">ID:</div>
                        <div>${a.id||"N/A"}</div>
                        
                        <div style="font-weight: 600; color: #555;">Nama Tim:</div>
                        <div>
                            <span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px;">
                                ${a.nama_tim||"N/A"}
                            </span>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Status:</div>
                        <div>
                            ${io(a.status_pengangkutan)}
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Tanggal:</div>
                        <div>
                            <strong>${a.tanggal_jadwal||"N/A"}</strong>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Anggota:</div>
                        <div>
                            <strong>${a.nama_anggota||(t==null?void 0:t.nama)||"N/A"}</strong><br>
                            <small>${(t==null?void 0:t.alamat)||"Alamat tidak tersedia"}</small>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Kontak:</div>
                        <div>
                            <small>Telp/WA: ${(t==null?void 0:t.noWA)||"Tidak tersedia"}</small>
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Catatan:</div>
                        <div style="white-space: pre-wrap; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; min-height: 60px;">
                            ${a.catatan||'<span style="color: #999; font-style: italic;">Tidak ada catatan</span>'}
                        </div>
                        
                        <div style="font-weight: 600; color: #555;">Dibuat:</div>
                        <div>${a.created_at?new Date(a.created_at).toLocaleString("id-ID"):"N/A"}</div>
                    </div>
                </div>
            </div>
        `;Bc("Detail Pengangkutan",i)}catch(a){alert("Error loading detail: "+a.message)}}window.detailAnggotaJadwalTimAngkutPage=to;window.changeDetailPage=changeDetailPage;function Cc(e,a,t="",i=""){const s="routeMapModal";let n=document.getElementById(s);if(!n)n=document.createElement("div"),n.id=s,n.className="modal fade",n.setAttribute("tabindex","-1"),n.setAttribute("aria-labelledby","routeMapModalLabel"),n.setAttribute("aria-hidden","true"),n.innerHTML=`
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="routeMapModalLabel">
                            <i class="bi bi-map me-2"></i>Peta Lokasi & Rute
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="container-fluid">
                            <div class="row">
                                <!-- Peta -->
                                <div class="col-md-8 p-0">
                                    <div id="routeMap" style="height: 800px;"></div>
                                </div>
                                
                                <!-- Panel Info -->
                                <div class="col-md-4 p-3">
                                    <h5 class="mb-3">${t||"Lokasi Anggota"}</h5>
                                    ${i?`<p class="text-muted mb-3">${i}</p>`:""}
                                    
                                    <div class="mb-4">
                                        <h6><i class="bi bi-geo-alt me-2"></i>Koordinat</h6>
                                        <p class="mb-1">Latitude: ${e}</p>
                                        <p>Longitude: ${a}</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6><i class="bi bi-info-circle me-2"></i>Kontrol Peta</h6>
                                        <div class="d-grid gap-2">
                                            <button id="getUserLocation" class="btn btn-primary btn-sm">
                                                <i class="bi bi-geo me-2"></i>Lokasi Saya
                                            </button>
                                            <button id="showRoute" class="btn btn-success btn-sm" disabled>
                                                <i class="bi bi-signpost me-2"></i>Tampilkan Rute
                                            </button>
                                            <button id="resetMapView" class="btn btn-secondary btn-sm">
                                                <i class="bi bi-arrow-clockwise me-2"></i>Reset Peta
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="routeInfo" class="mt-3" style="display: none;">
                                        <h6><i class="bi bi-graph-up me-2"></i>Informasi Rute</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2 text-center">
                                                        <small class="text-muted">Jarak</small>
                                                        <h6 id="routeDistance">-</h6>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2 text-center">
                                                        <small class="text-muted">Waktu</small>
                                                        <h6 id="routeDuration">-</h6>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="locationStatus" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(n),new bootstrap.Modal(n).show(),n.addEventListener("hidden.bs.modal",function(){window.map&&(window.map.remove(),window.map=null),window.routeControl&&(window.routeControl.remove(),window.routeControl=null)});else{const o=bootstrap.Modal.getInstance(n);o?o.show():new bootstrap.Modal(n).show(),document.getElementById("routeMapModalLabel").innerHTML=`<i class="bi bi-map me-2"></i>${t||"Peta Lokasi & Rute"}`;const l=n.querySelector(".modal-body");if(l.querySelector("h5").textContent=t||"Lokasi Anggota",i){const r=l.querySelector("p.text-muted");r&&(r.textContent=i)}l.querySelector(".mb-1").textContent=`Latitude: ${e}`,l.querySelector(".mb-1 + p").textContent=`Longitude: ${a}`,document.getElementById("routeInfo").style.display="none",document.getElementById("locationStatus").innerHTML=""}Dc().then(()=>{setTimeout(()=>jc(e,a,t),100)}).catch(o=>{console.error("Failed to load Leaflet:",o),Nc("Gagal memuat peta. Silakan refresh halaman.","error")})}function Dc(){return new Promise((e,a)=>{if(window.L&&window.L.Routing){e();return}let t=0;const i=4;function s(){t++,t===i&&window.L&&window.L.Routing&&e()}const n=document.createElement("link");n.rel="stylesheet",n.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",n.onload=s,n.onerror=()=>{console.error("Failed to load Leaflet CSS"),s()},document.head.appendChild(n);const o=document.createElement("link");o.rel="stylesheet",o.href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css",o.onload=s,o.onerror=()=>{console.error("Failed to load Leaflet Routing Machine CSS"),s()},document.head.appendChild(o);const l=document.createElement("script");l.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",l.onload=s,l.onerror=()=>{console.error("Failed to load Leaflet JS"),a(new Error("Failed to load Leaflet"))},document.head.appendChild(l);const r=document.createElement("script");r.src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js",r.onload=s,r.onerror=()=>{console.error("Failed to load Leaflet Routing Machine JS"),a(new Error("Failed to load Leaflet Routing Machine"))},document.head.appendChild(r),setTimeout(()=>{window.L&&window.L.Routing?e():a(new Error("Timeout loading Leaflet assets"))},1e4)})}function Ss({leafColor:e="green",overlayIcon:a="bi-person-fill",overlayBg:t="rgba(0,0,0,0.6)",leafFilter:i="",size:s=[38,95]}={}){return L.divIcon({className:"leaf-marker",html:`
      <div style="position: relative; width: ${s[0]}px; height: ${s[1]}px;">
        
        <!-- Leaf image -->
        <img 
          src="../../../public/foto/leaf-${e}.png"
          style="
            width: 100%;
            height: 100%;
            display: block;
            ${i?`filter: ${i};`:""}
          "
        />

        <!-- Overlay icon -->
        <div style="
          position: absolute;
          top: 18px;
          left: 50%;
          transform: translateX(-50%);
          width: 26px;
          height: 26px;
          background: ${t};
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 14px;
          border: 2px solid white;
          box-shadow: 0 0 6px rgba(0,0,0,0.4);
        ">
          <i class="bi ${a}"></i>
        </div>
      </div>
    `,iconSize:s,iconAnchor:[s[0]/2,s[1]-1],popupAnchor:[0,-s[1]+20],shadowUrl:"../../../public/foto/leaf-silver.png",shadowSize:[50,64],shadowAnchor:[4,62]})}function jc(e,a,t){if(!window.L){console.error("Leaflet not loaded");return}window.map&&window.map.remove();const i=L.map("routeMap").setView([e,a],15);window.map=i,L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(i);const s=Ss({leafColor:"red",overlayIcon:"bi-person-fill"});L.marker([e,a],{icon:s}).addTo(i).bindPopup(`<strong>${t||"Lokasi Anggota"}</strong><br>Lat: ${e}<br>Lng: ${a}`),window.userLocation=null,window.routeControl=null,window.userMarker=null;const n=document.getElementById("getUserLocation"),o=document.getElementById("showRoute"),l=document.getElementById("resetMapView"),r=document.getElementById("locationStatus"),c=document.getElementById("routeInfo"),d=document.getElementById("routeDistance"),m=document.getElementById("routeDuration");function u(){if(r.innerHTML='<div class="alert alert-info"><i class="bi bi-hourglass-split me-2"></i>Mendapatkan lokasi Anda...</div>',!navigator.geolocation){r.innerHTML='<div class="alert alert-danger">Browser tidak mendukung geolokasi</div>';return}navigator.geolocation.getCurrentPosition(function(h){window.userLocation={lat:h.coords.latitude,lng:h.coords.longitude},window.userMarker&&i.removeLayer(window.userMarker);const f=Ss({leafColor:"green",overlayIcon:"bi-geo-alt-fill",overlayBg:"rgba(13,110,253,0.9)",leafFilter:"hue-rotate(185deg) brightness(0.9)"});window.userMarker=L.marker([window.userLocation.lat,window.userLocation.lng],{icon:f}).addTo(i).bindPopup("<strong>Lokasi Anda</strong>"),r.innerHTML='<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Lokasi berhasil didapatkan!</div>',o.disabled=!1;const k=L.latLngBounds([window.userLocation.lat,window.userLocation.lng],[e,a]);i.fitBounds(k,{padding:[50,50]})},function(h){let f="Gagal mendapatkan lokasi: ";switch(h.code){case h.PERMISSION_DENIED:f+="Izin ditolak. Izinkan akses lokasi di pengaturan browser.";break;case h.POSITION_UNAVAILABLE:f+="Informasi lokasi tidak tersedia.";break;case h.TIMEOUT:f+="Waktu permintaan habis.";break;default:f+="Terjadi kesalahan."}r.innerHTML=`<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>${f}</div>`},{enableHighAccuracy:!0,timeout:3e4,maximumAge:0})}function g(){if(!window.userLocation){r.innerHTML='<div class="alert alert-warning">Harap dapatkan lokasi Anda terlebih dahulu</div>';return}if(!L.Routing){r.innerHTML='<div class="alert alert-danger">Fitur rute tidak tersedia. Silakan refresh halaman.</div>';return}window.routeControl&&i.removeControl(window.routeControl),c.style.display="block";try{window.routeControl=L.Routing.control({waypoints:[L.latLng(window.userLocation.lat,window.userLocation.lng),L.latLng(e,a)],routeWhileDragging:!1,showAlternatives:!1,lineOptions:{styles:[{color:"#0d6efd",opacity:.7,weight:5}]},createMarker:function(){return null},addWaypoints:!1,show:!1}).addTo(i),window.routeControl.on("routesfound",function(h){const f=h.routes;if(f&&f.length>0){const k=f[0].summary;let w=k.totalDistance/1e3;w=w<1?Math.round(k.totalDistance)+" m":w.toFixed(2)+" km";const $=Math.round(k.totalTime/60),y=Math.floor($/60),A=$%60;let E="";y>0?E=`${y} jam ${A} menit`:E=`${$} menit`,d.textContent=w,m.textContent=E}}),window.routeControl.on("routingerror",function(h){console.error("Routing error:",h.error),r.innerHTML='<div class="alert alert-warning">Tidak dapat menghitung rute. Coba lagi.</div>'})}catch(h){console.error("Error creating route:",h),r.innerHTML='<div class="alert alert-danger">Gagal membuat rute. Coba refresh halaman.</div>'}}function p(){if(!i||!i._container){console.warn("Map sudah tidak tersedia, reset dibatalkan");return}window.routeControl&&(i.removeControl(window.routeControl),window.routeControl=null),window.userMarker&&(i.removeLayer(window.userMarker),window.userMarker=null),i.setView([e,a],15),c.style.display="none",o.disabled=!0,r.innerHTML="",window.userLocation=null}n.addEventListener("click",u),o.addEventListener("click",g),l.addEventListener("click",p)}function Nc(e,a="info"){console.log(`${a}: ${e}`)}let Ya=[],As,Ca;async function _c(){const e=localStorage.getItem("user");if(!e){window.location.href="#/login";return}if(As=JSON.parse(e),Ca=As.username,!Ca){console.error("User not found in localStorage");return}const a=document.getElementById("mainContent");a.innerHTML=`
    <!-- Tambahkan di head atau sebelum script utama -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"><\/script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
    .marker-blue {
      filter: hue-rotate(200deg) saturate(150%);
    }
    </style>
    <div class="detail-tim-container">
      <div class="header-section">
        <h2><i class="bi bi-truck"></i> Jadwal Pengangkutan Tim ${Ca}</h2>
        <div class="filter-section">
          <div class="input-group">
            <span class="input-group-text bg-light">
              <i class="bi bi-calendar-event text-success"></i>
            </span>
            <input type="date" id="filterDate" class="form-control" 
                   placeholder="Filter tanggal jadwal">
          </div>
          <select id="filterStatus" class="form-select">
            <option value="">Semua Status</option>
            <option value="terjadwal">Terjadwal</option>
            <option value="dalam_proses">Dalam Proses</option>
            <option value="selesai">Selesai</option>
            <option value="dibatalkan">Dibatalkan</option>
          </select>
          <button id="resetFilter" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-clockwise"></i> Reset
          </button>
        </div>
      </div>
      
      <div id="detailContainer">
        <div class="text-center py-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Memuat data pengangkutan...</p>
        </div>
      </div>
    </div>
    
    <style>
      .detail-tim-container {
        padding: 20px;
      }
      
      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .header-section h2 {
        color: #2c3e50;
        margin: 0;
        font-weight: 600;
      }
      
      .filter-section {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      
      .input-group {
        width: 180px;
      }
      
      .detail-table {
        width: 100%;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      
      .table-header {
        background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .table-body {
        max-height: 600px;
        overflow-y: auto;
      }
      
      .detail-row {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1.5fr 1fr 1.5fr 1.5fr;
        gap: 12px;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        align-items: center;
        transition: background-color 0.2s;
      }
      
      .detail-row:hover {
        background-color: #f8f9fa;
      }
      
      .detail-row:last-child {
        border-bottom: none;
      }
      
      .anggota-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .anggota-name {
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }
      
      .anggota-actions {
        display: flex;
        gap: 6px;
        margin-top: 4px;
      }
      
      .anggota-action-btn {
        padding: 3px 8px;
        font-size: 0.7rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
      }
      
      .anggota-action-btn.member {
        background: #20c997;
        color: white;
      }
      
      .anggota-action-btn.member:hover {
        background: #17a2b8;
        transform: translateY(-1px);
      }
      
      .anggota-action-btn.map {
        background: #6f42c1;
        color: white;
      }
      
      .anggota-action-btn.map:hover {
        background: #5a32a3;
        transform: translateY(-1px);
      }
      
      .anggota-wa {
        font-size: 0.8rem;
        color: #6c757d;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .jadwal-date {
        font-weight: 500;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .jadwal-date i {
        color: #20c997;
      }
      
      .address-text {
        color: #495057;
        font-size: 0.85rem;
        line-height: 1.4;
      }
      
      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .status-terjadwal {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      
      .status-dalam_proses {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      
      .status-selesai {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-dibatalkan {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .catatan-text {
        color: #6c757d;
        font-size: 0.85rem;
        max-height: 40px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
      
      .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
      }
      
      .action-btn.update {
        background: #ffc107;
        color: #212529;
      }
      
      .action-btn.update:hover {
        background: #e0a800;
        transform: translateY(-1px);
      }
      
      .action-btn.view {
        background: #17a2b8;
        color: white;
      }
      
      .action-btn.view:hover {
        background: #138496;
        transform: translateY(-1px);
      }
      
      .action-btn.location {
        background: #6f42c1;
        color: white;
      }
      
      .action-btn.location:hover {
        background: #5a32a3;
        transform: translateY(-1px);
      }
      
      .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }
      
      .no-data i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
      }
      
      /* Modal Styling untuk Detail */
      .detail-modal-content {
        max-width: 800px;
      }
      
      .coordinate-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      /* Tambahkan di bagian style */
      .marker-blue {
        filter: hue-rotate(200deg) saturate(150%) brightness(0.9);
      }

      .all-anggota-map-modal {
        min-width: 90vw;
      }
      
      @media (max-width: 1200px) {
        .detail-row {
          grid-template-columns: 1fr;
          gap: 15px;
          padding: 20px;
        }
        
        .anggota-actions {
          justify-content: flex-start;
        }
        
        .action-buttons {
          justify-content: flex-start;
        }
        
        .filter-section {
          flex-direction: column;
          width: 100%;
        }
        
        .input-group {
          width: 100%;
        }
        
        .form-select {
          width: 100%;
        }
        
        #resetFilter {
          width: 100%;
        }
      }
      
      @media (max-width: 768px) {
        .header-section {
          flex-direction: column;
          align-items: stretch;
        }
        
        .filter-section {
          width: 100%;
        }

        .all-anggota-map-modal {
          min-width: 70vw;
        }
      }
    </style>
  `;const t=ro();document.getElementById("filterDate").value=t,document.getElementById("filterStatus").addEventListener("change",Xa),document.getElementById("filterDate").addEventListener("change",Xa),document.getElementById("resetFilter").addEventListener("click",ts),Xa()}async function Xa(){var i,s;const e=((i=document.getElementById("filterStatus"))==null?void 0:i.value)||"",a=((s=document.getElementById("filterDate"))==null?void 0:s.value)||"",t=document.getElementById("detailContainer");t.innerHTML=`
    <div class="text-center py-5">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Memuat data pengangkutan...</p>
    </div>
  `;try{const n=await M(b.detailAnggotaJadwal,{headers:v()});console.log("Semua data jadwal:",n),console.log("Username yang login:",Ca);const o=await qc(),l=n.filter(r=>{const c=r.nama_tim||"",d=c===Ca;if(!d)return console.log(`Data ${r.id} tidak sesuai: nama_tim="${c}", username="${Ca}"`),!1;const m=!e||(r.status_pengangkutan||r.status)===e;let u=!0;if(a){const g=r.tanggalJadwal||r.tanggal_jadwal||r.tanggal||r.created_at;if(g)try{u=new Date(g).toISOString().split("T")[0]===a}catch(p){console.warn("Error parsing date:",g,p),u=!1}else u=!1}return d&&m&&u});console.log("Data setelah filter:",l),Ya=[],l.forEach(r=>{const c=r.idAnggota||r.anggotaId;if(c){const d=o.find(m=>m.id===c||m.idAnggota===c);d&&d.latitude&&d.longitude&&Ya.push({...d,status_pengangkutan:r.status_pengangkutan||r.status,tanggalJadwal:r.tanggalJadwal||r.tanggal_jadwal,catatan:r.catatan})}}),console.log("ðŸ“ Data untuk peta:",Ya.length,"anggota"),console.log("ðŸ” Detail data peta:",Ya),Hc(l)}catch(n){console.error("Error loading detail:",n),t.innerHTML=`
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Error loading detail: ${n.message}
      </div>
    `}}async function Fc(){var i;if(!Ya||Ya.length===0){ia("âš ï¸ Tidak ada lokasi anggota untuk ditampilkan","warning");return}const e=(i=document.getElementById("filterDate"))==null?void 0:i.value,a=e?new Date(e).toLocaleDateString("id-ID"):"Hari Ini",t=`
    <div class="all-anggota-map-modal" 
         style="width: 90vw; max-width: 1200px; height: 80vh; display: flex; flex-direction: column; padding: 20px; overflow: hidden;">
      <h5><i class="bi bi-geo-alt-fill me-2"></i>Peta Lokasi Anggota Tim ${Ca}</h5>
      <p class="text-muted" style="flex-shrink: 0;">
        <i class="bi bi-calendar me-1"></i> Jadwal: ${a} |
        <i class="bi bi-person me-1"></i> ${Ya.length} anggota |
        <i class="bi bi-building me-1"></i> Tim: ${Ca}
      </p>
      
      <div id="allMapContainer" style="
        flex: 1 1 auto;
        width: 100%; 
        border-radius: 8px; 
        border: 1px solid #dee2e6; 
        margin: 15px 0;
        min-height: 300px;
      ">
        <div class="text-center py-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Memuat peta semua lokasi...</p>
        </div>
      </div>
      
      <div class="row mt-3 flex-shrink-0 flex-wrap">
        <!-- Legenda -->
        <div class="col-12 col-md-6 mb-2 mb-md-0" style="max-width: 300px;">
          <div class="card bg-light h-100" style="font-size: 0.85rem;">
            <div class="card-body p-2">
              <h6 class="card-title mb-2" style="font-size: 0.9rem;">
                <i class="bi bi-info-circle text-primary me-2"></i>
                Legenda Peta
              </h6>
              <div class="d-flex align-items-center mb-2">
                <div style="width: 16px; height: 16px; background-color: #007bff; border-radius: 50%; margin-right: 8px;"></div>
                <small>Anggota (${Ya.length})</small>
              </div>
              <div class="d-flex align-items-center">
                <div style="width: 16px; height: 16px; background-color: #28a745; border-radius: 50%; margin-right: 8px;"></div>
                <small>Tim Angkut (GPS saat ini)</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;P(`Peta ${Ya.length} Lokasi Anggota Tim ${Ca}`,t),setTimeout(()=>{so()},300)}async function so(){try{window.L||await Wc();const e=document.getElementById("allMapContainer");if(!e)return;const a=window.currentModalElement;if(a){const s=a.querySelector(".modal-dialog");s&&(s.style.maxWidth="70vw",s.style.width="70vw",s.style.height="150vh",s.style.margin="5vh auto");const n=a.querySelector(".modal-content");n&&(n.style.height="70%",n.style.display="flex",n.style.flexDirection="column")}e.style.flex="1 1 auto",e.style.width="72%",e.style.height="75%",e.style.minHeight="300px",e.style.margin="0",e.style.borderRadius="8px",e.style.border="1px solid #dee2e6";const t=L.latLngBounds([]),i=L.map("allMapContainer");L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(i),Ya.forEach(s=>{const n=parseFloat(s.latitude),o=parseFloat(s.longitude);!isNaN(n)&&!isNaN(o)&&(L.marker([n,o],{icon:L.icon({iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png",iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",iconSize:[35,55],iconAnchor:[17,55],popupAnchor:[1,-45],shadowSize:[55,55]})}).addTo(i).bindPopup(`
          <b>ðŸ“ ${s.nama_anggota||s.nama||"Anggota"}</b><br>
          <small>${s.alamat||s.address||""}</small><br>
          <small>Status: ${es(s.status_pengangkutan||s.status)}</small>
        `),t.extend([n,o]))});try{const s=await Yc(1e4),n=L.icon({iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png",iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",iconSize:[35,55],iconAnchor:[17,55],popupAnchor:[1,-45],shadowSize:[55,55],className:"marker-blue"});L.marker([s.latitude,s.longitude],{icon:n}).addTo(i).bindPopup(`<b>ðŸš› Lokasi Tim ${Ca}</b><br><small>GPS Real-time</small>`),t.extend([s.latitude,s.longitude])}catch(s){console.warn("GPS Tim Angkut tidak tersedia:",s)}t.isValid()?i.fitBounds(t,{padding:[50,50]}):i.setView([-6.2,106.8],10),setTimeout(()=>i.invalidateSize(),300),L.control.zoom({position:"topright"}).addTo(i),L.control.scale().addTo(i),window.recenterMap=function(){t.isValid()&&i.fitBounds(t,{padding:[50,50]})},window.printMap=function(){window.print()}}catch(e){console.error("Error loading all anggota map:",e);const a=document.getElementById("allMapContainer");a&&(a.innerHTML=`<div class="alert alert-danger m-3">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Gagal memuat peta: ${e.message}
      </div>`)}}function Hc(e){const a=document.getElementById("detailContainer");if(!e||e.length===0){a.innerHTML=`
      <div class="no-data">
        <i class="bi bi-calendar-x"></i>
        <h4>Tidak ada data pengangkutan</h4>
        <p class="text-muted">Tidak ada jadwal pengangkutan untuk tim Anda (${Ca}) pada tanggal yang dipilih.</p>
        <button onclick="resetFilter()" class="btn btn-outline-success mt-2">
          <i class="bi bi-arrow-clockwise"></i> Reset Filter
        </button>
      </div>
    `;return}const t=`
  <div class="card border-light shadow-sm mb-3">
    <div class="card-body py-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0 text-success">
            <i class="bi bi-list-task me-2"></i>Jadwal Pengangkutan Tim ${Ca}
          </h5>
          <small class="text-muted">${e.length} data ditemukan</small>
        </div>
        <div class="text-end">
          <!-- Tombol Peta All Anggota -->
          <button onclick="showAllAnggotaMap()" 
                  class="btn btn-primary btn-sm me-2">
            <i class="bi bi-map me-1"></i> Lihat Peta Semua Lokasi
          </button>
          <div class="badge bg-light text-dark">
            <i class="bi bi-calendar me-1"></i>
            ${document.getElementById("filterDate").value||"Semua tanggal"}
          </div>
        </div>
      </div>
      
      <!-- Column Headers -->
      <div class="row mt-3 border-bottom pb-2 text-muted small fw-bold d-none d-md-flex">
        <div class="col-md-2">
          <i class="bi bi-person me-1"></i> Info Diri
        </div>
        <div class="col-md-2">
          <i class="bi bi-calendar-check me-1"></i> Jadwal
        </div>
        <div class="col-md-2">
          <i class="bi bi-calendar-plus me-1"></i> Dibuat
        </div>
        <div class="col-md-2">
          <i class="bi bi-flag me-1"></i> Status
        </div>
        <div class="col-md-2">
          <i class="bi bi-chat-text me-1"></i> Catatan
        </div>
        <div class="col-md-2">
          <i class="bi bi-gear me-1"></i> Aksi
        </div>
      </div>
    </div>
  </div>
`,i=e.map(s=>{const n=s.tanggalJadwal||s.tanggal_jadwal||s.tanggal||s.created_at,o=me(n),l=me(s.created_at),r=s.status_pengangkutan||s.status||"terjadwal",c=Uc(r),d=es(r),m=s.idAnggota||s.anggotaId,u=s.nama_anggota||s.nama||"Anggota";s.latitude&&s.longitude;const g=s.alamat||s.address||"Alamat tidak tersedia";return`
    <div class="card border-light shadow-sm mb-2">
      <div class="card-body py-2">
        <!-- Desktop View (6 kolom) -->
        <div class="row align-items-center d-none d-md-flex">
          <!-- Kolom 1: Info Diri -->
          <div class="col-md-2">
            <div class="fw-bold">${u}</div>
            <div class="mt-1">
              ${m?`
                <button onclick="viewAnggotaDetail('${m}')" 
                        class="btn btn-sm btn-outline-secondary btn-xs">
                  <i class="bi bi-person"></i>
                </button>
              `:""}
            </div>
          </div>
          
          <!-- Kolom 2: Jadwal Pengangkutan -->
          <div class="col-md-2">
            <div class="text-muted small">
              <i class="bi bi-calendar-check me-1"></i>
              ${o}
            </div>
          </div>
          
          <!-- Kolom 3: Tanggal Dibuat -->
          <div class="col-md-2">
            <div class="text-muted small">
              <i class="bi bi-calendar-plus me-1"></i>
              ${l||"-"}
            </div>
          </div>
          
          <!-- Kolom 4: Status -->
          <div class="col-md-2">
            <span class="badge ${c}">
              ${d}
            </span>
          </div>
          
          <!-- Kolom 5: Catatan -->
          <div class="col-md-2">
            <div class="small text-truncate" title="${s.catatan||s.note||s.notes||""}">
              ${s.catatan||s.note||s.notes||"-"}
            </div>
          </div>
          
          <!-- Kolom 6: Aksi -->
          <div class="col-md-2">
            <div class="d-flex gap-1 flex-wrap">
              ${r==="terjadwal"?`
                <button onclick="mulaiPengangkutan('${s.id}')" 
                        class="btn btn-success btn-sm btn-xs" title="Mulai">
                  <i class="bi bi-play-circle"></i>
                </button>
              `:""}

              ${r==="dalam_proses"?`
                <button onclick="selesaikanPengangkutan('${s.id}')" 
                        class="btn btn-primary btn-sm btn-xs" title="Selesai">
                  <i class="bi bi-check-circle"></i>
                </button>
              `:""}

              ${r==="terjadwal"||r==="dalam_proses"?`
                <button onclick="batalkanPengangkutan('${s.id}')" 
                        class="btn btn-danger btn-sm btn-xs" title="Batalkan">
                  <i class="bi bi-x-circle"></i>
                </button>
              `:""}

              ${r==="selesai"?`
                <button onclick="ubahStatusPengangkutan('${s.id}')" 
                        class="btn btn-warning btn-sm btn-xs" title="Ubah Status">
                  <i class="bi bi-arrow-repeat"></i>
                </button>
              `:""}
              
              <button onclick="editCatatan('${s.id}')" 
                      class="btn btn-info btn-sm btn-xs" title="Catatan">
                <i class="bi bi-pencil"></i>
              </button>
              
              <button onclick="viewDetailTim('${s.id}')" 
                      class="btn btn-secondary btn-sm btn-xs" title="Detail">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Mobile View (card layout) -->
        <div class="d-block d-md-none">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div class="fw-bold">${u}</div>
              <div class="small text-muted">
                <i class="bi bi-calendar-check me-1"></i> ${o}
              </div>
            </div>
            <span class="badge ${c}">
              ${d}
            </span>
          </div>
          
          <div class="small text-muted mb-2">
            <i class="bi bi-geo-alt me-1"></i>
            ${g.substring(0,60)}${g.length>60?"...":""}
          </div>
          
          <div class="small mb-2">
            <i class="bi bi-chat-text me-1"></i>
            ${s.catatan||s.note||s.notes||"-"}
          </div>
          
          <div class="d-flex flex-wrap gap-1">
            ${r==="terjadwal"?`
              <button onclick="mulaiPengangkutan('${s.id}')" 
                      class="btn btn-success btn-sm">
                ðŸšš Mulai
              </button>
            `:""}

            ${r==="dalam_proses"?`
              <button onclick="selesaikanPengangkutan('${s.id}')" 
                      class="btn btn-primary btn-sm">
                âœ… Selesai
              </button>
            `:""}

            ${r==="terjadwal"||r==="dalam_proses"?`
              <button onclick="batalkanPengangkutan('${s.id}')" 
                      class="btn btn-danger btn-sm">
                âŒ Batalkan
              </button>
            `:""}
            
            <button onclick="editCatatan('${s.id}')" 
                    class="btn btn-info btn-sm">
              ðŸ“ Catatan
            </button>
            
            <button onclick="viewDetailTim('${s.id}')" 
                    class="btn btn-secondary btn-sm">
              <i class="bi bi-eye"></i>
            </button>
            
            ${m?`
              <button onclick="viewAnggotaDetail('${m}')" 
                      class="btn btn-outline-warning btn-sm">
                <i class="bi bi-person"></i>
              </button>
            `:""}
          </div>
        </div>
      </div>
    </div>
  `}).join("");a.innerHTML=`
    <div class="detail-table">
      ${t}
      <div class="table-body">
        ${i}
      </div>
      <div id="inlineDetailContainer" class="mt-3"></div>
    </div>
  `,window.updateDetailStatus=no,window.viewDetailTim=oo,window.viewAnggotaDetail=lo,window.resetFilter=ts}function Uc(e){return{terjadwal:"bg-warning text-dark",dalam_proses:"bg-info text-white",selesai:"bg-success text-white",dibatalkan:"bg-danger text-white"}[e.toLowerCase()]||"bg-secondary text-white"}async function Gc(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()}),t=`
      <div id="validationMessageContainer"></div>
      
      <div class="alert alert-info">
        <div class="d-flex align-items-center">
          <i class="bi bi-info-circle-fill fs-4 me-3"></i>
          <div>
            <strong class="d-block">Ubah Status Pengangkutan</strong>
            <small class="text-muted">Mengubah status dari "${a.status_pengangkutan}" ke status baru</small>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">
          <strong>Status Baru</strong>
          <small class="text-muted">Pilih status yang sesuai</small>
        </label>
        <select id="statusBaru" class="form-select">
          <option value="terjadwal" ${a.status_pengangkutan==="terjadwal"?"selected":""}>
            Terjadwal
          </option>
          <option value="dalam_proses" ${a.status_pengangkutan==="dalam_proses"?"selected":""}>
            Dalam Proses
          </option>
          <option value="selesai" ${a.status_pengangkutan==="selesai"?"selected":""}>
            Selesai
          </option>
          <option value="dibatalkan" ${a.status_pengangkutan==="dibatalkan"?"selected":""}>
            Dibatalkan
          </option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">
          <strong>Alasan Perubahan</strong>
          <small class="text-muted">Wajib diisi untuk alasan perubahan status</small>
        </label>
        <textarea 
          id="alasanPerubahan" 
          class="form-control" 
          rows="4"
          placeholder="Ketikkan alasan mengubah status (contoh: salah tekan, ada perubahan jadwal, dll.)"
          required></textarea>
        <div class="invalid-feedback">
          Alasan perubahan wajib diisi minimal 10 karakter.
        </div>
      </div>
      
      <div class="card border-light bg-light">
        <div class="card-body p-3">
          <h6 class="card-title mb-2">
            <i class="bi bi-info-circle text-primary me-2"></i>
            Detail Saat Ini
          </h6>
          <div class="row small text-muted">
            <div class="col-md-6">
              <div><strong>ID:</strong> ${a.id}</div>
              <div><strong>Anggota:</strong> ${a.nama_anggota||a.nama||"N/A"}</div>
            </div>
            <div class="col-md-6">
              <div><strong>Status:</strong> ${a.status_pengangkutan}</div>
              <div><strong>Tanggal:</strong> ${me(a.tanggal_jadwal||a.tanggalJadwal)}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="alert alert-warning mt-3">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Perhatian:</strong> Perubahan status akan tercatat dalam catatan.
      </div>
    `;let i;P("Ubah Status Pengangkutan",t,async()=>{var d,m;const n=document.querySelector("#validationMessageContainer");n&&(n.innerHTML="");const o=(d=document.getElementById("statusBaru"))==null?void 0:d.value,l=((m=document.getElementById("alasanPerubahan"))==null?void 0:m.value.trim())||"",r=document.getElementById("alasanPerubahan");if(!l||l.length<10){const u=a.status_pengangkutan;if(o===u&&!l)return n&&(n.innerHTML=`
              <div class="alert alert-warning fade show">
                <div class="d-flex align-items-center">
                  <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                  <div>
                    <strong class="d-block">Tidak ada perubahan</strong>
                    <small class="text-muted">
                      Anda belum mengubah status dan belum mengisi alasan.
                    </small>
                  </div>
                </div>
              </div>
            `,n.scrollIntoView({behavior:"smooth",block:"center"})),!1;if(o===u)return n&&(n.innerHTML=`
              <div class="alert alert-warning fade show">
                <div class="d-flex align-items-center">
                  <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                  <div>
                    <strong class="d-block">Status tidak berubah</strong>
                    <small class="text-muted">
                      Pilih status yang berbeda atau klik Batal.
                    </small>
                  </div>
                </div>
              </div>
            `,n.scrollIntoView({behavior:"smooth",block:"center"})),!1;if(l.length<10)return r&&(r.classList.add("is-invalid"),r.focus()),n&&(n.innerHTML=`
              <div class="alert alert-danger fade show">
                <div class="d-flex align-items-center">
                  <i class="bi bi-x-circle-fill fs-4 me-3"></i>
                  <div>
                    <strong class="d-block">Alasan terlalu singkat</strong>
                    <small class="text-muted">
                      Minimal 10 karakter untuk alasan perubahan status.
                    </small>
                  </div>
                </div>
              </div>
            `,n.scrollIntoView({behavior:"smooth",block:"center"})),!1;r&&r.classList.remove("is-invalid")}if(o===a.status_pengangkutan)return n&&(n.innerHTML=`
            <div class="alert alert-warning fade show">
              <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                <div>
                  <strong class="d-block">Status tidak berubah!</strong>
                  <small class="text-muted">Status baru sama dengan status saat ini. Pilih status yang berbeda atau batalkan.</small>
                </div>
              </div>
            </div>
          `,n.scrollIntoView({behavior:"smooth",block:"center"})),!1;const c=document.querySelector(".modal-body")||document.querySelector('[style*="padding: 20px"]');if(c){const u=c.innerHTML;c.innerHTML=`
          <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Mengubah status...</h5>
            <p class="text-muted">Mohon tunggu sebentar</p>
          </div>
        `;try{const p=`ðŸ”„ [Perubahan Status] ${new Date().toLocaleString("id-ID")}:
- Dari: ${a.status_pengangkutan}
- Ke: ${o}
- Alasan: ${l}`,h=a.catatan?`${a.catatan}

${p}`:p;return await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({status_pengangkutan:o,catatan:h})}),alert(`Status telah diubah menjadi: ${o}`),c.innerHTML=`
            <div class="text-center py-5">
              <div class="mb-3" style="font-size: 4rem; color: #28a745;">
                <i class="bi bi-check-circle-fill"></i>
              </div>
              <h4 class="text-success">âœ… Status Diubah!</h4>
              <p class="text-muted">Status telah diubah menjadi "${o}"</p>
              <div class="alert alert-success mt-4">
                <i class="bi bi-info-circle me-2"></i>
                Halaman akan diperbarui...
              </div>
            </div>
          `,setTimeout(()=>{Xa(),i&&i.close&&i.close()},1500),!0}catch(g){return console.error("Error changing status:",g),c.innerHTML=u,n&&(n.innerHTML=`
              <div class="alert alert-danger fade show">
                <div class="d-flex align-items-center">
                  <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                  <div>
                    <strong class="d-block">Gagal mengubah status!</strong>
                    <small class="text-muted">${g.message}</small>
                  </div>
                </div>
              </div>
            `),!1}}return!1},"Ya, Ubah Status","Batal");const s=document.querySelectorAll('[style*="position: fixed; top: 0; left: 0; width: 100%"]');s.length>0&&(i={element:s[s.length-1],close:()=>{const n=s[s.length-1];n&&n.parentNode&&n.parentNode.removeChild(n)}})}catch(a){console.error("Error loading detail:",a),typeof ia=="function"?ia(`âŒ Gagal memuat data: ${a.message}`,"error"):alert(`âŒ Gagal memuat data: ${a.message}`)}}async function Jc(e){P("Mulai Pengangkutan","<p>Yakin ingin <strong>memulai pengangkutan</strong> ini?</p>",async()=>{await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({status_pengangkutan:"dalam_proses"})}),ia("ðŸšš Pengangkutan dimulai","success"),alert("ðŸšš Pengangkutan dimulai"),Xa()})}async function Rc(e){const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()});P("Selesaikan Pengangkutan",`
      <div class="alert alert-warning">
        âš ï¸ Pastikan pengangkutan sudah selesai
      </div>

      <label class="form-label">Catatan Pengangkutan</label>
      <textarea id="catatanSelesai" class="form-control"
        placeholder="Contoh: Sampah sudah diangkut seluruhnya"></textarea>
    `,async()=>{const t=document.getElementById("catatanSelesai").value,i=a.catatan?a.catatan+`
- `+t:t;await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({status_pengangkutan:"selesai",catatan:i})}),ia("âœ… Pengangkutan selesai","success"),alert("âœ… Pengangkutan selesai"),Xa()})}async function zc(e){P("Batalkan Pengangkutan",`
      <div class="alert alert-danger">
        âŒ Pengangkutan akan dibatalkan
      </div>

      <label class="form-label">Alasan (Wajib)</label>
      <textarea id="catatanBatal" class="form-control"
        placeholder="Contoh: Lokasi tidak dapat diakses" required></textarea>
    `,async()=>{const a=document.getElementById("catatanBatal").value;if(!a){ia("âš ï¸ Alasan wajib diisi","warning");return}await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({status_pengangkutan:"dibatalkan",catatan:a})}),ia("âŒ Pengangkutan dibatalkan","success"),alert("âŒ Pengangkutan dibatalkan"),Xa()})}async function Oc(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()});let t=!1;P("Tambah Catatan",`
        <div class="mb-3">
          <label class="form-label">
            Catatan
            <small class="text-muted">(akan ditambahkan ke catatan sebelumnya)</small>
          </label>
          <textarea 
            id="editCatatanText" 
            class="form-control" 
            rows="4"
            placeholder="Tulis catatan tambahan..."
            autofocus></textarea>
          <div id="catatanError" class="invalid-feedback" style="display: none;">
            Catatan tidak boleh kosong
          </div>
        </div>
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-1"></i>
          Catatan sebelumnya akan ditambahkan dengan format:
          <code>Catatan Lama + [Update: Catatan Baru]</code>
        </div>
      `,()=>{const i=document.getElementById("editCatatanText").value.trim(),s=document.getElementById("catatanError"),n=document.getElementById("editCatatanText");return s&&(s.style.display="none"),n&&n.classList.remove("is-invalid"),i?(t=!0,!0):(s&&(s.style.display="block"),n&&(n.classList.add("is-invalid"),n.focus()),ia("Catatan tidak boleh kosong","warning"),!1)},async()=>{if(!t)return;const i=document.getElementById("editCatatanText").value.trim();if(!i){ia("âš ï¸ Catatan tidak boleh kosong","warning");return}const s=a.catatan?`${a.catatan}

ðŸ“ Update:
- ${i}`:`Update Tim Pengangkut:
- ${i}`;try{await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify({catatan:s})}),ia("ðŸ“ Catatan berhasil ditambahkan","success"),alert("ðŸ“ Catatan berhasil ditambahkan","success"),Xa()}catch(n){console.error("Update error:",n),ia("âŒ Gagal menyimpan catatan","error")}})}catch(a){console.error("Load error:",a),ia("âŒ Gagal memuat data","error")}}function me(e){if(!e)return"-";try{const a=new Date(e);return isNaN(a.getTime())?e:a.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})}catch(a){return console.warn("Error formatting date:",e,a),e}}function es(e){return e?{terjadwal:"Terjadwal",dalam_proses:"Dalam Proses",selesai:"Selesai",dibatalkan:"Dibatalkan"}[e.toLowerCase()]||e:"Tidak Diketahui"}async function no(e){try{const a=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()}),t=a.tanggalJadwal||a.tanggal_jadwal||a.tanggal,i=me(t),s=`
      <div class="update-status-form">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <strong>${a.nama_anggota||a.nama||"Anggota"}</strong><br>
          Jadwal: ${i}
        </div>
        
        <div class="mb-3">
          <label class="form-label">Status Pengangkutan</label>
          <select id="status" class="form-select">
            <option value="terjadwal" ${(a.status_pengangkutan||a.status)==="terjadwal"?"selected":""}>
              Terjadwal
            </option>
            <option value="dalam_proses" ${(a.status_pengangkutan||a.status)==="dalam_proses"?"selected":""}>
              Dalam Proses
            </option>
            <option value="selesai" ${(a.status_pengangkutan||a.status)==="selesai"?"selected":""}>
              Selesai
            </option>
            <option value="dibatalkan" ${(a.status_pengangkutan||a.status)==="dibatalkan"?"selected":""}>
              Dibatalkan
            </option>
          </select>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Catatan</label>
          <textarea id="catatan" class="form-control" rows="3" 
                    placeholder="Tambahkan catatan...">${a.catatan||a.note||""}</textarea>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Tanggal Jadwal (Opsional)</label>
          <input type="date" id="tanggalJadwal" class="form-control" 
                 value="${t?new Date(t).toISOString().split("T")[0]:""}">
        </div>
      </div>
    `;P("Update Status Pengangkutan",s,async()=>{const n={status_pengangkutan:document.getElementById("status").value,catatan:document.getElementById("catatan").value},o=document.getElementById("tanggalJadwal").value;o&&(n.tanggalJadwal=o);try{await M(`${b.detailAnggotaJadwal}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify(n)}),ia("âœ… Status berhasil diupdate!","success"),setTimeout(()=>{Xa()},500)}catch(l){console.error("Error updating status:",l),ia(`âŒ Gagal update: ${l.message}`,"error")}})}catch(a){console.error("Error loading detail:",a),ia(`âŒ Gagal memuat data: ${a.message}`,"error")}}async function oo(e){var a,t;try{const i=await M(`${b.detailAnggotaJadwal}${e}/`,{headers:v()});console.log("Detail data:",i);const s=((a=i.idJadwal)==null?void 0:a.tanggal)||i.tanggal_jadwal||i.tanggal,n=me(s),o=me(i.created_at),l=me(i.updated_at),r=i.status_pengangkutan||i.status||"terjadwal",c=`status-${r.toLowerCase().replace(" ","_")}`,d=es(r),m=i.idAnggota||{},u=m.latitude&&m.longitude,g=m.idAnggota||((t=i.idAnggota)==null?void 0:t.idAnggota),p=`
      <div class="detail-modal-content">
        <div class="card mb-3 border-success">
          <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 text-success">
              <i class="bi bi-truck me-2"></i>Detail Pengangkutan
            </h5>
            <span class="badge ${Kc(r)}">${d}</span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <table class="table table-borderless">
                  <tr>
                    <td width="40%"><strong>Anggota</strong></td>
                    <td>
                      ${m.nama||i.nama_anggota||"N/A"}
                      ${g?`
                        <button onclick="viewAnggotaDetail('${g}')" 
                                class="btn btn-sm btn-outline-success ms-2">
                          <i class="bi bi-person"></i> Profil
                        </button>
                      `:""}
                    </td>
                  </tr>
                  <tr>
                    <td width="40%"><strong>Tanggal Jadwal</strong></td>
                    <td>
                      <i class="bi bi-calendar-check text-success me-1"></i>
                      ${n}
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Nama Tim</strong></td>
                    <td>
                      <span class="badge bg-info">${i.nama_tim||Ca||"N/A"}</span>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Catatan</strong></td>
                    <td>
                      <div style="max-height: 100px; overflow-y: auto; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                        ${i.catatan?i.catatan.replace(/\n/g,"<br>"):'<span class="text-muted">Tidak ada catatan</span>'}
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>ID Anggota</strong></td>
                    <td><code>${i.idAnggota||"-"}</code></td>
                  </tr>
                  <tr>
                    <td><strong>ID Detail</strong></td>
                    <td><code>${i.id||"-"}</code></td>
                  </tr>
                </table>
              </div>
            </div>
            
            <!-- Info tambahan -->
            <div class="row mt-3">
              <div class="col-12">
                <div class="alert alert-light">
                  <div class="row">
                    <div class="col-md-6 text-end">
                      <small class="text-muted">
                        <i class="bi bi-clock-history me-1"></i>
                        Dibuat: ${o}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tombol aksi -->
            <div class="row mt-3">
              <div class="col-12 text-center">                
                ${m.noWA?`
                  <a href="https://wa.me/${m.noWA.replace(/^0/,"62")}" 
                     target="_blank" 
                     class="btn btn-success me-2">
                    <i class="bi bi-whatsapp me-1"></i>WhatsApp
                  </a>
                `:""}
                
                ${g?`
                  <button onclick="viewAnggotaDetail('${g}')" 
                          class="btn btn-outline-success">
                    <i class="bi bi-person me-1"></i>Profil Lengkap
                  </button>
                `:""}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;P("Detail Pengangkutan",p),window.copyToClipboard=function(h){navigator.clipboard.writeText(h).then(()=>ia("âœ“ Koordinat disalin ke clipboard","success")).catch(f=>console.error("Gagal menyalin:",f))},g&&(window.viewAnggotaDetail=function(h){const f=`${b.anggota}${h}/`;M(f,{headers:v()}).then(k=>{const w=`
              <div class="card">
                <div class="card-header bg-success text-white">
                  <h5 class="mb-0">Profil Anggota</h5>
                </div>
                <div class="card-body">
                  <table class="table table-borderless">
                    <tr><td><strong>Nama</strong></td><td>${k.nama}</td></tr>
                    <tr><td><strong>ID Anggota</strong></td><td>${k.idAnggota}</td></tr>
                    <tr><td><strong>Alamat</strong></td><td>${k.alamat}</td></tr>
                    <tr><td><strong>No. WhatsApp</strong></td><td>${k.noWA||"-"}</td></tr>
                    <tr><td><strong>Status</strong></td><td>${k.status}</td></tr>
                    <tr><td><strong>Jenis Sampah</strong></td><td>${k.jenisSampah}</td></tr>
                    <tr><td><strong>Tanggal Aktif</strong></td><td>${me(k.tanggalStart)} - ${me(k.tanggalEnd)}</td></tr>
                  </table>
                </div>
              </div>
            `;P("Detail Anggota",w)}).catch(k=>{ia(`âŒ Gagal memuat profil anggota: ${k.message}`,"error")})})}catch(i){console.error("Error loading detail:",i),ia(`âŒ Gagal memuat detail: ${i.message}`,"error")}}function Kc(e){switch(e){case"selesai":return"bg-success";case"dalam_proses":return"bg-warning text-dark";case"dibatalkan":return"bg-danger";case"terjadwal":return"bg-info";default:return"bg-secondary"}}async function lo(e){const a=document.getElementById("inlineDetailContainer");try{const t=await M(`${b.anggota}${e}/`,{headers:v()});a.innerHTML=`
      <div class="card border-info shadow-sm">
        <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-info">
            <i class="bi bi-person-circle me-2"></i>Detail Anggota
          </h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="closeInlineDetail()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td width="40%"><strong>Nama</strong></td>
                  <td>${t.nama||"-"}</td>
                </tr>
                <tr>
                  <td><strong>No. WhatsApp</strong></td>
                  <td>${t.noWA||"-"}</td>
                </tr>
                <tr>
                  <td><strong>Alamat</strong></td>
                  <td>${t.alamat||"-"}</td>
                </tr>
              </table>
            </div>

            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td><strong>Status</strong></td>
                  <td>
                    <span class="badge ${t.status==="aktif"?"bg-success":"bg-danger"}">
                      ${t.status||"-"}
                    </span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Jenis Sampah</strong></td>
                  <td>${t.jenisSampah||"-"}</td>
                </tr>
                <tr>
                  <td><strong>Periode</strong></td>
                  <td>${t.tanggalStart||"-"} s/d ${t.tanggalEnd||"-"}</td>
                </tr>
              </table>
            </div>
          </div>

          ${t.latitude&&t.longitude?`
            <hr>
            <h6><i class="bi bi-geo-alt me-2"></i>Lokasi Anggota</h6>
            <div class="d-flex gap-2 flex-wrap">
              <button
                onclick="showLocationMap(${t.latitude}, ${t.longitude}, '${(t.nama||"").replace(/'/g,"\\'")}', '${(t.alamat||"").replace(/'/g,"\\'")}')"
                class="btn btn-sm btn-outline-success">
                <i class="bi bi-map"></i> Peta & Rute
              </button>
            </div>
          `:""}
        </div>
      </div>
    `,a.scrollIntoView({behavior:"smooth",block:"start"})}catch(t){console.error("Error loading anggota detail:",t),ia("âŒ Gagal memuat detail anggota","error")}}async function qc(){try{const a=(await M(b.anggota,{headers:v()})).filter(t=>t.latitude&&t.longitude);return console.log("ðŸ“Š Semua anggota dengan lokasi:",a.length),a}catch(e){return console.error("Error fetching semua anggota:",e),[]}}function Vc(e,a,t="",i=""){Cc(e,a,t,i)}async function Wc(){return new Promise((e,a)=>{if(window.L){e();return}if(!document.querySelector('link[href*="leaflet"]')){const s=document.createElement("link");s.rel="stylesheet",s.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",s.integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=",s.crossOrigin="",document.head.appendChild(s)}const t="leaflet-interactive-map";if(document.getElementById(t)){const s=setInterval(()=>{window.L&&(clearInterval(s),e())},100);return}const i=document.createElement("script");i.id=t,i.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",i.integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=",i.crossOrigin="",i.onload=()=>{delete L.Icon.Default.prototype._getIconUrl,L.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"}),e()},i.onerror=a,document.body.appendChild(i)})}function Yc(){const e={latitude:-6.2088,longitude:106.8456},a=(t,i)=>new Promise((s,n)=>{navigator.geolocation.getCurrentPosition(o=>s({pos:o,sourceLabel:i}),o=>n(o),t)});return new Promise(async t=>{if(!navigator.geolocation){t({...e,isFallback:!0,source:"No Geolocation Support",message:"Browser tidak mendukung GPS"});return}try{const{pos:i}=await a({enableHighAccuracy:!0,timeout:2e4,maximumAge:0},"High Accuracy GPS");if(!i.coords||typeof i.coords.latitude!="number"||typeof i.coords.longitude!="number"||isNaN(i.coords.latitude)||isNaN(i.coords.longitude))throw new Error("Koordinat GPS tidak valid");if(Math.abs(i.coords.latitude)>90||Math.abs(i.coords.longitude)>180)throw new Error("Koordinat GPS di luar range");i.coords.accuracy&&i.coords.accuracy>1e3&&console.warn("âš ï¸ Akurasi GPS rendah:",i.coords.accuracy,"m"),t({latitude:i.coords.latitude,longitude:i.coords.longitude,accuracy:i.coords.accuracy,altitude:i.coords.altitude,heading:i.coords.heading,speed:i.coords.speed,timestamp:i.timestamp,isFallback:!1,source:"High Accuracy GPS"})}catch(i){console.warn("âš ï¸ High accuracy GPS gagal:",i.message);try{const{pos:s}=await a({enableHighAccuracy:!1,timeout:1e4,maximumAge:6e4},"Low Accuracy GPS");t({latitude:s.coords.latitude,longitude:s.coords.longitude,accuracy:s.coords.accuracy,isFallback:!1,source:"Low Accuracy (WiFi/IP)"})}catch(s){console.warn("âŒ Semua metode GPS gagal:",s.message),t({...e,isFallback:!0,source:"Hardcoded Fallback",message:s.message||"Gagal mendapatkan lokasi GPS"})}}})}function Zc(e){navigator.clipboard.writeText(e).then(()=>{ia("âœ… Berhasil disalin ke clipboard","success")}).catch(a=>{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),ia("âœ… Berhasil disalin ke clipboard","success")})}function ro(e=new Date){const a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${a}-${t}-${i}`}function ts(){const e=ro();console.log("jajajajaaa",e),document.getElementById("filterDate").value=e,document.getElementById("filterStatus").value="",Xa()}function ia(e,a="info"){const t=document.querySelector(".custom-notification");t&&t.remove();const i=document.createElement("div");i.className="custom-notification",i.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
    max-width: 300px;
    display: flex;
    align-items: center;
    gap: 10px;
  `,a==="success"?i.style.backgroundColor="#28a745":a==="error"?i.style.backgroundColor="#dc3545":a==="warning"?(i.style.backgroundColor="#ffc107",i.style.color="#212529"):i.style.backgroundColor="#17a2b8";const s=a==="success"?"âœ…":a==="error"?"âŒ":a==="warning"?"âš ï¸":"â„¹ï¸";i.innerHTML=`
    <span style="font-size: 16px;">${s}</span>
    <span>${e}</span>
  `,document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300)},3e3)}if(!document.querySelector("#notification-styles")){const e=document.createElement("style");e.id="notification-styles",e.textContent=`
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `,document.head.appendChild(e)}window.updateDetailStatus=no;window.viewDetailTim=oo;window.viewAnggotaDetail=lo;window.showLocationMap=Vc;window.copyToClipboard=Zc;window.resetFilter=ts;window.mulaiPengangkutan=Jc;window.selesaikanPengangkutan=Rc;window.batalkanPengangkutan=zc;window.editCatatan=Oc;window.ubahStatusPengangkutan=Gc;window.showAllAnggotaMap=Fc;window.loadAllAnggotaMap=so;let bt=[],oa=1;const Ci=9;let et=null,Ga=null,Oa=null,Ne=null;async function Xc(){const e=document.getElementById("mainContent");e.innerHTML=`
    <div>
      <div style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:20px;
        flex-wrap:wrap;
        gap:10px;
      ">
        <h2>ðŸ—‘ï¸ Laporan Sampah</h2>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input type="text" id="searchLaporan"
            placeholder="Cari laporan..."
            style="padding:8px;border:1px solid #ddd;border-radius:4px;width:200px;">

          <select id="filterStatus"
            style="padding:8px;border:1px solid #ddd;border-radius:4px;">
            <option value="">Semua Status</option>
            <option value="pending">Menunggu</option>
            <option value="proses">Dalam Proses</option>
            <option value="selesai">Selesai</option>
          </select>

          <input type="date" id="filterDate"
            style="padding:8px;border:1px solid #ddd;border-radius:4px;">
        </div>
      </div>

      <!-- GRID CARD -->
      <div id="laporanContainer"></div>

      <!-- PAGINATION (WAJIB DI LUAR GRID) -->
      <div id="laporanPagination"
        style="
          margin-top:20px;
          display:flex;
          justify-content:center;
          gap:6px;
          flex-wrap:wrap;
        ">
      </div>
    </div>
  `,document.getElementById("searchLaporan").oninput=mt,document.getElementById("filterStatus").onchange=mt,document.getElementById("filterDate").onchange=mt,mt()}async function mt(){const e=document.getElementById("searchLaporan").value,a=document.getElementById("filterStatus").value,t=document.getElementById("filterDate").value;try{bt=(await M(b.laporanSampah,{headers:v()})).filter(n=>{var c,d,m;const o=((c=n.nama)==null?void 0:c.toLowerCase().includes(e.toLowerCase()))||((d=n.alamat)==null?void 0:d.toLowerCase().includes(e.toLowerCase()))||((m=n.deskripsi)==null?void 0:m.toLowerCase().includes(e.toLowerCase())),l=!a||n.status===a,r=!t||n.tanggal_lapor===t;return o&&l&&r}),oa=1,ft(oa)}catch(i){document.getElementById("laporanContainer").innerHTML=`<p style="color: red;">Error loading laporan: ${i.message}</p>`}}async function Qc(e){try{const a=await M(`${b.laporanSampah}${e}/`,{headers:v()}),t=it(a.status),i=`
      <span style="
        padding: 6px 14px;
        background: ${t.background};
        color: ${t.text};
        border: 1px solid ${t.border};
        border-radius: 20px;
        font-size: 13px;
        font-weight: bold;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      ">
        ${is(a.status)} ${a.status}
      </span>
    `,s=a.foto_bukti?`
        <div style="margin-top: 15px; text-align:center;">
          <img src="${a.foto_bukti}" alt="Foto Bukti"
            style="
              width: 100%;
              max-height: 260px;
              object-fit: cover;
              border-radius: 10px;
              border: 1px solid #ccc;
              box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            ">
        </div>
      `:`
        <div style="
          margin-top:15px; 
          padding:20px; 
          background:#f0f0f0; 
          text-align:center; 
          border-radius:8px;
          color:#777;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        ">
          <i class="bi bi-image" style="font-size: 20px;"></i>
          Tidak ada foto bukti
        </div>
      `,n=`
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 15px; color: #555;">ðŸ“‹ Timeline Status</h4>
        <div style="position: relative; padding-left: 30px;">
          <div style="position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e0e0e0;"></div>
          
          <!-- Step Dilaporkan -->
          <div style="position: relative; margin-bottom: 25px;">
            <div style="position: absolute; left: -25px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: #9C27B0; border: 3px solid white; z-index: 1;"></div>
            <div>
              <div style="font-weight: 500; color: #333;">Dilaporkan</div>
              <div style="font-size: 13px; color: #666;">${Bs(a.tanggal_lapor)}</div>
            </div>
          </div>
          
          <!-- Status Saat Ini -->
          ${lm(a)}
        </div>
      </div>
    `,o=parseFloat(a.latitude)||-10.1772,l=parseFloat(a.longitude)||123.607,r=`
      <div style="font-family: Arial;">

        <h2 style="margin-bottom: 15px; color:#333; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
          <i class="bi bi-file-earmark-text me-2"></i> Detail Laporan Sampah
        </h2>

        <div style="
          background: #ffffff;
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #e5e5e5;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        ">

          <!-- Header dengan Status -->
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap: 10px;">
            <div>
              <h3 style="margin:0; color:#222; font-size: 20px;">${a.nama||"Laporan Tanpa Nama"}</h3>
              <p style="margin:5px 0 0 0; color:#666; font-size: 14px;">
                <i class="bi bi-person me-1"></i> ${a.nama_user||"Tidak diketahui"}
              </p>
            </div>
            ${i}
          </div>

          <!-- Informasi Utama -->
          <div style="margin-bottom: 20px;">
            <div class="row" style="display: flex; flex-wrap: wrap; gap: 15px; margin: 0 -7px;">
              <div style="flex: 1; min-width: 200px; padding: 0 7px;">
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #4285F4;">
                  <p style="margin:0; color:#666; font-size: 13px; font-weight: 500;">
                    <i class="bi bi-calendar me-2"></i> Tanggal Lapor
                  </p>
                  <p style="margin:5px 0 0 0; color:#333; font-size: 15px; font-weight: 600;">
                    ${Bs(a.tanggal_lapor)}
                  </p>
                </div>
              </div>
              <div style="flex: 1; min-width: 200px; padding: 0 7px;">
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #34A853;">
                  <p style="margin:0; color:#666; font-size: 13px; font-weight: 500;">
                    <i class="bi bi-geo-alt me-2"></i> ID Laporan
                  </p>
                  <p style="margin:5px 0 0 0; color:#333; font-size: 15px; font-weight: 600;">
                    #${a.idLaporan||a.id}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Alamat -->
          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #555; font-size: 16px;">
              <i class="bi bi-geo-alt-fill me-2"></i> Alamat Lokasi
            </h4>
            <div style="
              padding: 15px;
              background: #f8f9fa;
              border-radius: 8px;
              border-left: 4px solid #FBBC05;
            ">
              <p style="margin:0; color:#333; line-height: 1.5;">
                ${a.alamat||"Tidak ada alamat"}
              </p>
            </div>
          </div>

          <!-- MAP SECTION - DENGAN 2 MARKER DAN GARIS -->
          <div style="margin: 20px 0;">
            <h4 style="margin-bottom: 15px; color: #555; font-size: 16px;">
              <i class="bi bi-map me-2"></i> Lokasi di Peta
            </h4>

            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <button onclick="getCurrentLocationForLaporan()" 
                class="btn btn-primary btn-sm"
                style="display: flex; align-items: center; gap: 5px;">
                <i class="bi bi-geo-alt"></i> Ambil Lokasi Saya (GPS)
              </button>
              
              ${a.latitude&&a.longitude?`
                <a href="https://www.google.com/maps?q=${o},${l}" 
                   target="_blank" 
                   class="btn btn-success btn-sm"
                   style="display: flex; align-items: center; gap: 5px;">
                  <i class="bi bi-google"></i> Buka di Google Maps
                </a>
                
                <button onclick="copyCoordinates(${o}, ${l})" 
                  class="btn btn-outline-secondary btn-sm"
                  style="display: flex; align-items: center; gap: 5px;">
                  <i class="bi bi-clipboard"></i> Salin Koordinat
                </button>
              `:""}
              
              <button onclick="clearUserMarker()" 
                class="btn btn-outline-danger btn-sm"
                style="display: flex; align-items: center; gap: 5px;">
                <i class="bi bi-x-circle"></i> Hapus Marker GPS
              </button>
            </div>

            <!-- Info Jarak -->
            <div id="distanceInfo" style="
              padding: 10px 15px;
              background: #e8f5e9;
              border-radius: 6px;
              border-left: 4px solid #4CAF50;
              margin-bottom: 15px;
              display: none;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="color: #2e7d32;">ðŸ“ Informasi Jarak:</strong>
                  <div style="margin-top: 5px;">
                    <span id="distanceValue" style="font-weight: 600; color: #333;"></span>
                    <span id="distanceUnit" style="color: #666;"></span>
                  </div>
                </div>
                <div style="color: #666; font-size: 12px;">
                  <i class="bi bi-arrows-move me-1"></i>
                  Garis penghubung
                </div>
              </div>
            </div>

            <div id="mapDetailContainer"
              style="
                width: 100%;
                height: 300px;
                border: 1px solid #ddd;
                border-radius: 8px;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;
              ">
              <div id="mapLoading" style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #f8f9fa;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
              ">
                <div style="text-align: center;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p style="margin-top: 10px; color: #666;">Memuat peta...</p>
                </div>
              </div>
              
              <div id="mapDetail" 
                style="width: 100%; height: 100%; display: none;"></div>
            </div>

            <!-- Legenda Marker -->
            <div style="
              padding: 12px 15px;
              background: #f8f9fa;
              border-radius: 6px;
              border: 1px solid #e0e0e0;
              margin-top: 10px;
            ">
              <div style="font-size: 13px; font-weight: 600; color: #555; margin-bottom: 10px;">
                <i class="bi bi-info-circle me-1"></i> Legenda Marker:
              </div>
              <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: ${it(a.status).background};
                    border: 2px solid white;
                    box-shadow: 0 0 5px rgba(0,0,0,0.2);
                  "></div>
                  <span style="font-size: 12px; color: #666;">Lokasi Laporan</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: #2196F3;
                    border: 2px solid white;
                    box-shadow: 0 0 5px rgba(0,0,0,0.2);
                  "></div>
                  <span style="font-size: 12px; color: #666;">Lokasi Anda (GPS)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="
                    width: 20px;
                    height: 3px;
                    background: #FF5722;
                  "></div>
                  <span style="font-size: 12px; color: #666;">Garis Jarak</span>
                </div>
              </div>
            </div>

            <!-- Koordinat Display -->
            <div style="
              padding: 10px 15px;
              background: #f8f9fa;
              border-radius: 6px;
              border-left: 4px solid #0d6efd;
              margin-top: 10px;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                  <small style="color: #666;">Koordinat Laporan:</small>
                  <div style="font-weight: 600; color: #333;">
                    ${o.toFixed(6)}, ${l.toFixed(6)}
                  </div>
                </div>
                <div id="userCoordinates" style="display: none;">
                  <small style="color: #666;">Koordinat Anda:</small>
                  <div style="font-weight: 600; color: #2196F3;">
                    <span id="userLat">-</span>, <span id="userLng">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- END MAP SECTION -->

          <!-- Deskripsi -->
          <div style="margin: 20px 0;">
            <h4 style="margin-bottom: 10px; color: #555; font-size: 16px;">
              <i class="bi bi-chat-text me-2"></i> Deskripsi Laporan
            </h4>
            <div style="
              padding: 15px;
              background:#f8f9fa;
              border-left:4px solid #0d6efd;
              border-radius:8px;
            ">
              <p style="margin:0; color:#555; line-height:1.6;">
                ${a.deskripsi||"Tidak ada deskripsi"}
              </p>
            </div>
          </div>

          <!-- Foto Bukti -->
          <div style="margin: 20px 0;">
            <h4 style="margin-bottom: 15px; color: #555; font-size: 16px;">
              <i class="bi bi-image me-2"></i> Foto Bukti
            </h4>
            ${s}
          </div>

          <!-- Timeline -->
          ${n}

        </div>
      </div>
    `;P("Detail Laporan",r,null,"modal-lg"),setTimeout(()=>{am(a)},300)}catch(a){ha("Error loading detail: "+a.message,"error")}}function am(e){const a=parseFloat(e.latitude)||-10.1772,t=parseFloat(e.longitude)||123.607;ba(()=>{const i=document.getElementById("mapLoading");i&&(i.style.display="none");const s=document.getElementById("mapDetail");s&&(s.style.display="block");const n=L.map("mapDetail").setView([a,t],16);et=n,L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}).addTo(n);const o=it(e.status).background,l=L.divIcon({html:`
        <div style="
          background-color: ${o};
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 0 10px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
        ">
          <i class="bi bi-trash-fill" style="font-size: 16px;"></i>
        </div>
      `,className:"custom-marker-icon",iconSize:[40,40],iconAnchor:[20,40],popupAnchor:[0,-40]});Ga=L.marker([a,t],{icon:l}).addTo(n),Ga.bindPopup(`
      <div style="min-width: 200px;">
        <strong>ðŸ“ Lokasi Laporan</strong><br/>
        <small><strong>ID:</strong> #${e.idLaporan||e.id}</small><br/>
        <small><strong>Status:</strong> ${e.status}</small><br/>
        <small><strong>Koordinat:</strong> ${a.toFixed(6)}, ${t.toFixed(6)}</small><br/>
        <small><strong>Alamat:</strong> ${(e.alamat||"").substring(0,60)}...</small>
      </div>
    `).openPopup(),L.divIcon({html:`
        <div style="
          background-color: #2196F3;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
        ">
          <i class="bi bi-person-fill" style="font-size: 16px;"></i>
        </div>
      `,className:"user-marker-icon",iconSize:[40,40],iconAnchor:[20,40],popupAnchor:[0,-40]}),L.control.zoom({position:"topright"}).addTo(n),sm(n,e.status),n.fitBounds([Ga.getLatLng()]),setTimeout(()=>{n.invalidateSize()},200)})}function em(){if(!navigator.geolocation){ha("âŒ Browser tidak mendukung GPS","error");return}ha("ðŸ“ Mengambil lokasi GPS Anda...","info"),navigator.geolocation.getCurrentPosition(e=>{const{latitude:a,longitude:t,accuracy:i}=e.coords;document.getElementById("userCoordinates").style.display="block",document.getElementById("userLat").textContent=a.toFixed(6),document.getElementById("userLng").textContent=t.toFixed(6),Oa&&Oa.remove(),Ne&&Ne.remove();const s=L.divIcon({html:`
          <div style="
            background-color: #2196F3;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
          ">
            <i class="bi bi-person-fill" style="font-size: 16px;"></i>
          </div>
        `,className:"user-marker-icon",iconSize:[40,40],iconAnchor:[20,40],popupAnchor:[0,-40]});if(Oa=L.marker([a,t],{icon:s}).addTo(et),Oa.bindPopup(`
        <div style="min-width: 200px;">
          <strong>ðŸ“ Lokasi Anda (GPS)</strong><br/>
          <small><strong>Koordinat:</strong> ${a.toFixed(6)}, ${t.toFixed(6)}</small><br/>
          <small><strong>Akurasi:</strong> Â±${Math.round(i)} meter</small>
        </div>
      `).openPopup(),Ga){const n=im(Ga.getLatLng().lat,Ga.getLatLng().lng,a,t),o=document.getElementById("distanceInfo"),l=document.getElementById("distanceValue"),r=document.getElementById("distanceUnit");n<1e3?(l.textContent=Math.round(n),r.textContent=" meter"):(l.textContent=(n/1e3).toFixed(2),r.textContent=" km"),o.style.display="block",Ne=L.polyline([Ga.getLatLng(),Oa.getLatLng()],{color:"#FF5722",weight:3,opacity:.8,dashArray:"10, 10"}).addTo(et),Ne.bindPopup(`
          <div style="min-width: 200px;">
            <strong>ðŸ“ Jarak</strong><br/>
            <small><strong>Dari lokasi laporan ke Anda:</strong></small><br/>
            <small>${n<1e3?Math.round(n)+" meter":(n/1e3).toFixed(2)+" km"}</small>
          </div>
        `)}if(Ga&&Oa){const n=L.latLngBounds([Ga.getLatLng(),Oa.getLatLng()]);et.fitBounds(n,{padding:[50,50]})}ha(`ðŸ“ Lokasi GPS ditemukan (Akurasi: Â±${Math.round(i)}m)`,"success")},e=>{let a="Gagal mendapatkan lokasi";switch(e.code){case e.PERMISSION_DENIED:a="Izin lokasi ditolak";break;case e.POSITION_UNAVAILABLE:a="Lokasi tidak tersedia";break;case e.TIMEOUT:a="Waktu tunggu habis";break}ha(`âŒ ${a}`,"error")},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}function tm(){Oa&&(Oa.remove(),Oa=null),Ne&&(Ne.remove(),Ne=null);const e=document.getElementById("distanceInfo");e&&(e.style.display="none");const a=document.getElementById("userCoordinates");a&&(a.style.display="none"),et&&Ga&&et.setView(Ga.getLatLng(),16),ha("ðŸ—‘ï¸ Marker GPS berhasil dihapus","info")}function im(e,a,t,i){const n=e*Math.PI/180,o=t*Math.PI/180,l=(t-e)*Math.PI/180,r=(i-a)*Math.PI/180,c=Math.sin(l/2)*Math.sin(l/2)+Math.cos(n)*Math.cos(o)*Math.sin(r/2)*Math.sin(r/2);return 6371e3*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function sm(e,a){const t=it(a).background,i=L.control({position:"bottomright"});i.onAdd=function(){const s=L.DomUtil.create("div","info legend");return s.style.backgroundColor="white",s.style.padding="10px",s.style.borderRadius="5px",s.style.boxShadow="0 2px 6px rgba(0,0,0,0.1)",s.style.fontSize="12px",s.style.maxWidth="150px",s.innerHTML=`
      <div style="font-weight: bold; margin-bottom: 8px; color: #333;">Legenda:</div>
      <div style="display: flex; align-items: center; margin-bottom: 6px;">
        <div style="width: 12px; height: 12px; background: ${t}; border-radius: 50%; margin-right: 8px; border: 2px solid white;"></div>
        <span>Lokasi Laporan</span>
      </div>
      <div style="display: flex; align-items: center; margin-bottom: 6px;">
        <div style="width: 12px; height: 12px; background: #2196F3; border-radius: 50%; margin-right: 8px; border: 2px solid white;"></div>
        <span>Lokasi Anda</span>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="width: 12px; height: 3px; background: #FF5722; margin-right: 8px;"></div>
        <span>Jarak</span>
      </div>
    `,s},i.addTo(e)}function nm(e,a){const t=`${e.toFixed(6)}, ${a.toFixed(6)}`;navigator.clipboard.writeText(t).then(()=>{ha("âœ… Koordinat laporan disalin: "+t,"success")}).catch(i=>{console.error("Gagal menyalin koordinat:",i),ha("âŒ Gagal menyalin koordinat","error")})}function om(e){const a=document.getElementById("laporanContainer");if(!e||e.length===0){a.innerHTML=`
      <div style="grid-column:1/-1;text-align:center;padding:40px;background:#f8f9fa;border-radius:8px;">
        <div style="font-size:48px;color:#ddd;">ðŸ“­</div>
        <h3 style="color:#666;">Tidak ada laporan</h3>
        <p style="color:#888;">Tidak ada laporan sampah yang ditemukan.</p>
      </div>
    `;return}a.style.display="grid",a.style.gridTemplateColumns="repeat(auto-fill, minmax(300px, 1fr))",a.style.gap="20px",a.innerHTML=e.map(t=>{var n;const i=t.foto_bukti,s=it(t.status);return`
      <div class="laporan-card" style="border:1px solid #ddd;border-radius:12px;background:#fff;display:flex;flex-direction:column">

        <div style="padding:12px 16px;background:${s.lightBackground};display:flex;justify-content:space-between">
          <strong style="color:${s.text}">
            ${is(t.status)} ${t.nama||"Laporan"}
          </strong>
          <span style="font-size:11px;padding:4px 12px;border-radius:20px;background:${s.background};color:${s.text}">
            ${t.status}
          </span>
        </div>

        ${i?`<img src="${i}" style="height:180px;object-fit:cover" onclick="showImageModal('${i}')">`:'<div style="height:180px;display:flex;align-items:center;justify-content:center;color:#aaa">Tidak ada foto</div>'}

        <div style="padding:16px;flex:1">
          <p style="font-size:14px;color:#555">
            ${(t.deskripsi||"").substring(0,100)}${((n=t.deskripsi)==null?void 0:n.length)>100?"...":""}
          </p>
        </div>

        <div style="display:flex;gap:8px;padding:12px;background:#fafafa">
          <button onclick="viewLaporan(${t.idLaporan||t.id})"
            style="flex:1;background:#4285F4;color:#fff;border:none;border-radius:6px;padding:8px">
            Detail
          </button>
          <button onclick="updateLaporanStatus(${t.idLaporan||t.id})"
            style="flex:1;background:${s.actionButton};color:#000000;border:none;border-radius:6px;padding:8px">
            Update
          </button>
        </div>
      </div>
    `}).join("")}function ft(e){if(!bt||bt.length===0){document.getElementById("laporanContainer").innerHTML=`
      <div style="grid-column:1/-1;text-align:center;padding:40px;background:#f8f9fa;border-radius:8px;">
        <div style="font-size:48px;color:#ddd;">ðŸ“­</div>
        <h3 style="color:#666;">Tidak ada laporan</h3>
        <p style="color:#888;">Tidak ada laporan sampah yang ditemukan.</p>
      </div>
    `,document.getElementById("laporanPagination").innerHTML="";return}oa=e;const a=(e-1)*Ci,t=a+Ci,i=bt.slice(a,t);om(i),co()}function co(){const e=document.getElementById("laporanPagination");if(!e)return;const a=Math.ceil(bt.length/Ci);if(a<=1){e.innerHTML="";return}e.innerHTML="";const t=document.createElement("button");t.textContent="â¬… Prev",t.disabled=oa===1,t.style.cssText=`
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: ${oa===1?"#f5f5f5":"white"};
    color: ${oa===1?"#999":"#333"};
    border-radius: 4px;
    cursor: ${oa===1?"not-allowed":"pointer"};
  `,oa>1&&(t.onclick=()=>ft(oa-1)),e.appendChild(t);for(let s=1;s<=a;s++){const n=document.createElement("button");n.textContent=s,n.style.cssText=`
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: ${s===oa?"#0d6efd":"white"};
      color: ${s===oa?"white":"#333"};
      border-radius: 4px;
      cursor: pointer;
      font-weight: ${s===oa?"bold":"normal"};
    `,n.onclick=()=>ft(s),e.appendChild(n)}const i=document.createElement("button");i.textContent="Next âž¡",i.disabled=oa===a,i.style.cssText=`
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: ${oa===a?"#f5f5f5":"white"};
    color: ${oa===a?"#999":"#333"};
    border-radius: 4px;
    cursor: ${oa===a?"not-allowed":"pointer"};
  `,oa<a&&(i.onclick=()=>ft(oa+1)),e.appendChild(i)}function is(e){return{dilaporkan:"ðŸ“",diterima:"âœ…",diproses:"â³",proses:"ðŸ”„",selesai:"ðŸŽ‰",ditolak:"âŒ",pending:"â±ï¸"}[e]||"ðŸ“‹"}function Bs(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}function lm(e){const a=e.status||"dilaporkan",t=["dilaporkan","diterima","diproses","selesai","ditolak"],i=t.indexOf(a);let s="";return t.forEach((n,o)=>{if(o<=i){const l=it(n),r=n===a;s+=`
        <div style="position: relative; margin-bottom: 25px;">
          <div style="position: absolute; left: -25px; top: 0; width: 16px; height: 16px; border-radius: 50%; 
               background: ${l.text}; 
               border: 3px solid white; 
               z-index: 1;
               ${r?"box-shadow: 0 0 0 3px "+l.background+";":""}">
          </div>
          <div>
            <div style="font-weight: 500; color: #333; display: flex; align-items: center; gap: 8px;">
              ${is(n)} ${n.toUpperCase()}
              ${r?'<span style="font-size: 11px; background: '+l.background+"; color: "+l.text+'; padding: 2px 8px; border-radius: 10px;">SAAT INI</span>':""}
            </div>
          </div>
        </div>
      `}}),s}function rm(e){const a=`
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Foto Bukti</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <img src="${e}" class="img-fluid" alt="Foto bukti laporan" 
                style="max-height: 70vh; object-fit: contain;">
          </div>
          <div class="modal-footer">
            <a href="${e}" download class="btn btn-primary">
              <i class="bi bi-download me-2"></i> Download
            </a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          </div>
        </div>
      </div>
    </div>
  `,t=document.createElement("div");t.innerHTML=a,document.body.appendChild(t),new bootstrap.Modal(document.getElementById("imageModal")).show(),document.getElementById("imageModal").addEventListener("hidden.bs.modal",function(){t.remove()})}function dm(e,a,t=""){try{const i=parseFloat(e),s=parseFloat(a);if(isNaN(i)||isNaN(s)){ha("âŒ Koordinat tidak valid","error");return}let n=`https://www.google.com/maps?q=${i},${s}`;t&&(n+=`&q=${encodeURIComponent(t)}`),window.open(n,"_blank"),ha("ðŸŒ Membuka lokasi di Google Maps","info")}catch(i){console.error("Error opening Google Maps:",i),ha("âŒ Gagal membuka Google Maps","error")}}function cm(e,a){try{const t=parseFloat(e).toFixed(6),i=parseFloat(a).toFixed(6),s=`${t}, ${i}`;navigator.clipboard.writeText(s).then(()=>{ha("âœ… Koordinat disalin: "+s,"success")}).catch(n=>{const o=document.createElement("textarea");o.value=s,document.body.appendChild(o),o.select(),document.execCommand("copy"),document.body.removeChild(o),ha("âœ… Koordinat disalin: "+s,"success")})}catch(t){console.error("Error copying coordinates:",t),ha("âŒ Gagal menyalin koordinat","error")}}function ha(e,a="info"){const t=document.querySelector(".custom-notification");t&&t.remove();const i=document.createElement("div");i.className="custom-notification",i.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 14px;
    font-weight: 500;
    animation: slideIn 0.3s ease;
    max-width: 300px;
    display: flex;
    align-items: center;
    gap: 10px;
  `,a==="success"?i.style.backgroundColor="#34A853":a==="error"?i.style.backgroundColor="#EA4335":a==="warning"?i.style.backgroundColor="#FBBC05":i.style.backgroundColor="#4285F4";const s=a==="success"?"âœ…":a==="error"?"âŒ":a==="warning"?"âš ï¸":"â„¹ï¸";i.innerHTML=`<span style="font-size: 16px;">${s}</span><span>${e}</span>`,document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>i.remove(),300)},3e3)}if(!document.querySelector("#notification-styles")){const e=document.createElement("style");e.id="notification-styles",e.textContent=`
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  `,document.head.appendChild(e)}async function mm(e){try{const t=(await M(`${b.laporanSampah}${e}/`,{headers:v()})).status||"pending",i=`
      <form id="updateLaporanForm">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Status saat ini: <strong>${Di(t)}</strong>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Status Baru:</label>
          <select id="status" class="form-select" 
                  onchange="checkStatusChange('${t}')">
            <option value="pending" ${t==="pending"?"selected":""}>
              Pending
            </option>
            <option value="proses" ${t==="proses"?"selected":""}>
              Proses
            </option>
            <option value="selesai" ${t==="selesai"?"selected":""}>
              Selesai
            </option>
          </select>
        </div>
        
        <div id="statusWarning" class="alert alert-warning d-none">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Status yang dipilih sama dengan status saat ini. 
          Silakan pilih status yang berbeda untuk melakukan perubahan.
        </div>
        
        <div id="statusMessage"></div>
      </form>
    `;P("Update Status Laporan",i,async()=>{const s=document.getElementById("status").value,n=document.getElementById("statusMessage");if(s===t)return n&&(n.innerHTML=`
              <div class="alert alert-danger">
                <i class="bi bi-x-circle me-2"></i>
                Status belum berubah. Silakan pilih status yang berbeda.
              </div>
            `),!1;const o={status:s};try{return await M(`${b.laporanSampah}${e}/`,{method:"PATCH",headers:v(),body:JSON.stringify(o)}),ha("âœ… Status laporan berhasil diupdate!","success"),alert("âœ… Status laporan berhasil diupdate!, 'success'"),mt(),!0}catch(l){return n&&(n.innerHTML=`
              <div class="alert alert-danger">
                <i class="bi bi-x-circle me-2"></i>
                Error: ${l.message}
              </div>
            `),!1}}),setTimeout(()=>{mo(t)},100)}catch(a){ha(`âŒ Error: ${a.message}`,"error")}}function mo(e){const a=document.getElementById("status"),t=document.getElementById("statusWarning"),i=document.getElementById("statusMessage");if(!a)return;const s=a.value;i&&(i.innerHTML=""),s===e?t&&t.classList.remove("d-none"):(t&&t.classList.add("d-none"),i&&(i.innerHTML=`
        <div class="alert alert-success">
          <i class="bi bi-check-circle me-2"></i>
          Status akan diubah dari 
          <strong>${Di(e)}</strong> 
          menjadi 
          <strong>${Di(s)}</strong>
        </div>
      `))}function Di(e){return{pending:"Pending",proses:"Proses",selesai:"Selesai"}[e]||e}function it(e){return{dilaporkan:{background:"#F3E5F5",text:"#4A148C",border:"#CE93D8",lightBackground:"#FAF5FB",actionButton:"#E1BEE7"},diterima:{background:"#E3F2FD",text:"#0D47A1",border:"#90CAF9",lightBackground:"#F5FAFF",actionButton:"#BBDEFB"},diproses:{background:"#FFF3E0",text:"#E65100",border:"#FFB74D",lightBackground:"#FFF8EE",actionButton:"#FFE0B2"},proses:{background:"#FFF3E0",text:"#E65100",border:"#FFB74D",lightBackground:"#FFF8EE",actionButton:"#FFE0B2"},selesai:{background:"#E8F5E9",text:"#1B5E20",border:"#A5D6A7",lightBackground:"#F3FBF4",actionButton:"#C8E6C9"},ditolak:{background:"#FFEBEE",text:"#B71C1C",border:"#EF9A9A",lightBackground:"#FFF5F6",actionButton:"#FFCDD2"},pending:{background:"#F5F5F5",text:"#424242",border:"#BDBDBD",lightBackground:"#FAFAFA",actionButton:"#E0E0E0"}}[e]||{background:"#FAFAFA",text:"#424242",border:"#BDBDBD",lightBackground:"#FFFFFF",actionButton:"#EEEEEE"}}window.viewLaporan=Qc;window.updateLaporanStatus=mm;window.openLaporanInGoogleMaps=dm;window.copyLaporanCoordinates=cm;window.getCurrentLocationForLaporan=em;window.copyCoordinates=nm;window.showImageModal=rm;window.renderLaporanPageTim=ft;window.renderPaginationTim=co;window.checkStatusChange=mo;window.clearUserMarker=tm;let st=1;const Kt=10;let _e=[];async function ve(){var i,s,n;const e=((i=document.getElementById("filterStatus"))==null?void 0:i.value)||"",a=((s=document.getElementById("filterMonth"))==null?void 0:s.value)||"",t=((n=document.getElementById("searchPembayaran"))==null?void 0:n.value)||"";try{let o=b.pembayaran;const l=[];e&&l.push(`status=${e}`),a&&l.push(`bulan=${a}`),t&&l.push(`search=${t}`),console.log("Fetching pembayaran from:",o),console.log("Filter params:",l);const r=await fetch(o,{headers:v()});if(!r.ok){const u=await r.text();throw console.error("Error response:",u),new Error(`Gagal mengambil data pembayaran: ${r.status}`)}let c=await r.json();console.log("Raw response data:",c);let d=[];Array.isArray(c)?d=c:c.data&&Array.isArray(c.data)?d=c.data:c.results&&Array.isArray(c.results)?d=c.results:c.pembayaran&&Array.isArray(c.pembayaran)?d=c.pembayaran:(console.warn("Format data tidak dikenali:",c),d=[]),console.log("Raw pembayaranList (before filtering):",d);let m=d.filter(u=>{var f;let g=!0;if(e){const k=String(u.status||u.statusBayar||"").toLowerCase(),w=e.toLowerCase();g=k===w}let p=!0;a&&(p=(u.tanggal_bayar||u.tanggalBayar||u.tanggal||"").substring(0,7)===a);let h=!0;if(t){const k=t.toLowerCase(),w=u.nama_anggota||((f=u.anggota)==null?void 0:f.nama)||u.nama||"",$=u.idPembayaran||u.id||"",y=u.metode_bayar||u.metodeBayar||"";h=w.toLowerCase().includes(k)||String($).includes(t)||y.toLowerCase().includes(k)}return g&&p&&h});console.log("Filtered pembayaranList:",m),_e=pm(m),st=1,go(),hm(m)}catch(o){console.error("Error loading pembayaran:",o),document.getElementById("pembayaranContainer").innerHTML=`
      <div class="alert alert-danger m-3">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Gagal memuat data: ${o.message}
      </div>
    `}}function Ms(){document.getElementById("filterStatus").value="",document.getElementById("filterMonth").value="",document.getElementById("searchPembayaran").value="",ve()}async function um(){const e=document.getElementById("mainContent");e.innerHTML=`
    <div class="pembayaran-tim-page">
      <!-- Header dengan gradient hijau -->
      <div class="card border-success mb-4 shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="text-success fw-bold mb-1">
                <i class="bi bi-cash-coin me-2"></i>Manajemen Pembayaran
              </h2>
              <p class="text-muted mb-0">Kelola pembayaran bulanan anggota</p>
            </div>
            <button id="btnExportExcel" class="btn btn-outline-success">
              <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
            </button>
          </div>
        </div>
      </div>
      
      <!-- Filter dan Search -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                  <i class="bi bi-search text-success"></i>
                </span>
                <input type="text" id="searchPembayaran" class="form-control border-start-0" placeholder="Cari nama anggota...">
              </div>
            </div>
            <div class="col-md-3">
              <select id="filterStatus" class="form-select">
                <option value="">Semua Status</option>
                <option value="lunas">Lunas</option>
                <option value="pending">Pending</option>
                <option value="gagal">Gagal</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="month" id="filterMonth" class="form-control" placeholder="Bulan">
            </div>
            <div class="col-md-2">
              <button id="btnResetFilter" class="btn btn-outline-secondary w-100">
                <i class="bi bi-x-circle me-1"></i>Reset
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Statistik -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card border-success border-2 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                  <i class="bi bi-check-circle text-success fs-4"></i>
                </div>
                <div>
                  <h5 class="card-title mb-1">Lunas</h5>
                  <p class="card-text text-muted mb-0">
                    <span id="countLunas" class="fw-bold fs-4">0</span> anggota
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card border-warning border-2 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="bg-warning bg-opacity-10 p-3 rounded me-3">
                  <i class="bi bi-clock text-warning fs-4"></i>
                </div>
                <div>
                  <h5 class="card-title mb-1">Pending</h5>
                  <p class="card-text text-muted mb-0">
                    <span id="countPending" class="fw-bold fs-4">0</span> anggota
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card border-danger border-2 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="bg-danger bg-opacity-10 p-3 rounded me-3">
                  <i class="bi bi-x-circle text-danger fs-4"></i>
                </div>
                <div>
                  <h5 class="card-title mb-1">Gagal</h5>
                  <p class="card-text text-muted mb-0">
                    <span id="countGagal" class="fw-bold fs-4">0</span> anggota
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card border-info border-2 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-10 p-3 rounded me-3">
                  <i class="bi bi-cash-stack text-info fs-4"></i>
                </div>
                <div>
                  <h5 class="card-title mb-1">Total Bulan Ini</h5>
                  <p class="card-text text-muted mb-0">
                    Rp <span id="totalBulanIni" class="fw-bold fs-4">0</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabel Pembayaran -->
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div id="pembayaranContainer" class="table-responsive">
            <div class="text-center py-5">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Memuat data pembayaran...</p>
            </div>
          </div>
        </div>
        <div id="paginationContainer" class="card-footer bg-white border-0"></div>
      </div>
    </div>
  `,document.head.insertAdjacentHTML("beforeend",ym),document.getElementById("filterStatus").addEventListener("change",ve),document.getElementById("filterMonth").addEventListener("change",ve),document.getElementById("searchPembayaran").addEventListener("input",gm(ve,300)),document.getElementById("btnResetFilter").addEventListener("click",Ms),document.getElementById("btnExportExcel").addEventListener("click",$m),ve(),window.loadPembayaran=ve,window.viewPembayaran=km,window.updateStatusPembayaran=Lm,window.editBuktiPembayaran=wm,window.resetFilters=Ms}function gm(e,a){let t;return function(...s){const n=()=>{clearTimeout(t),e(...s)};clearTimeout(t),t=setTimeout(n,a)}}function pm(e){const a={pending:0,proses:1,berhasil:2,sukses:2,gagal:3};return e.slice().sort((t,i)=>{const s=(t.status||t.statusBayar||"pending").toLowerCase(),n=(i.status||i.statusBayar||"pending").toLowerCase();return(a[s]??99)-(a[n]??99)})}function uo(e,a,t){const i=(a-1)*t;return e.slice(i,i+t)}function go(){if(!_e||_e.length===0){document.getElementById("pembayaranContainer").innerHTML=`
      <div class="text-center py-5">
        <i class="bi bi-receipt text-muted mb-3" style="font-size: 3rem;"></i>
        <h5 class="text-muted">Tidak ada data pembayaran</h5>
        <p class="text-muted">Coba ubah filter pencarian</p>
      </div>
    `,document.getElementById("paginationContainer").innerHTML="";return}const e=uo(_e,st,Kt);vm(e),bm(_e.length)}function bm(e){const a=Math.ceil(e/Kt),t=document.getElementById("paginationContainer");if(!t||a<=1){t&&(t.innerHTML="");return}let i='<nav><ul class="pagination justify-content-center mt-3">';for(let s=1;s<=a;s++)i+=`
      <li class="page-item ${s===st?"active":""}">
        <button class="page-link" onclick="goToPage(${s})">${s}</button>
      </li>
    `;i+="</ul></nav>",t.innerHTML=i}function fm(e){st=e,go()}function hm(e){const a=new Date().toISOString().slice(0,7),t={lunas:0,pending:0,gagal:0,totalBulanIni:0};e.forEach(i=>{const s=String(i.status||i.statusBayar||"").toLowerCase();s==="paid"||s==="lunas"?t.lunas++:s==="pending"?t.pending++:(s==="failed"||s==="gagal")&&t.gagal++;const n=i.tanggal_bayar||i.tanggalBayar;if(n&&n.startsWith(a)){const o=parseFloat(i.jumlah||i.jumlahBayar||0);t.totalBulanIni+=o}}),document.getElementById("countLunas").textContent=t.lunas,document.getElementById("countPending").textContent=t.pending,document.getElementById("countGagal").textContent=t.gagal,document.getElementById("totalBulanIni").textContent=t.totalBulanIni.toLocaleString("id-ID")}function vm(e){const a=document.getElementById("pembayaranContainer");if(!e||e.length===0){a.innerHTML=`
      <div class="text-center py-5">
        <i class="bi bi-receipt text-muted mb-3" style="font-size: 3rem;"></i>
        <h5 class="text-muted">Tidak ada data pembayaran</h5>
        <p class="text-muted">Coba ubah filter pencarian</p>
      </div>
    `;return}const t=(st-1)*Kt+1,i=Math.min(st*Kt,_e.length),s=_e.length,n=`
    <div class="mb-3 d-flex justify-content-between align-items-center">
      <small class="text-muted">
        Menampilkan ${t}-${i} dari ${s} pembayaran
      </small>
      <div class="d-none d-md-block">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>Geser untuk melihat lebih banyak
        </small>
      </div>
    </div>
    
    <!-- Tabel untuk Desktop/Laptop -->
    <div class="d-none d-md-block">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col" width="60">No</th>
              <th scope="col">Anggota</th>
              <th scope="col" width="100">Tanggal</th>
              <th scope="col" width="120">Jumlah</th>
              <th scope="col" width="100">Metode</th>
              <th scope="col" width="100">Status</th>
              <th scope="col" width="90" class="text-center">Bukti</th>
              <th scope="col" width="150" class="text-center">Aksi</th>
            </tr>
          </thead>
          <tbody>
            ${e.map((o,l)=>{var f;const r=l+1,c=o.idPembayaran||o.id||"N/A",d=o.nama_anggota||((f=o.anggota)==null?void 0:f.nama)||o.nama||"N/A",m=o.tanggal_bayar||o.tanggalBayar||o.tanggal,u=o.jumlah||o.jumlahBayar||0,g=o.metode_bayar||o.metodeBayar||"N/A",p=o.status||o.statusBayar||"pending",h=o.bukti_bayar||o.buktiBayar||"";return`
              <tr>
                <td class="text-muted fw-semibold">${r}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                      <i class="bi bi-person-circle text-success"></i>
                    </div>
                    <div>
                      <div class="fw-medium text-truncate" style="max-width: 150px;">${d}</div>
                      <small class="text-muted">${tt(m)}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <small>${tt(m)}</small>
                </td>
                <td class="fw-bold text-success">
                  Rp ${parseInt(u).toLocaleString("id-ID")}
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    ${ji(g)}
                    <span class="ms-1 d-none d-lg-inline">${g}</span>
                  </div>
                </td>
                <td>
                  ${qt(p)}
                </td>
                <td class="text-center">
                  ${Is(h)}
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <button onclick="viewPembayaran('${c}')" 
                            class="btn btn-outline-success" title="Lihat Detail">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button onclick="updateStatusPembayaran('${c}')" 
                            class="btn btn-outline-warning" title="Ubah Status">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button onclick="editBuktiPembayaran('${c}')" 
                            class="btn btn-outline-info" title="Edit Bukti">
                      <i class="bi bi-image"></i>
                    </button>
                  </div>
                </td>
              </tr>
              `}).join("")}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Card View untuk Mobile -->
    <div class="d-md-none">
      <div class="row g-3">
        ${e.map((o,l)=>{var h;const r=o.idPembayaran||o.id||"N/A",c=o.nama_anggota||((h=o.anggota)==null?void 0:h.nama)||o.nama||"N/A",d=o.tanggal_bayar||o.tanggalBayar||o.tanggal,m=o.jumlah||o.jumlahBayar||0,u=o.metode_bayar||o.metodeBayar||"N/A",g=o.status||o.statusBayar||"pending",p=o.bukti_bayar||o.buktiBayar||"";return`
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <!-- Header dengan ID dan Status -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div>
                    <span class="badge bg-secondary">#${r}</span>
                    ${qt(g)}
                  </div>
                  <div class="text-end">
                    <div class="fw-bold text-success">
                      Rp ${parseInt(m).toLocaleString("id-ID")}
                    </div>
                    <small class="text-muted">${tt(d)}</small>
                  </div>
                </div>
                
                <!-- Info Anggota -->
                <div class="d-flex align-items-center mb-3">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                    <i class="bi bi-person-circle text-success fs-5"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-medium">${c}</div>
                    <div class="d-flex align-items-center mt-1">
                      ${ji(u)}
                      <small class="text-muted ms-1">${u}</small>
                    </div>
                  </div>
                </div>
                
                <!-- Bukti dan Aksi -->
                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                  <div>
                    ${Is(p)}
                  </div>
                  <div class="btn-group btn-group-sm" role="group">
                    <button onclick="viewPembayaran('${r}')" 
                            class="btn btn-outline-success btn-sm" title="Lihat Detail">
                      <i class="bi bi-eye"></i>
                      <span class="d-none d-sm-inline ms-1">Lihat</span>
                    </button>
                    <button onclick="updateStatusPembayaran('${r}')" 
                            class="btn btn-outline-warning btn-sm" title="Ubah Status">
                      <i class="bi bi-pencil"></i>
                      <span class="d-none d-sm-inline ms-1">Status</span>
                    </button>
                    <button onclick="editBuktiPembayaran('${r}')" 
                            class="btn btn-outline-info btn-sm" title="Edit Bukti">
                      <i class="bi bi-image"></i>
                      <span class="d-none d-sm-inline ms-1">Bukti</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          `}).join("")}
      </div>
    </div>
    
    <!-- Info untuk Mobile -->
    <div class="d-md-none mt-3">
      <div class="alert alert-info alert-sm py-2 mb-0">
        <i class="bi bi-phone me-1"></i>
        <small>Ketuk tombol aksi untuk melihat detail, ubah status, atau edit bukti</small>
      </div>
    </div>
  `;a.innerHTML=n}const ym=`
  <style>
    /* Mobile Responsive Styles */
    @media (max-width: 767.98px) {
      .pembayaran-tim-page .card {
        margin-bottom: 15px;
      }
      
      .pembayaran-tim-page .btn-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }
      
      .pembayaran-tim-page .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      
      /* Status badge mobile */
      .badge-mobile {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }
    }
    
    /* Small mobile devices */
    @media (max-width: 575.98px) {
      .pembayaran-tim-page .btn-group {
        flex-wrap: wrap;
      }
      
      .pembayaran-tim-page .btn-group .btn {
        margin: 2px;
        flex: 1;
        min-width: 70px;
      }
      
      .pembayaran-tim-page .card-body {
        padding: 1rem;
      }
    }
    
    /* Very small devices */
    @media (max-width: 375px) {
      .pembayaran-tim-page .fw-medium {
        font-size: 0.95rem;
      }
      
      .pembayaran-tim-page .text-success {
        font-size: 0.9rem;
      }
    }
    
    /* Print styles */
    @media print {
      .btn, .btn-group, .badge {
        display: none !important;
      }
      
      .card {
        border: 1px solid #000 !important;
        margin-bottom: 10px !important;
      }
    }
  </style>
`;function ji(e){if(!e||e==="N/A")return'<span class="text-muted">-</span>';const a={bank:'<i class="bi bi-bank text-primary me-1"></i>',qris:'<i class="bi bi-qr-code text-success me-1"></i>',cash:'<i class="bi bi-cash text-success me-1"></i>',transfer:'<i class="bi bi-arrow-left-right text-info me-1"></i>',ewallet:'<i class="bi bi-phone text-info me-1"></i>'},t=String(e).toLowerCase();return`${a[t]||'<i class="bi bi-credit-card text-secondary me-1"></i>'}${e}`}function qt(e){if(!e)return'<span class="badge bg-secondary">Unknown</span>';const a=String(e).toLowerCase(),i={paid:{text:"Lunas",class:"bg-success"},lunas:{text:"Lunas",class:"bg-success"},pending:{text:"Pending",class:"bg-warning"},failed:{text:"Gagal",class:"bg-danger"},gagal:{text:"Gagal",class:"bg-danger"},success:{text:"Sukses",class:"bg-success"},canceled:{text:"Dibatalkan",class:"bg-danger"}}[a]||{text:a,class:"bg-secondary"};return`<span class="badge ${i.class}">${i.text}</span>`}function Is(e){return e?'<span class="badge bg-success"><i class="bi bi-check-circle"></i> Ada</span>':'<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Tidak Ada</span>'}function tt(e){if(!e)return'<span class="text-muted">-</span>';try{const a=new Date(e);return isNaN(a.getTime())?e:a.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})}catch(a){return console.warn("Error formatting date:",e,a),e}}async function km(e){var a;try{console.log("Fetching detail pembayaran ID:",e);const t=await fetch(`${b.pembayaran}${e}/`,{headers:v()});if(!t.ok)throw new Error(`Gagal mengambil detail: ${t.status}`);const i=await t.json();console.log("Detail pembayaran:",i),console.log("All properties:",Object.keys(i)),console.log("idPembayaran:",i.idPembayaran),console.log("id:",i.id),console.log("nama_anggota:",i.nama_anggota),console.log("anggota:",i.anggota),console.log("tanggal_bayar:",i.tanggal_bayar),console.log("tanggalBayar:",i.tanggalBayar);const s=i.idPembayaran||i.id||"N/A",n=i.nama_anggota||((a=i.anggota)==null?void 0:a.nama)||i.nama||"N/A",o=i.tanggal_bayar||i.tanggalBayar||i.tanggal,l=i.jumlah||i.jumlahBayar||0,r=i.metode_bayar||i.metodeBayar||"N/A",c=i.status||i.statusBayar||"pending",d=i.bukti_bayar_url||i.bukti_bayar||i.buktiBayar||i.bukti||"",m=d?`
        <div class="text-center mt-3">
          <img src="${d}" 
            class="img-fluid rounded shadow"
            style="max-height: 420px; width: 100%; object-fit: contain;">
          <div class="mt-2">
            <a href="${d}" 
               target="_blank" 
               class="btn btn-sm btn-outline-primary">
              <i class="bi bi-box-arrow-up-right me-1"></i>Buka Full Size
            </a>
            <button onclick="editBuktiPembayaran('${e}')" 
                    class="btn btn-sm btn-outline-info ms-2">
              <i class="bi bi-pencil me-1"></i>Edit Bukti
            </button>
          </div>
        </div>
      `:`
        <div class="text-center py-4">
          <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
          <p class="text-muted mt-2">Tidak ada bukti bayar</p>
          <button onclick="editBuktiPembayaran('${e}')" 
                  class="btn btn-info btn-sm">
            <i class="bi bi-plus-circle me-1"></i>Tambah Bukti
          </button>
        </div>
      `,u=`
      <style>
        /* Perbesar modal khusus Detail Pembayaran */
        .modal.show .modal-dialog:has(.detail-pembayaran-lg) {
          max-width: 80vw !important;
          width: 80vw !important;
        }

        /* Tinggi & scroll biar nyaman */
        .modal.show .modal-body {
          max-height: 85vh;
          overflow-y: auto;
        }
      </style>
      <div class="detail-pembayaran detail-pembayaran-lg container-fluid">
        <div class="row gx-4 gy-3">
          <div class="col-md-6">
            <div class="card border-success mb-3">
              <div class="card-header bg-success bg-opacity-10">
                <h6 class="card-title mb-0 text-success">
                  <i class="bi bi-info-circle me-2"></i>Informasi Pembayaran
                </h6>
              </div>
              <div class="card-body">
                <table class="table table-borderless">
                  <tr>
                    <td width="40%"><strong>ID Pembayaran</strong></td>
                    <td>#${s}</td>
                  </tr>
                  <tr>
                    <td><strong>Nama Anggota</strong></td>
                    <td>${n}</td>
                  </tr>
                  <tr>
                    <td><strong>Tanggal Bayar</strong></td>
                    <td>${tt(o)}</td>
                  </tr>
                  <tr>
                    <td><strong>Jumlah</strong></td>
                    <td class="fw-bold text-success">
                      Rp ${parseInt(l).toLocaleString("id-ID")}
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Metode Bayar</strong></td>
                    <td>${ji(r)}</td>
                  </tr>
                  <tr>
                    <td><strong>Status</strong></td>
                    <td>${qt(c)}</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card border-info">
              <div class="card-header bg-info bg-opacity-10">
                <h6 class="card-title mb-0 text-info">
                  <i class="bi bi-receipt me-2"></i>Bukti Pembayaran
                </h6>
              </div>
              <div class="card-body">
                ${m}
              </div>
            </div>
          </div>
        </div>
        
        ${i.created_at||i.createdAt?`
        <div class="alert alert-light mt-3">
          <small class="text-muted">
            <i class="bi bi-clock-history me-1"></i>
            Dibuat: ${tt(i.created_at||i.createdAt)} | 
            Diperbarui: ${tt(i.updated_at||i.updatedAt)}
          </small>
        </div>
        `:""}
      </div>
    `;P("Detail Pembayaran",`<div class="modal-content-lg" style="max-width: 100%; overflow-x: auto;">${u}</div>`,null,null)}catch(t){console.error("Error loading detail:",t),P("Error",`
        <div class="text-center py-4">
          <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
          <h5 class="text-danger">Gagal Memuat Detail</h5>
          <p class="text-muted">${t.message}</p>
        </div>
      `,null)}}async function wm(e){var a;try{console.log("Edit bukti pembayaran ID:",e);const t=await fetch(`${b.pembayaran}${e}/`,{headers:v()});if(!t.ok)throw new Error(`Gagal mengambil data pembayaran: ${t.status}`);const i=await t.json(),s=i.bukti_bayar||i.buktiBayar||"",o=`
      <div class="edit-bukti-form">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Anda dapat mengunggah atau mengganti bukti pembayaran untuk <strong>${i.nama_anggota||((a=i.anggota)==null?void 0:a.nama)||"Anggota"}</strong>
        </div>
        
        ${s?`
          <div class="current-bukti mb-4">
            <h6><i class="bi bi-image me-2"></i>Bukti Saat Ini:</h6>
            <div class="text-center">
              <img src="${s}" 
                   class="img-fluid rounded border" 
                   style="max-height: 200px;" 
                   alt="Bukti Bayar Saat Ini">
              <div class="mt-2">
                <a href="${s}" 
                   target="_blank" 
                   class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-box-arrow-up-right me-1"></i>Lihat
                </a>
              </div>
            </div>
          </div>
        `:`
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Saat ini belum ada bukti pembayaran yang diunggah
          </div>
        `}
        
        <div class="upload-section">
          <h6><i class="bi bi-cloud-upload me-2"></i>Unggah Bukti Baru:</h6>
          
          <div class="mb-3">
            <label class="form-label">Pilih File Bukti</label>
            <input type="file" id="buktiFile" class="form-control" 
                   accept=".jpg,.jpeg,.png,.pdf,.webp">
            <div class="form-text">
              Format yang didukung: JPG, PNG, PDF, WebP (maks. 5MB)
            </div>
          </div>
          
          <div id="uploadMessage" class="mb-3"></div>
          
          <div class="preview-section d-none mb-3">
            <h6><i class="bi bi-eye me-2"></i>Preview:</h6>
            <div id="imagePreview" class="text-center">
              <img id="previewImage" class="img-fluid rounded border" style="max-height: 200px;">
            </div>
          </div>
        </div>
      </div>
    `;P("Edit Bukti Pembayaran",o,async()=>await xm(e)),setTimeout(()=>{const l=document.getElementById("buktiFile"),r=document.getElementById("buktiUrl"),c=document.querySelector(".preview-section"),d=document.getElementById("previewImage");l&&l.addEventListener("change",function(m){const u=m.target.files[0];if(u){r&&(r.value="");const g=new FileReader;g.onload=function(p){d.src=p.target.result,c.classList.remove("d-none")},g.readAsDataURL(u)}}),r&&r.addEventListener("input",function(){this.value.trim()?(l&&(l.value=""),this.value.match(/\.(jpg|jpeg|png|gif|webp|pdf)$/i)?(d.src=this.value,c.classList.remove("d-none")):c.classList.add("d-none")):c.classList.add("d-none")})},100)}catch(t){console.error("Error loading edit bukti form:",t),P("Error",`
        <div class="text-center py-4">
          <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
          <h5 class="text-danger">Gagal Memuat Form</h5>
          <p class="text-muted">${t.message}</p>
        </div>
      `,null)}}async function xm(e){const a=document.getElementById("buktiFile"),t=document.getElementById("uploadMessage");if(t.innerHTML="",a&&a.files&&a.files.length>0){const i=a.files[0];if(i.size>5*1024*1024)return qa(t,"âŒ File terlalu besar. Maksimal 5MB","danger"),!1;if(!["image/jpeg","image/png","image/jpg","application/pdf","image/webp"].includes(i.type))return qa(t,"âŒ Format file tidak didukung","danger"),!1;const n=new FormData;n.append("buktiBayar",i);try{qa(t,"â³ Mengupload file...","info");const o=await fetch(`${b.pembayaran}${e}/`,{method:"PATCH",headers:{Authorization:v().Authorization},body:n});if(!o.ok){const l=await o.json();throw new Error(l.detail||`Upload gagal: ${o.status}`)}return qa(t,"âœ… Bukti pembayaran berhasil diupload","success"),alert("âœ… Bukti pembayaran berhasil diupload, 'success'"),setTimeout(()=>{ve(),Ra()},1500),!0}catch(o){return qa(t,`âŒ Upload gagal: ${o.message}`,"danger"),!1}}return a&&qa(t,"âš ï¸ Pilih file untuk melanjutkan","warning"),!1}async function Lm(e){var a;console.group("ðŸ§ª DEBUG updateStatusPembayaran"),console.log("ID Pembayaran:",e);try{const t=await fetch(`${b.pembayaran}${e}/`,{method:"GET",headers:v()});if(console.log("GET response status:",t.status),!t.ok){const l=await t.text();throw console.error("GET error body:",l),new Error(`GET gagal (${t.status})`)}const i=await t.json();console.log("DATA PEMBAYARAN:",i);const s=i.anggota||i.anggota_id||i.idAnggota;console.log("Anggota ID terkait:",s),s||console.warn("âš ï¸ Tidak ada ID anggota terkait dengan pembayaran ini");const n=String(i.status||i.statusBayar||"").toLowerCase();console.log("Current Status (normalized):",n);const o=`
      <div class="update-status-form">
        <table class="table table-borderless">
          <tr>
            <td><strong>Anggota</strong></td>
            <td>${i.nama_anggota||((a=i.anggota)==null?void 0:a.nama)||"N/A"}</td>
          </tr>
          <tr>
            <td><strong>Jumlah</strong></td>
            <td>Rp ${parseInt(i.jumlah||i.jumlahBayar||0).toLocaleString("id-ID")}</td>
          </tr>
          <tr>
            <td><strong>Status Saat Ini</strong></td>
            <td>${qt(n)}</td>
          </tr>
        </table>

        <div class="mb-3">
          <label class="form-label">Status Baru</label>
          <select id="newStatus" class="form-select">
            <option value="">-- Pilih --</option>
            <option value="lunas" ${n==="lunas"||n==="paid"?"selected":""}>Lunas</option>
            <option value="pending" ${n==="pending"?"selected":""}>Pending</option>
            <option value="gagal" ${n==="gagal"||n==="failed"?"selected":""}>Gagal</option>
          </select>
        </div>

        <div class="form-check mb-3" id="updateTanggalContainer" style="display: none;">
          <input class="form-check-input" type="checkbox" id="updateTanggalEnd" checked>
          <label class="form-check-label" for="updateTanggalEnd">
            Perpanjang keanggotaan hingga 1 bulan ke depan
          </label>
          <small class="text-muted d-block mt-1">
            Anggota akan diperpanjang otomatis hingga 1 bulan dari tanggal pembayaran
          </small>
        </div>

        <div id="statusMessage"></div>
      </div>
    `;P("Ubah Status Pembayaran",o,async()=>{var d;const l=document.getElementById("newStatus").value,r=((d=document.getElementById("updateTanggalEnd"))==null?void 0:d.checked)||!1,c=document.getElementById("statusMessage");if(console.log("New Status dipilih:",l),console.log("Update tanggalEnd:",r),!l)return qa(c,"âŒ Status baru harus dipilih","danger"),!1;if(l===n)return qa(c,"âš ï¸ Status sama dengan sebelumnya","warning"),!1;try{const m={statusBayar:l};console.log("PATCH payload ke pembayaran:",m);const u=await fetch(`${b.pembayaran}${e}/`,{method:"PATCH",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify(m)});if(console.log("PATCH status:",u.status),!u.ok){const f=await u.text();throw new Error(`PATCH gagal (${u.status}): ${f}`)}const g=await u.json();console.log("âœ… Pembayaran berhasil diupdate:",g),alert("âœ… Pembayaran berhasil diupdate",g);let p=!1;if(l==="lunas"&&r&&s)try{console.log(`ðŸ”„ Memperbarui tanggalEnd untuk anggota ID: ${s}`);const f=await fetch(`${b.anggota}${s}/`,{headers:v()});if(f.ok){const k=await f.json();console.log("Data anggota saat ini:",k);const w=new Date,$=new Date(w);$.setMonth(w.getMonth()+1);const y=$.toISOString().split("T")[0];console.log(`TanggalEnd baru: ${y}`);const A=await fetch(`${b.anggota}${s}/`,{method:"PATCH",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify({tanggalEnd:y,status:"aktif"})});A.ok?(p=!0,console.log("âœ… Anggota berhasil diperbarui"),alert(`âœ… Perpanjang keanggotaan hingga ${y}`)):console.warn("âš ï¸ Gagal memperbarui anggota:",await A.text())}else console.warn("âš ï¸ Gagal mengambil data anggota")}catch(f){console.warn("âš ï¸ Error saat memperbarui anggota:",f)}let h="âœ… Status pembayaran berhasil diupdate";return l==="lunas"&&(s&&r?p?h+=" dan keanggotaan telah diperpanjang 1 bulan":h+=" (Gagal memperpanjang keanggotaan)":s||(h+=" (Tidak ada data anggota terkait)")),qa(c,h,"success"),setTimeout(()=>{ve()},500),!0}catch(m){return console.error("PATCH ERROR:",m),qa(c,`âŒ ${m.message}`,"danger"),!1}}),setTimeout(()=>{const l=document.getElementById("newStatus"),r=document.getElementById("updateTanggalContainer");l&&r&&(l.addEventListener("change",function(){this.value==="lunas"&&s?r.style.display="block":r.style.display="none"}),l.value==="lunas"&&s&&(r.style.display="block"))},100)}catch(t){console.error("FATAL ERROR:",t),P("Error",`
        <div class="text-center py-4">
          <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
          <h5 class="text-danger">Gagal Memuat Data</h5>
          <p class="text-muted">${t.message}</p>
        </div>
      `,null)}finally{console.groupEnd()}}function qa(e,a,t="info"){e.innerHTML=`
    <div class="alert alert-${t} alert-dismissible fade show" role="alert">
      ${a}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `}function yi(e,a="success"){if(typeof bootstrap>"u"||!bootstrap.Toast){console.warn("Bootstrap Toast tidak tersedia"),alert(e);return}const t="notification-toast-"+Date.now(),i=`
    <div id="${t}" class="toast align-items-center text-bg-${a} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi ${a==="success"?"bi-check-circle":"bi-info-circle"} me-2"></i>
          ${e}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;let s=document.getElementById("toast-container");s||(s=document.createElement("div"),s.id="toast-container",s.className="toast-container position-fixed top-0 end-0 p-3",s.style.zIndex="9999",document.body.appendChild(s)),s.innerHTML+=i;const n=document.getElementById(t);new bootstrap.Toast(n,{delay:3e3}).show(),n.addEventListener("hidden.bs.toast",function(){n.remove()})}async function $m(){try{const e=await fetch(b.pembayaran,{headers:v()});if(!e.ok)throw new Error(`Gagal mengambil data: ${e.status}`);const a=await e.json();let t=[];if(Array.isArray(a))t=a;else if(a.data&&Array.isArray(a.data))t=a.data;else if(a.results&&Array.isArray(a.results))t=a.results;else if(a.pembayaran&&Array.isArray(a.pembayaran))t=a.pembayaran;else throw new Error("Format data tidak dikenali");if(t.length===0){yi("Tidak ada data untuk diexport","warning");return}const i=t.map(d=>{var m;return{ID:d.idPembayaran||d.id||"","Nama Anggota":d.nama_anggota||((m=d.anggota)==null?void 0:m.nama)||d.nama||"","Tanggal Bayar":d.tanggal_bayar||d.tanggalBayar||d.tanggal||"",Jumlah:d.jumlah||d.jumlahBayar||0,"Metode Bayar":d.metode_bayar||d.metodeBayar||"",Status:d.status||d.statusBayar||""}}),s=Object.keys(i[0]),o=[s.join(","),...i.map(d=>s.map(m=>{const u=d[m]||"";return`"${String(u).replace(/"/g,'""')}"`}).join(","))].join(`
`),l=new Blob([o],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(l),c=document.createElement("a");c.setAttribute("href",r),c.setAttribute("download",`pembayaran_${new Date().toISOString().slice(0,10)}.csv`),c.style.visibility="hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c),yi("Data berhasil diexport ke CSV","success")}catch(e){console.error("Error exporting data:",e),yi(`Gagal mengexport data: ${e.message}`,"danger")}}window.paginate=uo;window.goToPage=fm;async function Em(){const e=document.getElementById("mainContent");e.innerHTML=`
    <div class="anggota-container">
      <div class="header-section">
        <h2><i class="bi bi-people-fill"></i> Data Anggota</h2>
        <div class="filter-section">
          <div class="input-group search-box">
            <span class="input-group-text bg-light border-end-0">
              <i class="bi bi-search text-success"></i>
            </span>
            <input type="text" id="searchAnggota" class="form-control border-start-0" placeholder="Cari nama atau alamat...">
          </div>
          <select id="filterStatus" class="form-select">
            <option value="">Semua Status</option>
            <option value="aktif">Aktif</option>
            <option value="non-aktif">Non-Aktif</option>
          </select>
        </div>
      </div>
      
      <div id="anggotaContainer">
        <div class="text-center py-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Memuat data anggota...</p>
        </div>
      </div>
      
      <!-- Container untuk detail anggota (akan ditampilkan di sini) -->
      <div id="anggotaDetailContainer" style="display: none;"></div>
    </div>
    
    <style>
      .anggota-container {
        padding: 20px;
      }
      
      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .header-section h2 {
        color: #2c3e50;
        margin: 0;
        font-weight: 600;
      }
      
      .filter-section {
        display: flex;
        gap: 15px;
        align-items: center;
      }
      
      .search-box {
        width: 300px;
      }
      
      .anggota-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
      }
      
      .anggota-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        overflow: hidden;
      }
      
      .anggota-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        border-color: #20c997;
      }
      
      .card-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      }
      
      .member-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
      }
      
      .member-wa {
        color: #6c757d;
        font-size: 0.9rem;
      }
      
      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .status-aktif {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-nonaktif {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .card-body {
        padding: 20px;
      }
      
      .address-text {
        color: #495057;
        line-height: 1.5;
        margin-bottom: 15px;
        font-size: 0.95rem;
      }
      
      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.85rem;
      }
      
      .info-label {
        color: #6c757d;
        font-weight: 500;
      }
      
      .info-value {
        color: #495057;
        font-weight: 600;
      }
      
      .detail-btn {
        width: 100%;
        padding: 10px;
        background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .detail-btn:hover {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        transform: translateY(-1px);
      }
      
      /* Styling untuk detail view */
      .detail-view {
        background: white;
        border-radius: 12px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 30px;
        animation: fadeIn 0.5s ease;
      }
      
      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f1f3f4;
      }
      
      .back-button {
        padding: 8px 16px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }
      
      .back-button:hover {
        background: #5a6268;
        transform: translateX(-3px);
      }
      
      .member-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }
      
      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }
      
      .info-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }
      
      .info-card h5 {
        color: #20c997;
        margin-bottom: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .info-card h5 i {
        font-size: 1.2rem;
      }
      
      .info-item {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px dashed #dee2e6;
      }
      
      .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      .info-label-lg {
        color: #6c757d;
        font-weight: 500;
        display: block;
        margin-bottom: 4px;
        font-size: 0.9rem;
      }
      
      .info-value-lg {
        color: #495057;
        font-weight: 600;
        font-size: 1rem;
      }
      
      .map-container {
        margin-top: 25px;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #dee2e6;
        height: 400px;
        position: relative;
      }
      
      .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(248, 249, 250, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 100;
      }
      
      .map-controls {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 1000;
        display: flex;
        gap: 10px;
      }
      
      .map-btn {
        background: white;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        color: #495057;
        font-weight: 500;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .map-btn:hover {
        background: #20c997;
        color: white;
        transform: translateY(-1px);
      }
      
      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
        flex-wrap: wrap;
      }
      
      .action-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
      }
      
      .action-btn.primary {
        background: #20c997;
        color: white;
        border: none;
      }
      
      .action-btn.primary:hover {
        background: #17a2b8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(32, 201, 151, 0.3);
      }
      
      .action-btn.secondary {
        background: #6c757d;
        color: white;
        border: none;
      }
      
      .action-btn.secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @media (max-width: 768px) {
        .header-section {
          flex-direction: column;
          align-items: stretch;
        }
        
        .filter-section {
          flex-direction: column;
        }
        
        .search-box {
          width: 100%;
        }
        
        .anggota-grid {
          grid-template-columns: 1fr;
        }
        
        .detail-grid {
          grid-template-columns: 1fr;
        }
        
        .action-buttons {
          flex-direction: column;
        }
        
        .action-btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  `,document.getElementById("searchAnggota").addEventListener("input",ki),document.getElementById("filterStatus").addEventListener("change",ki),ki()}async function ki(){var i,s;const e=((i=document.getElementById("searchAnggota"))==null?void 0:i.value)||"",a=((s=document.getElementById("filterStatus"))==null?void 0:s.value)||"",t=document.getElementById("anggotaContainer");t.innerHTML=`
    <div class="text-center py-5">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Memuat data anggota...</p>
    </div>
  `;try{const o=(await M(b.anggota,{headers:v()})).filter(l=>{var d,m;const r=(((d=l.nama)==null?void 0:d.toLowerCase())||"").includes(e.toLowerCase())||(((m=l.alamat)==null?void 0:m.toLowerCase())||"").includes(e.toLowerCase()),c=!a||l.status===a;return r&&c});Tm(o)}catch(n){t.innerHTML=`
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Error loading anggota: ${n.message}
      </div>
    `}}function Tm(e){const a=document.getElementById("anggotaContainer");if(e.length===0){a.innerHTML=`
      <div class="text-center py-5">
        <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-muted">Tidak ada data anggota</h4>
        <p class="text-muted">Coba ubah kata kunci pencarian atau filter status</p>
      </div>
    `;return}const t=e.map(i=>{const s=i.status==="aktif"?"status-aktif":"status-nonaktif",n=i.status==="aktif"?"Aktif":"Non-Aktif";return`
      <div class="anggota-card">
        <div class="card-header">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div class="member-name">${i.nama||"N/A"}</div>
              <div class="member-wa"><i class="bi bi-whatsapp text-success"></i> ${i.noWA||"-"}</div>
            </div>
            <span class="status-badge ${s}">${n}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="address-text">
            <i class="bi bi-geo-alt text-muted me-2"></i>
            ${(i.alamat||"Alamat tidak tersedia").substring(0,80)}${i.alamat&&i.alamat.length>80?"...":""}
          </div>
          
          <div class="info-row">
            <span class="info-label">Periode:</span>
            <span class="info-value">${i.tanggalStart||"-"} s/d ${i.tanggalEnd||"-"}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">Jenis Sampah:</span>
            <span class="info-value">${i.jenisSampah||"-"}</span>
          </div>
          
          <button onclick="showAnggotaDetail('${i.idAnggota||i.id}')" 
                  class="detail-btn mt-3">
            <i class="bi bi-eye-fill"></i> Lihat Detail
          </button>
        </div>
      </div>
    `}).join("");a.innerHTML=`
    <div class="anggota-grid">
      ${t}
    </div>
  `,window.showAnggotaDetail=po}async function po(e){try{document.getElementById("anggotaContainer").style.display="none";const a=document.getElementById("anggotaDetailContainer");a.style.display="block",a.innerHTML=`
      <div class="text-center py-5">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Memuat detail anggota...</p>
      </div>
    `;const t=await M(`${b.anggota}${e}/`,{headers:v()}),i=parseFloat(t.latitude)||null,s=parseFloat(t.longitude)||null,n=i?i.toFixed(6):"Belum diatur",o=s?s.toFixed(6):"Belum diatur",l=t.status==="aktif"?"status-aktif":"status-nonaktif",r=t.status==="aktif"?"Aktif":"Non-Aktif",c=`
      <div class="detail-view">
        <div class="detail-header">
          <button onclick="hideAnggotaDetail()" class="back-button">
            <i class="bi bi-arrow-left"></i> Kembali ke Daftar
          </button>
          <h2 class="member-title">Detail Anggota</h2>
          <span class="status-badge ${l}">${r}</span>
        </div>
        
        <div class="detail-grid">
          <div class="info-card">
            <h5><i class="bi bi-person-circle"></i> Informasi Pribadi</h5>
            <div class="info-item">
              <span class="info-label-lg">Nama Lengkap</span>
              <span class="info-value-lg">${t.nama||"N/A"}</span>
            </div>
            <div class="info-item">
              <span class="info-label-lg">No. WhatsApp</span>
              <span class="info-value-lg">
                <i class="bi bi-whatsapp text-success me-2"></i>
                ${t.noWA||"-"}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label-lg">Alamat Lengkap</span>
              <span class="info-value-lg">${t.alamat||"Alamat tidak tersedia"}</span>
            </div>
          </div>
          
          <div class="info-card">
            <h5><i class="bi bi-calendar-check"></i> Informasi Langganan</h5>
            <div class="info-item">
              <span class="info-label-lg">Tanggal Mulai</span>
              <span class="info-value-lg">${t.tanggalStart||"-"}</span>
            </div>
            <div class="info-item">
              <span class="info-label-lg">Tanggal Berakhir</span>
              <span class="info-value-lg">${t.tanggalEnd||"-"}</span>
            </div>
            <div class="info-item">
              <span class="info-label-lg">Jenis Sampah</span>
              <span class="info-value-lg">${t.jenisSampah||"-"}</span>
            </div>
          </div>
          
          <div class="info-card">
            <h5><i class="bi bi-geo-alt"></i> Informasi Lokasi</h5>
            <div class="info-item">
              <span class="info-label-lg">Koordinat</span>
              <span class="info-value-lg">
                ${n}, ${o}
                ${i&&s?`
                  <button onclick="copyToClipboard('${n}, ${o}')" 
                          class="btn btn-sm btn-outline-secondary ms-2">
                    <i class="bi bi-clipboard"></i> Salin
                  </button>
                `:""}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label-lg">Status GPS</span>
              <span class="info-value-lg">
                ${i&&s?'<span class="badge bg-success">Lokasi valid</span>':'<span class="badge bg-warning">Lokasi belum diatur</span>'}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Map Section -->
        <div class="map-container">
          <div id="map-loading-${e}" class="map-loading">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Memuat peta...</p>
          </div>
          <div id="map-${e}" style="width: 100%; height: 100%;"></div>
          
          ${i&&s?`
            <div class="map-controls">
              <button
                onclick="showLocationMap(${t.latitude}, ${t.longitude}, '${(t.nama||"").replace(/'/g,"\\'")}', '${(t.alamat||"").replace(/'/g,"\\'")}')"
                class="btn btn-sm btn-outline-success">
                <i class="bi bi-map"></i> Peta & Rute
              </button>
            </div>
          `:""}
        </div>
      </div>
    `;if(a.innerHTML=c,window.hideAnggotaDetail=bo,window.copyToClipboard=fo,window.openInGoogleMaps=ho,i&&s)setTimeout(()=>Sm(e,i,s,t.nama,t.alamat),500);else{const d=document.getElementById(`map-loading-${e}`);d&&(d.style.display="none")}}catch(a){const t=document.getElementById("anggotaDetailContainer");t.innerHTML=`
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <h5>Gagal Memuat Detail</h5>
        <p>${a.message}</p>
        <button onclick="hideAnggotaDetail()" class="btn btn-secondary mt-2">
          <i class="bi bi-arrow-left"></i> Kembali
        </button>
      </div>
    `}}function bo(){document.getElementById("anggotaDetailContainer").style.display="none",document.getElementById("anggotaDetailContainer").innerHTML="",document.getElementById("anggotaContainer").style.display="block",window.anggotaMaps&&(Object.values(window.anggotaMaps).forEach(e=>{e&&e.remove&&e.remove()}),window.anggotaMaps={})}function fo(e){navigator.clipboard.writeText(e).then(()=>{ht("âœ… Berhasil disalin ke clipboard","success")}).catch(a=>{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),ht("âœ… Berhasil disalin ke clipboard","success")})}function ho(e,a,t=""){try{const i=parseFloat(e),s=parseFloat(a);if(isNaN(i)||isNaN(s)){ht("âŒ Koordinat tidak valid","error");return}let n=`https://www.google.com/maps?q=${i},${s}`;t&&(n+=`&q=${encodeURIComponent(t)}`),window.open(n,"_blank"),ht("ðŸŒ Membuka di Google Maps...","info")}catch(i){console.error("Error opening Google Maps:",i),ht("âŒ Gagal membuka Google Maps","error")}}async function Sm(e,a,t,i,s){const n=`map-${e}`,o=`map-loading-${e}`;try{window.L||await Am();const l=document.getElementById(o);l&&(l.style.display="none");const r=L.map(n).setView([a,t],15);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(r),L.marker([a,t]).addTo(r).bindPopup(`
      <div style="padding: 10px; min-width: 250px;">
        <h6 style="margin: 0 0 10px 0; color: #20c997;">
          <i class="bi bi-geo-alt-fill"></i> ${i}
        </h6>
        <p style="margin: 0; font-size: 12px; color: #666;">
          ${s||"Alamat tidak tersedia"}
        </p>
        <p style="margin: 8px 0 0 0; font-size: 11px; color: #888;">
          <strong>Koordinat:</strong> ${a.toFixed(6)}, ${t.toFixed(6)}
        </p>
      </div>
    `).openPopup(),L.control.zoom({position:"bottomright"}).addTo(r),L.control.scale().addTo(r),window.anggotaMaps||(window.anggotaMaps={}),window.anggotaMaps[e]=r}catch(l){console.error("Error loading map:",l);const r=document.getElementById(o);r&&(r.innerHTML=`
        <div style="color: #dc3545; text-align: center;">
          <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem;"></i>
          <p style="margin: 10px 0;">Gagal memuat peta</p>
          <button onclick="retryLoadMap('${e}', ${a}, ${t})" 
                  class="btn btn-sm btn-outline-danger">
            <i class="bi bi-arrow-clockwise"></i> Coba Lagi
          </button>
        </div>
      `)}}async function Am(){return new Promise((e,a)=>{if(window.L){e();return}if(!document.querySelector('link[href*="leaflet"]')){const s=document.createElement("link");s.rel="stylesheet",s.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",s.integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=",s.crossOrigin="",document.head.appendChild(s)}const t="leaflet-anggota-script";if(document.getElementById(t)){const s=setInterval(()=>{window.L&&(clearInterval(s),e())},100);return}const i=document.createElement("script");i.id=t,i.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",i.integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=",i.crossOrigin="",i.onload=()=>{delete L.Icon.Default.prototype._getIconUrl,L.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"}),e()},i.onerror=a,document.body.appendChild(i)})}function Bm(e,a,t){console.log("Retry map load for:",e)}function ht(e,a="info"){const t=document.querySelector(".custom-notification");t&&t.remove();const i=document.createElement("div");i.className="custom-notification",i.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
    max-width: 300px;
    display: flex;
    align-items: center;
    gap: 10px;
  `,a==="success"?i.style.backgroundColor="#28a745":a==="error"?i.style.backgroundColor="#dc3545":a==="warning"?(i.style.backgroundColor="#ffc107",i.style.color="#212529"):i.style.backgroundColor="#17a2b8";const s=a==="success"?"âœ…":a==="error"?"âŒ":a==="warning"?"âš ï¸":"â„¹ï¸";i.innerHTML=`
    <span style="font-size: 16px;">${s}</span>
    <span>${e}</span>
  `,document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>i.remove(),300)},3e3)}if(!document.querySelector("#notification-animations")){const e=document.createElement("style");e.id="notification-animations",e.textContent=`
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  `,document.head.appendChild(e)}window.showAnggotaDetail=po;window.hideAnggotaDetail=bo;window.copyToClipboard=fo;window.openInGoogleMaps=ho;window.retryLoadMap=Bm;let wi,Ps,Aa;function Ni(e){const a=document.getElementById("pageTitle"),t=document.getElementById("mainContent"),i={dashboard:"Dashboard Tim",jadwal:"Jadwal Pengangkutan",detail:"Detail Anggota",anggota:"Anggota",laporan:"Laporan Sampah",pembayaran:"Pembayaran"};switch(a.textContent=i[e]||"Dashboard Tim",t.innerHTML=`
    <div class="text-center py-5">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Memuat...</span>
      </div>
      <p class="mt-3 text-muted">Memuat halaman...</p>
    </div>
  `,e){case"jadwal":to();break;case"detail":_c();break;case"laporan":Xc();break;case"pembayaran":um();break;case"anggota":Em();break;case"dashboard":location.reload();break;default:t.innerHTML=`<div class="alert alert-warning">Halaman ${e} tidak ditemukan</div>`}}function Cs(e=new Date){const a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${a}-${t}-${i}`}async function Mm(){try{const e=new Date,a=new Date;a.setDate(a.getDate()+1);const t=Cs(e),i=Cs(a);let s=[],n=[];const o=await fetch(b.detailAnggotaJadwal,{headers:v()});if(!o.ok)throw new Error(`API error ${o.status}`);const l=await o.json(),r=Array.isArray(l)?l:Object.values(l||{}),c=f=>(f==null?void 0:f.tanggal)||(f==null?void 0:f.tanggal_jadwal)||(f==null?void 0:f.jadwal_tanggal)||(f==null?void 0:f.tanggal_pengangkutan)||null,d=f=>{var k,w;return(f==null?void 0:f.nama_tim)||(f==null?void 0:f.tim_nama)||((k=f==null?void 0:f.tim)==null?void 0:k.nama)||((w=f==null?void 0:f.idTim)==null?void 0:w.nama)||null},m=r.filter(f=>{const k=c(f),w=d(f);return k===t&&w===Aa}),u=r.filter(f=>{const k=c(f),w=d(f);return k===i&&w===Aa});console.log("ðŸ“… Jadwal Tim Hari Ini:",t,m),console.log("ðŸ“… Jadwal Tim Besok:",i,u);const g=m.length,p=m.filter(f=>{const k=(f.status_pengangkutan||f.status||"").toLowerCase();return k.includes("proses")||k.includes("dalam")}).length,h=m.filter(f=>{const k=(f.status_pengangkutan||f.status||"").toLowerCase();return k.includes("selesai")||k.includes("done")}).length;return Ds(g,p,h),Dm(m),Im(u.length,u,i,a.toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric"})),{jadwalHariIni:m,jadwalBesok:u,tanggalHariIni:t,tanggalBesok:i}}catch(e){console.error("âŒ loadDashboardStats error:",e),Ds(0,0,0)}}function vo(e){var a,t,i;return(e==null?void 0:e.nama_tim)||(e==null?void 0:e.tim_nama)||((a=e==null?void 0:e.tim)==null?void 0:a.nama)||((t=e==null?void 0:e.idTim)==null?void 0:t.nama)||((i=e==null?void 0:e.timAngkut)==null?void 0:i.nama_tim)||null}function yo(e){var a,t;return(e==null?void 0:e.nama_anggota)||((a=e==null?void 0:e.anggota)==null?void 0:a.nama)||((t=e==null?void 0:e.idAnggota)==null?void 0:t.nama)||(e==null?void 0:e.nama)||"Anggota"}function Im(e,a,t,i){const s=document.getElementById("tomorrowScheduleSection");s&&s.remove();const n=document.querySelector(".row.mb-4");if(!n)return;const o=`
    <div class="col-12 mb-4" id="tomorrowScheduleSection">
      <div class="card ${e>0?"border-info":"border-secondary"}">
        <div class="card-header ${e>0?"bg-info text-white":"bg-secondary text-white"} d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">
              <i class="bi bi-calendar2-day me-2"></i>
              Jadwal Besok
            </h5>
            <small class="opacity-75">${i}</small>
          </div>
          <div>
            <span class="badge ${e>0?"bg-light text-info":"bg-light text-secondary"} fs-6">
              ${e} Jadwal
            </span>
          </div>
        </div>
        <div class="card-body">
          ${Pm(e,a)}
        </div>
      </div>
    </div>
  `;n.insertAdjacentHTML("afterend",o);const l=document.getElementById("viewTomorrowScheduleBtn");l&&(l.onclick=function(){Cm()})}function Pm(e,a){if(e===0)return`
      <div class="text-center py-4">
        <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
        <p class="mt-3 mb-0"><strong>Tidak ada jadwal untuk besok</strong></p>
        <p class="text-muted small">Belum ada jadwal yang dijadwalkan untuk tim Anda hari berikutnya</p>
      </div>
    `;let t=`
    <p class="text-muted mb-3">Berikut adalah jadwal pengangkutan untuk tim <strong>${Aa}</strong> besok:</p>
  `;const i=a.slice(0,3);if(i.length>0&&(t+=`
      <div class="list-group mb-3">
        ${i.map((n,o)=>{const l=yo(n),r=n.status_pengangkutan||n.status||"terjadwal",c=r==="selesai"?'<span class="badge bg-success">Selesai</span>':r==="diproses"||r==="proses"?'<span class="badge bg-warning">Dalam Proses</span>':'<span class="badge bg-info">Terjadwal</span>',d=n.waktu||n.jam||n.jadwal_waktu||"",m=n.lokasi||n.alamat||n.tempat||"";return`
            <div class="list-group-item border-0 border-bottom py-3">
              <div class="d-flex align-items-start">
                <div class="bg-info-subtle text-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                  <strong class="small">${o+1}</strong>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <h6 class="mb-0"><strong>${l}</strong></h6>
                    ${c}
                  </div>
                  
                  <!-- Tampilkan nama tim jika berbeda -->
                  <div class="mb-1">
                    <small class="text-muted">
                      <i class="bi bi-people me-1"></i>Tim: ${vo(n)||Aa}
                    </small>
                  </div>
                  
                  <!-- Info waktu dan lokasi -->
                  <div class="row g-2 mt-2">
                    ${d?`
                      <div class="col-12 col-sm-6">
                        <small class="text-muted d-block">
                          <i class="bi bi-clock me-1"></i>Waktu
                        </small>
                        <small class="d-block fw-medium">${d}</small>
                      </div>
                    `:""}
                    
                    ${m?`
                      <div class="col-12 ${d?"col-sm-6":"col-12"}">
                        <small class="text-muted d-block">
                          <i class="bi bi-geo-alt me-1"></i>Lokasi
                        </small>
                        <small class="d-block fw-medium">${m.substring(0,50)}${m.length>50?"...":""}</small>
                      </div>
                    `:""}
                  </div>
                  
                  <!-- Jika ada catatan -->
                  ${n.catatan?`
                    <div class="mt-2">
                      <small class="text-muted d-block">
                        <i class="bi bi-chat-text me-1"></i>Catatan
                      </small>
                      <small class="d-block">${n.catatan.substring(0,60)}${n.catatan.length>60?"...":""}</small>
                    </div>
                  `:""}
                </div>
              </div>
            </div>
          `}).join("")}
      </div>
    `),a.length>3){const n=a.length-3;t+=`
      <div class="alert alert-info alert-sm mb-3">
        <i class="bi bi-info-circle me-2"></i>
        Masih ada <strong>${n}</strong> jadwal lainnya
      </div>
    `}const s={total:a.length,terjadwal:a.filter(n=>{const o=(n.status_pengangkutan||n.status||"").toLowerCase();return o.includes("terjadwal")||!o.includes("proses")&&!o.includes("selesai")}).length,dalamProses:a.filter(n=>(n.status_pengangkutan||n.status||"").toLowerCase().includes("proses")).length,selesai:a.filter(n=>(n.status_pengangkutan||n.status||"").toLowerCase().includes("selesai")).length};return t+=`
    <div class="row g-2 mb-3">
      <div class="col-md-6">
        <div class="card border-0 bg-light">
          <div class="card-body py-2">
            <small class="text-muted d-block">Total Jadwal</small>
            <strong class="fs-5">${s.total} Lokasi</strong>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-0 bg-light">
          <div class="card-body py-2">
            <small class="text-muted d-block">Status</small>
            <div class="d-flex align-items-center">
              <span class="badge bg-info me-1">${s.terjadwal}</span>
              <span class="badge bg-warning me-1">${s.dalamProses}</span>
              <span class="badge bg-success">${s.selesai}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="progress mb-3" style="height: 8px;">
      <div class="progress-bar bg-info" role="progressbar" 
           style="width: ${s.total>0?s.terjadwal/s.total*100:0}%" 
           title="Terjadwal: ${s.terjadwal}"></div>
      <div class="progress-bar bg-warning" role="progressbar" 
           style="width: ${s.total>0?s.dalamProses/s.total*100:0}%" 
           title="Dalam Proses: ${s.dalamProses}"></div>
      <div class="progress-bar bg-success" role="progressbar" 
           style="width: ${s.total>0?s.selesai/s.total*100:0}%" 
           title="Selesai: ${s.selesai}"></div>
    </div>
    
    <div class="d-flex justify-content-between align-items-center small text-muted mb-3">
      <span>
        <span class="d-inline-block rounded-circle bg-info" style="width: 8px; height: 8px;"></span>
        <span class="ms-1">Terjadwal</span>
      </span>
      <span>
        <span class="d-inline-block rounded-circle bg-warning" style="width: 8px; height: 8px;"></span>
        <span class="ms-1">Dalam Proses</span>
      </span>
      <span>
        <span class="d-inline-block rounded-circle bg-success" style="width: 8px; height: 8px;"></span>
        <span class="ms-1">Selesai</span>
      </span>
    </div>
  `,t+=`
    <div class="d-grid gap-2">
      <button class="btn ${e>0?"btn-outline-info":"btn-outline-secondary"}" id="viewTomorrowScheduleBtn">
        <i class="bi ${e>0?"bi-calendar2-check":"bi-calendar2"} me-2"></i>
        ${e>0?"Lihat Semua Jadwal Besok":"Cek Jadwal"}
      </button>
      
      <button class="btn btn-success" id="prepareTomorrowScheduleBtn">
        <i class="bi bi-clipboard-check me-2"></i>
        Persiapan untuk Besok
      </button>
    </div>
  `,t}function Cm(){const e=new Date;e.setDate(e.getDate()+1);const a=e.toISOString().split("T")[0];localStorage.setItem("scheduleFilterDate",a),localStorage.setItem("scheduleFilterType","tomorrow");const t=document.querySelector('[data-page="jadwal"]');t&&(document.querySelectorAll("[data-page]").forEach(i=>{i.classList.remove("active")}),t.classList.add("active"),Ni("jadwal"))}function Ds(e,a,t){console.log("ðŸ§ª updateStatsUI dipanggil:",{jadwal:e,proses:a,selesai:t,stack:new Error().stack}),[{id:"statJadwalHariIni",value:e},{id:"dalamProses",value:a},{id:"selesaiHariIni",value:t}].forEach(({id:s,value:n})=>{const o=document.getElementById(s);o&&(o.textContent=n)})}function Dm(e){const a=document.getElementById("recentActivity");if(!a||!Array.isArray(e))return;const i=[...e.filter(n=>vo(n)===Aa)].sort((n,o)=>{const l=new Date(n.created_at||n.tanggal_jadwal||0);return new Date(o.created_at||o.tanggal_jadwal||0)-l}).slice(0,5);if(i.length===0){a.innerHTML=`
      <div class="list-group-item">
        <div class="d-flex align-items-center">
          <div class="bg-light p-2 rounded-circle me-3">
            <i class="bi bi-calendar text-muted"></i>
          </div>
          <div class="flex-grow-1">
            <p class="mb-1"><strong>Tidak ada aktivitas hari ini</strong></p>
            <small class="text-muted">Belum ada jadwal untuk tim Anda hari ini</small>
          </div>
        </div>
      </div>
    `;return}const s=i.map(n=>{const o=n.status_pengangkutan||n.status||"terjadwal",l=yo(n),r=n.tanggal_jadwal||n.tanggal||"";let c="bi-calendar",d="text-success",m="bg-success-subtle";return o.toLowerCase().includes("selesai")?(c="bi-check-circle",d="text-success",m="bg-success-subtle"):o.toLowerCase().includes("proses")?(c="bi-arrow-repeat",d="text-warning",m="bg-warning-subtle"):o.toLowerCase().includes("batal")&&(c="bi-x-circle",d="text-danger",m="bg-danger-subtle"),`
      <div class="list-group-item border-0">
        <div class="d-flex align-items-center">
          <div class="${m} p-2 rounded-circle me-3">
            <i class="${c} ${d}"></i>
          </div>
          <div class="flex-grow-1">
            <p class="mb-1"><strong>${l}</strong></p>
            <small class="text-muted">${o} â€¢ ${r}</small>
            <div class="mt-1">
              <span class="badge bg-info">Tim: ${Aa}</span>
            </div>
          </div>
        </div>
      </div>
    `}).join("");a.innerHTML=s}async function ko(){const e=await Da();if(!e)return;if(e.role!=="tim_angkut"){alert("Hanya tim angkut yang bisa mengakses dashboard ini!"),window.location.hash="#/dashboard";return}if(wi=localStorage.getItem("user"),!wi){window.location.href="#/login";return}Ps=JSON.parse(wi),Aa=Ps.username;const a=document.getElementById("app");a.innerHTML=`
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      /* Custom styles for mobile sidebar */
      .sidebar-collapse {
        transition: all 0.3s ease;
      }
      
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        display: none;
      }
      
      .sidebar-overlay.show {
        display: block;
      }
      
      .mobile-sidebar {
        position: fixed;
        top: 0;
        left: -280px;
        width: 280px;
        height: 100%;
        z-index: 1050;
        transition: left 0.3s ease;
        overflow-y: auto;
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
      }
      
      .mobile-sidebar.show {
        left: 0;
      }
      
      @media (max-width: 767.98px) {
        .mobile-sidebar-toggle {
          display: block !important;
        }
      }
      
      /* Main content adjustment */
      @media (min-width: 768px) {
        .main-content {
          margin-left: 0;
        }
      }
      
      @media (max-width: 767.98px) {
        .main-content {
          width: 100%;
        }
        
        /* Hide desktop sidebar on mobile */
        .desktop-sidebar {
          display: none;
        }
      }
    </style>
    
    <div class="container-fluid p-0">
      <!-- Overlay for mobile sidebar -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>
      
      <!-- Mobile Sidebar -->
      <div class="mobile-sidebar bg-success text-white" id="mobileSidebar">
        <div class="d-flex flex-column h-100">
          <div class="p-4 bg-success-dark d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <img src="/logo/logo_3d.png" 
                    alt="CleanUp Kupang Logo" 
                    style="height: 40px; width: auto;">
              </div>
              <h2 class="mb-0">CleanUp</h2>
            </div>
            <button class="btn btn-link text-white p-0" id="closeMobileSidebar">
              <i class="bi bi-x-lg fs-4"></i>
            </button>
          </div>
          
          <div class="p-3 border-bottom border-success-dark">
            <div class="d-flex align-items-center">
              <div class="bg-white text-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                <strong>${Aa.charAt(0).toUpperCase()}</strong>
              </div>
              <div>
                <p class="mb-0 fw-medium">${Aa}</p>
                <span class="badge bg-warning text-dark">TIM</span>
              </div>
            </div>
          </div>
          
          <div class="flex-grow-1 p-3 overflow-auto">
            <div class="mb-4">
              <h6 class="text-uppercase opacity-75 mb-3">ðŸ  Dashboard</h6>
              <button class="btn btn-success w-100 text-start mb-2" data-page="dashboard">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard Utama
              </button>
            </div>
            
            <div class="mb-4">
              <h6 class="text-uppercase opacity-75 mb-3">ðŸ“‹ Operasional</h6>
              <button class="btn btn-success w-100 text-start mb-2" data-page="jadwal">
                <i class="bi bi-calendar me-2"></i>Jadwal
              </button>
              <button class="btn btn-success w-100 text-start mb-2" data-page="detail">
                <i class="bi bi-people me-2"></i>Pengangkutan
              </button>
              <button class="btn btn-success w-100 text-start mb-2" data-page="anggota">
                <i class="bi bi-person me-2"></i>Anggota
              </button>
            </div>
            
            <div class="mb-4">
              <h6 class="text-uppercase opacity-75 mb-3">ðŸ“ Laporan & Pembayaran</h6>
              <button class="btn btn-success w-100 text-start mb-2" data-page="laporan">
                <i class="bi bi-trash me-2"></i>Laporan Sampah
              </button>
              <button class="btn btn-success w-100 text-start mb-2" data-page="pembayaran">
                <i class="bi bi-cash-coin me-2"></i>Pembayaran
              </button>
            </div>
            
            <div class="mb-4">
              <h6 class="text-uppercase opacity-75 mb-3">ðŸ”” Notifikasi</h6>
              <button class="btn btn-success w-100 text-start mb-2" id="tim-showNotificationsModal-mobile">
                <i class="bi bi-bell me-2"></i>Lihat Notifikasi
                <span id="tim-notification-status-mobile" class="badge bg-secondary ms-2">
                  <i class="bi bi-bell-slash me-1"></i>Nonaktif
                </span>
              </button>
              <button class="btn btn-success w-100 text-start mb-2" id="tim-toggleNotificationsBtn-mobile">
                <i class="bi bi-toggle-off me-2"></i>Aktifkan Notifikasi
              </button>
            </div>
            
            <div class="mt-5">
              <button class="btn btn-outline-light w-100" id="btnLogoutMobileSidebar">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
              </button>
            </div>
          </div>
          
          <div class="p-3 border-top border-success-dark">
            <p class="text-center mb-0 small opacity-75">Tim Angkut â€¢ v1.0.0</p>
          </div>
        </div>
      </div>
      
      <div class="row min-vh-100 m-0">
        <!-- Desktop Sidebar (Visible on md and up) -->
        <div class="desktop-sidebar col-md-3 col-lg-2 bg-success text-white p-0">
          <div class="d-flex flex-column h-100">
            <div class="p-4 bg-success-dark">
              <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                  <img src="/logo/logo_3d.png" 
                      alt="CleanUp Kupang Logo" 
                      style="height: 40px; width: auto;">
                </div>
                <h2 class="mb-0">CleanUp</h2>
              </div>
              <div class="d-flex align-items-center">
                <div class="bg-white text-success rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                  <strong>${Aa.charAt(0).toUpperCase()}</strong>
                </div>
                <div>
                  <p class="mb-0">${Aa}</p>
                  <span class="badge bg-warning text-dark">TIM</span>
                </div>
              </div>
            </div>
            
            <div class="flex-grow-1 p-3 overflow-auto">
              <div class="mb-4">
                <h6 class="text-uppercase opacity-75 mb-3">ðŸ  Dashboard</h6>
                <button class="btn btn-success w-100 text-start mb-2 active" data-page="dashboard">
                  <i class="bi bi-speedometer2 me-2"></i>Dashboard Utama
                </button>
              </div>
              
              <div class="mb-4">
                <h6 class="text-uppercase opacity-75 mb-3">ðŸ“‹ Operasional</h6>
                <button class="btn btn-success w-100 text-start mb-2" data-page="jadwal">
                  <i class="bi bi-calendar me-2"></i>Jadwal
                </button>
                <button class="btn btn-success w-100 text-start mb-2" data-page="detail">
                  <i class="bi bi-people me-2"></i>Pengangkutan
                </button>
                <button class="btn btn-success w-100 text-start mb-2" data-page="anggota">
                  <i class="bi bi-person me-2"></i>Anggota
                </button>
              </div>
              
              <div class="mb-4">
                <h6 class="text-uppercase opacity-75 mb-3">ðŸ“ Laporan & Pembayaran</h6>
                <button class="btn btn-success w-100 text-start mb-2" data-page="laporan">
                  <i class="bi bi-trash me-2"></i>Laporan Sampah
                </button>
                <button class="btn btn-success w-100 text-start mb-2" data-page="pembayaran">
                  <i class="bi bi-cash-coin me-2"></i>Pembayaran
                </button>
              </div>
              
              <div class="mb-4">
                <h6 class="text-uppercase opacity-75 mb-3">ðŸ”” Notifikasi</h6>
                <button class="btn btn-success w-100 text-start mb-2" id="tim-showNotificationsModal">
                  <i class="bi bi-bell me-2"></i>Lihat Notifikasi
                  <span id="tim-notification-status" class="badge bg-secondary ms-2">
                    <i class="bi bi-bell-slash me-1"></i>Nonaktif
                  </span>
                </button>
                <button class="btn btn-success w-100 text-start mb-2" id="tim-toggleNotificationsBtn">
                  <i class="bi bi-toggle-off me-2"></i>Aktifkan Notifikasi
                </button>
              </div>
              
              <div class="mt-5">
                <button class="btn btn-outline-light w-100" id="btnLogout">
                  <i class="bi bi-box-arrow-right me-2"></i>Logout
                </button>
              </div>
            </div>
            
            <div class="p-3 border-top border-success-dark">
              <p class="text-center mb-0 small opacity-75">Tim Angkut â€¢ v1.0.0</p>
            </div>
          </div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-content col-12 col-md-9 col-lg-10 p-0">
          <!-- Mobile Header with Burger Menu -->
          <div class="bg-white border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <!-- Burger Menu Button (Mobile) -->
                <button class="btn btn-success me-3 d-md-none mobile-sidebar-toggle" id="openMobileSidebar">
                  <i class="bi bi-list"></i>
                </button>
                
                <!-- Logo for Mobile -->
                <div class="d-flex align-items-center">
                  <div class="me-2 d-md-none">
                    <img src="/logo/logo_3d.png" 
                        alt="CleanUp Kupang Logo" 
                        style="height: 35px; width: auto;">
                  </div>
                  <h4 class="mb-0 text-success" id="pageTitle">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard Tim
                  </h4>
                </div>
              </div>
              
              <div class="d-flex align-items-center">
                <!-- Notification Bell -->
                <div class="position-relative me-3">
                  <button class="btn btn-outline-success" 
                          id="tim-showNotificationsModalMobile"
                          style="position: relative; z-index: 1;">
                    <i class="bi bi-bell"></i>
                  </button>
                  <span id="tim-notification-badge-mobile" 
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-2 border-white"
                        style="display: none; font-size: 0.65rem; padding: 0.15em 0.4em; min-width: 18px; height: 18px; z-index: 2;">
                    0
                  </span>
                </div>
                
                <!-- User Dropdown -->
                <div class="dropdown">
                  <button class="btn btn-success d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                    <div class="bg-white text-success rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                      <strong>${Aa.charAt(0).toUpperCase()}</strong>
                    </div>
                    <span class="d-none d-sm-inline">${Aa}</span>
                    <i class="bi bi-chevron-down ms-2"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item text-danger" id="btnLogoutMobile"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Main Content Area -->
          <div class="p-3 p-md-4">
            <div id="mainContent">
              <!-- Dashboard default content -->
              <div>
                <div class="card border-success mb-4">
                  <div class="card-body bg-success-subtle">
                    <div class="row align-items-center">
                      <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                          <div class="me-2 d-none d-md-block">
                            <img src="/logo/logo_3d.png" 
                                alt="CleanUp Kupang Logo" 
                                style="height: 40px; width: auto;">
                          </div>
                          <h1 class="card-title text-success mb-0 fs-4 fs-md-2">
                            Dashboard Tim Pengangkut
                          </h1>
                        </div>
                        <p class="card-text mb-2">Selamat datang, <b>${Aa}</b> ðŸ‘·</p>
                        <span class="badge bg-success">Tim Angkut Aktif</span>
                      </div>
                      <div class="col-md-4 text-end mt-3 mt-md-0">
                        <div class="bg-success text-white p-3 rounded-circle d-inline-block">
                          <i class="bi bi-truck fs-2 fs-md-3"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="row mb-4">
                  <div class="col-sm-6 col-md-4 mb-3">
                    <div class="card border-success h-100">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="bg-success text-white rounded-circle p-3 me-3">
                            <i class="bi bi-calendar-check"></i>
                          </div>
                          <div>
                            <h3 class="card-title text-success mb-0" id="statJadwalHariIni">0</h3>
                            <p class="card-text text-muted mb-0">Jadwal Hari Ini</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-sm-6 col-md-4 mb-3">
                    <div class="card border-warning h-100">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="bg-warning text-white rounded-circle p-3 me-3">
                            <i class="bi bi-arrow-repeat"></i>
                          </div>
                          <div>
                            <h3 class="card-title text-warning mb-0" id="dalamProses">0</h3>
                            <p class="card-text text-muted mb-0">Dalam Proses</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-sm-6 col-md-4 mb-3">
                    <div class="card border-info h-100">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="bg-info text-white rounded-circle p-3 me-3">
                            <i class="bi bi-check-circle"></i>
                          </div>
                          <div>
                            <h3 class="card-title text-info mb-0" id="selesaiHariIni">0</h3>
                            <p class="card-text text-muted mb-0">Selesai Hari Ini</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="card border-success mb-4">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Mulai Bekerja</h5>
                  </div>
                  <div class="card-body">
                    <p class="text-muted">Pilih menu di sidebar atau tombol di bawah untuk memulai pekerjaan Anda</p>
                    
                    <div class="row">
                      <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-success w-100 h-100 p-2 p-md-3 d-flex flex-column align-items-center" data-action="jadwal">
                          <i class="bi bi-calendar mb-2 fs-4"></i>
                          <span class="text-center">Lihat Jadwal</span>
                          <small class="text-muted mt-1 text-center d-none d-md-block">Kelola jadwal pengangkutan</small>
                        </button>
                      </div>
                      
                      <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-success w-100 h-100 p-2 p-md-3 d-flex flex-column align-items-center" data-action="detail">
                          <i class="bi bi-people mb-2 fs-4"></i>
                          <span class="text-center">Detail Anggota</span>
                          <small class="text-muted mt-1 text-center d-none d-md-block">Lihat detail anggota</small>
                        </button>
                      </div>
                      
                      <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-success w-100 h-100 p-2 p-md-3 d-flex flex-column align-items-center" data-action="laporan">
                          <i class="bi bi-trash mb-2 fs-4"></i>
                          <span class="text-center">Laporan Sampah</span>
                          <small class="text-muted mt-1 text-center d-none d-md-block">Kelola laporan sampah</small>
                        </button>
                      </div>
                      
                      <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-success w-100 h-100 p-2 p-md-3 d-flex flex-column align-items-center" data-action="pembayaran">
                          <i class="bi bi-cash-coin mb-2 fs-4"></i>
                          <span class="text-center">Pembayaran</span>
                          <small class="text-muted mt-1 text-center d-none d-md-block">Kelola pembayaran</small>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="card border-success">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Aktivitas Terbaru</h5>
                  </div>
                  <div class="card-body">
                    <div class="list-group list-group-flush" id="recentActivity">
                      <div class="list-group-item border-0">
                        <div class="d-flex align-items-center">
                          <div class="bg-success-subtle p-2 rounded-circle me-3">
                            <i class="bi bi-truck text-success"></i>
                          </div>
                          <div class="flex-grow-1">
                            <p class="mb-1"><strong>Siap bekerja hari ini!</strong></p>
                            <small class="text-muted">Mulai dengan melihat jadwal pengangkutan</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal Container -->
    <div id="modalContainer"></div>
  `,Nm(),_m(),jm(),await Mm(),setTimeout(()=>{Fm()},1e3)}function jm(){console.log("ðŸ“± Setting up mobile sidebar functionality...");const e=document.getElementById("mobileSidebar"),a=document.getElementById("sidebarOverlay"),t=document.getElementById("openMobileSidebar"),i=document.getElementById("closeMobileSidebar");if(!e||!t){console.warn("âŒ Mobile sidebar elements not found!");return}console.log("âœ… Mobile sidebar elements found, setting up event listeners..."),t.addEventListener("click",function(l){l.preventDefault(),l.stopPropagation(),console.log("ðŸ” Burger menu clicked!"),e.classList.add("show"),a.classList.add("show"),document.body.style.overflow="hidden"}),i&&i.addEventListener("click",n),a&&a.addEventListener("click",n);const s=e.querySelectorAll("[data-page]");s.forEach(l=>{l.addEventListener("click",n)}),document.addEventListener("keydown",function(l){l.key==="Escape"&&n()});function n(){e.classList.remove("show"),a&&a.classList.remove("show"),document.body.style.overflow=""}window.addEventListener("resize",function(){window.innerWidth>=768&&n()});const o=document.querySelectorAll(".desktop-sidebar [data-page]");o.length>0&&o.forEach(l=>{l.addEventListener("click",function(){o.forEach(d=>d.classList.remove("active")),s.forEach(d=>d.classList.remove("active")),this.classList.add("active");const r=this.getAttribute("data-page"),c=e.querySelector(`[data-page="${r}"]`);c&&c.classList.add("active")})}),s.length>0&&s.forEach(l=>{l.addEventListener("click",function(){o.forEach(d=>d.classList.remove("active")),s.forEach(d=>d.classList.remove("active")),this.classList.add("active");const r=this.getAttribute("data-page"),c=document.querySelector(`.desktop-sidebar [data-page="${r}"]`);c&&c.classList.add("active")})}),console.log("âœ… Mobile sidebar setup complete!")}function js(){const e=document.getElementById("mobileSidebar"),a=document.getElementById("sidebarOverlay");e&&e.classList.remove("show"),a&&a.classList.remove("show"),document.body.style.overflow=""}function Nm(){document.querySelectorAll(".dropdown-toggle").forEach(t=>{bootstrap&&bootstrap.Dropdown&&new bootstrap.Dropdown(t)});const a=document.createElement("style");a.textContent=`
    .bg-success-dark {
      background-color: #198754 !important;
    }
    
    .border-success {
      border-color: #198754 !important;
    }
    
    .btn-success {
      background-color: #198754;
      border-color: #198754;
    }
    
    .btn-success:hover, .btn-success:focus {
      background-color: #157347;
      border-color: #146c43;
    }
    
    .btn-success.active {
      background-color: #146c43;
      border-color: #13653f;
      box-shadow: 0 0 0 0.25rem rgba(60, 153, 110, 0.5);
    }
    
    .btn-outline-success {
      color: #198754;
      border-color: #198754;
    }
    
    .btn-outline-success:hover {
      background-color: #198754;
      border-color: #198754;
    }
    
    .text-success {
      color: #198754 !important;
    }
    
    .bg-success-subtle {
      background-color: #d1e7dd !important;
    }
    
    .bg-info-subtle {
      background-color: #d1ecf1 !important;
    }
    
    .border-success-dark {
      border-color: #146c43 !important;
    }
    
    .card.border-success .card-header {
      background-color: #198754;
      color: white;
    }
    
    .sidebar-menu .btn {
      text-align: left;
      padding: 0.75rem 1rem;
      margin-bottom: 0.25rem;
      border-radius: 0.375rem;
      transition: all 0.3s ease;
    }
    
    .sidebar-menu .btn:hover {
      transform: translateX(5px);
    }
    
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        z-index: 1000;
        height: 100vh;
        overflow-y: auto;
      }
      
      .main-content {
        margin-left: 0;
      }
    }
  `,document.head.appendChild(a)}function _m(){console.log("ðŸ”— Setting up event listeners..."),document.querySelectorAll(".btn[data-page]").forEach(o=>{o.id.includes("Logout")||o.addEventListener("click",l=>{l.preventDefault(),console.log(`ðŸ“„ Menu clicked: ${o.dataset.page}`),document.querySelectorAll(".btn[data-page]").forEach(r=>{r.classList.remove("active")}),o.classList.add("active"),Ni(o.dataset.page)})}),document.querySelectorAll("button[data-action]").forEach(o=>{o.addEventListener("click",l=>{l.preventDefault();const r=o.getAttribute("data-action");console.log(`âš¡ Action button clicked: ${r}`),document.querySelectorAll(".btn[data-page]").forEach(c=>{c.classList.remove("active"),c.getAttribute("data-page")===r&&c.classList.add("active")}),Ni(r)})}),["btnLogout","btnLogoutMobile","btnLogoutMobileSidebar"].forEach(o=>{const l=document.getElementById(o);l&&l.addEventListener("click",r=>{r.preventDefault(),console.log(`ðŸšª Logout button clicked: ${o}`),typeof window.logout=="function"?window.logout():(localStorage.clear(),window.location.hash="#/login",window.location.reload())})});const a=document.getElementById("tim-showNotificationsModalMobile");a&&(console.log("ðŸ“± Found mobile notification button, setting up click handler..."),a.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸ”¼ Mobile notification button clicked!");try{a.classList.add("btn-warning"),a.classList.remove("btn-outline-success");const l=a.querySelector("i");l&&(l.className="bi bi-arrow-repeat spinner-border spinner-border-sm");const{timNotifications:r}=await Pe(async()=>{const{timNotifications:c}=await import("./timNotifications-BGXkaiyb.js");return{timNotifications:c}},__vite__mapDeps([0,1,2]));await r.showTimNotificationModal()}catch(l){console.error("âŒ Error showing notifications modal:",l),xi("Terjadi kesalahan: "+l.message)}finally{setTimeout(()=>{a.classList.remove("btn-warning"),a.classList.add("btn-outline-success");const l=a.querySelector("i");l&&(l.className="bi bi-bell")},500)}}));const t=document.getElementById("tim-showNotificationsModal");t&&(console.log("ðŸ’» Found desktop notification button, setting up click handler..."),t.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸ”¼ Desktop notification button clicked!");try{t.classList.add("btn-warning");const l=t.querySelector("i");l&&(l.className="bi bi-arrow-repeat spinner-border spinner-border-sm");const{timNotifications:r}=await Pe(async()=>{const{timNotifications:c}=await import("./timNotifications-BGXkaiyb.js");return{timNotifications:c}},__vite__mapDeps([0,1,2]));await r.showTimNotificationModal()}catch(l){console.error("âŒ Error showing notifications modal:",l),xi(l.message)}finally{setTimeout(()=>{t.classList.remove("btn-warning");const l=t.querySelector("i");l&&(l.className="bi bi-bell")},500)}}));const i=document.getElementById("tim-showNotificationsModal-mobile");i&&(console.log("ðŸ“± Found mobile sidebar notification button"),i.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸ”¼ Mobile sidebar notification button clicked!"),js();try{const{timNotifications:l}=await Pe(async()=>{const{timNotifications:r}=await import("./timNotifications-BGXkaiyb.js");return{timNotifications:r}},__vite__mapDeps([0,1,2]));await l.showTimNotificationModal()}catch(l){console.error("âŒ Error showing notifications modal from mobile sidebar:",l),xi(l.message)}}));const s=document.getElementById("tim-toggleNotificationsBtn");s&&(console.log("ðŸ”” Found toggle notification button"),s.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸ”„ Toggle notification button clicked");try{s.disabled=!0;const l=s.innerHTML;s.innerHTML=`
          <span class="spinner-border spinner-border-sm me-2"></span>
          Memproses...
        `;const{timNotifications:r}=await Pe(async()=>{const{timNotifications:d}=await import("./timNotifications-BGXkaiyb.js");return{timNotifications:d}},__vite__mapDeps([0,1,2]));await r.toggleNotifications()&&(console.log("âœ… Notifications toggled successfully"),setTimeout(()=>{const d=s.innerHTML.includes("Nonaktifkan");s.innerHTML=d?'<i class="bi bi-bell me-2"></i>Aktifkan':'<i class="bi bi-bell-slash me-2"></i>Nonaktifkan'},100))}catch(l){console.error("âŒ Error toggling notifications:",l),alert("Gagal mengubah pengaturan notifikasi: "+l.message)}finally{setTimeout(()=>{s.disabled=!1},1e3)}}));const n=document.getElementById("tim-toggleNotificationsBtn-mobile");n&&(console.log("ðŸ“± Found mobile sidebar toggle notification button"),n.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("ðŸ”„ Mobile sidebar toggle notification button clicked"),js();try{const{timNotifications:l}=await Pe(async()=>{const{timNotifications:r}=await import("./timNotifications-BGXkaiyb.js");return{timNotifications:r}},__vite__mapDeps([0,1,2]));await l.toggleNotifications()}catch(l){console.error("âŒ Error toggling notifications from mobile sidebar:",l),alert("Gagal mengubah pengaturan notifikasi: "+l.message)}})),console.log("âœ… All event listeners setup complete")}function xi(e=""){console.log("ðŸªŸ Showing fallback notification modal...");const a=`
    <div class="modal fade show" id="fallbackNotificationModal" tabindex="-1" 
         style="display: block; background-color: rgba(0,0,0,0.5); z-index: 1060;" 
         aria-modal="true" role="dialog">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="bi bi-bell me-2"></i>Notifikasi Tim
            </h5>
            <button type="button" class="btn-close btn-close-white" 
                    onclick="document.getElementById('fallbackNotificationModal').remove()"></button>
          </div>
          <div class="modal-body">
            <div class="text-center py-3">
              <div class="text-success mb-3" style="font-size: 3rem;">
                <i class="bi bi-bell"></i>
              </div>
              <h5>${e||"Sistem Notifikasi"}</h5>
              
              <div class="alert alert-info mt-4">
                <h6><i class="bi bi-info-circle me-2"></i>Informasi Notifikasi:</h6>
                <div class="mt-2">
                  <p class="mb-1"><strong>ðŸ“… Jadwal Besok:</strong> 3 lokasi pengangkutan</p>
                  <p class="mb-1"><strong>ðŸ”„ Dalam Proses:</strong> 2 pengangkutan</p>
                  <p class="mb-1"><strong>âœ… Selesai Hari Ini:</strong> 5 pengangkutan</p>
                  <hr class="my-2">
                  <p class="mb-0 small text-muted">
                    <i class="bi bi-clock me-1"></i>
                    Terakhir diperbarui: ${new Date().toLocaleTimeString("id-ID")}
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" 
                    onclick="document.getElementById('fallbackNotificationModal').remove()">
              Tutup
            </button>
            <button type="button" class="btn btn-success" 
                    onclick="location.reload()">
              <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </button>
          </div>
        </div>
      </div>
    </div>
  `,t=document.getElementById("fallbackNotificationModal");t&&t.remove();const i=document.getElementById("modalContainer");if(i)i.innerHTML=a;else{const s=document.createElement("div");s.id="modalContainer",s.innerHTML=a,document.body.appendChild(s)}}async function Fm(){try{console.log("ðŸ”” Setting up Tim notifications...");const{timNotifications:e}=await Pe(async()=>{const{timNotifications:a}=await import("./timNotifications-BGXkaiyb.js");return{timNotifications:a}},__vite__mapDeps([0,1,2]));await e.setupDashboardIntegration(),console.log("âœ… Tim notifications setup complete"),setTimeout(()=>{e.checkTomorrowSchedule()},2e3)}catch(e){console.error("âŒ Error setting up tim notifications:",e),setTimeout(()=>{console.log("ðŸ”„ Setting up fallback notification system");const a=document.getElementById("tim-notification-badge-mobile");a&&(a.textContent="!",a.style.display="block",a.style.backgroundColor="#ffc107")},100)}}let St=null;async function Hm(e,a,t=null){if(!e||!e.id){P("Akses Ditolak","User tidak valid. Silakan login ulang."),window.location.hash="#/login";return}const i=localStorage.getItem("access");if(!i){P("Session Expired",`
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; color: #ff9800; margin-bottom: 20px;">âš ï¸</div>
                <h3 style="color: #c62828; margin-bottom: 10px;">Session Expired</h3>
                <p style="color: #666; margin-bottom: 20px;">Silakan login kembali untuk melanjutkan.</p>
                <button onclick="window.location.hash='#/login'" 
                        style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    Login Kembali
                </button>
            </div>
        `,null,null);return}let s=e.username;try{const o=await fetch(`${b.users}${e.id}/`,{headers:{Authorization:`Bearer ${i}`,Accept:"application/json"}});if(o.ok){const l=await o.json();s=l.first_name||l.username||e.username}}catch(o){console.error("Error fetching user data:",o)}const n=`
        <div id="formLaporanModalContent">
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 20px;">
                    <i class="bi bi-info-circle" style="color: #2196F3; margin-right: 5px;"></i>
                    Laporkan lokasi sampah untuk membantu kebersihan Kota Kupang
                </p>
            </div>
            
            <!-- INFO JENIS LIMBAH -->
            <div class="alert alert-info mb-4" style="border-left: 4px solid #17a2b8;">
                <div class="d-flex align-items-start">
                    <i class="bi bi-info-circle-fill me-2" style="color: #17a2b8; font-size: 1.2rem;"></i>
                    <div>
                        <h6 class="alert-heading mb-2" style="color: #0c5460;">
                            <i class="bi bi-trash me-1"></i>Informasi Jenis Sampah
                        </h6>
                        <div class="row small g-2">
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-danger me-2" style="font-size: 0.7rem;">B3</span>
                                    <span><strong>Limbah B3 (Berbahaya & Beracun)</strong></span>
                                </div>
                                <p class="mb-2 ps-4" style="font-size: 0.85rem; color: #495057;">
                                    â€¢ Baterai, aki, elektronik rusak<br>
                                    â€¢ Sisa cat, oli, bahan kimia<br>
                                    â€¢ Obat kadaluarsa, pestisida
                                </p>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-warning me-2" style="font-size: 0.7rem;">PLASTIK</span>
                                    <span><strong>Sampah Plastik</strong></span>
                                </div>
                                <p class="mb-2 ps-4" style="font-size: 0.85rem; color: #495057;">
                                    â€¢ Botol, kemasan plastik<br>
                                    â€¢ Kantong kresek, sedotan<br>
                                    â€¢ Peralatan plastik rusak
                                </p>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-success me-2" style="font-size: 0.7rem;">ORGANIK</span>
                                    <span><strong>Sampah Organik</strong></span>
                                </div>
                                <p class="mb-2 ps-4" style="font-size: 0.85rem; color: #495057;">
                                    â€¢ Sisa makanan, sayuran<br>
                                    â€¢ Daun, ranting, rumput<br>
                                    â€¢ Kotoran hewan ternak
                                </p>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-primary me-2" style="font-size: 0.7rem;">LOGAM</span>
                                    <span><strong>Sampah Logam</strong></span>
                                </div>
                                <p class="mb-2 ps-4" style="font-size: 0.85rem; color: #495057;">
                                    â€¢ Kaleng minuman, besi<br>
                                    â€¢ Peralatan rumah tangga<br>
                                    â€¢ Kawat, rangka besi
                                </p>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-secondary me-2" style="font-size: 0.7rem;">KACA</span>
                                    <span><strong>Sampah Kaca</strong></span>
                                </div>
                                <p class="mb-2 ps-4" style="font-size: 0.85rem; color: #495057;">
                                    â€¢ Botol kaca, beling<br>
                                    â€¢ Kaca jendela/piring<br>
                                    â€¢ Lampu bohlam/neon
                                </p>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-info me-2" style="font-size: 0.7rem;">KERTAS</span>
                                    <span><strong>Sampah Kertas</strong></span>
                                </div>
                                <p class="mb-2 ps-4" style="font-size: 0.85rem; color: #495057;">
                                    â€¢ Koran, kardus, karton<br>
                                    â€¢ Buku, majalah, dokumen<br>
                                    â€¢ Kemasan kertas
                                </p>
                            </div>
                        </div>
                        <hr class="my-2">
                        <p class="mb-0 small text-muted">
                            <i class="bi bi-lightbulb me-1"></i>
                            <strong>Tips:</strong> Sebutkan jenis sampah dalam deskripsi untuk membantu analisis dampak lingkungan
                        </p>
                    </div>
                </div>
            </div>
            
            <form id="formLaporan">
                <!-- Loading untuk peta -->
                <div id="mapLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Menyiapkan peta...</p>
                </div>
                
                <!-- Nama dan Tanggal -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-person me-1"></i>Nama Pelapor
                        </label>
                        <input type="text" class="form-control" id="nama" value="${s}" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar me-1"></i>Tanggal Laporan
                        </label>
                        <input type="text" class="form-control" id="tanggal" value="${new Date().toLocaleDateString("id-ID")}" readonly>
                    </div>
                </div>

                <!-- Alamat -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-house-door me-1"></i>Kelurahan Lokasi Sampah
                    </label>
                    <input type="text" class="form-control" id="alamat" 
                        placeholder="Contoh: Kelurahan Oebobo" required>
                </div>

                <!-- Deskripsi dengan contoh yang lebih jelas -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-chat-text me-1"></i>Deskripsi Sampah
                    </label>
                    <textarea class="form-control" id="deskripsi" rows="3"
                            placeholder="Contoh: 'Tumpukan sampah plastik (botol, kresek) di pinggir jalan, volume sekitar 1mÂ³, dekat saluran air'
                            atau 'Limbah B3 (baterai bekas, aki) dibuang sembarangan di tanah kosong'
                            
                            Mohon sebutkan: 
                            1. Jenis sampah (plastik/organik/logam/kaca/B3/dll)
                            2. Perkiraan volume/banyaknya
                            3. Kondisi sekitar (berbau, mengganggu jalan, dll)" required></textarea>
                    <div class="form-text small">
                        <i class="bi bi-info-circle"></i> Sebutkan jenis sampah dengan jelas untuk membantu analisis dampak lingkungan
                    </div>
                </div>
                
                <!-- Peta -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-map me-1"></i>Lokasi di Peta
                    </label>
                    <div class="alert alert-info py-2 mb-2">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            Klik pada peta untuk menentukan lokasi sampah
                        </small>
                    </div>
                    <div id="mapForm" style="height: 250px; width: 100%; border-radius: 6px; border: 1px solid #ced4da;"></div>
                    <!-- Tombol GPS -->
                    <div class="mb-3">
                        <button type="button" id="btnGetLocation" class="btn btn-outline-primary w-100">
                            ðŸ“ Gunakan Lokasi Saya (GPS)
                        </button>
                        <small class="text-muted d-block mt-1">
                            Izinkan akses lokasi pada browser Anda
                        </small>
                    </div>
                </div>

                <!-- Koordinat -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-geo-alt me-1"></i>Latitude
                        </label>
                        <input type="number" step="0.00000001" class="form-control" id="latitude" 
                            placeholder="-10.1935921" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-geo-alt me-1"></i>Longitude
                        </label>
                        <input type="number" step="0.00000001" class="form-control" id="longitude" 
                            placeholder="123.6149376" required>
                    </div>
                </div>

                <!-- Foto -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="bi bi-camera me-1"></i>Foto Bukti
                    </label>
                    <input type="file" class="form-control" id="foto_bukti" accept="image/*" required>
                    <div class="form-text text-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Foto bukti <strong>wajib</strong> sebagai acuan validitas laporan
                    </div>
                    
                    <!-- Preview -->
                    <div id="previewContainer" class="mt-2" style="display: none;">
                        <div class="card">
                            <div class="card-body p-2">
                                <p class="small mb-1"><strong>Pratinjau:</strong></p>
                                <img id="imagePreview" class="img-fluid rounded" style="max-height: 150px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status koordinat -->
                <div id="coordinatesAlert" class="alert alert-warning" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="coordinatesMessage">Silakan pilih lokasi di peta terlebih dahulu!</span>
                </div>

                <!-- Pesan -->
                <div id="formMessage" class="mt-3"></div>
            </form>
        </div>
    `;window.__onLaporanSuccess=t,P("ðŸ“ Buat Laporan Sampah Baru",n,async()=>await Gm(e),()=>{window.__formLaporanMap&&(window.__formLaporanMap.remove(),delete window.__formLaporanMap),delete window.__onLaporanSuccess}),setTimeout(()=>{const o=-10.1935921,l=123.6149376;document.getElementById("latitude").value=o,document.getElementById("longitude").value=l,ai("mapForm","latitude","longitude",o,l).then(u=>{window.__formLaporanMap=u,setTimeout(()=>{u.invalidateSize()},300)}).catch(u=>{console.error("Gagal inisialisasi peta:",u)});const r=document.getElementById("btnGetLocation");r?r.addEventListener("click",async()=>{if(!("geolocation"in navigator)){Ie("âŒ Browser Anda tidak mendukung GPS","error");return}r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mencari lokasi...',Ie("ðŸ” Mencari sinyal GPS... Mohon tunggu","info");try{const u=await Um(15e3),{latitude:g,longitude:p,accuracy:h}=u.coords;let f="";h>100&&(f=`âš ï¸ Akurasi GPS rendah (Â±${Math.round(h)} m).`);const k=document.getElementById("latitude"),w=document.getElementById("longitude");if(k&&w&&(k.value=g.toFixed(7),w.value=p.toFixed(7)),window.__formLaporanMap){const $=window.__formLaporanMap;$.setView([g,p],17),St?St.setLatLng([g,p]):St=L.marker([g,p],{icon:L.divIcon({className:"gps-marker",html:'<div style="background: #4CAF50; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo($),St.bindPopup(`
                            <strong>ðŸ“ Lokasi Anda (GPS)</strong><br>
                            Lat: ${g.toFixed(6)}<br>
                            Lng: ${p.toFixed(6)}<br>
                            Akurasi: Â±${Math.round(h)} m
                        `).openPopup(),setTimeout(()=>{$.invalidateSize()},200)}Ie(`âœ… Lokasi berhasil ditemukan<br>
                        <small>Lat: ${g.toFixed(6)}, Lng: ${p.toFixed(6)}<br>
                        ${f} ${f?"Coba pindah ke area terbuka.":""}</small>`,"success"),window.locationFromGPS=!0}catch(u){let g="âŒ Gagal mengambil lokasi",p="error";switch(u.code||u.name){case 1:case"PERMISSION_DENIED":g=`
                                âŒ Izin lokasi ditolak<br>
                                <small>Silakan:</small><br>
                                1. Klik ikon <strong>ðŸ”’</strong> di address bar<br>
                                2. Izinkan akses lokasi<br>
                                3. Coba lagi
                            `;break;case 2:case"POSITION_UNAVAILABLE":g="âŒ GPS tidak tersedia. Pastikan GPS diaktifkan pada perangkat Anda.";break;case 3:case"TIMEOUT":g=`
                                â±ï¸ Pencarian lokasi timeout<br>
                                <small>Tips:</small><br>
                                1. Buka jendela/keluar dari gedung<br>
                                2. Pastikan sinyal GPS aktif<br>
                                3. Coba aktifkan High Accuracy Mode<br>
                                4. Tunggu beberapa detik lalu coba lagi
                            `,p="warning";break;case"TimeoutError":g="â±ï¸ Pencarian terlalu lama. Pastikan Anda di area terbuka dengan sinyal GPS baik.",p="warning";break;default:g=`âŒ Error: ${u.message||"Tidak diketahui"}`}Ie(g,p),(u.code===3||u.name==="TIMEOUT"||u.name==="TimeoutError")&&setTimeout(()=>{Ie("ðŸ’¡ <strong>Alternatif:</strong> Anda bisa klik langsung di peta untuk menentukan lokasi","info")},3e3)}finally{r.disabled=!1,r.innerHTML='<i class="bi bi-geo-alt me-1"></i>Gunakan Lokasi Saya (GPS)'}}):console.warn("Tombol btnGetLocation tidak ditemukan di DOM"),document.getElementById("foto_bukti").onchange=function(u){const g=u.target.files[0],p=document.getElementById("previewContainer"),h=document.getElementById("imagePreview");if(g){if(g.size>5*1024*1024){Ie("Ukuran file maksimal 5MB","error"),u.target.value="";return}const f=new FileReader;f.onload=function(k){h.src=k.target.result,p.style.display="block"},f.readAsDataURL(g)}else p.style.display="none"};const c=document.getElementById("latitude"),d=document.getElementById("longitude"),m=()=>{const u=c.value,g=d.value,p=document.getElementById("coordinatesAlert"),h=document.getElementById("coordinatesMessage");u&&g?(p.className="alert alert-success",p.style.display="block",h.innerHTML=`
                    <strong>Lokasi terpilih:</strong> ${parseFloat(u).toFixed(6)}, ${parseFloat(g).toFixed(6)}
                `):(p.className="alert alert-warning",p.style.display="block",h.textContent="Silakan pilih lokasi di peta terlebih dahulu!")};c.addEventListener("input",m),d.addEventListener("input",m),m()},100)}function Um(e=1e4){return new Promise((a,t)=>{if(!navigator.geolocation){t(new Error("Geolocation tidak didukung"));return}let i=null,s=!1;const n=r=>{if(!s){if(s=!0,i&&clearTimeout(i),!r.coords||typeof r.coords.latitude!="number"||typeof r.coords.longitude!="number"){t(new Error("Data GPS tidak valid"));return}a(r)}},o=r=>{s||(s=!0,i&&clearTimeout(i),t(r))},l={enableHighAccuracy:!0,timeout:e,maximumAge:0};navigator.geolocation.getCurrentPosition(n,o,l),i=setTimeout(()=>{s||(s=!0,t(new Error("TimeoutError")))},e+2e3)})}async function Gm(e){var h,f,k,w,$;console.log("=== SUBMIT LAPORAN STARTED ===");const a=localStorage.getItem("access");if(!a)return Ie("Session expired. Silakan login kembali.","error"),setTimeout(()=>window.location.hash="#/login",2e3),!1;Jm();const t=(h=document.getElementById("alamat"))==null?void 0:h.value.trim(),i=(f=document.getElementById("latitude"))==null?void 0:f.value,s=(k=document.getElementById("longitude"))==null?void 0:k.value,n=(w=document.getElementById("deskripsi"))==null?void 0:w.value.trim(),o=($=document.getElementById("foto_bukti"))==null?void 0:$.files[0];console.log("Form values:",{alamat:t,latitude:i,longitude:s,deskripsi:n,foto:o});let l=!0;t||(ka("alamat","Alamat harus diisi"),l=!1);const r=i&&s&&!isNaN(i)&&!isNaN(s),c=r&&i>=-90&&i<=90&&s>=-180&&s<=180;if(r?c||(ka("latitude","Koordinat tidak valid"),l=!1):(ka("latitude","Silakan tentukan lokasi di peta"),l=!1),n?n.length<10&&(ka("deskripsi","Deskripsi minimal 10 karakter"),l=!1):(ka("deskripsi","Deskripsi harus diisi"),l=!1),o?(o.size>5*1024*1024&&(ka("foto_bukti","Ukuran file maksimal 5MB"),l=!1),["image/jpeg","image/png","image/jpg"].includes(o.type)||(ka("foto_bukti","Format file harus JPG, JPEG, atau PNG"),l=!1)):(ka("foto_bukti","Foto bukti wajib diunggah sebagai acuan validitas laporan"),l=!1),!l)return console.log("Validation failed"),Ve("Harap perbaiki field yang masih error","error"),!1;console.log("Validation passed, preparing form data...");const d=new FormData;d.append("nama",document.getElementById("nama").value),d.append("alamat",t),d.append("latitude",parseFloat(i)),d.append("longitude",parseFloat(s)),d.append("deskripsi",n),d.append("tanggal_lapor",new Date().toISOString().split("T")[0]),d.append("idUser",parseInt(e.id)),d.append("status","pending"),d.append("foto_bukti",o);let m=null;const u=document.querySelectorAll('button[id*="saveModalBtn"]');if(u.length>0&&(m=u[0]),m||document.querySelectorAll(".modal-footer button").forEach(A=>{A.textContent.includes("Simpan")&&!m&&(m=A,console.log("Found button by text:",A.textContent))}),!m){const y=document.querySelector(".modal-footer .btn-primary");y&&(m=y,console.log("Found primary button in modal footer"))}if(!m){console.log("Debug - All buttons in modal:");const y=document.querySelector(".modal.show");y&&y.querySelectorAll("button").forEach(A=>{console.log(`- Button: text="${A.textContent}", id="${A.id}", class="${A.className}"`)})}if(!m)return console.error("Tombol simpan TIDAK DITEMUKAN!"),Ve("System error: Tombol tidak ditemukan","error"),!1;console.log("Submit button found:",m);const g=m.innerHTML,p=m.disabled;m.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mengirim...',m.disabled=!0;try{console.log("Sending request to:",b.laporanSampah);const y=await fetch(b.laporanSampah,{method:"POST",headers:{Authorization:`Bearer ${a}`},body:d}),A=await y.text();console.log("Response text (first 200 chars):",A.substring(0,200));let E;try{E=JSON.parse(A),console.log("Parsed data:",E)}catch{console.log("Response is not JSON"),E={message:A}}if(!y.ok){let B={},I="Gagal mengirim laporan";if(E.detail)I=E.detail;else if(typeof E=="object")for(const[D,U]of Object.entries(E))if(Array.isArray(U)){const da=Rm(D);da?B[da]=U.join(", "):I=`${D}: ${U.join(", ")}`}else I=`${D}: ${U}`;throw Object.keys(B).forEach(D=>{ka(D,B[D])}),Object.keys(B).length===0&&Ve(I,"error"),new Error(`HTTP ${y.status}: ${I}`)}console.log("Submission successful!"),alert("âœ… Laporan berhasil dikirim!"),Ve("âœ… Laporan berhasil dikirim!","success"),x("Laporan berhasil dikirim. Terima kasih atas partisipasi Anda!","success");const C=window.__onLaporanSuccess;return C&&typeof C=="function"&&setTimeout(()=>{try{C()}catch(B){console.error("Error in success callback:",B)}},1500),setTimeout(()=>{m.innerHTML=g,m.disabled=p,setTimeout(()=>{const B=document.querySelector(".modal.show");if(B){const I=bootstrap.Modal.getInstance(B);if(I)I.hide();else{B.style.display="none",document.body.classList.remove("modal-open");const D=document.querySelector(".modal-backdrop");D&&D.remove()}}},2e3)},1e3),!0}catch(y){return console.error("Error submitting report:",y),m.innerHTML=g,m.disabled=p,y.message.includes("401")||y.message.includes("Unauthorized")?(Ve("Session expired. Silakan login kembali.","error"),localStorage.clear(),setTimeout(()=>window.location.hash="#/login",2e3)):y.message.includes("Gagal mengirim laporan")||Ve(`âŒ ${y.message}`,"error"),!1}finally{console.log("=== SUBMIT LAPORAN FINISHED ===")}}function ka(e,a){const t=document.getElementById(e);if(!t)return;t.classList.add("is-invalid"),t.classList.remove("is-valid");const i=t.parentNode.querySelector(`#${e}-feedback`);i&&i.remove();const s=document.createElement("div");s.id=`${e}-feedback`,s.className="invalid-feedback d-block",s.innerHTML=`
        <i class="bi bi-exclamation-circle me-1"></i>
        ${a}
    `,t.parentNode.appendChild(s),t.scrollIntoView({behavior:"smooth",block:"center"})}function Li(e,a){const t=document.getElementById(e);if(!t)return;t.classList.add("is-valid"),t.classList.remove("is-invalid");const i=t.parentNode.querySelector(`#${e}-feedback`);i&&i.remove();const s=document.createElement("div");s.id=`${e}-feedback`,s.className="valid-feedback d-block",s.innerHTML=`
        <i class="bi bi-check-circle me-1"></i>
        ${a}
    `,t.parentNode.appendChild(s)}function Jm(){const e=document.getElementById("formLaporan");if(!e){console.warn("Form dengan ID 'formLaporan' tidak ditemukan");return}e.querySelectorAll("input, textarea, select").forEach(s=>{s.classList.remove("is-invalid","is-valid");const n=`${s.id}-feedback`,o=document.getElementById(n);o&&o.remove();const l=s.parentNode.querySelector(".invalid-feedback");l&&l.remove();const r=s.parentNode.querySelector(".valid-feedback");r&&r.remove()});const t=document.getElementById("formGeneralMessage");t&&(t.innerHTML="",t.className="");const i=document.getElementById("formMessage");i&&(i.innerHTML="",i.className="")}function Ve(e,a="info"){const t=document.getElementById("formGeneralMessage")||(()=>{const i=document.createElement("div");i.id="formGeneralMessage";const s=document.querySelector("#formLaporanModal form, #formLaporanForm");return s&&s.insertBefore(i,s.firstChild),i})();t.innerHTML="",t.className=`alert alert-${a==="error"?"danger":a==="success"?"success":"info"} alert-dismissible fade show mt-2`,t.innerHTML=`
        <div class="d-flex align-items-center">
            <i class="bi ${a==="error"?"bi-exclamation-triangle":a==="success"?"bi-check-circle":"bi-info-circle"} me-2"></i>
            <div>${e}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `,a==="info"&&setTimeout(()=>{t.textContent.includes(e)&&(t.innerHTML="",t.className="")},5e3),t.scrollIntoView({behavior:"smooth",block:"start"})}function Rm(e){return{nama:"nama",alamat:"alamat",latitude:"latitude",longitude:"longitude",deskripsi:"deskripsi",foto_bukti:"foto_bukti",idUser:"idUser"}[e]||e.toLowerCase()}function zm(){const e=document.getElementById("alamat"),a=document.getElementById("deskripsi"),t=document.getElementById("foto_bukti");e&&e.addEventListener("blur",function(){const i=this.value.trim();i?i.length<10?ka("alamat","Alamat minimal 10 karakter"):Li("alamat","Alamat valid"):ka("alamat","Alamat harus diisi")}),a&&a.addEventListener("blur",function(){const i=this.value.trim();i?i.length<10?ka("deskripsi","Deskripsi minimal 10 karakter"):Li("deskripsi","Deskripsi valid"):ka("deskripsi","Deskripsi harus diisi")}),t&&t.addEventListener("change",function(i){const s=i.target.files[0];if(s){if(s.size>5*1024*1024){ka("foto_bukti","Ukuran file maksimal 5MB"),i.target.value="";return}if(!["image/jpeg","image/png","image/jpg"].includes(s.type)){ka("foto_bukti","Format file harus JPG, JPEG, atau PNG"),i.target.value="";return}Li("foto_bukti","File valid")}})}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("formLaporanModal");e&&e.addEventListener("shown.bs.modal",function(){setTimeout(()=>{zm()},500)})});function Ie(e,a="info"){const t=document.getElementById("formMessage");t&&(t.innerHTML="",t.className=`alert alert-${a==="error"?"danger":a==="success"?"success":"info"} mt-3`,t.innerHTML=`
        <div class="d-flex align-items-center">
            ${a==="error"?"âŒ":a==="success"?"âœ…":"â„¹ï¸"}
            <span class="ms-2">${e}</span>
        </div>
    `,a==="info"&&setTimeout(()=>{t.textContent===e&&(t.innerHTML="",t.className="")},5e3))}async function wo(){const e=document.getElementById("app"),a=await Da();if(!a){alert("Silakan login terlebih dahulu!"),window.location.hash="#/login";return}if(e.innerHTML=`
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="container-fluid" style="max-width: 1300px; margin: 0 auto; padding: 0 15px;">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="#/dashboard">
                <!-- LOGO CLEANUP KUPANG -->
                <div class="d-flex align-items-center">
                    <img src="/logo/logo_3d.png" 
                         alt="CleanUp Kupang Logo" 
                         style="height: 40px; width: auto; margin-right: 10px;">
                    <span>CleanUp Kupang</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#/dashboard">
                            <i class="bi bi-house-door me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="btnBuatLaporanNav" href="#/buat-laporan">
                            <i class="bi bi-list-check me-1"></i>Buat Laporan Sampah
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#/upgrade-anggota">
                            <i class="bi bi-star-fill me-1"></i>Upgrade Anggota
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#/analisis-dampak">
                            <i class="bi bi-graph-up me-1"></i> Analisis Sistem
                        </a>
                    </li>
                    <!-- Menu Bantuan dan Tentang dihapus sesuai permintaan -->
                </ul>
                <div class="navbar-nav">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <div class="bg-light rounded-circle p-2 me-2">
                                <i class="bi bi-person text-success"></i>
                            </div>
                            <div class="d-flex flex-column">
                                <span class="fw-bold">${a.username}</span>
                                <small class="text-white opacity-75">${a.role}</small>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" onclick="showProfileModal(); return false;">
                                <i class="bi bi-person-gear me-2"></i>Lihat Profil
                            </a></li>
                            
                            <!-- Tambahkan notifikasi dropdown -->
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="#" id="tamu-toggleNotificationsBtn">
                                    <i class="bi bi-bell-slash me-2" id="tamu-bellIcon"></i>
                                    <span id="tamu-bellText">Aktifkan Notifikasi</span>
                                </a>
                            </li>

                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" id="navLogout">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div style="margin: 5px auto; max-width: 1300px; padding: 0 10px;">
        <!-- Welcome Card dengan informasi CleanUp -->
        <div class="bg-success text-white p-4 rounded-3 mb-4 mt-3 shadow-sm" style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-2 fw-bold">
                        <i class="bi bi-house-door me-2"></i>Dashboard Tamu
                    </h1>
                    <p class="mb-0 opacity-90">
                        Selamat datang kembali, <b class="text-warning">${a.username}</b>! 
                        Anda masuk sebagai <b class="text-warning">${a.role}</b>.
                    </p>
                    <small class="d-block mt-2">
                        <i class="bi bi-quote me-1"></i>
                        <em>ðŸš® INGAT SAMPAH INGAT CleanUp</em>
                    </small>
                </div>
                <div class="d-flex gap-2">
                    <button id="btnBuatLaporanHeader" class="btn btn-warning btn-sm">
                        <i class="bi bi-plus-circle me-1"></i> Buat Laporan
                    </button>
                </div>
            </div>
        </div>

        <!-- Banner Informasi CleanUp DENGAN LOGO -->
        <div class="card mb-4 shadow-sm" style="border-left: 5px solid #2e7d32;">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center mb-3 mb-md-0">
                        <!-- LOGO CLEANUP di Banner -->
                        <div class="bg-success p-3 rounded-circle d-inline-block">
                            <img src="/logo/logo_3d.png" 
                                 alt="CleanUp Kupang Logo" 
                                 style="height:60px; object-fit:contain;">
                        </div>
                    </div>
                    <div class="col-md-10">
                        <h4 class="card-title text-success mb-2">
                            <strong>CleanUp Kupang</strong> - Jasa Angkut Sampah Depan Rumah Anda
                        </h4>
                        <p class="card-text mb-2">
                            <i class="bi bi-quote text-success me-1"></i>
                            Kami mulai dari kesadaran kami melihat <strong>SAMPAH KOTA KUPANG</strong> yang semakin parah setiap hari.
                            <strong class="text-danger">EST 2025</strong>
                        </p>
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            <span class="badge bg-success">"Kaka Buang, Beta Angkut"</span>
                            <span class="badge bg-warning text-dark">Sampah dibuang langsung ke TPA</span>
                            <span class="badge bg-info">Tanpa menumpuk di kotak sampah</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card border-success shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-map text-success fs-3"></i>
                            </div>
                            <div>
                                <h5 class="card-title text-muted small mb-1">Laporan Aktif</h5>
                                <h2 class="card-text text-success mb-0 fw-bold" id="activeReports">0</h2>
                                <small class="text-muted">di peta saat ini</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="bg-info bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-check-circle text-info fs-3"></i>
                            </div>
                            <div>
                                <h5 class="card-title text-muted small mb-1">Laporan Selesai</h5>
                                <h2 class="card-text text-info mb-0 fw-bold" id="completedReports">0</h2>
                                <small class="text-muted">telah ditangani</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-clock-history text-warning fs-3"></i>
                            </div>
                            <div>
                                <h5 class="card-title text-muted small mb-1">Dalam Proses</h5>
                                <h2 class="card-text text-warning mb-0 fw-bold" id="pendingReports">0</h2>
                                <small class="text-muted">menunggu penanganan</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Peta Laporan Sampah -->
        <div class="card mb-4 border-success shadow-sm">
            <div class="card-header bg-success text-white d-flex align-items-center">
                <i class="bi bi-map me-2 fs-5"></i>
                <h2 class="card-title h5 mb-0 fw-bold">Peta Laporan Sampah Kota Kupang</h2>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Peta interaktif menunjukkan lokasi-lokasi laporan sampah di Kota Kupang
                    </p>
                    <div class="d-flex gap-2">
                        <button onclick="refreshMapMarkers()" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh Peta
                        </button>
                    </div>
                </div>
                <div id="map" style="height: 500px; border-radius: 8px; overflow: hidden; border: 1px solid #dee2e6;"></div>
            </div>
        </div>

        <!-- Tombol Utama -->
        <div class="d-grid mb-4">
            <button id="btnBuatLaporanUtama" class="btn btn-success btn-lg py-3 shadow" 
                    style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); border: none;">
                <i class="bi bi-plus-circle me-2"></i> Buat Laporan Sampah Baru
            </button>
        </div>

        <!-- Form Container -->
        <div id="formContainer"></div>

        <!-- Daftar Laporan Sampah Terbaru DENGAN PAGINATION -->
        <div class="card mb-4 border-success shadow-sm">
            <div class="card-header bg-success text-white d-flex align-items-center">
                <i class="bi bi-list-ul me-2 fs-5"></i>
                <h2 class="card-title h5 mb-0 fw-bold">Laporan Terbaru</h2>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Daftar laporan sampah terbaru yang dibuat oleh warga (10 laporan per halaman)
                    </p>
                    <div class="d-flex gap-2">
                        <button onclick="loadLaporanGrid(1)" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                        <a href="#/semua-laporan" class="btn btn-success btn-sm">
                            <i class="bi bi-list-stars me-1"></i> Lihat Semua
                        </a>
                    </div>
                </div>
                <div id="laporanGrid" class="row g-3"></div>
                
                <!-- Pagination Controls -->
                <div class="row mt-4">
                    <div class="col-12">
                        <nav aria-label="Laporan pagination">
                            <ul class="pagination justify-content-center mb-0" id="laporanPagination">
                                <!-- Pagination akan diisi oleh JavaScript -->
                            </ul>
                        </nav>
                        <div class="text-center mt-2">
                            <small class="text-muted" id="paginationInfo">Menampilkan 0-0 dari 0 laporan</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upgrade Banner dengan informasi lengkap CleanUp -->
        <div class="card mb-4 shadow-sm"
        style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
                color: white; border: none; cursor: pointer;"
        onclick="window.location.hash = '#/upgrade-anggota'">
            <div class="card-body">
                <h2 class="card-title h4 mb-3 fw-bold">
                    <i class="bi bi-gem me-2"></i> Upgrade ke Anggota CleanUp Kupang
                </h2>
                <p class="mb-3">
                    ðŸ˜ðŸ¥³ Hallo Bapa, Mama, Kaka, Adik semua! Nikmati kemudahan layanan angkut sampah 
                    dengan menjadi anggota CleanUp Kupang. Hanya <b class="text-warning">Rp 50.000/bulan</b>, 
                    Anda sudah berkontribusi menjaga kebersihan kota.
                </p>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="bg-success bg-opacity-10 p-3 rounded-3 h-100 border border-success border-opacity-25">
                            <h5 class="mb-2 text-dark fw-bold">
                                <i class="bi bi-check-circle-fill text-success me-2"></i> 4x Angkut/Bulan
                            </h5>
                            <p class="mb-0 small text-dark">Layanan dijemput langsung di depan rumah Anda</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-warning bg-opacity-10 p-3 rounded-3 h-100 border border-warning border-opacity-25">
                            <h5 class="mb-2 text-dark fw-bold">
                                <i class="bi bi-currency-exchange text-warning me-2"></i> Rp 50.000
                            </h5>
                            <p class="mb-0 small text-dark">Biaya terjangkau untuk lingkungan bersih</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-success bg-opacity-10 p-3 rounded-3 h-100 border border-success border-opacity-25">
                            <h5 class="mb-2 text-dark fw-bold">
                                <i class="bi bi-tree-fill text-success me-2"></i> Kota Bersih
                            </h5>
                            <p class="mb-0 small text-dark">Berkontribusi untuk Kota Kupang yang lebih indah</p>
                        </div>
                    </div>
                </div>
                
                <!-- Informasi Keunggulan CleanUp -->
                <div class="alert alert-light mt-4" style="background: rgba(255,255,255,0.9);">
                    <h6 class="fw-bold text-success mb-3">
                        <i class="bi bi-star-fill me-2"></i>Mengapa harus CleanUp Kupang?
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start mb-2">
                                <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                                    <i class="bi bi-award text-success"></i>
                                </div>
                                <div>
                                    <small class="fw-semibold text-dark">Sertifikasi dan Izin</small>
                                    <p class="mb-0 small">CleanUp memiliki sertifikasi dan izin resmi untuk pengangkutan sampah</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start mb-2">
                                <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                                    <i class="bi bi-building text-success"></i>
                                </div>
                                <div>
                                    <small class="fw-semibold text-dark">Turut Membangun Daerah</small>
                                    <p class="mb-0 small">Bergabung bersama CleanUp, Anda ikut membayar Retribusi daerah (Perda No. 1 Tahun 2024)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start mb-2">
                                <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                                    <i class="bi bi-truck text-success"></i>
                                </div>
                                <div>
                                    <small class="fw-semibold text-dark">Armada Memadai</small>
                                    <p class="mb-0 small">CleanUp memiliki armada yang memadai dan terawat untuk mengangkut sampah</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start mb-2">
                                <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                                    <i class="bi bi-tree text-success"></i>
                                </div>
                                <div>
                                    <small class="fw-semibold text-dark">Pedili Lingkungan</small>
                                    <p class="mb-0 small">CleanUp berkomitmen mengurangi dampak lingkungan dari pengangkutan sampah</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Peringatan Sampah Menumpuk -->
                <div class="alert alert-warning mt-3" style="background: rgba(255,193,7,0.1); border-left: 4px solid #ffc107;">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle-fill text-warning fs-5 me-3"></i>
                        <div>
                            <h6 class="fw-bold mb-2 text-dark">Kasian kan kalo sampah sampai numpuk begini di komplek atau halaman kita?</h6>
                            <p class="mb-0 small text-dark">
                                Jangan biarkan sampah menumpuk! Bergabung dengan CleanUp untuk lingkungan yang lebih bersih dan sehat.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button id="btnUpgradeNow" class="btn btn-warning btn-lg px-5 shadow">
                        <i class="bi bi-star-fill me-2"></i> Upgrade Sekarang
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer dengan kontak CleanUp dan LOGO -->
        <div class="card border-success shadow-sm">
            <div class="card-header bg-success text-white d-flex align-items-center">
                <i class="bi bi-telephone me-2 fs-5"></i>
                <h2 class="card-title h5 mb-0 fw-bold">Kontak & Informasi CleanUp Kupang</h2>
            </div>
            <div class="card-body">
                <!-- Header Footer dengan Logo -->
                <div class="text-center mb-4">
                    <img src="/logo/logo_3d.png" 
                         alt="CleanUp Kupang Logo" 
                         style="height: 80px; width: auto; margin-bottom: 15px;">
                    <h4 class="text-success fw-bold mb-2">CleanUp Kupang</h4>
                    <p class="text-muted mb-0">Layanan Angkut Sampah Rumah Tangga Langsung ke TPA</p>
                </div>
                
                <!-- Kontak Utama -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                            <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-whatsapp text-success fs-4"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block fw-semibold">WhatsApp Langsung</small>
                                <strong class="text-dark">082-341-743-886</strong>
                                <p class="small text-muted mb-0 mt-1">Klik untuk chat langsung via WhatsApp</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                            <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-envelope text-success fs-4"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block fw-semibold">Email</small>
                                <strong class="text-dark">admin@cleanupkupang.id</strong>
                                <p class="small text-muted mb-0 mt-1">Untuk pertanyaan dan informasi</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sosial Media -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="bi bi-globe me-2"></i>Ikuti Kami di Sosial Media
                        </h6>
                        <div class="d-flex flex-wrap gap-3">
                            <!-- Instagram -->
                            <a href="https://instagram.com/cleanUp_officiall" target="_blank" class="btn btn-outline-success btn-sm d-flex align-items-center">
                                <i class="bi bi-instagram me-2"></i> @cleanUp_officiall
                            </a>
                            <!-- Facebook (Link diperbaiki) -->
                            <a href="https://facebook.com/CleanUpKupang" target="_blank" class="btn btn-outline-primary btn-sm d-flex align-items-center">
                                <i class="bi bi-facebook me-2"></i> CleanUp Kupang
                            </a>
                            <!-- TikTok (Ditambahkan) -->
                            <a href="https://www.tiktok.com/@cleanp.kupang5" target="_blank" class="btn btn-outline-dark btn-sm d-flex align-items-center">
                                <i class="bi bi-tiktok me-2"></i> @cleanp.kupang5
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Jam Operasional -->
                <div class="alert alert-success mt-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-clock-history me-2 fs-4"></i>
                        <div>
                            <strong class="d-block">Jam Operasional:</strong>
                            <span class="small">Senin - Rabu (08:00 - 18:00 WITA)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Motto dan Slogan -->
                <div class="text-center mt-4 p-3 bg-light rounded-3">
                    <h5 class="text-success fw-bold mb-2">
                        <i class="bi bi-quote me-2"></i>INGAT SAMPAH INGAT CLEANUP
                    </h5>
                    <p class="text-muted small mb-0">
                        "Kaka Buang, Beta Angkut" - Layanan angkut sampah rumah tangga langsung ke TPA
                    </p>
                    <div class="mt-3">
                        <span class="badge bg-success">CleanUp Kupang</span>
                        <span class="badge bg-warning text-dark">EST 2025</span>
                        <span class="badge bg-info">Jasa Angkut Sampah</span>
                    </div>
                </div>
                
                <!-- Footer Hak Cipta dengan Logo Kecil -->
                <div class="text-center mt-4 pt-3 border-top">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <img src="/logo/logo_3d.png" 
                             alt="CleanUp Kupang Logo" 
                             style="height: 30px; width: auto; margin-right: 10px;">
                        <p class="text-muted small mb-0">
                            &copy; 2025 CleanUp Kupang. Semua hak dilindungi undang-undang.
                        </p>
                    </div>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a href="#/syarat-ketentuan" class="text-success text-decoration-none small">Syarat & Ketentuan</a>
                        <a href="#/kebijakan-privasi" class="text-success text-decoration-none small">Kebijakan Privasi</a>
                        <a href="#/faq" class="text-success text-decoration-none small">FAQ</a>
                        <a href="#/tentang" class="text-success text-decoration-none small">Tentang Kami</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
`,!document.getElementById("modalContainer")){const i=document.createElement("div");i.id="modalContainer",document.body.appendChild(i)}Km(a),ba(()=>{qm()}),ci(1),setTimeout(xo,1500);async function t(){try{const{tamuNotifications:i}=await Pe(async()=>{const{tamuNotifications:s}=await import("./tamuNotifications-0geSIip8.js");return{tamuNotifications:s}},__vite__mapDeps([3,1,2]));await i.setupDashboardIntegration(),console.log("âœ… Tamu notifications setup complete")}catch(i){console.error("âŒ Error setting up tamu notifications:",i)}}setTimeout(()=>{t()},1e3)}async function Om(){const e=document.getElementById("tamu-bellIcon"),a=document.getElementById("tamu-bellText");if(!(!e||!a))try{await webPushManager.checkSubscription()?(e.className="bi bi-bell-fill me-2 text-warning",a.textContent="Nonaktifkan Notifikasi"):(e.className="bi bi-bell-slash me-2",a.textContent="Aktifkan Notifikasi")}catch(t){console.error("âŒ Gagal cek status notifikasi",t)}}document.addEventListener("DOMContentLoaded",Om);function Km(e){window.userData=e;const a=document.getElementById("navLogout");a&&(a.onclick=()=>{typeof window.logout=="function"?window.logout():(localStorage.clear(),window.location.hash="#/login",window.location.reload())});const t=document.getElementById("btnUpgradeNow");t&&(t.onclick=()=>{At(e)});const i=document.getElementById("btnEditTamu");i&&(i.onclick=()=>{window.location.hash="#/profile"});const s=document.getElementById("btnBuatLaporanUtama");s&&(s.onclick=()=>{At(e)});const n=document.getElementById("btnBuatLaporanHeader");n&&(n.onclick=()=>{At(e)});const o=document.getElementById("btnBuatLaporanNav");o&&(o.onclick=r=>{At(e),r.preventDefault()}),document.querySelectorAll('[href*="082-341-743-886"]').forEach(r=>{r.onclick=c=>{c.preventDefault(),window.open("https://wa.me/6282341743886?text=Halo%20CleanUp%20Kupang,%20saya%20ingin%20bertanya%20tentang%20layanan%20angkut%20sampah","_blank")}})}function At(e){const a=document.getElementById("modalContainer")||(()=>{const t=document.createElement("div");return t.id="modalContainer",document.body.appendChild(t),t})();Hm(e,a,()=>{console.log("Form laporan selesai, refreshing grid..."),ci(window.currentPage||1),ss(),xo()})}function qm(){const e=Se("map");window.dashboardMap=e,ss()}async function ss(){if(window.dashboardMap){window.dashboardMarkers&&(window.dashboardMarkers.forEach(e=>e.remove()),window.dashboardMarkers=[]),window.allLaporanData=[];try{const e=await fetch(b.laporanSampah,{headers:v()});if(e.ok){const a=await e.json();window.dashboardMarkers=[],window.allLaporanData=a,a.forEach((t,i)=>{if(!t.latitude||!t.longitude)return;const s=(t.status||"pending").toLowerCase();let n="#ffc107",o="MENUNGGU";s==="selesai"?(n="#28a745",o="SELESAI"):s==="proses"?(n="#17a2b8",o="DIPROSES"):s==="pending"&&(n="#ffc107",o="MENUNGGU");const l=t.tanggal_lapor?new Date(t.tanggal_lapor).toLocaleDateString("id-ID",{weekday:"short",day:"numeric",month:"short",year:"numeric"}):"Tanggal tidak tersedia",r=i,c=`
                    <div style="max-width: 300px; font-family: 'Segoe UI', Arial, sans-serif;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                            <div style="width: 14px; height: 14px; background-color: ${n}; border-radius: 50%; margin-right: 10px; border: 2px solid white; box-shadow: 0 0 0 1px ${n}"></div>
                            <strong style="font-size: 15px; color: #2e7d32; flex-grow: 1;">${t.nama||"Anonim"}</strong>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <span style="background-color: ${n}; color: ${s==="pending"?"#212529":"#fff"}; 
                                   padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; 
                                   display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <i class="bi bi-circle-fill" style="font-size: 8px; vertical-align: middle; margin-right: 5px;"></i>
                                ${o}
                            </span>
                        </div>
                        
                        <div style="font-size: 13px; color: #495057; margin-bottom: 12px; line-height: 1.5;">
                            <div style="margin-bottom: 6px; display: flex; align-items: center;">
                                <i class="bi bi-calendar" style="color: #6c757d; margin-right: 8px; width: 16px;"></i>
                                <span><strong>Tanggal:</strong> ${l}</span>
                            </div>
                            ${t.nama_user?`
                                <div style="margin-bottom: 6px; display: flex; align-items: center;">
                                    <i class="bi bi-person" style="color: #6c757d; margin-right: 8px; width: 16px;"></i>
                                    <span><strong>Pelapor:</strong> ${t.nama_user}</span>
                                </div>
                            `:""}
                        </div>
                        
                        
                        ${t.deskripsi?`
                            <div style="font-size: 13px; color: #495057; margin-bottom: 12px;">
                                <div style="display: flex; align-items: flex-start;">
                                    <i class="bi bi-chat-text" style="color: #6c757d; margin-right: 8px; width: 16px; margin-top: 2px;"></i>
                                    <div>
                                        <strong style="color: #2e7d32;">Deskripsi:</strong><br>
                                        <div style="margin-top: 2px; color: #343a40; font-style: italic; background-color: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 3px solid ${n};">
                                            "${t.deskripsi.substring(0,100)}${t.deskripsi.length>100?"...":""}"
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `:""}
                        
                        ${t.foto_bukti_url||t.foto_bukti?`
                            <div style="margin-bottom: 12px; text-align: center;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">
                                    <i class="bi bi-image me-1"></i>Foto Bukti:
                                </div>
                                <img src="${t.foto_bukti_url||t.foto_bukti}" 
                                     alt="Foto bukti" 
                                     style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 6px; border: 2px solid #dee2e6; cursor: pointer;"
                                     onclick="this.style.maxHeight = this.style.maxHeight === 'none' ? '150px' : 'none'">
                            </div>
                        `:""}
                        
                        <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e9ecef;">
                            <button onclick="showLaporanDetail(${r})" 
                                    style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 3px 6px rgba(46, 125, 50, 0.2);">
                                <i class="bi bi-map"></i> Lihat Detail di Peta
                            </button>
                        </div>
                    </div>
                `,d=nt(window.dashboardMap,t.latitude,t.longitude,c,n);d&&(d.dataIndex=r,window.dashboardMarkers.push(d))}),Vm(),console.log(`âœ… Loaded ${window.dashboardMarkers.length} markers to map (3 status colors)`)}}catch(e){console.error("Error refreshing map markers:",e)}}}function Vm(){if(!window.dashboardMap)return;window.mapLegend&&window.mapLegend.remove();const e=L.control({position:"bottomright"});e.onAdd=function(a){var n;const t=L.DomUtil.create("div","info legend");t.style.backgroundColor="white",t.style.padding="12px 15px",t.style.borderRadius="8px",t.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",t.style.fontSize="13px",t.style.fontFamily="'Segoe UI', Arial, sans-serif",t.style.border="2px solid #2e7d32",t.style.maxWidth="220px";const i=[{status:"SELESAI",color:"#28a745",icon:"âœ…",desc:"Laporan sudah ditangani"},{status:"DIPROSES",color:"#17a2b8",icon:"ðŸ”„",desc:"Sedang dalam penanganan"},{status:"MENUNGGU",color:"#ffc107",icon:"â³",desc:"Menunggu penanganan"}];let s=`
            <div style="display: flex; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                <div style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); color: white; padding: 6px 10px; border-radius: 6px; margin-right: 10px;">
                    <i class="bi bi-info-circle"></i>
                </div>
                <strong style="color: #2e7d32; font-size: 14px;">Legenda Status Laporan</strong>
            </div>
        `;return i.forEach(o=>{s+=`
                <div style="display: flex; align-items: flex-start; margin: 10px 0; padding: 8px 0;">
                    <div style="width: 18px; height: 18px; background-color: ${o.color}; border-radius: 50%; margin-right: 12px; margin-top: 2px; border: 2px solid white; box-shadow: 0 0 0 1px ${o.color};"></div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 3px;">
                            <span style="font-weight: 600; color: #343a40; margin-right: 8px;">${o.status}</span>
                            <span style="font-size: 14px;">${o.icon}</span>
                        </div>
                        <div style="font-size: 11px; color: #6c757d;">${o.desc}</div>
                    </div>
                </div>
            `}),s+=`
            <div style="margin-top: 15px; padding-top: 12px; border-top: 2px solid #e9ecef; font-size: 11px; color: #495057; text-align: center;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: #2e7d32;">
                        <i class="bi bi-pin-map me-1"></i>Total:
                    </span>
                    <span style="background: #2e7d32; color: white; padding: 2px 10px; border-radius: 12px; font-weight: bold;">
                        ${((n=window.dashboardMarkers)==null?void 0:n.length)||0} laporan
                    </span>
                </div>
                <div style="margin-top: 8px; font-size: 10px; color: #6c757d;">
                    <i class="bi bi-info-circle me-1"></i>Klik marker untuk detail
                </div>
            </div>
        `,t.innerHTML=s,t},e.addTo(window.dashboardMap),window.mapLegend=e}async function ci(e=1){const a=document.getElementById("laporanGrid");if(!a)return;window.currentPage=e,a.innerHTML=`
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Memuat data laporan...</p>
        </div>
    `;const t=document.getElementById("paginationInfo");t&&(t.textContent="Memuat...");try{const i=await fetch(b.laporanSampah,{headers:v()});console.log("Laporan response status:",i.status);const s=i.headers.get("content-type");if(!s||!s.includes("application/json")){const p=await i.text();console.error("Response is not JSON:",p.substring(0,200)),a.innerHTML=`
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <h4 class="alert-heading">
                            <i class="bi bi-exclamation-triangle me-2"></i>Error Loading Data
                        </h4>
                        <p>Server returned non-JSON response. Status: ${i.status}</p>
                        <button onclick="loadLaporanGrid(${e})" class="btn btn-success mt-2">
                            <i class="bi bi-arrow-clockwise me-2"></i> Coba Lagi
                        </button>
                    </div>
                </div>
            `;return}if(!i.ok){const p=await i.text();console.error("Server error:",p),a.innerHTML=`
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <h4 class="alert-heading">
                            <i class="bi bi-exclamation-triangle me-2"></i>Error ${i.status}
                        </h4>
                        <p>${p||i.statusText}</p>
                        <button onclick="loadLaporanGrid(${e})" class="btn btn-success mt-2">
                            <i class="bi bi-arrow-clockwise me-2"></i> Coba Lagi
                        </button>
                    </div>
                </div>
            `;return}const n=await i.json();if(console.log("âœ… Laporan loaded:",n.length,"items"),!n||!Array.isArray(n)||n.length===0){a.innerHTML=`
                <div class="col-12">
                    <div class="text-center py-5 bg-light rounded-3">
                        <div class="bg-success bg-opacity-10 p-4 rounded-circle d-inline-block mb-3">
                            <i class="bi bi-inbox text-success display-4"></i>
                        </div>
                        <h3 class="text-muted mb-3">Belum Ada Laporan</h3>
                        <p class="text-muted mb-4">
                            Jadilah yang pertama melaporkan lokasi sampah di sekitar Anda!
                        </p>
                        <button onclick="showFormLaporanInModal(window.userData)" class="btn btn-success btn-lg">
                            <i class="bi bi-plus-circle me-2"></i> Buat Laporan Pertama
                        </button>
                    </div>
                </div>
            `,$i(0,e);return}const o=[...n].sort((p,h)=>new Date(h.tanggal_lapor||0)-new Date(p.tanggal_lapor||0)),l=9,r=o.length,c=Math.ceil(r/l);e<1&&(e=1),e>c&&(e=c);const d=(e-1)*l,m=Math.min(d+l,r),u=o.slice(d,m);a.innerHTML="",u.forEach((p,h)=>{var E;const f=h<3,k=p.tanggal_lapor?new Date(p.tanggal_lapor).toLocaleDateString("id-ID",{weekday:"short",day:"numeric",month:"short",year:"numeric"}):"Tanggal tidak tersedia",w=(p.status||"pending").toLowerCase();let $="bg-warning text-dark",y="â³";w==="selesai"?($="bg-success text-white",y="âœ…"):w==="proses"&&($="bg-info text-white",y="ðŸ”„");const A=document.createElement("div");A.className="col-md-6 col-lg-4",A.innerHTML=`
                <div class="card h-100 ${f?"border-success border-3 shadow":"border-light shadow-sm"} hover-shadow" 
                     style="transition: transform 0.2s, box-shadow 0.2s;" 
                     onmouseover="this.style.transform='translateY(-5px)';" 
                     onmouseout="this.style.transform='translateY(0)';">
                    ${p.foto_bukti_url||p.foto_bukti?`
                        <div style="position: relative;">
                            <img src="${p.foto_bukti_url||p.foto_bukti}" 
                                 class="card-img-top" 
                                 alt="Foto bukti"
                                 style="height: 200px; object-fit: cover; border-top-left-radius: 6px; border-top-right-radius: 6px;">
                            ${f?`
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(46, 125, 50, 0.9); color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                    <i class="bi bi-star-fill me-1"></i>BARU
                                </div>
                            `:""}
                        </div>
                    `:`
                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light" 
                             style="height: 200px; border-top-left-radius: 6px; border-top-right-radius: 6px;">
                            <div class="text-center">
                                <div class="bg-success bg-opacity-10 p-3 rounded-circle d-inline-block mb-2">
                                    <i class="bi bi-image text-success fs-1"></i>
                                </div>
                                <p class="text-muted small mb-0">Tidak ada foto</p>
                            </div>
                        </div>
                    `}
                    
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0 text-success fw-bold">
                                ${p.nama||"Anonim"}
                            </h5>
                            <span class="badge ${$} d-flex align-items-center">
                                <span style="font-size: 12px; margin-right: 4px;">${y}</span>
                                ${w.toUpperCase()}
                            </span>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i> ${k}
                            </small>
                            ${p.nama_user?`<small class="text-muted">
                                    <i class="bi bi-person me-1"></i> ${p.nama_user}
                                </small>`:""}
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="small text-muted mb-1">
                                <i class="bi bi-geo-alt me-1"></i> Lokasi
                            </h6>
                            <p class="card-text small mb-0" style="color: #495057;">${p.alamat||"Tidak ada alamat"}</p>
                        </div>
                        
                        ${p.deskripsi?`
                            <div class="mb-3">
                                <h6 class="small text-muted mb-1">
                                    <i class="bi bi-chat-text me-1"></i> Deskripsi
                                </h6>
                                <p class="card-text small mb-0" style="color: #495057;">${p.deskripsi.substring(0,100)}${p.deskripsi.length>100?"...":""}</p>
                            </div>
                        `:""}
                        
                        <div class="mt-auto pt-3">
                            ${p.latitude&&p.longitude?`
                                <button onclick="showLaporanOnMap(${p.latitude}, ${p.longitude}, '${((E=p.deskripsi)==null?void 0:E.replace(/'/g,"\\'"))||""}')" 
                                        class="btn btn-outline-success btn-sm w-100 d-flex align-items-center justify-content-center">
                                    <i class="bi bi-map me-2"></i> Lihat di Peta
                                </button>
                            `:`
                                <div class="alert alert-warning py-2 mb-0 text-center small">
                                    <i class="bi bi-exclamation-triangle me-1"></i> Tidak ada lokasi
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `,a.appendChild(A)}),$i(r,e,l,c),t&&(t.textContent=`Menampilkan ${d+1}-${m} dari ${r} laporan`);const g=document.createElement("div");g.className="col-12",g.innerHTML=`
            <div class="text-center mt-4 p-3 bg-light rounded-3 border-start border-5 border-success">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                        <i class="bi bi-clock-history text-success"></i>
                    </div>
                    <div>
                        <small class="text-muted d-block">Halaman ${e} dari ${c}</small>
                        <small class="text-success fw-semibold">Diperbarui: ${new Date().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})} WITA</small>
                    </div>
                </div>
            </div>
        `,a.appendChild(g)}catch(i){console.error("Gagal load grid laporan:",i),a.innerHTML=`
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle d-inline-block mb-3">
                        <i class="bi bi-wifi-off text-warning fs-1"></i>
                    </div>
                    <h4 class="alert-heading text-dark">
                        <i class="bi bi-exclamation-triangle me-2"></i> Koneksi Error
                    </h4>
                    <p class="text-dark">${i.message}</p>
                    <div class="mt-3">
                        <button onclick="location.reload()" class="btn btn-outline-success me-2">
                            <i class="bi bi-arrow-clockwise me-2"></i> Refresh Page
                        </button>
                        <button onclick="loadLaporanGrid(${e})" class="btn btn-success">
                            <i class="bi bi-list-ul me-2"></i> Load Laporan
                        </button>
                    </div>
                </div>
            </div>
        `,$i(0,e)}}function $i(e,a,t=10,i=1){const s=document.getElementById("laporanPagination");if(!s)return;if(e===0){s.innerHTML="";return}i===1&&(i=Math.ceil(e/t));let n=Math.max(1,a-2),o=Math.min(i,n+4);o-n<4&&(n=Math.max(1,o-4));let l="";l+=`
        <li class="page-item ${a===1?"disabled":""}">
            <a class="page-link ${a===1?"":"text-success"}" 
               href="#" 
               onclick="loadLaporanGrid(${a-1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
    `,n>1&&(l+=`
            <li class="page-item">
                <a class="page-link text-success" href="#" onclick="loadLaporanGrid(1); return false;">1</a>
            </li>
        `,n>2&&(l+='<li class="page-item disabled"><span class="page-link">...</span></li>'));for(let r=n;r<=o;r++)l+=`
            <li class="page-item ${r===a?"active":""}">
                <a class="page-link ${r===a?"bg-success border-success":"text-success"}" 
                   href="#" 
                   onclick="loadLaporanGrid(${r}); return false;">
                    ${r}
                </a>
            </li>
        `;o<i&&(o<i-1&&(l+='<li class="page-item disabled"><span class="page-link">...</span></li>'),l+=`
            <li class="page-item">
                <a class="page-link text-success" href="#" onclick="loadLaporanGrid(${i}); return false;">${i}</a>
            </li>
        `),l+=`
        <li class="page-item ${a===i?"disabled":""}">
            <a class="page-link ${a===i?"":"text-success"}" 
               href="#" 
               onclick="loadLaporanGrid(${a+1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    `,s.innerHTML=l}async function xo(){try{const e=await fetch(b.laporanSampah,{headers:v()});if(e.ok){const a=await e.json(),t=a.filter(r=>r.status==="selesai").length,i=a.filter(r=>r.status==="pending").length,s=a.length,n=document.getElementById("activeReports"),o=document.getElementById("completedReports"),l=document.getElementById("pendingReports");n&&(n.textContent=s),o&&(o.textContent=t),l&&(l.textContent=i)}}catch(e){console.error("Error updating stats:",e)}}window.showLaporanDetail=function(e){var t;const a=(t=window.allLaporanData)==null?void 0:t[e];if(!a){console.error("Laporan data not found for index:",e),alert("Data laporan tidak ditemukan");return}Lo(a)};function Lo(e){const{nama:a,tanggal_lapor:t,alamat:i,latitude:s,longitude:n,deskripsi:o,foto_bukti:l,foto_bukti_url:r,status:c,nama_user:d}=e,m=parseFloat(s),u=parseFloat(n),g=new Date(t).toLocaleDateString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),p={pending:"warning",proses:"info",selesai:"success"},h={pending:"Menunggu",proses:"Diproses",selesai:"Selesai"},f=p[c]||"secondary",k=h[c]||c,w=document.createElement("div");w.id="mapDetailModal",w.innerHTML=`
        <div class="modal fade" id="staticMapDetailModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-success border-3">
                    <div class="modal-header text-white" style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);">
                        <h5 class="modal-title" id="mapModalLabel">
                            <i class="bi bi-geo-alt-fill me-2"></i> Detail Lengkap Laporan Sampah
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    
                    <div class="modal-body">
                        <!-- Row untuk informasi dan foto -->
                        <div class="row mb-4">
                            <!-- Informasi Laporan -->
                            <div class="col-md-8">
                                <div class="card border-0 shadow-sm mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title text-success mb-3">
                                            <i class="bi bi-info-circle me-2"></i>Informasi Laporan
                                        </h6>
                                        
                                        <div class="row">
                                            <div class="col-6 mb-2">
                                                <small class="text-muted d-block">Nama Pelapor</small>
                                                <strong>${a||"-"}</strong>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <small class="text-muted d-block">Tanggal Lapor</small>
                                                <strong>${g}</strong>
                                            </div>
                                            <div class="col-12 mb-2">
                                                <small class="text-muted d-block">Alamat Lengkap</small>
                                                <strong class="text-break">${i||"-"}</strong>
                                            </div>
                                            <div class="col-12 mb-2">
                                                <small class="text-muted d-block">Deskripsi Laporan</small>
                                                <div class="bg-light p-3 rounded border">
                                                    ${o||"-"}
                                                </div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <small class="text-muted d-block">Status</small>
                                                <span class="badge bg-${f}">${k}</span>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <small class="text-muted d-block">Koordinat</small>
                                                <strong>${m.toFixed(6)}, ${u.toFixed(6)}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Foto Bukti -->
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body d-flex flex-column">
                                        <h6 class="card-title text-success mb-3">
                                            <i class="bi bi-camera me-2"></i>Foto Bukti
                                        </h6>
                                        
                                        ${l||r?`
                                            <div class="text-center mb-3 flex-grow-1">
                                                <img src="${l||r}" 
                                                     class="img-fluid rounded shadow-sm" 
                                                     alt="Foto Bukti Laporan"
                                                     style="max-height: 200px; cursor: pointer; object-fit: cover;"
                                                     onclick="window.open('${l||r}', '_blank')">
                                            </div>
                                            <div class="text-center">
                                                <small class="text-muted">Klik gambar untuk memperbesar</small>
                                            </div>
                                        `:`
                                            <div class="text-center py-4 flex-grow-1 d-flex flex-column justify-content-center">
                                                <i class="bi bi-image text-muted mb-3" style="font-size: 3rem;"></i>
                                                <p class="text-muted">Tidak ada foto bukti</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Peta -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0">
                                <h6 class="card-title text-success mb-0">
                                    <i class="bi bi-map me-2"></i>Lokasi di Peta
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="detailMapModal" style="height: 400px; border-radius: 8px; overflow: hidden;"></div>
                                <div class="p-3 border-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-success p-2 me-2">
                                                <i class="bi bi-geo-alt me-1"></i>
                                                Latitude: ${m.toFixed(6)}
                                            </span>
                                            <span class="badge bg-primary p-2">
                                                <i class="bi bi-geo-alt me-1"></i>
                                                Longitude: ${u.toFixed(6)}
                                            </span>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="copyCoordinates(${m}, ${u})">
                                            <i class="bi bi-clipboard me-1"></i> Salin Koordinat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i> Tutup
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${m},${u}" 
                           target="_blank" 
                           class="btn btn-success">
                            <i class="bi bi-arrow-right-circle me-2"></i> Buka di Google Maps
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `,document.body.appendChild(w);const $=new bootstrap.Modal(document.getElementById("staticMapDetailModal")),y=document.getElementById("staticMapDetailModal"),A=function(){ba(()=>{const C=Se("detailMapModal",m,u,16),B=L.divIcon({html:`<div style="
                    background-color: #28a745;
                    width: 35px;
                    height: 35px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 0 10px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                ">
                    <i class="bi bi-trash-fill" style="font-size: 14px;"></i>
                </div>`,className:"custom-marker-icon",iconSize:[35,35],iconAnchor:[17.5,17.5]});L.marker([m,u],{icon:B}).addTo(C).bindPopup(`
                    <div style="min-width: 200px;">
                        <strong>${a||"Pelapor"}</strong><br/>
                        <small class="text-muted">Status: ${k}</small><br/>
                        <small>${i?i.substring(0,50)+"...":"Tidak ada alamat"}</small>
                    </div>
                `).openPopup()})};y.addEventListener("shown.bs.modal",A);const E=function(){y.removeEventListener("shown.bs.modal",A),y.removeEventListener("hidden.bs.modal",E),setTimeout(()=>{w&&w.parentNode&&w.parentNode.removeChild(w)},300)};y.addEventListener("hidden.bs.modal",E),$.show()}async function Wm(){const e=window.userData;if(!e)return;const a=document.getElementById("modalContainer")||(()=>{const $=document.createElement("div");return $.id="modalContainer",document.body.appendChild($),$})();let t={},i={};a.innerHTML=`
        <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-success border-3">
                    <div class="modal-header text-white" style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);">
                        <h5 class="modal-title" id="profileModalLabel">
                            <i class="bi bi-person-gear me-2"></i> Profil Tamu
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    
                    <div class="modal-body">
                        <!-- Loading Spinner -->
                        <div id="profileLoading" class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Memuat data profil...</p>
                        </div>
                        
                        <!-- Alert Tidak Ada Perubahan -->
                        <div id="noChangeAlertModal" class="alert alert-warning alert-dismissible fade show mb-3" style="display: none;">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span id="noChangeMessageModal">Tidak ada perubahan yang dilakukan. Silakan ubah data terlebih dahulu.</span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <!-- Profile Display -->
                        <div id="profileDisplay" style="display: none;">
                            <!-- Informasi Dasar -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-success">
                                        <i class="bi bi-person-circle me-2"></i> Informasi Profil
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-success" id="editProfileBtn">
                                        <i class="bi bi-pencil me-1"></i> Edit Profil
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-muted">Username</label>
                                            <div class="form-control-plaintext fw-bold" id="displayUsername">${e.username}</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-muted">Email</label>
                                            <div class="form-control-plaintext" id="displayEmail">Memuat...</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-muted">Nama Lengkap</label>
                                            <div class="form-control-plaintext fw-bold" id="displayNama">Memuat...</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-muted">Jenis Kelamin</label>
                                            <div class="form-control-plaintext" id="displayJk">Memuat...</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-muted">Role</label>
                                            <div class="form-control-plaintext">
                                                <span class="badge bg-success">${e.role||"Tamu"}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Form -->
                        <div id="profileFormContainer" style="display: none;">
                            <form id="profileForm" novalidate>
                                <!-- Informasi Dasar -->
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 text-success">
                                            <i class="bi bi-person-circle me-2"></i> Edit Informasi Profil
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelEditBtn">
                                            <i class="bi bi-x me-1"></i> Batal Edit
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <small>Untuk menyimpan perubahan, Anda harus mengubah minimal satu data.</small>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-semibold">Username</label>
                                                <input type="text" class="form-control" id="profileUsername" 
                                                       value="${e.username}" readonly disabled>
                                                <div class="form-text text-muted">Username tidak dapat diubah</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                                                <input type="email" class="form-control" id="profileEmail" 
                                                       data-original="" required>
                                                <div id="profileEmailError" class="validation-error small"></div>
                                                <div class="form-text text-muted">Contoh: nama@email.com</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-semibold">Nama Lengkap <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="profileNama" 
                                                       data-original="" required>
                                                <div id="profileNamaError" class="validation-error small"></div>
                                                <div class="form-text text-muted">Minimal 3 karakter</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-semibold">Jenis Kelamin <span class="text-danger">*</span></label>
                                                <select class="form-select" id="profileJk" data-original="" required>
                                                    <option value="">Pilih Jenis Kelamin</option>
                                                    <option value="L">Laki-laki</option>
                                                    <option value="P">Perempuan</option>
                                                </select>
                                                <div id="profileJkError" class="validation-error small"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Password (Opsional) -->
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0 text-success">
                                            <i class="bi bi-shield-lock me-2"></i> Ubah Password (Opsional)
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            Kosongkan jika tidak ingin mengubah password
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-semibold">Password Baru</label>
                                                <input type="password" class="form-control" id="profilePasswordBaru" 
                                                       placeholder="Minimal 6 karakter">
                                                <div id="profilePasswordBaruError" class="validation-error small"></div>
                                                <div class="form-text text-muted">Kosongkan jika tidak ingin ubah password</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-semibold">Konfirmasi Password Baru</label>
                                                <input type="password" class="form-control" id="profilePasswordKonfirmasi" 
                                                       placeholder="Ulangi password baru">
                                                <div id="profilePasswordKonfirmasiError" class="validation-error small"></div>
                                                <div class="form-text text-muted">Harus sama dengan password baru</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Summary Validation -->
                                <div id="profileSummaryValidation" class="alert alert-warning mb-4" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-exclamation-triangle-fill me-3"></i>
                                        <div>
                                            <strong class="d-block mb-1">Perbaiki data berikut:</strong>
                                            <ul id="profileSummaryErrors" class="mb-0 small"></ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Save Button -->
                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <button type="button" class="btn btn-outline-secondary" id="cancelEditFormBtn">
                                        <i class="bi bi-x-circle me-2"></i> Batal
                                    </button>
                                    <button type="submit" class="btn btn-success" id="saveProfileBtn">
                                        <i class="bi bi-check-circle me-2"></i> Simpan Perubahan
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="modal-footer" id="profileModalFooter">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i> Tutup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;const s=new bootstrap.Modal(document.getElementById("profileModal"));document.getElementById("profileModal").addEventListener("shown.bs.modal",async function(){try{await n()}catch($){console.warn("Error loading tamu data:",$),o()}});async function n(){try{const $=e.id,y=await fetch(`/api/tamu/?idUser=${$}`,{headers:v()});if(y.ok){const A=await y.json();let E;Array.isArray(A)?E=A[0]||{}:A.results&&Array.isArray(A.results)?E=A.results[0]||{}:E=A||{},t={email:e.email||"",nama:E.nama||"",jk:E.jk||"",password:""},i={...E},l(t),r(t),document.getElementById("profileLoading").style.display="none",document.getElementById("profileDisplay").style.display="block",c()}}catch($){throw console.error("Error loading tamu data:",$),$}}function o(){t={email:e.email||"",nama:e.nama||e.first_name||e.username,jk:e.jk||"",password:""},l(t),r(t),setTimeout(()=>{document.getElementById("profileLoading").style.display="none",document.getElementById("profileDisplay").style.display="block",c()},500)}function l($){document.getElementById("displayEmail").textContent=$.email,document.getElementById("displayNama").textContent=$.nama||"-",document.getElementById("displayJk").textContent=$.jk==="L"?"Laki-laki":$.jk==="P"?"Perempuan":"-"}function r($){const y={profileEmail:$.email,profileNama:$.nama,profileJk:$.jk};Object.entries(y).forEach(([A,E])=>{const C=document.getElementById(A);C&&(C.value=E||"",C.setAttribute("data-original",E||""))})}function c(){document.getElementById("editProfileBtn").addEventListener("click",function(){document.getElementById("profileDisplay").style.display="none",document.getElementById("profileFormContainer").style.display="block",document.getElementById("profileModalFooter").style.display="none",m()}),document.getElementById("cancelEditBtn").addEventListener("click",function(){d()}),document.getElementById("cancelEditFormBtn").addEventListener("click",function(){d()}),document.getElementById("saveProfileBtn").addEventListener("click",async function($){$.preventDefault(),await k()}),document.getElementById("profileForm").addEventListener("submit",async function($){$.preventDefault(),await k()})}function d(){r(t),g(),document.getElementById("profileFormContainer").style.display="none",document.getElementById("profileDisplay").style.display="block",document.getElementById("profileModalFooter").style.display="flex"}function m(){["profileEmail","profileNama","profileJk","profilePasswordBaru","profilePasswordKonfirmasi"].forEach(y=>{const A=document.getElementById(y);A&&(A.addEventListener("input",()=>u(y)),A.addEventListener("blur",()=>u(y)))})}function u($){const y=document.getElementById($),A=document.getElementById(`${$}Error`),E=y.value.trim();if(!A)return!0;let C=!0,B="";switch($){case"profileEmail":E?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(E)||(B="Format email tidak valid",C=!1):(B="Email harus diisi",C=!1);break;case"profileNama":E?E.length<3&&(B="Nama minimal 3 karakter",C=!1):(B="Nama lengkap harus diisi",C=!1);break;case"profileJk":E||(B="Pilih jenis kelamin",C=!1);break;case"profilePasswordBaru":if(E){E.length<6&&(B="Password minimal 6 karakter",C=!1);const D=document.getElementById("profilePasswordKonfirmasi").value.trim();D&&E!==D&&(B="Password tidak cocok dengan konfirmasi",C=!1)}break;case"profilePasswordKonfirmasi":const I=document.getElementById("profilePasswordBaru").value.trim();I&&E&&E!==I?(B="Konfirmasi password tidak cocok",C=!1):!E&&I&&(B="Konfirmasi password harus diisi",C=!1);break}return C?(A.style.display="none",y.classList.remove("is-invalid"),E&&y.classList.add("is-valid")):(A.style.display="block",A.textContent=B,y.classList.add("is-invalid"),y.classList.remove("is-valid")),C}function g(){["profileEmail","profileNama","profileJk","profilePasswordBaru","profilePasswordKonfirmasi"].forEach(E=>{const C=document.getElementById(E),B=document.getElementById(`${E}Error`);C&&C.classList.remove("is-invalid","is-valid"),B&&(B.style.display="none",B.textContent="")});const y=document.getElementById("profileSummaryValidation");y&&(y.style.display="none");const A=document.getElementById("noChangeAlertModal");A&&(A.style.display="none")}function p(){const $=[{id:"profileEmail",name:"Email"},{id:"profileNama",name:"Nama"},{id:"profileJk",name:"Jenis Kelamin"},{id:"profilePasswordBaru",name:"Password"}];let y=!1,A=[];for(const E of $){const C=document.getElementById(E.id);if(C){const B=C.value.trim(),I=C.getAttribute("data-original")||"";B!==I&&(E.id==="profilePasswordBaru"&&B!==""||E.id!=="profilePasswordBaru")&&(y=!0,A.push(E.name))}}return{hasChanged:y,changedFields:A}}function h(){const $=document.getElementById("noChangeAlertModal");$&&($.style.display="block",$.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{$.style.display="none"},5e3))}function f(){const $=["profileEmail","profileNama","profileJk"];let y=!0,A=[];$.forEach(D=>{var da;if(!u(D)){y=!1;const Fa=((da=document.querySelector(`label[for="${D}"]`))==null?void 0:da.textContent.replace(" *",""))||D,ca=document.getElementById(`${D}Error`).textContent;ca&&A.push(`${Fa}: ${ca}`)}});const E=document.getElementById("profilePasswordBaru").value.trim(),C=document.getElementById("profilePasswordKonfirmasi").value.trim();if(E||C){const D=u("profilePasswordBaru"),U=u("profilePasswordKonfirmasi");(!D||!U)&&(y=!1),E&&C&&E!==C&&(y=!1,A.push("Password: Password dan konfirmasi tidak cocok"))}const B=document.getElementById("profileSummaryValidation"),I=document.getElementById("profileSummaryErrors");return!y&&B&&I?(I.innerHTML="",A.forEach(D=>{const U=document.createElement("li");U.textContent=D,I.appendChild(U)}),B.style.display="block"):B&&(B.style.display="none"),y}async function k(){const $=document.getElementById("saveProfileBtn");$.innerHTML;try{const y=p(),A=y.hasChanged,E=y.changedFields;if(!A){h();return}if(!f())return;$.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...',$.disabled=!0;const B={nama:document.getElementById("profileNama").value.trim(),jk:document.getElementById("profileJk").value},I={email:document.getElementById("profileEmail").value.trim()},D=document.getElementById("profilePasswordBaru").value.trim();let U=!1;if(I.email!==t.email||D){const ca={};I.email!==t.email&&(ca.email=I.email),D&&(ca.password=D);try{const T=JSON.parse(localStorage.getItem("user")).id;console.log("User ID from localStorage:",T);const N=await fetch(`${b.users}${T}/`,{method:"PATCH",headers:{...v(),"Content-Type":"application/json"},body:JSON.stringify(ca)});if(console.log("User response status:",N.status),!N.ok){let G="Gagal mengupdate data user";try{const j=await N.json();console.log("User error data:",j),j.email&&Array.isArray(j.email)?(document.getElementById("profileEmailError").style.display="block",document.getElementById("profileEmailError").textContent=j.email[0],document.getElementById("profileEmail").classList.add("is-invalid"),G=`Email: ${j.email[0]}`):j.detail&&(G=j.detail)}catch(j){console.warn("Cannot parse user error response:",j);const K=await N.text();G=`HTTP ${N.status}: ${K||N.statusText}`}throw new Error(G)}const z=await N.json();if(console.log("User update success:",z),U=!0,I.email!==t.email){const j={...JSON.parse(localStorage.getItem("user")||"{}"),email:I.email,...z};localStorage.setItem("user",JSON.stringify(j)),window.userData=j}}catch(fa){console.error("User update error:",fa),$.disabled=!1,$.innerHTML='<i class="bi bi-check-circle me-2"></i>Simpan Perubahan',showToast("error",fa.message||"Terjadi kesalahan saat menyimpan");return}}let Fa=!1;if(B.nama!==t.nama||B.jk!==t.jk)try{const ca=await fetch(`${b.tamu}`,{headers:v()});if(console.log("Tamu list response status:",ca.status),!ca.ok)throw new Error("Gagal mengambil data tamu");const fa=await ca.json();console.log("Tamu list:",fa);const N=JSON.parse(localStorage.getItem("user")).id;let z=null;if(Array.isArray(fa)?z=fa.find(G=>G.idUser===N):fa.results&&Array.isArray(fa.results)?z=fa.results.find(G=>G.idUser===N):fa.idUser===N&&(z=fa),console.log("Current tamu found:",z),z&&z.idTamu){console.log("Updating tamu ID:",z.idTamu),console.log("Update data:",B);const G=await fetch(`${b.tamu}${z.idTamu}/`,{method:"PATCH",headers:{"Content-Type":"application/json",...v()},body:JSON.stringify(B)});if(console.log("Tamu update response status:",G.status),!G.ok){let K="Gagal mengupdate data tamu";try{const H=await G.json();if(console.log("Tamu update error data:",H),H.nama&&Array.isArray(H.nama)&&(document.getElementById("profileNamaError").style.display="block",document.getElementById("profileNamaError").textContent=H.nama[0],document.getElementById("profileNama").classList.add("is-invalid"),K=`Nama: ${H.nama[0]}`),H.jk&&Array.isArray(H.jk)){const O=document.getElementById("profileJkError");O&&(O.style.display="block",O.textContent=H.jk[0]),document.getElementById("profileJk").classList.add("is-invalid"),K+=K.includes("Nama:")?`, JK: ${H.jk[0]}`:`JK: ${H.jk[0]}`}}catch(H){console.warn("Cannot parse tamu error:",H);const O=await G.text();console.log("Raw error text:",O),K=`HTTP ${G.status}: ${O}`}throw new Error(K)}const j=await G.json();console.log("Tamu update success:",j),Fa=!0}else console.log("No tamu found for user ID:",N)}catch(ca){console.error("Tamu update error:",ca),$.disabled=!1,$.innerHTML='<i class="bi bi-check-circle me-2"></i>Simpan Perubahan',showToast("error",ca.message||"Terjadi kesalahan saat menyimpan data tamu");return}$.disabled=!1,$.innerHTML='<i class="bi bi-check-circle me-2"></i>Simpan Perubahan',U||Fa?(t={...t,nama:B.nama,jk:B.jk,email:I.email,password:""},l({email:I.email,nama:B.nama,jk:B.jk}),r(t),d(),w(E),typeof Ns=="function"&&Ns(window.userData),setTimeout(()=>{typeof showToast=="function"&&showToast("success","Profil berhasil diperbarui!")},500)):h()}catch(y){console.error("General save error:",y),$.disabled=!1,$.innerHTML='<i class="bi bi-check-circle me-2"></i>Simpan Perubahan',typeof showToast=="function"?showToast("error",y.message||"Terjadi kesalahan saat menyimpan"):alert("Error: "+y.message)}}function w($){const y=document.createElement("div");y.className="position-fixed top-0 end-0 p-3",y.style.zIndex="1060";let A=$.length>0?`Data yang berubah: ${$.join(", ")}`:"Data berhasil diperbarui";y.innerHTML=`
            <div id="profileSuccessToastModal" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong class="me-auto">Berhasil!</strong>
                    <small>Baru saja</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                            <i class="bi bi-person-check text-success"></i>
                        </div>
                        <div>
                            <strong>Profil berhasil diperbarui!</strong>
                            <p class="mb-0 small">${A}</p>
                        </div>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(y);const E=document.getElementById("profileSuccessToastModal");new bootstrap.Toast(E,{delay:4e3}).show(),E.addEventListener("hidden.bs.toast",function(){y.remove()})}s.show(),document.getElementById("profileModal").addEventListener("hidden.bs.modal",function(){a&&a.parentNode&&(a.innerHTML="")})}function Ns(e){document.querySelectorAll(".bg-success.text-white .text-warning").forEach(s=>{if(s.textContent.includes(e.username)){const n=e.nama||e.username;s.textContent=n}});const t=document.querySelector(".navbar-nav .dropdown-toggle .fw-bold");if(t){const s=e.nama||e.username;t.textContent=s}const i=document.querySelector(".navbar-nav .dropdown-toggle small");i&&(i.textContent=e.role||"Tamu")}window.getCurrentLocationView=function(){if(!navigator.geolocation){showFormToast("Browser tidak mendukung GPS","danger");return}showFormToast("Mendeteksi lokasi GPS...","info"),navigator.geolocation.getCurrentPosition(function(e){const a=e.coords.latitude,t=e.coords.longitude,i=e.coords.accuracy;window.profileMap&&(window.profileMap.setView([a,t],17),window.profileGPSMarker?window.profileGPSMarker.setLatLng([a,t]):window.profileGPSMarker=window.L.marker([a,t],{icon:window.L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),title:"LOKASI SAYA (GPS)",draggable:!1,zIndexOffset:1e3}).addTo(window.profileMap),window.profileGPSMarker.bindPopup(`
                    <div style="max-width: 250px;">
                        <strong style="color: #4CAF50;">ðŸ“ LOKASI SAYA (GPS)</strong><br>
                        <small>
                            <b>Lat:</b> ${a.toFixed(6)}<br>
                            <b>Lng:</b> ${t.toFixed(6)}<br>
                            <b>Akurasi:</b> Â±${Math.round(i)} meter<br>
                            <i>Lokasi dari GPS perangkat</i>
                        </small>
                    </div>
                `).openPopup(),showFormToast(`Lokasi ditemukan: ${a.toFixed(6)}, ${t.toFixed(6)}`,"success"))},function(e){let a="Gagal mendapatkan lokasi GPS";switch(e.code){case e.PERMISSION_DENIED:a="Izin lokasi ditolak";break;case e.POSITION_UNAVAILABLE:a="Informasi lokasi tidak tersedia";break;case e.TIMEOUT:a="Permintaan lokasi timeout";break}showFormToast(a,"danger")},{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})};window.resetMapView=function(){window.profileMap&&(window.profileMap.setView([-10.1935921,123.6149376],13),window.profileGPSMarker&&(window.profileMap.removeLayer(window.profileGPSMarker),window.profileGPSMarker=null),showFormToast("Peta direset ke lokasi default Kupang","info"))};window.copyEditToClipboard=function(e){const a=document.getElementById(e);if(a){a.select(),document.execCommand("copy");const t=a.value;a.value="âœ“ Disalin!",setTimeout(()=>{a.value=t},1e3),showFormToast("âœ… Berhasil disalin ke clipboard!","success")}};window.setEditFixedLocation=function(e,a,t){updateLocationInputs(e,a),editMap&&(editMap.setView([e,a],17),editGPSMarker&&editMap.hasLayer(editGPSMarker)&&(editMap.removeLayer(editGPSMarker),editGPSMarker=null),updateEditMarker(e,a),updateEditGPSStatus("manual"),setTimeout(()=>{editMap.invalidateSize()},100)),showFormToast(`Lokasi diterapkan: ${t}`,"info")};window.loadLaporanGrid=ci;window.refreshLaporanGrid=ci;window.refreshMapMarkers=ss;window.showProfileModal=Wm;window.showLaporanOnMap=function(e,a,t=""){if(console.log("showLaporanOnMap called with lat, lng:",e,a),window.allLaporanData&&window.allLaporanData.length>0){const n=window.allLaporanData.find(o=>Math.abs(parseFloat(o.latitude)-e)<1e-4&&Math.abs(parseFloat(o.longitude)-a)<1e-4);if(n){Lo(n);return}}const i=document.createElement("div");i.id="mapModal",i.innerHTML=`
        <div class="modal fade" id="staticMapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-success border-3">
                    <div class="modal-header text-white" style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);">
                        <h5 class="modal-title" id="mapModalLabel">
                            <i class="bi bi-geo-alt-fill me-2"></i> Lokasi Laporan Sampah
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${t?`
                            <div class="alert alert-info mb-3 border-start border-5 border-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Deskripsi:</strong> ${t}
                            </div>
                        `:""}
                        <div id="detailMap" style="height: 400px; border-radius: 8px; overflow: hidden; border: 1px solid #dee2e6;"></div>
                        <div class="mt-3 text-center">
                            <div class="badge bg-success p-2">
                                <i class="bi bi-geo-alt me-1"></i>
                                Koordinat: ${e.toFixed(6)}, ${a.toFixed(6)}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i> Tutup
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${e},${a}" 
                           target="_blank" 
                           class="btn btn-success">
                            <i class="bi bi-arrow-right-circle me-2"></i> Buka di Google Maps
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `,document.body.appendChild(i),new bootstrap.Modal(document.getElementById("staticMapModal")).show(),document.getElementById("staticMapModal").addEventListener("shown.bs.modal",function(){ba(()=>{const n=Se("detailMap",e,a,15);nt(n,e,a,t||"Lokasi Laporan","#28a745")})}),document.getElementById("staticMapModal").addEventListener("hidden.bs.modal",function(){i.remove()})};window.copyCoordinates=function(e,a){const t=`${e.toFixed(6)}, ${a.toFixed(6)}`;navigator.clipboard.writeText(t).then(()=>{var s;const i=(s=event==null?void 0:event.target)==null?void 0:s.closest("button");if(i){const n=i.innerHTML;i.innerHTML='<i class="bi bi-check2 me-1"></i>Tersalin!',i.classList.remove("btn-outline-success"),i.classList.add("btn-success"),setTimeout(()=>{i.innerHTML=n,i.classList.remove("btn-success"),i.classList.add("btn-outline-success")},2e3)}else alert("Koordinat berhasil disalin: "+t)}).catch(i=>{console.error("Failed to copy coordinates: ",i),alert("Gagal menyalin koordinat. Silakan salin manual: "+t)})};let ae=null,za=null;async function Ym(){const e=document.getElementById("app"),a=await Da();if(!a){alert("Silakan login terlebih dahulu!"),window.location.hash="#/login";return}if(a.role!=="tamu"){alert("Hanya Tamu yang bisa melakukan upgrade anggota."),window.location.hash="#/dashboard";return}let t={...a};try{const n=await fetch(`${b.users}${a.id}/`,{headers:v()});n.ok&&(t=await n.json())}catch(n){console.error("Error fetching user details:",n)}e.innerHTML=`
    <style>
      .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
      }
      .is-invalid {
        border-color: #dc3545 !important;
      }
      .form-control:disabled {
        background-color: #f8f9fa;
        opacity: 0.8;
        cursor: not-allowed;
      }
      .date-info {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
      }
    </style>
    
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
      <h3>Upgrade Menjadi Anggota CleanUp</h3>
      <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <p><strong>ðŸ’° Hanya Rp 50.000/bulan</strong></p>
        <p>Dengan menjadi anggota, Anda akan mendapatkan:</p>
        <ul>
          <li>ðŸ“… Layanan angkut sampah <strong>4 kali sebulan</strong></li>
          <li>ðŸ  Penjemputan langsung di depan rumah</li>
          <li>ðŸŒ± Kontribusi menjaga kebersihan Kota Kupang</li>
          <li>ðŸ“Š Akses ke dashboard anggota khusus</li>
        </ul>
      </div>
      
      <hr>

      <form id="formUpgrade" class="form-upgrade">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <label><strong>Nama Lengkap *</strong></label>
            <input type="text" id="nama" required value="${t.first_name||t.username||""}" 
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px;">
            <div id="namaError" class="validation-error"></div>
          </div>
          
          <div>
            <label><strong>Nomor WhatsApp *</strong></label>
            <input type="text" id="noWA" maxlength="12" required placeholder="Contoh: 081234567890" value="08"
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px;">
            <div id="noWAError" class="validation-error"></div>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label><strong>Alamat Lengkap *</strong></label>
          <textarea id="alamat" required rows="3" placeholder="Alamat lengkap termasuk RT/RW, kelurahan, kecamatan"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px;"></textarea>
          <div id="alamatError" class="validation-error"></div>
        </div>

        <div style="margin-bottom: 20px;">
          <label><strong>Lokasi Rumah (Klik pada peta untuk menandai) *</strong></label>
          <div id="mapSelect" style="height: 300px; width: 100%; border:1px solid #ccc; border-radius: 4px; margin-top: 5px;"></div>
          <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button type="button" id="btnGetLocation"
              style="
                background:#2196F3;
                color:white;
                padding:10px 14px;
                border:none;
                border-radius:4px;
                cursor:pointer;
                font-size:14px;
                flex: 1;
              ">
              ðŸ“ Gunakan Lokasi Saya (GPS)
            </button>
            <button type="button" id="btnClearMarker"
              style="
                background:#f44336;
                color:white;
                padding:10px 14px;
                border:none;
                border-radius:4px;
                cursor:pointer;
                font-size:14px;
                flex: 1;
              ">
              ðŸ—‘ï¸ Hapus Marker
            </button>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <label><strong>Latitude *</strong></label>
            <input type="number" id="latitude" step="0.00000001" readonly required 
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px; background: #f5f5f5;">
            <div id="latitudeError" class="validation-error"></div>
          </div>
          
          <div>
            <label><strong>Longitude *</strong></label>
            <input type="number" id="longitude" step="0.00000001" readonly required 
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px; background: #f5f5f5;">
            <div id="longitudeError" class="validation-error"></div>
          </div>
        </div>

        <div style="margin-bottom: 20px; display: none;">
          <label><strong>Tanggal Mulai Keanggotaan *</strong></label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="date" id="tanggalStart" required 
                   style="display:none;">
            <button type="button" id="btnSetToday" 
                    style="background: #6c757d; color: white; padding: 10px 14px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 5px;">
              ðŸ“… Set Hari Ini
            </button>
          </div>
          <div class="date-info" id="tanggalStartInfo">Tanggal mulai keanggotaan</div>
          <div id="tanggalStartError" class="validation-error"></div>
        </div>

        <div style="margin-bottom: 20px; display: none;">
          <label><strong>Tanggal Berakhir *</strong></label>
          <input type="date" id="tanggalEnd" readonly required 
                 style="display: none;">
          <div class="date-info" id="tanggalEndInfo">Otomatis dihitung 1 bulan dari tanggal mulai</div>
          <div id="tanggalEndError" class="validation-error"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <label><strong>Jenis Sampah *</strong></label>
            <select id="jenisSampah" required 
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px;">
              <option value="">-- Pilih Jenis Sampah --</option>
              <option value="rumah_tangga">Rumah Tangga</option>
              <option value="tempat_usaha">Tempat Usaha</option>
            </select>
            <div id="jenisSampahError" class="validation-error"></div>
          </div>
          
          <div>
            <label><strong>Status Keanggotaan *</strong></label>
            <select id="status" required disabled
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px; background: #f5f5f5;">
              <option value="aktif">Aktif</option>
            </select>
            <div class="date-info">Status akan otomatis "Aktif"</div>
          </div>
        </div>

        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 5px solid #ffc107; margin-bottom: 20px;">
          <h4 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
            <i class="bi bi-info-circle"></i> Informasi Keanggotaan
          </h4>
          <ul style="margin-bottom: 0; color: #856404;">
            <li>Durasi keanggotaan: <strong>1 bulan</strong> (30 hari)</li>
            <li>Biaya: <strong>Rp 50.000 per bulan</strong></li>
            <li>Layanan: <strong>4 kali angkut sampah per bulan</strong></li>
            <li>Status: <strong>Aktif</strong></li>
            <li>Verifikasi: <strong>1x24 jam</strong> setelah pengajuan</li>
          </ul>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" id="submitBtn"
                  style="flex: 1; background: #4CAF50; color: white; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
            ðŸ“‹ Ajukan Upgrade
          </button>
          <button type="button" id="btnBack" 
                  style="flex: 1; background: #757575; color: white; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
            â† Kembali ke Dashboard
          </button>
        </div>
        
        <div id="formMessage" style="margin-top: 15px;"></div>
      </form>
    </div>
  `,document.getElementById("btnBack").onclick=()=>{window.location.hash="#/dashboard"},Zm(),document.getElementById("btnSetToday").onclick=()=>{$o()},Xm(),ba(()=>{ai("mapSelect","latitude","longitude",-10.1772,123.607).then(l=>{window.__upgradeMap=l,l.on("click",function(r){const{lat:c,lng:d}=r.latlng;if(document.getElementById("latitude").value=c.toFixed(7),document.getElementById("longitude").value=d.toFixed(7),ae&&(ae.remove(),Marker=null),za)za.setLatLng([c,d]);else{const m=L.divIcon({html:`<div style="
                background-color: #4CAF50;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 0 10px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
              ">
                <i class="bi bi-house" style="font-size: 12px;"></i>
              </div>`,className:"custom-marker-icon",iconSize:[30,30],iconAnchor:[15,15]});za=L.marker([c,d],{icon:m}).addTo(l)}za.bindPopup(`
            <div style="font-size: 14px;">
              <strong>ðŸ“ Lokasi Rumah</strong><br>
              Lat: ${c.toFixed(6)}<br>
              Lng: ${d.toFixed(6)}
            </div>
          `).openPopup(),l.setView([c,d],17),Ba("latitude"),Ba("longitude"),Za(),_a("âœ… Lokasi berhasil dipilih dengan klik peta","success")}),setTimeout(()=>{l.invalidateSize()},300)}).catch(l=>{console.error("Gagal inisialisasi peta:",l)}),document.getElementById("latitude").value=-10.1772,document.getElementById("longitude").value=123.607,ns(),Za()});const i=document.getElementById("btnGetLocation");i.addEventListener("click",()=>{if(!("geolocation"in navigator)){_a("âŒ Browser Anda tidak mendukung GPS","error");return}i.disabled=!0,i.innerHTML="â³ Mengambil lokasi...",navigator.geolocation.getCurrentPosition(n=>{const{latitude:o,longitude:l,accuracy:r}=n.coords;if(document.getElementById("latitude").value=o.toFixed(7),document.getElementById("longitude").value=l.toFixed(7),window.__upgradeMap){const c=window.__upgradeMap;c.setView([o,l],17),za&&(za.remove(),za=null);const d=L.divIcon({html:`<div style="
              background-color: #2196F3;
              width: 35px;
              height: 35px;
              border-radius: 50%;
              border: 3px solid white;
              box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-weight: bold;
            ">
              <i class="bi bi-geo-alt-fill" style="font-size: 16px;"></i>
            </div>`,className:"gps-marker-icon",iconSize:[35,35],iconAnchor:[17.5,17.5]});ae?ae.setLatLng([o,l]):ae=L.marker([o,l],{icon:d}).addTo(c),ae.bindPopup(`
            <div style="font-size: 14px;">
              <strong>ðŸ“ Lokasi GPS Anda</strong><br>
              Lat: ${o.toFixed(6)}<br>
              Lng: ${l.toFixed(6)}<br>
              <small>Akurasi: Â±${Math.round(r)} meter</small>
            </div>
          `).openPopup(),setTimeout(()=>{c.invalidateSize()},200)}Ba("latitude"),Ba("longitude"),Za(),_a(`ðŸ“ Lokasi GPS berhasil diambil<br>
          <small>Akurasi Â±${Math.round(r)} meter</small>`,"success"),i.disabled=!1,i.innerHTML="ðŸ“ Gunakan Lokasi Saya (GPS)"},n=>{let o="Gagal mengambil lokasi GPS";switch(n.code){case n.PERMISSION_DENIED:o="âŒ Izin lokasi ditolak. Izinkan akses lokasi di browser Anda.";break;case n.POSITION_UNAVAILABLE:o="âŒ Lokasi tidak tersedia. Pastikan GPS aktif.";break;case n.TIMEOUT:o="â±ï¸ Waktu tunggu habis. Coba lagi.";break}_a(o,"error"),i.disabled=!1,i.innerHTML="ðŸ“ Gunakan Lokasi Saya (GPS)"},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}),document.getElementById("btnClearMarker").addEventListener("click",()=>{ae&&(ae.remove(),ae=null),za&&(za.remove(),za=null);const n=-10.1772,o=123.607;document.getElementById("latitude").value=n,document.getElementById("longitude").value=o,window.__upgradeMap&&window.__upgradeMap.setView([n,o],13),Ba("latitude"),Ba("longitude"),Za(),_a("ðŸ—‘ï¸ Semua marker telah dihapus","info")}),document.getElementById("formUpgrade").onsubmit=Qm}function Zm(){const e=new Date;vt("tanggalStart",e);const a=new Date(e);a.setMonth(e.getMonth()+1),vt("tanggalEnd",a),_i(),document.getElementById("tanggalStart").addEventListener("change",function(){const t=new Date(this.value),i=new Date;if(i.setHours(0,0,0,0),t<i){_a("âŒ Tanggal mulai tidak boleh sebelum hari ini","error"),$o();return}const s=new Date(t);s.setMonth(t.getMonth()+1),vt("tanggalEnd",s),_i(),Ba("tanggalStart"),Ba("tanggalEnd"),Za()})}function $o(){const e=new Date;vt("tanggalStart",e);const a=new Date(e);a.setMonth(e.getMonth()+1),vt("tanggalEnd",a),_i(),_a("âœ… Tanggal mulai diatur ke hari ini","success"),Ba("tanggalStart"),Ba("tanggalEnd"),Za()}function vt(e,a){const t=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0"),n=`${t}-${i}-${s}`;document.getElementById(e).value=n}function _i(){const e=new Date(document.getElementById("tanggalStart").value),a=new Date(document.getElementById("tanggalEnd").value),t={weekday:"long",year:"numeric",month:"long",day:"numeric"},i=e.toLocaleDateString("id-ID",t),s=a.toLocaleDateString("id-ID",t),n=Math.abs(a-e),o=Math.ceil(n/(1e3*60*60*24));document.getElementById("tanggalStartInfo").textContent=`Mulai: ${i}`,document.getElementById("tanggalEndInfo").textContent=`Berakhir: ${s} (${o} hari)`}function Xm(){["nama","noWA","alamat","latitude","longitude","tanggalStart","jenisSampah"].forEach(a=>{const t=document.getElementById(a);t&&(t.addEventListener("input",()=>{Ba(a),Za()}),t.addEventListener("blur",()=>{Ba(a),Za()}))}),document.getElementById("jenisSampah").addEventListener("change",()=>{Ba("jenisSampah"),Za()})}function Ba(e){const a=document.getElementById(e),t=document.getElementById(`${e}Error`),i=a.value.trim();if(!t)return!0;let s=!0,n="";switch(e){case"nama":i?i.length<3&&(n="Nama minimal 3 karakter",s=!1):(n="Nama lengkap harus diisi",s=!1);break;case"noWA":if(!i){n="Nomor WhatsApp harus diisi",s=!1;break}const o=i.replace(/[^0-9]/g,"");o.startsWith("08")?(o.length<10||o.length>12)&&(n="Nomor WhatsApp harus 12 digit",s=!1):(n="Nomor WhatsApp harus diawali 08",s=!1);break;case"alamat":i?i.length<6&&(n="Alamat terlalu pendek",s=!1):(n="Alamat harus diisi",s=!1);break;case"latitude":case"longitude":i||(n="Pilih lokasi di peta atau gunakan GPS",s=!1);break;case"tanggalStart":if(!i)n="Tanggal mulai harus diisi",s=!1;else{const l=new Date(i),r=new Date;r.setHours(0,0,0,0),l<r&&(n="Tanggal tidak boleh sebelum hari ini",s=!1)}break;case"tanggalEnd":break;case"jenisSampah":i||(n="Pilih jenis sampah",s=!1);break}return s?(t.style.display="none",t.textContent="",a.classList.remove("is-invalid")):(t.style.display="block",t.textContent=n,a.classList.add("is-invalid")),s}function ns(){const e=["nama","noWA","alamat","latitude","longitude","tanggalStart","jenisSampah"];let a=!0;return e.forEach(t=>{Ba(t)||(a=!1)}),a}function Za(){const e=ns(),a=document.getElementById("submitBtn");a.disabled=!e,a.style.backgroundColor=e?"#4CAF50":"#cccccc",a.style.cursor=e?"pointer":"not-allowed",e?a.innerHTML="ðŸ“‹ Ajukan Upgrade":a.innerHTML="âš ï¸ Lengkapi Data"}async function Qm(e){if(e.preventDefault(),!ns()){_a("Periksa kembali data yang Anda masukkan","error");return}if(!localStorage.getItem("access")){Ei();return}const t=await Da();if(!t||t.role!=="tamu"){_a("Hanya Tamu yang bisa melakukan upgrade anggota.","error");return}const i=document.getElementById("nama").value.trim(),s=document.getElementById("alamat").value.trim(),n=document.getElementById("noWA").value.trim(),o=parseFloat(document.getElementById("latitude").value),l=parseFloat(document.getElementById("longitude").value),r=document.getElementById("tanggalStart").value,c=document.getElementById("tanggalEnd").value,d=document.getElementById("jenisSampah").value,u={nama:i,alamat:s,noWA:n,latitude:o,longitude:l,tanggalStart:r,tanggalEnd:c,status:"aktif",jenisSampah:d,idUser:t.id};console.log("Submitting upgrade data:",u),_a("Mengirim permohonan upgrade...","info");const g=document.getElementById("submitBtn");g.disabled=!0,g.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Mengirim...';try{const p=await fetch(`${b.upgradeAnggota}`,{method:"POST",headers:v(),body:JSON.stringify(u)});if(console.log("Response status:",p.status),p.status===401||p.status===403){Ei();return}let h;const f=p.headers.get("content-type");if(f&&f.includes("application/json"))h=await p.json();else{const w=await p.text();console.log("Non-JSON response:",w.substring(0,200)),h={message:w}}if(!p.ok)throw new Error(h.detail||h.message||`HTTP ${p.status}`);_a("âœ… Permohonan upgrade berhasil dikirim! Status Anda Sekarang Aktif. ","success");const k=JSON.parse(localStorage.getItem("user")||"{}");k.role="anggota",localStorage.setItem("user",JSON.stringify(k)),setTimeout(()=>{window.location.hash="#/login"},3e3)}catch(p){if(console.error("Upgrade error:",p),p.message.includes("401")||p.message.includes("Unauthorized")||p.message.includes("403")||p.message.includes("Forbidden")){Ei();return}_a(`âŒ Gagal mengirim permohonan: ${p.message}`,"error"),g.disabled=!1,g.innerHTML="ðŸ“‹ Upgrade",Za()}}function Ei(){localStorage.removeItem("access"),localStorage.removeItem("refresh"),localStorage.removeItem("user"),alert("Session expired. Silakan login kembali."),window.location.hash="#/login",setTimeout(()=>{window.location.reload()},100)}function _a(e,a="info"){const t=document.getElementById("formMessage");t&&(t.innerHTML="",t.style.padding="10px 15px",t.style.borderRadius="4px",t.style.marginTop="10px",t.style.fontSize="14px",a==="error"?(t.style.backgroundColor="#ffebee",t.style.color="#c62828",t.style.border="1px solid #ffcdd2"):a==="success"?(t.style.backgroundColor="#e8f5e9",t.style.color="#2e7d32",t.style.border="1px solid #c8e6c9"):(t.style.backgroundColor="#e3f2fd",t.style.color="#1565c0",t.style.border="1px solid #bbdefb"),t.innerHTML=e,a==="info"&&setTimeout(()=>{t.innerHTML===e&&(t.innerHTML="",t.style="")},5e3))}window.testUpgradeEndpoint=async function(){var e;console.log("Testing endpoint:",b.upgradeAnggota),console.log("Token:",((e=localStorage.getItem("access"))==null?void 0:e.substring(0,20))+"...");try{const a=await fetch(b.upgradeAnggota,{method:"GET",headers:v()});console.log("GET Response status:",a.status),console.log("Content-Type:",a.headers.get("content-type"));const t=await a.text();console.log("Response (first 300 chars):",t.substring(0,300))}catch(a){console.error("Test failed:",a)}};async function Eo(){const e=document.getElementById("app");e.innerHTML=`
    <div class="container py-5">
      <div class="text-center py-5">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Memuat data analisis dampak lingkungan...</p>
      </div>
    </div>
  `;try{const t=new URLSearchParams(window.location.hash.split("?")[1]).get("days")||"30",i=await au(t);eu(e,i,t),lu()}catch(a){console.error("Error loading analisis dampak:",a),e.innerHTML=`
      <div class="container py-5">
        <div class="alert alert-danger">
          <h4 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Gagal Memuat Data</h4>
          <p>Terjadi kesalahan saat mengambil data analisis dampak lingkungan.</p>
          <div class="mt-3">
            <button onclick="window.location.hash='#/'" class="btn btn-primary">
              <i class="bi bi-house me-1"></i> Kembali ke Beranda
            </button>
            <button onclick="analisisDampakPage()" class="btn btn-outline-secondary ms-2">
              <i class="bi bi-arrow-clockwise me-1"></i> Coba Lagi
            </button>
          </div>
        </div>
      </div>
    `}}async function au(e="30"){try{const a=await fetch(`${b.publicAnalisisLingkungan}?days=${e}`,{headers:Ao()});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return await a.json()}catch(a){throw console.error("Error fetching analisis data:",a),a}}function eu(e,a,t){var l,r,c,d;const i=((l=a.period)==null?void 0:l.label)||`${t} Hari Terakhir`,s=((r=a.ringkasan)==null?void 0:r.total_laporan)||0,n=((c=a.ringkasan)==null?void 0:c.persentase_selesai)||0,o=((d=a.ringkasan)==null?void 0:d.update_terakhir)||"Sedang diperbarui";e.innerHTML=`
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" 
         style="background: rgba(27, 94, 32, 0.95); backdrop-filter: blur(10px);">
      <div class="container">
        <a class="navbar-brand fw-bold d-flex align-items-center" href="#/">
          <div class="me-2">
            <img src="/logo/logo_3d.png" 
                 alt="CleanUp Kupang Logo" 
                 style="height: 40px; width: auto;"
                 onerror="this.onerror=null; this.style.display='none';">
          </div>
          CleanUp Kupang
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#/">
                <i class="bi bi-house me-1"></i> Beranda
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#/analisis-dampak">
                <i class="bi bi-graph-up me-1"></i> Analisis
              </a>
            </li>
            <li class="nav-item ms-2">
              <a href="#/login" class="btn btn-warning btn-sm">
                <i class="bi bi-box-arrow-in-right me-1"></i> Login
              </a>
            </li>
            <li class="nav-item ms-2">
              <a href="#/register" class="btn btn-outline-light btn-sm">
                <i class="bi bi-person-plus me-1"></i> Daftar
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div style="padding-top: 80px;">
      <!-- HERO SECTION -->
      <section class="text-white" 
               style="background: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%);">
        <div class="container py-5">
          <div class="row align-items-center">
            <div class="col-lg-8">
              <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                  <img src="/logo/logo_3d.png" 
                       alt="CleanUp Kupang Logo" 
                       style="height: 60px; width: auto;"
                       onerror="this.onerror=null; this.style.display='none';">
                </div>
                <div>
                  <h1 class="display-5 fw-bold mb-2">Analisis Dampak Lingkungan</h1>
                  <p class="lead mb-0">Dashboard Publik Pengelolaan Sampah Kota Kupang</p>
                </div>
              </div>
              <div class="d-flex flex-wrap align-items-center gap-3 mt-4">
                <div class="bg-white bg-opacity-25 px-3 py-2 rounded-pill">
                  <small>
                    <i class="bi bi-calendar me-1"></i>
                    ${i}
                  </small>
                </div>
                <div class="bg-white bg-opacity-25 px-3 py-2 rounded-pill">
                  <small>
                    <i class="bi bi-file-text me-1"></i>
                    Total: ${s}
                  </small>
                </div>
                <div class="bg-white bg-opacity-25 px-3 py-2 rounded-pill">
                  <small>
                    <i class="bi bi-check-circle me-1"></i>
                    Selesai: ${n}%
                  </small>
                </div>
              </div>
            </div>
            <div class="col-lg-4 text-center mt-4 mt-lg-0">
              <div class="bg-white bg-opacity-10 rounded-3 p-4" id="statusCard">
                <div class="display-6 fw-bold mb-1" id="statusLingkungan">-</div>
                <p class="mb-0 text-white-75">Status Lingkungan</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- STATS CARDS -->
      <section class="bg-light py-4">
        <div class="container">
          <div class="row g-3" id="statsCards">
            <!-- Stats akan diisi oleh JavaScript -->
          </div>
        </div>
      </section>

      <!-- MAIN CONTENT -->
      <section class="py-5">
        <div class="container">
          <div class="row">
            <!-- LEFT COLUMN: Analisis Dampak Lingkungan -->
            <div class="col-lg-8 mb-5">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <h3 class="fw-bold mb-0">
                      <i class="bi bi-graph-up text-success me-2"></i>
                      Analisis Dampak Lingkungan
                    </h3>
                    <div class="dropdown">
                      <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" 
                              data-bs-toggle="dropdown">
                        <i class="bi bi-filter me-1"></i> ${t} Hari
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-days="7">7 Hari Terakhir</a></li>
                        <li><a class="dropdown-item" href="#" data-days="30">30 Hari Terakhir</a></li>
                        <li><a class="dropdown-item" href="#" data-days="90">90 Hari Terakhir</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <!-- Chart Container -->
                  <div class="mb-4" style="height: 300px;">
                    <canvas id="jenisSampahChart"></canvas>
                  </div>
                  
                  <!-- Jenis Sampah Detail -->
                  <div id="jenisSampahList">
                    <!-- Detail akan diisi oleh JavaScript -->
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT COLUMN: Ranking Wilayah & Tips -->
            <div class="col-lg-4">
              <!-- Wilayah Terkotor -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-danger bg-opacity-10 text-danger border-0 py-3">
                  <h5 class="fw-bold mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Wilayah Terkotor
                  </h5>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush" id="wilayahTerkotorList">
                    <!-- Data akan diisi oleh JavaScript -->
                  </div>
                </div>
              </div>

              <!-- Wilayah Terbersih -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success bg-opacity-10 text-success border-0 py-3">
                  <h5 class="fw-bold mb-0">
                    <i class="bi bi-trophy me-2"></i>
                    Wilayah Terbersih
                  </h5>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush" id="wilayahTerbersihList">
                    <!-- Data akan diisi oleh JavaScript -->
                  </div>
                </div>
              </div>

              <!-- Tips Lingkungan -->
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-info bg-opacity-10 text-info border-0 py-3">
                  <h5 class="fw-bold mb-0">
                    <i class="bi bi-lightbulb me-2"></i>
                    Tips Lingkungan
                  </h5>
                </div>
                <div class="card-body">
                  <div id="tipsLingkunganList">
                    <!-- Tips akan diisi oleh JavaScript -->
                  </div>
                  <div class="text-center mt-3">
                    <button onclick="shareTips()" class="btn btn-outline-success btn-sm">
                      <i class="bi bi-share me-1"></i> Bagikan Tips
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CALL TO ACTION -->
      <section class="py-5 bg-success bg-opacity-10">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-lg-8">
              <h3 class="fw-bold mb-3">Berkontribusi untuk Kota Kupang yang Lebih Bersih</h3>
              <p class="mb-0">
                Laporkan timbunan sampah di sekitar Anda dan bantu kami memantau kondisi lingkungan.
              </p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
              <a href="#/register" class="btn btn-success btn-lg px-4">
                <i class="bi bi-plus-circle me-2"></i> Laporkan Sampah
              </a>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- FOOTER -->
    <footer class="bg-dark text-white py-4">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <img src="/logo/logo_3d.png" 
                     alt="CleanUp Kupang Logo" 
                     style="height: 40px; width: auto;"
                     onerror="this.onerror=null; this.style.display='none';">
              </div>
              <div>
                <p class="mb-0 text-white-50">Â© 2025 CleanUp Kupang</p>
                <small class="text-white-50">Dashboard Analisis Dampak Lingkungan</small>
              </div>
            </div>
          </div>
          <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <small class="text-white-50">
              Update: ${o}
            </small>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"><\/script>
    
    <!-- Custom CSS -->
    <style>
      :root {
        --bs-success: #198754;
        --bs-success-rgb: 25, 135, 84;
      }
      
      .navbar {
        transition: all 0.3s ease;
      }
      
      .navbar.scrolled {
        background: rgba(27, 94, 32, 0.95) !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .stat-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 12px;
      }
      
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
      }
      
      .jenis-sampah-item {
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
        border-radius: 8px;
      }
      
      .jenis-sampah-item:hover {
        background-color: rgba(25, 135, 84, 0.05);
        border-left-color: var(--bs-success);
      }
      
      .ranking-badge {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: bold;
        font-size: 0.875rem;
        flex-shrink: 0;
      }
      
      .rank-1 { background-color: #ff4444; color: white; }
      .rank-2 { background-color: #ff6b6b; color: white; }
      .rank-3 { background-color: #ff9999; color: #333; }
      .rank-4, .rank-5 { background-color: #ffe6e6; color: #333; }
      
      .rank-clean-1 { background-color: #4caf50; color: white; }
      .rank-clean-2 { background-color: #66bb6a; color: white; }
      .rank-clean-3 { background-color: #81c784; color: white; }
      .rank-clean-4, .rank-clean-5 { background-color: #e8f5e9; color: #333; }
      
      .danger-high { background: linear-gradient(45deg, #ff4444, #ff6b6b) !important; }
      .danger-medium { background: linear-gradient(45deg, #ffa726, #ffb74d) !important; }
      .danger-low { background: linear-gradient(45deg, #4caf50, #66bb6a) !important; }
      .danger-none { background: linear-gradient(45deg, #757575, #9e9e9e) !important; }
      
      .progress {
        height: 8px;
        border-radius: 4px;
      }
      
      body {
        font-family: 'Inter', sans-serif;
      }
      
      .card {
        border-radius: 12px;
        overflow: hidden;
      }
      
      .chart-container {
        position: relative;
        height: 300px;
      }
      
      @media (max-width: 768px) {
        .hero-section .display-5 {
          font-size: 2rem;
        }
        .stat-card .fw-bold {
          font-size: 1.5rem;
        }
      }
    </style>
  `,setTimeout(async()=>{await tu(),iu(a),su(a),ou(a)},100)}async function tu(){if(typeof Chart>"u")try{await new Promise((e,a)=>{const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/chart.js",t.onload=e,t.onerror=a,document.head.appendChild(t)}),console.log("Chart.js loaded successfully")}catch(e){throw console.error("Failed to load Chart.js:",e),e}}function iu(e){var o,l,r,c,d;const a=document.getElementById("statsCards");if(a){const m=((o=e.ringkasan)==null?void 0:o.total_laporan)||0,u=((l=e.ringkasan)==null?void 0:l.laporan_selesai)||0,g=m-u,p=((r=e.analisis_dampak_lingkungan)==null?void 0:r.total_berbahaya)||0,h=[{icon:"bi-file-text",title:"Total Laporan",value:m,color:"primary",bg:"bg-primary bg-opacity-10 text-primary",tooltip:"Total laporan sampah dalam periode ini"},{icon:"bi-check-circle",title:"Selesai",value:`${((c=e.ringkasan)==null?void 0:c.persentase_selesai)||0}%`,color:"success",bg:"bg-success bg-opacity-10 text-success",tooltip:"Persentase laporan yang sudah ditangani"},{icon:"bi-clock-history",title:"Pending",value:g,color:"warning",bg:"bg-warning bg-opacity-10 text-warning",tooltip:"Laporan yang masih dalam proses"},{icon:"bi-exclamation-triangle",title:"Berbahaya",value:p,color:"danger",bg:"bg-danger bg-opacity-10 text-danger",tooltip:"Laporan sampah berbahaya/B3"}];a.innerHTML=h.map(f=>`
      <div class="col-md-3 col-6">
        <div class="card border-0 shadow-sm stat-card h-100" data-bs-toggle="tooltip" title="${f.tooltip}">
          <div class="card-body text-center p-3">
            <div class="${f.bg} rounded-circle p-3 d-inline-flex align-items-center justify-content-center mb-3" 
                 style="width: 60px; height: 60px;">
              <i class="bi ${f.icon} fs-4"></i>
            </div>
            <h3 class="fw-bold mb-1">${Xe(f.value)}</h3>
            <p class="text-muted mb-0 small">${f.title}</p>
          </div>
        </div>
      </div>
    `).join("")}const t=document.getElementById("jenisSampahList");if(t){const m=((d=e.analisis_dampak_lingkungan)==null?void 0:d.detail)||[];m.length===0?t.innerHTML=`
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Tidak ada data jenis sampah untuk periode ini.
        </div>
      `:t.innerHTML=m.map((u,g)=>`
        <div class="jenis-sampah-item p-3 mb-2 rounded" style="border-left-color: ${u.warna||"#666"}">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center">
              <span class="me-3" style="font-size: 1.5rem;">${u.ikon||"ðŸ“Š"}</span>
              <div>
                <h6 class="fw-bold mb-0 text-capitalize">${Pt(u.jenis)}</h6>
                <small class="text-muted">${Fs(u.dampak_lingkungan||"Dampak lingkungan",60)}</small>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold">${Xe(u.jumlah)} laporan</div>
              <div class="text-muted small">${u.persentase||0}% dari total</div>
            </div>
          </div>
          <div class="progress mb-2">
            <div class="progress-bar" 
                 style="width: ${u.persentase||0}%; background-color: ${u.warna||"#666"};"
                 role="progressbar"
                 aria-valuenow="${u.persentase||0}"
                 aria-valuemin="0"
                 aria-valuemax="100">
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <small class="text-muted">
              <i class="bi ${du(u.tingkat_bahaya)} me-1"></i>
              ${ru(u.tingkat_bahaya)}
            </small>
            <small class="text-muted text-end">
              <i class="bi bi-lightbulb me-1"></i>
              ${Fs(u.rekomendasi_sederhana||"",40)}
            </small>
          </div>
        </div>
      `).join("")}const i=document.getElementById("wilayahTerkotorList");if(i){const m=e.wilayah_terkotor||[];m.length===0?i.innerHTML=`
        <div class="list-group-item border-0 py-4 text-center">
          <i class="bi bi-inbox text-muted mb-2 d-block" style="font-size: 2rem;"></i>
          <p class="text-muted small mb-0">Tidak ada data wilayah terkotor</p>
        </div>
      `:i.innerHTML=m.map((u,g)=>`
        <div class="list-group-item border-0 py-3">
          <div class="d-flex align-items-center">
            <div class="ranking-badge rank-${Math.min(g+1,5)} me-3">
              ${u.peringkat||g+1}
            </div>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1 text-capitalize">${_s(u.wilayah)}</div>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">${Xe(u.total_laporan)} laporan</small>
                <span class="badge bg-danger bg-opacity-25 text-danger">
                  ${u.kategori||"Kotor"}
                </span>
              </div>
              <div class="progress mt-1" style="height: 4px;">
                <div class="progress-bar bg-danger" 
                     style="width: ${Math.min(u.persentase_selesai||0,100)}%"
                     title="${u.persentase_selesai||0}% selesai">
                </div>
              </div>
              <small class="text-muted d-block mt-1">
                <i class="bi bi-check-circle me-1"></i>
                Selesai: ${u.persentase_selesai||0}%
              </small>
              <small class="text-muted d-block">
                <i class="bi bi-calendar me-1"></i>
                ${u.tanggal_terakhir||"-"}
              </small>
            </div>
          </div>
        </div>
      `).join("")}const s=document.getElementById("wilayahTerbersihList");if(s){const m=e.wilayah_terbersih||[];m.length===0?s.innerHTML=`
        <div class="list-group-item border-0 py-4 text-center">
          <i class="bi bi-inbox text-muted mb-2 d-block" style="font-size: 2rem;"></i>
          <p class="text-muted small mb-0">Tidak ada data wilayah terbersih</p>
        </div>
      `:s.innerHTML=m.map((u,g)=>`
        <div class="list-group-item border-0 py-3">
          <div class="d-flex align-items-center">
            <div class="ranking-badge rank-clean-${Math.min(g+1,5)} me-3">
              ${u.peringkat||g+1}
            </div>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1 text-capitalize">${_s(u.wilayah)}</div>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">${Xe(u.total_laporan)} laporan</small>
                <span class="badge bg-success bg-opacity-25 text-success">
                  ${u.kategori||"Bersih"}
                </span>
              </div>
              <div class="progress mt-1" style="height: 4px;">
                <div class="progress-bar bg-success" 
                     style="width: ${Math.min(u.persentase_selesai||0,100)}%"
                     title="${u.persentase_selesai||0}% selesai">
                </div>
              </div>
              <small class="text-muted d-block mt-1">
                <i class="bi bi-check-circle me-1"></i>
                Selesai: ${u.persentase_selesai||0}%
              </small>
              <small class="text-muted d-block">
                <i class="bi bi-calendar me-1"></i>
                ${u.tanggal_terakhir||"-"}
              </small>
            </div>
          </div>
        </div>
      `).join("")}const n=document.getElementById("tipsLingkunganList");if(n){const m=e.tips_lingkungan||["Pilah sampah organik dan non-organik di rumah","Kurangi penggunaan plastik sekali pakai","Gunakan tas belanja reusable","Daur ulang kertas, plastik, dan logam","Buat kompos dari sampah organik"];n.innerHTML=m.map((u,g)=>`
      <div class="d-flex mb-3">
        <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3 flex-shrink-0 d-flex align-items-center justify-content-center" 
             style="width: 40px; height: 40px;">
          <span class="text-success fw-bold">${g+1}</span>
        </div>
        <div class="flex-grow-1">
          <p class="mb-0 small">${u}</p>
        </div>
      </div>
    `).join("")}}function su(e){var i;const a=document.getElementById("jenisSampahChart");if(!a){console.error("Canvas element not found!");return}const t=((i=e.analisis_dampak_lingkungan)==null?void 0:i.detail)||[];if(t.length===0){a.parentElement.innerHTML=`
      <div class="text-center py-5">
        <i class="bi bi-pie-chart text-muted mb-3" style="font-size: 3rem;"></i>
        <p class="text-muted">Tidak ada data untuk ditampilkan dalam chart</p>
      </div>
    `;return}console.log("Setting up chart with data:",t);try{const s=Chart.getChart(a);s&&s.destroy();const n=t.filter(l=>{const r=!isNaN(l.jumlah)&&l.jumlah>0;return r||console.warn("Invalid data for chart:",l),r});if(n.length===0)throw new Error("No valid data for chart");const o=new Chart(a,{type:"doughnut",data:{labels:n.map(l=>Pt(l.jenis)),datasets:[{data:n.map(l=>l.jumlah),backgroundColor:n.map(l=>l.warna||nu()),borderWidth:2,borderColor:"#fff",hoverOffset:15}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{padding:20,usePointStyle:!0,pointStyle:"circle",font:{size:11},color:"#333"}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",borderColor:"#198754",borderWidth:1,callbacks:{label:function(l){const r=n[l.dataIndex];return`${Pt(r.jenis)}: ${Xe(r.jumlah)} laporan (${r.persentase||0}%)`}}}},cutout:"60%",animation:{animateScale:!0,animateRotate:!0,duration:1e3}}});return console.log("Chart created successfully"),o}catch(s){console.error("Error setting up chart:",s),a.parentElement.innerHTML=`
      <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Chart tidak dapat ditampilkan. Berikut data dalam bentuk tabel:
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Jenis Sampah</th>
              <th>Jumlah</th>
              <th>Persentase</th>
              <th>Warna</th>
            </tr>
          </thead>
          <tbody>
            ${t.map(n=>`
              <tr>
                <td>${Pt(n.jenis)}</td>
                <td>${Xe(n.jumlah)}</td>
                <td>${n.persentase||0}%</td>
                <td>
                  <div style="width: 20px; height: 20px; background-color: ${n.warna||"#666"}; border-radius: 3px;"></div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `}}function nu(){const e=["#FF6B6B","#4ECDC4","#FFD166","#06D6A0","#118AB2","#EF476F","#FFD166","#06D6A0","#118AB2","#073B4C"];return e[Math.floor(Math.random()*e.length)]}function ou(e){var r;const a=document.getElementById("statusLingkungan"),t=document.getElementById("statusCard");if(!a||!t)return;const i=((r=e.analisis_dampak_lingkungan)==null?void 0:r.status_lingkungan)||"data_terbatas",s={baik:{text:"BAIK",class:"text-white",bg:"danger-low",icon:"bi-check-circle"},waspada:{text:"WASPADA",class:"text-white",bg:"danger-medium",icon:"bi-exclamation-triangle"},perhatian:{text:"PERHATIAN",class:"text-white",bg:"danger-high",icon:"bi-exclamation-triangle-fill"},data_terbatas:{text:"DATA TERBATAS",class:"text-white",bg:"danger-none",icon:"bi-info-circle"}},n=s[i]||s.data_terbatas;a.innerHTML="";const o=document.createElement("i");o.className=`bi ${n.icon} me-2`;const l=document.createElement("span");l.textContent=n.text,a.appendChild(o),a.appendChild(l),a.className=`display-6 fw-bold mb-1 ${n.class}`,t.className=`${n.bg} rounded-3 p-4 text-white text-center`}function lu(){document.querySelectorAll("[data-days]").forEach(a=>{a.addEventListener("click",function(t){t.preventDefault();const i=this.getAttribute("data-days");window.location.hash=`#/analisis-dampak?days=${i}`,setTimeout(()=>{Eo()},100)})});const e=function(){const a=document.querySelector(".navbar");a&&(window.scrollY>50?a.classList.add("scrolled"):a.classList.remove("scrolled"))};window.addEventListener("scroll",e),setTimeout(()=>{[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(t){try{return new bootstrap.Tooltip(t)}catch(i){return console.warn("Failed to initialize tooltip:",i),null}})},500),window._analisisScrollHandler=e}function Xe(e){return typeof e!="number"?e:new Intl.NumberFormat("id-ID").format(e)}function Pt(e){return e?{plastik:"Plastik",organik:"Organik",kertas:"Kertas",logam:"Logam",kaca:"Kaca",limbah_berbahaya:"Limbah Berbahaya",campuran:"Campuran",konstruksi:"Konstruksi",medis:"Medis",lainnya:"Lainnya",tidak_diketahui:"Tidak Diketahui"}[e.toLowerCase()]||e.charAt(0).toUpperCase()+e.slice(1).replace(/_/g," "):"Tidak Diketahui"}function _s(e){return e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():"Tidak Diketahui"}function ru(e){return e?{tinggi:"Tinggi",menengah:"Menengah",rendah:"Rendah",sangat_tinggi:"Sangat Tinggi",sedang:"Sedang"}[e.toLowerCase()]||e.charAt(0).toUpperCase()+e.slice(1):"Tidak diketahui"}function Fs(e,a){return e?e.length<=a?e:e.substring(0,a)+"...":""}function du(e){if(!e)return"bi-question-circle text-secondary";switch(e.toLowerCase()){case"sangat_tinggi":case"tinggi":return"bi-exclamation-triangle-fill text-danger";case"menengah":case"sedang":return"bi-exclamation-triangle text-warning";case"rendah":return"bi-check-circle text-success";default:return"bi-info-circle text-info"}}async function Fi(){const e=window.location.hash;if(console.log("ðŸ”„ ROUTER: path =",e),e===""||e==="#/"||e==="#/landing"||e==="#/home")return Si();if(e==="#/analisis-dampak"||e==="#/dampak-lingkungan")return Eo();if(e==="#/register-anggota")return Yo();if(e==="#/register")return zo();if(e==="#/login"){const t=await Da();return t?be(t.role):Po()}const a=await Da();if(console.log("ðŸ‘¤ USER =",a),!a)return window.location.hash="#/login",Si();switch(e){case"#/upgrade-anggota":return a.role!=="tamu"?(alert("Hanya tamu yang bisa upgrade akun!"),be(a.role)):Ym();case"#/dashboard":case"#/dashboard-admin":return a.role==="admin"?jn():be(a.role);case"#/dashboard-anggota":return a.role==="anggota"?eo():(alert("Hanya anggota yang bisa mengakses dashboard ini!"),be(a.role));case"#/dashboard-tim":return a.role==="tim_angkut"?ko():(alert("Hanya tim angkut yang bisa mengakses dashboard ini!"),be(a.role));case"#/dashboard-tamu":return a.role==="tamu"?wo():be(a.role);default:return be(a.role)}}function be(e){switch(console.log("âž¡ Redirecting role:",e),e){case"admin":return window.location.hash="#/dashboard-admin",jn();case"anggota":return window.location.hash="#/dashboard-anggota",eo();case"tim_angkut":return window.location.hash="#/dashboard-tim",ko();case"tamu":return window.location.hash="#/dashboard-tamu",wo();default:return window.location.hash="#/",Si()}}function To(){console.log("ðŸ”§ Setting up router..."),window.addEventListener("load",()=>{Fi()}),window.addEventListener("hashchange",async()=>{try{await Fi()}catch(e){console.error("âŒ Router error:",e);const a=document.getElementById("app");a&&(a.innerHTML=`
                    <div class="container mt-5">
                        <div class="alert alert-danger">
                            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Error</h4>
                            <p>Terjadi kesalahan: ${e.message}</p>
                            <div class="mt-3">
                                <button onclick="location.reload()" class="btn btn-primary">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                </button>
                                <button onclick="window.location.hash='#/'" class="btn btn-secondary ms-2">
                                    <i class="bi bi-house me-1"></i> Home
                                </button>
                            </div>
                        </div>
                    </div>
                `)}}),window.redirectByRole=be,console.log("âœ… Router setup complete")}To();const mu=Object.freeze(Object.defineProperty({__proto__:null,router:Fi,setupRouter:To},Symbol.toStringTag,{value:"Module"}));export{b as A,P as a,v as g,mu as r,x as s,Z as w};
