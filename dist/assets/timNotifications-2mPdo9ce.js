import{w as g,s as c,g as m,A as d,a as w}from"./router-D9V036Fn.js";import"./index-C2HavDub.js";class N{constructor(){this.notificationSubscription=null,this.unreadNotifications=0,this.notificationInterval=null,this.lastNotificationCheck=null,this.webPushInitialized=!1,this.user=null}async initialize(){try{if(console.log("üîî Initializing Tim Angkut Notifications..."),this.user=JSON.parse(localStorage.getItem("user")||"{}"),await this.setupScheduleChecker(),this.user.role!=="tim_angkut")return console.log(`‚ÑπÔ∏è User role ${this.user.role} doesn't need tim notifications`),!1;if(!g.isSupported)return console.log("‚ö†Ô∏è Web Push not supported in this browser"),this.updateNotificationUI("not-supported"),!1;try{await g.initialize(),this.webPushInitialized=!0,g.setupPushEventListener(),console.log("‚úÖ Web Push initialized for tim angkut")}catch(i){return console.error("Web Push init failed:",i),this.updateNotificationUI("service-worker-error"),!1}const t=await g.checkSubscription();return t?(console.log("‚úÖ Tim Angkut is subscribed to push notifications"),this.notificationSubscription=g.subscription,await this.updateUnreadNotificationsCount(),await this.updateNotificationUI("subscribed"),this.startNotificationPolling()):(console.log("‚ÑπÔ∏è Tim Angkut is not subscribed to push notifications"),await this.updateNotificationUI("unsubscribed")),t}catch(t){return console.error("‚ùå Error initializing tim notifications:",t),this.updateNotificationUI("error"),!1}}async enableNotifications(){try{if(console.log("üîÑ Enabling tim angkut notifications..."),JSON.parse(localStorage.getItem("user")||"{}").role!=="tim_angkut")return c("Hanya tim angkut yang dapat mengaktifkan notifikasi","error"),!1;if(this.updateNotificationUI("loading"),!g.isSupported)throw new Error("Browser tidak mendukung Web Push Notifications");if(Notification.permission==="denied")throw new Error("Permission untuk notifikasi telah ditolak. Mohon aktifkan di pengaturan browser.");if(Notification.permission==="default"&&await Notification.requestPermission()!=="granted")throw new Error("Izin notifikasi ditolak oleh pengguna");const i=await g.enableNotifications();return i.success?(console.log("‚úÖ Tim Angkut notifications enabled successfully"),this.notificationSubscription=g.subscription,await this.updateNotificationUI("subscribed"),this.startNotificationPolling(),c("Notifikasi tim angkut telah diaktifkan! Anda akan mendapatkan pemberitahuan tentang jadwal dan tugas.","success"),!0):(console.error("‚ùå Failed to enable tim notifications:",i.error),await this.updateNotificationUI("error"),c("Gagal mengaktifkan notifikasi","error"),!1)}catch(t){console.error("‚ùå Error enabling tim notifications:",t);let i="Terjadi kesalahan saat mengaktifkan notifikasi",e="error";return t.message.includes("Permission")||t.message.includes("Izin")?(i="Izin notifikasi ditolak. Mohon aktifkan di pengaturan browser.",e="permission-denied"):t.message.includes("Service Worker")?(i="Service Worker tidak tersedia. Pastikan Anda mengakses melalui HTTPS.",e="service-worker-error"):(t.message.includes("VAPID")||t.message.includes("fetch"))&&(i="Server notifikasi tidak dapat dijangkau. Coba lagi nanti.",e="server-unavailable"),await this.updateNotificationUI(e),c(i,"error"),!1}}async disableNotifications(){try{console.log("üîÑ Disabling tim angkut notifications..."),this.updateNotificationUI("loading");const t=await g.disableNotifications();return t.success?(console.log("‚úÖ Tim Angkut notifications disabled successfully"),this.notificationSubscription=null,this.unreadNotifications=0,this.stopNotificationPolling(),await this.updateNotificationUI("unsubscribed"),c("Notifikasi tim angkut telah dinonaktifkan","info"),!0):(console.error("‚ùå Failed to disable tim notifications:",t.error),await this.updateNotificationUI("error"),c("Gagal menonaktifkan notifikasi","error"),!1)}catch(t){return console.error("‚ùå Error disabling tim notifications:",t),await this.updateNotificationUI("error"),c("Terjadi kesalahan saat menonaktifkan notifikasi","error"),!1}}async toggleNotifications(){try{return await g.checkSubscription()?await this.disableNotifications():await this.enableNotifications(),!0}catch(t){return console.error("‚ùå Error toggling tim notifications:",t),c("Gagal mengubah pengaturan notifikasi","error"),!1}}async fetchTimNotifications(){try{console.log("üì• Fetching tim angkut notifications...");const t=m(),i=d.notifications;if(!i)return console.error("Notification API endpoint not configured"),this.getMockTimNotifications();const e=new URLSearchParams({user:this.user.id,notification_type:"schedule,alert,system",limit:"30",ordering:"-created_at"}),a=`${i}?${e}`;console.log(`Fetching from: ${a}`);const o=await fetch(a,{headers:t,credentials:"include"});if(!o.ok){if(o.status>=500)return console.error("Server error - menggunakan mock notifications"),this.getMockTimNotifications();const r=await o.text();throw console.error(`API Error ${o.status}:`,r.substring(0,200)),new Error(`HTTP ${o.status}: Server error`)}const n=await o.json();let s=[];return Array.isArray(n)?s=n:n&&n.results?s=n.results:n&&n.notifications&&(s=n.notifications),console.log(`üìä Received ${s.length} notifications for tim angkut ${this.user.username}`),this.unreadNotifications=s.filter(r=>!r.read).length,this.lastNotificationCheck=new Date,this.updateNotificationBadge(),s}catch(t){return console.error("‚ùå Error fetching tim notifications:",t.message),console.log("Using mock notifications for development"),this.getMockTimNotifications()}}async checkForNewTimNotifications(){try{if(!navigator.onLine)return console.log("üåê Offline - Skipping notification check"),[];const t=await this.fetchTimNotifications(),i=new Date(Date.now()-5*60*1e3),e=t.filter(a=>{try{return new Date(a.created_at||a.timestamp||Date.now())>i}catch{return!1}});return e.length>0&&Notification.permission==="granted"&&e.forEach(a=>{(a.priority==="high"||a.notification_type==="alert")&&this.showDesktopNotification(a)}),e}catch(t){return console.error("‚ùå Error checking for new tim notifications:",t),[]}}async updateUnreadNotificationsCount(){try{const t=await this.fetchTimNotifications();this.unreadNotifications=t.filter(i=>!i.read).length,this.updateNotificationBadge()}catch(t){console.error("Error updating unread count:",t)}}async sendTimTestNotification(){try{if(console.log("üöÄ Sending tim angkut test notification..."),JSON.parse(localStorage.getItem("user")||"{}").role!=="tim_angkut"){c("Hanya tim angkut yang dapat mengirim notifikasi test","error");return}if(!await g.checkSubscription()){c("Harap aktifkan notifikasi terlebih dahulu","warning");return}const e=await g.sendTestNotification();e.success?(c("Notifikasi test berhasil dikirim!","success",5e3),console.log("‚úÖ Test notification sent successfully")):(console.error("‚ùå Failed to send test notification:",e.message),c("error",e.message||"Gagal mengirim notifikasi test"))}catch(t){console.error("‚ùå Error sending tim test notification:",t);let i="Gagal mengirim notifikasi test";t.message.includes("network")||t.message.includes("fetch")?i="Server notifikasi tidak dapat dijangkau":(t.message.includes("401")||t.message.includes("Authentication"))&&(i="Sesi login telah habis. Silakan login ulang."),c(i,"error")}}async markAllTimNotificationsAsRead(){try{if(console.log("üìù Marking all admin notifications as read..."),!this.user||!this.user.id)throw new Error("User not found");const t=m(),i=d.notificationsMarkAllRead||`${d.notifications}mark-all-read/`;console.log("Using URL:",i);const e=await fetch(i,{method:"POST",headers:{...t,"Content-Type":"application/json"},credentials:"include"});if(console.log("Response status:",e.status),!e.ok){const o=await e.text();throw console.error("Error response:",o),new Error(`HTTP ${e.status}`)}const a=await e.json();return console.log("Response data:",a),this.unreadNotifications=0,this.updateNotificationBadge(),c(`Semua notifikasi (${a.count||0}) telah ditandai sebagai dibaca`,"success"),!0}catch(t){console.error("Error marking all notifications as read:",t);try{console.log("üîÑ Trying fallback: marking individual notifications...");const e=(await this.fetchNotifications()).filter(a=>!a.read);if(e.length>0){const a=m();for(const o of e)try{const n=`${d.notifications}${o.id}/mark_read/`;await fetch(n,{method:"POST",headers:a,credentials:"include"})}catch(n){console.warn(`Failed to mark notification ${o.id} as read:`,n.message)}}return this.unreadNotifications=0,this.updateNotificationBadge(),c("Semua notifikasi telah ditandai sebagai dibaca (fallback)","success"),!0}catch(i){return console.error("Fallback also failed:",i),this.unreadNotifications=0,this.updateNotificationBadge(),c("Notifikasi ditandai sebagai dibaca secara lokal","info"),!0}}}async deleteTimNotification(t){try{if(console.log(`üóëÔ∏è Deleting tim notification ${t}...`),!this.user||!this.user.id)throw new Error("User not found");const i=m();let e=d.notifications;if(!e)throw new Error("Notification API endpoint not configured");e.endsWith("/")||(e+="/");const a=`${e}${t}/`;console.log("Delete URL for tim:",a);const o=await fetch(a,{method:"DELETE",headers:i,credentials:"include"});if(!o.ok){const n=await o.text();return console.error(`Delete failed ${o.status}:`,n.substring(0,200)),await this.tryAlternativeDeleteTim(t)}return this.unreadNotifications>0&&(this.unreadNotifications--,this.updateNotificationBadge()),c("Notifikasi berhasil dihapus","success"),console.log(`‚úÖ Tim notification ${t} deleted successfully`),!0}catch(i){if(console.error("‚ùå Error deleting tim notification:",i),this.handleLocalTimDelete(t))return c("Notifikasi dihapus (mode pengembangan)","info"),!0;let a="Gagal menghapus notifikasi";return i.message.includes("404")?a="Notifikasi tidak ditemukan":(i.message.includes("401")||i.message.includes("403"))&&(a="Anda tidak memiliki izin untuk menghapus notifikasi"),c(a,"error"),!1}}async tryAlternativeDeleteTim(t){try{console.log("üîÑ Mencoba alternatif delete untuk tim...");const i=m(),e=[`${d.notifications}${t}/`,`${d.notifications}/${t}/`,`${d.base}/notifications/${t}/`,`${d.base}/tim/notifications/${t}/`,`${d.base}/tim-angikut/notifications/${t}/`];for(const a of e)try{if(console.log(`Mencoba: ${a}`),(await fetch(a,{method:"DELETE",headers:i,credentials:"include"})).ok)return console.log(`‚úÖ Delete berhasil via ${a}`),this.unreadNotifications>0&&(this.unreadNotifications--,this.updateNotificationBadge()),!0}catch(o){console.log(`URL ${a} gagal:`,o.message);continue}throw new Error("Semua alternatif gagal")}catch(i){throw console.error("‚ùå Semua percobaan delete tim gagal:",i),i}}async deleteAllTimNotifications(){try{if(console.log("üóëÔ∏è Deleting all tim notifications..."),!this.user||!this.user.id)throw new Error("User not found");if(!await this.showTimDeleteConfirmationModal())return!1;c("Menghapus semua notifikasi tim...","info",3e3);const i=m();let e;d.notifications?e=d.notifications.endsWith("/")?`${d.notifications}tim/all/`:`${d.notifications}/tim/all/`:e=`${d.base}/tim/notifications/all/`,console.log("Delete all URL for tim:",e);const a=await fetch(e,{method:"DELETE",headers:i,credentials:"include"});if(a.ok)return this.unreadNotifications=0,this.updateNotificationBadge(),c("Semua riwayat notifikasi tim telah dihapus","success",3e3),console.log("‚úÖ All tim notifications deleted successfully"),!0;if(a.status===404)return console.log("Endpoint /tim/all tidak ditemukan, menggunakan fallback..."),await this.deleteAllTimNotificationsFallback();{const o=await a.text();return console.error(`Delete all tim failed ${a.status}:`,o.substring(0,200)),await this.deleteAllTimNotificationsFallback()}}catch(t){console.error("‚ùå Error deleting all tim notifications:",t);try{if(await this.deleteAllTimNotificationsFallback())return!0}catch(i){console.error("Fallback juga gagal:",i)}return this.unreadNotifications=0,this.updateNotificationBadge(),c("Riwayat notifikasi tim direset (mode pengembangan)","info"),!0}}async deleteAllTimNotificationsFallback(){try{console.log("üîÑ Menggunakan fallback untuk delete all tim...");const t=await this.fetchTimNotifications();if(t.length===0)return console.log("Tidak ada notifikasi tim untuk dihapus"),c("Tidak ada notifikasi untuk dihapus","info"),!0;let i=0,e=0;for(const o of t)try{await this.deleteTimNotification(o.id),i++,await new Promise(n=>setTimeout(n,50))}catch(n){console.warn(`Gagal menghapus notifikasi tim ${o.id}:`,n.message),e++}this.unreadNotifications=0,this.updateNotificationBadge();let a=`Berhasil menghapus ${i} notifikasi tim`;return e>0&&(a+=`, ${e} gagal`),c(a,"success"),console.log(`‚úÖ Deleted ${i} tim notifications (${e} failed)`),i>0}catch(t){return console.error("‚ùå Error in tim fallback delete all:",t),this.unreadNotifications=0,this.updateNotificationBadge(),c("Notifikasi tim direset secara lokal","info"),!0}}async showTimNotificationModal(){try{console.log("üìã Showing tim angkut notification modal...");const t=await this.fetchTimNotifications(),i=`
                <div class="notification-modal-tim">
                    ${this.generateNotificationModalContent(t)}
                </div>
            `;w("Notifikasi Tim Angkut",i,"modal-lg"),this.setupNotificationModalEventListeners()}catch(t){console.error("‚ùå Error showing tim notification modal:",t),c("Gagal memuat notifikasi","error")}}handleLocalTimDelete(t){console.log(`üîß Local delete for tim notification ${t} (mock)`);const i=this.getMockTimNotifications();return console.log(`Mock: Menghapus notifikasi ${t} dari ${i.length} total`),this.unreadNotifications>0&&(this.unreadNotifications=Math.max(0,this.unreadNotifications-1),this.updateNotificationBadge()),!0}async updateNotificationUI(t){const i=document.getElementById("tim-notification-status"),e=document.getElementById("tim-toggleNotificationsBtn"),a=document.getElementById("tim-notification-status-mobile"),o=(r,l)=>{r&&(r.innerHTML=l)},n={loading:{badge:`<span class="badge bg-warning">
                    <i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1"></i> Memuat...
                </span>`,buttonText:'<i class="bi bi-arrow-repeat me-2"></i>Memuat...',disabled:!0},subscribed:{badge:`<span class="badge bg-success">
                    <i class="bi bi-bell-fill me-1"></i> Aktif
                </span>`,buttonText:'<i class="bi bi-bell-slash me-2"></i>Nonaktifkan',disabled:!1},unsubscribed:{badge:`<span class="badge bg-secondary">
                    <i class="bi bi-bell-slash me-1"></i> Nonaktif
                </span>`,buttonText:'<i class="bi bi-bell me-2"></i>Aktifkan',disabled:!1},"not-supported":{badge:`<span class="badge bg-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i> Tidak Didukung
                </span>`,buttonText:'<i class="bi bi-ban me-2"></i>Tidak Didukung',disabled:!0},"permission-denied":{badge:`<span class="badge bg-danger">
                    <i class="bi bi-slash-circle me-1"></i> Izin Ditolak
                </span>`,buttonText:'<i class="bi bi-slash-circle me-2"></i>Izin Ditolak',disabled:!0},"service-worker-error":{badge:`<span class="badge bg-danger">
                    <i class="bi bi-gear me-1"></i> Service Worker Error
                </span>`,buttonText:'<i class="bi bi-exclamation-triangle me-2"></i>Error SW',disabled:!0},"server-unavailable":{badge:`<span class="badge bg-warning">
                    <i class="bi bi-cloud-slash me-1"></i> Server Offline
                </span>`,buttonText:'<i class="bi bi-cloud-slash me-2"></i>Server Offline',disabled:!0},error:{badge:`<span class="badge bg-danger">
                    <i class="bi bi-exclamation-circle me-1"></i> Error
                </span>`,buttonText:'<i class="bi bi-exclamation-triangle me-2"></i>Error',disabled:!1}},s=n[t]||n.error;o(i,s.badge),o(a,s.badge),e&&(e.innerHTML=s.buttonText,e.disabled=s.disabled),this.updateNotificationBadge()}updateNotificationBadge(){const t=document.getElementById("tim-notification-badge"),i=document.getElementById("tim-notification-badge-mobile"),e=a=>{a&&(this.unreadNotifications>0?(a.innerHTML=`
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6em;">
                            ${this.unreadNotifications>99?"99+":this.unreadNotifications}
                            <span class="visually-hidden">unread notifications</span>
                        </span>
                    `,a.classList.add("position-relative")):(a.innerHTML="",a.classList.remove("position-relative")))};e(t),e(i)}async showSingleDeleteConfirmationModal(){return new Promise(t=>{w("Konfirmasi Hapus",`
                <div class="confirmation-modal-single">
                    <div class="text-center mb-3">
                        <i class="bi bi-trash text-danger fs-2"></i>
                    </div>
                    <h6 class="text-center mb-3">Hapus Notifikasi</h6>
                    <p class="text-center text-muted mb-0">
                        Apakah Anda yakin ingin menghapus notifikasi ini?
                    </p>
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="button" class="btn btn-outline-secondary" 
                                data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-danger" id="confirmSingleDeleteBtn">
                            <i class="bi bi-trash me-1"></i>Hapus
                        </button>
                    </div>
                </div>
            `,"modal-sm"),setTimeout(()=>{const e=document.getElementById("confirmSingleDeleteBtn");e&&e.addEventListener("click",()=>{t(!0)})},100)})}async refreshNotificationModal(){try{console.log("üîÑ Refreshing notification modal...");const t=await this.fetchTimNotifications(),i=document.querySelector(".modal-body .notification-modal-tim");if(i){const e=this.generateNotificationModalContent(t);i.innerHTML=e,this.setupNotificationModalEventListeners()}this.updateNotificationBadge()}catch(t){console.error("‚ùå Error refreshing modal:",t)}}generateNotificationModalContent(t){let i=`
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-truck text-primary me-2"></i>
                    Notifikasi Tim Angkut
                    ${this.unreadNotifications>0?`
                        <span class="badge bg-danger ms-2">${this.unreadNotifications} baru</span>
                    `:""}
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="refreshTimNotifications">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    ${t.length>0?`
                        <button class="btn btn-sm btn-outline-success ms-2" id="markAllAsReadTim">
                            <i class="bi bi-check-all"></i> Tandai Semua Dibaca
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-2" id="deleteAllTimNotifications">
                            <i class="bi bi-trash"></i> Hapus Semua
                        </button>
                    `:""}
                </div>
            </div>
        `;return t.length>0?(i+=`
                <div class="notification-list-tim" style="max-height: 400px; overflow-y: auto;">
            `,t.forEach((e,a)=>{const o=e.priority==="high",n=e.read;i+=`
                    <div class="notification-item-tim border rounded p-3 mb-2 ${o?"border-danger":n?"border-light":"border-primary"} ${o?"bg-danger bg-opacity-10":n?"bg-light":"bg-primary bg-opacity-10"}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 me-3">
                                <div class="d-flex align-items-center mb-1">
                                    ${this.getTimNotificationIcon(e.notification_type||e.type)}
                                    <h6 class="mb-0 ms-2 ${o?"text-danger fw-bold":n?"text-muted":"text-dark"}">
                                        ${e.title||"Notifikasi"}
                                    </h6>
                                    ${o?`
                                        <span class="badge bg-danger ms-2">PENTING</span>
                                    `:""}
                                    ${n?"":`
                                        <span class="badge bg-success ms-2">BARU</span>
                                    `}
                                </div>
                                <p class="mb-1 ${n?"text-muted":"text-dark"}">${e.message||""}</p>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    ${this.formatTimeAgo(e.created_at||e.timestamp)}
                                </small>
                            </div>
                            <div>
                                ${n?"":`
                                    <button class="btn btn-sm btn-outline-success mark-as-read-tim me-1" data-id="${e.id||a}">
                                        <i class="bi bi-check"></i> Tandai Dibaca
                                    </button>
                                `}
                                <button class="btn btn-sm btn-outline-danger delete-tim-notification" data-id="${e.id||a}">
                                    <i class="bi bi-trash"></i> Hapus
                                </button>
                            </div>
                        </div>
                `,e.data&&(i+=`
                        <div class="mt-2 p-2 bg-light rounded">
                            <small class="text-muted">Informasi:</small>
                            <pre class="mb-0 small" style="max-height: 100px; overflow: auto; white-space: pre-wrap;">${JSON.stringify(e.data,null,2)}</pre>
                        </div>
                    `),i+="</div>"}),i+="</div>"):i+=`
                <div class="text-center py-5">
                    <i class="bi bi-truck fs-1 text-muted mb-3"></i>
                    <p class="text-muted">Tidak ada notifikasi</p>
                    <small class="text-muted">Notifikasi akan muncul di sini saat ada jadwal baru atau pembaruan</small>
                </div>
            `,i+=`
            <div class="mt-3 border-top pt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Notifikasi diperbarui setiap 5 menit. Terakhir: ${this.lastNotificationCheck?this.lastNotificationCheck.toLocaleTimeString("id-ID"):"Belum pernah"}
                </small>
            </div>
        `,i}setupNotificationModalEventListeners(){setTimeout(()=>{const t=document.getElementById("refreshTimNotifications");t&&t.addEventListener("click",async()=>{await this.refreshNotificationModal()});const i=document.getElementById("markAllAsReadTim");i&&i.addEventListener("click",async()=>{await this.markAllTimNotificationsAsRead()&&await this.refreshNotificationModal()});const e=document.getElementById("deleteAllTimNotifications");e&&e.addEventListener("click",async()=>{await this.deleteAllTimNotifications()&&await this.refreshNotificationModal()}),document.querySelectorAll(".mark-as-read-tim").forEach(a=>{a.addEventListener("click",async o=>{const n=o.target.closest(".mark-as-read-tim"),s=n.dataset.id;n.disabled=!0,n.innerHTML='<i class="bi bi-hourglass"></i> Memproses...',await this.markTimNotificationAsRead(s)?await this.refreshNotificationModal():(n.disabled=!1,n.innerHTML='<i class="bi bi-check"></i> Tandai Dibaca',c("Gagal menandai notifikasi sebagai dibaca","error"))})}),document.querySelectorAll(".delete-tim-notification").forEach(a=>{a.addEventListener("click",async o=>{const n=o.target.closest(".delete-tim-notification"),s=n.dataset.id;if(!await this.showSingleDeleteConfirmationModal())return;n.disabled=!0,n.innerHTML='<i class="bi bi-hourglass"></i> Menghapus...',await this.deleteTimNotification(s)?await this.refreshNotificationModal():(n.disabled=!1,n.innerHTML='<i class="bi bi-trash"></i> Hapus',c("Gagal menghapus notifikasi","error"))})})},100)}async markTimNotificationAsRead(t){try{console.log(`üìù Marking tim notification ${t} as read...`);const i=m();if(d.notifications){const e=d.notifications.endsWith("/")?`${d.notifications}${t}/mark_read/`:`${d.notifications}/${t}/mark_read/`;try{(await fetch(e,{method:"POST",headers:i,credentials:"include"})).ok?console.log(`‚úÖ Server: Notification ${t} marked as read`):console.warn(`‚ö†Ô∏è Server: Failed to mark notification ${t} as read`)}catch(a){console.warn("Server update failed, using local only:",a.message)}}return this.unreadNotifications>0&&this.unreadNotifications--,console.log(`‚úÖ Local: Notification ${t} marked as read`),this.updateNotificationBadge(),!0}catch(i){return console.error("‚ùå Error marking tim notification as read:",i),this.unreadNotifications>0&&(this.unreadNotifications--,this.updateNotificationBadge()),!1}}showDesktopNotification(t){try{if(!("Notification"in window)){console.log("‚ö†Ô∏è Desktop notifications not supported");return}if(Notification.permission!=="granted"){console.log("‚ö†Ô∏è Notification permission not granted");return}const i={body:t.message||"Anda memiliki notifikasi baru",icon:"/static/icon-192x192.png",badge:"/static/icon-72x72.png",tag:`tim-notification-${t.id||Date.now()}`,requireInteraction:t.priority==="high",data:t,silent:!1},e=new Notification(`Tim Angkut - ${t.title||"Notifikasi"}`,i);e.onclick=()=>{window.focus(),e.close(),this.showTimNotificationModal()},e.onclose=()=>{console.log("Desktop notification closed")},t.priority!=="high"&&setTimeout(()=>{e.close()},1e4)}catch(i){console.error("‚ùå Error showing desktop notification:",i)}}startNotificationPolling(){this.notificationInterval&&clearInterval(this.notificationInterval),this.notificationInterval=setInterval(async()=>{try{await this.checkForNewTimNotifications()}catch(t){console.error("Polling error:",t)}},5*60*1e3),console.log("üîÑ Started tim notification polling (every 5 minutes)"),setTimeout(()=>{this.checkForNewTimNotifications()},3e3)}stopNotificationPolling(){this.notificationInterval&&(clearInterval(this.notificationInterval),this.notificationInterval=null,console.log("üõë Stopped tim notification polling"))}getTimNotificationIcon(t){return{schedule:'<i class="bi bi-calendar-check text-primary fs-5"></i>',schedule_new:'<i class="bi bi-calendar-plus text-success fs-5"></i>',schedule_reminder:'<i class="bi bi-alarm text-warning fs-5"></i>',pickup_update:'<i class="bi bi-truck text-info fs-5"></i>',alert:'<i class="bi bi-exclamation-triangle text-danger fs-5"></i>',system:'<i class="bi bi-gear text-secondary fs-5"></i>',test:'<i class="bi bi-bell text-muted fs-5"></i>',payment:'<i class="bi bi-cash-coin text-success fs-5"></i>',report:'<i class="bi bi-clipboard-data text-warning fs-5"></i>'}[t]||'<i class="bi bi-bell text-muted fs-5"></i>'}formatTimeAgo(t){if(!t)return"Baru saja";try{const i=new Date(t),a=new Date-i,o=Math.floor(a/1e3),n=Math.floor(o/60),s=Math.floor(n/60),r=Math.floor(s/24);return o<10?"Baru saja":o<60?`${o} detik lalu`:n<60?`${n} menit lalu`:s<24?`${s} jam lalu`:r===1?"Kemarin":r<7?`${r} hari lalu`:r<30?`${Math.floor(r/7)} minggu lalu`:`${Math.floor(r/30)} bulan lalu`}catch{return"Baru saja"}}getMockTimNotifications(){const t=new Date;return[{id:1,title:"Jadwal Pengangkutan Baru",message:"Ada 3 lokasi baru untuk diangkut besok",notification_type:"schedule_new",priority:"high",read:!1,created_at:new Date(t.getTime()-30*60*1e3).toISOString(),data:{schedule_count:3,date:new Date(t.getTime()+24*60*60*1e3).toISOString().split("T")[0]}},{id:2,title:"Anggota Menunggu",message:"Anggota Pak Budi menunggu pengangkutan di Jl. Merdeka No. 10",notification_type:"schedule_reminder",priority:"normal",read:!0,created_at:new Date(t.getTime()-2*60*60*1e3).toISOString(),data:{anggota_name:"Pak Budi",address:"Jl. Merdeka No. 10",status:"waiting"}},{id:3,title:"Laporan Sampah Baru",message:"Ada laporan sampah baru di area operasional Anda",notification_type:"report",priority:"normal",read:!1,created_at:new Date(t.getTime()-1*60*60*1e3).toISOString(),data:{report_id:45,address:"Jl. Kebersihan No. 5",status:"pending"}}]}async setupDashboardIntegration(){try{console.log("üîß Setting up tim dashboard integration..."),await this.initialize(),this.setupEventListeners(),await this.updateDropdownStatus(),console.log("‚úÖ Tim dashboard integration complete")}catch(t){console.error("‚ùå Error setting up tim dashboard integration:",t)}}setupEventListeners(){console.log("üîó Setting up tim event listeners...");const t=document.getElementById("tim-toggleNotificationsBtn");t&&(t.addEventListener("click",async a=>{a.preventDefault(),await this.toggleNotifications()}),console.log("‚úÖ Toggle button listener added"));const i=document.getElementById("tim-testNotificationBtn");i&&(i.addEventListener("click",async a=>{a.preventDefault(),await this.sendTimTestNotification()}),console.log("‚úÖ Test button listener added"));const e=document.getElementById("tim-showNotificationsModal");e&&(e.addEventListener("click",async a=>{a.preventDefault(),await this.showTimNotificationModal()}),console.log("‚úÖ Show modal button listener added"))}async updateDropdownStatus(){const t=document.getElementById("tim-notification-dropdown-status");if(t)try{await g.checkSubscription()?t.innerHTML=`
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> Aktif
                    </span>
                `:t.innerHTML=`
                    <span class="badge bg-secondary">
                        <i class="bi bi-bell-slash"></i> Nonaktif
                    </span>
                `}catch(i){console.error("Error updating dropdown status:",i),t.innerHTML=`
                <span class="badge bg-warning">
                    <i class="bi bi-exclamation-circle"></i> Gagal
                </span>
            `}}async checkTomorrowSchedule(){try{if(console.log("üìÖ Checking tomorrow's schedule for tim angkut..."),JSON.parse(localStorage.getItem("user")||"{}").role!=="tim_angkut")return 0;const i=new Date,e=new Date;e.setDate(e.getDate()+1),console.log("üïê Waktu sekarang (WITA):",i.toLocaleString("id-ID",{timeZone:"Asia/Makassar",hour12:!1}));const a=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;console.log("üìÖ Tanggal besok untuk query:",a);const o=await fetch(`${d.detailAnggotaJadwal}?tanggal_jadwal=${a}`,{headers:m()});if(!o.ok)return console.error("‚ùå Failed to fetch schedule:",o.status),0;const n=await o.json(),l=(Array.isArray(n)?n:[]).filter(f=>{if(!f.tanggal_jadwal)return!1;try{return new Date(f.tanggal_jadwal).toISOString().split("T")[0]===a}catch{return!1}}).length;if(console.log(`üìä Found ${l} schedules for tomorrow`),l>0){const f=await this.checkNotificationSentToday(),u=new Date().toLocaleTimeString("id-ID",{timeZone:"Asia/Makassar",hour12:!1,hour:"2-digit"}).split(":")[0],h=new Date().getMinutes(),b=parseInt(u)*60+h,k=7*60,p=17*60;if(console.log(`üïê Waktu saat ini (WITA): ${u}:${h} (total menit: ${b})`),b>=p)return console.log("‚úÖ Sudah lewat waktu notifikasi kedua (17:00 WITA)"),l;if(b>=k)if(f.first)console.log("‚úÖ Notifikasi pertama sudah dikirim hari ini");else return console.log("üïê Waktu untuk notifikasi pertama (07:00 WITA)"),await this.createTomorrowScheduleNotification(l,"morning"),this.showDesktopScheduleNotification(l,"morning"),this.updateScheduleUI(l),l;if(b>=p-30&&b<p+30)if(f.second)console.log("‚úÖ Notifikasi kedua sudah dikirim hari ini");else return console.log("üïê Waktu untuk notifikasi kedua (17:00 WITA)"),await this.createTomorrowScheduleNotification(l,"evening"),this.showDesktopScheduleNotification(l,"evening"),this.updateScheduleUI(l),l;return console.log("‚è≥ Belum waktunya untuk notifikasi jadwal besok"),l}else return console.log("üì≠ Tidak ada jadwal untuk besok"),await this.clearScheduleNotifications(),this.clearScheduleUI(),0}catch(t){return console.error("‚ùå Error checking tomorrow schedule:",t),0}}async checkNotificationSentToday(){try{const t=new Date().toISOString().split("T")[0],i=JSON.parse(localStorage.getItem("user")||"{}"),e=m(),a=`${d.notifications}?user=${i.id}&notification_type=schedule`,o=await fetch(a,{headers:e,credentials:"include"});if(o.ok){const n=await o.json();let s=[];Array.isArray(n)?s=n:n&&n.results&&(s=n.results);const r=s.filter(u=>{try{const b=new Date(u.created_at).toISOString().split("T")[0],k=u.data||{};return b===t&&k.type==="tomorrow_schedule"}catch{return!1}}),l=r.some(u=>(u.data||{}).time_of_day==="morning"),f=r.some(u=>(u.data||{}).time_of_day==="evening");return{first:l,second:f,count:r.length}}}catch(t){console.error("Error checking notification sent today:",t)}return{first:!1,second:!1,count:0}}async createTomorrowScheduleNotification(t,i="morning"){try{console.log(`üìù Creating ${i} notification for ${t} tomorrow schedules...`);const e=JSON.parse(localStorage.getItem("user")||"{}");if(e.role!=="tim_angkut")return!1;const a=new Date;a.setDate(a.getDate()+1);const o=a.toLocaleDateString("id-ID",{timeZone:"Asia/Makassar",weekday:"long",year:"numeric",month:"long",day:"numeric"});let n,s;const r=new Date().toLocaleTimeString("id-ID",{timeZone:"Asia/Makassar",hour12:!1,hour:"2-digit",minute:"2-digit"});if(i==="morning"?(n="üìÖ Jadwal Pengangkutan Besok (Pagi)",s=`Selamat pagi! Anda memiliki ${t} jadwal pengangkutan untuk besok (${o}).`):(n="üìÖ Jadwal Pengangkutan Besok (Sore)",s=`Selamat sore! Anda memiliki ${t} jadwal pengangkutan untuk besok (${o}).`),await this.checkExistingScheduleNotification(i))return console.log(`‚ö†Ô∏è ${i} schedule notification already exists for today, skipping...`),!1;const f={user:e.id,title:n,message:s,notification_type:"schedule",priority:t>5?"high":"normal",read:!1,url:"/tim-angkut/jadwal",data:{schedule_count:t,schedule_date:a.toISOString().split("T")[0],date_string:o,notification_date:new Date().toISOString().split("T")[0],time_of_day:i,type:"tomorrow_schedule",created_at_wita:r}};return console.log("üì§ Sending notification data:",f),await this.saveNotificationToDatabase(f)?(console.log(`‚úÖ ${i} schedule notification created successfully`),!0):(console.error(`‚ùå Failed to create ${i} notification`),!1)}catch(e){return console.error(`‚ùå Error creating ${i} schedule notification:`,e),!1}}async checkExistingScheduleNotification(t){try{const i=new Date().toISOString().split("T")[0],e=JSON.parse(localStorage.getItem("user")||"{}"),a=m(),o=`${d.notifications}?user=${e.id}&notification_type=schedule`,n=await fetch(o,{headers:a,credentials:"include"});if(n.ok){const s=await n.json();let r=[];return Array.isArray(s)?r=s:s&&s.results&&(r=s.results),r.find(l=>{try{const u=new Date(l.created_at).toISOString().split("T")[0],h=l.data||{};return u===i&&h.time_of_day===t&&h.type==="tomorrow_schedule"}catch{return!1}})}}catch(i){console.error("Error checking existing schedule notification:",i)}return null}async saveNotificationToDatabase(t){try{const i=m();let e=d.notifications;if(!e)return console.error("Notification API endpoint not configured"),!1;e.endsWith("/")||(e+="/"),console.log("üì§ Saving notification to:",e);const a=await fetch(e,{method:"POST",headers:{...i,"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"});if(a.ok){const o=await a.json();return console.log("‚úÖ Notification saved to database:",o.id),!0}else{const o=await a.text();return console.error("‚ùå Failed to save notification:",a.status,o),!1}}catch(i){return console.error("‚ùå Error saving notification to database:",i),!1}}showDesktopScheduleNotification(t,i="morning"){if(!("Notification"in window)){console.log("‚ö†Ô∏è Desktop notifications not supported");return}if(Notification.permission!=="granted"){console.log("‚ö†Ô∏è Notification permission not granted");return}const e=new Date;e.setDate(e.getDate()+1);const a=e.toLocaleDateString("id-ID",{timeZone:"Asia/Makassar",weekday:"long",year:"numeric",month:"long",day:"numeric"});let o;i==="morning"?o=`Selamat pagi! Anda memiliki ${t} jadwal pengangkutan untuk besok (${a}).`:o=`Selamat sore! Anda memiliki ${t} jadwal pengangkutan untuk besok (${a}).`;const n={body:o,icon:"/static/icon-192x192.png",badge:"/static/icon-72x72.png",tag:`tomorrow-schedule-${i}-${new Date().toISOString().split("T")[0]}`,requireInteraction:!0,silent:!1,timestamp:Date.now()},s=new Notification(`üìÖ Jadwal Besok (${i==="morning"?"Pagi":"Sore"})`,n);return s.onclick=()=>{window.focus(),s.close(),window.location.href="/tim-angkut/jadwal"},setTimeout(()=>{s.close()},3e4),s}updateScheduleUI(t){const i=document.getElementById("tomorrowScheduleCount");i&&(i.textContent=t,i.classList.remove("d-none"));const e=document.getElementById("scheduleBadge");e&&(t>0?(e.textContent=t,e.classList.remove("d-none")):e.classList.add("d-none"));const a=document.getElementById("scheduleInfo");if(a){const o=new Date().toLocaleTimeString("id-ID",{timeZone:"Asia/Makassar",hour12:!1,hour:"2-digit",minute:"2-digit"});t>0?(a.textContent=`üìÖ ${t} jadwal besok (diperbarui ${o} WITA)`,a.classList.remove("text-muted"),a.classList.add("text-success")):(a.textContent="üìÖ Tidak ada jadwal untuk besok",a.classList.remove("text-success"),a.classList.add("text-muted"))}}clearScheduleUI(){const t=document.getElementById("tomorrowScheduleCount");t&&t.classList.add("d-none");const i=document.getElementById("scheduleBadge");i&&i.classList.add("d-none");const e=document.getElementById("scheduleInfo");e&&(e.textContent="üìÖ Tidak ada jadwal untuk besok",e.classList.remove("text-success"),e.classList.add("text-muted"))}async clearScheduleNotifications(){try{const t=new Date().toISOString().split("T")[0],i=JSON.parse(localStorage.getItem("user")||"{}"),e=m(),a=`${d.notifications}?user=${i.id}&notification_type=schedule`,o=await fetch(a,{headers:e,credentials:"include"});if(o.ok){const n=await o.json();let s=[];Array.isArray(n)?s=n:n&&n.results&&(s=n.results);const r=s.filter(l=>{try{const u=new Date(l.created_at).toISOString().split("T")[0],h=l.data||{};return u===t&&h.type==="tomorrow_schedule"}catch{return!1}});for(const l of r)try{await this.deleteTimNotification(l.id)}catch(f){console.warn(`Failed to delete schedule notification ${l.id}:`,f.message)}console.log(`üóëÔ∏è Cleared ${r.length} schedule notifications for today`)}}catch(t){console.error("Error clearing schedule notifications:",t)}}async setupScheduleChecker(){try{console.log("üîÑ Setting up schedule checker..."),setTimeout(async()=>{await this.checkTomorrowSchedule()},3e3),setInterval(async()=>{await this.checkTomorrowSchedule()},30*60*1e3),this.setupExactTimeScheduleChecker(),console.log("‚úÖ Schedule checker initialized")}catch(t){console.error("‚ùå Error setting up schedule checker:",t)}}setupExactTimeScheduleChecker(){const t=new Date,i=new Date(t.toLocaleString("en-US",{timeZone:"Asia/Makassar"}));[7,17].forEach(a=>{const o=new Date(i);o.setHours(a,0,0,0),o<=i&&o.setDate(o.getDate()+1);const n=o.getTime()-i.getTime();console.log(`‚è∞ Akan cek jadwal pada ${a}:00 WITA dalam ${Math.round(n/1e3/60)} menit`),setTimeout(async()=>{console.log(`üïê Waktunya cek jadwal! (${a}:00 WITA)`),await this.checkTomorrowSchedule(),setInterval(async()=>{console.log(`üïê Waktunya cek jadwal harian! (${a}:00 WITA)`),await this.checkTomorrowSchedule()},24*60*60*1e3)},n)})}}const $=new N;export{N as TimNotifications,$ as timNotifications};
