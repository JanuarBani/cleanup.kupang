import{w as a,s as o}from"./router-DKNYMW_3.js";import"./index-5B4sqd9c.js";class u{constructor(){this.notificationSubscription=null,this.notificationInterval=null,this.webPushInitialized=!1,this.user=null}async initialize(){try{if(console.log("ðŸ”” Initializing Tamu Notifications..."),this.user=JSON.parse(localStorage.getItem("user")||"{}"),!["tamu","anggota"].includes(this.user.role))return console.log(`â„¹ï¸ User role ${this.user.role} doesn't need tamu notifications`),!1;if(!a.isSupported)return console.log("âš ï¸ Web Push not supported in this browser"),this.updateNotificationUI("not-supported"),!1;try{await a.initialize(),this.webPushInitialized=!0,a.setupPushEventListener(),console.log("âœ… Web Push initialized for tamu")}catch(e){return console.error("Web Push init failed:",e),this.updateNotificationUI("service-worker-error"),!1}const t=await a.checkSubscription();return t?(console.log("âœ… Tamu is subscribed to push notifications"),this.notificationSubscription=a.subscription,await this.updateNotificationUI("subscribed"),this.startNotificationPolling()):(console.log("â„¹ï¸ Tamu is not subscribed to push notifications"),await this.updateNotificationUI("unsubscribed")),t}catch(i){return console.error("âŒ Error initializing tamu notifications:",i),this.updateNotificationUI("error"),!1}}async enableNotifications(){try{if(console.log("ðŸ”„ Enabling tamu notifications..."),this.updateNotificationUI("loading"),!a.isSupported)throw new Error("Browser tidak mendukung Web Push Notifications");if(Notification.permission==="denied")throw new Error("Permission untuk notifikasi telah ditolak. Mohon aktifkan di pengaturan browser.");if(Notification.permission==="default"&&await Notification.requestPermission()!=="granted")throw new Error("Izin notifikasi ditolak oleh pengguna");const i=await a.enableNotifications();return i.success?(console.log("âœ… Tamu notifications enabled successfully"),this.notificationSubscription=a.subscription,await this.updateNotificationUI("subscribed"),this.startNotificationPolling(),o("success","Notifikasi telah diaktifkan! Anda akan mendapatkan pemberitahuan tentang laporan dan pembaruan."),!0):(console.error("âŒ Failed to enable tamu notifications:",i.error),await this.updateNotificationUI("error"),o("error","Gagal mengaktifkan notifikasi"),!1)}catch(i){console.error("âŒ Error enabling tamu notifications:",i);let t="Terjadi kesalahan saat mengaktifkan notifikasi",e="error";return i.message.includes("Permission")||i.message.includes("Izin")?(t="Izin notifikasi ditolak. Mohon aktifkan di pengaturan browser.",e="permission-denied"):i.message.includes("Service Worker")?(t="Service Worker tidak tersedia. Pastikan Anda mengakses melalui HTTPS.",e="service-worker-error"):(i.message.includes("VAPID")||i.message.includes("fetch"))&&(t="Server notifikasi tidak dapat dijangkau. Coba lagi nanti.",e="server-unavailable"),await this.updateNotificationUI(e),o("error",t),!1}}async disableNotifications(){try{console.log("ðŸ”„ Disabling tamu notifications..."),this.updateNotificationUI("loading");const i=await a.disableNotifications();return i.success?(console.log("âœ… Tamu notifications disabled successfully"),this.notificationSubscription=null,this.stopNotificationPolling(),await this.updateNotificationUI("unsubscribed"),o("info","Notifikasi telah dinonaktifkan"),!0):(console.error("âŒ Failed to disable tamu notifications:",i.error),await this.updateNotificationUI("error"),o("error","Gagal menonaktifkan notifikasi"),!1)}catch(i){return console.error("âŒ Error disabling tamu notifications:",i),await this.updateNotificationUI("error"),o("error","Terjadi kesalahan saat menonaktifkan notifikasi"),!1}}async toggleNotifications(){try{return await a.checkSubscription()?await this.disableNotifications():await this.enableNotifications(),!0}catch(i){return console.error("âŒ Error toggling tamu notifications:",i),o("error","Gagal mengubah pengaturan notifikasi"),!1}}async updateNotificationUI(i){const t=document.getElementById("tamu-notification-status"),e=document.getElementById("tamu-toggleNotificationsBtn"),l=(r,c)=>{r&&(r.innerHTML=c)},s={loading:{badge:`<span class="badge bg-warning">
                    <i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1"></i> Memuat...
                </span>`,buttonText:'<i class="bi bi-arrow-repeat me-2"></i>Memuat...',disabled:!0},subscribed:{badge:`<span class="badge bg-success">
                    <i class="bi bi-bell-fill me-1"></i> Aktif
                </span>`,buttonText:'<i class="bi bi-bell-slash me-2"></i>Nonaktifkan',disabled:!1},unsubscribed:{badge:`<span class="badge bg-secondary">
                    <i class="bi bi-bell-slash me-1"></i> Nonaktif
                </span>`,buttonText:'<i class="bi bi-bell me-2"></i>Aktifkan',disabled:!1},"not-supported":{badge:`<span class="badge bg-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i> Tidak Didukung
                </span>`,buttonText:'<i class="bi bi-ban me-2"></i>Tidak Didukung',disabled:!0},"permission-denied":{badge:`<span class="badge bg-danger">
                    <i class="bi bi-slash-circle me-1"></i> Izin Ditolak
                </span>`,buttonText:'<i class="bi bi-slash-circle me-2"></i>Izin Ditolak',disabled:!0},"service-worker-error":{badge:`<span class="badge bg-danger">
                    <i class="bi bi-gear me-1"></i> Service Worker Error
                </span>`,buttonText:'<i class="bi bi-exclamation-triangle me-2"></i>Error SW',disabled:!0},"server-unavailable":{badge:`<span class="badge bg-warning">
                    <i class="bi bi-cloud-slash me-1"></i> Server Offline
                </span>`,buttonText:'<i class="bi bi-cloud-slash me-2"></i>Server Offline',disabled:!0},error:{badge:`<span class="badge bg-danger">
                    <i class="bi bi-exclamation-circle me-1"></i> Error
                </span>`,buttonText:'<i class="bi bi-exclamation-triangle me-2"></i>Error',disabled:!1}},n=s[i]||s.error;l(t,n.badge),e&&(e.innerHTML=n.buttonText,e.disabled=n.disabled)}startNotificationPolling(){this.notificationInterval&&clearInterval(this.notificationInterval),this.notificationInterval=setInterval(async()=>{try{await this.checkForNewNotifications()}catch(i){console.error("Polling error:",i)}},5*60*1e3),console.log("ðŸ”„ Started notification polling (every 5 minutes)"),setTimeout(()=>{this.checkForNewNotifications()},3e3)}stopNotificationPolling(){this.notificationInterval&&(clearInterval(this.notificationInterval),this.notificationInterval=null,console.log("ðŸ›‘ Stopped notification polling"))}async checkForNewNotifications(){try{return navigator.onLine?(console.log("ðŸ”” Checking for notification status..."),[]):(console.log("ðŸŒ Offline - Skipping notification check"),[])}catch(i){return console.error("âŒ Error checking for new notifications:",i),[]}}async setupDashboardIntegration(){try{console.log("ðŸ”§ Setting up tamu dashboard integration..."),await this.initialize(),this.setupEventListeners(),console.log("âœ… Tamu dashboard integration complete")}catch(i){console.error("âŒ Error setting up dashboard integration:",i)}}setupEventListeners(){console.log("ðŸ”— Setting up tamu event listeners...");const i=document.getElementById("tamu-toggleNotificationsBtn");i&&(i.addEventListener("click",async t=>{t.preventDefault(),await this.toggleNotifications()}),console.log("âœ… Toggle button listener added"))}}const g=new u;export{u as TamuNotifications,g as tamuNotifications};
